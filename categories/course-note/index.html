<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Course-Note | diefish's blog</title><meta name=keywords content><meta name=description content="A freshman at SJTU John class."><meta name=author content="diefish"><link rel=canonical href=https://diefish1024.github.io/categories/course-note/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://diefish1024.github.io/images/avatar.jpg><link rel=icon type=image/png sizes=16x16 href=https://diefish1024.github.io/images/avatar.jpg><link rel=icon type=image/png sizes=32x32 href=https://diefish1024.github.io/images/avatar.jpg><link rel=apple-touch-icon href=https://diefish1024.github.io/images/avatar.jpg><link rel=mask-icon href=https://diefish1024.github.io/images/avatar.jpg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=https://diefish1024.github.io/categories/course-note/index.xml><link rel=alternate hreflang=en href=https://diefish1024.github.io/categories/course-note/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><meta property="og:url" content="https://diefish1024.github.io/categories/course-note/"><meta property="og:site_name" content="diefish's blog"><meta property="og:title" content="Course-Note"><meta property="og:description" content="A freshman at SJTU John class."><meta property="og:locale" content="zh-cn"><meta property="og:type" content="website"><meta property="og:image" content="https://diefish1024.github.io/images/avatar.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://diefish1024.github.io/images/avatar.jpg"><meta name=twitter:title content="Course-Note"><meta name=twitter:description content="A freshman at SJTU John class."></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://diefish1024.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://diefish1024.github.io/images/avatar.jpg alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://diefish1024.github.io/posts/ title=posts><span>posts</span></a></li><li><a href=https://diefish1024.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://diefish1024.github.io/search title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://diefish1024.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://diefish1024.github.io/categories/>Categories</a></div><h1>Course-Note</h1></header><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>15. å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥æ¡ä»¶å˜é‡</h2></header><div class=entry-content><p>åŒæ­¥å’Œæ¡ä»¶å˜é‡ äº’æ–¥å®ç°äº†åŸå­æ€§ï¼Œä½†æ˜¯æ— æ³•å®ç°ç¡®å®šæ€§ï¼Œä¹Ÿå°±æ˜¯æ— æ³•æ­£ç¡®å®ç° â€œhappens-beforeâ€ çš„å…³ç³»
å› æ­¤éœ€è¦å¼•å…¥æ¡ä»¶å˜é‡æ¥å®ç°çº¿ç¨‹çš„åŒæ­¥ï¼Œå½¢æˆå—æ§åˆ¶çš„å¹¶å‘äº‹ä»¶çš„å‘ç”Ÿé¡ºåºï¼ˆå¯ä»¥ç”¨ä¹å›¢æŒ‡æŒ¥æ¥ç±»æ¯”ï¼‰ï¼ŒæŠŠä¸€ç³»åˆ—ä¸ç¡®å®šçš„çŠ¶æ€åœ¨æŸä¸€ä¸ªæ—¶é—´ç‚¹åŒæ­¥åˆ°äº†ä¸€ä¸ªç¡®å®šçš„çŠ¶æ€ï¼Œå°†å‘æ•£çš„å¹¶å‘ç¨‹åºçŠ¶æ€ â€œæ”¶æŸâ€
å®ç°åŒæ­¥
å®ç° $ A\to B $ï¼š
1 2 3 4 5 6 7 A; can_proceed = true; (signal) while(!can_proceed); B // B: wait until the condition is satisfied è¿™æ ·çš„æ€è·¯å¤§è‡´æ­£ç¡®ï¼Œä½†æ˜¯è‡ªé€‰çš„å¾ªç¯æœ‰å¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªæ›´åŠ åº•å±‚çš„æœºåˆ¶æ¥å¸®åŠ©å®ç°è¿™ä¸€ç‚¹
æœ€ç†æƒ³çš„ API æ˜¯ wait_until(cond) ï¼Œä½†æ˜¯è¿‡å»ä¸ºäº†ç®€åŒ–è®¾è®¡ï¼Œå˜æˆäº†
æ¡ä»¶ä¸æ»¡è¶³æ—¶ç­‰å¾…ï¼šwait - ç›´æ¥ç¡çœ ç­‰å¾… æ¡ä»¶æ»¡è¶³æ—¶ç»§ç»­ï¼šsignal/broadcast - å”¤é†’æ‰€æœ‰çº¿ç¨‹ ï¼ˆå°æ—¶å€™çš„ scratch ç¼–ç¨‹å…¶å®å·²ç»æœ‰äº†è¿™æ ·çš„æ€æƒ³ğŸ˜‚ï¼‰
åœ¨ c++ ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥æŠŠæ¡ä»¶æ”¾åˆ° $ \lambda $ è¡¨è¾¾å¼ä¸­ï¼š
1 2 3 4 5 6 7 8 9 10 11 12 std::mutex mtx; std::condition_variable cv; void T_player() { std::unique_lock lk(mtx); cv.wait(lk, []{ return can_proceed; } ); cv.notify_all(); lk.unlock(); } æ³¨æ„æ¡ä»¶å˜é‡åœ¨ç­‰å¾…æ—¶éœ€è¦å¸¦ç€ä¸€æŠŠé”ï¼ˆéœ€è¦ç¡®ä¿æ£€æŸ¥å’Œç­‰å¾…æ˜¯åŸå­æ“ä½œï¼‰
...</p></div><footer class=entry-footer>2 min&nbsp;Â·&nbsp;diefish</footer><a class=entry-link aria-label="post link to 15. å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥æ¡ä»¶å˜é‡" href=https://diefish1024.github.io/posts/nju-os-2025/15-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E5%90%8C%E6%AD%A5%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>16. å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ä¿¡å·é‡</h2></header><div class=entry-content><p>ä¿¡å·é‡ äº’æ–¥é”åœ¨æŸç§æ„ä¹‰ä¸Šä¹Ÿå¯ä»¥è®¤ä¸ºå®ç°äº† â€œhappens-beforeâ€ çš„ä¾èµ–å…³ç³»â€”â€” release å¿…ç„¶å‘ç”Ÿåœ¨ acquire ä¹‹å‰ã€‚æˆ‘ä»¬å¯ä»¥è¯•ç€åˆ©ç”¨è¿™ç§ä¾èµ–å…³ç³»æ¥å®ç°è®¡ç®—å›¾çš„è°ƒåº¦ï¼šä¸ºæ¯æ¡è¾¹åˆ†é…ä¸€ä¸ªäº’æ–¥é”ï¼Œä»£è¡¨æ•°æ®æˆ–å‰ç½®ä»»åŠ¡çš„å®Œæˆï¼›ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»è·å¾—æ‰€æœ‰å…¥è¾¹å¯¹åº”çš„äº’æ–¥é”æ‰èƒ½å¼€å§‹è®¡ç®—ï¼Œè®¡ç®—å®Œæˆåï¼Œå°±é‡Šæ”¾æ‰€æœ‰å‡ºè¾¹å¯¹åº”çš„äº’æ–¥é”ï¼Œé€šçŸ¥ä¸‹æ¸¸èŠ‚ç‚¹è¾“å‡ºå°±ç»ªï¼ˆä½†æ˜¯è¿™ç§ç›´æ¥ä½¿ç”¨äº’æ–¥é”ä½œä¸ºè¾¹çŠ¶æ€ä¿¡å·çš„æ–¹å¼æ˜¯ undefined behaviorï¼Œå› ä¸ºäº’æ–¥é”ä¸»è¦ç”¨äºä¿æŠ¤ä¸´ç•ŒåŒºï¼Œå…¶é‡Šæ”¾é€šå¸¸è¦æ±‚ç”±æŒæœ‰å®ƒçš„çº¿ç¨‹å®Œæˆï¼Œè‹¥é‡Šæ”¾æœªæ›¾è·å–çš„é”ï¼Œåˆ™è¡Œä¸ºæœªå®šä¹‰ï¼‰
æˆ‘ä»¬å¯ä»¥ä»è¿™ç§æƒ³æ³•ä¸­æŠ½è±¡å‡ºå…¶æœ¬è´¨ï¼Œä¹Ÿå°±æ˜¯ç”¨ä¸€ä¸ªâ€œä¿¡å·â€å»è·å–èµ„æºçš„è®¸å¯ï¼Œç±»ä¼¼é¤å…çš„å–å·åƒé¥­
è¿™ç§ä¿¡å·çš„æ€æƒ³å¾ˆé€‚åˆç”¨æ¥ç®¡ç†è®¡æ•°ç±»å‹çš„åŒç±»èµ„æºï¼Œæ¯”å¦‚åœè½¦åœºçš„ç©ºä½ï¼Œä¸ºäº†å®ç°è¿™ç§ producer-customer çš„é—®é¢˜ï¼Œç”¨ æ¡ä»¶å˜é‡ å¯ä»¥è½»æ˜“è§£å†³ï¼Œè¿›å…¥çš„æ¡ä»¶å°±æ˜¯å­˜åœ¨ç©ºä½ count &lt; capacity ï¼Œé‚£æˆ‘ä»¬ä»å‡å°‘å˜é‡çš„è§’åº¦å‡ºå‘ï¼Œè¿™å®é™…ä¸Šä¹Ÿå°±æ˜¯å‰©ä½™ç©ºä½çš„æ•°é‡å¤§äºé›¶ï¼Œæˆ‘ä»¬åœè½¦ç›¸å½“äºæ¶ˆè€—äº†ä¸€ä¸ªè½¦ä½ï¼Œç¦»å¼€ç›¸å½“äºåˆ›é€ äº†ä¸€ä¸ªè½¦ä½ï¼Œè¿™ä¹Ÿå°±å¾—åˆ°äº†æ‰€è°“â€œä¿¡å·é‡â€çš„æœºåˆ¶
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 void P(sem_t *sem) { // Prolaag - try + decrease/down/wait/acquire mutex_lock(&amp;sem->lk); while (!(sem->count > 0)) { cond_wait(&amp;sem->cv, &amp;sem->lk); } sem->count--; // æ¶ˆè€—ä¸€ä¸ªä¿¡å· (è½¦ä½) mutex_unlock(&amp;sem->lk); } void V(sem_t *sem) { // Verhoog - increase/up/post/signal/release mutex_lock(&amp;sem->lk); sem->count++; // åˆ›å»ºä¸€ä¸ªä¿¡å· (è½¦ä½) cond_broadcast(&amp;sem->cv); mutex_unlock(&amp;sem->lk); } æ ¹æ®è¿™ä¸ªä¸€è·¯æ¨å‡ºä¿¡å·é‡çš„æ€è·¯ï¼Œæˆ–è®¸å¯ä»¥è®¤ä¸ºè¿™æ˜¯äº’æ–¥é”çš„æ‰©å±•
...</p></div><footer class=entry-footer>1 min&nbsp;Â·&nbsp;diefish</footer><a class=entry-link aria-label="post link to 16. å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ä¿¡å·é‡" href=https://diefish1024.github.io/posts/nju-os-2025/16-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E5%90%8C%E6%AD%A5%E4%BF%A1%E5%8F%B7%E9%87%8F/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>17. å¹¶å‘ Bugs</h2></header><div class=entry-content><p>æ•°æ®ç«äº‰ å¤§å¤šå¹¶å‘ bug æœ€åéƒ½ä¼šä½“ç°ä¸ºæ•°æ®ç«äº‰ (Data Race)
å¯¹äºé¡ºåºç¨‹åºè€Œè¨€ï¼Œå‡½æ•° f() è¿”å›ä¹‹åå°±å·²ç»å®Œæˆäº†æ‰€æœ‰çš„çŠ¶æ€ä¿®æ”¹ï¼Œå¯¹äºå…¶ä»–éƒ¨åˆ†è€Œè¨€è¿™ä¸ªä¿®æ”¹æ˜¯ç«‹å³ç”Ÿæ•ˆçš„ï¼›å¦‚æœå¯¹äºå¹¶å‘ç¨‹åºè€Œè¨€æ¨¡å¼çš„åˆ‡æ¢ä¹Ÿåœ¨ç¬é—´å®Œæˆï¼Œé‚£å°±ä¸ä¼šå¯¼è‡´å¹¶å‘çš„é—®é¢˜
ç„¶è€Œå®é™…ä¸Šæ¨¡å¼çš„åˆ‡æ¢éœ€è¦æ—¶é—´ï¼Œæ‰§è¡Œçš„æ“ä½œåœ¨æœªæ¥ä¸€æ®µæ—¶é—´ä¹‹åæ‰ä¼šå°±ç»ªï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å®é™…ç¼–ç¨‹æ—¶æ€»æ˜¯å®¹æ˜“æœ‰â€œç«‹å³ç”Ÿæ•ˆâ€çš„è‚Œè‚‰è®°å¿†ï¼Œè¿™å°±å¯¼è‡´äº†å¹¶å‘é—®é¢˜çš„å¯èƒ½æ€§
ä¸è¿‡å¯¹äºå‡½æ•°å¼ç¼–ç¨‹è€Œè¨€ï¼Œæ“ä½œä¸å­˜åœ¨å¯¹å¤–çŠ¶æ€çš„ä¿®æ”¹ï¼Œæ²¡æœ‰å‰¯ä½œç”¨ï¼ˆåªä¼šæ“ä½œå±€éƒ¨å˜é‡ï¼‰ï¼Œè¿™å°±ä¸ä¼šå¯¼è‡´å¹¶å‘é—®é¢˜
Data Race å‘ç”Ÿçš„å®è´¨æ˜¯ä¸åŒçš„çº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€å†…å­˜ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™ï¼Œå½¢è±¡çš„ç†è§£å°±æ˜¯ä¸åŒçš„å†…å­˜è®¿é—®åœ¨â€œèµ›è·‘â€ï¼Œè·‘èµ¢çš„æ“ä½œå…ˆæ‰§è¡Œ
Not that easy: è™½ç„¶æˆ‘ä»¬å°†æ•°æ®ç«äº‰å½¢è±¡åœ°æ¯”å–»ä¸ºâ€œèµ›è·‘â€ï¼Œä½†å®é™…ä¸Šï¼Œå“ªä¸€ä¸ªæ“ä½œèƒ½â€œè·‘èµ¢â€å¹¶æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•å’Œç¡®å®šï¼Œå…¶å¤æ‚æ€§ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢
å¼±å†…å­˜æ¨¡å‹ (Weak memory model)ï¼šåœ¨ç°ä»£å¤„ç†å™¨æ¶æ„ä¸­ï¼Œä¸ºäº†æå‡æ€§èƒ½ï¼Œå¤„ç†å™¨å¯èƒ½ä¼šå¯¹å†…å­˜æ“ä½œè¿›è¡Œé‡æ’åºã€‚è¿™æ„å‘³ç€ï¼Œä¸åŒçš„çº¿ç¨‹æˆ–â€œè§‚å¯Ÿè€…â€åœ¨ä¸åŒæ—¶é—´ç‚¹çœ‹åˆ°å…±äº«å†…å­˜çš„çŠ¶æ€å¯èƒ½æ˜¯ä¸ä¸€è‡´çš„ã€‚ä¸€ä¸ªçº¿ç¨‹å¯¹å†…å­˜çš„å†™å…¥æ“ä½œï¼Œå¯èƒ½ä¸ä¼šç«‹å³å¯¹æ‰€æœ‰å…¶ä»–çº¿ç¨‹å¯è§ï¼Œå¯¼è‡´ä¸åŒçº¿ç¨‹è§‚å¯Ÿåˆ°ä¸åŒçš„ç»“æœã€‚è¿™ç§å†…å­˜æ¨¡å‹çš„ä¸€è‡´æ€§é—®é¢˜ä½¿å¾—ç¡®å®šå“ªä¸ªæ“ä½œâ€œå…ˆå‘ç”Ÿâ€å˜å¾—éå¸¸å›°éš¾ä¸”ä¸ç¡®å®šã€‚
æœªå®šä¹‰è¡Œä¸º (Undefined Behavior)ï¼šä» C++11 æ ‡å‡†å¼€å§‹ï¼Œæ•°æ®ç«äº‰è¢«æ˜ç¡®è§„å®šä¸ºæœªå®šä¹‰è¡Œä¸ºã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ çš„ç¨‹åºå‘ç”Ÿäº†æ•°æ®ç«äº‰ï¼Œç¼–è¯‘å™¨å¯ä»¥è‡ªç”±åœ°äº§ç”Ÿä»»ä½•è¡Œä¸ºï¼Œæ— è®ºæ˜¯å´©æºƒã€äº§ç”Ÿé”™è¯¯ç»“æœï¼Œè¿˜æ˜¯çœ‹ä¼¼æ­£å¸¸è¿è¡Œä½†ç»“æœä¸å¯é¢„æµ‹ã€‚è¿™ä½¿å¾—æ•°æ®ç«äº‰æˆä¸ºéå¸¸å±é™©ä¸”éš¾ä»¥è°ƒè¯•çš„å¹¶å‘é”™è¯¯ï¼Œå› ä¸ºå®ƒçš„è¡¨ç°å¯èƒ½æ˜¯ä¸ç¡®å®šã€ä¸ç¨³å®šçš„ã€‚
å¤šçº¿ç¨‹ä¸å¤šå†…å­˜çš„å¤æ‚äº¤äº’ï¼šåœ¨å®é™…çš„å¹¶å‘ç¨‹åºä¸­ï¼Œé€šå¸¸ä¼šæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å¤šä¸ªå…±äº«å†…å­˜ä½ç½®ã€‚è¿™äº›çº¿ç¨‹å’Œå†…å­˜ä¹‹é—´å­˜åœ¨å¤æ‚çš„è¯»ï¼ˆRï¼‰å†™ï¼ˆWï¼‰äº¤äº’ã€‚ä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªå†…å­˜ä½ç½®çš„å†™å…¥å¯èƒ½å½±å“åˆ°å…¶ä»–å¤šä¸ªçº¿ç¨‹å¯¹è¯¥ä½ç½®çš„è¯»å–ï¼ŒåŒæ—¶ï¼Œå¤šä¸ªå†…å­˜ä½ç½®ä¹‹é—´ä¹Ÿå¯èƒ½å­˜åœ¨å¤æ‚çš„ä¾èµ–å…³ç³»å’Œç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚è¿™ç§é”™ç»¼å¤æ‚çš„äº¤äº’ç½‘ç»œè¿›ä¸€æ­¥åŠ å‰§äº†æ•°æ®ç«äº‰çš„ä¸å¯é¢„æµ‹æ€§ã€‚
ä¸ºäº†æ¶ˆç­æ•°æ®ç«äº‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯ç¨‹åºçš„ serializability ï¼Œå¯èƒ½ç«äº‰çš„å†…å­˜è®¿é—®è¦ä¹ˆäº’æ–¥ï¼Œè¦ä¹ˆåŒæ­¥
å®é™…ç¼–ç¨‹ä¸­é‡åˆ°çš„æ•°æ®ç«äº‰ bug å¤§å¤šå±äºä¸Šé”™äº†é”å’Œå¿˜è®°ä¸Šé”ä¸¤ç§æƒ…å†µçš„å˜ç§
Case 1: ä¸Šé”™äº†é”
1 2 void T_1() { spin_lock(&amp;A); sum++; spin_unlock(&amp;A); } void T_2() { spin_lock(&amp;B); sum++; spin_unlock(&amp;B); } Case 2: å¿˜è®°ä¸Šé”
1 2 void T_1() { spin_lock(&amp;A); sum++; spin_unlock(&amp;A); } void T_2() { sum++; } ä½†æ˜¯å®é™…ç³»ç»Ÿé¢ä¸´çš„æƒ…å†µæ¯”è¿™å¤æ‚çš„å¤šï¼Œå› ä¸º
å†…å­˜å¯ä»¥æ˜¯åœ°å€ç©ºé—´çš„ä»»ä½•å†…å­˜ï¼Œæ¯”å¦‚å…¨å±€å˜é‡ã€å †å†…å­˜åˆ†é…çš„å˜é‡ã€ç¨‹åºçš„æ ˆâ€¦â€¦ è®¿é—®å¯ä»¥å‘ç”Ÿåœ¨ä»»ä½•ä»£ç ï¼Œæ¯”å¦‚è‡ªå·±çš„ä»£ç ã€æ¡†æ¶ä»£ç ã€ä¸€è¡Œæ²¡è¯»åˆ°çš„æ±‡ç¼–æŒ‡ä»¤ã€æŸæ¡ ret æŒ‡ä»¤ â€œä¸€è¡Œæ²¡è¯»åˆ°çš„æ±‡ç¼–æŒ‡ä»¤â€é€ æˆçš„è®¿é—®çš„æƒ…å†µæœ‰ç¼–è¯‘å™¨ä¼˜åŒ–é€ æˆçš„æŒ‡ä»¤é‡æ’ã€ç¡¬ä»¶å±‚é¢å¼±å†…å­˜æ¨¡å‹çš„å†…å­˜è®¿é—®é‡æ’ã€è¿˜æœ‰ä¸€äº›é«˜å±‚è¯­è¨€æ“ä½œçš„éšå¼å†…å­˜è®¿é—® å®é™…ç³»ç»Ÿä¸­è™½ç„¶éš¾ä»¥é¿å…ï¼Œä½†æ˜¯ä¼šå°½å¯èƒ½ä¿è¯åº•å±‚çš„ç»“æ„å¯¹ä¸Šå±‚å°½å¯èƒ½å°é—­æ¥é˜²æ­¢è¿™ç§é”™è¯¯ æ­»é” æ­»é” (Deadlock) æ˜¯æŒ‡ä¸€ä¸ªç¾¤ä½“ä¸­çš„æ¯ä¸ªæˆå‘˜éƒ½åœ¨ç­‰å¾…å…¶ä»–æˆå‘˜ï¼ˆåŒ…æ‹¬è‡ªèº«ï¼‰é‡‡å–è¡ŒåŠ¨çš„çŠ¶æ€
æ­»é”æœ‰ä¸¤ç§ï¼š
AA-Deadlock: è‡ªå·±ç­‰å¾…è‡ªå·±
1 2 3 4 5 6 7 lock(&amp;lk); // lk->locked == âœ…; proceed ... // Possibly in interrupt handler lock(&amp;lk); // while (lk->locked == âŒ) ; è¿™æ ·çš„é”™è¯¯è™½ç„¶çœ‹èµ·æ¥å¾ˆå‚»ï¼Œä½†æ˜¯åœ¨çœŸå®ç¨‹åºå¤æ‚çš„æ§åˆ¶æµä¸­æ˜¯å¯èƒ½å‡ºç°çš„
...</p></div><footer class=entry-footer>2 min&nbsp;Â·&nbsp;diefish</footer><a class=entry-link aria-label="post link to 17. å¹¶å‘ Bugs" href=https://diefish1024.github.io/posts/nju-os-2025/17-%E5%B9%B6%E5%8F%91-bugs/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>18. çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹ (1)</h2></header><div class=entry-content><p>å¹¶å‘ç¼–ç¨‹çš„æ ¸å¿ƒæŠ½è±¡æ˜¯å®ç°ä¸€ä¸ªè®¡ç®—å›¾ï¼Œè®¡ç®—å‘ç”Ÿåœ¨èŠ‚ç‚¹ä¸Šï¼Œè¾¹è¡¨ç¤ºèŠ‚ç‚¹ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼ŒåŒæ—¶è®¡ç®—å›¾åœ¨è¿è¡Œæ—¶å¯èƒ½æ˜¯åŠ¨æ€å˜åŒ–çš„
ä½¿ç”¨æ¡ä»¶å˜é‡ã€é”ã€ä¿¡å·é‡ç­‰ api å»å®ç°è®¡ç®—å›¾å¹¶ä¸æ˜¯ä¸€ä¸ªä¼˜é›…çš„å®ç°æ–¹å¼ï¼Œå› ä¸ºè¿™æ ·ä¼šåœ¨ä»£ç ä¸­å¼•å…¥ä¼—å¤šå¹²æ‰°ä»£ç ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´ä¸€äº›é—®é¢˜
ä¸ºæ­¤å¯ä»¥å¢åŠ ä¸€äº›åŠŸèƒ½å—é™çš„è¯­æ³•ï¼Œå¯ä»¥åœ¨åŒæ ·æè¿°è®¡ç®—å›¾çš„åŠŸèƒ½ä¸‹å‡å°‘äº†è®¸å¤šæ½œåœ¨çš„é—®é¢˜
é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶è¡Œç¼–ç¨‹ åœ¨é«˜æ€§èƒ½è®¡ç®—ä¸­ï¼Œè®¡ç®—å›¾é€šå¸¸æ˜“äºé™æ€åˆ‡åˆ†ï¼Œå°¤å…¶é€‚ç”¨äºç‰©ç†æ¨¡æ‹Ÿçš„ç½‘æ ¼åˆ’åˆ†ï¼Œä¸ºæ­¤ HPC å‘å±•å‡ºå¤šç§é«˜æ•ˆçš„å¹¶è¡Œç¼–ç¨‹æ¨¡å‹ï¼Œå…·ä½“å­¦ä¹ å¯ä»¥å‚è€ƒ SJTU HPC å­¦ä¹ æ‰‹å†Œ
MPI: åˆ†å¸ƒå¼å†…å­˜å¹¶è¡Œ æ¯ä¸ª MPI è¿›ç¨‹æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œè¿›ç¨‹é—´é€šè¿‡æ˜¾å¼æ¶ˆæ¯ä¼ é€’ï¼ˆå‘é€/æ¥æ”¶ï¼‰äº¤æ¢æ•°æ®
OpenMP: å…±äº«å†…å­˜å¹¶è¡Œ å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€åœ°å€ç©ºé—´ä¸­å¹¶è¡Œæ‰§è¡Œï¼Œæ‰€æœ‰çº¿ç¨‹å¯ä»¥ç›´æ¥è®¿é—®ç›¸åŒçš„æ•°æ®ï¼Œä½¿ç”¨Â #pragma ompÂ æŒ‡ä»¤å®ç°å¹¶è¡ŒåŒ–
å¯¹éè®¡ç®—æœºä¸“ä¸šæ¥è¯´éå¸¸å‹å¥½ï¼Œåªéœ€è¦åœ¨æ­£å¸¸çš„ä»£ç ä¸Šé¢åŠ ä¸Šç¼–è¯‘æŒ‡ä»¤å³å¯ï¼Œèƒ½è½»æ¾å®ç°é«˜æ•ˆçš„å¹¶è¡Œä¼˜åŒ–
CUDA: GPU å¼‚æ„å¹¶è¡Œ CPU è°ƒåº¦ï¼ŒGPU æ‰§è¡Œå¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—
æ¦‚å¿µï¼š
æ ¸å‡½æ•° (Kernel) ï¼šåœ¨ GPU ä¸Šå¹¶è¡Œæ‰§è¡Œçš„å‡½æ•° çº¿ç¨‹å±‚æ¬¡ï¼šçº¿ç¨‹ (threadIdx) ç»„æˆçº¿ç¨‹å— (blockIdx)ï¼Œçº¿ç¨‹å—ç»„æˆç½‘æ ¼ (gridDim) å†…å­˜å±‚æ¬¡ï¼šå¯„å­˜å™¨ã€å…±äº«å†…å­˜ï¼ˆå—å†…é«˜é€Ÿï¼‰ã€å…¨å±€å†…å­˜ï¼ˆæ‰€æœ‰çº¿ç¨‹å¯è®¿é—®ï¼‰ æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹ ä» Web 1.0 åˆ° Web 2.0 åœ¨ Web æ—¶ä»£ç”¨çš„æœ€å¹¿æ³›çš„æ˜¯ Javascript
Asynchronous JavaScript and XML (Ajax; ~1999) å…è®¸ç½‘é¡µå®ç°â€œåå°åˆ·æ–°â€ jQuery $ (2006): A DOM Query Language (ç¼–ç¨‹æŠ½è±¡) Web 2.0 æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹ çº¿ç¨‹å¼€é”€å¤§ï¼Œå¹¶ä¸”å¤§å¤šæ•° Web å¼€å‘è€…éš¾ä»¥è¿›è¡Œå¹¶å‘ç¼–ç¨‹
...</p></div><footer class=entry-footer>1 min&nbsp;Â·&nbsp;diefish</footer><a class=entry-link aria-label="post link to 18. çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹ (1)" href=https://diefish1024.github.io/posts/nju-os-2025/18-%E7%9C%9F%E5%AE%9E%E4%B8%96%E7%95%8C%E7%9A%84%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-1/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>19. çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹ (2)</h2></header><div class=entry-content><p>CPU å†…çš„å¹¶è¡Œç¼–ç¨‹ CPU çš„åŠŸè€— $ P=C\cdot V^{2}\cdot f $ å¯¼è‡´çºµä½¿æœ‰æ›´å¤§çš„ç”µè·¯ï¼Œçƒ­åŠŸè€—é™åˆ¶äº†æ€§èƒ½ä¸Šé™ï¼Œä»è€Œæœ‰ä¸€å µâ€œåŠŸè€—å¢™â€é™åˆ¶äº† CPU çš„æ€§èƒ½ï¼Œä¸ºæ­¤éœ€è¦è€ƒè™‘å¦‚ä½•åœ¨é™ä½ $ V $ å’Œ $ f $ çš„åŒæ—¶ç”¨é¢ç§¯æ¢æ€§èƒ½
æœ‰ä¸¤ä¸ªæ€è·¯ï¼š
è®©ä¸€æ¡æŒ‡ä»¤èƒ½å¤„ç†æ›´å¤šçš„æ•°æ®ï¼šSIMD (Single Instruction, Multiple Data)
â€œä¸€æ¡æŒ‡ä»¤â€ æµªè´¹çš„èƒ½é‡å¤§è‡´æ˜¯å®šæ•° å¤„ç†çš„æ•°æ®è¶Šå¤šï¼Œæµªè´¹è¶Šå°‘ ç”¨æ›´å¤šæ›´ç®€å•çš„å¤„ç†å™¨ï¼šå¤šå¤„ç†å™¨ç³»ç»Ÿã€å¼‚æ„å¤šå¤„ç†å™¨
åŒç­‰é¢ç§¯ï¼Œå¤„ç†å™¨è¶Šç®€å•ï¼Œæ•°é‡è¶Šå¤š å¼‚æ„è®¡ç®—ï¼šæœ€ç»å…¸çš„ä¾‹å­æ˜¯å¤§å°æ ¸æ¶æ„ï¼ˆå¦‚ Apple M1ï¼‰ SIMD SIMD çš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨ç¡¬ä»¶å±‚é¢å®ç°æ•°æ®çº§å¹¶è¡Œï¼Œå®ƒé€šè¿‡å¼•å…¥ä¸“é—¨çš„ç¡¬ä»¶å•å…ƒæ¥è¾¾æˆè¿™ä¸ªç›®æ ‡ï¼š
å®½ä½å¯„å­˜å™¨ (Wide Registers)ï¼šCPU å†…éƒ¨å¢åŠ äº†æ¯”é€šç”¨å¯„å­˜å™¨å®½å¾ˆå¤šçš„ä¸“ç”¨å¯„å­˜å™¨
Intel çš„ SSE æŒ‡ä»¤é›†å¼•å…¥äº† 128 ä½çš„ XMM å¯„å­˜å™¨ï¼Œè€Œæœ€æ–°çš„ AVX-512 æ‹¥æœ‰ 512 ä½çš„ ZMM å¯„å­˜å™¨ è¿™äº›å®½ä½å¯„å­˜å™¨å¯ä»¥ä¸€æ¬¡æ€§è£…å…¥å¤šä¸ªæ•°æ®å…ƒç´ ï¼Œæ¯”å¦‚ä¸€ä¸ª 128 ä½çš„å¯„å­˜å™¨å¯ä»¥åŒæ—¶å®¹çº³ 4 ä¸ª 32 ä½çš„æµ®ç‚¹æ•°ï¼Œæˆ–è€… 16 ä¸ª 8 ä½çš„æ•´æ•° è¿™äº›è¢«æ‰“åŒ…åœ¨ä¸€èµ·çš„æ•°æ®è¢«ç§°ä¸º Vector å‘é‡å¤„ç†å•å…ƒ (Vector ALU)ï¼šCPU å†…éƒ¨ä¹Ÿé…å¤‡äº†èƒ½å¤Ÿå¯¹æ•´ä¸ªå‘é‡è¿›è¡Œå¹¶è¡Œè®¡ç®—çš„ ALU
...</p></div><footer class=entry-footer>2 min&nbsp;Â·&nbsp;diefish</footer><a class=entry-link aria-label="post link to 19. çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹ (2)" href=https://diefish1024.github.io/posts/nju-os-2025/19-%E7%9C%9F%E5%AE%9E%E4%B8%96%E7%95%8C%E7%9A%84%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-2/></a></article><footer class=page-footer><nav class=pagination><a class=next href=https://diefish1024.github.io/categories/course-note/page/2/>Next&nbsp;&nbsp;Â»</a></nav></footer></main><footer class=footer><span>&copy; 2025 <a href=https://diefish1024.github.io/>diefish's blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>