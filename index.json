[{"content":"åŒæ­¥å’Œæ¡ä»¶å˜é‡ äº’æ–¥å®ç°äº†åŸå­æ€§ï¼Œä½†æ˜¯æ— æ³•å®ç°ç¡®å®šæ€§ï¼Œä¹Ÿå°±æ˜¯æ— æ³•æ­£ç¡®å®ç° \u0026ldquo;happens-before\u0026rdquo; çš„å…³ç³»\nå› æ­¤éœ€è¦å¼•å…¥æ¡ä»¶å˜é‡æ¥å®ç°çº¿ç¨‹çš„åŒæ­¥ï¼Œå½¢æˆå—æ§åˆ¶çš„å¹¶å‘äº‹ä»¶çš„å‘ç”Ÿé¡ºåºï¼ˆå¯ä»¥ç”¨ä¹å›¢æŒ‡æŒ¥æ¥ç±»æ¯”ï¼‰ï¼ŒæŠŠä¸€ç³»åˆ—ä¸ç¡®å®šçš„çŠ¶æ€åœ¨æŸä¸€ä¸ªæ—¶é—´ç‚¹åŒæ­¥åˆ°äº†ä¸€ä¸ªç¡®å®šçš„çŠ¶æ€ï¼Œå°†å‘æ•£çš„å¹¶å‘ç¨‹åºçŠ¶æ€ â€œæ”¶æŸâ€\nå®ç°åŒæ­¥\nå®ç° $ A\\to B $ï¼š\n1 2 3 4 5 6 7 A; can_proceed = true; (signal) while(!can_proceed); B // B: wait until the condition is satisfied è¿™æ ·çš„æ€è·¯å¤§è‡´æ­£ç¡®ï¼Œä½†æ˜¯è‡ªé€‰çš„å¾ªç¯æœ‰å¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªæ›´åŠ åº•å±‚çš„æœºåˆ¶æ¥å¸®åŠ©å®ç°è¿™ä¸€ç‚¹\næœ€ç†æƒ³çš„ API æ˜¯ wait_until(cond) ï¼Œä½†æ˜¯è¿‡å»ä¸ºäº†ç®€åŒ–è®¾è®¡ï¼Œå˜æˆäº†\næ¡ä»¶ä¸æ»¡è¶³æ—¶ç­‰å¾…ï¼šwait - ç›´æ¥ç¡çœ ç­‰å¾… æ¡ä»¶æ»¡è¶³æ—¶ç»§ç»­ï¼šsignal/broadcast - å”¤é†’æ‰€æœ‰çº¿ç¨‹ ï¼ˆå°æ—¶å€™çš„ scratch ç¼–ç¨‹å…¶å®å·²ç»æœ‰äº†è¿™æ ·çš„æ€æƒ³ğŸ˜‚ï¼‰\nåœ¨ c++ ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥æŠŠæ¡ä»¶æ”¾åˆ° $ \\lambda $ è¡¨è¾¾å¼ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 std::mutex mtx; std::condition_variable cv; void T_player() { std::unique_lock lk(mtx); cv.wait(lk, []{ return can_proceed; } ); cv.notify_all(); lk.unlock(); } æ³¨æ„æ¡ä»¶å˜é‡åœ¨ç­‰å¾…æ—¶éœ€è¦å¸¦ç€ä¸€æŠŠé”ï¼ˆéœ€è¦ç¡®ä¿æ£€æŸ¥å’Œç­‰å¾…æ˜¯åŸå­æ“ä½œï¼‰\nä½¿ç”¨æ¡ä»¶å˜é‡è§£å†³åŒæ­¥é—®é¢˜ å¤§éƒ¨åˆ†çš„åŒæ­¥é—®é¢˜éƒ½å¯ä»¥ç”¨ç»å…¸çš„ç”Ÿäº§è€… - æ¶ˆè´¹è€…é—®é¢˜å½’çº³ï¼š\nProducer å’Œ Consumer å…±äº«ä¸€ä¸ªç¼“å†²åŒºï¼Œå…¶ä¸­\nProducer çœ‹åˆ°ç¼“å†²åŒºæœ‰ç©ºä½å°±ä¼šæ”¾å…¥ï¼Œå¦åˆ™ç­‰å¾… Consumer çœ‹åˆ°ç¼“å†²åŒºæœ‰æ•°æ®å°±å›å»èµ°ï¼Œå¦åˆ™ç­‰å¾… æ˜¾ç„¶ä¸€ä¸ªå¯¹è±¡çš„ç”Ÿäº§å’Œæ¶ˆè´¹å¿…é¡»æ»¡è¶³ \u0026ldquo;happens-before\u0026rdquo; çš„å…³ç³»\nå¯ä»¥ç­‰ä»·æˆæ‰“å°åŒ¹é…çš„æ‹¬å·ï¼Œå¹¶ä¸”åµŒå¥—æ·±åº¦æœ‰ä¸Šé™ï¼ˆç¼“å†²åŒºçš„æ·±åº¦ï¼‰\nå¤„ç†è¿™æ ·çš„é—®é¢˜é¦–å…ˆè¦æƒ³æ¸…æ¥šç¨‹åºç»§ç»­æ‰§è¡Œçš„æ¡ä»¶ï¼Œæ¯”å¦‚ç”Ÿäº§çš„æ¡ä»¶æ˜¯ $ d0 $ ï¼Œç„¶åå¥—å…¥å›ºå®šçš„æ¨¡æ¿ä»£ç å³å¯ï¼š\n1 2 3 4 5 6 mutex_lock(lk); while (!cond) { // cond can be any calculate cond_wait(\u0026amp;cv, lk); } assert(cond); mutex_lock(lk); 1 2 3 4 mutex_lock(lk); cond = true cond_broadcast(\u0026amp;cv); //âš ï¸ mutex_unlock(lk); æ³¨æ„ï¼šå…¨å±€å¹¿æ’­ cond_broadcast ä¸èƒ½è¢«æ›¿æ¢æˆå•ç‹¬å”¤é†’ä¸€ä¸ªçº¿ç¨‹ cond_signal ï¼Œåœ¨è¿™é‡Œæ˜¾ç„¶å¯èƒ½ä¼šå¯¼è‡´æ‰€æœ‰è¿›ç¨‹éƒ½è¢«é”ä½æ— æ³•è§¦å‘æ–°çš„åŒæ­¥å˜é‡ï¼›å¹¶å‘ç¼–ç¨‹å¾ˆå¤šçœ‹èµ·æ¥æ­£ç¡®çš„åœ°æ–¹éƒ½éœ€è¦ä»”ç»†æ€è€ƒ\né‡åˆ°ä»»ä½•åŒæ­¥é—®é¢˜çš„æ ¸å¿ƒéƒ½æ˜¯åŒæ­¥æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Œæ¯”å¦‚æ‹¬å·æ‰“å°å¯ä»¥æ‹“å±•æˆæ‰“å° \u0026lt;\u0026gt;\u0026lt; æˆ–è€… \u0026gt;\u0026lt;\u0026gt; ä¸¤ç§å½¢çŠ¶ï¼Œæ ¸å¿ƒä¹Ÿæ˜¯ç”»å‡ºçŠ¶æ€æœºï¼Œæ‰¾åˆ°åŒæ­¥æ¡ä»¶ï¼Œå†å¥—å…¥æ¨¡æ¿å°±è§£å†³äº†é—®é¢˜\nè®¡ç®—å›¾ä¸å¹¶å‘æ§åˆ¶ å¹¶è¡Œè®¡ç®—çš„æ¨¡å‹å¯ä»¥ç”¨ä¸€ä¸ª DAG è®¡ç®—å›¾å»ç†è§£ï¼Œä»»åŠ¡ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œé€šè¿‡æ‹“æ‰‘æ’åºçš„é¡ºåºå»è§£å†³é—®é¢˜ï¼Œç›¸äº’ä¸å­˜åœ¨ \u0026ldquo;happens-before\u0026rdquo; ä¾èµ–å…³ç³»çš„ä»»åŠ¡éƒ½å¯ä»¥å¹¶å‘è§£å†³\nä¸ºäº†ä¼˜åŒ–æ•ˆç‡ï¼Œæˆ‘ä»¬å¯¹è®¡ç®—ä»»åŠ¡çš„åˆ†é…éœ€è¦ä¿è¯æ¯ä¸ªèŠ‚ç‚¹è®¡ç®—çš„æ¶ˆè€—æ˜¯è¿œå¤§äºåŒæ­¥å’Œé”çš„å¼€é”€çš„ï¼Œå› æ­¤å®é™…ä¸Šå¯èƒ½æ˜¯æŠŠå¾ˆå¤šä¸ªå°çš„ä»»åŠ¡èšåˆæˆä¸€ä¸ªå¤§çš„å¹¶å‘è®¡ç®—èŠ‚ç‚¹ï¼Œäº¤ç»™ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œ\nå®ç°è®¡ç®—å›¾æœ‰ä¸¤ç§æ€è·¯ï¼Œç¬¬ä¸€ç§æ˜¯æœ´ç´ çš„ä¸ºæ¯ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸€ä¸ªçº¿ç¨‹å’Œæ¡ä»¶å˜é‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // The dependency edge is u-\u0026gt;v void T_u() { // calculate u mutex_lock(v-\u0026gt;lock); v-\u0026gt;num_done++; cond_signal(v-\u0026gt;cv); // it\u0026#39;s okay mutex_unlock(v-\u0026gt;lock); } void T_v() { mutex_lock(v-\u0026gt;lock); while (!(v-\u0026gt;num_done == v-\u0026gt;num_predecessors)){ cond_wait(v-\u0026gt;cv, v-\u0026gt;lock); } mutex_unlock(v-\u0026gt;lock); // calculate v } ä½†æ˜¯è¿™æ ·å®é™…ä¼šäº§ç”Ÿè¿‡å¤šçš„çº¿ç¨‹ï¼Œé€ æˆä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ï¼ˆæ¯”å¦‚äº§ç”Ÿäº†å¤šä½™ CPU çš„ core æ•°é‡çš„çº¿ç¨‹ï¼‰ï¼Œå®é™…ä¸Šæ›´ä¼˜çš„åŠæ³•æ˜¯åˆ›å»ºä¸€ä¸ªä»»åŠ¡è°ƒåº¦å™¨çº¿ç¨‹ $ T_{\\text{scheduler}} $ æ¥ä¸“é—¨æ§åˆ¶äº§ç”Ÿ $ T_{\\text{worker}} $ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 mutex_lock(lk); while (!(all_done || has_job(tid))) { cond_wait(\u0026amp;worker_cv[tid], lk); } mutex_unlock(lk); if (all_done) { break; } else { process_job(tid); } signal(\u0026amp;sched_cv); ","permalink":"https://diefish1024.github.io/posts/nju-os-2025/15-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E5%90%8C%E6%AD%A5%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/","summary":"\u003ch2 id=\"åŒæ­¥å’Œæ¡ä»¶å˜é‡\"\u003eåŒæ­¥å’Œæ¡ä»¶å˜é‡\u003c/h2\u003e\n\u003cp\u003eäº’æ–¥å®ç°äº†\u003cstrong\u003eåŸå­æ€§\u003c/strong\u003eï¼Œä½†æ˜¯æ— æ³•å®ç°\u003cstrong\u003eç¡®å®šæ€§\u003c/strong\u003eï¼Œä¹Ÿå°±æ˜¯æ— æ³•æ­£ç¡®å®ç° \u0026ldquo;happens-before\u0026rdquo; çš„å…³ç³»\u003c/p\u003e\n\u003cp\u003eå› æ­¤éœ€è¦å¼•å…¥æ¡ä»¶å˜é‡æ¥å®ç°çº¿ç¨‹çš„åŒæ­¥ï¼Œå½¢æˆå—æ§åˆ¶çš„å¹¶å‘äº‹ä»¶çš„\u003cstrong\u003eå‘ç”Ÿé¡ºåº\u003c/strong\u003eï¼ˆå¯ä»¥ç”¨ä¹å›¢æŒ‡æŒ¥æ¥ç±»æ¯”ï¼‰ï¼ŒæŠŠä¸€ç³»åˆ—ä¸ç¡®å®šçš„çŠ¶æ€åœ¨æŸä¸€ä¸ªæ—¶é—´ç‚¹åŒæ­¥åˆ°äº†ä¸€ä¸ªç¡®å®šçš„çŠ¶æ€ï¼Œå°†å‘æ•£çš„å¹¶å‘ç¨‹åºçŠ¶æ€ â€œæ”¶æŸâ€\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå®ç°åŒæ­¥\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå®ç° $ A\\to B $ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-gdscript3\" data-lang=\"gdscript3\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ecan_proceed\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esignal\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003ecan_proceed\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eB\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e//\u003c/span\u003e \u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ewait\u003c/span\u003e \u003cspan class=\"n\"\u003euntil\u003c/span\u003e \u003cspan class=\"n\"\u003ethe\u003c/span\u003e \u003cspan class=\"n\"\u003econdition\u003c/span\u003e \u003cspan class=\"n\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003esatisfied\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eè¿™æ ·çš„æ€è·¯å¤§è‡´æ­£ç¡®ï¼Œä½†æ˜¯è‡ªé€‰çš„å¾ªç¯æœ‰å¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªæ›´åŠ åº•å±‚çš„æœºåˆ¶æ¥å¸®åŠ©å®ç°è¿™ä¸€ç‚¹\u003c/p\u003e\n\u003cp\u003eæœ€ç†æƒ³çš„ API æ˜¯ \u003ccode\u003ewait_until(cond)\u003c/code\u003e ï¼Œä½†æ˜¯è¿‡å»ä¸ºäº†ç®€åŒ–è®¾è®¡ï¼Œå˜æˆäº†\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ¡ä»¶ä¸æ»¡è¶³æ—¶ç­‰å¾…ï¼š\u003ccode\u003ewait\u003c/code\u003e - ç›´æ¥ç¡çœ ç­‰å¾…\u003c/li\u003e\n\u003cli\u003eæ¡ä»¶æ»¡è¶³æ—¶ç»§ç»­ï¼š\u003ccode\u003esignal/broadcast\u003c/code\u003e - å”¤é†’æ‰€æœ‰çº¿ç¨‹\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eï¼ˆå°æ—¶å€™çš„ scratch ç¼–ç¨‹å…¶å®å·²ç»æœ‰äº†è¿™æ ·çš„æ€æƒ³ğŸ˜‚ï¼‰\u003c/p\u003e\n\u003cp\u003eåœ¨ c++ ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥æŠŠæ¡ä»¶æ”¾åˆ° $ \\lambda $ è¡¨è¾¾å¼ä¸­ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c++\" data-lang=\"c++\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e \u003cspan class=\"n\"\u003emtx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003econdition_variable\u003c/span\u003e \u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eT_player\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eunique_lock\u003c/span\u003e \u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emtx\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"p\"\u003e[]{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ecan_proceed\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enotify_all\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eunlock\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eæ³¨æ„æ¡ä»¶å˜é‡åœ¨ç­‰å¾…æ—¶éœ€è¦å¸¦ç€ä¸€æŠŠé”ï¼ˆéœ€è¦ç¡®ä¿æ£€æŸ¥å’Œç­‰å¾…æ˜¯åŸå­æ“ä½œï¼‰\u003c/p\u003e","title":"15. å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥æ¡ä»¶å˜é‡"},{"content":"ä¿¡å·é‡ äº’æ–¥é”åœ¨æŸç§æ„ä¹‰ä¸Šä¹Ÿå¯ä»¥è®¤ä¸ºå®ç°äº† \u0026ldquo;happens-before\u0026rdquo; çš„ä¾èµ–å…³ç³»â€”â€” release å¿…ç„¶å‘ç”Ÿåœ¨ acquire ä¹‹å‰ã€‚æˆ‘ä»¬å¯ä»¥è¯•ç€åˆ©ç”¨è¿™ç§ä¾èµ–å…³ç³»æ¥å®ç°è®¡ç®—å›¾çš„è°ƒåº¦ï¼šä¸ºæ¯æ¡è¾¹åˆ†é…ä¸€ä¸ªäº’æ–¥é”ï¼Œä»£è¡¨æ•°æ®æˆ–å‰ç½®ä»»åŠ¡çš„å®Œæˆï¼›ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»è·å¾—æ‰€æœ‰å…¥è¾¹å¯¹åº”çš„äº’æ–¥é”æ‰èƒ½å¼€å§‹è®¡ç®—ï¼Œè®¡ç®—å®Œæˆåï¼Œå°±é‡Šæ”¾æ‰€æœ‰å‡ºè¾¹å¯¹åº”çš„äº’æ–¥é”ï¼Œé€šçŸ¥ä¸‹æ¸¸èŠ‚ç‚¹è¾“å‡ºå°±ç»ªï¼ˆä½†æ˜¯è¿™ç§ç›´æ¥ä½¿ç”¨äº’æ–¥é”ä½œä¸ºè¾¹çŠ¶æ€ä¿¡å·çš„æ–¹å¼æ˜¯ undefined behaviorï¼Œå› ä¸ºäº’æ–¥é”ä¸»è¦ç”¨äºä¿æŠ¤ä¸´ç•ŒåŒºï¼Œå…¶é‡Šæ”¾é€šå¸¸è¦æ±‚ç”±æŒæœ‰å®ƒçš„çº¿ç¨‹å®Œæˆï¼Œè‹¥é‡Šæ”¾æœªæ›¾è·å–çš„é”ï¼Œåˆ™è¡Œä¸ºæœªå®šä¹‰ï¼‰\næˆ‘ä»¬å¯ä»¥ä»è¿™ç§æƒ³æ³•ä¸­æŠ½è±¡å‡ºå…¶æœ¬è´¨ï¼Œä¹Ÿå°±æ˜¯ç”¨ä¸€ä¸ªâ€œä¿¡å·â€å»è·å–èµ„æºçš„è®¸å¯ï¼Œç±»ä¼¼é¤å…çš„å–å·åƒé¥­\nè¿™ç§ä¿¡å·çš„æ€æƒ³å¾ˆé€‚åˆç”¨æ¥ç®¡ç†è®¡æ•°ç±»å‹çš„åŒç±»èµ„æºï¼Œæ¯”å¦‚åœè½¦åœºçš„ç©ºä½ï¼Œä¸ºäº†å®ç°è¿™ç§ producer-customer çš„é—®é¢˜ï¼Œç”¨ æ¡ä»¶å˜é‡ å¯ä»¥è½»æ˜“è§£å†³ï¼Œè¿›å…¥çš„æ¡ä»¶å°±æ˜¯å­˜åœ¨ç©ºä½ count \u0026lt; capacity ï¼Œé‚£æˆ‘ä»¬ä»å‡å°‘å˜é‡çš„è§’åº¦å‡ºå‘ï¼Œè¿™å®é™…ä¸Šä¹Ÿå°±æ˜¯å‰©ä½™ç©ºä½çš„æ•°é‡å¤§äºé›¶ï¼Œæˆ‘ä»¬åœè½¦ç›¸å½“äºæ¶ˆè€—äº†ä¸€ä¸ªè½¦ä½ï¼Œç¦»å¼€ç›¸å½“äºåˆ›é€ äº†ä¸€ä¸ªè½¦ä½ï¼Œè¿™ä¹Ÿå°±å¾—åˆ°äº†æ‰€è°“â€œä¿¡å·é‡â€çš„æœºåˆ¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 void P(sem_t *sem) { // Prolaag - try + decrease/down/wait/acquire mutex_lock(\u0026amp;sem-\u0026gt;lk); while (!(sem-\u0026gt;count \u0026gt; 0)) { cond_wait(\u0026amp;sem-\u0026gt;cv, \u0026amp;sem-\u0026gt;lk); } sem-\u0026gt;count--; // æ¶ˆè€—ä¸€ä¸ªä¿¡å· (è½¦ä½) mutex_unlock(\u0026amp;sem-\u0026gt;lk); } void V(sem_t *sem) { // Verhoog - increase/up/post/signal/release mutex_lock(\u0026amp;sem-\u0026gt;lk); sem-\u0026gt;count++; // åˆ›å»ºä¸€ä¸ªä¿¡å· (è½¦ä½) cond_broadcast(\u0026amp;sem-\u0026gt;cv); mutex_unlock(\u0026amp;sem-\u0026gt;lk); } æ ¹æ®è¿™ä¸ªä¸€è·¯æ¨å‡ºä¿¡å·é‡çš„æ€è·¯ï¼Œæˆ–è®¸å¯ä»¥è®¤ä¸ºè¿™æ˜¯äº’æ–¥é”çš„æ‰©å±•\nä¿¡å·é‡ï¼šåº”ç”¨ ä¿¡å·é‡æœ‰ä¸¤ç§å…¸å‹çš„åº”ç”¨ï¼š\nå®ç°ä¸€ä¸ªä¸´æ—¶çš„ happens-beforeï¼š$ A\\to V(s)\\to P(s)\\to B $ ç®¡ç†è®¡æ•°èµ„æºï¼šåœè½¦åœºã€é¤å…â€¦â€¦ å¯ä»¥åˆ©ç”¨ä¿¡å·é‡ä¼˜é›…åœ°å®ç° producer-customer çš„æ¨¡å‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 sem_t empty = SEM_INIT(depth); sem_t fill = SEM_INIT(0); void T_produce() { P(\u0026amp;empty); printf(\u0026#34;(\u0026#34;); V(\u0026amp;fill); } void T_consume() { P(\u0026amp;fill); printf(\u0026#34;)\u0026#34;); V(\u0026amp;empty); } ä¿¡å·é‡ã€æ¡ä»¶å˜é‡ä¸åŒæ­¥ ä¿¡å·é‡å¯¹æ¯”æ¡ä»¶å˜é‡ï¼š\nä¿¡å·é‡ï¼šæ›´åŠ å¹²å‡€ä¼˜é›…ï¼Œä½†æ˜¯ä¸ä¸€å®šèƒ½å¾ˆå¥½åœ°è¡¨ç¤ºåŒæ­¥æ¡ä»¶ï¼ˆç”¨æ›´ hack çš„æ–¹å¼è§£å†³é—®é¢˜ï¼‰ æ¡ä»¶å˜é‡ï¼šæ›´åŠ ä¸‡èƒ½ï¼Œä½†æ˜¯ä»£ç æ¯”è¾ƒä¸‘é™‹ï¼ˆç”¨æ›´æ ‡å‡†åŒ–çš„æ–¹å¼è§£å†³é—®é¢˜ï¼‰ å°è¯•ç”¨ä¿¡å·é‡è§£å†³æ›´å¤æ‚çš„åŒæ­¥é—®é¢˜ï¼šå“²å­¦å®¶åƒé¥­ï¼Œä¸€å¼ åœ†æ¡Œå›´å $ n $ ä¸ªå“²å­¦å®¶ï¼Œæ¯ä¸¤ä¸ªäººä¹‹é—´æœ‰ä¸€æŠŠå‰å­ï¼ˆç­·å­æ›´åŠ åˆé€‚ï¼Ÿï¼Ÿï¼‰ï¼Œæ¯ä¸ªå“²å­¦å®¶ï¼ˆçº¿ç¨‹ï¼‰æœ‰æ—¶æ€è€ƒæœ‰æ—¶åƒé¥­ï¼Œæ€è€ƒæ—¶ä»€ä¹ˆä¹Ÿä¸ç”¨åšï¼Œåƒé¥­æ—¶åŒæ—¶éœ€è¦å·¦æ‰‹å³æ‰‹çš„å‰å­\nç”¨æ¡ä»¶å˜é‡è§£å†³è¿™ä¸ªé—®é¢˜åªéœ€è¦æ— è„‘è®¾ç½®åŒæ­¥æ¡ä»¶å³å¯ï¼Œç”¨ä¿¡å·é‡è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸€ä¸ªåˆæ­¥çš„æƒ³æ³•æ˜¯ P(\u0026amp;sem[lhs]) \u0026amp;\u0026amp; P(\u0026amp;sem[rhs]) ï¼Œä¹ä¸€çœ‹æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™ä¸ªæ¡ä»¶åœ¨æ‰€æœ‰äººéƒ½åŒæ—¶ä¸¾èµ·äº†åŒä¸€è¾¹çš„å‰å­æ—¶ä¼šé™·å…¥æ­»é”ï¼ˆæ‰€ä»¥å¹¶å‘ç¼–ç¨‹ä¸€å®šè¦ä»”ç»†å†ä»”ç»†ï¼ï¼‰ï¼Œæ‰€ä»¥ä¸ºäº†æ’é™¤è¿™ç§æ–¹æ¡ˆï¼Œæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š\nä»æ¡Œå­èµ¶èµ°ä¸€ä¸ªäººï¼šä¸ºä¸Šæ¡Œåƒé¥­äººæ•°è®¾ç½®ä¸€ä¸ªä¿¡å·é‡ï¼Œé™åˆ¶ä¸è®©æ‰€æœ‰äººåŒæ—¶ä¸Šæ¡Œå³å¯ï¼ˆæ˜¾ç„¶ä¸å¯èƒ½æ‰€æœ‰äººåŒæ—¶åƒä¸Šé¥­ï¼‰ ä¸ºå‰å­ç¼–å·ï¼Œæ€»æ˜¯å…ˆæ‹¿èµ·ç¼–å·å°çš„ä¸€æŠŠï¼ˆæœ€åä¸€ä¸ªäººçš„é¡ºåºä¼šå’Œå…¶ä»–äººåè¿‡æ¥ï¼‰ ä½†æ˜¯è¿™æ ·çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¸å¤Ÿä¼˜é›…ä¸å¤Ÿé€šç”¨çš„ï¼Œå› æ­¤æ›´å¤šæ—¶å€™æ¡ä»¶å˜é‡æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼Œå¯ä»¥æ€»ç»“ä¸ºä¿¡å·é‡åœ¨é€‚åˆçš„é€‚åˆå¾ˆå¥½ç”¨ï¼Œä½†ä¸æ€»æ˜¯å¾ˆå¥½ç”¨\n","permalink":"https://diefish1024.github.io/posts/nju-os-2025/16-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E5%90%8C%E6%AD%A5%E4%BF%A1%E5%8F%B7%E9%87%8F/","summary":"\u003ch2 id=\"ä¿¡å·é‡\"\u003eä¿¡å·é‡\u003c/h2\u003e\n\u003cp\u003eäº’æ–¥é”åœ¨æŸç§æ„ä¹‰ä¸Šä¹Ÿå¯ä»¥è®¤ä¸ºå®ç°äº† \u0026ldquo;happens-before\u0026rdquo; çš„ä¾èµ–å…³ç³»â€”â€” release å¿…ç„¶å‘ç”Ÿåœ¨ acquire ä¹‹å‰ã€‚æˆ‘ä»¬å¯ä»¥è¯•ç€åˆ©ç”¨è¿™ç§ä¾èµ–å…³ç³»æ¥å®ç°è®¡ç®—å›¾çš„è°ƒåº¦ï¼šä¸ºæ¯æ¡è¾¹åˆ†é…ä¸€ä¸ªäº’æ–¥é”ï¼Œä»£è¡¨æ•°æ®æˆ–å‰ç½®ä»»åŠ¡çš„å®Œæˆï¼›ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»è·å¾—æ‰€æœ‰å…¥è¾¹å¯¹åº”çš„äº’æ–¥é”æ‰èƒ½å¼€å§‹è®¡ç®—ï¼Œè®¡ç®—å®Œæˆåï¼Œå°±é‡Šæ”¾æ‰€æœ‰å‡ºè¾¹å¯¹åº”çš„äº’æ–¥é”ï¼Œé€šçŸ¥ä¸‹æ¸¸èŠ‚ç‚¹è¾“å‡ºå°±ç»ªï¼ˆä½†æ˜¯è¿™ç§ç›´æ¥ä½¿ç”¨äº’æ–¥é”ä½œä¸ºè¾¹çŠ¶æ€ä¿¡å·çš„æ–¹å¼æ˜¯ undefined behaviorï¼Œå› ä¸ºäº’æ–¥é”ä¸»è¦ç”¨äºä¿æŠ¤ä¸´ç•ŒåŒºï¼Œå…¶é‡Šæ”¾é€šå¸¸è¦æ±‚ç”±æŒæœ‰å®ƒçš„çº¿ç¨‹å®Œæˆï¼Œè‹¥é‡Šæ”¾æœªæ›¾è·å–çš„é”ï¼Œåˆ™è¡Œä¸ºæœªå®šä¹‰ï¼‰\u003c/p\u003e\n\u003cp\u003eæˆ‘ä»¬å¯ä»¥ä»è¿™ç§æƒ³æ³•ä¸­æŠ½è±¡å‡ºå…¶æœ¬è´¨ï¼Œä¹Ÿå°±æ˜¯ç”¨ä¸€ä¸ªâ€œ\u003cstrong\u003eä¿¡å·\u003c/strong\u003eâ€å»è·å–èµ„æºçš„è®¸å¯ï¼Œç±»ä¼¼é¤å…çš„å–å·åƒé¥­\u003c/p\u003e\n\u003cp\u003eè¿™ç§\u003cstrong\u003eä¿¡å·\u003c/strong\u003eçš„æ€æƒ³å¾ˆé€‚åˆç”¨æ¥ç®¡ç†\u003cstrong\u003eè®¡æ•°ç±»å‹çš„åŒç±»èµ„æº\u003c/strong\u003eï¼Œæ¯”å¦‚åœè½¦åœºçš„ç©ºä½ï¼Œä¸ºäº†å®ç°è¿™ç§ producer-customer çš„é—®é¢˜ï¼Œç”¨ \u003ca href=\"15.%20%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%EF%BC%9A%E5%90%8C%E6%AD%A5%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F.md\"\u003eæ¡ä»¶å˜é‡\u003c/a\u003e å¯ä»¥è½»æ˜“è§£å†³ï¼Œè¿›å…¥çš„æ¡ä»¶å°±æ˜¯å­˜åœ¨ç©ºä½ \u003ccode\u003ecount \u0026lt; capacity\u003c/code\u003e ï¼Œé‚£æˆ‘ä»¬ä»å‡å°‘å˜é‡çš„è§’åº¦å‡ºå‘ï¼Œè¿™å®é™…ä¸Šä¹Ÿå°±æ˜¯å‰©ä½™ç©ºä½çš„æ•°é‡å¤§äºé›¶ï¼Œæˆ‘ä»¬åœè½¦ç›¸å½“äº\u003cstrong\u003eæ¶ˆè€—\u003c/strong\u003eäº†ä¸€ä¸ªè½¦ä½ï¼Œç¦»å¼€ç›¸å½“äº\u003cstrong\u003eåˆ›é€ \u003c/strong\u003eäº†ä¸€ä¸ªè½¦ä½ï¼Œè¿™ä¹Ÿå°±å¾—åˆ°äº†æ‰€è°“â€œ\u003cstrong\u003eä¿¡å·é‡\u003c/strong\u003eâ€çš„æœºåˆ¶\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003esem_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// Prolaag - try + decrease/down/wait/acquire\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003emutex_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nf\"\u003econd_wait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// æ¶ˆè€—ä¸€ä¸ªä¿¡å· (è½¦ä½)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003emutex_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003esem_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// Verhoog - increase/up/post/signal/release\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003emutex_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// åˆ›å»ºä¸€ä¸ªä¿¡å· (è½¦ä½)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003econd_broadcast\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nf\"\u003emutex_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eæ ¹æ®è¿™ä¸ªä¸€è·¯æ¨å‡ºä¿¡å·é‡çš„æ€è·¯ï¼Œæˆ–è®¸å¯ä»¥è®¤ä¸ºè¿™æ˜¯äº’æ–¥é”çš„æ‰©å±•\u003c/p\u003e","title":"16. å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ä¿¡å·é‡"},{"content":"æ•°æ®ç«äº‰ å¤§å¤šå¹¶å‘ bug æœ€åéƒ½ä¼šä½“ç°ä¸ºæ•°æ®ç«äº‰ (Data Race)\nå¯¹äºé¡ºåºç¨‹åºè€Œè¨€ï¼Œå‡½æ•° f() è¿”å›ä¹‹åå°±å·²ç»å®Œæˆäº†æ‰€æœ‰çš„çŠ¶æ€ä¿®æ”¹ï¼Œå¯¹äºå…¶ä»–éƒ¨åˆ†è€Œè¨€è¿™ä¸ªä¿®æ”¹æ˜¯ç«‹å³ç”Ÿæ•ˆçš„ï¼›å¦‚æœå¯¹äºå¹¶å‘ç¨‹åºè€Œè¨€æ¨¡å¼çš„åˆ‡æ¢ä¹Ÿåœ¨ç¬é—´å®Œæˆï¼Œé‚£å°±ä¸ä¼šå¯¼è‡´å¹¶å‘çš„é—®é¢˜\nç„¶è€Œå®é™…ä¸Šæ¨¡å¼çš„åˆ‡æ¢éœ€è¦æ—¶é—´ï¼Œæ‰§è¡Œçš„æ“ä½œåœ¨æœªæ¥ä¸€æ®µæ—¶é—´ä¹‹åæ‰ä¼šå°±ç»ªï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å®é™…ç¼–ç¨‹æ—¶æ€»æ˜¯å®¹æ˜“æœ‰â€œç«‹å³ç”Ÿæ•ˆâ€çš„è‚Œè‚‰è®°å¿†ï¼Œè¿™å°±å¯¼è‡´äº†å¹¶å‘é—®é¢˜çš„å¯èƒ½æ€§\nä¸è¿‡å¯¹äºå‡½æ•°å¼ç¼–ç¨‹è€Œè¨€ï¼Œæ“ä½œä¸å­˜åœ¨å¯¹å¤–çŠ¶æ€çš„ä¿®æ”¹ï¼Œæ²¡æœ‰å‰¯ä½œç”¨ï¼ˆåªä¼šæ“ä½œå±€éƒ¨å˜é‡ï¼‰ï¼Œè¿™å°±ä¸ä¼šå¯¼è‡´å¹¶å‘é—®é¢˜\nData Race å‘ç”Ÿçš„å®è´¨æ˜¯ä¸åŒçš„çº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€å†…å­˜ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™ï¼Œå½¢è±¡çš„ç†è§£å°±æ˜¯ä¸åŒçš„å†…å­˜è®¿é—®åœ¨â€œèµ›è·‘â€ï¼Œè·‘èµ¢çš„æ“ä½œå…ˆæ‰§è¡Œ\nNot that easy: è™½ç„¶æˆ‘ä»¬å°†æ•°æ®ç«äº‰å½¢è±¡åœ°æ¯”å–»ä¸ºâ€œèµ›è·‘â€ï¼Œä½†å®é™…ä¸Šï¼Œå“ªä¸€ä¸ªæ“ä½œèƒ½â€œè·‘èµ¢â€å¹¶æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•å’Œç¡®å®šï¼Œå…¶å¤æ‚æ€§ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢\nå¼±å†…å­˜æ¨¡å‹ (Weak memory model)ï¼šåœ¨ç°ä»£å¤„ç†å™¨æ¶æ„ä¸­ï¼Œä¸ºäº†æå‡æ€§èƒ½ï¼Œå¤„ç†å™¨å¯èƒ½ä¼šå¯¹å†…å­˜æ“ä½œè¿›è¡Œé‡æ’åºã€‚è¿™æ„å‘³ç€ï¼Œä¸åŒçš„çº¿ç¨‹æˆ–â€œè§‚å¯Ÿè€…â€åœ¨ä¸åŒæ—¶é—´ç‚¹çœ‹åˆ°å…±äº«å†…å­˜çš„çŠ¶æ€å¯èƒ½æ˜¯ä¸ä¸€è‡´çš„ã€‚ä¸€ä¸ªçº¿ç¨‹å¯¹å†…å­˜çš„å†™å…¥æ“ä½œï¼Œå¯èƒ½ä¸ä¼šç«‹å³å¯¹æ‰€æœ‰å…¶ä»–çº¿ç¨‹å¯è§ï¼Œå¯¼è‡´ä¸åŒçº¿ç¨‹è§‚å¯Ÿåˆ°ä¸åŒçš„ç»“æœã€‚è¿™ç§å†…å­˜æ¨¡å‹çš„ä¸€è‡´æ€§é—®é¢˜ä½¿å¾—ç¡®å®šå“ªä¸ªæ“ä½œâ€œå…ˆå‘ç”Ÿâ€å˜å¾—éå¸¸å›°éš¾ä¸”ä¸ç¡®å®šã€‚\næœªå®šä¹‰è¡Œä¸º (Undefined Behavior)ï¼šä» C++11 æ ‡å‡†å¼€å§‹ï¼Œæ•°æ®ç«äº‰è¢«æ˜ç¡®è§„å®šä¸ºæœªå®šä¹‰è¡Œä¸ºã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ çš„ç¨‹åºå‘ç”Ÿäº†æ•°æ®ç«äº‰ï¼Œç¼–è¯‘å™¨å¯ä»¥è‡ªç”±åœ°äº§ç”Ÿä»»ä½•è¡Œä¸ºï¼Œæ— è®ºæ˜¯å´©æºƒã€äº§ç”Ÿé”™è¯¯ç»“æœï¼Œè¿˜æ˜¯çœ‹ä¼¼æ­£å¸¸è¿è¡Œä½†ç»“æœä¸å¯é¢„æµ‹ã€‚è¿™ä½¿å¾—æ•°æ®ç«äº‰æˆä¸ºéå¸¸å±é™©ä¸”éš¾ä»¥è°ƒè¯•çš„å¹¶å‘é”™è¯¯ï¼Œå› ä¸ºå®ƒçš„è¡¨ç°å¯èƒ½æ˜¯ä¸ç¡®å®šã€ä¸ç¨³å®šçš„ã€‚\nå¤šçº¿ç¨‹ä¸å¤šå†…å­˜çš„å¤æ‚äº¤äº’ï¼šåœ¨å®é™…çš„å¹¶å‘ç¨‹åºä¸­ï¼Œé€šå¸¸ä¼šæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å¤šä¸ªå…±äº«å†…å­˜ä½ç½®ã€‚è¿™äº›çº¿ç¨‹å’Œå†…å­˜ä¹‹é—´å­˜åœ¨å¤æ‚çš„è¯»ï¼ˆRï¼‰å†™ï¼ˆWï¼‰äº¤äº’ã€‚ä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªå†…å­˜ä½ç½®çš„å†™å…¥å¯èƒ½å½±å“åˆ°å…¶ä»–å¤šä¸ªçº¿ç¨‹å¯¹è¯¥ä½ç½®çš„è¯»å–ï¼ŒåŒæ—¶ï¼Œå¤šä¸ªå†…å­˜ä½ç½®ä¹‹é—´ä¹Ÿå¯èƒ½å­˜åœ¨å¤æ‚çš„ä¾èµ–å…³ç³»å’Œç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚è¿™ç§é”™ç»¼å¤æ‚çš„äº¤äº’ç½‘ç»œè¿›ä¸€æ­¥åŠ å‰§äº†æ•°æ®ç«äº‰çš„ä¸å¯é¢„æµ‹æ€§ã€‚\nä¸ºäº†æ¶ˆç­æ•°æ®ç«äº‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯ç¨‹åºçš„ serializability ï¼Œå¯èƒ½ç«äº‰çš„å†…å­˜è®¿é—®è¦ä¹ˆäº’æ–¥ï¼Œè¦ä¹ˆåŒæ­¥\nå®é™…ç¼–ç¨‹ä¸­é‡åˆ°çš„æ•°æ®ç«äº‰ bug å¤§å¤šå±äºä¸Šé”™äº†é”å’Œå¿˜è®°ä¸Šé”ä¸¤ç§æƒ…å†µçš„å˜ç§\nCase 1: ä¸Šé”™äº†é”\n1 2 void T_1() { spin_lock(\u0026amp;A); sum++; spin_unlock(\u0026amp;A); } void T_2() { spin_lock(\u0026amp;B); sum++; spin_unlock(\u0026amp;B); } Case 2: å¿˜è®°ä¸Šé”\n1 2 void T_1() { spin_lock(\u0026amp;A); sum++; spin_unlock(\u0026amp;A); } void T_2() { sum++; } ä½†æ˜¯å®é™…ç³»ç»Ÿé¢ä¸´çš„æƒ…å†µæ¯”è¿™å¤æ‚çš„å¤šï¼Œå› ä¸º\nå†…å­˜å¯ä»¥æ˜¯åœ°å€ç©ºé—´çš„ä»»ä½•å†…å­˜ï¼Œæ¯”å¦‚å…¨å±€å˜é‡ã€å †å†…å­˜åˆ†é…çš„å˜é‡ã€ç¨‹åºçš„æ ˆâ€¦â€¦ è®¿é—®å¯ä»¥å‘ç”Ÿåœ¨ä»»ä½•ä»£ç ï¼Œæ¯”å¦‚è‡ªå·±çš„ä»£ç ã€æ¡†æ¶ä»£ç ã€ä¸€è¡Œæ²¡è¯»åˆ°çš„æ±‡ç¼–æŒ‡ä»¤ã€æŸæ¡ ret æŒ‡ä»¤ â€œä¸€è¡Œæ²¡è¯»åˆ°çš„æ±‡ç¼–æŒ‡ä»¤â€é€ æˆçš„è®¿é—®çš„æƒ…å†µæœ‰ç¼–è¯‘å™¨ä¼˜åŒ–é€ æˆçš„æŒ‡ä»¤é‡æ’ã€ç¡¬ä»¶å±‚é¢å¼±å†…å­˜æ¨¡å‹çš„å†…å­˜è®¿é—®é‡æ’ã€è¿˜æœ‰ä¸€äº›é«˜å±‚è¯­è¨€æ“ä½œçš„éšå¼å†…å­˜è®¿é—® å®é™…ç³»ç»Ÿä¸­è™½ç„¶éš¾ä»¥é¿å…ï¼Œä½†æ˜¯ä¼šå°½å¯èƒ½ä¿è¯åº•å±‚çš„ç»“æ„å¯¹ä¸Šå±‚å°½å¯èƒ½å°é—­æ¥é˜²æ­¢è¿™ç§é”™è¯¯ æ­»é” æ­»é” (Deadlock) æ˜¯æŒ‡ä¸€ä¸ªç¾¤ä½“ä¸­çš„æ¯ä¸ªæˆå‘˜éƒ½åœ¨ç­‰å¾…å…¶ä»–æˆå‘˜ï¼ˆåŒ…æ‹¬è‡ªèº«ï¼‰é‡‡å–è¡ŒåŠ¨çš„çŠ¶æ€\næ­»é”æœ‰ä¸¤ç§ï¼š\nAA-Deadlock: è‡ªå·±ç­‰å¾…è‡ªå·±\n1 2 3 4 5 6 7 lock(\u0026amp;lk); // lk-\u0026gt;locked == âœ…; proceed ... // Possibly in interrupt handler lock(\u0026amp;lk); // while (lk-\u0026gt;locked == âŒ) ; è¿™æ ·çš„é”™è¯¯è™½ç„¶çœ‹èµ·æ¥å¾ˆå‚»ï¼Œä½†æ˜¯åœ¨çœŸå®ç¨‹åºå¤æ‚çš„æ§åˆ¶æµä¸­æ˜¯å¯èƒ½å‡ºç°çš„\nABBA-Deadlock: ä¸¤ä¸ªï¼ˆå¤šä¸ªï¼‰é”äº’ç›¸ç­‰å¾…\næ¯”å¦‚ 16. å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ä¿¡å·é‡ ä¸­çš„å“²å­¦å®¶åƒé¥­é—®é¢˜\nHow? æƒ³è¦æ¶ˆé™¤æ­»é”ï¼Œå¯ä»¥ä»æ­»é”äº§ç”Ÿçš„å¿…è¦æ¡ä»¶å…¥æ‰‹ï¼Œé€šå¸¸ç§°ä¸ºéœå°”å¾·ï¼ˆHoltï¼‰æ¡ä»¶ï¼Œ å¯ä»¥å½¢è±¡åœ°æŠŠé”çœ‹æˆè¢‹å­é‡Œçš„çƒï¼š\näº’æ–¥ (Mutual-exclusion)ï¼š ä¸€ä¸ªå£è¢‹ä¸€ä¸ªçƒï¼Œå³èµ„æºæ˜¯äº’æ–¥çš„ï¼Œä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹å ç”¨ å¦‚æœèµ„æºå¯ä»¥å…±äº«ï¼ˆä¾‹å¦‚ï¼Œåªè¯»æ–‡ä»¶ï¼‰ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿæ­»é” è¯·æ±‚å¹¶ä¿æŒ (Wait-for)ï¼š å¾—åˆ°çƒçš„äººæƒ³è¦æ›´å¤šçš„çƒï¼Œå³ä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰è‡³å°‘ä¸€ä¸ªèµ„æºçš„åŒæ—¶ï¼Œåˆåœ¨ç­‰å¾…è·å–å…¶ä»–è¢«å ç”¨çš„èµ„æº å¦‚æœçº¿ç¨‹åœ¨è¯·æ±‚æ–°èµ„æºæ—¶ï¼Œå¿…é¡»é‡Šæ”¾æ‰€æœ‰å·²æŒæœ‰çš„èµ„æºï¼Œåˆ™å¯ä»¥é¿å…æ­»é” ä¸å¯æŠ¢å  (No-preemption)ï¼š ä¸èƒ½æŠ¢åˆ«äººçš„æŒæœ‰çš„çƒï¼Œå³èµ„æºä¸èƒ½è¢«å¼ºåˆ¶ä»æŒæœ‰è€…æ‰‹ä¸­æŠ¢èµ°ï¼Œåªèƒ½ç”±æŒæœ‰è€…è‡ªæ„¿é‡Šæ”¾ å¦‚æœç³»ç»Ÿå¯ä»¥æŠ¢å èµ„æºï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ä¸­æ–­å¼ºåˆ¶é‡Šæ”¾ï¼‰ï¼Œåˆ™å¯ä»¥æ‰“ç ´æ­¤æ¡ä»¶ å¾ªç¯ç­‰å¾… (Circular-chain)ï¼š å½¢æˆå¾ªç¯ç­‰å¾…çš„å…³ç³»ï¼Œå³å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹é“¾ $ T_1, T_2, \\ldots, T_n $ï¼Œå…¶ä¸­ $ T_1 $ æ­£åœ¨ç­‰å¾… $ T_2 $ å ç”¨çš„èµ„æºï¼Œ$ T_2 $ æ­£åœ¨ç­‰å¾… $ T_3 $ å ç”¨çš„èµ„æºï¼Œä¾æ­¤ç±»æ¨ï¼Œ$ T_n $ æ­£åœ¨ç­‰å¾… $ T_1 $ å ç”¨çš„èµ„æº è¿™å››ä¸ªæ¡ä»¶æ˜¯æ­»é”å‘ç”Ÿçš„å¿…è¦æ¡ä»¶ï¼Œè¿™æ„å‘³ç€åªè¦æ‰“ç ´ä»»ä½•ä¸€ä¸ªæ¡ä»¶ï¼Œå°±ä¸ä¼šå‘ç”Ÿæ­»é”äº†ï¼Œç†è®ºä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç ´åè¿™äº›æ¡ä»¶æ¥é¢„é˜²æˆ–é¿å…æ­»é”ã€‚\nç„¶è€Œï¼Œå°†è¿™å¥—ç†è®ºåº”ç”¨äºå®é™…å¤æ‚ç³»ç»Ÿæ—¶ï¼Œä¼šå‘ç°å®ƒæ˜¯ä¸€ä¸ªæ­£ç¡®çš„åºŸè¯ï¼Œä¸èƒ½ç§°ä¸ºä¸€ä¸ªåˆç†çš„ argument\nå¯¹äºç©å…·ç³»ç»Ÿ/æ¨¡å‹ï¼šå¯ä»¥ç›´æ¥è¯æ˜ç³»ç»Ÿæ˜¯ deadlock-free çš„ï¼Œå› ä¸ºå…¶çŠ¶æ€ç©ºé—´æœ‰é™ï¼Œå¯ä»¥é€šè¿‡ç©·ä¸¾æˆ–å½¢å¼åŒ–æ–¹æ³•è¿›è¡ŒéªŒè¯ å¯¹äºçœŸæ­£çš„å¤æ‚ç³»ç»Ÿï¼šå¾ˆéš¾åˆ¤æ–­å“ªä¸ªæ¡ä»¶æœ€å®¹æ˜“è¢«æ‰“ç ´ï¼Œæˆ–è€…è¯´ï¼Œåœ¨ä¿è¯ç³»ç»ŸåŠŸèƒ½æ€§å’Œæ€§èƒ½çš„å‰æä¸‹ï¼Œæ‰“ç ´æŸä¸ªæ¡ä»¶å¯èƒ½å¸¦æ¥å·¨å¤§çš„å¤æ‚æ€§æˆ–æ€§èƒ½å¼€é”€ å®é™…ç¼–ç¨‹ä¸­é€šå¸¸ä¼šé‡‡ç”¨å…¶ä»–ç­–ç•¥æ¥é¢„é˜²æ­»é”ï¼š\nä¸€ä¸ªå¸¸è§çš„æ–¹æ³•æ˜¯é”æ’åºï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š\nä»»æ„æ—¶åˆ»ç³»ç»Ÿä¸­çš„é”éƒ½æ˜¯æœ‰é™çš„ã€‚ ç»™æ‰€æœ‰é”ç¼–å·ï¼ˆæˆ–è€…å®šä¹‰ä¸€ä¸ªå…¨å±€çš„è·å–é¡ºåºï¼‰ çº¿ç¨‹åœ¨è·å–å¤šä¸ªé”æ—¶ï¼Œä¸¥æ ¼æŒ‰ç…§ä»å°æ•°åˆ°å¤§çš„é¡ºåºè·å–é” è¿™ç§ç­–ç•¥ä¹Ÿç›¸å¯¹å®¹æ˜“æ£€æŸ¥å’ŒéªŒè¯ã€‚ è¿™æ ·åœ¨ä»»æ„æ—¶åˆ»æ€»æœ‰ä¸€ä¸ªçº¿ç¨‹è·å¾—â€œç¼–å·æœ€å¤§â€çš„é”ï¼Œäºæ˜¯è¿™ä¸ªçº¿ç¨‹æ€»æ˜¯å¯ä»¥ç»§ç»­è¿è¡Œ\nç„¶è€Œè¿™ç§æ–¹æ³•åœ¨å®è·µä¸­ä¼šé‡åˆ°é—®é¢˜ï¼Œä»£ç çš„æ–‡æ¡£å¹¶ä¸æ€»æ˜¯å¯é ï¼Œå¹¶ä¸”å¯¹äºå¤æ‚ç³»ç»Ÿè¿™æ˜¯éš¾ä»¥æ‰©å±•çš„ï¼›è€Œæœ€å¥½çš„é”æ˜¯å°è£…çš„ï¼Œå¹¶ä¸ä¼šæš´éœ²å‡ºæ¥ï¼Œè¿™æ ·ä½¿ç”¨ä»£ç çš„äººç”šè‡³ä¸éœ€è¦çŸ¥é“æ­£åœ¨ä½¿ç”¨é”\nSome Methods ä¸ºäº†åº”å¯¹æ­»é”ï¼Œå°¤å…¶æ˜¯ ABBA-Deadlockï¼Œä¸€äº›å·¥å…·è¢«å¼€å‘å‡ºæ¥ï¼Œä¾‹å¦‚ Linux å†…æ ¸ä¸­çš„ LockDep\nä¸€ä¸ªç®€å•çš„æƒ³æ³•ï¼š\næ¯æ¬¡ acquire/release é”æ—¶ï¼Œéƒ½æ‰“å°ä¸€ä¸ªæ—¥å¿— å¦‚æœä»»ä½•çº¿ç¨‹å­˜åœ¨ $ A\\to B $ å’Œ $ B\\to A $ çš„ä¾èµ–å…³ç³»ï¼Œå°±æŠ¥å‘Šæ­»é” è¿™å¯èƒ½å¯¼è‡´ false positives ï¼Œæ¯”å¦‚å­˜åœ¨åŒæ­¥æœºåˆ¶ ($ A\\to B\\to \\mathrm{spawn}\\to B\\to A $) é€šè¿‡ä¼˜åŒ–è¿™ä¸ªæ–¹æ³•å¯ä»¥å¾—åˆ°ä¸€ä¸ªç›¸å¯¹é«˜æ•ˆçš„å®ç°ï¼šåŠ¨æ€ç»´æŠ¤â€œé”ä¾èµ–å›¾â€œå¹¶æ£€æµ‹ç¯è·¯\nåŸå­æ€§å’Œé¡ºåºè¿å å¹¶å‘ç¼–ç¨‹æ˜¯æœ¬è´¨å›°éš¾çš„ï¼Œæˆ‘ä»¬åªèƒ½ç”¨ sequential çš„æ–¹å¼æ¥ç†è§£å¹¶å‘ï¼šæŠŠç¨‹åºåˆ†æˆè‹¥å¹²çš„å—ï¼Œæ¯ä¸€å—çš„æ“ä½œéƒ½æ˜¯åŸå­çš„ï¼Œæ— æ³•è¢«æ‰“æ–­\nå¹¶å‘çš„æœºåˆ¶å¯ä»¥åˆ†æˆä¸¤ç±»ï¼š\näº’æ–¥é”å®ç°åŸå­æ€§ å¿˜è®°ä¸Šé”ä¼šå¯¼è‡´åŸå­æ€§è¿å (Atomicity Violation, AV) æ¡ä»¶å˜é‡/ä¿¡å·é‡å®ç°å…ˆåé¡ºåºåŒæ­¥ å¿˜è®°åŒæ­¥ä¼šå¯¼è‡´é¡ºåºè¿å (Order Violation, OV) å¹¶å‘çš„æœºåˆ¶å®Œå…¨æ˜¯â€œåæœè‡ªè´Ÿâ€çš„ï¼Œè¿™ä¹Ÿå¯¼è‡´äº† Threads cannot be implemented as a library ï¼Œå› ä¸ºï¼Ÿ\næœ‰ç ”ç©¶ç»Ÿè®¡äº†å¾ˆå¤šçœŸæ˜¯ç³»ç»Ÿå­˜åœ¨çš„å¹¶å‘ bugï¼Œå‘ç° 97% çš„éæ­»é”å¹¶å‘ bug éƒ½æ˜¯åŸå­æ€§æˆ–é¡ºåºé”™è¯¯\nAtomic Violation ä»£ç è¢«åˆ«çš„çº¿ç¨‹â€œå¼ºè¡Œæ’å…¥â€ï¼Œå³ä½¿åˆ†åˆ«ä¸Šé”æ¶ˆé™¤äº†æ•°æ®ç«äº‰ï¼Œè¿˜æ˜¯ä¼šå¯¼è‡´ AV\næ¯”å¦‚å›¾ä¸­çš„ä¾‹å­ï¼š\nå¦‚æœåœ¨ Thread 1 ç»“æŸåˆ¤æ–­è¿›å…¥ if ä¹‹å Thread 2 å†æ‰§è¡Œï¼Œå°±å¯¼è‡´äº†é”™è¯¯\nå¹¶ä¸”æ³¨æ„åˆ°æ“ä½œç³»ç»Ÿçš„çŠ¶æ€ä¹Ÿæ˜¯å…±äº«çŠ¶æ€ï¼Œåˆ©ç”¨ä¸€æ ·çš„åŸç†è¿˜å¯èƒ½äº§ç”Ÿæ›´éš¾å‘ç°çš„ bug\næ”»å‡»è€…åœ¨ check ä¹‹åé©¬ä¸Šæ›¿æ¢æ–‡ä»¶ä¸ºç¬¦å·é“¾æ¥ï¼Œå°±å¯ä»¥é€ æˆæƒé™é—®é¢˜ç­‰ä¸¥é‡å®‰å…¨æ¼æ´\nOrder Violation äº‹ä»¶æ²¡æœ‰æŒ‰ç…§é¢„å®šçš„é¡ºåºå‘ç”Ÿï¼Œå°±ä¼šå¯¼è‡´ OV ï¼Œæ¯”å¦‚ å¦‚æœ Thread 2 ä¸­çš„ S4 å‘ç”Ÿåœ¨äº†æ¡ä»¶å˜é‡çš„åˆå§‹åŒ–ä¹‹å‰ï¼Œé‚£ä¹ˆç›¸å½“äºå…¨å±€çš„å¹¿æ’­è¢«åæ‰äº†ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´ Thread 1 å¯èƒ½æ— æ³•è¢«å”¤é†’\nHowever æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŠ å¼ºç‰ˆçš„ LockDep æ¥è§£å†³è¿™äº›é—®é¢˜ï¼Œæ¯”å¦‚ç›´æ¥åˆ†æç¨‹åºçš„æ—¥å¿—ï¼Œæ£€æŸ¥æœ‰æ²¡æœ‰ä¸ç›¸äº¤çš„é”ï¼Œäº‹ä»¶çš„ happens-before å…³ç³»æ˜¯å¦æ­£ç¡®â€¦â€¦ç”šè‡³ä¹Ÿå¯ä»¥ç›´æ¥ç”¨å¯å‘å¼ï¼ˆæˆ–è€… LLM ï¼‰æ¥åˆ†ææ—¥å¿—æ˜¯å¦æ­£ç¡®\nç„¶è€Œå³ä½¿è¿™æ ·ä¹Ÿä¸èƒ½è§£å†³çœŸå®ä¸–ç•Œçš„æ‰€æœ‰å¹¶å‘é—®é¢˜ï¼Œæ¯”å¦‚è¿™ä¸ª GhostRace çš„ä¾‹å­\nå®ç°äº†æ­£ç¡®çš„äº’æ–¥ã€æ­£ç¡®çš„åŒæ­¥ $ \\text{use}\\to\\text{free} $ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 void T_A() { lock(\u0026amp;obj-\u0026gt;lock); free(obj-\u0026gt;something); obj-\u0026gt;something = NULL; unlock(\u0026amp;obj-\u0026gt;lock); } void T_B() { lock(\u0026amp;obj-\u0026gt;lock); if (obj-\u0026gt;something) { // changes cache on speculative execution } unlock(\u0026amp;obj-\u0026gt;lock); } å®é™…ä¸Šå¯¼è‡´é—®é¢˜çš„æ˜¯ç°ä»£ CPU çš„æ¨æµ‹æ‰§è¡Œçš„ç‰¹æ€§ï¼Œä¸ºäº†æé«˜æ•ˆç‡ä¼šæå‰é€šè¿‡åˆ†æ²»é¢„æµ‹å™¨é¢„åˆ¤æ‰§è¡Œçš„æ–¹å‘ï¼Œæå‰æ‰§è¡ŒæŒ‡ä»¤\nè¿™æ®µä»£ç ä¸­çº¿ç¨‹ $ T_{B} $ çš„ CPU ä¼šåœ¨æ­£å¼è·å¾—é”å¹¶åˆ¤æ–­ NULL ä¹‹å‰å°±æå‰æ¨æµ‹æ€§æ‰§è¡Œ if å—å†…éƒ¨çš„ä»£ç ï¼Œå¦‚æœæ­¤æ—¶ $ T_{A} $ æ°å¥½é‡Šæ”¾äº† obj-something æŒ‡å‘çš„å†…å­˜ï¼Œé‚£ä¹ˆ $ T_{B} $ ä¸­å°±ä¼šè®¿é—®åˆ°ä¸€å—å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜ï¼Œä»è€Œé€šè¿‡ç¼“å­˜ç­‰æ–¹å¼æ³„éœ²ä¿¡æ¯ï¼ˆè™½ç„¶é”™è¯¯æ‰§è¡Œçš„è¯­å¥å·²ç»å›æ»šäº†ï¼Œä½†æ˜¯è¢«åŠ è½½åˆ°ç¼“å­˜ä¸­çš„æ•°æ®ç­‰ä¸ä¼šå›æ»šï¼‰ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å°±æœ‰å¯èƒ½è®¿é—®åˆ°ç¨‹åºæœ¬æ¥æ²¡æœ‰æƒé™è®¿é—®çš„å†…å­˜ï¼Œä»è€Œäº§ç”Ÿå®‰å…¨æ¼æ´\nè¿™ç§å¹¶å‘ bug çš„æ ¹æºåœ¨äºè½¯ä»¶å±‚é¢çš„åŒæ­¥æ— æ³•çº¦æŸç¡¬ä»¶å±‚é¢çš„è¡Œä¸º\n","permalink":"https://diefish1024.github.io/posts/nju-os-2025/17-%E5%B9%B6%E5%8F%91-bugs/","summary":"\u003ch2 id=\"æ•°æ®ç«äº‰\"\u003eæ•°æ®ç«äº‰\u003c/h2\u003e\n\u003cp\u003eå¤§å¤šå¹¶å‘ bug æœ€åéƒ½ä¼šä½“ç°ä¸º\u003cstrong\u003eæ•°æ®ç«äº‰ (Data Race)\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¯¹äºé¡ºåºç¨‹åºè€Œè¨€ï¼Œå‡½æ•° \u003ccode\u003ef()\u003c/code\u003e è¿”å›ä¹‹åå°±å·²ç»å®Œæˆäº†æ‰€æœ‰çš„çŠ¶æ€ä¿®æ”¹ï¼Œå¯¹äºå…¶ä»–éƒ¨åˆ†è€Œè¨€è¿™ä¸ªä¿®æ”¹æ˜¯ç«‹å³ç”Ÿæ•ˆçš„ï¼›å¦‚æœå¯¹äºå¹¶å‘ç¨‹åºè€Œè¨€æ¨¡å¼çš„åˆ‡æ¢ä¹Ÿåœ¨ç¬é—´å®Œæˆï¼Œé‚£å°±ä¸ä¼šå¯¼è‡´å¹¶å‘çš„é—®é¢˜\u003c/p\u003e\n\u003cp\u003eç„¶è€Œå®é™…ä¸Šæ¨¡å¼çš„åˆ‡æ¢éœ€è¦æ—¶é—´ï¼Œæ‰§è¡Œçš„æ“ä½œåœ¨æœªæ¥ä¸€æ®µæ—¶é—´ä¹‹åæ‰ä¼šå°±ç»ªï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å®é™…ç¼–ç¨‹æ—¶æ€»æ˜¯å®¹æ˜“æœ‰â€œç«‹å³ç”Ÿæ•ˆâ€çš„è‚Œè‚‰è®°å¿†ï¼Œè¿™å°±å¯¼è‡´äº†å¹¶å‘é—®é¢˜çš„å¯èƒ½æ€§\u003c/p\u003e\n\u003cp\u003eä¸è¿‡å¯¹äº\u003cstrong\u003eå‡½æ•°å¼ç¼–ç¨‹\u003c/strong\u003eè€Œè¨€ï¼Œæ“ä½œä¸å­˜åœ¨å¯¹å¤–çŠ¶æ€çš„ä¿®æ”¹ï¼Œæ²¡æœ‰å‰¯ä½œç”¨ï¼ˆåªä¼šæ“ä½œå±€éƒ¨å˜é‡ï¼‰ï¼Œè¿™å°±ä¸ä¼šå¯¼è‡´å¹¶å‘é—®é¢˜\u003c/p\u003e\n\u003cp\u003eData Race å‘ç”Ÿçš„å®è´¨æ˜¯\u003cstrong\u003eä¸åŒçš„çº¿ç¨‹\u003c/strong\u003eåŒæ—¶è®¿é—®\u003cstrong\u003eåŒä¸€å†…å­˜\u003c/strong\u003eï¼Œå¹¶ä¸”\u003cstrong\u003eè‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™\u003c/strong\u003eï¼Œå½¢è±¡çš„ç†è§£å°±æ˜¯ä¸åŒçš„å†…å­˜è®¿é—®åœ¨â€œèµ›è·‘â€ï¼Œè·‘èµ¢çš„æ“ä½œå…ˆæ‰§è¡Œ\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eNot that easy\u003c/strong\u003e: è™½ç„¶æˆ‘ä»¬å°†æ•°æ®ç«äº‰å½¢è±¡åœ°æ¯”å–»ä¸ºâ€œèµ›è·‘â€ï¼Œä½†å®é™…ä¸Šï¼Œå“ªä¸€ä¸ªæ“ä½œèƒ½â€œè·‘èµ¢â€å¹¶æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•å’Œç¡®å®šï¼Œå…¶å¤æ‚æ€§ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå¼±å†…å­˜æ¨¡å‹ (Weak memory model)\u003c/strong\u003eï¼šåœ¨ç°ä»£å¤„ç†å™¨æ¶æ„ä¸­ï¼Œä¸ºäº†æå‡æ€§èƒ½ï¼Œå¤„ç†å™¨å¯èƒ½ä¼šå¯¹å†…å­˜æ“ä½œè¿›è¡Œé‡æ’åºã€‚è¿™æ„å‘³ç€ï¼Œä¸åŒçš„çº¿ç¨‹æˆ–â€œè§‚å¯Ÿè€…â€åœ¨ä¸åŒæ—¶é—´ç‚¹çœ‹åˆ°å…±äº«å†…å­˜çš„çŠ¶æ€å¯èƒ½æ˜¯ä¸ä¸€è‡´çš„ã€‚ä¸€ä¸ªçº¿ç¨‹å¯¹å†…å­˜çš„å†™å…¥æ“ä½œï¼Œå¯èƒ½ä¸ä¼šç«‹å³å¯¹æ‰€æœ‰å…¶ä»–çº¿ç¨‹å¯è§ï¼Œå¯¼è‡´ä¸åŒçº¿ç¨‹è§‚å¯Ÿåˆ°ä¸åŒçš„ç»“æœã€‚è¿™ç§\u003cstrong\u003eå†…å­˜æ¨¡å‹çš„ä¸€è‡´æ€§é—®é¢˜\u003c/strong\u003eä½¿å¾—ç¡®å®šå“ªä¸ªæ“ä½œâ€œå…ˆå‘ç”Ÿâ€å˜å¾—éå¸¸å›°éš¾ä¸”ä¸ç¡®å®šã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eæœªå®šä¹‰è¡Œä¸º (Undefined Behavior)\u003c/strong\u003eï¼šä» C++11 æ ‡å‡†å¼€å§‹ï¼Œæ•°æ®ç«äº‰è¢«æ˜ç¡®è§„å®šä¸º\u003cstrong\u003eæœªå®šä¹‰è¡Œä¸º\u003c/strong\u003eã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ çš„ç¨‹åºå‘ç”Ÿäº†æ•°æ®ç«äº‰ï¼Œç¼–è¯‘å™¨å¯ä»¥è‡ªç”±åœ°äº§ç”Ÿä»»ä½•è¡Œä¸ºï¼Œæ— è®ºæ˜¯å´©æºƒã€äº§ç”Ÿé”™è¯¯ç»“æœï¼Œè¿˜æ˜¯çœ‹ä¼¼æ­£å¸¸è¿è¡Œä½†ç»“æœä¸å¯é¢„æµ‹ã€‚è¿™ä½¿å¾—æ•°æ®ç«äº‰æˆä¸ºéå¸¸å±é™©ä¸”éš¾ä»¥è°ƒè¯•çš„å¹¶å‘é”™è¯¯ï¼Œå› ä¸ºå®ƒçš„è¡¨ç°å¯èƒ½æ˜¯ä¸ç¡®å®šã€ä¸ç¨³å®šçš„ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå¤šçº¿ç¨‹ä¸å¤šå†…å­˜çš„å¤æ‚äº¤äº’\u003c/strong\u003eï¼šåœ¨å®é™…çš„å¹¶å‘ç¨‹åºä¸­ï¼Œé€šå¸¸ä¼šæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å¤šä¸ªå…±äº«å†…å­˜ä½ç½®ã€‚è¿™äº›çº¿ç¨‹å’Œå†…å­˜ä¹‹é—´å­˜åœ¨å¤æ‚çš„è¯»ï¼ˆRï¼‰å†™ï¼ˆWï¼‰äº¤äº’ã€‚ä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªå†…å­˜ä½ç½®çš„å†™å…¥å¯èƒ½å½±å“åˆ°å…¶ä»–å¤šä¸ªçº¿ç¨‹å¯¹è¯¥ä½ç½®çš„è¯»å–ï¼ŒåŒæ—¶ï¼Œå¤šä¸ªå†…å­˜ä½ç½®ä¹‹é—´ä¹Ÿå¯èƒ½å­˜åœ¨å¤æ‚çš„ä¾èµ–å…³ç³»å’Œç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚è¿™ç§é”™ç»¼å¤æ‚çš„äº¤äº’ç½‘ç»œè¿›ä¸€æ­¥åŠ å‰§äº†æ•°æ®ç«äº‰çš„ä¸å¯é¢„æµ‹æ€§ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä¸ºäº†æ¶ˆç­æ•°æ®ç«äº‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯ç¨‹åºçš„ serializability ï¼Œ\u003cstrong\u003eå¯èƒ½ç«äº‰çš„å†…å­˜è®¿é—®è¦ä¹ˆäº’æ–¥ï¼Œè¦ä¹ˆåŒæ­¥\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå®é™…ç¼–ç¨‹ä¸­é‡åˆ°çš„æ•°æ®ç«äº‰ bug å¤§å¤šå±äº\u003cstrong\u003eä¸Šé”™äº†é”\u003c/strong\u003eå’Œ\u003cstrong\u003eå¿˜è®°ä¸Šé”\u003c/strong\u003eä¸¤ç§æƒ…å†µçš„å˜ç§\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eCase 1: ä¸Šé”™äº†é”\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eT_1\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nf\"\u003espin_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"n\"\u003esum\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nf\"\u003espin_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eT_2\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nf\"\u003espin_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"n\"\u003esum\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nf\"\u003espin_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eCase 2: å¿˜è®°ä¸Šé”\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eT_1\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nf\"\u003espin_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"n\"\u003esum\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nf\"\u003espin_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eT_2\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003esum\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eä½†æ˜¯å®é™…ç³»ç»Ÿé¢ä¸´çš„æƒ…å†µæ¯”è¿™å¤æ‚çš„å¤šï¼Œå› ä¸º\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå†…å­˜å¯ä»¥æ˜¯åœ°å€ç©ºé—´çš„ä»»ä½•å†…å­˜ï¼Œæ¯”å¦‚å…¨å±€å˜é‡ã€å †å†…å­˜åˆ†é…çš„å˜é‡ã€ç¨‹åºçš„æ ˆâ€¦â€¦\u003c/li\u003e\n\u003cli\u003eè®¿é—®å¯ä»¥å‘ç”Ÿåœ¨ä»»ä½•ä»£ç ï¼Œæ¯”å¦‚è‡ªå·±çš„ä»£ç ã€æ¡†æ¶ä»£ç ã€ä¸€è¡Œæ²¡è¯»åˆ°çš„æ±‡ç¼–æŒ‡ä»¤ã€æŸæ¡ ret æŒ‡ä»¤\n\u003cul\u003e\n\u003cli\u003eâ€œä¸€è¡Œæ²¡è¯»åˆ°çš„æ±‡ç¼–æŒ‡ä»¤â€é€ æˆçš„è®¿é—®çš„æƒ…å†µæœ‰ç¼–è¯‘å™¨ä¼˜åŒ–é€ æˆçš„æŒ‡ä»¤é‡æ’ã€ç¡¬ä»¶å±‚é¢å¼±å†…å­˜æ¨¡å‹çš„å†…å­˜è®¿é—®é‡æ’ã€è¿˜æœ‰ä¸€äº›é«˜å±‚è¯­è¨€æ“ä½œçš„éšå¼å†…å­˜è®¿é—®\u003c/li\u003e\n\u003cli\u003eå®é™…ç³»ç»Ÿä¸­è™½ç„¶éš¾ä»¥é¿å…ï¼Œä½†æ˜¯ä¼šå°½å¯èƒ½ä¿è¯åº•å±‚çš„ç»“æ„å¯¹ä¸Šå±‚å°½å¯èƒ½å°é—­æ¥é˜²æ­¢è¿™ç§é”™è¯¯\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"æ­»é”\"\u003eæ­»é”\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eæ­»é” (Deadlock)\u003c/strong\u003e æ˜¯æŒ‡ä¸€ä¸ªç¾¤ä½“ä¸­çš„æ¯ä¸ªæˆå‘˜éƒ½åœ¨ç­‰å¾…å…¶ä»–æˆå‘˜ï¼ˆåŒ…æ‹¬è‡ªèº«ï¼‰é‡‡å–è¡ŒåŠ¨çš„çŠ¶æ€\u003c/p\u003e\n\u003cp\u003eæ­»é”æœ‰ä¸¤ç§ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eAA-Deadlock\u003c/strong\u003e: è‡ªå·±ç­‰å¾…è‡ªå·±\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nf\"\u003elock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// lk-\u0026gt;locked == âœ…; proceed\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// Possibly in interrupt handler\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003elock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// while (lk-\u0026gt;locked == âŒ) ;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eè¿™æ ·çš„é”™è¯¯è™½ç„¶çœ‹èµ·æ¥å¾ˆå‚»ï¼Œä½†æ˜¯åœ¨çœŸå®ç¨‹åºå¤æ‚çš„æ§åˆ¶æµä¸­æ˜¯å¯èƒ½å‡ºç°çš„\u003c/p\u003e","title":"17. å¹¶å‘ Bugs"},{"content":"å¹¶å‘ç¼–ç¨‹çš„æ ¸å¿ƒæŠ½è±¡æ˜¯å®ç°ä¸€ä¸ªè®¡ç®—å›¾ï¼Œè®¡ç®—å‘ç”Ÿåœ¨èŠ‚ç‚¹ä¸Šï¼Œè¾¹è¡¨ç¤ºèŠ‚ç‚¹ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼ŒåŒæ—¶è®¡ç®—å›¾åœ¨è¿è¡Œæ—¶å¯èƒ½æ˜¯åŠ¨æ€å˜åŒ–çš„\nä½¿ç”¨æ¡ä»¶å˜é‡ã€é”ã€ä¿¡å·é‡ç­‰ api å»å®ç°è®¡ç®—å›¾å¹¶ä¸æ˜¯ä¸€ä¸ªä¼˜é›…çš„å®ç°æ–¹å¼ï¼Œå› ä¸ºè¿™æ ·ä¼šåœ¨ä»£ç ä¸­å¼•å…¥ä¼—å¤šå¹²æ‰°ä»£ç ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´ä¸€äº›é—®é¢˜\nä¸ºæ­¤å¯ä»¥å¢åŠ ä¸€äº›åŠŸèƒ½å—é™çš„è¯­æ³•ï¼Œå¯ä»¥åœ¨åŒæ ·æè¿°è®¡ç®—å›¾çš„åŠŸèƒ½ä¸‹å‡å°‘äº†è®¸å¤šæ½œåœ¨çš„é—®é¢˜\né«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶è¡Œç¼–ç¨‹ åœ¨é«˜æ€§èƒ½è®¡ç®—ä¸­ï¼Œè®¡ç®—å›¾é€šå¸¸æ˜“äºé™æ€åˆ‡åˆ†ï¼Œå°¤å…¶é€‚ç”¨äºç‰©ç†æ¨¡æ‹Ÿçš„ç½‘æ ¼åˆ’åˆ†ï¼Œä¸ºæ­¤ HPC å‘å±•å‡ºå¤šç§é«˜æ•ˆçš„å¹¶è¡Œç¼–ç¨‹æ¨¡å‹ï¼Œå…·ä½“å­¦ä¹ å¯ä»¥å‚è€ƒ SJTU HPC å­¦ä¹ æ‰‹å†Œ\nMPI: åˆ†å¸ƒå¼å†…å­˜å¹¶è¡Œ æ¯ä¸ª MPI è¿›ç¨‹æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œè¿›ç¨‹é—´é€šè¿‡æ˜¾å¼æ¶ˆæ¯ä¼ é€’ï¼ˆå‘é€/æ¥æ”¶ï¼‰äº¤æ¢æ•°æ®\nOpenMP: å…±äº«å†…å­˜å¹¶è¡Œ å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€åœ°å€ç©ºé—´ä¸­å¹¶è¡Œæ‰§è¡Œï¼Œæ‰€æœ‰çº¿ç¨‹å¯ä»¥ç›´æ¥è®¿é—®ç›¸åŒçš„æ•°æ®ï¼Œä½¿ç”¨Â #pragma ompÂ æŒ‡ä»¤å®ç°å¹¶è¡ŒåŒ–\nå¯¹éè®¡ç®—æœºä¸“ä¸šæ¥è¯´éå¸¸å‹å¥½ï¼Œåªéœ€è¦åœ¨æ­£å¸¸çš„ä»£ç ä¸Šé¢åŠ ä¸Šç¼–è¯‘æŒ‡ä»¤å³å¯ï¼Œèƒ½è½»æ¾å®ç°é«˜æ•ˆçš„å¹¶è¡Œä¼˜åŒ–\nCUDA: GPU å¼‚æ„å¹¶è¡Œ CPU è°ƒåº¦ï¼ŒGPU æ‰§è¡Œå¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—\næ¦‚å¿µï¼š\næ ¸å‡½æ•° (Kernel) ï¼šåœ¨ GPU ä¸Šå¹¶è¡Œæ‰§è¡Œçš„å‡½æ•° çº¿ç¨‹å±‚æ¬¡ï¼šçº¿ç¨‹ (threadIdx) ç»„æˆçº¿ç¨‹å— (blockIdx)ï¼Œçº¿ç¨‹å—ç»„æˆç½‘æ ¼ (gridDim) å†…å­˜å±‚æ¬¡ï¼šå¯„å­˜å™¨ã€å…±äº«å†…å­˜ï¼ˆå—å†…é«˜é€Ÿï¼‰ã€å…¨å±€å†…å­˜ï¼ˆæ‰€æœ‰çº¿ç¨‹å¯è®¿é—®ï¼‰ æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹ ä» Web 1.0 åˆ° Web 2.0 åœ¨ Web æ—¶ä»£ç”¨çš„æœ€å¹¿æ³›çš„æ˜¯ Javascript\nAsynchronous JavaScript and XML (Ajax; ~1999) å…è®¸ç½‘é¡µå®ç°â€œåå°åˆ·æ–°â€ jQuery $ (2006): A DOM Query Language (ç¼–ç¨‹æŠ½è±¡) Web 2.0 æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹ çº¿ç¨‹å¼€é”€å¤§ï¼Œå¹¶ä¸”å¤§å¤šæ•° Web å¼€å‘è€…éš¾ä»¥è¿›è¡Œå¹¶å‘ç¼–ç¨‹\nä»è€Œæœ‰äº†event-based concurrency (åŠ¨æ€è®¡ç®—å›¾) çš„æœºåˆ¶ï¼šç¦æ­¢ä»»ä½•è®¡ç®—èŠ‚ç‚¹å¹¶è¡Œï¼ˆå’Œé«˜æ€§èƒ½è®¡ç®—çš„é€‰æ‹©ä¸åŒï¼‰\nå…è®¸ç½‘ç»œè¯·æ±‚ã€sleep åœ¨åå°è¿›è¡Œï¼ˆè¿™æ‰æ˜¯ä¸»è¦å¼€é”€ï¼‰ï¼Œæ‰§è¡Œå®Œä¹‹åäº§ç”Ÿæ–°çš„è®¡ç®—èŠ‚ç‚¹ äº‹ä»¶å¯ä»¥åœ¨æµè§ˆå™¨é‡Œçœ‹åˆ° ç›´æ¥ç”¨è¿™æ ·çš„æ–¹å¼æè¿°è®¡ç®—å›¾ä¼šäº§ç”Ÿå¤§é‡å±å±±ä»£ç  (Callback hell) ï¼Œç°ä»£çš„é€‰æ‹©æ˜¯åŠ¨æ€æè¿°è®¡ç®—å›¾\næ•°æ®ä¸­å¿ƒçš„å¹¶å‘ç¼–ç¨‹ æ•°æ®ä¸­å¿ƒä»¥æµ·é‡åˆ†å¸ƒå¼æ•°æ®ä¸ºä¸­å¿ƒï¼Œéœ€è¦å¤„ç†çš„éœ€æ±‚æœ‰ï¼š\nå®æ—¶çš„â€œå°æ•°æ®â€å¤„ç†ï¼šå†…å®¹åˆ†å‘ã€å¼¹å¹•â€¦â€¦ ç¦»çº¿çš„â€œå¤§æ•°æ®â€å¤„ç†ï¼šå†…å®¹ç´¢å¼•ã€æ•°æ®æŒ–æ˜â€¦â€¦ ä¸º AI æä¾›æ”¯æŒ æ•°æ®ä¸­å¿ƒé‡Œçš„å¹¶å‘ç¼–ç¨‹éœ€è¦æ»¡è¶³é«˜ååé‡å’Œä½å»¶è¿Ÿçš„ç‰¹ç‚¹ï¼Œéš¾ç‚¹åœ¨äºï¼š\nå¤„ç†äº‹ä»¶å¯èƒ½éœ€è¦è¯»å†™æŒä¹…å­˜å‚¨æˆ–è¯·æ±‚ç½‘ç»œä¸Šçš„æœåŠ¡ï¼Œä»è€Œå¯¼è‡´å»¶è¿Ÿä¸ç¡®å®š çº¿ç¨‹ç»´æŠ¤å’Œä¸Šä¸‹æ–‡åˆ‡æ¢éƒ½ä¼šå¸¦æ¥å¼€é”€ åœ¨æ•°æ®ä¸­å¿ƒè¿›è¡Œå¹¶å‘ç¼–ç¨‹æ—¶ï¼Œä¼ ç»Ÿçš„é€šè¿‡æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹ã€é”ç­‰ä½çº§å¹¶å‘åŸè¯­çš„æ–¹å¼å˜å¾—è¶Šæ¥è¶Šå¤æ‚ä¸”éš¾ä»¥æ‰©å±•ï¼Œå› æ­¤ä»Šå¤©çš„è§£å†³æ–¹æ¡ˆæ˜¯æ— æœåŠ¡å™¨è®¡ç®— (Serverless Computing) ï¼Œç‰¹åˆ«æ˜¯å‡½æ•°å³æœåŠ¡ (Function as a Service, FaaS) ï¼Œå…¶ä¼˜åŠ¿åœ¨äº\nå¼€å‘äººå‘˜ä¸å†éœ€è¦ç›´æ¥å¤„ç†åº•å±‚çš„å¹¶å‘é—®é¢˜ FaaS å‡½æ•°é€šå¸¸æ˜¯çŸ­æš‚çš„ã€æ— çŠ¶æ€çš„ï¼Œå¹¶ä¸”æ¯ä¸ªè¯·æ±‚é€šå¸¸è§¦å‘ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°å®ä¾‹ï¼Œä¸åŒçš„å‡½æ•°å®ä¾‹ä¹‹é—´é€šå¸¸ä¸å…±äº«å†…å­˜ï¼Œè¿™ä»æ ¹æœ¬ä¸Šè§„é¿äº†ä¼ ç»Ÿå¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ç”±äºå…±äº«å†…å­˜é—®é¢˜ è¿™æ ·çš„èŒƒå¼ä½¿å¾—ç°ä»£å­˜å‚¨ç³»ç»Ÿå®ç°é«˜å¯é ã€ä½å»¶è¿Ÿçš„å¤šå‰¯æœ¬åˆ†å¸ƒå¼å­˜å‚¨å’Œè®¡ç®—å˜å¾—éå¸¸ Challenge ï¼Œæ•°æ®ä¸€è‡´æ€§ã€æœåŠ¡æ—¶åˆ»å¯ç”¨å’Œå®¹å¿æœºå™¨ç¦»çº¿ä¸‰ä¸ªç‰¹æ€§ä¸å¯ä»¥å…¼å¾— åç¨‹ åç¨‹æ˜¯ä¸€ç§ç¨‹åºç»„ä»¶ï¼Œä¸çº¿ç¨‹åœ¨æ¦‚å¿µä¸Šæœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„ï¼Œæ¯”å¦‚éƒ½åœ¨è¿›ç¨‹å†…éƒ¨æ‹¥æœ‰ç‹¬ç«‹çš„æ ˆå¸§ï¼Œå¹¶èƒ½åœ¨è¿è¡Œæ—¶ç»´æŠ¤è‡ªå·±çš„çŠ¶æ€ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå…±äº«å†…å­˜çš„çŠ¶æ€æœº\nç„¶è€Œï¼Œåç¨‹ä¸çº¿ç¨‹æœ€å¤§çš„ä¸åŒåœ¨äºå®ƒä»¬çš„è°ƒåº¦æ–¹å¼å’Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼š\nåä½œå¼è°ƒåº¦ï¼šåç¨‹çš„æ‰§è¡Œæ˜¯åä½œå¼çš„ï¼Œä¼šâ€œä¸€ç›´æ‰§è¡Œâ€ ï¼Œç›´åˆ°é‡åˆ° yield() ç­‰æŒ‡ä»¤æ—¶ï¼Œæ‰ä¼šä¸»åŠ¨æ”¾å¼ƒå¤„ç†å™¨æ§åˆ¶æƒï¼Œå°†æ‰§è¡Œæƒäº¤è¿˜ç»™è°ƒç”¨è€…æˆ–è°ƒåº¦å™¨ï¼Œè¿™ä¸çº¿ç¨‹çš„æŠ¢å å¼è°ƒåº¦ï¼ˆç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶ä¸­æ–­å’Œåˆ‡æ¢ï¼‰ä¸åŒ\næ“ä½œç³»ç»Ÿâ€œä¸æ„ŸçŸ¥â€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šå½“åç¨‹é€šè¿‡ yield() è¿›è¡Œåˆ‡æ¢æ—¶ï¼Œè¿™ä»…ä»…æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨çº§åˆ«çš„æ“ä½œï¼Œä¸éœ€è¦åƒçº¿ç¨‹åˆ‡æ¢é‚£æ ·ï¼Œä¿å­˜å’Œæ¢å¤å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå› æ­¤è¿™ç§åˆ‡æ¢å¼€é”€éå¸¸å°ï¼Œå¹¶ä¸”æ˜¯æ“ä½œç³»ç»Ÿå®Œå…¨ä¸æ„ŸçŸ¥\né˜»å¡ I/O çš„å±€é™æ€§ï¼šç”±äºåç¨‹æ˜¯åä½œå¼æ‰§è¡Œçš„ï¼Œå¦‚æœåœ¨ä¸€ä¸ªåç¨‹å†…éƒ¨æ‰§è¡Œäº†é˜»å¡æ€§æ“ä½œï¼ˆå¦‚è€—æ—¶çš„ I/O æ“ä½œæˆ– sleep()ï¼‰ï¼Œé‚£ä¹ˆå½“å‰æ‰€åœ¨çš„æ•´ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹éƒ½ä¼šè¢«å¡ä½ï¼Œè¿™æ„å‘³ç€æ‰€æœ‰åœ¨è¯¥çº¿ç¨‹ä¸Šè¿è¡Œçš„åç¨‹éƒ½å°†åœæ­¢æ‰§è¡Œï¼Œä»è€Œå¤±å»äº†å¹¶è¡Œ\nç¤ºä¾‹\n1 2 3 4 5 6 7 8 9 10 11 import random def T_worker(name): i = 0 while (i := i + 1): print(f\u0026#39;[{name}] i = {i}\u0026#39;) yield() threads = [T_worker(i) for i in range(1000000)] while True: random.choice(threads).send(None) è¿™ä¸ªä¾‹å­å¾ˆå¥½åœ°é˜é‡Šäº†åç¨‹çš„ç‰¹ç‚¹ï¼š\nåœ¨åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸­æ‰§è¡Œï¼šè™½ç„¶åˆ›å»ºäº†éå¸¸å¤šä¸ª T_worker å¯¹è±¡ï¼Œä½†å®ƒä»¬éƒ½è¿è¡Œåœ¨ç¨‹åºçš„åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸­ï¼Œå¼€é”€è¿œå°äºåˆ›å»ºç›¸åŒæ•°é‡ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ ç”±ç¨‹åºæ§åˆ¶è°ƒåº¦ï¼šwhile True: random.choice(threads).send(None) è¿™æ®µä»£ç æ˜¯è‡ªå®šä¹‰çš„ç®€å•è°ƒåº¦å™¨ï¼Œå®ƒéšæœºé€‰æ‹©ä¸€ä¸ªåç¨‹å¹¶æ¿€æ´»å®ƒï¼Œä½¿å…¶æ‰§è¡Œç›´åˆ°é‡åˆ° yield() æš‚åœï¼Œç„¶åå†é€‰æ‹©ä¸‹ä¸€ä¸ªåç¨‹ èµ„æºå ç”¨æä½ï¼šç”±äºä¸æ¶‰åŠæ“ä½œç³»ç»Ÿå±‚é¢çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œé™¤äº†åç¨‹æœ¬èº«æ‰€éœ€è¦çš„ä¸€å°å—å†…å­˜ç”¨äºä¿å­˜å…¶æ ˆå¸§å’ŒçŠ¶æ€å¤–ï¼Œåç¨‹ä¸å ç”¨é¢å¤–çš„æ“ä½œç³»ç»Ÿèµ„æºï¼Œå› æ­¤å¯ä»¥åˆ›å»ºæµ·é‡çš„åç¨‹å®ä¾‹ï¼Œéå¸¸é€‚åˆé«˜å¹¶å‘çš„ I/O å¯†é›†å‹ä»»åŠ¡ã€‚ ","permalink":"https://diefish1024.github.io/posts/nju-os-2025/18-%E7%9C%9F%E5%AE%9E%E4%B8%96%E7%95%8C%E7%9A%84%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-1/","summary":"\u003cp\u003eå¹¶å‘ç¼–ç¨‹çš„æ ¸å¿ƒæŠ½è±¡æ˜¯å®ç°ä¸€ä¸ªè®¡ç®—å›¾ï¼Œè®¡ç®—å‘ç”Ÿåœ¨èŠ‚ç‚¹ä¸Šï¼Œè¾¹è¡¨ç¤ºèŠ‚ç‚¹ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼ŒåŒæ—¶è®¡ç®—å›¾åœ¨è¿è¡Œæ—¶å¯èƒ½æ˜¯åŠ¨æ€å˜åŒ–çš„\u003c/p\u003e\n\u003cp\u003eä½¿ç”¨æ¡ä»¶å˜é‡ã€é”ã€ä¿¡å·é‡ç­‰ api å»å®ç°è®¡ç®—å›¾å¹¶ä¸æ˜¯ä¸€ä¸ªä¼˜é›…çš„å®ç°æ–¹å¼ï¼Œå› ä¸ºè¿™æ ·ä¼šåœ¨ä»£ç ä¸­å¼•å…¥ä¼—å¤š\u003cstrong\u003eå¹²æ‰°ä»£ç \u003c/strong\u003eï¼Œä¹Ÿå¯èƒ½å¯¼è‡´ä¸€äº›é—®é¢˜\u003c/p\u003e\n\u003cp\u003eä¸ºæ­¤å¯ä»¥å¢åŠ ä¸€äº›åŠŸèƒ½å—é™çš„\u003cstrong\u003eè¯­æ³•\u003c/strong\u003eï¼Œå¯ä»¥åœ¨åŒæ ·æè¿°è®¡ç®—å›¾çš„åŠŸèƒ½ä¸‹å‡å°‘äº†è®¸å¤šæ½œåœ¨çš„é—®é¢˜\u003c/p\u003e\n\u003ch2 id=\"é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶è¡Œç¼–ç¨‹\"\u003eé«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶è¡Œç¼–ç¨‹\u003c/h2\u003e\n\u003cp\u003eåœ¨é«˜æ€§èƒ½è®¡ç®—ä¸­ï¼Œè®¡ç®—å›¾é€šå¸¸æ˜“äº\u003cstrong\u003eé™æ€åˆ‡åˆ†\u003c/strong\u003eï¼Œå°¤å…¶é€‚ç”¨äºç‰©ç†æ¨¡æ‹Ÿçš„ç½‘æ ¼åˆ’åˆ†ï¼Œä¸ºæ­¤ HPC å‘å±•å‡ºå¤šç§é«˜æ•ˆçš„å¹¶è¡Œç¼–ç¨‹æ¨¡å‹ï¼Œå…·ä½“å­¦ä¹ å¯ä»¥å‚è€ƒ \u003ca href=\"https://xflops.sjtu.edu.cn/hpc-start-guide/parallel-computing/basic/\"\u003eSJTU HPC å­¦ä¹ æ‰‹å†Œ\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"mpi-åˆ†å¸ƒå¼å†…å­˜å¹¶è¡Œ\"\u003eMPI: åˆ†å¸ƒå¼å†…å­˜å¹¶è¡Œ\u003c/h4\u003e\n\u003cp\u003eæ¯ä¸ª MPI è¿›ç¨‹æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œè¿›ç¨‹é—´é€šè¿‡\u003cstrong\u003eæ˜¾å¼æ¶ˆæ¯ä¼ é€’\u003c/strong\u003eï¼ˆå‘é€/æ¥æ”¶ï¼‰äº¤æ¢æ•°æ®\u003c/p\u003e\n\u003ch4 id=\"openmp-å…±äº«å†…å­˜å¹¶è¡Œ\"\u003eOpenMP: å…±äº«å†…å­˜å¹¶è¡Œ\u003c/h4\u003e\n\u003cp\u003eå¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€åœ°å€ç©ºé—´ä¸­å¹¶è¡Œæ‰§è¡Œï¼Œæ‰€æœ‰çº¿ç¨‹å¯ä»¥ç›´æ¥è®¿é—®ç›¸åŒçš„æ•°æ®ï¼Œä½¿ç”¨Â \u003ccode\u003e#pragma omp\u003c/code\u003eÂ æŒ‡ä»¤å®ç°å¹¶è¡ŒåŒ–\u003c/p\u003e\n\u003cp\u003eå¯¹éè®¡ç®—æœºä¸“ä¸šæ¥è¯´éå¸¸å‹å¥½ï¼Œåªéœ€è¦åœ¨æ­£å¸¸çš„ä»£ç ä¸Šé¢åŠ ä¸Šç¼–è¯‘æŒ‡ä»¤å³å¯ï¼Œèƒ½è½»æ¾å®ç°é«˜æ•ˆçš„å¹¶è¡Œä¼˜åŒ–\u003c/p\u003e\n\u003ch4 id=\"cuda-gpu-å¼‚æ„å¹¶è¡Œ\"\u003eCUDA: GPU å¼‚æ„å¹¶è¡Œ\u003c/h4\u003e\n\u003cp\u003eCPU è°ƒåº¦ï¼ŒGPU æ‰§è¡Œå¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæ¦‚å¿µ\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eæ ¸å‡½æ•° (Kernel)\u003c/strong\u003e ï¼šåœ¨ GPU ä¸Šå¹¶è¡Œæ‰§è¡Œçš„å‡½æ•°\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eçº¿ç¨‹å±‚æ¬¡\u003c/strong\u003eï¼šçº¿ç¨‹ (\u003ccode\u003ethreadIdx\u003c/code\u003e) ç»„æˆçº¿ç¨‹å— (\u003ccode\u003eblockIdx\u003c/code\u003e)ï¼Œçº¿ç¨‹å—ç»„æˆç½‘æ ¼ (\u003ccode\u003egridDim\u003c/code\u003e)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå†…å­˜å±‚æ¬¡\u003c/strong\u003eï¼šå¯„å­˜å™¨ã€å…±äº«å†…å­˜ï¼ˆå—å†…é«˜é€Ÿï¼‰ã€å…¨å±€å†…å­˜ï¼ˆæ‰€æœ‰çº¿ç¨‹å¯è®¿é—®ï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹\"\u003eæˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹\u003c/h2\u003e\n\u003ch4 id=\"ä»-web-10-åˆ°-web-20\"\u003eä» Web 1.0 åˆ° Web 2.0\u003c/h4\u003e\n\u003cp\u003eåœ¨ Web æ—¶ä»£ç”¨çš„æœ€å¹¿æ³›çš„æ˜¯ Javascript\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAsynchronous JavaScript and XML\u003c/strong\u003e (Ajax; ~1999)\n\u003cul\u003e\n\u003cli\u003eå…è®¸ç½‘é¡µå®ç°â€œåå°åˆ·æ–°â€\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ejQuery $ (2006): A DOM Query Language\u003c/strong\u003e (ç¼–ç¨‹æŠ½è±¡)\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"web-20-æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹\"\u003eWeb 2.0 æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹\u003c/h4\u003e\n\u003cp\u003eçº¿ç¨‹å¼€é”€å¤§ï¼Œå¹¶ä¸”å¤§å¤šæ•° Web å¼€å‘è€…éš¾ä»¥è¿›è¡Œå¹¶å‘ç¼–ç¨‹\u003c/p\u003e","title":"18. çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹ (1)"},{"content":"CPU å†…çš„å¹¶è¡Œç¼–ç¨‹ CPU çš„åŠŸè€— $ P=C\\cdot V^{2}\\cdot f $ å¯¼è‡´çºµä½¿æœ‰æ›´å¤§çš„ç”µè·¯ï¼Œçƒ­åŠŸè€—é™åˆ¶äº†æ€§èƒ½ä¸Šé™ï¼Œä»è€Œæœ‰ä¸€å µâ€œåŠŸè€—å¢™â€é™åˆ¶äº† CPU çš„æ€§èƒ½ï¼Œä¸ºæ­¤éœ€è¦è€ƒè™‘å¦‚ä½•åœ¨é™ä½ $ V $ å’Œ $ f $ çš„åŒæ—¶ç”¨é¢ç§¯æ¢æ€§èƒ½\næœ‰ä¸¤ä¸ªæ€è·¯ï¼š\nè®©ä¸€æ¡æŒ‡ä»¤èƒ½å¤„ç†æ›´å¤šçš„æ•°æ®ï¼šSIMD (Single Instruction, Multiple Data)\nâ€œä¸€æ¡æŒ‡ä»¤â€ æµªè´¹çš„èƒ½é‡å¤§è‡´æ˜¯å®šæ•° å¤„ç†çš„æ•°æ®è¶Šå¤šï¼Œæµªè´¹è¶Šå°‘ ç”¨æ›´å¤šæ›´ç®€å•çš„å¤„ç†å™¨ï¼šå¤šå¤„ç†å™¨ç³»ç»Ÿã€å¼‚æ„å¤šå¤„ç†å™¨\nåŒç­‰é¢ç§¯ï¼Œå¤„ç†å™¨è¶Šç®€å•ï¼Œæ•°é‡è¶Šå¤š å¼‚æ„è®¡ç®—ï¼šæœ€ç»å…¸çš„ä¾‹å­æ˜¯å¤§å°æ ¸æ¶æ„ï¼ˆå¦‚ Apple M1ï¼‰ SIMD SIMD çš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨ç¡¬ä»¶å±‚é¢å®ç°æ•°æ®çº§å¹¶è¡Œï¼Œå®ƒé€šè¿‡å¼•å…¥ä¸“é—¨çš„ç¡¬ä»¶å•å…ƒæ¥è¾¾æˆè¿™ä¸ªç›®æ ‡ï¼š\nå®½ä½å¯„å­˜å™¨ (Wide Registers)ï¼šCPU å†…éƒ¨å¢åŠ äº†æ¯”é€šç”¨å¯„å­˜å™¨å®½å¾ˆå¤šçš„ä¸“ç”¨å¯„å­˜å™¨\nIntel çš„ SSE æŒ‡ä»¤é›†å¼•å…¥äº† 128 ä½çš„ XMM å¯„å­˜å™¨ï¼Œè€Œæœ€æ–°çš„ AVX-512 æ‹¥æœ‰ 512 ä½çš„ ZMM å¯„å­˜å™¨ è¿™äº›å®½ä½å¯„å­˜å™¨å¯ä»¥ä¸€æ¬¡æ€§è£…å…¥å¤šä¸ªæ•°æ®å…ƒç´ ï¼Œæ¯”å¦‚ä¸€ä¸ª 128 ä½çš„å¯„å­˜å™¨å¯ä»¥åŒæ—¶å®¹çº³ 4 ä¸ª 32 ä½çš„æµ®ç‚¹æ•°ï¼Œæˆ–è€… 16 ä¸ª 8 ä½çš„æ•´æ•° è¿™äº›è¢«æ‰“åŒ…åœ¨ä¸€èµ·çš„æ•°æ®è¢«ç§°ä¸º Vector å‘é‡å¤„ç†å•å…ƒ (Vector ALU)ï¼šCPU å†…éƒ¨ä¹Ÿé…å¤‡äº†èƒ½å¤Ÿå¯¹æ•´ä¸ªå‘é‡è¿›è¡Œå¹¶è¡Œè®¡ç®—çš„ ALU\nå½“æ‰§è¡Œä¸€æ¡ SIMD æŒ‡ä»¤æ—¶ï¼Œè¿™ä¸ªç‰¹æ®Šçš„ ALU ä¼šåœ¨åŒä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼ŒåŒæ—¶å¯¹å¯„å­˜å™¨ä¸­çš„ 4 å¯¹æµ®ç‚¹æ•°åˆ†åˆ«æ‰§è¡Œæ“ä½œ ä¾‹å­ï¼šå‡è®¾æˆ‘ä»¬è¦è®¡ç®—ä¸¤ä¸ªæ•°ç»„ A å’Œ B çš„å’Œï¼Œå­˜å…¥æ•°ç»„ Cï¼Œæ¯ä¸ªæ•°ç»„éƒ½æœ‰ 4 ä¸ªå…ƒç´ ã€‚\nTraditionalï¼š\nload A[0] load B[0] add -\u0026gt; store C[0] load A[1] load B[1] add -\u0026gt; store C[1] \u0026hellip; é‡å¤ 4 æ¬¡ï¼Œéœ€è¦æ‰§è¡Œ 4 è½®ç‹¬ç«‹çš„â€œload-compute-storeâ€æŒ‡ä»¤ SIMDï¼š\nLOADï¼šå°†æ•°ç»„ A çš„ 4 ä¸ªå…ƒç´ ä¸€æ¬¡æ€§åŠ è½½åˆ°ä¸€ä¸ª 128 ä½çš„ XMM å¯„å­˜å™¨ä¸­ LOADï¼šå°†æ•°ç»„ B çš„ 4 ä¸ªå…ƒç´ åŠ è½½åˆ°å¦ä¸€ä¸ª XMM å¯„å­˜å™¨ä¸­ VADDPSï¼šCPU çš„å‘é‡å¤„ç†å•å…ƒå¯¹è¿™ä¸¤ä¸ªå¯„å­˜å™¨ä¸­çš„ 4 å¯¹å…ƒç´  åŒæ—¶ è¿›è¡ŒåŠ æ³•è¿ç®— STOREï¼šå°†è®¡ç®—ç»“æœå¯„å­˜å™¨ä¸­çš„ 4 ä¸ªå’Œå€¼ä¸€æ¬¡æ€§å­˜å›å†…å­˜ä¸­çš„æ•°ç»„ C é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒåŸæ¥éœ€è¦å¾ªç¯å¤šæ¬¡çš„è®¡ç®—è¢«å‹ç¼©æˆäº†å‡ æ¡é«˜æ•ˆçš„å‘é‡æŒ‡ä»¤ï¼Œæå¤§åœ°æå‡äº†ååç‡ï¼Œå°¤å…¶æ˜¯åœ¨å›¾åƒå¤„ç†ã€è§†é¢‘ç¼–è§£ç ã€ç§‘å­¦è®¡ç®—å’Œäººå·¥æ™ºèƒ½ç­‰éœ€è¦å¤§é‡é‡å¤æ€§è®¡ç®—çš„é¢†åŸŸï¼Œæ•ˆæœéå¸¸æ˜¾è‘—\nGPU å’Œ GPGPU ç¬¬äºŒç§å…‹æœâ€œåŠŸè€—å¢™â€çš„æ€è·¯â€”â€”ä½¿ç”¨æ›´å¤šã€æ›´ç®€å•çš„å¤„ç†å™¨â€”â€”ç›´æ¥å‚¬ç”Ÿäº† GPU (Graphics Processing Unit) çš„å‘å±•ï¼Œå®ƒæœ€åˆä¸ºå›¾å½¢æ¸²æŸ“è¿™ç§é«˜åº¦å¹¶è¡Œçš„ä»»åŠ¡è€Œè®¾è®¡ï¼Œå…¶æ¶æ„è¢«è¯æ˜éå¸¸æœ‰æ•ˆï¼Œæœ€ç»ˆæ¼”å˜æˆäº†ä¸€ä¸ªé€šç”¨è®¡ç®—çš„å¼ºå¤§å¼•æ“\nä» PPU åˆ° GPU å¯¹ä¸“ç”¨å›¾å½¢ç¡¬ä»¶çš„éœ€æ±‚åœ¨æ—©æœŸæ¸¸æˆæœºä¸­å°±å¾ˆæ˜æ˜¾ï¼šCPU åœ¨æ¸²æŸ“æ–¹é¢æ•ˆç‡æä½ï¼Œè®¡ç®—å±å¹•ä¸Šæ¯ä¸ªåƒç´ çš„é¢œè‰²ï¼Œæ¯ç§’é‡å¤ 60 æ¬¡ï¼Œè¿™ç§â€œå¤§è§„æ¨¡å¹¶è¡Œâ€ä»»åŠ¡ä¼šå®Œå…¨å‹å®ä¸ºä¸²è¡Œä»»åŠ¡è®¾è®¡çš„ CPU\næ—©æœŸæ–¹æ¡ˆ - PPUï¼šæ—©æœŸç³»ç»Ÿå°†å›¾å½¢ä»»åŠ¡äº¤ç»™ PPU (Picture Processing Unit) å¤„ç†ï¼Œè¿™æ˜¯ä¸€ç§é¢†åŸŸä¸“ç”¨ç¡¬ä»¶ï¼Œå®ƒæ“ä½œçš„æ˜¯é«˜çº§å›¾å½¢å¯¹è±¡ï¼Œå¦‚ tiles (8x8 åƒç´ å—) å’Œ sprites (å¯ç§»åŠ¨çš„å‰æ™¯è§’è‰²)ï¼Œè€Œéå•ä¸ªåƒç´ ï¼ŒCPU çš„å·¥ä½œè¢«ç®€åŒ–ä¸ºå‘Šè¯‰ PPU è¯¥ç”» å“ªä¸ª å›¾å—ä»¥åŠç”»åœ¨ å“ªé‡Œ\nå›ºå®šåŠŸèƒ½ Pipelineï¼šéšç€ 3D å›¾å½¢çš„å‡ºç°ï¼Œç®€å•çš„ PPU æ¨¡å‹æ¼”å˜ä¸ºæ›´å¤æ‚ä½†ä»ç„¶å›ºåŒ–çš„ â€œå›ºå®šåŠŸèƒ½ç®¡çº¿â€ (Fixed-Function Pipeline)ï¼Œå®ƒæœ‰ä¸€ç³»åˆ—ç¡¬ä»¶å®ç°çš„å›ºå®šé˜¶æ®µï¼Œè™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†é™¤äº†è°ƒæ•´é¢„è®¾å‚æ•°å¤–ï¼Œå‡ ä¹æ²¡æœ‰åˆ›é€ æ€§ç©ºé—´\néšåå¼€å‘è€…ä¸ºäº†è‡ªå®šä¹‰è§†è§‰æ•ˆæœï¼ŒæŠŠå›¾å½¢ç®¡çº¿ä¸­çš„å…³é”®éƒ¨åˆ†è¢«æ›¿æ¢ä¸ºå¯ç¼–ç¨‹å•å…ƒï¼Œå‘å±•å‡ºäº†å¯ç¼–ç¨‹çš„ç‰¹æ€§\nè¿™ç§å¯ç¼–ç¨‹æ€§èµ‹äºˆäº†å¼€å‘è€…å‰æ‰€æœªæœ‰çš„æ§åˆ¶åŠ›ï¼Œä¹Ÿæ ‡å¿—ç€ç°ä»£ GPU çš„è¯ç”Ÿ\nGPGPU äººä»¬å¾ˆå¿«æ„è¯†åˆ°ï¼Œä¸€ä¸ªä¸ºåƒç´ å¹¶è¡Œæ‰§è¡Œæ•°ç™¾ä¸‡ä¸ªç®€å•ç¨‹åºçš„èŠ¯ç‰‡ï¼Œç”¨é€”è¿œä¸æ­¢äºå›¾å½¢\næ—©æœŸçš„ hack ï¼šæœ€åˆçš„ GPGPU (General-Purpose computing on GPU) æ˜¯å¼€å‘è€…å°†ä¸€ä¸ªç§‘å­¦é—®é¢˜ï¼ˆå¦‚çŸ©é˜µä¹˜æ³•ï¼‰ä¼ªè£…æˆä¸€ä¸ªå›¾å½¢ä»»åŠ¡ï¼Œä¾‹å¦‚å°†çŸ©é˜µä½œä¸ºâ€œçº¹ç†â€åŠ è½½ï¼Œç„¶åç¼–å†™ä¸€ä¸ªâ€œç‰‡å…ƒç€è‰²å™¨â€æ¥è¿›è¡Œä¹˜æ³•è®¡ç®—ï¼Œæœ€åå°†ç»“æœâ€œé¢œè‰²â€å†™å‡º æ¼”å˜ä¸ºè®¡ç®—å¹³å°ï¼šè¿™ç§å¼ºå¤§ä½†ç¹ççš„æ–¹æ³•è¯æ˜äº†å…¶å¯è¡Œæ€§ï¼Œç¡¬ä»¶å‚å•†ï¼ˆæ¯”å¦‚ Nvidiaï¼‰éšå³æ¨å‡ºäº†ä¸“ç”¨çš„ç¼–ç¨‹æ¡†æ¶ï¼ˆCUDAï¼‰å’Œå¼€æ”¾æ ‡å‡†ï¼ˆOpenCLï¼‰ï¼Œè¿™äº›å¹³å°å½»åº•å‰¥ç¦»äº†å›¾å½¢æ¥å£ï¼Œå°† GPU å¼ºå¤§çš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›ç›´æ¥æš´éœ²ç»™å¼€å‘è€… AI æ—¶ä»£çš„å¹¶è¡Œç¼–ç¨‹ éšç€ GPGPU å¹³å°çš„æˆç†Ÿï¼Œå¯ç¼–ç¨‹çš„ Shader æ¨¡å‹ä¹Ÿæ¼”å˜æˆäº†æ›´é€šç”¨çš„çº¿ç¨‹æ¨¡å‹ï¼Œæœ€ç»ˆåœ¨ AI æ—¶ä»£å¤§æ”¾å¼‚å½©\nSIMTï¼šå•æŒ‡ä»¤ï¼Œå¤šçº¿ç¨‹ CUDA ç¼–ç¨‹æ¨¡å‹çš„æ ¸å¿ƒæ˜¯ SIMT (Single Instruction, Multiple Threads)ï¼Œè¿™æ˜¯å¯¹ SIMD æ€æƒ³çš„æ‰©å±•\nGPU ç¨‹åºä¸­æ¯ä¸ªåƒç´ æ‰§è¡Œä¸€æ¬¡çš„â€œç€è‰²å™¨â€ï¼Œåœ¨ CUDA è¢«çœ‹ä½œæ˜¯ä¸€ä¸ª Kernel å‡½æ•°ï¼Œä¼šè¢«æˆåƒä¸Šä¸‡ç”šè‡³æ•°ç™¾ä¸‡ä¸ª çº¿ç¨‹ å¹¶è¡Œæ‰§è¡Œ\nSIMT çš„é­”æ³•åœ¨äºï¼ŒGPU ä¼šå°†çº¿ç¨‹åˆ†ç»„ï¼ˆé€šå¸¸ 32 ä¸ªçº¿ç¨‹ä¸ºä¸€ä¸ª Warpï¼‰ï¼Œä¸€ä¸ª Warp å†…çš„æ‰€æœ‰çº¿ç¨‹å…±äº«åŒä¸€ä¸ªç¨‹åºè®¡æ•°å™¨ (PC)ï¼Œåœ¨ç¡¬ä»¶å±‚é¢ï¼Œå®ƒä»¬åœ¨åŒä¸€æ—¶åˆ»æ‰§è¡Œå®Œå…¨ç›¸åŒçš„æŒ‡ä»¤\nè¿™å®é™…ä¸Šåˆ›é€ äº†ä¸€ç§ç±»ä¼¼å·¨å‹ SIMD çš„æ•ˆæœï¼Œæ¯ä¸ªçº¿ç¨‹è™½ç„¶æœ‰è‡ªå·±ç‹¬ç«‹çš„å¯„å­˜å™¨å’Œæ•°æ®ï¼ˆé€šè¿‡ threadIdx ç­‰å†…ç½®å˜é‡åŒºåˆ†ï¼‰ï¼Œä½†å®ƒä»¬çš„æ‰§è¡Œæµè¢«æ†ç»‘åœ¨ä¸€èµ·ï¼Œè¿™ä½¿å¾—æ§åˆ¶å•å…ƒçš„è®¾è®¡å¯ä»¥æå…¶ç®€åŒ–ï¼Œä»è€Œåœ¨èŠ¯ç‰‡ä¸Šé›†æˆæµ·é‡çš„è®¡ç®—æ ¸å¿ƒ\nChallenges SIMT æ¶æ„åœ¨å¸¦æ¥å·¨å¤§å¹¶è¡Œä¼˜åŠ¿çš„åŒæ—¶ï¼Œä¹Ÿç»™å¸¦æ¥äº†æŒ‘æˆ˜ï¼š\nå†…å­˜åˆå¹¶ (Memory Coalescing)ï¼šå½“ä¸€ä¸ª Warp ä¸­çš„å¤šä¸ªçº¿ç¨‹è¿ç»­è®¿é—®å†…å­˜æ—¶ï¼ŒGPU ç¡¬ä»¶èƒ½å°†è¿™ 32 ä¸ªç‹¬ç«‹çš„è®¿é—®è¯·æ±‚åˆå¹¶æˆä¸€ç¬”æˆ–å‡ ç¬”å¤§çš„å†…å­˜äº‹åŠ¡ï¼Œè¿™æ˜¯ CUDA æ€§èƒ½ä¼˜åŒ–çš„å…³é”®\nåˆ†æ”¯å‘æ•£ (Branch Divergence)ï¼šSIMT æœ€å¤§çš„éš¾ç‚¹åœ¨äºå¤„ç†åˆ†æ”¯ï¼Œå¦‚æœä¸€ä¸ª Warp å†…çš„çº¿ç¨‹åœ¨ if-else è¯­å¥ä¸Šåšå‡ºä¸åŒé€‰æ‹©ï¼Œç”±äºå®ƒä»¬å…±äº«åŒä¸€ä¸ª PCï¼Œç¡¬ä»¶å¿…é¡»ä¸²è¡Œåœ°æ‰§è¡Œ if è·¯å¾„å’Œ else è·¯å¾„ï¼Œå¹¶åœ¨æ‰§è¡Œæ¯ä¸ªè·¯å¾„æ—¶ï¼Œå°†å¦ä¸€éƒ¨åˆ†çº¿ç¨‹æš‚æ—¶å±è”½ï¼Œè¿™ä¼šä½¿ Warp çš„æ‰§è¡Œé€Ÿåº¦å–å†³äºå†…éƒ¨æ‰§è¡Œæœ€æ…¢çš„çº¿ç¨‹\nå…±äº«å†…å­˜ (Shared Memory)ï¼šè™½ç„¶ CUDA çº¿ç¨‹å¯ä»¥è®¿é—®å…±äº«å†…å­˜ï¼Œä½†å¦‚ä½•é¿å…è®¿é—®å†²çª (Bank Conflict)ï¼Œå¦‚ä½•ç»„ç»‡æ•°æ®ä»¥æœ€å¤§åŒ–å¹¶è¡ŒåŠ è½½ï¼Œéƒ½ä¼šå¢åŠ  CUDA ç¨‹åºçš„ç¼–å†™éš¾åº¦\nå°½ç®¡ç¼–å†™é«˜æ•ˆçš„ CUDA ç¨‹åºå……æ»¡æŒ‘æˆ˜ï¼Œä½†å…¶å›æŠ¥æ˜¯å·¨å¤§çš„ï¼Œå°¤å…¶å¯¹äºé‚£äº›è®¡ç®—å¯†é›†ã€æ¨¡å¼å›ºå®šçš„ä»»åŠ¡ï¼Œä¾‹å¦‚æ·±åº¦å­¦ä¹ ä¸­çš„çŸ©é˜µä¹˜æ³•å’Œå·ç§¯è¿ç®—ï¼ŒGPU èƒ½æä¾›æ¯” CPU é«˜å‡ºæ•°ä¸ªæ•°é‡çº§çš„æ€§èƒ½å’Œèƒ½æ•ˆæ¯”\n","permalink":"https://diefish1024.github.io/posts/nju-os-2025/19-%E7%9C%9F%E5%AE%9E%E4%B8%96%E7%95%8C%E7%9A%84%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-2/","summary":"\u003ch2 id=\"cpu-å†…çš„å¹¶è¡Œç¼–ç¨‹\"\u003eCPU å†…çš„å¹¶è¡Œç¼–ç¨‹\u003c/h2\u003e\n\u003cp\u003eCPU çš„åŠŸè€— $ P=C\\cdot V^{2}\\cdot f $ å¯¼è‡´çºµä½¿æœ‰æ›´å¤§çš„ç”µè·¯ï¼Œçƒ­åŠŸè€—é™åˆ¶äº†æ€§èƒ½ä¸Šé™ï¼Œä»è€Œæœ‰ä¸€å µâ€œåŠŸè€—å¢™â€é™åˆ¶äº† CPU çš„æ€§èƒ½ï¼Œä¸ºæ­¤éœ€è¦è€ƒè™‘å¦‚ä½•åœ¨é™ä½ $ V $ å’Œ $ f $ çš„åŒæ—¶ç”¨é¢ç§¯æ¢æ€§èƒ½\u003c/p\u003e\n\u003cp\u003eæœ‰ä¸¤ä¸ªæ€è·¯ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eè®©ä¸€æ¡æŒ‡ä»¤èƒ½å¤„ç†æ›´å¤šçš„æ•°æ®\u003c/strong\u003eï¼šSIMD (Single Instruction, Multiple Data)\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eâ€œä¸€æ¡æŒ‡ä»¤â€ æµªè´¹çš„èƒ½é‡å¤§è‡´æ˜¯å®šæ•°\u003c/li\u003e\n\u003cli\u003eå¤„ç†çš„æ•°æ®è¶Šå¤šï¼Œæµªè´¹è¶Šå°‘\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eç”¨æ›´å¤šæ›´ç®€å•çš„å¤„ç†å™¨\u003c/strong\u003eï¼šå¤šå¤„ç†å™¨ç³»ç»Ÿã€å¼‚æ„å¤šå¤„ç†å™¨\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåŒç­‰é¢ç§¯ï¼Œå¤„ç†å™¨è¶Šç®€å•ï¼Œæ•°é‡è¶Šå¤š\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå¼‚æ„è®¡ç®—\u003c/strong\u003eï¼šæœ€ç»å…¸çš„ä¾‹å­æ˜¯\u003cstrong\u003eå¤§å°æ ¸æ¶æ„\u003c/strong\u003eï¼ˆå¦‚ Apple M1ï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"simd\"\u003eSIMD\u003c/h3\u003e\n\u003cp\u003eSIMD çš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨ç¡¬ä»¶å±‚é¢å®ç°æ•°æ®çº§å¹¶è¡Œï¼Œå®ƒé€šè¿‡å¼•å…¥ä¸“é—¨çš„ç¡¬ä»¶å•å…ƒæ¥è¾¾æˆè¿™ä¸ªç›®æ ‡ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå®½ä½å¯„å­˜å™¨ (Wide Registers)\u003c/strong\u003eï¼šCPU å†…éƒ¨å¢åŠ äº†æ¯”é€šç”¨å¯„å­˜å™¨å®½å¾ˆå¤šçš„ä¸“ç”¨å¯„å­˜å™¨\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIntel çš„ SSE æŒ‡ä»¤é›†å¼•å…¥äº† 128 ä½çš„ XMM å¯„å­˜å™¨ï¼Œè€Œæœ€æ–°çš„ AVX-512 æ‹¥æœ‰ 512 ä½çš„ ZMM å¯„å­˜å™¨\u003c/li\u003e\n\u003cli\u003eè¿™äº›å®½ä½å¯„å­˜å™¨å¯ä»¥ä¸€æ¬¡æ€§è£…å…¥å¤šä¸ªæ•°æ®å…ƒç´ ï¼Œæ¯”å¦‚ä¸€ä¸ª 128 ä½çš„å¯„å­˜å™¨å¯ä»¥åŒæ—¶å®¹çº³ 4 ä¸ª 32 ä½çš„æµ®ç‚¹æ•°ï¼Œæˆ–è€… 16 ä¸ª 8 ä½çš„æ•´æ•°\u003c/li\u003e\n\u003cli\u003eè¿™äº›è¢«æ‰“åŒ…åœ¨ä¸€èµ·çš„æ•°æ®è¢«ç§°ä¸º Vector\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå‘é‡å¤„ç†å•å…ƒ (Vector ALU)\u003c/strong\u003eï¼šCPU å†…éƒ¨ä¹Ÿé…å¤‡äº†èƒ½å¤Ÿå¯¹æ•´ä¸ªå‘é‡è¿›è¡Œå¹¶è¡Œè®¡ç®—çš„ ALU\u003c/p\u003e","title":"19. çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹ (2)"},{"content":"è¾“å…¥è¾“å‡ºè®¾å¤‡ Everything is a File åœ¨ Unix-like ç³»ç»Ÿä¸­ï¼Œä¸å¤–éƒ¨è®¾å¤‡äº¤äº’çš„æ ¸å¿ƒæ€æƒ³æ˜¯ Everything is a File\næ–‡ä»¶æè¿°ç¬¦ (File Descriptor)ï¼šæ“ä½œç³»ç»Ÿä¸ºä¸Šå±‚è½¯ä»¶æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æŠ½è±¡ï¼Œå³æ–‡ä»¶æè¿°ç¬¦ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘å†…æ ¸ä¸­ä»»ä½• I/O å¯¹è±¡çš„â€œæŒ‡é’ˆâ€æˆ–å¥æŸ„\nç»Ÿä¸€æ¥å£ï¼šæ— è®ºæ˜¯æ™®é€šæ–‡ä»¶ã€ç¡¬ä»¶è®¾å¤‡ï¼ˆå¦‚ç»ˆç«¯ã€ç£ç›˜ï¼‰ã€è¿˜æ˜¯ç½‘ç»œè¿æ¥ï¼Œéƒ½å¯ä»¥é€šè¿‡ open è·å¾—ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶åä½¿ç”¨ç›¸åŒçš„ read/write ç­‰ç³»ç»Ÿè°ƒç”¨æ¥è¿›è¡Œæ“ä½œï¼Œè¿™æå¤§åœ°ç®€åŒ–äº†åº”ç”¨ç¨‹åºçš„ç¼–å†™\nè®¾å¤‡æ§åˆ¶å™¨ä¸ MMIO â€œæ–‡ä»¶â€è¿™ä¸ªç¾å¥½çš„æŠ½è±¡èƒŒåï¼Œæ˜¯å…·ä½“çš„ç¡¬ä»¶å·¥ä½œåŸç†\nè®¾å¤‡æ§åˆ¶å™¨ (Device Controller)ï¼šæ¯ä¸ª I/O è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å« CPUã€å†…å­˜å’Œå¯„å­˜å™¨çš„å¾®å‹è®¡ç®—æœºï¼Œä½œä¸º CPU å’Œç‰©ç†è®¾å¤‡ä¹‹é—´çš„æ¡¥æ¢\nè®¾å¤‡å¯„å­˜å™¨ï¼šæ§åˆ¶å™¨é€šè¿‡ä¸€ç»„å¯„å­˜å™¨ä¸ CPU é€šä¿¡ï¼Œé€šå¸¸åŒ…æ‹¬ï¼š\nçŠ¶æ€å¯„å­˜å™¨ï¼šç”¨äºè¡¨ç¤ºè®¾å¤‡å½“å‰æ˜¯å¦ç¹å¿™ã€æ˜¯å¦å‡†å¤‡å¥½ç­‰ æŒ‡ä»¤å¯„å­˜å™¨ï¼šCPU å†™å…¥æŒ‡ä»¤ï¼Œå‘Šè¯‰è®¾å¤‡è¦åšä»€ä¹ˆ æ•°æ®å¯„å­˜å™¨ï¼šç”¨äºåœ¨ CPU å’Œè®¾å¤‡ä¹‹é—´ä¼ è¾“æ•°æ® å†…å­˜æ˜ å°„ I/O (MMIO)ï¼šä¸ºäº†è®© CPU èƒ½è®¿é—®è¿™äº›å¯„å­˜å™¨ï¼Œç°ä»£ç³»ç»Ÿæ™®éé‡‡ç”¨ MMIO (Memory-Mapped I/O)ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†è®¾å¤‡çš„å¯„å­˜å™¨æ˜ å°„åˆ°ç‰©ç†å†…å­˜åœ°å€ç©ºé—´ä¸­çš„ç‰¹å®šåŒºåŸŸï¼Œè¿™æ ·ä¸€æ¥ï¼ŒCPU å°±å¯ä»¥åƒè®¿é—®æ™®é€šå†…å­˜ä¸€æ ·ï¼Œä½¿ç”¨æ ‡å‡†çš„ load/store æŒ‡ä»¤æ¥è¯»å†™è®¾å¤‡å¯„å­˜å™¨ï¼Œä»è€Œå®ç°å¯¹è®¾å¤‡çš„æ§åˆ¶\nGPIO GPIO (General-Purpose Input/Output) æ˜¯ç†è§£ I/O è®¾å¤‡åŸç†æœ€ç›´è§‚çš„ä¾‹å­ï¼ŒGPIO å°±æ˜¯ä¸€ä¸ªç‰©ç†å¼•è„šï¼Œå¯ä»¥é€šè¿‡ç¼–ç¨‹è®¾ç½®ä¸ºè¾“å…¥æˆ–è¾“å‡ºæ¨¡å¼\né€šè¿‡ MMIOï¼Œä¸€ä¸ª GPIO å¼•è„šçš„ç”µå¹³çŠ¶æ€è¢«æ˜ å°„åˆ°ä¸€ä¸ªç‰¹å®šçš„å†…å­˜åœ°å€ï¼Œå½“ CPU å‘è¿™ä¸ªåœ°å€å†™å…¥ 1 æ—¶ï¼Œå¼•è„šå°±å˜ä¸ºé«˜ç”µå¹³ï¼›å†™å…¥ 0 æ—¶ï¼Œåˆ™å˜ä¸ºä½ç”µå¹³ï¼Œè¿™ä¸ªè¿‡ç¨‹å°†ä¸€æ¡å†…å­˜å†™æŒ‡ä»¤ç›´æ¥è½¬åŒ–ä¸ºäº†ä¸€ä¸ªç‰©ç†ä¸–ç•Œçš„åŠ¨ä½œï¼ˆæ¯”å¦‚ç‚¹äº®ä¸€ä¸ª LEDï¼‰\nè¾“å…¥è¾“å‡ºè®¾å¤‡æ¡ˆä¾‹ ä¸²å£ä¸é”®ç›˜ ç»å…¸çš„ I/O è®¾å¤‡ï¼Œå±•ç¤ºäº†æœ€åŸºç¡€çš„è®¾å¤‡äº¤äº’æ–¹å¼\nç«¯å£ I/Oï¼šå®ƒä»¬é€šå¸¸ä½¿ç”¨ç«¯å£ I/O (Port I/O) ä¸ CPU é€šä¿¡ï¼Œè®¾å¤‡å¯„å­˜å™¨è¢«æ˜ å°„åˆ°ä¸“ç”¨çš„ I/O ç«¯å£åœ°å€ï¼ˆè€Œéå†…å­˜åœ°å€ï¼‰ï¼ŒCPU éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„ in/out æŒ‡ä»¤æ¥è¯»å†™è¿™äº›ç«¯å£\nå‘æŒ‡å®šç«¯å£å†™å…¥ä¸åŒçš„æ•°å€¼ï¼Œç›¸å½“äºå‘è®¾å¤‡å‘é€ä¸åŒçš„æŒ‡ä»¤ï¼ˆå¦‚è®¾ç½®æ³¢ç‰¹ç‡ã€æ§åˆ¶é”®ç›˜ LED ç¯ï¼‰ï¼Œè€Œä»æŒ‡å®šç«¯å£è¯»å–æ•°æ®åˆ™æ˜¯æ¥æ”¶è®¾å¤‡çš„çŠ¶æ€æˆ–è¾“å…¥ï¼ˆå¦‚ä¸²å£æ”¶åˆ°çš„å­—ç¬¦ã€é”®ç›˜æŒ‰é”®çš„æ‰«æç ï¼‰\nç£ç›˜æ§åˆ¶å™¨ä¸ PIO æ—©æœŸçš„ç£ç›˜æ§åˆ¶å™¨ï¼ˆå¦‚ ATA/IDEï¼‰å±•ç¤ºäº†ä¸€ç§æ›´å¤æ‚ä½†æ•ˆç‡è¾ƒä½çš„äº¤äº’æ¨¡å¼ï¼šPIO åè®®ï¼šå…¨ç§°ä¸ºProgrammed I/Oï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ•°æ®çš„ä¼ è¾“å®Œå…¨ç”± CPU æ§åˆ¶\nå·¥ä½œæµç¨‹ï¼š\nCPU å‘ç£ç›˜æ§åˆ¶å™¨çš„æŒ‡ä»¤å¯„å­˜å™¨å†™å…¥å‘½ä»¤ï¼ˆå¦‚â€œè¯»å–ç¬¬ N ä¸ªæ‰‡åŒºâ€ï¼‰ CPU è¿›å…¥è½®è¯¢ (Polling) çŠ¶æ€ï¼Œåå¤è¯»å–çŠ¶æ€å¯„å­˜å™¨ï¼Œç›´åˆ°è®¾å¤‡æŠ¥å‘Šâ€œæ•°æ®å‡†å¤‡å°±ç»ªâ€ CPU åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ï¼Œé€ä¸ªå­—èŠ‚æˆ–å­—åœ°å°†æ•°æ®ä»ç£ç›˜çš„æ•°æ®å¯„å­˜å™¨è¯»å…¥ CPU å¯„å­˜å™¨ï¼Œå†å†™å…¥å†…å­˜ ç¼ºç‚¹ï¼šåœ¨è½®è¯¢å’Œæ•°æ®ä¼ è¾“æœŸé—´ï¼ŒCPU è¢«å®Œå…¨å ç”¨ï¼Œæ— æ³•æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œæ•ˆç‡æå…¶ä½ä¸‹\næ‰“å°æœºä¸ DSL æ‰“å°æœºè¿™ç±»è®¾å¤‡ï¼Œå°†äº¤äº’æ¨¡å‹æå‡åˆ°äº†ä¸€ä¸ªæ–°çš„é«˜åº¦\né¢†åŸŸä¸“ç”¨è¯­è¨€ (DSL)ï¼šæ‰“å°æœºä¸æ˜¯ç®€å•åœ°æ¥æ”¶åƒç´ æ•°æ®ï¼Œè€Œæ˜¯ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„è®¡ç®—æœºï¼Œæ¥æ”¶å¹¶è§£é‡Šç”¨é¡µé¢æè¿°è¯­è¨€ï¼ˆå¦‚ PostScript æˆ– PCLï¼‰ç¼–å†™çš„â€œç¨‹åºâ€\nCPUï¼ˆé©±åŠ¨ç¨‹åºï¼‰çš„è§’è‰²æ›´åƒæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå°†åº”ç”¨ç¨‹åºçš„æ‰“å°è¯·æ±‚ï¼ˆå¦‚ä¸€ä¸ª Word æ–‡æ¡£ï¼‰ç¼–è¯‘æˆä¸€ä¸² PostScript æŒ‡ä»¤æµï¼Œç„¶åå‘é€ç»™æ‰“å°æœº\næ‰“å°æœºå†…éƒ¨çš„å¤„ç†å™¨è´Ÿè´£æ‰§è¡Œè¿™äº›æŒ‡ä»¤ï¼Œå°†æŠ½è±¡çš„æè¿°ï¼ˆå¦‚â€œåœ¨è¿™é‡Œç”»ä¸€æ¡çº¿â€ã€â€œä½¿ç”¨è¿™ä¸ªå­—ä½“æ˜¾ç¤ºæ–‡æœ¬â€ï¼‰ç¿»è¯‘æˆæ‰“å°å¤´çš„ç‰©ç†åŠ¨ä½œ\næ€»çº¿ä¸å¯æ‰©å±•æ€§ å•ä¸ªè®¡ç®—æœºç³»ç»Ÿéœ€è¦è¿æ¥å¤šç§å¤šæ ·çš„è®¾å¤‡ï¼Œè¿™å°±éœ€è¦ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ‰©å±•æœºåˆ¶â€”â€”æ€»çº¿ (Bus)\næ€»çº¿æ˜¯ä¸€ç»„å…±äº«çš„ç”µå­çº¿è·¯ï¼Œå®ƒå®šä¹‰äº†ä¸€å¥—åè®®ï¼Œå…è®¸ CPUã€å†…å­˜å’Œå¤šä¸ª I/O è®¾å¤‡ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼Œå®ƒæä¾›äº†ä¸€ç§â€œè®¾å¤‡è™šæ‹ŸåŒ–â€ï¼ŒCPU åªéœ€ä¸æ€»çº¿æ§åˆ¶å™¨é€šä¿¡ï¼Œç”±æ€»çº¿è´Ÿè´£å°†è¯·æ±‚è½¬å‘åˆ°æ­£ç¡®çš„è®¾å¤‡\nå¯æ‰©å±•æ€§ï¼šé€šè¿‡æ ‡å‡†çš„æ‰©å±•æ’æ§½ï¼ˆå¦‚æ—©æœŸçš„ ISAã€ç°ä»£çš„ PCIeï¼‰ï¼Œç”¨æˆ·å¯ä»¥å‘ç³»ç»Ÿä¸­æ·»åŠ æ— ç©·æ— å°½çš„æ–°è®¾å¤‡ï¼Œè€Œæ— éœ€ä¿®æ”¹ä¸»æ¿æˆ– CPU çš„è®¾è®¡ PCIe æ€»çº¿ä¸ DMA PCIe (PCI Express) æ˜¯ç›®å‰ä¸»æµçš„é«˜é€Ÿæ€»çº¿æ ‡å‡†ï¼Œå®ƒå¼•å…¥äº†ä¸€é¡¹é©å‘½æ€§çš„æŠ€æœ¯æ¥è§£å†³ PIO çš„æ•ˆç‡é—®é¢˜ï¼šDMAï¼Œå…¨ç§°ä¸ºç›´æ¥å†…å­˜è®¿é—® (Direct Memory Access)ï¼Œå®ƒå…è®¸è®¾å¤‡æ§åˆ¶å™¨åœ¨æ²¡æœ‰ CPU å¹²é¢„çš„æƒ…å†µä¸‹ï¼Œç›´æ¥ä¸ä¸»å†…å­˜è¿›è¡Œæ•°æ®ä¼ è¾“\nå·¥ä½œæµç¨‹ï¼š\nCPU è®¾ç½® DMA æ§åˆ¶å™¨ï¼Œå‘Šè¯‰å®ƒæºåœ°å€ã€ç›®æ ‡åœ°å€å’Œä¼ è¾“å¤§å° CPU å‘è®¾å¤‡å‘å‡ºâ€œå¼€å§‹ä¼ è¾“â€çš„æŒ‡ä»¤åï¼Œå°±å¯ä»¥å»æ‰§è¡Œå…¶ä»–ä»»åŠ¡äº† DMA æ§åˆ¶å™¨å…¨æƒè´Ÿè´£æ•°æ®çš„æ¬è¿ ä¼ è¾“å®Œæˆåï¼ŒDMA æ§åˆ¶å™¨é€šè¿‡ä¸­æ–­é€šçŸ¥ CPU ä¼˜åŠ¿ï¼šDMA æå¤§åœ°è§£æ”¾äº† CPUï¼Œä½¿å…¶ä¸éœ€è¦è´Ÿè´£æ¬è¿æ•°æ®ï¼Œä»è€Œæ˜¾è‘—æå‡äº†æ•´ä¸ªç³»ç»Ÿçš„ I/O ååé‡å’Œæ•ˆç‡ï¼Œæ˜¯æ‰€æœ‰ç°ä»£é«˜æ€§èƒ½è®¾å¤‡ï¼ˆæ˜¾å¡ã€NVMe ç¡¬ç›˜ã€é«˜é€Ÿç½‘å¡ï¼‰çš„åŸºç¡€\nè®¾å¤‡é©±åŠ¨ç¨‹åº file_operations ç»“æ„ä½“ æ“ä½œç³»ç»Ÿå†…æ ¸é€šè¿‡åä¸º file_operations çš„ç»“æ„ä½“è½å®â€œEverything is a Fileâ€çš„æ€æƒ³\næ ¸å¿ƒæœºåˆ¶ï¼šè¿™ä¸ªç»“æ„ä½“æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆåˆ—è¡¨ï¼Œå®šä¹‰äº†ä¸€ç³»åˆ—æ ‡å‡†çš„æ–‡ä»¶æ“ä½œï¼Œå¦‚ read, write, open, llseek, ioctl ç­‰\né©±åŠ¨çš„æœ¬è´¨ï¼šä¸€ä¸ªè®¾å¤‡é©±åŠ¨ç¨‹åº (Device Driver) çš„æ ¸å¿ƒï¼Œå°±æ˜¯ä¸ºç‰¹å®šçš„ç¡¬ä»¶æˆ–è™šæ‹Ÿè®¾å¤‡ï¼Œæä¾›ä¸€å¥—å…·ä½“çš„ file_operations å®ç°ï¼Œå½“ä¸€ä¸ªè®¾å¤‡è¢«æ³¨å†Œåˆ°ç³»ç»Ÿä¸­æ—¶ï¼Œå†…æ ¸å°±ä¼šå°†è¿™ä¸ªè®¾å¤‡çš„â€œæ–‡ä»¶â€ä¸è¿™å¥—æ“ä½œå‡½æ•°å…³è”èµ·æ¥\né©±åŠ¨çš„ç¿»è¯‘èŒè´£ è®¾å¤‡é©±åŠ¨ç¨‹åºçš„æ ¸å¿ƒèŒè´£ï¼Œå°±æ˜¯ç¿»è¯‘åº”ç”¨ç¨‹åºå’Œç‰©ç†ç¡¬ä»¶ä¹‹é—´çš„äº¤äº’\nç¿»è¯‘è¿‡ç¨‹ï¼šå½“ä¸€ä¸ªç”¨æˆ·ç¨‹åºå¯¹æ–‡ä»¶æè¿°ç¬¦æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼ˆä¾‹å¦‚ read(fd, buf, size)ï¼‰ï¼Œå†…æ ¸ä¼šï¼š\né€šè¿‡ fd æ‰¾åˆ°å¯¹åº”çš„å†…æ ¸æ–‡ä»¶å¯¹è±¡ ä»æ–‡ä»¶å¯¹è±¡ä¸­æ‰¾åˆ°å…³è”çš„ file_operations ç»“æ„ä½“ è°ƒç”¨å…¶ä¸­çš„ .read å‡½æ•°æŒ‡é’ˆï¼Œå¹¶å°†ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ä¼ é€’è¿‡å» é©±åŠ¨çš„å®ç°ï¼šé©±åŠ¨ç¨‹åºä¸­çš„ .read å‡½æ•°åˆ™è´Ÿè´£æ‰§è¡Œè®¾å¤‡ç›¸å…³çš„åº•å±‚æ“ä½œï¼Œæ¯”å¦‚é€šè¿‡ MMIO æˆ– PIO å‘è®¾å¤‡æ§åˆ¶å™¨å‘é€æŒ‡ä»¤ï¼Œç­‰å¾…æ•°æ®å°±ç»ªï¼Œç„¶åå°†æ•°æ®ä»è®¾å¤‡å¯„å­˜å™¨ä¸­è¯»å‡ºï¼Œæœ€åå¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´çš„ buf ä¸­\nè™šæ‹Ÿè®¾å¤‡ï¼šè¿™ä¸ªæ¨¡å‹åŒæ ·é€‚ç”¨äºè™šæ‹Ÿè®¾å¤‡ï¼Œä¾‹å¦‚å¯¹ /dev/null çš„ write æ“ä½œï¼Œå…¶é©±åŠ¨å®ç°ä»…ä»…æ˜¯ç›´æ¥è¿”å›å†™å…¥çš„å­—èŠ‚æ•°ï¼Œè€Œä»€ä¹ˆä¹Ÿä¸åšï¼Œå¯¹ /proc/stat çš„ read æ“ä½œï¼Œåˆ™æ˜¯è¯»å–å†…æ ¸ä¸­çš„ç»Ÿè®¡æ•°æ®å¹¶æ ¼å¼åŒ–æˆå­—ç¬¦ä¸²è¿”å›\nioctl ä¸‡èƒ½æ¥å£ å¯¹äºè¯»å†™æ•°æ®æµä¹‹å¤–çš„è®¾å¤‡æ§åˆ¶å’Œé…ç½®éœ€æ±‚ï¼ˆå¦‚è®¾ç½®é”®ç›˜é‡å¤ç‡ã€è·å–ç£ç›˜å¥åº·ä¿¡æ¯ã€é…ç½®ç½‘ç»œå‚æ•°ç­‰ï¼‰ï¼Œread/write æ¨¡å‹æ˜¾ç„¶ä¸èƒ½æ»¡è¶³ï¼Œä¸ºæ­¤ï¼ŒUnix ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªé€šç”¨çš„ ioctl (I/O Control) ç³»ç»Ÿè°ƒç”¨\nioctl æ˜¯ä¸€ä¸ªé«˜åº¦çµæ´»çš„æ¥å£ï¼Œå®ƒçš„å…·ä½“è¡Œä¸ºå®Œå…¨ç”±è®¾å¤‡é©±åŠ¨ç¨‹åºå®šä¹‰ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡ä¼ é€’ä¸€ä¸ªè®¾å¤‡ä¸“å±çš„å‘½ä»¤ç å’Œå‚æ•°ï¼Œæ¥æ‰§è¡Œç‰¹å®šçš„æ§åˆ¶åŠŸèƒ½\nè™½ç„¶å¼ºå¤§ï¼Œä½† ioctl ä¹Ÿå¸¦æ¥äº†å·¨å¤§çš„å¤æ‚æ€§ï¼Œå› ä¸ºæ¯ä¸ªè®¾å¤‡çš„å‘½ä»¤é›†éƒ½ä¸åŒï¼Œå½¢æˆäº†ä¸€ç³»åˆ—éšè—çš„ã€éæ ‡å‡†çš„åè®®ï¼Œåº”ç”¨ç¨‹åºéœ€è¦çŸ¥é“è¿™äº›ç»†èŠ‚æ‰èƒ½ä¸è®¾å¤‡æ·±åº¦äº¤äº’ï¼ˆæ˜¯å·¨å¤§çš„å±å±±ğŸ’©ï¼‰\nå®é™…æ¡ˆä¾‹ï¼š\nlibc ç¼“å†²ï¼šlibc åº“é€šè¿‡å¯¹æ–‡ä»¶æè¿°ç¬¦ 1 (stdout) æ‰§è¡Œä¸€ä¸ª tty è®¾å¤‡ä¸“å±çš„ ioctl å‘½ä»¤ï¼ˆå¦‚ TCGETSï¼‰ï¼Œæ¥åˆ¤æ–­è¾“å‡ºç›®æ ‡æ˜¯å¦ä¸ºä¸€ä¸ªäº¤äº’å¼ç»ˆç«¯ï¼Œä»è€Œå†³å®šæ˜¯é‡‡ç”¨è¡Œç¼“å†²è¿˜æ˜¯å…¨ç¼“å†²\nKVM è™šæ‹ŸåŒ–ï¼šKVM å°±æ˜¯ä¸€ä¸ªé€šè¿‡ ioctl æš´éœ²å…¨éƒ¨åŠŸèƒ½çš„å¤æ‚è®¾å¤‡ï¼Œç”¨æˆ·ç¨‹åºæ‰“å¼€ /dev/kvm åï¼Œé€šè¿‡ä¸€ç³»åˆ— ioctl å‘½ä»¤ï¼ˆå¦‚ KVM_CREATE_VM, KVM_SET_REGS, KVM_RUNï¼‰æ¥åˆ›å»ºè™šæ‹Ÿæœºã€è®¾å®š CPU çŠ¶æ€å¹¶è¿è¡Œè™šæ‹Ÿæœºï¼Œç›´åˆ°å‘ç”Ÿ VM Exit äº‹ä»¶è¿”å›åˆ°ç”¨æˆ·æ€\n","permalink":"https://diefish1024.github.io/posts/nju-os-2025/20-%E8%AE%BE%E5%A4%87%E5%92%8C%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/","summary":"\u003ch2 id=\"è¾“å…¥è¾“å‡ºè®¾å¤‡\"\u003eè¾“å…¥è¾“å‡ºè®¾å¤‡\u003c/h2\u003e\n\u003ch3 id=\"everything-is-a-file\"\u003eEverything is a File\u003c/h3\u003e\n\u003cp\u003eåœ¨ Unix-like ç³»ç»Ÿä¸­ï¼Œä¸å¤–éƒ¨è®¾å¤‡äº¤äº’çš„æ ¸å¿ƒæ€æƒ³æ˜¯ \u003cstrong\u003eEverything is a File\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eæ–‡ä»¶æè¿°ç¬¦ (File Descriptor)\u003c/strong\u003eï¼šæ“ä½œç³»ç»Ÿä¸ºä¸Šå±‚è½¯ä»¶æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æŠ½è±¡ï¼Œå³æ–‡ä»¶æè¿°ç¬¦ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘å†…æ ¸ä¸­ä»»ä½• I/O å¯¹è±¡çš„â€œæŒ‡é’ˆâ€æˆ–å¥æŸ„\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eç»Ÿä¸€æ¥å£\u003c/strong\u003eï¼šæ— è®ºæ˜¯æ™®é€šæ–‡ä»¶ã€ç¡¬ä»¶è®¾å¤‡ï¼ˆå¦‚ç»ˆç«¯ã€ç£ç›˜ï¼‰ã€è¿˜æ˜¯ç½‘ç»œè¿æ¥ï¼Œéƒ½å¯ä»¥é€šè¿‡ \u003ccode\u003eopen\u003c/code\u003e è·å¾—ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶åä½¿ç”¨ç›¸åŒçš„ \u003ccode\u003eread\u003c/code\u003e/\u003ccode\u003ewrite\u003c/code\u003e ç­‰ç³»ç»Ÿè°ƒç”¨æ¥è¿›è¡Œæ“ä½œï¼Œè¿™æå¤§åœ°ç®€åŒ–äº†åº”ç”¨ç¨‹åºçš„ç¼–å†™\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"è®¾å¤‡æ§åˆ¶å™¨ä¸-mmio\"\u003eè®¾å¤‡æ§åˆ¶å™¨ä¸ MMIO\u003c/h3\u003e\n\u003cp\u003eâ€œæ–‡ä»¶â€è¿™ä¸ªç¾å¥½çš„æŠ½è±¡èƒŒåï¼Œæ˜¯å…·ä½“çš„ç¡¬ä»¶å·¥ä½œåŸç†\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eè®¾å¤‡æ§åˆ¶å™¨ (Device Controller)\u003c/strong\u003eï¼šæ¯ä¸ª I/O è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å« CPUã€å†…å­˜å’Œå¯„å­˜å™¨çš„å¾®å‹è®¡ç®—æœºï¼Œä½œä¸º CPU å’Œç‰©ç†è®¾å¤‡ä¹‹é—´çš„æ¡¥æ¢\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eè®¾å¤‡å¯„å­˜å™¨\u003c/strong\u003eï¼šæ§åˆ¶å™¨é€šè¿‡ä¸€ç»„\u003cstrong\u003eå¯„å­˜å™¨\u003c/strong\u003eä¸ CPU é€šä¿¡ï¼Œé€šå¸¸åŒ…æ‹¬ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eçŠ¶æ€å¯„å­˜å™¨\u003c/strong\u003eï¼šç”¨äºè¡¨ç¤ºè®¾å¤‡å½“å‰æ˜¯å¦ç¹å¿™ã€æ˜¯å¦å‡†å¤‡å¥½ç­‰\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæŒ‡ä»¤å¯„å­˜å™¨\u003c/strong\u003eï¼šCPU å†™å…¥æŒ‡ä»¤ï¼Œå‘Šè¯‰è®¾å¤‡è¦åšä»€ä¹ˆ\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ•°æ®å¯„å­˜å™¨\u003c/strong\u003eï¼šç”¨äºåœ¨ CPU å’Œè®¾å¤‡ä¹‹é—´ä¼ è¾“æ•°æ®\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå†…å­˜æ˜ å°„ I/O (MMIO)\u003c/strong\u003eï¼šä¸ºäº†è®© CPU èƒ½è®¿é—®è¿™äº›å¯„å­˜å™¨ï¼Œç°ä»£ç³»ç»Ÿæ™®éé‡‡ç”¨ \u003cstrong\u003eMMIO (Memory-Mapped I/O)\u003c/strong\u003eï¼Œæ“ä½œç³»ç»Ÿä¼šå°†è®¾å¤‡çš„å¯„å­˜å™¨æ˜ å°„åˆ°ç‰©ç†å†…å­˜åœ°å€ç©ºé—´ä¸­çš„ç‰¹å®šåŒºåŸŸï¼Œè¿™æ ·ä¸€æ¥ï¼ŒCPU å°±å¯ä»¥åƒè®¿é—®æ™®é€šå†…å­˜ä¸€æ ·ï¼Œä½¿ç”¨æ ‡å‡†çš„ \u003ccode\u003eload\u003c/code\u003e/\u003ccode\u003estore\u003c/code\u003e æŒ‡ä»¤æ¥è¯»å†™è®¾å¤‡å¯„å­˜å™¨ï¼Œä»è€Œå®ç°å¯¹è®¾å¤‡çš„æ§åˆ¶\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"gpio\"\u003eGPIO\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eGPIO (General-Purpose Input/Output)\u003c/strong\u003e æ˜¯ç†è§£ I/O è®¾å¤‡åŸç†æœ€ç›´è§‚çš„ä¾‹å­ï¼ŒGPIO å°±æ˜¯ä¸€ä¸ªç‰©ç†å¼•è„šï¼Œå¯ä»¥é€šè¿‡ç¼–ç¨‹è®¾ç½®ä¸ºè¾“å…¥æˆ–è¾“å‡ºæ¨¡å¼\u003c/p\u003e\n\u003cp\u003eé€šè¿‡ MMIOï¼Œä¸€ä¸ª GPIO å¼•è„šçš„ç”µå¹³çŠ¶æ€è¢«æ˜ å°„åˆ°ä¸€ä¸ªç‰¹å®šçš„å†…å­˜åœ°å€ï¼Œå½“ CPU å‘è¿™ä¸ªåœ°å€å†™å…¥ \u003ccode\u003e1\u003c/code\u003e æ—¶ï¼Œå¼•è„šå°±å˜ä¸ºé«˜ç”µå¹³ï¼›å†™å…¥ \u003ccode\u003e0\u003c/code\u003e æ—¶ï¼Œåˆ™å˜ä¸ºä½ç”µå¹³ï¼Œè¿™ä¸ªè¿‡ç¨‹å°†ä¸€æ¡å†…å­˜å†™æŒ‡ä»¤ç›´æ¥è½¬åŒ–ä¸ºäº†ä¸€ä¸ªç‰©ç†ä¸–ç•Œçš„åŠ¨ä½œï¼ˆæ¯”å¦‚ç‚¹äº®ä¸€ä¸ª LEDï¼‰\u003c/p\u003e","title":"20. è®¾å¤‡å’Œé©±åŠ¨ç¨‹åº"},{"content":"ç§‘æ™®æ€§è´¨ï¼Œç®€å•è®°å½•ä¸€ä¸‹\n1-Bit çš„å­˜å‚¨ï¼šç£é“ è¦å®ç°â€œæŒä¹…åŒ–â€å­˜å‚¨ï¼Œæ ¸å¿ƒæ˜¯è¦æ‰¾åˆ°ä¸€ä¸ªèƒ½åå¤æ”¹å†™çš„çŠ¶æ€ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°èƒ½å¤Ÿåˆ©ç”¨ç£çš„ç‰¹æ€§ï¼Œè¿™å°±æœ‰äº†ç£å¸¦çš„åˆæ­¥æƒ³æ³•ï¼š\nä¸€ä¸ªé•¿æ¡çš„å¸¦å­ä¸Šé¢å‡åŒ€æœ‰ç£æ€§ç‰©è´¨ å®šä½åˆ°ç‰¹å®šä½ç½®ä¹‹åé€šè¿‡æ”¾å¤§æ„Ÿåº”ç”µæµè¯»å– ç”¨ç”µç£é“æ”¹å˜ç£åŒ–æ–¹å‘æ¥å†™å…¥æ•°æ® ä¸ºäº†æé«˜å­˜å‚¨å¯†åº¦ï¼Œå¯ä»¥æŠŠè¿™æ ·çš„å¸¦å­ç»™å·èµ·æ¥ï¼Œäºæ˜¯å°±å¾—åˆ°äº†ç£å¸¦\nè¿™æ ·çš„å­˜å‚¨æ–¹å¼ä¸»è¦ç¼ºç‚¹æ˜¯å‡ ä¹ä¸èƒ½éšæœºè¯»å†™ï¼ˆæ¯”å¦‚ç£å¸¦æ”¶éŸ³æœºéœ€è¦å€’å¸¦ï¼‰ï¼Œä¸€èˆ¬ç”¨äºå†·æ•°æ®çš„å­˜æ¡£å’Œå¤‡ä»½\nä¸ºäº†è§£å†³è¿™ä¸ªç¼ºç‚¹ï¼Œå¯ä»¥æƒ³åˆ°ç”¨æ—‹è½¬çš„äºŒç»´å¹³é¢æ¥æ›¿ä»£å·èµ·æ¥çš„å¸¦å­ï¼Œè¿™æ ·è¯»å†™å»¶è¿Ÿå°±ä¸ä¼šè¶…è¿‡æ—‹è½¬çš„å‘¨æœŸï¼Œè¿™å°±å¾—åˆ°äº†ç£é¼“ï¼š\nå†åœ¨ç£é¼“çš„åŸºç¡€ä¸Šè¿›ä¸€æ­¥å†…å·ï¼ŒæŠŠç”¨åœ†ç›˜ä»£æ›¿æŸ±é¢ï¼Œä»è€Œå¯ä»¥å †å èµ·æ¥ï¼Œè¿›ä¸€æ­¥æé«˜äº†å­˜å‚¨å¯†åº¦ï¼Œè¿™å°±å¾—åˆ°äº†ç£ç›˜ï¼š\nç£ç›˜ä½œä¸ºå­˜å‚¨è®¾å¤‡çš„éšæœºè¯»å†™æ€§èƒ½è™½ç„¶ç›¸æ¯”ç£å¸¦æœ‰äº†å¾ˆå¤§çš„æ”¹å–„ï¼Œä½†æ˜¯è¿˜æ˜¯éœ€è¦ç­‰å¾…å®šä½åˆ°æ­£ç¡®çš„ä½ç½®ï¼Œæ€§èƒ½ä»ç„¶ä¸å¤Ÿä¼˜ç§€ï¼Œä¸ºäº†è¯»å†™å®šä½åˆ°ä¸€ä¸ªæ‰‡åŒºé€šå¸¸éœ€è¦èŠ±è´¹å‡ ä¸ªæ¯«ç§’çš„æ—¶é—´ï¼Œè¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ç¼“å­˜å’Œè°ƒåº¦ç®—æ³•æ¥ç¼“è§£ï¼Œè®©æ•°æ®å°½å¯èƒ½è¿ç»­å­˜å‚¨\nå½“æˆ‘ä»¬åœ¨ç£ç›˜çš„åŸºç¡€ä¸ŠæŠŠè¯»å†™å¤´å’Œç›˜ç‰‡æœ¬ä½“åˆ†å¼€ï¼Œæˆ‘ä»¬å°±å®ç°äº†æ•°æ®çš„ç§»åŠ¨ï¼Œè¿™ä¹Ÿå°±å¾—åˆ°äº†è½¯ç›˜ï¼Œè¿™æ˜¯ä¸Šä¸ªæ•°æ®æ•°æ®å‘è¡Œçš„ä¸»è¦æ–¹å¼ï¼Œè™½ç„¶æ€§èƒ½å’Œå¯é æ€§éƒ½æ¯”è¾ƒä½ï¼Œä½†æ˜¯èƒœåœ¨äº†ä¾¿æ·ã€å¯ç§»åŠ¨\n1-Bit çš„å­˜å‚¨ï¼šæŒ–å‘ å¤äººå®ç°æŒä¹…åŒ–å­˜å‚¨çš„æ–¹å¼æ˜¯åœ¨çŸ³å¤´ä¸Šåˆ»å­—ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡æŒ–å‘æ¥å­˜å‚¨ä¿¡æ¯ï¼Œè¿™ç§æ–¹å¼å¯ä»¥è·¨è¶Šéå¸¸é•¿çš„æ—¶é—´\nè€Œç°ä»£å·¥ä¸šä½¿æˆ‘ä»¬å¯ä»¥æŒ–å‡ºæ›´åŠ ç²¾ç»†çš„å‘ï¼Œä»è€Œå¯ä»¥å­˜å‚¨æ›´é«˜å¯†åº¦çš„ä¿¡æ¯\nä¸ºäº†è¯»å–è¿™æ ·çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ä»å…‰å­¦çš„è§’åº¦è€ƒè™‘ï¼šåœ¨åå°„å¹³é¢ä¸ŠæŒ–ç²—ç³™å‘ï¼Œæ¿€å…‰æ‰«è¿‡è¡¨é¢ï¼Œåœ¨å¹³é¢ä¼šåå°„å›æ¥ï¼Œåœ¨å‘é‡Œä¼šå‘ç”Ÿæ¼«åå°„ï¼Œäºæ˜¯æˆ‘ä»¬åªè¦æ£€æµ‹æ˜¯å¦æ”¶åˆ°åå°„å…‰å°±å¯ä»¥è¯†åˆ«æ˜¯å‘è¿˜æ˜¯è¡¨é¢ï¼Œè¿™ä¹Ÿå°±æ˜¯å…‰ç›˜\nå…‰ç›˜æœ€æœ‰è¶£çš„ç‰¹æ€§æ˜¯å®¹æ˜“å¤åˆ¶ï¼Œæˆ‘ä»¬è¦åˆ¶é€ å…‰ç›˜å¯ä»¥å…ˆä»”ç»†åœ°åˆ¶é€ ä¸€å¼ åè½¬çš„ç›˜ç‰‡ï¼Œå‘çš„ä½ç½®å¯¹åº”å…¶è¡¨é¢çš„çªèµ·ï¼Œä¹‹ååªéœ€è¦ç›´æ¥ç”¨è¿™ä¸ªç›˜ç‰‡å‹åˆ¶åŠ çƒ­çš„å¡‘æ–™å†é•€ä¸Šåå°„è†œå°±å¯ä»¥å¾—åˆ°ä¸€å¼ å…‰ç›˜ï¼Œè¿™ç§æ–¹å¼å¯ä»¥è¾¾åˆ°æé«˜çš„å†™å…¥é€Ÿåº¦\nå½“ç„¶è¿™ç§æŒ–å‘æ–¹å¼çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§å°±æ˜¯ä¸èƒ½ä¿®æ”¹å·²ç»å†™å…¥çš„å†…å®¹çš„ï¼Œå¾ˆéš¾å¡«ä¸Šä¸€ä¸ªå·²ç»æŒ–äº†çš„å‘ï¼ˆå½“ç„¶é€šè¿‡ç‰¹æ®Šçš„åˆ¶é€ ææ–™å’Œå·¥è‰ºä¹Ÿæ˜¯å¯ä»¥åšåˆ°çš„ï¼‰ï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´é‡Œé¢å­˜å‚¨çš„æ•°æ®æ˜¯ append only çš„ï¼Œæƒ³è¦ä¿®æ”¹ä¹‹å‰çš„å†…å®¹å¯ä»¥é‡‡ç”¨å¯æŒä¹…åŒ–äºŒå‰æ ‘çš„ç»“æ„\nå…‰ç›˜ä½œä¸ºå­˜å‚¨è®¾å¤‡ï¼Œä»·æ ¼ä½çš„åŒæ—¶å®¹é‡å’Œå¯é æ€§éƒ½æ¯”è¾ƒé«˜ï¼ŒåŒæ—¶é¡ºåºè¯»æ€§èƒ½ä¸€èˆ¬ï¼Œéšæœºè¯»æ€§èƒ½ä½å¹¶ä¸”å¾ˆéš¾å†™å…¥ï¼Œä¸€ä¸ªé‡è¦çš„åº”ç”¨å¸¸è§å°±æ˜¯æ•°å­—æ—¶ä»£çš„å†…å®¹åˆ†å‘\nç°ä»£è¿™ç§æŒ–å‘çš„å­˜å‚¨æ–¹å¼è¿˜æœ‰ä¸€ç§åº”ç”¨æ–¹å¼æ˜¯å›å½’å¤äººçŸ³ç¢‘çš„å½¢å¼ï¼ŒæŠŠä¿¡æ¯åˆ»åœ¨å¾ˆç¨³å®šçš„ææ–™ä¸Šæ¥åšåˆ°æ°¸ä¹…å­˜å‚¨\n1-Bit çš„å­˜å‚¨ï¼šç”µè· å‰ä¸¤ç§å­˜å‚¨ä»‹è´¨éƒ½å­˜åœ¨æ¯”è¾ƒå¤§çš„ç¼ºé™·ï¼š\nç£ï¼šä¾èµ–æœºæ¢°éƒ¨ä»¶ï¼Œä»è€Œæ— æ³•é¿å… ms çº§åˆ«çš„å»¶è¿Ÿ å‘ï¼ˆå…‰ï¼‰ï¼šæŒ–å‘æ•ˆç‡ä½ï¼ŒåŒæ—¶å¡«å‘å¾ˆå›°éš¾ è€Œç”µè·åˆ™æ˜¯ä¸€ç§éå¸¸ç†æƒ³çš„å­˜å‚¨ä»‹è´¨ï¼šç”µå­çš„å¯†åº¦æé«˜ï¼Œå¹¶ä¸”ç”µè·¯çš„é€Ÿåº¦æå¿«ï¼ˆè¿˜å¤©ç„¶å¹¶è¡Œï¼‰\nåœ¨ç”µè·¯ä¸­å®ç° 1-bit çš„æŒä¹…å­˜å‚¨ï¼Œä¸€ä¸ªæƒ³æ³•æ˜¯æˆ‘ä»¬å¯ä»¥æŒ–ä¸€ä¸ªå‘ï¼Œä¸¤ç§çŠ¶æ€åˆ†åˆ«æ˜¯ï¼š\nåœ¨å‘é‡Œå¡«å…¥ç”µå­ ä»å‘é‡Œæ”¾è·‘ç”µå­ è€Œè¿™å°±å¾—åˆ°äº†é—ªå­˜ (Flash Memory) ï¼š å…¶ä½œä¸ºå­˜å‚¨è®¾å¤‡ï¼Œä»·æ ¼ä½ï¼Œå®¹é‡å’Œå¯é æ€§é«˜ï¼Œè€Œä¸”è¯»å†™æ€§èƒ½æé«˜ï¼ˆç”±äºç”µè·¯å¤©ç„¶å¹¶è¡Œï¼Œæ‰€ä»¥å®¹é‡è¶Šå¤§ï¼Œé€Ÿåº¦è¶Šå¿«ï¼‰\nç„¶è€Œï¼Œé—ªå­˜çš„ç‰©ç†åŸç†ä¹Ÿå¸¦æ¥äº†å…¶å›ºæœ‰çš„ç¼ºé™·ï¼Œå³ä¼šç£¨æŸ (wear out)\næ¯æ¬¡æ”¾ç”µ (erase) æ“ä½œéƒ½æ— æ³• 100% å°†ç”µå­æ”¾å¹²å‡€ï¼Œè¿™ä¼šå¯¹å­˜å‚¨å•å…ƒé€ æˆå¾®å°çš„ã€ä¸å¯é€†çš„æŸä¼¤ åœ¨ç»å†æ•°åƒæˆ–æ•°ä¸‡æ¬¡æ“¦å†™å¾ªç¯åï¼Œä¸€äº›å­˜å‚¨å•å…ƒä¼šå› ä¸ºç´¯ç§¯çš„æŸä¼¤è€Œå¤±æ•ˆï¼Œæ— æ³•å†å¯é åœ°å­˜å‚¨æ•°æ®ï¼Œè¿™è¢«ç§°ä¸º â€œæ­»å•å…ƒ (Dead Cell)â€ ä¸ºäº†è§£å†³é—ªå­˜çš„ç£¨æŸé—®é¢˜ï¼Œå¹¶å°†å…¶æ›´å¥½åœ°å‘ˆç°ç»™æ“ä½œç³»ç»Ÿï¼Œç°ä»£å›ºæ€å­˜å‚¨è®¾å¤‡ï¼ˆå¦‚ SSDã€U ç›˜ã€SD å¡ï¼‰å†…éƒ¨å®é™…ä¸Šéƒ½é›†æˆäº†ä¸€ä¸ªå¾®å‹è®¡ç®—æœºç³»ç»Ÿ\nè¿™ä¸ªç³»ç»Ÿè¿è¡Œç€ä¸€å±‚è¢«ç§°ä¸º FTL (Flash Translation Layer) çš„å›ºä»¶ï¼Œå®ƒçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€æ˜¯ ç£¨æŸå‡è¡¡ (Wear Leveling)\nFTL ä¼šè®°å½•æ¯ä¸ªç‰©ç†å—çš„æ“¦å†™æ¬¡æ•°ï¼Œå½“æ“ä½œç³»ç»Ÿè¯·æ±‚å†™å…¥æŸä¸ªé€»è¾‘åœ°å€æ—¶ï¼ŒFTL ä¼šé¿å…æ€»æ˜¯å†™å…¥åŒä¸€ä¸ªç‰©ç†å—ï¼Œè€Œæ˜¯å°†å†™å…¥è¯·æ±‚é‡å®šå‘åˆ°ä¸€ä¸ªè¾ƒå°‘è¢«ä½¿ç”¨çš„ç‰©ç†å—ä¸Šï¼Œè¿™ç§æœºåˆ¶ç±»ä¼¼äºæ“ä½œç³»ç»Ÿä¸­çš„è™šæ‹Ÿå†…å­˜ï¼Œé€šè¿‡å¼•å…¥ä¸€ä¸ªé—´æ¥å±‚ï¼ˆé€»è¾‘åœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ï¼‰æ¥éšè—åº•å±‚ç¡¬ä»¶çš„å¤æ‚æ€§å¹¶ä¼˜åŒ–å…¶ä½¿ç”¨å¯¿å‘½\nè¿™ä¹Ÿæ„å‘³ç€ï¼Œå³ä¾¿æ˜¯ä¾¿å®œçš„ U ç›˜ æˆ– SD å¡ï¼Œå…¶å†…éƒ¨ä¹Ÿå¯èƒ½åŒ…å«ä¸€ä¸ª ARM èŠ¯ç‰‡æ¥è¿è¡Œ FTLï¼Œè€Œé«˜æ€§èƒ½çš„ SSD åˆ™æ‹¥æœ‰æ›´å¼ºå¤§çš„å¤„ç†å™¨ã€ç¼“å­˜å’Œæ›´å¤æ‚çš„ FTL ç®—æ³•ï¼Œä»è€Œæä¾›æ›´é•¿çš„å¯¿å‘½å’Œæ›´é«˜çš„æ€§èƒ½\nè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸åº”è¯¥è´­ä¹°è¿‡äºå»‰ä»·çš„ U ç›˜ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½ä¼šåœ¨ FTL ä¸Šå·å·¥å‡æ–™ï¼Œç”šè‡³ä¼ªé€ å®¹é‡å’Œå‚å•†ä¿¡æ¯ï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤±\nå­˜å‚¨è®¾å¤‡ä¸æ“ä½œç³»ç»Ÿ å—è®¾å¤‡æŠ½è±¡ æ— è®ºæ˜¯æ—‹è½¬çš„ç£ç›˜è¿˜æ˜¯é—ªå­˜èŠ¯ç‰‡ï¼Œå®ƒä»¬éƒ½ä¸é€‚åˆä»¥å•ä¸ªå­—èŠ‚ä¸ºå•ä½è¿›è¡Œå¯»å€ï¼Œå› ä¸ºå®šä½å’Œå…ƒæ•°æ®ï¼ˆå¦‚æ‰‡åŒºå¤´ã€ECC æ ¡éªŒç ï¼‰çš„å¼€é”€å¤ªå¤§\nå› æ­¤ï¼Œå­˜å‚¨è®¾å¤‡å°†å®ƒä»¬çš„å­˜å‚¨ç©ºé—´åˆ’åˆ†ä¸ºå›ºå®šå¤§å°çš„å— (Block)ï¼Œå¹¶ä»¥å—ä¸ºå•ä½è¿›è¡Œè¯»å†™ï¼Œè¿™å¤§å¤§æ‘Šé”€äº†å•æ¬¡ I/O æ“ä½œçš„å¼€é”€ï¼Œè¿™äº›è®¾å¤‡åœ¨æ“ä½œç³»ç»Ÿä¸­è¢«ç§°ä¸ºå—è®¾å¤‡ (Block Devices)\næ“ä½œç³»ç»Ÿçœ‹åˆ°çš„æ˜¯ä¸€ä¸ªçº¿æ€§çš„ã€ä» 0 å¼€å§‹ç¼–å·çš„å—æ•°ç»„ struct block disk[NUM_BLOCKS]ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥åƒè¯»å†™æ–‡ä»¶ä¸€æ ·è¯»å†™å—è®¾å¤‡ï¼ˆä¾‹å¦‚ /dev/sdaï¼‰ï¼Œä½†è¿™æ ·åšçš„æ•ˆç‡å¾ˆä½ï¼Œå¦‚æœéšæœºè¯»å†™ä¸€ä¸ªå­—èŠ‚ï¼Œæ“ä½œç³»ç»Ÿå’Œè®¾å¤‡ç¡¬ä»¶æœ€ç»ˆå¯èƒ½ä¼šè¯»å–æˆ–å†™å…¥æ•´ä¸ªå—ï¼Œå¯¼è‡´è¯»/å†™æ”¾å¤§ (read/write amplification) çš„é—®é¢˜ï¼Œå› æ­¤ï¼Œä¸Šå±‚çš„æ–‡ä»¶ç³»ç»Ÿè¢«è®¾è®¡ä¸ºèƒ½å¤Ÿæ„ŸçŸ¥â€œå—â€çš„å­˜åœ¨ï¼Œå¹¶ä»¥å—ä¸ºå•ä½æ¥ç»„ç»‡å’Œç®¡ç†æ•°æ®\nä¸ºäº†é«˜æ•ˆåœ°ç®¡ç†å¯¹å—è®¾å¤‡çš„è®¿é—®ï¼Œæ“ä½œç³»ç»Ÿæä¾›äº†ä¸€ä¸ªä¸“é—¨çš„ I/O æ ˆ\nåœ¨ Linux ä¸­ï¼Œä¸Šå±‚æ–‡ä»¶ç³»ç»Ÿæˆ–åº”ç”¨ç¨‹åºé€šè¿‡å— I/O (Bio) å±‚æäº¤è¯·æ±‚ï¼ŒBio å±‚æä¾›äº†ä¸€ä¸ªè¯·æ±‚/å“åº”æ¥å£ï¼Œå®ƒå°†ä¸Šå±‚çš„è¯»å†™è¯·æ±‚å°è£…æˆ struct bio ç»“æ„ä½“ï¼Œè¿™äº›è¯·æ±‚è¢«æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾… I/O è°ƒåº¦å™¨ (I/O Scheduler) è¿›è¡Œå¤„ç†ï¼Œè°ƒåº¦å™¨ä¼šæ ¹æ®ç­–ç•¥ï¼ˆä¾‹å¦‚åˆå¹¶ç›¸é‚»çš„è¯·æ±‚ã€æ’åºè¯·æ±‚ä»¥å‡å°‘ç£å¤´å¯»é“æ—¶é—´ï¼‰æ¥ä¼˜åŒ–é˜Ÿåˆ—\nç°ä»£ Linux å†…æ ¸ä½¿ç”¨å¤šé˜Ÿåˆ—å— I/O (Multi-queue block I/O, blk-mq) æœºåˆ¶ï¼Œä¸ºæ¯ä¸ª CPU æ ¸å¿ƒ åˆ†é…ç‹¬ç«‹çš„è¯·æ±‚é˜Ÿåˆ—ï¼Œå……åˆ†åˆ©ç”¨äº†ç°ä»£å¤šæ ¸å¤„ç†å™¨å’Œé«˜é€Ÿ SSD çš„å¹¶è¡Œæ€§\næœ€ç»ˆï¼Œç”±è®¾å¤‡é©±åŠ¨ç¨‹åºå°†å¤„ç†å¥½çš„è¯·æ±‚å‘é€ç»™ç¡¬ä»¶æ‰§è¡Œ\n","permalink":"https://diefish1024.github.io/posts/nju-os-2025/21-%E5%AD%98%E5%82%A8%E8%AE%BE%E5%A4%87%E5%8E%9F%E7%90%86/","summary":"\u003cp\u003eç§‘æ™®æ€§è´¨ï¼Œç®€å•è®°å½•ä¸€ä¸‹\u003c/p\u003e\n\u003ch2 id=\"1-bit-çš„å­˜å‚¨ç£é“\"\u003e1-Bit çš„å­˜å‚¨ï¼šç£é“\u003c/h2\u003e\n\u003cp\u003eè¦å®ç°â€œæŒä¹…åŒ–â€å­˜å‚¨ï¼Œæ ¸å¿ƒæ˜¯è¦æ‰¾åˆ°ä¸€ä¸ªèƒ½åå¤æ”¹å†™çš„çŠ¶æ€ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°èƒ½å¤Ÿåˆ©ç”¨ç£çš„ç‰¹æ€§ï¼Œè¿™å°±æœ‰äº†ç£å¸¦çš„åˆæ­¥æƒ³æ³•ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eä¸€ä¸ªé•¿æ¡çš„å¸¦å­ä¸Šé¢å‡åŒ€æœ‰ç£æ€§ç‰©è´¨\u003c/li\u003e\n\u003cli\u003eå®šä½åˆ°ç‰¹å®šä½ç½®ä¹‹åé€šè¿‡æ”¾å¤§æ„Ÿåº”ç”µæµè¯»å–\u003c/li\u003e\n\u003cli\u003eç”¨ç”µç£é“æ”¹å˜ç£åŒ–æ–¹å‘æ¥å†™å…¥æ•°æ®\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä¸ºäº†æé«˜å­˜å‚¨å¯†åº¦ï¼Œå¯ä»¥æŠŠè¿™æ ·çš„å¸¦å­ç»™å·èµ·æ¥ï¼Œäºæ˜¯å°±å¾—åˆ°äº†ç£å¸¦\u003c/p\u003e\n\u003cp\u003eè¿™æ ·çš„å­˜å‚¨æ–¹å¼ä¸»è¦ç¼ºç‚¹æ˜¯\u003cstrong\u003eå‡ ä¹ä¸èƒ½éšæœºè¯»å†™\u003c/strong\u003eï¼ˆæ¯”å¦‚ç£å¸¦æ”¶éŸ³æœºéœ€è¦å€’å¸¦ï¼‰ï¼Œä¸€èˆ¬ç”¨äºå†·æ•°æ®çš„å­˜æ¡£å’Œå¤‡ä»½\u003c/p\u003e\n\u003cp\u003eä¸ºäº†è§£å†³è¿™ä¸ªç¼ºç‚¹ï¼Œå¯ä»¥æƒ³åˆ°ç”¨æ—‹è½¬çš„äºŒç»´å¹³é¢æ¥æ›¿ä»£å·èµ·æ¥çš„å¸¦å­ï¼Œè¿™æ ·è¯»å†™å»¶è¿Ÿå°±ä¸ä¼šè¶…è¿‡æ—‹è½¬çš„å‘¨æœŸï¼Œè¿™å°±å¾—åˆ°äº†\u003cstrong\u003eç£é¼“\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/images/21-%E5%AD%98%E5%82%A8%E8%AE%BE%E5%A4%87%E5%8E%9F%E7%90%86/pasted-image-20250805012735-png\"\u003e\u003c/p\u003e\n\u003cp\u003eå†åœ¨ç£é¼“çš„åŸºç¡€ä¸Šè¿›ä¸€æ­¥å†…å·ï¼ŒæŠŠç”¨åœ†ç›˜ä»£æ›¿æŸ±é¢ï¼Œä»è€Œå¯ä»¥å †å èµ·æ¥ï¼Œè¿›ä¸€æ­¥æé«˜äº†å­˜å‚¨å¯†åº¦ï¼Œè¿™å°±å¾—åˆ°äº†\u003cstrong\u003eç£ç›˜\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/images/21-%E5%AD%98%E5%82%A8%E8%AE%BE%E5%A4%87%E5%8E%9F%E7%90%86/pasted-image-20250805012958-png\"\u003e\u003c/p\u003e\n\u003cp\u003eç£ç›˜ä½œä¸ºå­˜å‚¨è®¾å¤‡çš„éšæœºè¯»å†™æ€§èƒ½è™½ç„¶ç›¸æ¯”ç£å¸¦æœ‰äº†å¾ˆå¤§çš„æ”¹å–„ï¼Œä½†æ˜¯è¿˜æ˜¯éœ€è¦ç­‰å¾…å®šä½åˆ°æ­£ç¡®çš„ä½ç½®ï¼Œæ€§èƒ½ä»ç„¶ä¸å¤Ÿä¼˜ç§€ï¼Œä¸ºäº†è¯»å†™å®šä½åˆ°ä¸€ä¸ªæ‰‡åŒºé€šå¸¸éœ€è¦èŠ±è´¹å‡ ä¸ªæ¯«ç§’çš„æ—¶é—´ï¼Œè¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ç¼“å­˜å’Œè°ƒåº¦ç®—æ³•æ¥ç¼“è§£ï¼Œè®©æ•°æ®å°½å¯èƒ½è¿ç»­å­˜å‚¨\u003c/p\u003e\n\u003cp\u003eå½“æˆ‘ä»¬åœ¨ç£ç›˜çš„åŸºç¡€ä¸ŠæŠŠè¯»å†™å¤´å’Œç›˜ç‰‡æœ¬ä½“åˆ†å¼€ï¼Œæˆ‘ä»¬å°±å®ç°äº†æ•°æ®çš„ç§»åŠ¨ï¼Œè¿™ä¹Ÿå°±å¾—åˆ°äº†\u003cstrong\u003eè½¯ç›˜\u003c/strong\u003eï¼Œè¿™æ˜¯ä¸Šä¸ªæ•°æ®æ•°æ®å‘è¡Œçš„ä¸»è¦æ–¹å¼ï¼Œè™½ç„¶æ€§èƒ½å’Œå¯é æ€§éƒ½æ¯”è¾ƒä½ï¼Œä½†æ˜¯èƒœåœ¨äº†ä¾¿æ·ã€å¯ç§»åŠ¨\u003c/p\u003e\n\u003ch2 id=\"1-bit-çš„å­˜å‚¨æŒ–å‘\"\u003e1-Bit çš„å­˜å‚¨ï¼šæŒ–å‘\u003c/h2\u003e\n\u003cp\u003eå¤äººå®ç°æŒä¹…åŒ–å­˜å‚¨çš„æ–¹å¼æ˜¯åœ¨çŸ³å¤´ä¸Šåˆ»å­—ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡æŒ–å‘æ¥å­˜å‚¨ä¿¡æ¯ï¼Œè¿™ç§æ–¹å¼å¯ä»¥è·¨è¶Šéå¸¸é•¿çš„æ—¶é—´\u003c/p\u003e\n\u003cp\u003eè€Œç°ä»£å·¥ä¸šä½¿æˆ‘ä»¬å¯ä»¥æŒ–å‡ºæ›´åŠ ç²¾ç»†çš„å‘ï¼Œä»è€Œå¯ä»¥å­˜å‚¨æ›´é«˜å¯†åº¦çš„ä¿¡æ¯\u003c/p\u003e\n\u003cp\u003eä¸ºäº†è¯»å–è¿™æ ·çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ä»å…‰å­¦çš„è§’åº¦è€ƒè™‘ï¼šåœ¨åå°„å¹³é¢ä¸ŠæŒ–ç²—ç³™å‘ï¼Œæ¿€å…‰æ‰«è¿‡è¡¨é¢ï¼Œåœ¨å¹³é¢ä¼šåå°„å›æ¥ï¼Œåœ¨å‘é‡Œä¼šå‘ç”Ÿæ¼«åå°„ï¼Œäºæ˜¯æˆ‘ä»¬åªè¦æ£€æµ‹æ˜¯å¦æ”¶åˆ°åå°„å…‰å°±å¯ä»¥è¯†åˆ«æ˜¯å‘è¿˜æ˜¯è¡¨é¢ï¼Œè¿™ä¹Ÿå°±æ˜¯\u003cstrong\u003eå…‰ç›˜\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå…‰ç›˜æœ€æœ‰è¶£çš„ç‰¹æ€§æ˜¯å®¹æ˜“å¤åˆ¶ï¼Œæˆ‘ä»¬è¦åˆ¶é€ å…‰ç›˜å¯ä»¥å…ˆä»”ç»†åœ°åˆ¶é€ ä¸€å¼ åè½¬çš„ç›˜ç‰‡ï¼Œå‘çš„ä½ç½®å¯¹åº”å…¶è¡¨é¢çš„çªèµ·ï¼Œä¹‹ååªéœ€è¦ç›´æ¥ç”¨è¿™ä¸ªç›˜ç‰‡å‹åˆ¶åŠ çƒ­çš„å¡‘æ–™å†é•€ä¸Šåå°„è†œå°±å¯ä»¥å¾—åˆ°ä¸€å¼ å…‰ç›˜ï¼Œè¿™ç§æ–¹å¼å¯ä»¥è¾¾åˆ°æé«˜çš„å†™å…¥é€Ÿåº¦\u003c/p\u003e\n\u003cp\u003eå½“ç„¶è¿™ç§æŒ–å‘æ–¹å¼çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§å°±æ˜¯ä¸èƒ½ä¿®æ”¹å·²ç»å†™å…¥çš„å†…å®¹çš„ï¼Œå¾ˆéš¾å¡«ä¸Šä¸€ä¸ªå·²ç»æŒ–äº†çš„å‘ï¼ˆå½“ç„¶é€šè¿‡ç‰¹æ®Šçš„åˆ¶é€ ææ–™å’Œå·¥è‰ºä¹Ÿæ˜¯å¯ä»¥åšåˆ°çš„ï¼‰ï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´é‡Œé¢å­˜å‚¨çš„æ•°æ®æ˜¯ append only çš„ï¼Œæƒ³è¦ä¿®æ”¹ä¹‹å‰çš„å†…å®¹å¯ä»¥é‡‡ç”¨å¯æŒä¹…åŒ–äºŒå‰æ ‘çš„ç»“æ„\u003c/p\u003e\n\u003cp\u003eå…‰ç›˜ä½œä¸ºå­˜å‚¨è®¾å¤‡ï¼Œä»·æ ¼ä½çš„åŒæ—¶å®¹é‡å’Œå¯é æ€§éƒ½æ¯”è¾ƒé«˜ï¼ŒåŒæ—¶é¡ºåºè¯»æ€§èƒ½ä¸€èˆ¬ï¼Œéšæœºè¯»æ€§èƒ½ä½å¹¶ä¸”å¾ˆéš¾å†™å…¥ï¼Œä¸€ä¸ªé‡è¦çš„åº”ç”¨å¸¸è§å°±æ˜¯æ•°å­—æ—¶ä»£çš„å†…å®¹åˆ†å‘\u003c/p\u003e\n\u003cp\u003eç°ä»£è¿™ç§æŒ–å‘çš„å­˜å‚¨æ–¹å¼è¿˜æœ‰ä¸€ç§åº”ç”¨æ–¹å¼æ˜¯å›å½’å¤äººçŸ³ç¢‘çš„å½¢å¼ï¼ŒæŠŠä¿¡æ¯åˆ»åœ¨å¾ˆç¨³å®šçš„ææ–™ä¸Šæ¥åšåˆ°æ°¸ä¹…å­˜å‚¨\u003c/p\u003e\n\u003ch2 id=\"1-bit-çš„å­˜å‚¨ç”µè·\"\u003e1-Bit çš„å­˜å‚¨ï¼šç”µè·\u003c/h2\u003e\n\u003cp\u003eå‰ä¸¤ç§å­˜å‚¨ä»‹è´¨éƒ½å­˜åœ¨æ¯”è¾ƒå¤§çš„ç¼ºé™·ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eç£ï¼šä¾èµ–æœºæ¢°éƒ¨ä»¶ï¼Œä»è€Œæ— æ³•é¿å… ms çº§åˆ«çš„å»¶è¿Ÿ\u003c/li\u003e\n\u003cli\u003eå‘ï¼ˆå…‰ï¼‰ï¼šæŒ–å‘æ•ˆç‡ä½ï¼ŒåŒæ—¶å¡«å‘å¾ˆå›°éš¾\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè€Œç”µè·åˆ™æ˜¯ä¸€ç§éå¸¸ç†æƒ³çš„å­˜å‚¨ä»‹è´¨ï¼šç”µå­çš„å¯†åº¦æé«˜ï¼Œå¹¶ä¸”ç”µè·¯çš„é€Ÿåº¦æå¿«ï¼ˆè¿˜å¤©ç„¶å¹¶è¡Œï¼‰\u003c/p\u003e\n\u003cp\u003eåœ¨ç”µè·¯ä¸­å®ç° 1-bit çš„æŒä¹…å­˜å‚¨ï¼Œä¸€ä¸ªæƒ³æ³•æ˜¯æˆ‘ä»¬å¯ä»¥æŒ–ä¸€ä¸ªå‘ï¼Œä¸¤ç§çŠ¶æ€åˆ†åˆ«æ˜¯ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåœ¨å‘é‡Œå¡«å…¥ç”µå­\u003c/li\u003e\n\u003cli\u003eä»å‘é‡Œæ”¾è·‘ç”µå­\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè€Œè¿™å°±å¾—åˆ°äº†\u003cstrong\u003eé—ªå­˜ (Flash Memory)\u003c/strong\u003e ï¼š\n\u003cimg loading=\"lazy\" src=\"/images/21-%E5%AD%98%E5%82%A8%E8%AE%BE%E5%A4%87%E5%8E%9F%E7%90%86/pasted-image-20250805112704-png\"\u003e\nå…¶ä½œä¸ºå­˜å‚¨è®¾å¤‡ï¼Œä»·æ ¼ä½ï¼Œå®¹é‡å’Œå¯é æ€§é«˜ï¼Œè€Œä¸”è¯»å†™æ€§èƒ½æé«˜ï¼ˆç”±äºç”µè·¯å¤©ç„¶å¹¶è¡Œï¼Œæ‰€ä»¥å®¹é‡è¶Šå¤§ï¼Œé€Ÿåº¦è¶Šå¿«ï¼‰\u003c/p\u003e\n\u003cp\u003eç„¶è€Œï¼Œé—ªå­˜çš„ç‰©ç†åŸç†ä¹Ÿå¸¦æ¥äº†å…¶å›ºæœ‰çš„ç¼ºé™·ï¼Œå³\u003cstrong\u003eä¼šç£¨æŸ (wear out)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ¯æ¬¡æ”¾ç”µ (erase) æ“ä½œéƒ½æ— æ³• 100% å°†ç”µå­æ”¾å¹²å‡€ï¼Œè¿™ä¼šå¯¹å­˜å‚¨å•å…ƒé€ æˆå¾®å°çš„ã€ä¸å¯é€†çš„æŸä¼¤\u003c/li\u003e\n\u003cli\u003eåœ¨ç»å†æ•°åƒæˆ–æ•°ä¸‡æ¬¡æ“¦å†™å¾ªç¯åï¼Œä¸€äº›å­˜å‚¨å•å…ƒä¼šå› ä¸ºç´¯ç§¯çš„æŸä¼¤è€Œå¤±æ•ˆï¼Œæ— æ³•å†å¯é åœ°å­˜å‚¨æ•°æ®ï¼Œè¿™è¢«ç§°ä¸º â€œ\u003cstrong\u003eæ­»å•å…ƒ (Dead Cell)\u003c/strong\u003eâ€\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä¸ºäº†è§£å†³é—ªå­˜çš„ç£¨æŸé—®é¢˜ï¼Œå¹¶å°†å…¶æ›´å¥½åœ°å‘ˆç°ç»™æ“ä½œç³»ç»Ÿï¼Œç°ä»£å›ºæ€å­˜å‚¨è®¾å¤‡ï¼ˆå¦‚ SSDã€U ç›˜ã€SD å¡ï¼‰å†…éƒ¨å®é™…ä¸Šéƒ½é›†æˆäº†ä¸€ä¸ªå¾®å‹è®¡ç®—æœºç³»ç»Ÿ\u003c/p\u003e\n\u003cp\u003eè¿™ä¸ªç³»ç»Ÿè¿è¡Œç€ä¸€å±‚è¢«ç§°ä¸º \u003cstrong\u003eFTL (Flash Translation Layer)\u003c/strong\u003e çš„å›ºä»¶ï¼Œå®ƒçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€æ˜¯ \u003cstrong\u003eç£¨æŸå‡è¡¡ (Wear Leveling)\u003c/strong\u003e\u003c/p\u003e","title":"21. å­˜å‚¨è®¾å¤‡åŸç†"},{"content":"ç›®å½•æ ‘ æ–‡ä»¶çš„æŠ½è±¡ æ“ä½œç³»ç»Ÿå°†ç‰©ç†å­˜å‚¨è®¾å¤‡ï¼ˆå¦‚ç£ç›˜ï¼‰çš„å¤æ‚æ€§éšè—èµ·æ¥ï¼Œæä¾›äº†ä¸€ä¸ªç®€å•ã€ç»Ÿä¸€çš„æŠ½è±¡â€”â€”æ–‡ä»¶\næ–‡ä»¶å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ç£ç›˜ï¼Œå³ä¸€ä¸ªå‘½åçš„ã€ä¸€ç»´çš„å­—èŠ‚åºåˆ—ï¼Œæ”¯æŒ read, write, lseek ç­‰æ“ä½œ\nè¿™ç§æŠ½è±¡ä½¿å¾—ä¸Šå±‚åº”ç”¨æ— éœ€å…³å¿ƒæ•°æ®åœ¨ç‰©ç†ç£ç›˜ä¸Šçš„å…·ä½“ä½ç½®å’Œå­˜å‚¨æ–¹å¼\nç›®å½•çš„å¼•å…¥ å½“æ–‡ä»¶æ•°é‡å¢å¤šæ—¶ï¼Œéœ€è¦ä¸€ç§æ–¹å¼æ¥ç»„ç»‡å’Œç®¡ç†å®ƒä»¬\næ“ä½œç³»ç»Ÿå¼•å…¥äº†ç›®å½• (Directory) çš„æ¦‚å¿µï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå…¶å†…å®¹æ˜¯å…¶ä»–æ–‡ä»¶æˆ–ç›®å½•çš„åˆ—è¡¨\né€šè¿‡å°†æ–‡ä»¶å’Œç›®å½•ç»„ç»‡æˆä¸€ä¸ªå±‚æ¬¡åŒ–çš„æ ‘çŠ¶ç»“æ„ï¼Œå³ç›®å½•æ ‘ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å¯¹æ–‡ä»¶è¿›è¡Œåˆ†ç±»ã€æŸ¥æ‰¾å’Œç®¡ç†\nå¤šæ•°ç±» Unix ç³»ç»Ÿéµå¾ª FHS (Filesystem Hierarchy Standard) çš„ç›®å½•ç»“æ„çº¦å®šï¼Œä¸ºè½¯ä»¶å’Œç”¨æˆ·é¢„æµ‹æ–‡ä»¶ä½ç½®æä¾›äº†ä¾¿åˆ©\nç›®å½•æ“ä½œ API æ“ä½œç³»ç»Ÿæä¾›äº†ä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨æ¥æ“ä½œç›®å½•æ ‘ï¼Œæ ¸å¿ƒæ“ä½œå›´ç»•â€œå¢åˆ æ”¹æŸ¥â€\nmkdir: åˆ›å»ºä¸€ä¸ªæ–°çš„ç›®å½• rmdir: åˆ é™¤ä¸€ä¸ªç©ºçš„ç›®å½• getdents: è¯»å–ç›®å½•ä¸­çš„æ¡ç›® (directory entries) link / unlink: åˆ›å»ºæˆ–åˆ é™¤æ–‡ä»¶çš„é“¾æ¥ é“¾æ¥ é“¾æ¥æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œå®ƒå…è®¸ä¸€ä¸ªæ–‡ä»¶æ‹¥æœ‰å¤šä¸ªåå­—æˆ–å­˜åœ¨äºç›®å½•æ ‘çš„å¤šä¸ªä½ç½®\né“¾æ¥ä¸»è¦åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šç¡¬é“¾æ¥å’Œè½¯é“¾æ¥ï¼ˆç¬¦å·é“¾æ¥ï¼‰\nç¡¬é“¾æ¥ Hard Link å®šä¹‰ï¼šç¡¬é“¾æ¥æ˜¯è®©å¤šä¸ªç›®å½•æ¡ç›®ï¼ˆæ–‡ä»¶åï¼‰ç›´æ¥æŒ‡å‘ç£ç›˜ä¸ŠåŒä¸€ä¸ªæ–‡ä»¶ç´¢å¼•èŠ‚ç‚¹ (inode)\næ¯ä¸ªæ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ inodeï¼Œå®ƒåŒ…å«äº†æ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆå¦‚æƒé™ã€å¤§å°ã€æ•°æ®å—ä½ç½®ç­‰ï¼‰å’Œæ•°æ®æœ¬èº«\nåˆ›å»ºä¸€ä¸ªç¡¬é“¾æ¥ï¼Œç›¸å½“äºä¸ºåŒä¸€ä¸ª inode å¢åŠ äº†ä¸€ä¸ªæ–°çš„å…¥å£ç‚¹ï¼ˆæ–‡ä»¶åï¼‰\nç‰¹æ€§ï¼š\næ‰€æœ‰æŒ‡å‘åŒä¸€ä¸ª inode çš„ç¡¬é“¾æ¥åœ°ä½å¹³ç­‰ï¼Œæ²¡æœ‰ä¸»æ¬¡ä¹‹åˆ† inode å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªé“¾æ¥è®¡æ•° (reference count), åªæœ‰å½“è¿™ä¸ªè®¡æ•°å‡åˆ° 0 æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿæ‰ä¼šçœŸæ­£åˆ é™¤è¯¥ inode å’Œå¯¹åº”çš„æ•°æ®å—ï¼Œè¿™ä¹Ÿæ˜¯ unlink ç³»ç»Ÿè°ƒç”¨çš„ç”±æ¥ é™åˆ¶ï¼š\nä¸èƒ½ä¸ºç›®å½•åˆ›å»ºç¡¬é“¾æ¥ï¼Œä»¥é˜²æ­¢åœ¨ç›®å½•æ ‘ä¸­äº§ç”Ÿå¾ªç¯ ä¸èƒ½è·¨è¶Šä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå› ä¸º inode å·åªåœ¨å½“å‰æ–‡ä»¶ç³»ç»Ÿå†…å”¯ä¸€ï¼‰ è½¯é“¾æ¥ Symbolic Link å®šä¹‰ï¼šè½¯é“¾æ¥ï¼Œä¹Ÿç§°ç¬¦å·é“¾æ¥ (symlink)ï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå®ƒçš„å†…å®¹æ˜¯å¦ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„è·¯å¾„\nè½¯é“¾æ¥æœ¬èº«æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ inode å’Œæ•°æ®å—ï¼Œå…¶æ•°æ®å—ä¸­å­˜å‚¨çš„æ˜¯ä¸€ä¸ªæ–‡æœ¬å­—ç¬¦ä¸²ï¼Œå³ç›®æ ‡å¯¹è±¡çš„è·¯å¾„åï¼Œå½“è®¿é—®è½¯é“¾æ¥æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šè§£æå…¶å†…å®¹ï¼Œå¹¶å°†è®¿é—®è¯·æ±‚é‡å®šå‘åˆ°å®ƒæ‰€æŒ‡å‘çš„è·¯å¾„\nç‰¹æ€§ï¼š\næå…¶çµæ´»ï¼Œå› ä¸ºå®ƒæœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªè·¯å¾„çš„â€œå¿«æ·æ–¹å¼â€ å¯ä»¥é“¾æ¥åˆ°ç›®å½• å¯ä»¥è·¨è¶Šä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿ å¯ä»¥åˆ›å»ºä¸€ä¸ªâ€œæ‚¬ç©ºâ€çš„é“¾æ¥ (dangling link)ï¼Œå³å®ƒæŒ‡å‘çš„ç›®æ ‡è·¯å¾„å½“å‰å¹¶ä¸å­˜åœ¨ åˆ é™¤è½¯é“¾æ¥æœ¬èº«ï¼Œå¯¹å®ƒæŒ‡å‘çš„åŸå§‹æ–‡ä»¶æ²¡æœ‰ä»»ä½•å½±å“ åº”ç”¨:\nå¸¸ç”¨äºç®¡ç†è½¯ä»¶ç‰ˆæœ¬ï¼Œä¾‹å¦‚è®©ä¸€ä¸ªé€šç”¨çš„å‘½ä»¤ï¼ˆå¦‚ pythonï¼‰æŒ‡å‘ä¸€ä¸ªå…·ä½“çš„ç‰ˆæœ¬æ–‡ä»¶ï¼ˆå¦‚ /usr/bin/python3.9ï¼‰ è¢« NixOS ç­‰ç³»ç»Ÿç”¨æ¥æ„å»ºé«˜åº¦å¯å¤ç°å’Œéš”ç¦»çš„ç¯å¢ƒï¼Œé€šè¿‡å¤§é‡ä½¿ç”¨è½¯é“¾æ¥å°†ä¸åŒç‰ˆæœ¬çš„è½¯ä»¶åŒ…ç»„åˆæˆä¸€ä¸ªè™šæ‹Ÿçš„æ–‡ä»¶ç³»ç»Ÿç»“æ„ æ–‡ä»¶çš„å…ƒæ•°æ® åŸºæœ¬å…ƒæ•°æ® æ–‡ä»¶ä½œä¸ºæ“ä½œç³»ç»Ÿä¸­çš„å¯¹è±¡ï¼Œæ‹¥æœ‰ä¸€ç³»åˆ—çš„å±æ€§ (attributes)ï¼Œè¿™äº›å±æ€§å°±æ˜¯å…ƒæ•°æ® (metadata), ä½ å¯ä»¥é€šè¿‡ ls -l å‘½ä»¤æŸ¥çœ‹æ–‡ä»¶çš„ä¸»è¦å…ƒæ•°æ®ï¼Œè¿™åŒ…æ‹¬æ–‡ä»¶çš„ç±»å‹ã€æ‰€æœ‰è€…ã€å¤§å°ã€ä¿®æ”¹æ—¶é—´ç­‰å…³é”®ä¿¡æ¯\nå…¶ä¸­ï¼Œæ¨¡å¼ (Mode) å­—æ®µå®šä¹‰äº†æ–‡ä»¶çš„è®¿é—®æƒé™ï¼Œå®ƒåˆ†ä¸ºä¸‰ç»„ï¼Œåˆ†åˆ«å¯¹åº”æ‰€æœ‰è€… (owner)ã€æ‰€å±ç»„ (group) å’Œå…¶ä»–ç”¨æˆ· (other)ï¼Œæ¯ç»„éƒ½åŒ…å«è¯» (r)ã€å†™ (w)ã€æ‰§è¡Œ (x) ä¸‰ç§æƒé™\nä¸€ä¸ªå¸¸è§çš„æƒé™ä¾‹å­æ˜¯ 755ï¼Œè¿™æ˜¯ä¸€ä¸ªå…«è¿›åˆ¶æ•°ï¼Œå¸¸ç”¨äºç¨‹åºæˆ–ç›®å½•\nç¬¬ä¸€ä¸ª 7 ä»£è¡¨æ‰€æœ‰è€…æƒé™, 7=4+2+1, æ„å‘³ç€è¯»ã€å†™ã€æ‰§è¡Œ (rwx) æƒé™å…¨å¼€ ç¬¬äºŒä¸ª 5 ä»£è¡¨æ‰€å±ç»„æƒé™, 5=4+0+1, æ„å‘³ç€è¯»ã€æ‰§è¡Œ (r-x) æƒé™ ç¬¬ä¸‰ä¸ª 5 ä»£è¡¨å…¶ä»–ç”¨æˆ·æƒé™, 5=4+0+1, åŒæ ·æ˜¯è¯»ã€æ‰§è¡Œ (r-x) æƒé™ Extended Attributes (xattr) æ‰©å±•å±æ€§ xattr æ˜¯ç°ä»£æ–‡ä»¶ç³»ç»Ÿæä¾›çš„ä¸€é¡¹å¼ºå¤§åŠŸèƒ½ï¼Œå®ƒå…è®¸ä¸ºæ–‡ä»¶é™„åŠ ä¸€ä¸ªçµæ´»çš„ key-value é”®å€¼å¯¹å­—å…¸ï¼Œç”¨äºå­˜å‚¨æ ‡å‡†å…ƒæ•°æ®æ— æ³•è¦†ç›–çš„ä»»æ„ä¿¡æ¯ï¼Œæ“ä½œç³»ç»Ÿæä¾›äº† fsetxattr å’Œ fgetxattr ç­‰ç³»ç»Ÿè°ƒç”¨æ¥æ“ä½œè¿™äº›å±æ€§\nåº”ç”¨ï¼š\nmacOS çš„å®‰å…¨éš”ç¦»æœºåˆ¶å°±æ˜¯ä¸€ä¸ªå…¸å‹ä¾‹å­ï¼Œå½“ä»ç½‘ç»œä¸‹è½½æ–‡ä»¶åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ  com.apple.quarantine å±æ€§ï¼Œè®°å½•ä¸‹è½½æ¥æºï¼ˆURLï¼‰å’Œæ—¶é—´ï¼Œé¦–æ¬¡æ‰“å¼€æ—¶ï¼Œç³»ç»Ÿä¼šæ£€æŸ¥æ­¤å±æ€§å¹¶å‘ç”¨æˆ·å‘å‡ºå®‰å…¨è­¦å‘Š\næ–‡ä»¶å†…å®¹å…ƒä¿¡æ¯: åº”ç”¨ç¨‹åºå¯ä»¥åˆ©ç”¨ xattr å­˜å‚¨ä¸æ–‡ä»¶å†…å®¹ç›¸å…³çš„å…ƒä¿¡æ¯ï¼Œä¾‹å¦‚ï¼Œå›¾ç‰‡æµè§ˆå™¨å¯ä»¥å­˜å‚¨ç…§ç‰‡çš„ EXIF æ•°æ®å‰¯æœ¬ï¼Œæˆ–è€…éŸ³ä¹æ’­æ”¾å™¨å¯ä»¥å­˜å‚¨æ­Œæ›²çš„æ¼”å”±è€…å’Œä¸“è¾‘ä¿¡æ¯ï¼Œä¾¿äºç®¡ç†å’Œæœç´¢ï¼›ç›¸æ¯”äºæ–‡ä»¶ç›®å½•åªèƒ½æŒ‰ç…§æ–‡ä»¶æ ‡é¢˜ç´¢å¼•ï¼Œè¿™ç§ä»¥å†…å®¹ä½œä¸ºç´¢å¼•æ‰æ˜¯ç°ä»£æ–‡ä»¶ç³»ç»Ÿæ›´åˆç†çš„åšæ³•\nç¼ºé™·ï¼šè™½ç„¶ xattr åŠŸèƒ½å¼ºå¤§ï¼Œä½†å®ƒâ€œå¥½ç”¨ä¸ç«â€çš„åŸå› åœ¨äºå…¶å›ºæœ‰çš„ç¼ºé™·\nç¼ºä¹æ ‡å‡†åŒ–ä¸å…¼å®¹æ€§: xattr çš„é”®åæ²¡æœ‰ç»Ÿä¸€æ ‡å‡†ï¼Œä¸åŒåº”ç”¨å’Œç³»ç»Ÿé—´éšæ„å®šä¹‰ï¼Œå¯¼è‡´æ•°æ®éš¾ä»¥äº’é€šï¼Œä¾‹å¦‚ï¼Œcom.apple.quarantine å±æ€§åœ¨ Linux æˆ– Windows ä¸Šæ²¡æœ‰æ„ä¹‰ å·¥å…·æ”¯æŒä¸å®Œå–„: è®¸å¤šç»å…¸çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå¦‚ cp, mv, tar, rsync ç­‰ï¼Œé»˜è®¤ä¸ä¼šå¤„ç†æ‰©å±•å±æ€§ï¼Œåœ¨æ‰§è¡Œæ–‡ä»¶å¤åˆ¶æˆ–æ‰“åŒ…æ—¶ï¼Œè¿™äº›é‡è¦çš„å…ƒæ•°æ®å¯èƒ½ä¼šè¢«é™é»˜ä¸¢å¼ƒï¼Œç”¨æˆ·å¿…é¡»æ˜¾å¼ä½¿ç”¨ç‰¹å®šå‚æ•°ï¼ˆå¦‚ cp --preserve=xattr, rsync -Xï¼‰æ‰èƒ½ä¿ç•™å®ƒä»¬ï¼Œè¿™å¯¹ä¾èµ– xattr çš„ç³»ç»Ÿï¼ˆå¦‚ä½¿ç”¨äº† SELinuxï¼‰å¯èƒ½æ˜¯ç¾éš¾æ€§çš„ å¯è§æ€§ä½: æ‰©å±•å±æ€§å¯¹äºæ™®é€šç”¨æˆ·æ˜¯ä¸å¯è§çš„ï¼Œls -l å‘½ä»¤å¹¶ä¸ä¼šæ˜¾ç¤ºå®ƒä»¬ï¼Œéœ€è¦ä½¿ç”¨ getfattr æˆ– xattr -l ç­‰ä¸“ç”¨å·¥å…·æ‰èƒ½æŸ¥çœ‹ï¼Œè¿™ä½¿å¾—é—®é¢˜æ’æŸ¥å˜å¾—æ›´åŠ å›°éš¾ Access Control List (ACL) ä¼ ç»Ÿçš„ user/group/other æƒé™æ¨¡å‹åœ¨å¤„ç†å¤æ‚çš„å…±äº«éœ€æ±‚æ—¶æ˜¾å¾—åŠ›ä¸ä»å¿ƒï¼Œä¾‹å¦‚éœ€è¦è®©ç”¨æˆ· bob è®¿é—® alice çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œä½† bob ä¸åœ¨ alice çš„ç”¨æˆ·ç»„é‡Œï¼Œè€Œåˆä¸æƒ³æŠŠæ–‡ä»¶æƒé™å¼€æ”¾ç»™æ‰€æœ‰â€œå…¶ä»–ç”¨æˆ·â€ï¼ŒACL å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç±»é—®é¢˜è€Œç”Ÿçš„\nACL æä¾›äº†æ¯”ä¼ ç»Ÿæ¨¡å‹æ›´ç²¾ç»†ã€æ›´çµæ´»çš„è®¿é—®æ§åˆ¶æœºåˆ¶ï¼Œå®ƒå…è®¸ä½ ä¸ºä»»æ„æŒ‡å®šçš„ç”¨æˆ·æˆ–ç”¨æˆ·ç»„è®¾ç½®ç‹¬ç«‹çš„æƒé™\næ–‡ä»¶ç³»ç»Ÿçº§ API ä¸é’ˆå¯¹å•ä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„æ“ä½œä¸åŒï¼Œæ–‡ä»¶ç³»ç»Ÿè¿˜æä¾›äº†ä¸€ç³»åˆ—â€œç³»ç»Ÿçº§â€çš„ APIï¼Œç”¨äºç®¡ç†æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„å’Œè¡Œä¸º\næŒ‚è½½ Mount åœ¨ç±» Unix ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰çš„æ–‡ä»¶å’Œç›®å½•éƒ½ç»„ç»‡åœ¨ä¸€æ£µä»¥æ ¹ç›®å½• / ä¸ºèµ·ç‚¹çš„å·¨å¤§ç›®å½•æ ‘ä¸‹ï¼Œè€Œåœ¨ Windows ä¸­ï¼Œæ–‡ä»¶ç³»ç»Ÿåˆ™åˆ†æ•£åœ¨ä¸åŒçš„â€œç›˜ç¬¦â€ä¸‹ï¼ˆC:ã€D: ç­‰ï¼‰\næŒ‚è½½ (mount) æ˜¯æ„å»ºè¿™æ£µç»Ÿä¸€ç›®å½•æ ‘çš„æ ¸å¿ƒæœºåˆ¶, å®ƒçš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼ˆé€šå¸¸æ¥è‡ªä¸€ä¸ªç‹¬ç«‹çš„å­˜å‚¨è®¾å¤‡ï¼Œå¦‚ç¡¬ç›˜åˆ†åŒºã€U ç›˜æˆ–å…‰ç›˜ï¼‰â€œé™„åŠ â€åˆ°ç°æœ‰ç›®å½•æ ‘çš„ä¸€ä¸ªæŒ‚è½½ç‚¹ (mount point) ä¸Š, æŒ‚è½½ç‚¹æ˜¯ä¸€ä¸ªå·²å­˜åœ¨çš„ç©ºç›®å½•\nä¾‹å¦‚ï¼Œå‘½ä»¤ mount /dev/sdb1 /mnt/data å°±å°† /dev/sdb1 è¿™ä¸ªåˆ†åŒºä¸Šçš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°äº† /mnt/data ç›®å½•, æ­¤åï¼Œå¯¹ /mnt/data ç›®å½•å†…å®¹çš„è®¿é—®ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹ /dev/sdb1 åˆ†åŒºæ ¹ç›®å½•çš„è®¿é—®, æ•´ä¸ª Linux ç³»ç»Ÿçš„æ ¹ç›®å½• / æœ¬èº«ä¹Ÿæ˜¯åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶æŒ‚è½½çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ\nå›ç¯è®¾å¤‡ Loopback Device mount å‘½ä»¤é€šå¸¸æ“ä½œçš„æ˜¯å—è®¾å¤‡ (block device)ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬éœ€è¦æŒ‚è½½ä¸€ä¸ªå­˜åœ¨äºæ–‡ä»¶ä¸­çš„æ–‡ä»¶ç³»ç»Ÿé•œåƒï¼ˆä¾‹å¦‚ä¸€ä¸ª .iso å…‰ç›˜é•œåƒæ–‡ä»¶ï¼‰, æ–‡ä»¶ä¸æ˜¯å—è®¾å¤‡ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥æŒ‚è½½\nä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒLinux æä¾›äº†å›ç¯è®¾å¤‡ (loopback device), è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„å—è®¾å¤‡ï¼Œå®ƒä¸å¯¹åº”ä»»ä½•ç‰©ç†ç¡¬ä»¶ï¼Œè€Œæ˜¯å°†ä¸€ä¸ªæ™®é€šæ–‡ä»¶ä½œä¸ºå…¶åç«¯å­˜å‚¨\nå®ƒçš„å·¥ä½œæµç¨‹å¯ä»¥æƒ³è±¡æˆä¸€ä¸ªé€‚é…å™¨ï¼š\nå°†æ–‡ä»¶é•œåƒä¸ä¸€ä¸ªå›ç¯è®¾å¤‡ï¼ˆå¦‚ /dev/loop0ï¼‰å…³è”èµ·æ¥, è¿™æ—¶ï¼Œæ“ä½œç³»ç»Ÿçœ‹å¾… /dev/loop0 å°±åƒçœ‹å¾…ä¸€ä¸ªçœŸå®çš„ç‰©ç†ç£ç›˜ä¸€æ · å¯¹è¿™ä¸ªå›ç¯è®¾å¤‡æ‰§è¡Œ mount æ“ä½œï¼Œå°†å…¶æŒ‚è½½åˆ°æŒ‡å®šç›®å½• è¿™ä¸ªè¿‡ç¨‹çš„åº•å±‚æ˜¯é€šè¿‡ ioctl ç³»ç»Ÿè°ƒç”¨å®ç°çš„ï¼Œå®ƒå‘ loop é©±åŠ¨å‘é€ LOOP_SET_FD ç­‰å‘½ä»¤ï¼Œå°†æ–‡ä»¶æè¿°ç¬¦ä¸ä¸€ä¸ªç©ºé—²çš„ loop è®¾å¤‡è¿›è¡Œç»‘å®š\nè”åˆæ–‡ä»¶ç³»ç»Ÿ OverlayFS OverlayFS æ˜¯ä¸€ç§å¼ºå¤§çš„è”åˆæ–‡ä»¶ç³»ç»Ÿ (UnionFS)ï¼Œå®ƒå…è®¸å°†å¤šä¸ªä¸åŒçš„ç›®å½•ï¼ˆç§°ä¸ºå±‚ï¼‰â€œå †å â€èµ·æ¥ï¼Œå¯¹å¤–æä¾›ä¸€ä¸ªç»Ÿä¸€çš„ã€åˆå¹¶åçš„è§†å›¾\næˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªéå¸¸å½¢è±¡çš„æ¯”å–»æ¥ç†è§£å®ƒçš„å·¥ä½œåŸç†ï¼š\nåº•å±‚ (lowerdir): æƒ³è±¡ä¸€å¼ å·²ç»å°åˆ·å¥½çš„ã€ä¸å¯ä¿®æ”¹çš„åŸå§‹ç”»ç¨¿, è¿™å°±æ˜¯åªè¯»çš„åº•å±‚, å®ƒå¯ä»¥æœ‰å¾ˆå¤šå¼ ï¼Œå±‚å±‚å æ”¾ ä¸Šå±‚ (upperdir)ï¼šåœ¨åŸå§‹ç”»ç¨¿ä¸Šè¦†ç›–ä¸€å¼ é€æ˜çš„å¡‘æ–™è–„è†œ, è¿™å°±æ˜¯å¯å†™çš„ä¸Šå±‚ åˆå¹¶è§†å›¾ (merged view)ï¼šä½ é€è¿‡è¿™å¼ é€æ˜è–„è†œçœ‹åˆ°çš„æœ€ç»ˆæ™¯è±¡ï¼Œå°±æ˜¯ OverlayFS å‘ˆç°ç»™ä½ çš„ç›®å½• åŸºäºè¿™ä¸ªæ¨¡å‹ï¼Œæ‰€æœ‰æ“ä½œéƒ½å˜å¾—éå¸¸ç›´è§‚ï¼š\nè¯»å–æ–‡ä»¶: å½“ä½ è¯»å–ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œç›¸å½“äºé€è¿‡é€æ˜è–„è†œçœ‹ç”»ç¨¿, å¦‚æœæ–‡ä»¶åªå­˜åœ¨äºåº•å±‚ï¼Œä½ ä¼šç›´æ¥çœ‹åˆ°å®ƒ, å¦‚æœæ–‡ä»¶åœ¨ä¸Šå±‚ä¹Ÿå­˜åœ¨ï¼Œé‚£ä¹ˆä¸Šå±‚çš„ç‰ˆæœ¬ä¼šâ€œé®ç›–â€ä½åº•å±‚çš„ç‰ˆæœ¬\nä¿®æ”¹æ–‡ä»¶ï¼šä½ ä¸èƒ½ç›´æ¥ä¿®æ”¹åŸå§‹ç”»ç¨¿ï¼ˆlowerdirï¼‰ï¼Œå½“ä½ ç¬¬ä¸€æ¬¡å°è¯•ä¿®æ”¹ä¸€ä¸ªæ¥è‡ªåº•å±‚çš„æ–‡ä»¶æ—¶ï¼Œç³»ç»Ÿä¼šå¯åŠ¨å†™æ—¶å¤åˆ¶ (Copy-on-Write) æœºåˆ¶ï¼Œå…ˆæŠŠè¿™ä¸ªæ–‡ä»¶ä»åº•å±‚å¤åˆ¶ä¸€ä»½åˆ°ä¸Šå±‚çš„é€æ˜è–„è†œä¸Šï¼Œç„¶åä½ æ‰€æœ‰çš„ä¿®æ”¹éƒ½å‘ç”Ÿåœ¨è¿™ä»½å¤åˆ¶å“ä¸Š\nåˆ›å»ºæ–‡ä»¶ï¼šè¿™å°±åƒç›´æ¥åœ¨é€æ˜è–„è†œä¸Šç”»æ–°çš„å†…å®¹ï¼Œå®Œå…¨ä¸å½±å“ä¸‹é¢çš„åŸå§‹ç”»ç¨¿\nåˆ é™¤æ–‡ä»¶ï¼šä½ æ— æ³•æ“¦é™¤åŸå§‹ç”»ç¨¿çš„å†…å®¹, å½“ä½ åˆ é™¤ä¸€ä¸ªæ¥è‡ªåº•å±‚çš„æ–‡ä»¶æ—¶ï¼Œç³»ç»Ÿä¼šåœ¨ä¸Šå±‚åˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„â€œç™½ç‚¹â€æ–‡ä»¶ (whiteout)ï¼Œåƒè´´äº†ä¸€å¼ ä¸é€æ˜çš„å°è´´çº¸ï¼Œåˆšå¥½é®ä½åº•å±‚çš„æ–‡ä»¶ï¼Œè®©å®ƒçœ‹èµ·æ¥åƒæ˜¯è¢«åˆ é™¤äº†\nè¿™ç§åˆ†å±‚å’Œå†™æ—¶å¤åˆ¶çš„æœºåˆ¶æ˜¯ Docker ç­‰å®¹å™¨æŠ€æœ¯çš„æ ¸å¿ƒ, å®¹å™¨é•œåƒå°±æ˜¯åªè¯»çš„ lowerdirï¼Œè€Œæ¯ä¸ªè¿è¡Œçš„å®¹å™¨éƒ½æœ‰è‡ªå·±ä¸“å±çš„å¯å†™ upperdirï¼Œè¿™ä½¿å¾—æˆç™¾ä¸Šåƒä¸ªå®¹å™¨å¯ä»¥å…±äº«åŒä¸€ä¸ªåŸºç¡€é•œåƒï¼ŒåŒæ—¶ä¿æŒå„è‡ªçš„éš”ç¦»æ€§ï¼Œæå¤§åœ°èŠ‚çœäº†å­˜å‚¨ç©ºé—´å’Œéƒ¨ç½²æ—¶é—´\næ–‡ä»¶ç³»ç»Ÿå¿«ç…§ Snapshot ä¸€äº›é«˜çº§çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ Btrfs, ZFSï¼‰æˆ–é€»è¾‘å·ç®¡ç†å™¨ï¼ˆLVMï¼‰æ”¯æŒå¿«ç…§ (snapshot) åŠŸèƒ½ï¼Œå®ƒå¯ä»¥åœ¨ç¬é—´â€œå†»ç»“â€å¹¶åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿåœ¨æŸä¸ªæ—¶é—´ç‚¹çš„å®Œæ•´å‰¯æœ¬\nå¿«ç…§çš„å®ç°ä¹Ÿå¸¸å¸¸ä¾èµ–äºå†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼Œåˆ›å»ºå¿«ç…§æ—¶ï¼Œå¹¶ä¸ä¼šç«‹å³å¤åˆ¶æ‰€æœ‰æ•°æ®ï¼Œè€Œåªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘å½“å‰æ•°æ®å—çš„æŒ‡é’ˆé›†åˆ, å½“ä¹‹åæœ‰æ•°æ®å—è¢«ä¿®æ”¹æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿä¸ä¼šè¦†ç›–æ—§çš„æ•°æ®å—ï¼Œè€Œæ˜¯å°†ä¿®æ”¹å†™å…¥æ–°çš„ä½ç½®ï¼Œå¹¶è®©æ—§çš„å¿«ç…§æŒ‡é’ˆç»§ç»­æŒ‡å‘æœªä¿®æ”¹çš„æ—§æ•°æ®å—\nè¿™ä¸ªåŠŸèƒ½å¯¹äºç³»ç»Ÿå¤‡ä»½ã€å¿«é€Ÿå›æ»šå’Œåˆ›å»ºå®‰å…¨çš„æµ‹è¯•ç¯å¢ƒéå¸¸æœ‰ç”¨\n","permalink":"https://diefish1024.github.io/posts/nju-os-2025/22-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F-api/","summary":"\u003ch2 id=\"ç›®å½•æ ‘\"\u003eç›®å½•æ ‘\u003c/h2\u003e\n\u003ch3 id=\"æ–‡ä»¶çš„æŠ½è±¡\"\u003eæ–‡ä»¶çš„æŠ½è±¡\u003c/h3\u003e\n\u003cp\u003eæ“ä½œç³»ç»Ÿå°†ç‰©ç†å­˜å‚¨è®¾å¤‡ï¼ˆå¦‚ç£ç›˜ï¼‰çš„å¤æ‚æ€§éšè—èµ·æ¥ï¼Œæä¾›äº†ä¸€ä¸ªç®€å•ã€ç»Ÿä¸€çš„æŠ½è±¡â€”â€”\u003cstrong\u003eæ–‡ä»¶\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæ–‡ä»¶å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ª\u003cstrong\u003eè™šæ‹Ÿçš„ç£ç›˜\u003c/strong\u003eï¼Œå³ä¸€ä¸ªå‘½åçš„ã€ä¸€ç»´çš„\u003cstrong\u003eå­—èŠ‚åºåˆ—\u003c/strong\u003eï¼Œæ”¯æŒ \u003ccode\u003eread\u003c/code\u003e, \u003ccode\u003ewrite\u003c/code\u003e, \u003ccode\u003elseek\u003c/code\u003e ç­‰æ“ä½œ\u003c/p\u003e\n\u003cp\u003eè¿™ç§æŠ½è±¡ä½¿å¾—ä¸Šå±‚åº”ç”¨æ— éœ€å…³å¿ƒæ•°æ®åœ¨ç‰©ç†ç£ç›˜ä¸Šçš„å…·ä½“ä½ç½®å’Œå­˜å‚¨æ–¹å¼\u003c/p\u003e\n\u003ch3 id=\"ç›®å½•çš„å¼•å…¥\"\u003eç›®å½•çš„å¼•å…¥\u003c/h3\u003e\n\u003cp\u003eå½“æ–‡ä»¶æ•°é‡å¢å¤šæ—¶ï¼Œéœ€è¦ä¸€ç§æ–¹å¼æ¥ç»„ç»‡å’Œç®¡ç†å®ƒä»¬\u003c/p\u003e\n\u003cp\u003eæ“ä½œç³»ç»Ÿå¼•å…¥äº†\u003cstrong\u003eç›®å½• (Directory)\u003c/strong\u003e çš„æ¦‚å¿µï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå…¶å†…å®¹æ˜¯å…¶ä»–æ–‡ä»¶æˆ–ç›®å½•çš„åˆ—è¡¨\u003c/p\u003e\n\u003cp\u003eé€šè¿‡å°†æ–‡ä»¶å’Œç›®å½•ç»„ç»‡æˆä¸€ä¸ªå±‚æ¬¡åŒ–çš„\u003cstrong\u003eæ ‘çŠ¶ç»“æ„\u003c/strong\u003eï¼Œå³\u003cstrong\u003eç›®å½•æ ‘\u003c/strong\u003eï¼Œå¯ä»¥æ–¹ä¾¿åœ°å¯¹æ–‡ä»¶è¿›è¡Œåˆ†ç±»ã€æŸ¥æ‰¾å’Œç®¡ç†\u003c/p\u003e\n\u003cp\u003eå¤šæ•°ç±» Unix ç³»ç»Ÿéµå¾ª \u003cstrong\u003eFHS (Filesystem Hierarchy Standard)\u003c/strong\u003e çš„ç›®å½•ç»“æ„çº¦å®šï¼Œä¸ºè½¯ä»¶å’Œç”¨æˆ·é¢„æµ‹æ–‡ä»¶ä½ç½®æä¾›äº†ä¾¿åˆ©\u003c/p\u003e\n\u003ch3 id=\"ç›®å½•æ“ä½œ-api\"\u003eç›®å½•æ“ä½œ API\u003c/h3\u003e\n\u003cp\u003eæ“ä½œç³»ç»Ÿæä¾›äº†ä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨æ¥æ“ä½œç›®å½•æ ‘ï¼Œæ ¸å¿ƒæ“ä½œå›´ç»•â€œå¢åˆ æ”¹æŸ¥â€\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003emkdir\u003c/code\u003e: åˆ›å»ºä¸€ä¸ªæ–°çš„ç›®å½•\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ermdir\u003c/code\u003e: åˆ é™¤ä¸€ä¸ªç©ºçš„ç›®å½•\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egetdents\u003c/code\u003e: è¯»å–ç›®å½•ä¸­çš„æ¡ç›® (\u003cstrong\u003ed\u003c/strong\u003eirectory \u003cstrong\u003eent\u003c/strong\u003erie\u003cstrong\u003es\u003c/strong\u003e)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003elink\u003c/code\u003e / \u003ccode\u003eunlink\u003c/code\u003e: åˆ›å»ºæˆ–åˆ é™¤æ–‡ä»¶çš„é“¾æ¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"é“¾æ¥\"\u003eé“¾æ¥\u003c/h3\u003e\n\u003cp\u003eé“¾æ¥æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œå®ƒå…è®¸ä¸€ä¸ªæ–‡ä»¶æ‹¥æœ‰å¤šä¸ªåå­—æˆ–å­˜åœ¨äºç›®å½•æ ‘çš„å¤šä¸ªä½ç½®\u003c/p\u003e\n\u003cp\u003eé“¾æ¥ä¸»è¦åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š\u003cstrong\u003eç¡¬é“¾æ¥\u003c/strong\u003eå’Œ\u003cstrong\u003eè½¯é“¾æ¥ï¼ˆç¬¦å·é“¾æ¥ï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003ch4 id=\"ç¡¬é“¾æ¥-hard-link\"\u003eç¡¬é“¾æ¥ Hard Link\u003c/h4\u003e\n\u003cp\u003e\u003cstrong\u003eå®šä¹‰\u003c/strong\u003eï¼š\u003cstrong\u003eç¡¬é“¾æ¥\u003c/strong\u003eæ˜¯è®©å¤šä¸ªç›®å½•æ¡ç›®ï¼ˆæ–‡ä»¶åï¼‰ç›´æ¥æŒ‡å‘ç£ç›˜ä¸ŠåŒä¸€ä¸ª\u003cstrong\u003eæ–‡ä»¶ç´¢å¼•èŠ‚ç‚¹ (inode)\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæ¯ä¸ªæ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ \u003ccode\u003einode\u003c/code\u003eï¼Œå®ƒåŒ…å«äº†æ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆå¦‚æƒé™ã€å¤§å°ã€æ•°æ®å—ä½ç½®ç­‰ï¼‰å’Œæ•°æ®æœ¬èº«\u003c/p\u003e\n\u003cp\u003eåˆ›å»ºä¸€ä¸ªç¡¬é“¾æ¥ï¼Œç›¸å½“äºä¸ºåŒä¸€ä¸ª \u003ccode\u003einode\u003c/code\u003e å¢åŠ äº†ä¸€ä¸ªæ–°çš„å…¥å£ç‚¹ï¼ˆæ–‡ä»¶åï¼‰\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eç‰¹æ€§\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ‰€æœ‰æŒ‡å‘åŒä¸€ä¸ª \u003ccode\u003einode\u003c/code\u003e çš„ç¡¬é“¾æ¥åœ°ä½å¹³ç­‰ï¼Œæ²¡æœ‰ä¸»æ¬¡ä¹‹åˆ†\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003einode\u003c/code\u003e å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª\u003cstrong\u003eé“¾æ¥è®¡æ•° (reference count)\u003c/strong\u003e, åªæœ‰å½“è¿™ä¸ªè®¡æ•°å‡åˆ° 0 æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿæ‰ä¼šçœŸæ­£åˆ é™¤è¯¥ \u003ccode\u003einode\u003c/code\u003e å’Œå¯¹åº”çš„æ•°æ®å—ï¼Œè¿™ä¹Ÿæ˜¯ \u003ccode\u003eunlink\u003c/code\u003e ç³»ç»Ÿè°ƒç”¨çš„ç”±æ¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eé™åˆ¶\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eä¸èƒ½ä¸ºç›®å½•åˆ›å»ºç¡¬é“¾æ¥ï¼Œä»¥é˜²æ­¢åœ¨ç›®å½•æ ‘ä¸­äº§ç”Ÿå¾ªç¯\u003c/li\u003e\n\u003cli\u003eä¸èƒ½è·¨è¶Šä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå› ä¸º \u003ccode\u003einode\u003c/code\u003e å·åªåœ¨å½“å‰æ–‡ä»¶ç³»ç»Ÿå†…å”¯ä¸€ï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"è½¯é“¾æ¥-symbolic-link\"\u003eè½¯é“¾æ¥ Symbolic Link\u003c/h4\u003e\n\u003cp\u003e\u003cstrong\u003eå®šä¹‰\u003c/strong\u003eï¼š\u003cstrong\u003eè½¯é“¾æ¥\u003c/strong\u003eï¼Œä¹Ÿç§°\u003cstrong\u003eç¬¦å·é“¾æ¥ (symlink)\u003c/strong\u003eï¼Œæ˜¯ä¸€ä¸ª\u003cstrong\u003eç‰¹æ®Šçš„æ–‡ä»¶\u003c/strong\u003eï¼Œå®ƒçš„å†…å®¹æ˜¯å¦ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„\u003cstrong\u003eè·¯å¾„\u003c/strong\u003e\u003c/p\u003e","title":"22. æ–‡ä»¶ç³»ç»Ÿ API"},{"content":"A General Paradigm of Test-Time Adaptation æ ¹æ®æµ‹è¯•æ•°æ®æ¥æ”¶æ–¹å¼å’Œé€‚åº”è¿‡ç¨‹ï¼ŒTTA åˆ†ä¸ºä¸‰ç§ä¸»è¦èŒƒå¼ï¼š\nTest-Time Batch Adaptation (TTBA) æµ‹è¯•æ—¶é—´æ‰¹æ¬¡é€‚åº”ï¼š æ•°æ®ä»¥å°æ‰¹æ¬¡å½¢å¼åˆ°è¾¾ã€‚æ¨¡å‹ä¼šé’ˆå¯¹æ¯ä¸ªåˆ°æ¥çš„å°æ‰¹æ¬¡è¿›è¡Œé€‚åº”ï¼Œå¹¶ç«‹å³æä¾›é¢„æµ‹ã€‚ Online Test-Time Adaptation (OTTA) åœ¨çº¿æµ‹è¯•æ—¶é—´é€‚åº”ï¼š æ•°æ®ä»¥åºåˆ—åŒ–çš„æ–¹å¼ï¼ˆå°æ‰¹æ¬¡ï¼‰åˆ°è¾¾ã€‚æ¨¡å‹è¿›è¡Œå¢é‡æ›´æ–°ï¼Œå¹¶ä¸”è¿‡å»çš„é€‚åº”ç»éªŒä¼šå½±å“æœªæ¥çš„é¢„æµ‹ã€‚ Test-Time Domain Adaptation (TTDA) æµ‹è¯•æ—¶é—´åŸŸé€‚åº”ï¼š æ•´ä¸ªç›®æ ‡åŸŸçš„æ•°æ®ï¼ˆæ‰€æœ‰æµ‹è¯•æ•°æ®ï¼‰å¯åœ¨é¢„æµ‹å‰ä¸€æ¬¡æ€§ç”¨äºé€‚åº”ã€‚ Datasets for Evaluation è®ºæ–‡ä½¿ç”¨äº†ä¸¤ç§ä¸åŒç±»å‹çš„åˆ†å¸ƒåç§»æ•°æ®é›†è¿›è¡Œè¯„ä¼°ï¼š\nCorruption Datasets æŸåæ•°æ®é›†ï¼š åŸå§‹æ•°æ®é›†ï¼ˆCIFAR-10ï¼ŒImageNetï¼‰ç»è¿‡äººä¸ºæŸåå¤„ç†åå¾—åˆ°çš„ï¼Œé€šè¿‡æ·»åŠ ä¸åŒç±»å‹çš„å™ªå£°ã€æ¨¡ç³Šç­‰ï¼Œæ¨¡æ‹Ÿä¸åŒä¸¥é‡ç¨‹åº¦çš„åˆ†å¸ƒåç§»ã€‚ Natural-shift Datasets è‡ªç„¶åç§»æ•°æ®é›†ï¼š è¿™äº›æ•°æ®é›†ä»£è¡¨æ•°æ®åˆ†å¸ƒä¸­è‡ªç„¶å‘ç”Ÿçš„å˜åŒ–ï¼Œæ”¶é›†è‡ªä¸åŒçš„çœŸå®ä¸–ç•Œæ¥æºæˆ–æ¡ä»¶ï¼ˆOffice-Homeï¼ŒDomainNetï¼Œå…¶ä¸­å›¾åƒå¯èƒ½æ˜¯ä¸åŒé£æ ¼çš„è‰ºæœ¯ä½œå“ã€å‰ªè´´ç”»ã€çœŸå®ä¸–ç•Œç…§ç‰‡æˆ–è‰å›¾ï¼‰ã€‚ Results on Natural Shift Datasets TTA æ–¹æ³•åœ¨è‡ªç„¶åç§»æ•°æ®é›†ä¸Šçš„è¡¨ç°ä¸åœ¨æŸåæ•°æ®é›†ä¸Šçš„è¡¨ç°æœ‰æ‰€ä¸åŒã€‚ PredBN åœ¨æŸåæ•°æ®é›†ä¸Šæœ‰æ•ˆï¼Œä½†åœ¨è‡ªç„¶åç§»æ•°æ®é›†ä¸Šè¡¨ç°ä¸ä½³ï¼Œæœ‰æ—¶ç”šè‡³æ¯”æºæ¨¡å‹æ›´å·®ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºè‡ªç„¶åç§»å¯¹æ•°æ®åˆ†å¸ƒçš„å½±å“ä¸äººå·¥æŸåä¸åŒã€‚ T3A åœ¨ OTTA èŒƒå¼ä¸‹çš„è‡ªç„¶åç§»æ•°æ®é›†ä¸Šè¡¨ç°ä¼˜äºå…¶ä»– OTTA ç®—æ³•ã€‚è¿™å½’å› äºå…¶ç‰¹å¾ç”Ÿæˆæ–¹å¼åŠå…¶åˆ†ç±»å™¨ä¼˜åŒ–èƒ½åŠ›ã€‚ å¯¹äºè‡ªç„¶åç§»æ•°æ®é›†ï¼ŒTTDA ç®—æ³• æŒç»­å–å¾—äº†æœ€é«˜çš„æ€§èƒ½ã€‚ä¸€äº› OTTA æ–¹æ³•çš„å¤šè½®æ¬¡ä¹Ÿèƒ½è¾¾åˆ°å¯æ¯”çš„æˆæœã€‚ ","permalink":"https://diefish1024.github.io/posts/literature-notes/benchmarking-tta/","summary":"\u003ch3 id=\"a-general-paradigm-of-test-time-adaptation\"\u003eA General Paradigm of Test-Time Adaptation\u003c/h3\u003e\n\u003cp\u003eæ ¹æ®æµ‹è¯•æ•°æ®æ¥æ”¶æ–¹å¼å’Œé€‚åº”è¿‡ç¨‹ï¼ŒTTA åˆ†ä¸ºä¸‰ç§ä¸»è¦èŒƒå¼ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eTest-Time Batch Adaptation (TTBA) æµ‹è¯•æ—¶é—´æ‰¹æ¬¡é€‚åº”ï¼š\u003c/strong\u003e æ•°æ®ä»¥å°æ‰¹æ¬¡å½¢å¼åˆ°è¾¾ã€‚æ¨¡å‹ä¼šé’ˆå¯¹æ¯ä¸ªåˆ°æ¥çš„å°æ‰¹æ¬¡è¿›è¡Œé€‚åº”ï¼Œå¹¶ç«‹å³æä¾›é¢„æµ‹ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eOnline Test-Time Adaptation (OTTA) åœ¨çº¿æµ‹è¯•æ—¶é—´é€‚åº”ï¼š\u003c/strong\u003e æ•°æ®ä»¥åºåˆ—åŒ–çš„æ–¹å¼ï¼ˆå°æ‰¹æ¬¡ï¼‰åˆ°è¾¾ã€‚æ¨¡å‹è¿›è¡Œå¢é‡æ›´æ–°ï¼Œå¹¶ä¸”è¿‡å»çš„é€‚åº”ç»éªŒä¼šå½±å“æœªæ¥çš„é¢„æµ‹ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eTest-Time Domain Adaptation (TTDA) æµ‹è¯•æ—¶é—´åŸŸé€‚åº”ï¼š\u003c/strong\u003e æ•´ä¸ªç›®æ ‡åŸŸçš„æ•°æ®ï¼ˆæ‰€æœ‰æµ‹è¯•æ•°æ®ï¼‰å¯åœ¨é¢„æµ‹å‰ä¸€æ¬¡æ€§ç”¨äºé€‚åº”ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"datasets-for-evaluation\"\u003eDatasets for Evaluation\u003c/h3\u003e\n\u003cp\u003eè®ºæ–‡ä½¿ç”¨äº†ä¸¤ç§ä¸åŒç±»å‹çš„åˆ†å¸ƒåç§»æ•°æ®é›†è¿›è¡Œè¯„ä¼°ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eCorruption Datasets æŸåæ•°æ®é›†ï¼š\u003c/strong\u003e åŸå§‹æ•°æ®é›†ï¼ˆCIFAR-10ï¼ŒImageNetï¼‰ç»è¿‡\u003cstrong\u003eäººä¸ºæŸåå¤„ç†\u003c/strong\u003eåå¾—åˆ°çš„ï¼Œé€šè¿‡æ·»åŠ ä¸åŒç±»å‹çš„å™ªå£°ã€æ¨¡ç³Šç­‰ï¼Œæ¨¡æ‹Ÿä¸åŒä¸¥é‡ç¨‹åº¦çš„åˆ†å¸ƒåç§»ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eNatural-shift Datasets è‡ªç„¶åç§»æ•°æ®é›†ï¼š\u003c/strong\u003e è¿™äº›æ•°æ®é›†ä»£è¡¨æ•°æ®åˆ†å¸ƒä¸­\u003cstrong\u003eè‡ªç„¶å‘ç”Ÿçš„å˜åŒ–\u003c/strong\u003eï¼Œæ”¶é›†è‡ªä¸åŒçš„çœŸå®ä¸–ç•Œæ¥æºæˆ–æ¡ä»¶ï¼ˆOffice-Homeï¼ŒDomainNetï¼Œå…¶ä¸­å›¾åƒå¯èƒ½æ˜¯ä¸åŒé£æ ¼çš„è‰ºæœ¯ä½œå“ã€å‰ªè´´ç”»ã€çœŸå®ä¸–ç•Œç…§ç‰‡æˆ–è‰å›¾ï¼‰ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"results-on-natural-shift-datasets\"\u003eResults on Natural Shift Datasets\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eTTA æ–¹æ³•åœ¨è‡ªç„¶åç§»æ•°æ®é›†ä¸Šçš„è¡¨ç°ä¸åœ¨æŸåæ•°æ®é›†ä¸Šçš„è¡¨ç°æœ‰æ‰€ä¸åŒã€‚\u003c/li\u003e\n\u003cli\u003ePredBN åœ¨æŸåæ•°æ®é›†ä¸Šæœ‰æ•ˆï¼Œä½†åœ¨è‡ªç„¶åç§»æ•°æ®é›†ä¸Šè¡¨ç°ä¸ä½³ï¼Œæœ‰æ—¶ç”šè‡³æ¯”æºæ¨¡å‹æ›´å·®ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºè‡ªç„¶åç§»å¯¹æ•°æ®åˆ†å¸ƒçš„å½±å“ä¸äººå·¥æŸåä¸åŒã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eT3A\u003c/strong\u003e åœ¨ OTTA èŒƒå¼ä¸‹çš„è‡ªç„¶åç§»æ•°æ®é›†ä¸Šè¡¨ç°ä¼˜äºå…¶ä»– OTTA ç®—æ³•ã€‚è¿™å½’å› äºå…¶ç‰¹å¾ç”Ÿæˆæ–¹å¼åŠå…¶åˆ†ç±»å™¨ä¼˜åŒ–èƒ½åŠ›ã€‚\u003c/li\u003e\n\u003cli\u003eå¯¹äºè‡ªç„¶åç§»æ•°æ®é›†ï¼Œ\u003cstrong\u003eTTDA ç®—æ³•\u003c/strong\u003e æŒç»­å–å¾—äº†æœ€é«˜çš„æ€§èƒ½ã€‚ä¸€äº› OTTA æ–¹æ³•çš„å¤šè½®æ¬¡ä¹Ÿèƒ½è¾¾åˆ°å¯æ¯”çš„æˆæœã€‚\u003c/li\u003e\n\u003c/ul\u003e","title":"Benchmarking TTA"},{"content":"Setting Continual Test-Time Domain Adaptation æ˜¯ä¸€ç§æ›´å…·æŒ‘æˆ˜æ€§çš„æ¨¡å‹é€‚åº”è®¾å®šã€‚åœ¨æ­¤è®¾å®šä¸‹ï¼Œä¸€ä¸ªåœ¨æºæ•°æ®ä¸Šé¢„è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œåœ¨æµ‹è¯•æ—¶ä¼šé‡åˆ°ä¸€ä¸ªéå¹³ç¨³ä¸”æŒç»­å˜åŒ–çš„ç›®æ ‡ç¯å¢ƒ ã€‚\nCoTTA ä¸ä»¥ä¸‹æ–¹æ³•ä¸åŒï¼š\nStandard Domain Adaptationï¼šéœ€è¦åŒæ—¶è®¿é—®æºæ•°æ®å’Œï¼ˆé™æ€çš„ï¼‰ç›®æ ‡æ•°æ®è¿›è¡Œè®­ç»ƒã€‚ Standard Test-Time Adaptation / Fully Test-Time Adaptationï¼šé€šå¸¸å‡è®¾ç›®æ ‡åŸŸæ˜¯å›ºå®šçš„æˆ–é™æ€çš„ï¼Œè€Œ CoTTA å…³æ³¨çš„æ˜¯æŒç»­å˜åŒ–çš„ç›®æ ‡åŸŸã€‚ Test-Time Training (TTT)ï¼šéœ€è¦ä¿®æ”¹æºæ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ä»¥åŠ å…¥è¾…åŠ©ä»»åŠ¡ï¼Œå› æ­¤æ— æ³•ä½¿ç”¨ä»»æ„çš„â€œå¼€ç®±å³ç”¨â€é¢„è®­ç»ƒæ¨¡å‹ã€‚ ç›¸æ¯”ä¹‹ä¸‹ï¼ŒCoTTA ä¸“é—¨è§£å†³åœ¨æ— æºæ•°æ®çš„æ¡ä»¶ä¸‹ï¼Œæ¨¡å‹å¦‚ä½•åœ¨çº¿é€‚åº”ä¸€ä¸ªæŒç»­å˜åŒ–çš„æ•°æ®æµï¼ŒåŒæ—¶å…‹æœç°æœ‰æ–¹æ³•ä¸­å¸¸è§çš„é”™è¯¯ç´¯ç§¯å’Œç¾éš¾æ€§é—å¿˜é—®é¢˜ã€‚\nMethod è®ºæ–‡çš„æ ¸å¿ƒè´¡çŒ®æ˜¯æå‡ºäº†CoTTA (Continual Test-Time Adaptation) æ–¹æ³•ï¼Œæ—¨åœ¨é€šè¿‡å‡å°‘é”™è¯¯ç´¯ç§¯å’Œé¿å…ç¾éš¾æ€§é—å¿˜ï¼Œå®ç°æ¨¡å‹åœ¨éå¹³ç¨³ç¯å¢ƒä¸‹çš„é•¿æœŸç¨³å®šé€‚åº”ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªå…³é”®éƒ¨åˆ†ã€‚\n1. å‡å°‘é”™è¯¯ç´¯ç§¯ (Reducing Error Accumulation) ä¸ºäº†ç”Ÿæˆæ›´å¯é çš„è‡ªè®­ç»ƒä¿¡å·ï¼ŒCoTTA é‡‡ç”¨äº†å¹³å‡åŒ–çš„ä¼ªæ ‡ç­¾ç­–ç•¥ï¼Œè¯¥ç­–ç•¥ç»“åˆäº†æƒé‡å¹³å‡å’Œæ•°æ®å¢å¼ºå¹³å‡ã€‚\næƒé‡å¹³å‡ä¼ªæ ‡ç­¾ (Weight-Averaged Pseudo-Labels) è¯¥æ–¹æ³•é‡‡ç”¨ä¸€ä¸ªæ•™å¸ˆ - å­¦ç”Ÿ (teacher-student) æ¡†æ¶ã€‚å­¦ç”Ÿæ¨¡å‹ (student model) åœ¨çº¿è¿›è¡Œå­¦ä¹ å’Œæ›´æ–°ã€‚ æ•™å¸ˆæ¨¡å‹ (teacher model) çš„æƒé‡æ˜¯å­¦ç”Ÿæ¨¡å‹æƒé‡çš„æŒ‡æ•°ç§»åŠ¨å¹³å‡ (Exponential Moving Average, EMA)ã€‚ ç”±äºæ•™å¸ˆæ¨¡å‹çš„æ›´æ–°æ›´å¹³æ»‘ï¼Œå…¶é¢„æµ‹ç»“æœé€šå¸¸æ¯”å­¦ç”Ÿæ¨¡å‹æ›´å‡†ç¡®ï¼Œå› æ­¤ç”¨å®ƒæ¥ç”Ÿæˆä¼ªæ ‡ç­¾ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘é”™è¯¯ç´¯ç§¯ã€‚å­¦ç”Ÿæ¨¡å‹é€šè¿‡æœ€å°åŒ–ä¸æ•™å¸ˆä¼ªæ ‡ç­¾çš„ä¸€è‡´æ€§æŸå¤± (consistency loss) æ¥è¿›è¡Œæ›´æ–°ã€‚ æ•°æ®å¢å¼ºå¹³å‡ä¼ªæ ‡ç­¾ (Augmentation-Averaged Pseudo-Labels) ä¸ºäº†è¿›ä¸€æ­¥æå‡ä¼ªæ ‡ç­¾åœ¨é‡åˆ°è¾ƒå¤§åŸŸåç§»æ—¶çš„è´¨é‡ï¼ŒCoTTA ä¼šæœ‰æ¡ä»¶åœ°ä½¿ç”¨æ•°æ®å¢å¼ºã€‚ å®ƒé¦–å…ˆä½¿ç”¨åŸå§‹é¢„è®­ç»ƒæ¨¡å‹è¯„ä¼°å½“å‰æµ‹è¯•æ•°æ®çš„é¢„æµ‹ç½®ä¿¡åº¦ï¼Œä»¥æ­¤æ¥è¿‘ä¼¼åŸŸå·®å¼‚çš„å¤§å°ã€‚ æ¡ä»¶æ€§åº”ç”¨ï¼š å¦‚æœç½®ä¿¡åº¦é«˜ï¼ˆåŸŸå·®å¼‚å°ï¼‰ï¼Œåˆ™ç›´æ¥ä½¿ç”¨æ•™å¸ˆæ¨¡å‹çš„é¢„æµ‹ä½œä¸ºä¼ªæ ‡ç­¾ 16ã€‚ å¦‚æœç½®ä¿¡åº¦ä½ï¼ˆåŸŸå·®å¼‚å¤§ï¼‰ï¼Œåˆ™å¯¹è¾“å…¥æ•°æ®è¿›è¡Œ N æ¬¡éšæœºå¢å¼ºï¼Œå¹¶å°†æ•™å¸ˆæ¨¡å‹å¯¹è¿™äº›å¢å¼ºæ ·æœ¬çš„å¹³å‡é¢„æµ‹ç»“æœä½œä¸ºä¼ªæ ‡ç­¾ 17171717ã€‚è¿™å¯ä»¥è¿›ä¸€æ­¥æé«˜ä¼ªæ ‡ç­¾çš„é²æ£’æ€§ã€‚ 2. é¿å…ç¾éš¾æ€§é—å¿˜ (Avoiding Catastrophic Forgetting) ä¸ºäº†åœ¨é•¿æœŸé€‚åº”è¿‡ç¨‹ä¸­ä¿ç•™ä»æºåŸŸå­¦åˆ°çš„çŸ¥è¯†ï¼ŒCoTTA å¼•å…¥äº†éšæœºæ¢å¤ (Stochastic Restoration) æœºåˆ¶ã€‚\næ ¸å¿ƒæ€æƒ³ï¼šåœ¨æ¯æ¬¡æ¨¡å‹æ›´æ–°åï¼Œä»¥ä¸€ä¸ªå¾ˆå°çš„æ¦‚ç‡ pï¼Œå°†æ¨¡å‹ä¸­çš„ä¸€å°éƒ¨åˆ†æƒé‡å‚æ•°éšæœºåœ°æ¢å¤åˆ°å…¶åŸå§‹çš„ã€é¢„è®­ç»ƒæ—¶çš„çŠ¶æ€ã€‚ ä¼˜åŠ¿ï¼š è¿™ç§æœºåˆ¶å¯ä»¥çœ‹ä½œä¸€ç§ç‰¹æ®Šçš„ Dropout 20ã€‚å®ƒèƒ½æœ‰æ•ˆé˜²æ­¢æ¨¡å‹åœ¨é€‚åº”æ–°æ•°æ®æ—¶â€œæ¼‚ç§»â€å¾—ç¦»æºæ¨¡å‹å¤ªè¿œï¼Œä»è€Œæ˜¾å¼åœ°ä¿ç•™äº†æºçŸ¥è¯†ï¼Œé¿å…äº†ç¾éš¾æ€§é—å¿˜ã€‚ é€šè¿‡ä¿ç•™æºçŸ¥è¯†ï¼ŒCoTTA èƒ½å¤Ÿå®‰å…¨åœ°æ›´æ–°ç½‘ç»œä¸­çš„æ‰€æœ‰å‚æ•°ï¼Œè€Œä¸ä»…ä»…æ˜¯å½’ä¸€åŒ–å±‚ï¼Œè¿™ä¸ºæ¨¡å‹é€‚åº”æä¾›äº†æ›´å¤§çš„å®¹é‡ã€‚ Algorithm CoTTA ç®—æ³•çš„åœ¨çº¿æµç¨‹å¦‚ä¸‹ï¼š\nInitialization (åˆå§‹åŒ–)ï¼š åŠ è½½ä¸€ä¸ªâ€œå¼€ç®±å³ç”¨â€çš„é¢„è®­ç»ƒæºæ¨¡å‹ $ f_{\\theta_{0}} $ ç”¨æºæ¨¡å‹æƒé‡åˆå§‹åŒ–æ•™å¸ˆæ¨¡å‹ $ f_{\\theta'_{0}} $ Iteration (è¿­ä»£)ï¼šå¯¹äºåœ¨çº¿è¾“å…¥çš„æ¯ä¸ªæµ‹è¯•æ•°æ® $ x_{t} $â€‹ï¼š ç”Ÿæˆä¼ªæ ‡ç­¾ï¼šä½¿ç”¨æ•™å¸ˆæ¨¡å‹ $ f_{\\theta'_{t}} $â€‹â€‹ï¼Œå¹¶ç»“åˆæ¡ä»¶æ€§æ•°æ®å¢å¼ºï¼Œç”Ÿæˆæƒé‡å’Œå¢å¼ºå¹³å‡çš„ä¼ªæ ‡ç­¾ã€‚ æ›´æ–°å­¦ç”Ÿæ¨¡å‹ï¼šé€šè¿‡ä¸€è‡´æ€§æŸå¤±æ›´æ–°å­¦ç”Ÿæ¨¡å‹ $ f_{\\theta_{t}} $ æ›´æ–°æ•™å¸ˆæ¨¡å‹ï¼šä½¿ç”¨ EMA æ›´æ–°æ•™å¸ˆæ¨¡å‹çš„æƒé‡ $ f_{\\theta'_{t+1}} $ éšæœºæ¢å¤ï¼šå¯¹å­¦ç”Ÿæ¨¡å‹çš„æƒé‡è¿›è¡Œéšæœºæ¢å¤ Output (è¾“å‡º)ï¼šä½¿ç”¨æ•™å¸ˆæ¨¡å‹ $ f_{\\theta'_{t}} $â€‹â€‹ è¿›è¡Œåœ¨çº¿é¢„æµ‹ï¼Œå¹¶ä¼ é€’æ›´æ–°åçš„å­¦ç”Ÿå’Œæ•™å¸ˆæ¨¡å‹åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´æ­¥ã€‚ Experiments è®ºæ–‡åœ¨å¤šä¸ªå›¾åƒåˆ†ç±»å’Œè¯­ä¹‰åˆ†å‰²ä»»åŠ¡ä¸Šå¯¹ CoTTA è¿›è¡Œäº†è¯„ä¼°ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸€ä¸ªæŒç»­å˜åŒ–çš„æµ‹è¯•ç¯å¢ƒä¸­ã€‚\nContinual Adaptation on Corrupted Images åœ¨ CIFAR10-Cã€CIFAR100-C å’Œ ImageNet-C æ•°æ®é›†ä¸Šï¼Œæ¨¡å‹è¢«é¡ºåºè¾“å…¥ 15 ç§ä¸åŒç±»å‹çš„æŸåå›¾åƒã€‚\nä¸»è¦å‘ç°ï¼š åœ¨ CIFAR10-C ä¸Šï¼ŒCoTTA çš„å¹³å‡é”™è¯¯ç‡ä»…ä¸º 16.2%ï¼Œæ˜¾è‘—ä¼˜äº Source-only åŸºçº¿ (43.5%) å’Œ TENT-continual (20.7%)ã€‚ åœ¨æ›´éš¾çš„ CIFAR100-C ä¸Šï¼ŒTENT ç­‰æ–¹æ³•å› é”™è¯¯ç´¯ç§¯å¯¼è‡´æ€§èƒ½éšæ—¶é—´æ¨ç§»è€Œæ€¥å‰§ä¸‹é™ï¼ˆé”™è¯¯ç‡ä» 37.2% æ¶åŒ–åˆ° 90.4%ï¼‰ï¼Œè€Œ CoTTA è¡¨ç°ç¨³å®šï¼Œå¹³å‡é”™è¯¯ç‡ä»…ä¸º 32.5% ã€‚ å®éªŒè¡¨æ˜ï¼ŒTENT åœ¨æŒç»­é€‚åº”çš„åæœŸä¼šå› é”™è¯¯ç´¯ç§¯è€Œæ€§èƒ½å´©æºƒï¼Œè€Œ CoTTA çš„éšæœºæ¢å¤æœºåˆ¶æˆåŠŸé¿å…äº†è¿™ä¸€ç‚¹ã€‚ Continual Adaptation on Semantic Segmentation åœ¨ä¸€ä¸ªä» Cityscapes (æ™´å¤©) åˆ° ACDC (é›¾ã€å¤œã€é›¨ã€é›ªç­‰æ¶åŠ£å¤©æ°”) çš„æŒç»­è¯­ä¹‰åˆ†å‰²ä»»åŠ¡ä¸­ï¼Œæ¨¡å‹ä¼šå¾ªç¯ç»å†è¿™å››ç§å¤©æ°”æ¡ä»¶ 10 æ¬¡ï¼Œä»¥æµ‹è¯•å…¶é•¿æœŸé€‚åº”å’Œé—å¿˜æƒ…å†µã€‚\nä¸»è¦å‘ç°ï¼š CoTTA å°†å¹³å‡ mIoU æå‡è‡³ 58.6%ï¼Œä¼˜äºæºæ¨¡å‹ (56.7%) å’Œå…¶ä»–é€‚åº”æ–¹æ³•ã€‚ TENT åœ¨æ­¤ä»»åŠ¡ä¸Šè¡¨ç°ä¸ä½³ï¼Œå› ä¸ºå…¶ä¾èµ–çš„æ‰¹é‡å½’ä¸€åŒ– (Batch Normalization) å±‚åœ¨ Transformer æ¶æ„ (Segformer) ä¸­å¾ˆå°‘ã€‚ CoTTA ä¸ä¾èµ–äºç‰¹å®šå±‚ï¼Œå› æ­¤åœ¨åŸºäº Transformer çš„æ¶æ„ä¸ŠåŒæ ·æœ‰æ•ˆï¼Œå±•ç°äº†å…¶é€šç”¨æ€§ 38ã€‚ Analysis é€šè¿‡æ¶ˆèå®éªŒéªŒè¯äº† CoTTA å„ä¸ªç»„ä»¶çš„æœ‰æ•ˆæ€§ã€‚\næƒé‡å¹³å‡çš„ä½œç”¨ï¼šä»…ä½¿ç”¨æƒé‡å¹³å‡çš„ä¼ªæ ‡ç­¾ï¼Œå°±å°†é”™è¯¯ç‡ä» 20.7% (TENT-continual) é™è‡³ 18.3%ï¼Œè¯æ˜äº†æ•™å¸ˆæ¨¡å‹ä¼ªæ ‡ç­¾çš„ä¼˜è¶Šæ€§ã€‚ æ•°æ®å¢å¼ºå¹³å‡çš„ä½œç”¨ï¼šåœ¨æƒé‡å¹³å‡çš„åŸºç¡€ä¸Šå†åŠ å…¥æ¡ä»¶æ€§æ•°æ®å¢å¼ºï¼Œé”™è¯¯ç‡è¿›ä¸€æ­¥é™è‡³ 17.4%ã€‚ éšæœºæ¢å¤çš„ä½œç”¨ï¼šæœ€ååŠ å…¥éšæœºæ¢å¤æœºåˆ¶ï¼Œé”™è¯¯ç‡æœ€ç»ˆé™è‡³ 16.2%ï¼Œå¹¶ä¸”è§£å†³äº†é•¿æœŸé€‚åº”ä¸­çš„æ€§èƒ½è¡°é€€é—®é¢˜ï¼Œè¯æ˜äº†å…¶åœ¨é¿å…ç¾éš¾æ€§é—å¿˜ä¸­çš„å…³é”®ä½œç”¨ã€‚ Related Work è®ºæ–‡å›é¡¾äº†ä¸ CoTTA ç›¸å…³çš„é¢†åŸŸï¼š\nTest-Time Adaptation (TTA)ï¼šç°æœ‰å·¥ä½œå¤§å¤šå…³æ³¨é™æ€ç›®æ ‡åŸŸï¼Œåœ¨æŒç»­å˜åŒ–çš„ç¯å¢ƒä¸­ï¼ŒåŸºäºç†µæœ€å°åŒ–æˆ–ä¼ªæ ‡ç­¾çš„æ–¹æ³•å®¹æ˜“å› ä¼ªæ ‡ç­¾å™ªå£°è€Œç´¯ç§¯é”™è¯¯ã€‚ Continuous Domain Adaptationï¼šä¸ CoTTA ç›®æ ‡ç›¸ä¼¼ï¼Œä½†ç°æœ‰æ–¹æ³•é€šå¸¸éœ€è¦è®¿é—®æºæ•°æ®æ¥å¯¹é½åˆ†å¸ƒã€‚ Continual Learningï¼šCoTTA å€Ÿé‰´äº†è¯¥é¢†åŸŸçš„æ€æƒ³æ¥è§£å†³ç¾éš¾æ€§é—å¿˜é—®é¢˜ï¼Œä½†å°†å…¶åº”ç”¨åœ¨äº†ä¸€ä¸ªæ— ç›‘ç£ã€æµ‹è¯•æ—¶é€‚åº”çš„ç‹¬ç‰¹åœºæ™¯ä¸­ã€‚ Source-Free Domain Adaptationï¼šCoTTA å±äºæ­¤èŒƒç•´ï¼Œå…¶æ–°é¢–ä¹‹å¤„åœ¨äºå®ƒä¸“ä¸ºåœ¨çº¿å’ŒæŒç»­å˜åŒ–çš„ç¯å¢ƒè®¾è®¡ï¼Œè€Œè¿™æ˜¯å…ˆå‰å·¥ä½œå¾ˆå°‘è€ƒè™‘çš„ã€‚ Discussion CoTTA æˆåŠŸåœ°è§£å†³äº†åœ¨æ— æºæ•°æ®ã€éå¹³ç¨³ç¯å¢ƒä¸‹è¿›è¡ŒæŒç»­æµ‹è¯•æ—¶é€‚åº”çš„æŒ‘æˆ˜ã€‚å®ƒé€šè¿‡åˆ›æ–°çš„æœºåˆ¶åŒæ—¶è§£å†³äº†é”™è¯¯ç´¯ç§¯å’Œç¾éš¾æ€§é—å¿˜è¿™ä¸¤ä¸ªæ ¸å¿ƒéš¾é¢˜ã€‚\nä¼˜åŠ¿æ€»ç»“ï¼š ç¨³å®šä¸é•¿æ•ˆï¼šé€šè¿‡éšæœºæ¢å¤æœºåˆ¶ï¼ŒCoTTA å®ç°äº†åœ¨é•¿æœŸæŒç»­é€‚åº”è¿‡ç¨‹ä¸­çš„æ€§èƒ½ç¨³å®šï¼Œé¿å…äº†æ€§èƒ½å´©æºƒã€‚ å®ç”¨ä¸é€šç”¨ï¼šæ— éœ€è®¿é—®æºæ•°æ®ï¼Œä¹Ÿæ— éœ€ä¿®æ”¹æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ï¼Œå¯ç›´æ¥ç”¨äºå„ç±»â€œå¼€ç®±å³ç”¨â€çš„é¢„è®­ç»ƒæ¨¡å‹ï¼ˆåŒ…æ‹¬ CNN å’Œ Transformerï¼‰ ã€‚ é«˜æ•ˆï¼šæ•´ä¸ªé€‚åº”è¿‡ç¨‹åœ¨çº¿è¿›è¡Œï¼Œæ¨¡å‹æ ¹æ®å½“å‰æ•°æ®æµå³æ—¶æ›´æ–°å’Œé¢„æµ‹ã€‚ æ€»è€Œè¨€ä¹‹ï¼ŒCoTTA ä¸ºæ¨¡å‹åœ¨çœŸå®ä¸–ç•Œä¸­éƒ¨ç½²åçš„æŒç»­è‡ªæˆ‘è¿›åŒ–æä¾›äº†ä¸€ä¸ªå¼ºå¤§ä¸”å®ç”¨çš„æ¡†æ¶ï¼Œä½¿æ¨¡å‹èƒ½å¤Ÿé²æ£’åœ°é€‚åº”ä¸æ–­å˜åŒ–çš„æ“ä½œç¯å¢ƒã€‚\n","permalink":"https://diefish1024.github.io/posts/literature-notes/cotta/","summary":"\u003ch1 id=\"setting\"\u003eSetting\u003c/h1\u003e\n\u003cp\u003e\u003cstrong\u003eContinual Test-Time Domain Adaptation\u003c/strong\u003e æ˜¯ä¸€ç§æ›´å…·æŒ‘æˆ˜æ€§çš„æ¨¡å‹é€‚åº”è®¾å®šã€‚åœ¨æ­¤è®¾å®šä¸‹ï¼Œä¸€ä¸ªåœ¨æºæ•°æ®ä¸Šé¢„è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œåœ¨æµ‹è¯•æ—¶ä¼šé‡åˆ°ä¸€ä¸ª\u003cstrong\u003eéå¹³ç¨³\u003c/strong\u003eä¸”\u003cstrong\u003eæŒç»­å˜åŒ–\u003c/strong\u003eçš„ç›®æ ‡ç¯å¢ƒ ã€‚\u003c/p\u003e\n\u003cp\u003eCoTTA ä¸ä»¥ä¸‹æ–¹æ³•ä¸åŒï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eStandard Domain Adaptation\u003c/strong\u003eï¼šéœ€è¦åŒæ—¶è®¿é—®æºæ•°æ®å’Œï¼ˆé™æ€çš„ï¼‰ç›®æ ‡æ•°æ®è¿›è¡Œè®­ç»ƒã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eStandard Test-Time Adaptation / Fully Test-Time Adaptation\u003c/strong\u003eï¼šé€šå¸¸å‡è®¾ç›®æ ‡åŸŸæ˜¯å›ºå®šçš„æˆ–é™æ€çš„ï¼Œè€Œ CoTTA å…³æ³¨çš„æ˜¯æŒç»­å˜åŒ–çš„ç›®æ ‡åŸŸã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eTest-Time Training (TTT)\u003c/strong\u003eï¼šéœ€è¦ä¿®æ”¹æºæ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ä»¥åŠ å…¥è¾…åŠ©ä»»åŠ¡ï¼Œå› æ­¤æ— æ³•ä½¿ç”¨ä»»æ„çš„â€œå¼€ç®±å³ç”¨â€é¢„è®­ç»ƒæ¨¡å‹ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç›¸æ¯”ä¹‹ä¸‹ï¼ŒCoTTA ä¸“é—¨è§£å†³åœ¨\u003cstrong\u003eæ— æºæ•°æ®\u003c/strong\u003eçš„æ¡ä»¶ä¸‹ï¼Œæ¨¡å‹å¦‚ä½•åœ¨çº¿é€‚åº”ä¸€ä¸ª\u003cstrong\u003eæŒç»­å˜åŒ–çš„\u003c/strong\u003eæ•°æ®æµï¼ŒåŒæ—¶å…‹æœç°æœ‰æ–¹æ³•ä¸­å¸¸è§çš„\u003cstrong\u003eé”™è¯¯ç´¯ç§¯\u003c/strong\u003eå’Œ\u003cstrong\u003eç¾éš¾æ€§é—å¿˜\u003c/strong\u003eé—®é¢˜ã€‚\u003c/p\u003e\n\u003ch2 id=\"method\"\u003eMethod\u003c/h2\u003e\n\u003cp\u003eè®ºæ–‡çš„æ ¸å¿ƒè´¡çŒ®æ˜¯æå‡ºäº†\u003cstrong\u003eCoTTA (Continual Test-Time Adaptation)\u003c/strong\u003e æ–¹æ³•ï¼Œæ—¨åœ¨é€šè¿‡\u003cstrong\u003eå‡å°‘é”™è¯¯ç´¯ç§¯\u003c/strong\u003eå’Œ\u003cstrong\u003eé¿å…ç¾éš¾æ€§é—å¿˜\u003c/strong\u003eï¼Œå®ç°æ¨¡å‹åœ¨éå¹³ç¨³ç¯å¢ƒä¸‹çš„é•¿æœŸç¨³å®šé€‚åº”ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªå…³é”®éƒ¨åˆ†ã€‚\u003c/p\u003e\n\u003ch3 id=\"1-å‡å°‘é”™è¯¯ç´¯ç§¯-reducing-error-accumulation\"\u003e1. å‡å°‘é”™è¯¯ç´¯ç§¯ (Reducing Error Accumulation)\u003c/h3\u003e\n\u003cp\u003eä¸ºäº†ç”Ÿæˆæ›´å¯é çš„è‡ªè®­ç»ƒä¿¡å·ï¼ŒCoTTA é‡‡ç”¨äº†å¹³å‡åŒ–çš„ä¼ªæ ‡ç­¾ç­–ç•¥ï¼Œè¯¥ç­–ç•¥ç»“åˆäº†æƒé‡å¹³å‡å’Œæ•°æ®å¢å¼ºå¹³å‡ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eæƒé‡å¹³å‡ä¼ªæ ‡ç­¾ (Weight-Averaged Pseudo-Labels)\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003eè¯¥æ–¹æ³•é‡‡ç”¨ä¸€ä¸ª\u003cstrong\u003eæ•™å¸ˆ - å­¦ç”Ÿ (teacher-student)\u003c/strong\u003e æ¡†æ¶ã€‚å­¦ç”Ÿæ¨¡å‹ (student model) åœ¨çº¿è¿›è¡Œå­¦ä¹ å’Œæ›´æ–°ã€‚\u003c/li\u003e\n\u003cli\u003eæ•™å¸ˆæ¨¡å‹ (teacher model) çš„æƒé‡æ˜¯å­¦ç”Ÿæ¨¡å‹æƒé‡çš„\u003cstrong\u003eæŒ‡æ•°ç§»åŠ¨å¹³å‡ (Exponential Moving Average, EMA)\u003c/strong\u003eã€‚\u003c/li\u003e\n\u003cli\u003eç”±äºæ•™å¸ˆæ¨¡å‹çš„æ›´æ–°æ›´å¹³æ»‘ï¼Œå…¶é¢„æµ‹ç»“æœé€šå¸¸æ¯”å­¦ç”Ÿæ¨¡å‹æ›´å‡†ç¡®ï¼Œå› æ­¤ç”¨å®ƒæ¥ç”Ÿæˆä¼ªæ ‡ç­¾ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘é”™è¯¯ç´¯ç§¯ã€‚å­¦ç”Ÿæ¨¡å‹é€šè¿‡æœ€å°åŒ–ä¸æ•™å¸ˆä¼ªæ ‡ç­¾çš„\u003cstrong\u003eä¸€è‡´æ€§æŸå¤±\u003c/strong\u003e (consistency loss) æ¥è¿›è¡Œæ›´æ–°ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ•°æ®å¢å¼ºå¹³å‡ä¼ªæ ‡ç­¾ (Augmentation-Averaged Pseudo-Labels)\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003eä¸ºäº†è¿›ä¸€æ­¥æå‡ä¼ªæ ‡ç­¾åœ¨é‡åˆ°è¾ƒå¤§åŸŸåç§»æ—¶çš„è´¨é‡ï¼ŒCoTTA ä¼šæœ‰æ¡ä»¶åœ°ä½¿ç”¨æ•°æ®å¢å¼ºã€‚\u003c/li\u003e\n\u003cli\u003eå®ƒé¦–å…ˆä½¿ç”¨\u003cstrong\u003eåŸå§‹é¢„è®­ç»ƒæ¨¡å‹\u003c/strong\u003eè¯„ä¼°å½“å‰æµ‹è¯•æ•°æ®çš„\u003cstrong\u003eé¢„æµ‹ç½®ä¿¡åº¦\u003c/strong\u003eï¼Œä»¥æ­¤æ¥è¿‘ä¼¼åŸŸå·®å¼‚çš„å¤§å°ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ¡ä»¶æ€§åº”ç”¨\u003c/strong\u003eï¼š\n\u003cul\u003e\n\u003cli\u003eå¦‚æœç½®ä¿¡åº¦\u003cstrong\u003eé«˜\u003c/strong\u003eï¼ˆåŸŸå·®å¼‚å°ï¼‰ï¼Œåˆ™ç›´æ¥ä½¿ç”¨æ•™å¸ˆæ¨¡å‹çš„é¢„æµ‹ä½œä¸ºä¼ªæ ‡ç­¾ 16ã€‚\u003c/li\u003e\n\u003cli\u003eå¦‚æœç½®ä¿¡åº¦\u003cstrong\u003eä½\u003c/strong\u003eï¼ˆåŸŸå·®å¼‚å¤§ï¼‰ï¼Œåˆ™å¯¹è¾“å…¥æ•°æ®è¿›è¡Œ N æ¬¡éšæœºå¢å¼ºï¼Œå¹¶å°†æ•™å¸ˆæ¨¡å‹å¯¹è¿™äº›å¢å¼ºæ ·æœ¬çš„å¹³å‡é¢„æµ‹ç»“æœä½œä¸ºä¼ªæ ‡ç­¾ 17171717ã€‚è¿™å¯ä»¥è¿›ä¸€æ­¥æé«˜ä¼ªæ ‡ç­¾çš„é²æ£’æ€§ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"2-é¿å…ç¾éš¾æ€§é—å¿˜-avoiding-catastrophic-forgetting\"\u003e2. é¿å…ç¾éš¾æ€§é—å¿˜ (Avoiding Catastrophic Forgetting)\u003c/h3\u003e\n\u003cp\u003eä¸ºäº†åœ¨é•¿æœŸé€‚åº”è¿‡ç¨‹ä¸­ä¿ç•™ä»æºåŸŸå­¦åˆ°çš„çŸ¥è¯†ï¼ŒCoTTA å¼•å…¥äº†\u003cstrong\u003eéšæœºæ¢å¤ (Stochastic Restoration)\u003c/strong\u003e æœºåˆ¶ã€‚\u003c/p\u003e","title":"CoTTA"},{"content":"Introduction ç±»ä¼¼ GAN çš„å¯¹æŠ—è®­ç»ƒæ€æƒ³\nDomain Adaptation ç»™å®šæºåŸŸ $ D_{S} $ ï¼ˆæœ‰æ ‡ç­¾ï¼‰å’Œç›®æ ‡åŸŸ $ D_{T} $ ï¼ˆæ— æ ‡ç­¾ï¼‰ï¼Œç›®æ ‡æ˜¯è®­ç»ƒä¸€ä¸ªåˆ†ç±»å™¨ $ \\eta: X\\to Y $ ä½¿å…¶åœ¨ç›®æ ‡åŸŸä¸Šçš„ç›®æ ‡é£é™© $$ R_{D_{T}}(\\eta) = \\underset{(\\mathbf{x},y)\\sim D_{T}}{\\mathrm{Pr}}(\\eta(\\mathbf{x}) \\neq y) $$ æœ€å°\nDomain Divergence éœ€è¦é‡åŒ–ä¸¤ä¸ªé¢†åŸŸçš„â€œç›¸ä¼¼åº¦â€ï¼Œä»è€Œå¼•å‡ºäº† H- æ•£åº¦ çš„æ¦‚å¿µï¼š $$ d_{\\mathcal{H}}(D_S, D_T) = 2 \\sup_{\\eta \\in \\mathcal{H}} \\left| \\Pr_{x \\sim D_S}[\\eta(x) = 1] - \\Pr_{x \\sim D_T}[\\eta(x) = 1] \\right| $$ å«ä¹‰æ˜¯æœ€ä¼˜çš„åˆ†ç±»å™¨å°†ç›®æ ‡åŸŸå’ŒæºåŸŸåˆ¤å®šä¸º 1 çš„å¯èƒ½æ€§ä¹‹å·®ï¼Œå½“ H- æ•£åº¦éå¸¸å°æ—¶ï¼Œè¯´æ˜ä¸¤ä¸ªé¢†åŸŸå¾ˆéš¾è¢«åŒºåˆ†ï¼Œä¹Ÿå°±è¯´æ˜å­¦ä¹ çš„ç‰¹å¾å®ç°äº†é¢†åŸŸä¸å˜æ€§çš„æ•ˆæœ\nç”±äºç†è®º H æ•£åº¦æ˜¯ç†æƒ³æ•°æ®åˆ†å¸ƒä¸Šçš„å®šä¹‰ï¼Œå®é™…ä¸­åªæœ‰æœ‰é™çš„æ ·æœ¬é›† $ S $ å’Œ $ T $ ï¼Œå› æ­¤éœ€è¦ä¸€å®šçš„è¿‘ä¼¼ï¼Œäºæ˜¯éœ€è¦ç»éªŒ H- æ•£åº¦ $$ \\hat{d}_{\\mathcal{H}}(S, T) = 2 \\left(1 - \\min_{\\eta \\in \\mathcal{H}} \\left[ \\dfrac{1}{n}\\sum_{i=1}^n \\mathcal{I}[\\eta(x_i) = 0] + \\dfrac{1}{n'}\\sum_{i=n+1}^N \\mathcal{I}[\\eta(x_i) = 1] \\right] \\right) $$ å…¶ä¸­ $ \\mathcal{I}[\\cdot] $ è¡¨ç¤ºæ¡ä»¶ä¸ºçœŸæ—¶ä¸º 1ï¼Œå¦åˆ™ä¸º 0\nProxy Distance ç»éªŒ H- æ•£åº¦ä¹Ÿéœ€è¦ç›´æ¥éå†æ‰€æœ‰çš„ $ \\eta $ ï¼Œåœ¨è®¡ç®—ä¸Šä¸ç°å®ï¼Œéœ€è¦ä¸€ä¸ªè¿›ä¸€æ­¥çš„è¿‘ä¼¼æ–¹æ³•ï¼Œå› æ­¤è€ƒè™‘ Proxy A-distance (PAD)\næ„é€ ç”¨äºé¢†åŸŸåˆ†ç±»çš„æ•°æ®é›† $$ U = \\{ (\\mathbf{x}_{i},0) \\}_{i=1}^{n} \\cup \\{ (\\mathbf{x}_{i},1) \\}_{i=n+1}^{N} $$ ç”¨è¿™ä¸ªæ•°æ®é›†è®­ç»ƒåˆ†ç±»å™¨ï¼Œè®¾ $ \\epsilon $ ä¸ºåœ¨æ•°æ®é›† $ U $ ä¸Šè®­ç»ƒå‡ºçš„æœ€ä¼˜é¢†åŸŸåˆ†ç±»å™¨æ‰€è¾¾åˆ°çš„æœ€å°é”™è¯¯ç‡ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ $$ \\hat{d}_{\\mathcal{A}} = 2(1-2\\epsilon) $$ æ¥è¿‘ä¼¼ H- æ•£åº¦\nGeneralization Bound on the Target Risk æœ‰æ•ˆæ€§è¯æ˜\nç†è®ºç ”ç©¶è¯´æ˜æ¨¡å‹çš„ç›®æ ‡é£é™©å¯ä»¥é€šè¿‡æºé£é™©å’Œä¸¤ä¸ªé¢†åŸŸçš„æ•£åº¦æ¥é™åˆ¶ï¼Œä¸»è¦æ€æƒ³æ˜¯ $$ R_{D_T}(\\eta) \\le R_S(\\eta) + \\text{Domain Divergence Terms} + \\text{Complexity Terms} + \\beta $$ å…¶ä¸­ $ \\text{Domain Divergence Terms}\\approx d_{\\mathcal{H}}(S, T) $ ï¼Œå¯ä»¥ç”¨ä¸Šé¢çš„ $ \\hat{d}_{\\mathcal{A}} $ è¿‘ä¼¼ï¼›$ \\text{Complexity Terms} $ æ˜¯ä¸€ä¸ªæ¯”è¾ƒå°çš„å¸¸æ•°é¡¹ï¼Œå’Œæ¨¡å‹æœ¬èº«è®­ç»ƒæœ‰å…³ï¼ˆåŸå…¬å¼æ²¡çœ‹æ‡‚ã€‚ã€‚ï¼‰ï¼›$ \\beta $ æ˜¯ä¸€ä¸ªç†æƒ³åŒ–çš„é¡¹ï¼Œè¡¨ç¤ºæœ€å¥½æƒ…å†µä¸‹åœ¨ç›®æ ‡åŸŸå’ŒæºåŸŸä¸ŠåŒæ—¶å–å¾—çš„æœ€ä½é”™è¯¯ç‡\nDANN ä¼˜åŒ–ç›®æ ‡ï¼š $$ E(\\theta_f, \\theta_y, \\theta_d) = \\frac{1}{n} \\sum_{i=1}^n \\mathcal{L}_y(\\theta_f, \\theta_y) - \\lambda \\left( \\frac{1}{n} \\sum_{i=1}^n \\mathcal{L}_d(\\theta_f, \\theta_d) + \\frac{1}{n'} \\sum_{i=n+1}^N \\mathcal{L}_d(\\theta_f, \\theta_d) \\right) $$ æ ¸å¿ƒæ˜¯ Saddle Point Problem ï¼Œæ‰¾åˆ°éœ€è¦æ‰¾åˆ°éç‚¹è€Œéæœ€å°å€¼\nå¦‚ä½•å®ç°å¯¹æŠ—ï¼š\næ ‡ç­¾é¢„æµ‹å‚æ•°ï¼š $$ \\theta_{y} \\leftarrow \\theta_{y} - \\mu \\dfrac{ \\partial \\mathcal{L}_{y} }{ \\partial \\theta_{y} } $$ é¢†åŸŸåˆ†ç±»å‚æ•°ï¼š $$ \\theta_{d} \\leftarrow \\theta_{d} - \\mu \\lambda \\dfrac{ \\partial \\mathcal{L}_{d} }{ \\partial \\theta_{d} } $$ ç‰¹å¾æå–å‚æ•°ï¼š $$ \\theta_{f} \\leftarrow \\theta_{f} - \\mu\\left( \\dfrac{ \\partial \\mathcal{L}_{y} }{ \\partial \\theta_{f} } - \\lambda \\dfrac{ \\partial \\mathcal{L}_{d} }{ \\partial \\theta_{f} } \\right) $$ æ ¸å¿ƒéœ€è¦æœ€å¤§åŒ– $ \\mathcal{L}_{d} $ ï¼Œå› æ­¤éœ€è¦æ²¿ç€æ¢¯åº¦çš„æ­£å‘ä¼˜åŒ– Gradient Reversal Layer (GRL) æ˜¯å®ç°å¯¹æŠ—çš„æ ¸å¿ƒç»„ä»¶ï¼Œå…·ä½“åŸç†æ˜¯åœ¨å‰å‘ä¼ æ’­æ—¶è¡¨ç°ä¸º $ R(x)=x $ ï¼Œä½†æ˜¯åå‘ä¼ æ’­æ—¶ $ \\dfrac{\\mathrm{d} R}{\\mathrm{d}x}=-I $ ï¼Œè¿™æ ·å¯ä»¥ç›´æ¥åˆ©ç”¨å†…ç½®çš„è‡ªåŠ¨å¾®åˆ†ä¼˜é›…å®ç°å¯¹æŠ—\n","permalink":"https://diefish1024.github.io/posts/literature-notes/dann/","summary":"\u003ch2 id=\"introduction\"\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eç±»ä¼¼ GAN çš„å¯¹æŠ—è®­ç»ƒæ€æƒ³\u003c/p\u003e\n\u003ch2 id=\"domain-adaptation\"\u003eDomain Adaptation\u003c/h2\u003e\n\u003cp\u003eç»™å®šæºåŸŸ $ D_{S} $ ï¼ˆæœ‰æ ‡ç­¾ï¼‰å’Œç›®æ ‡åŸŸ $ D_{T} $ ï¼ˆæ— æ ‡ç­¾ï¼‰ï¼Œç›®æ ‡æ˜¯è®­ç»ƒä¸€ä¸ªåˆ†ç±»å™¨ $ \\eta: X\\to Y $ ä½¿å…¶åœ¨ç›®æ ‡åŸŸä¸Šçš„ç›®æ ‡é£é™©\n$$ \n\nR_{D_{T}}(\\eta) = \\underset{(\\mathbf{x},y)\\sim D_{T}}{\\mathrm{Pr}}(\\eta(\\mathbf{x}) \\neq y)\n\n $$\næœ€å°\u003c/p\u003e\n\u003ch4 id=\"domain-divergence\"\u003eDomain Divergence\u003c/h4\u003e\n\u003cp\u003eéœ€è¦é‡åŒ–ä¸¤ä¸ªé¢†åŸŸçš„â€œç›¸ä¼¼åº¦â€ï¼Œä»è€Œå¼•å‡ºäº† \u003cstrong\u003eH- æ•£åº¦\u003c/strong\u003e çš„æ¦‚å¿µï¼š\n$$ \n\nd_{\\mathcal{H}}(D_S, D_T) = 2 \\sup_{\\eta \\in \\mathcal{H}} \\left| \\Pr_{x \\sim D_S}[\\eta(x) = 1] - \\Pr_{x \\sim D_T}[\\eta(x) = 1] \\right|\n\n $$\nå«ä¹‰æ˜¯æœ€ä¼˜çš„åˆ†ç±»å™¨å°†ç›®æ ‡åŸŸå’ŒæºåŸŸåˆ¤å®šä¸º 1 çš„å¯èƒ½æ€§ä¹‹å·®ï¼Œå½“ H- æ•£åº¦éå¸¸å°æ—¶ï¼Œè¯´æ˜ä¸¤ä¸ªé¢†åŸŸå¾ˆéš¾è¢«åŒºåˆ†ï¼Œä¹Ÿå°±è¯´æ˜å­¦ä¹ çš„ç‰¹å¾å®ç°äº†é¢†åŸŸä¸å˜æ€§çš„æ•ˆæœ\u003c/p\u003e\n\u003cp\u003eç”±äºç†è®º H æ•£åº¦æ˜¯ç†æƒ³æ•°æ®åˆ†å¸ƒä¸Šçš„å®šä¹‰ï¼Œå®é™…ä¸­åªæœ‰æœ‰é™çš„æ ·æœ¬é›† $ S $ å’Œ $ T $ ï¼Œå› æ­¤éœ€è¦ä¸€å®šçš„è¿‘ä¼¼ï¼Œäºæ˜¯éœ€è¦ç»éªŒ H- æ•£åº¦\n$$ \n\n\\hat{d}_{\\mathcal{H}}(S, T) = 2 \\left(1 - \\min_{\\eta \\in \\mathcal{H}} \\left[ \\dfrac{1}{n}\\sum_{i=1}^n \\mathcal{I}[\\eta(x_i) = 0] + \\dfrac{1}{n'}\\sum_{i=n+1}^N \\mathcal{I}[\\eta(x_i) = 1] \\right] \\right)\n\n $$\nå…¶ä¸­ $ \\mathcal{I}[\\cdot] $ è¡¨ç¤ºæ¡ä»¶ä¸ºçœŸæ—¶ä¸º 1ï¼Œå¦åˆ™ä¸º 0\u003c/p\u003e","title":"DANN"},{"content":"Abstract é—®é¢˜ï¼šç°æœ‰ EEG æƒ…ç»ªè¯†åˆ«æ–¹æ³•å¯¹é•¿æœŸä¸Šä¸‹æ–‡ä¿¡æ¯å…³æ³¨ä¸è¶³ï¼Œå¯¼è‡´è·¨è¢«è¯•æ³›åŒ–èƒ½åŠ›å‡å¼± æ–¹æ¡ˆï¼šæå‡º Emotion Transformer (EmT) ï¼Œä¸º Graph-Transformer æ··å’Œæ¶æ„ æ ¸å¿ƒæ¨¡å—ï¼š TGCï¼šå°† EEG ä¿¡å·è½¬æ¢ä¸ºæ—¶åºå›¾åºåˆ— RMPGï¼šä½¿ç”¨æ®‹å·®å¤šè§†å›¾é‡‘å­—å¡” GCNï¼Œå­¦ä¹ åŠ¨æ€ã€å¤šå°ºåº¦çš„ç©ºé—´è¿æ¥æ¨¡å¼ï¼Œç”Ÿæˆ tokenï¼ˆæ ¸å¿ƒï¼‰ TCTï¼šä½¿ç”¨ä»»åŠ¡è‡ªé€‚åº”çš„ Transformerï¼Œå­¦ä¹  token åºåˆ—ä¸Šä¸‹æ–‡ï¼ˆæ ¸å¿ƒï¼‰ TSOï¼šè¾“å‡ºåˆ†ç±»/å›å½’ç»“æœ æˆæœï¼šåœ¨å¤šä¸ªå…¬å¼€æ•°æ®é›†çš„å¹¿ä¹‰è·¨è¢«è¯•ä»»åŠ¡ä¸Šé¢è¶…è¿‡äº† baseline Introduction \u0026amp; Related Work ä¸ºä»€ä¹ˆ EEG éš¾ä»¥ä½¿ç”¨è·¨è¢«è¯• (cross-subject) çš„åœºæ™¯ï¼Ÿ\nä¸ªä½“å·®å¼‚ï¼šä¸åŒè¢«è¯•ç”Ÿç†ç»“æ„å’Œè®¤çŸ¥ç­–ç•¥å·®å¼‚ï¼Œå¯¼è‡´ EEG æ¨¡å¼ä¸åŒ ä½ä¿¡å™ªæ¯”ï¼šEEG ä¿¡å·å®¹æ˜“å—åˆ°å¤–æºå™ªå£°å¹²æ‰°ï¼ˆè‚Œç”µã€çœ¼ç”µâ€¦â€¦ï¼‰ ç›®æ ‡æ˜¯å­¦ä¹ ä¸€ç§è·¨è¢«è¯•å…±äº«ã€å…·æœ‰æ³›åŒ–èƒ½åŠ›çš„æƒ…ç»ªè¡¨å¾\nGpaph Neural Networks æ ¸å¿ƒæ€æƒ³ï¼šEEG æ•°æ®å…·æœ‰éæ¬§å›¾ç»“æ„ï¼Œé€‚åˆä½¿ç”¨ GNN æ¥å¤„ç† ä»£è¡¨å·¥ä½œï¼š ChebyNetï¼šä½¿ç”¨åˆ‡æ¯”é›ªå¤«å¤šé¡¹å¼è¿‘ä¼¼å…‰è°±æ»¤æ³¢ï¼ŒEmT æ¨¡å‹ä¸­é‡‡ç”¨å…¶ä½œä¸º GCN å±‚ GCNï¼šé€šè¿‡å±€éƒ¨ä¸€é˜¶èšåˆè¿‘ä¼¼å…‰è°±æ»¤æ³¢ DGCNN / RGNNï¼šä½¿ç”¨ GNNs æå– EEG ç©ºé—´ä¿¡æ¯ï¼›ä¾èµ–å•ä¸€çš„é‚»æ¥çŸ©é˜µï¼Œå¿½ç•¥æ—¶åºä¸Šä¸‹æ–‡ï¼Œå…·æœ‰å±€é™æ€§ï¼›è€Œ EmT é€šè¿‡å¤šè§†å›¾å¯å­¦ä¹ é‚»æ¥çŸ©é˜µå’Œæ—¶åºå›¾æ¥å¼¥è¡¥ Temporal Context Learning æ ¸å¿ƒç†å¿µ: æƒ…ç»ªæ˜¯è¿ç»­è®¤çŸ¥è¿‡ç¨‹ï¼ŒEEG ä¿¡å·ä¸­åµŒå…¥æ—¶åºä¸Šä¸‹æ–‡ä¿¡æ¯ ä»£è¡¨å·¥ä½œï¼š LSTM / TCN / TESANet / Conformer / AMDET å±€é™æ€§ï¼šè¿™äº›æ–¹æ³•é€šå¸¸ä»æ‰å¹³åŒ–çš„ EEG ç‰¹å¾å‘é‡å­¦ä¹ ï¼Œå¯èƒ½æœªèƒ½æœ‰æ•ˆå­¦ä¹ ç©ºé—´å…³ç³»ï¼›EmT åˆ™é€šè¿‡å¹¶è¡Œ GCN å’Œ STA å±‚æ›´æœ‰æ•ˆåœ°æ•æ‰æ—¶ç©ºä¿¡æ¯ EEG Emotion Recognition æ ¸å¿ƒç†å¿µï¼šEEG æƒ…ç»ªè¯†åˆ«é¢ä¸´ä¸ªä½“å·®å¼‚å¤§ã€ä¿¡å™ªæ¯”ä½ç­‰æŒ‘æˆ˜ï¼Œéœ€æå–å…‰è°±ã€ç©ºé—´ã€æ—¶åºç‰¹å¾ ä»£è¡¨å·¥ä½œï¼š GCB-Net / TSception å±€é™æ€§ï¼šæ²¡æœ‰å…³æ³¨é•¿æ—¶åºä¸Šä¸‹æ–‡ä¿¡æ¯ Method EmT æ˜¯ä¸€ä¸ªç«¯åˆ°ç«¯çš„æ¡†æ¶ï¼ŒåŒ…å«å››å¤§æ¨¡å—ï¼š\nraw EEG -\u0026gt; TGC -\u0026gt; æ—¶åºå›¾ -\u0026gt; RMPG -\u0026gt; Tokens -\u0026gt; TCT -\u0026gt; æ·±å±‚ç‰¹å¾ -\u0026gt; TSO -\u0026gt; Result\nEEG-Temporal-Graph Representations (TGC) ç›®æ ‡ï¼šå°†è¿ç»­çš„ EEG ä¿¡å·è½¬åŒ–ä¸ºç»“æ„åŒ–çš„æ—¶åºå›¾åºåˆ—\nå›¾ï¼šæ¯ä¸ªâ€œå›¾â€æ˜¯æŒ‡åœ¨ä¸€ä¸ªçŸ­çš„çª—å£å†…å¤§è„‘çŠ¶æ€çš„æ•°å­¦è¡¨ç¤ºï¼Œå›¾ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”ä¸€ä¸ª EEG ç”µæé€šé“ï¼ŒèŠ‚ç‚¹çš„ç‰¹å¾æ˜¯è¯¥é€šé“åœ¨ 7 ä¸ªä¸åŒçš„é¢‘æ®µä¸Šçš„ rPSD æ—¶åºåºåˆ—ï¼šåºåˆ—æ˜¯é€šè¿‡æ»‘åŠ¨çª—å£æŠ€æœ¯æˆªå–çš„ä¸€æ®µè¾ƒé•¿çš„ EEG æ•°æ®é‡Œé¢åˆ‡åˆ†æˆè®¸å¤šé‡å çš„çŸ­çš„å­ç‰‡æ®µï¼Œæ¯ä¸ªå­ç‰‡æ®µç”Ÿæˆçš„å›¾æ‰€å½¢æˆçš„åºåˆ— åŒå±‚æ»‘åŠ¨çª—å£åˆ†æ®µï¼šä¸ºäº†æ•æ‰ä¸åŒæ—¶é—´å°ºåº¦ä¸Šçš„ä¿¡æ¯ï¼ŒTGC é‡‡ç”¨äº†ä¸€ç§åŒå±‚åˆ†æ®µç­–ç•¥ é¦–å…ˆå°†ä¸€æ¬¡å®Œæ•´å®éªŒçš„ (trail) çš„ EEG æ•°æ®ï¼Œè¡¨ç¤ºä¸º $ X \\in \\mathbb{R}^{c \\times L} $ ï¼ˆå…¶ä¸­ $ c $ ä¸ºé€šé“æ•°ï¼Œ$ L $ ä¸ºæ€»é‡‡æ ·ç‚¹æ•°ï¼‰ï¼Œé€šè¿‡ä¸€ä¸ªè¾ƒé•¿çš„æ»‘åŠ¨çª—å£ï¼ˆé•¿åº¦ä¸º $ l $ ï¼Œæ­¥é•¿ä¸º $ s $ ï¼‰åˆ†å‰²æˆå¤šä¸ªé‡å çš„é•¿ç‰‡æ®µ $ \\overline{X} \\in \\mathbb{R}^{c \\times l} $ æ¥ç€å¯¹äºæ¯ä¸€ä¸ªé•¿ç‰‡æ®µ $ \\overline{X} $ ä½¿ç”¨ä¸€ä¸ªæ›´çŸ­çš„æ»‘åŠ¨çª—å£ï¼ˆé•¿åº¦ä¸º $ l' $ ï¼Œæ­¥é•¿ä¸º $ s' $ ï¼‰å°†å…¶åˆ†å‰²ä¸ºä¸€ç³»åˆ—å­ç‰‡æ®µ $ \\tilde{X} \\in \\mathbb{R}^{c \\times l'} $ è¿™ä½¿å¾—æ¨¡å‹èƒ½å¤Ÿåœ¨ä¸€ä¸ªé•¿ç‰‡æ®µçš„æ ‡ç­¾ä¸‹ï¼Œè§‚å¯Ÿåˆ°å†…éƒ¨æ›´ç²¾ç»†çš„ä¿¡å·åŠ¨æ€å˜åŒ–ï¼Œä¸ºåç»­çš„ Transformer æ¨¡å—æ•æ‰æ—¶é—´ä¸Šä¸‹æ–‡æä¾›äº†åŸºç¡€ èŠ‚ç‚¹ç‰¹å¾æå–ï¼šå¯¹äºæ¯ä¸€ä¸ªå­ç‰‡æ®µ $ \\tilde{X} $ï¼Œéœ€è¦ä¸ºå…¶å¯¹åº”çš„å›¾èŠ‚ç‚¹ï¼ˆå³ EEG é€šé“ï¼‰æå–æœ‰æ„ä¹‰çš„ç‰¹å¾ï¼Œè®ºæ–‡é€‰æ‹©äº†ç›¸å¯¹åŠŸç‡è°±å¯†åº¦ (Relative PSD, rPSD) ä½œä¸ºèŠ‚ç‚¹å±æ€§ å…·ä½“åœ°ï¼Œä½¿ç”¨ welch\u0026rsquo;s method è®¡ç®—æ¯ä¸ª EEG é€šé“åœ¨ä¸ƒä¸ªç»å…¸é¢‘å¸¦ä¸Šçš„ rPSD è¿™æ ·ï¼Œæ¯ä¸ªå­ç‰‡æ®µ $ \\tilde{X} $ éƒ½å¯¹åº”ä¸€ä¸ªç‰¹å¾çŸ©é˜µ $ F \\in \\mathbb{R}^{c \\times f} $ï¼Œå…¶ä¸­ $ f=7 $ æœ€ç»ˆï¼Œä¸€ä¸ªé•¿ç‰‡æ®µ $ \\overline{X} $ è¢«è½¬æ¢æˆä¸€ä¸ªæŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„å›¾åºåˆ— $ G_{T} = \\{\\mathcal{G}^{i}\\} \\in \\mathbb{R}^{seq \\times c \\times f} $ï¼Œå…¶ä¸­ $ seq $ æ˜¯å­ç‰‡æ®µçš„æ•°é‡ã€‚è¿™ä¸ªæ—¶é—´å›¾åºåˆ—å°±æ˜¯ RMPG æ¨¡å—çš„è¾“å…¥\nResidual Multiview Pyramid GCN (RMPG) æ ¸å¿ƒï¼šè§£å†³ä¼ ç»Ÿ GNNâ€œå•ä¸€è§†è§’â€é—®é¢˜ï¼Œä¸ºæ—¶é—´å›¾åºåˆ— $ G_{T} $â€‹ ä¸­çš„æ¯ä¸€ä¸ªå›¾ $ \\mathcal{G}^i $ å­¦ä¹ ä¸€ä¸ªä¸°å¯Œçš„ã€å¤šå±‚æ¬¡çš„ç©ºé—´è¡¨å¾ï¼Œå¹¶å°†å…¶å‹ç¼©æˆä¸€ä¸ªå•ä¸€çš„ token ï¼Œä»¥ä¾›åç»­çš„ TCT æ¨¡å—å¤„ç†\nRMPG æ¨¡å—ç”±ä¸€ä¸ªåŸºç¡€çš„å›¾ç¼–ç å™¨ $ \\Phi_{g}(\\cdot) $ æ„æˆï¼Œæ–‡ä¸­é‡‡ç”¨äº† ChebyNet ä½œä¸ºåŸºç¡€å›¾ç¼–ç å™¨ï¼Œå¯¹äºç»™å®šç‰¹å¾è¾“å…¥ $ F^{m-1} $ å’Œé‚»æ¥çŸ©é˜µ $ A $ ï¼ˆé€šè¿‡æ‹‰æ™®æ‹‰æ–¯ç®—å­ $ \\hat{L} $ è½¬æ¢ï¼‰ $$ \\Phi_{g}(F^{m}, A) = \\sigma\\left( \\sum_{k=0}^{K-1}\\theta_{k}^{m}T_{k}(\\hat{L})F^{m-1} - b^{m}\\right) $$ å…¶ä¸­ $ m $ ä¸º GCN å±‚çš„ç´¢å¼•ï¼Œ$ \\sigma $ ä¸º ReLU æ¿€æ´»å‡½æ•°ï¼Œ$ \\theta $ ä¸ºå‚æ•°ï¼Œ$ T_{k} $ ä¸º $ k $ é˜¶ Chebyshev å¤šé¡¹å¼\nå¤šè§†å›¾å­¦ä¹  (Multiview Learning) ï¼šä¸ºäº†æ¨¡æ‹Ÿæƒ…ç»ªèƒŒåå¤šç§è®¤çŸ¥å­è¿‡ç¨‹é©±åŠ¨çš„ä¸åŒå¤§è„‘è¿æ¥æ¨¡å¼ï¼ŒRMPG å¹¶éä½¿ç”¨å•ä¸€çš„å›¾å·ç§¯ç½‘ç»œï¼Œè€Œæ˜¯å¹¶è¡Œåœ°ä½¿ç”¨äº†å¤šä¸ª GCN åˆ†æ”¯ï¼Œ$ \\{ \\Phi_{g}^{0}(\\cdot), \\Phi_{g}^{1}(\\cdot), \\dots, \\Phi_{g}^{i}(\\cdot) \\} $ æ¯ä¸ªåˆ†æ”¯éƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„å¯å­¦ä¹ é‚»æ¥çŸ©é˜µ $ A^{i} \\in \\mathbb{R}^{c \\times c} $ ï¼Œèƒ½åœ¨æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­é€šè¿‡æ¢¯åº¦åå‘ä¼ æ’­è¿›è¡Œç«¯åˆ°ç«¯çš„ä¼˜åŒ– è¿™æ„å‘³ç€æ¯ä¸ª GCN åˆ†æ”¯éƒ½èƒ½ä»æ•°æ®ä¸­å­¦ä¹ åˆ°ä¸€ç§ç‹¬ç‰¹çš„å¤§è„‘åŠŸèƒ½è¿æ¥â€œè§†å›¾â€ é‡‘å­—å¡”å­¦ä¹  (Pyramid Learning) ï¼šä¸ºäº†æ•æ‰ä¸åŒå°ºåº¦çš„ç©ºé—´ä¿¡æ¯ï¼Œå¹¶è¡Œçš„ GCN åˆ†æ”¯è¢«è®¾è®¡æˆå…·æœ‰ä¸åŒçš„æ·±åº¦ï¼ˆå³ GCN å±‚æ•°ï¼‰ è¾ƒæµ…çš„ GCN èƒ½å¤Ÿæœ‰æ•ˆåœ°èšåˆå…¨å±€çš„ã€è·¨è„‘åŒºçš„åŠŸèƒ½è¿æ¥ä¿¡æ¯ï¼Œèšåˆè¿œè·ç¦»èŠ‚ç‚¹çš„ä¿¡æ¯è€Œä¸è¿‡åº¦å¹³æ»‘ è¾ƒæ·±çš„ GCN èƒ½å¤Ÿæ›´å¥½åœ°èšåˆå±€éƒ¨é‚»åŸŸå†…çš„ä¿¡æ¯ï¼Œåœ¨è„‘åŒºå†…éƒ¨å½¢æˆä¸€è‡´çš„è¡¨å¾ GCN çš„æ·±åº¦è¶Šæ·±ï¼Œå…¶è¾“å‡ºæ‰€ä»£è¡¨çš„ç‰¹å¾é‡‘å­—å¡”å±‚çº§è¶Šé«˜ã€‚ æ®‹å·®è¿æ¥ (Residual) ï¼šé™¤äº†å¹¶è¡Œçš„ GCN åˆ†æ”¯å¤–ï¼ŒRMPG è¿˜åŒ…å«ä¸€ä¸ªå¹¶è¡Œçš„çº¿æ€§æ®‹å·®åˆ†æ”¯ã€‚è¯¥åˆ†æ”¯ç›´æ¥å¯¹åŸå§‹çš„æ—¶åºå›¾ $ G $ ï¼ˆæˆ–è€…å¯¹åº”çš„ç‰¹å¾çŸ©é˜µ $ F $ ï¼‰è¿›è¡Œçº¿æ€§æŠ•å½±ï¼Œä¸ç»è¿‡ä»»ä½•å›¾å·ç§¯ï¼Œä»è€Œä¿ç•™æœ€åŸå§‹çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œä½œä¸ºç‰¹å¾é‡‘å­—å¡”çš„â€œåŸºåº§â€ çº¿æ€§æŠ•å½±å±‚ $ LP(\\cdot) $ å°†æ‰å¹³åŒ–çš„å›¾è¡¨ç¤ºæŠ•å½±åˆ°éšè—åµŒå…¥ $ H_{g}^{i} \\in \\mathbb{R}^{d_{g}} $ å †å æ¥è‡ªä¸åŒå±‚çš„ GCN çš„å¹¶è¡Œè¾“å‡ºï¼Œå¾—åˆ°å¤šé‡‘å­—å¡”è§†å›¾åµŒå…¥ $$ \\{ H_{g}^{i} \\} = \\{ LP^{i}(\\Gamma(\\Phi_{g}^{i}(F, A^{i}))) \\} $$ å…¶ä¸­ $ \\Gamma(\\cdot) $ æ˜¯æ‰å¹³æ“ä½œï¼Œ$ \\{ \\cdot \\} $ æ˜¯å †å æ“ä½œ ç‰¹å¾èåˆä¸ Token ç”Ÿæˆï¼šæœ€ç»ˆï¼Œå¯¹äºå›¾åºåˆ—ä¸­çš„æ¯ä¸€ä¸ªå›¾ $ G_{i} $ï¼Œå…¶æ‰€æœ‰ GCN è§†å›¾çš„è¾“å‡º $ \\{ H_{i}^{g} \\} $ å’Œæ®‹å·®åŸºåº§ $ H_{g-\\text{base}} $â€‹ é€šè¿‡ä¸€ä¸ª mean fusion æ“ä½œåˆå¹¶æˆå½“å‰æ—¶é—´æ­¥ $ i $ çš„æœ€ç»ˆ token $ s_{i} $ $$ s_{i} = \\text{mean}(\\{ H_{g-\\text{base}}, H_{g}^{0}, H_{g}^{1}, \\dots, H_{g}^{i} \\}) $$\né€šè¿‡ RMPG æ¨¡å—ï¼Œè¾“å…¥çš„å›¾åºåˆ— $ G_{T} $ è¢«é«˜æ•ˆåœ°è½¬åŒ–ä¸ºä¸€ä¸ª token åºåˆ— $ S_{T}=\\{ s^{i} \\} \\in \\mathbb{R}^{seq \\times d_{g}} $ ï¼Œè¿™ä¸ªåºåˆ—æ—¢è•´å«äº†æ¯ä¸ªæ—¶åˆ»ä¸°å¯Œçš„å¤šè§†å›¾ã€å¤šå±‚æ¬¡ç©ºé—´ä¿¡æ¯ï¼Œåˆå…·å¤‡äº†é€‚åˆ Transformer å¤„ç†çš„æ ¼å¼\nTemporal Contextual Transformer (TCT) æ ¸å¿ƒï¼šæ¥å—ç”± RMPG ç”Ÿæˆçš„ token åºåˆ— $ S_{T} $ ï¼Œå¹¶åˆ©ç”¨ Transformer çš„ç»“æ„æ¥é«˜æ•ˆæ•æ‰è¿™äº› token ä¹‹é—´çš„æ—¶é—´ä¾èµ–å…³ç³»ï¼›ä¸æ ‡å‡†çš„ Transformer ä¸åŒï¼ŒTCT å¼•å…¥äº†ä¸¤ç§ä¸º EEG æƒ…ç»ªè¯†åˆ«ä»»åŠ¡å®šåˆ¶çš„ Token Mixerï¼Œåˆ†åˆ«ç”¨äºåˆ†ç±»å’Œå›å½’ä»»åŠ¡\nTCT æ¨¡å—ç”±å¤šä¸ªå †å çš„ Transformer Block ç»„æˆï¼Œå¯¹äºè¾“å…¥ token åºåˆ— $ Z^{m} $ ï¼ˆ $ Z^{0} = S_{T} $ ï¼‰ï¼Œæ¯ä¸ª Block çš„è®¡ç®—è¿‡ç¨‹ä¸º $$ Z^{m'} = \\text{TokenMixer}(\\text{Norm}(Z^{m})) + Z^{m} $$ $$ Z^{m+1} = \\text{MLP}(\\text{Norm}(Z^{m'})) + Z^{m'} $$ å…¶ä¸­ $ m $ æ˜¯å±‚çš„ç´¢å¼•ï¼ŒMLP æ˜¯å¸¦ ReLU æ¿€æ´»å‡½æ•°çš„ä¸¤å±‚æ„ŸçŸ¥æœº\n$ \\text{TokenMixer}_{\\text{clas}} $ for Classification Tasks æ—¨åœ¨æ•æ‰éšæ—¶é—´å˜åŒ–çš„é•¿çŸ­æ—¶åºä¸Šä¸‹æ–‡ä¿¡æ¯\nå¤šå¤´è‡ªæ³¨æ„åŠ› (Multi-head Self-Attention, MSA) ï¼šç”¨äºå…¨å±€åœ°å…³æ³¨åºåˆ—ä¸­ä¸æ•´ä½“æƒ…ç»ªçŠ¶æ€é«˜åº¦ç›¸å…³çš„éƒ¨åˆ† $$ \\text{Attn}(Q,K,V) = \\text{softmax}\\left( \\frac{QK^{T}}{\\sqrt{ d }} \\right)V $$ å¹¶è¡Œåº”ç”¨å¤šä¸ªæ³¨æ„åŠ›å¤´ï¼ˆæ¯ä¸ªå¤´æœ‰ç‹¬ç«‹çš„ $ LP_h(\\cdot) $ æ¥ç”Ÿæˆ $ Q, K, V $ï¼‰ï¼Œç„¶åå°†æ‰€æœ‰å¤´çš„è¾“å‡ºæ‹¼æ¥ï¼š$$ \\text{MSA}(S_{T}) = \\text{Concat}(\\text{Attn}(LP_0(S_{T})), ..., \\text{Attn}(LP_{n_{\\text{head}}-1}(S_{T}))) $$ å…¶ä¸­ $ S_{T} $ æ˜¯ token åºåˆ—ï¼Œ$ n_{\\text{head}} $ æ˜¯æ³¨æ„åŠ›å¤´çš„æ•°é‡ çŸ­æœŸèšåˆå±‚ (Short-Time Aggregation, STA) ï¼š åŸºäºâ€œæƒ…ç»ªçŸ­æœŸè¿ç»­è€Œé•¿æœŸå˜åŒ–â€çš„å…ˆéªŒçŸ¥è¯†ï¼ŒSTA åœ¨ MSA ä¹‹ååº”ç”¨æ¥å­¦ä¹ çŸ­æœŸçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ é¦–å…ˆå¯¹ MSA çš„è¾“å‡º $ H_{\\text{attn}} \\in \\mathbb{R}^{n_{\\text{head}} \\times \\text{seq} \\times d_{\\text{head}}} $ åº”ç”¨ä¸€ä¸ªå¸¦æœ‰æ¯”ä¾‹å› å­ $ \\alpha $ çš„ Dropout å±‚ $ \\text{dp}(\\alpha) $ æ¥ç€ï¼Œé€šè¿‡ Conv2D èšåˆ $ n_{\\text{anchor}} $ ä¸ªæ—¶åºè¿‘é‚» Conv2D çš„å·ç§¯æ ¸ $ K_{\\text{cnn}} $ çš„å°ºå¯¸ä¸º $ (n_{\\text{anchor}}, 1) $ï¼Œæ­¥é•¿ä¸º $ (1,1) $ æœ€åï¼Œå·ç§¯çš„è¾“å‡ºä¼šè¢« Reshape å¹¶è¿›è¡Œçº¿æ€§æŠ•å½±ï¼ˆ$ W_{\\text{sta}} $ï¼‰ å¯ä»¥æè¿°ä¸º $$ \\text{STA}(H_{\\text{attn}}) = \\text{Reshape}(\\text{Conv2D}(\\text{dp}(H_{\\text{attn}}), K_{\\text{cnn}})) W_{\\text{sta}} $$ $ \\text{Reshape}(\\cdot) $ å°†ç»´åº¦ä» $ (n_{\\text{head}},\\text{seq},d_{\\text{head}}) $ è½¬æ¢ä¸º $ (\\text{seq}, n_{\\text{head}} \\cdot d_{\\text{head}}) $ ï¼Œ $ W_{\\text{sta}} \\in \\mathbb{R}^{n_{\\text{head}} \\cdot d_{\\text{head}} \\times d_g} $ æ˜¯æŠ•å½±æƒé‡çŸ©é˜µ $ \\text{TokenMixer}_{\\text{Clas}} $ æœ€ç»ˆç”±ä¸Šè¿°ä¸¤ä¸ªæ¨¡å—ä¸²è”æ„æˆ $$ \\text{TokenMixer}_{\\text{clas}}(S_{T}) = \\text{STA}(\\text{MSA}(S_{T})) $$ $ \\text{TokenMixer}_{\\text{regr}} $ for Regression Tasks æ—¨åœ¨é¢„æµ‹åºåˆ—ä¸­æƒ…ç»ªçŠ¶æ€çš„è¿ç»­å˜åŒ–\nä¸åŒäºåˆ†ç±»ä»»åŠ¡ï¼šåˆ†ç±»ä»»åŠ¡çš„ç›®æ ‡é€šå¸¸æ˜¯ä»æ•´ä¸ªåºåˆ—ä¸­æå–å‡ ä¸ªæ ¸å¿ƒç‰¹å¾æ¥åˆ¤æ–­æ•´ä½“æƒ…ç»ªçŠ¶æ€ï¼Œè¿™é€šè¿‡ MSA èšç„¦äºé‡è¦éƒ¨åˆ†æ˜¯æœ‰æ•ˆçš„ï¼›ç„¶è€Œå›å½’ä»»åŠ¡éœ€è¦æ¨¡å‹å¯¹åºåˆ—ä¸­æ¯ä¸ªæ—¶æ­¥çš„è¿ç»­æƒ…ç»ªå˜åŒ–è¿›è¡Œé¢„æµ‹ï¼Œå› æ­¤ä¸ä½¿ç”¨å…¨å±€çš„ MSAï¼Œè€Œæ˜¯é‡‡ç”¨äº†ä¸€ç§åŸºäº RNN çš„æ··åˆå™¨ï¼ˆ RNN family ï¼‰ RNN Mixer ï¼š RNN ç»“æ„å¤©ç„¶é€‚åˆå¤„ç†è¿ç»­åºåˆ—çš„æ¼”å˜è¿‡ç¨‹ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°å»ºæ¨¡æƒ…ç»ªå€¼çš„å¹³æ»‘å˜åŒ– ç»éªŒæ€§é€‰æ‹©çš„ä¸¤å±‚åŒå‘ GRU (bi-directional GRU)Â ä½œä¸º $ \\text{TokenMixer}_{\\text{regr}} $ ï¼Œè¾“å‡ºé•¿åº¦ä¸º $ 2 \\times d_{\\text{head}} $ è®¡ç®—è¿‡ç¨‹ä¸º $$ \\text{TokenMixer}_{\\text{regr}}(S_T) = \\text{RNNs}(\\text{LP}(S_T)) $$ å…¶ä¸­ $ LP(S_{T}) = S_{T}W_{v} $ ï¼ŒæŠŠ token åºåˆ—æŠ•å½±ä¸º $ V $ å€¼ TSO Module å¤´éƒ¨æ¥æ”¶æ¥è‡ªä¸åŒ Token Mixer çš„è¾“å‡ºï¼šç”¨äºåˆ†ç±»çš„ $ S_{\\text{clas}} $ å’Œç”¨äºå›å½’çš„ $ S_{\\text{regr}} $\nåˆ†ç±»ä»»åŠ¡ï¼šå¯¹æ‰€æœ‰ token è¿›è¡Œ mean fusion ï¼Œå†é€šè¿‡çº¿æ€§å±‚å¾—åˆ°æœ€ç»ˆ logits $$ \\hat{Y}_{\\text{clas}} = \\text{mean}(S_{\\text{clas}})W_{\\text{clas}} + b_{\\text{clas}} $$ å…¶ä¸­ $ S_{\\text{clas}} \\in \\mathbb{R}^{\\text{seq} \\times d_{\\text{head}}} $ ï¼Œ$ W_{\\text{clas}} \\in \\mathbb{R}^{d_{\\text{head}} \\times d_{\\text{class}}} $ ï¼Œ$ b_{\\text{clas}} \\in \\mathbb{R}^{n_{\\text{class}}} $ å›å½’ä»»åŠ¡ï¼šç›´æ¥å°†æ¯ä¸ªæ—¶é—´æ­¥çš„ token ç‰¹å¾é€šè¿‡çº¿æ€§å±‚ï¼Œå¾—åˆ°å¯¹åº”æ¯ä¸ªæ—¶åˆ»çš„å›å½’å€¼ $$ \\hat{Y}_{\\text{regr}} = S_{\\text{regr}}W_{\\text{regr}} + b_{\\text{regr}} $$ å…¶ä¸­ $ S_{\\text{regr}} \\in \\mathbb{R}^{\\text{seq} \\times 2\\cdot d_{\\text{head}}} $ ï¼ˆåŒå‘ï¼‰ï¼Œ$ W_{\\text{regr}} \\in \\mathbb{R}^{2\\cdot d_{\\text{head}} \\times 1} $ ï¼Œ$ b_{\\text{regr}} \\in \\mathbb{R} $ Experiment Datasets ä½¿ç”¨ SEED, THU-EP, FACED, MAHNOB-HCI å››ä¸ªå…¬å¼€æ•°æ®é›†\nå…¶ä¸­ SEED æ•°æ®é›†ä½¿ç”¨äº† 0.3-50 Hz çš„å¸¦é€šæ»¤æ³¢\nEEG-Temporal-Graph é•¿ç‰‡æ®µï¼šçª—å£é•¿åº¦ $ l=20\\,\\mathrm{s} $ ï¼ˆå³ $ 20 \\times f_{s} $ ï¼‰ï¼Œæ­¥é•¿ $ s=4\\,\\mathrm{s} $ å­ç‰‡æ®µï¼š å¯¹äº SEED å’Œ THU-EPï¼š $ l'=2\\,\\mathrm{s},s'=0.5\\,\\mathrm{s} $ å¯¹äº FACEDï¼š $ l'=4\\,\\mathrm{s},s'=1\\,\\mathrm{s} $ Settings æ•°æ®åˆ’åˆ†ï¼š SEEDï¼šé‡‡ç”¨ç•™ä¸€è¢«è¯•äº¤å‰éªŒè¯ï¼Œæ¯æ¬¡è¿­ä»£ä¸€ä¸ªè¢«è¯•çš„æ•°æ®ä½œä¸ºæµ‹è¯•é›†ï¼Œå‰©ä½™æ•°æ®ä¸­ 80% ä½œä¸ºè®­ç»ƒé›†ï¼Œ20% ä½œä¸ºéªŒè¯é›† THU-EP å’Œ FACEDï¼šé‡‡ç”¨ç•™ $ n $ è¢«è¯•äº¤å‰éªŒè¯ï¼Œå…¶ä¸­ $ n_{\\text{THU-EP}}=8,n_{\\text{FACED}}=12 $ ï¼Œè®­ç»ƒæ•°æ®ä¸­ 10% ä½œä¸ºéªŒè¯é›† åˆ†ç±»ä»»åŠ¡ï¼šå¯¹ SEEDã€THU-EP å’Œ FACED è¿›è¡Œç§¯æ/æ¶ˆææƒ…ç»ªçš„äºŒåˆ†ç±»ï¼ŒTHU-EP å’Œ FACED çš„æ•ˆä»·åˆ†æ•°é€šè¿‡é˜ˆå€¼ 3.0 åˆ’åˆ†ä¸ºé«˜/ä½æ•ˆä»· å›å½’ä»»åŠ¡ï¼šMAHNOB-HCI å¹¶è¿›è¡Œ LOSO éªŒè¯ Evaluation Metrics Classfication Accuracyï¼š$$ \\text{Accuracy} = \\frac{\\text{TP + TN}}{\\text{TP + FP + TN + FN}} $$ F1 Scoreï¼š$$ \\text{F1} = 2 \\times \\frac{\\text{Precision} \\times \\text{Recall}}{\\text{Precision + Recall}} = \\frac{\\text{TP}}{\\text{TP} + \\frac{1}{2}(\\text{FP} + \\text{FN})} $$ å…¶ä¸­ $ \\text{TP} $ è¡¨ç¤ºçœŸé˜³æ€§ï¼Œ$ \\text{TN} $ è¡¨ç¤ºçœŸé˜´æ€§ï¼Œ$ \\text{FP} $ è¡¨ç¤ºå‡é˜³æ€§ï¼Œ$ \\text{FN} $ è¡¨ç¤ºå‡é˜´æ€§\nRegression ç»™å®šé¢„æµ‹å€¼ $ \\hat{y} $ å’Œè¿ç»­æ ‡ç­¾ $ y $ ï¼š\nå‡æ–¹æ ¹è¯¯å·® (RMSE) ï¼š$$ \\text{RMSE} = \\sqrt{\\frac{1}{N} \\sum_{i=0}^{N-1} (\\hat{y}_i - y_i)^2} $$ çš®å°”é€Šç›¸å…³ç³»æ•° (PCC) ï¼š$$ \\text{PCC} = \\frac{\\sigma_{\\hat{y}y}}{\\sigma_{\\hat{y}} \\sigma_y} = \\frac{\\sum_{i=0}^{N-1} (\\hat{y}_i - \\mu_{\\hat{y}})(\\hat{y}_i - \\mu_y)}{\\sqrt{\\sum_{i=0}^{N-1} (\\hat{y}_i - \\mu_{\\hat{y}})^2} \\sqrt{\\sum_{i=0}^{N-1} (y_i - \\mu_y)^2}} $$ ä¸€è‡´æ€§ç›¸å…³ç³»æ•° (CCC) ï¼š$$ \\text{CCC} = \\frac{2\\sigma_{\\hat{y}y}}{\\sigma^2_{\\hat{y}} + \\sigma^2_y + (\\mu_{\\hat{y}} - \\mu_y)^2} $$ å…¶ä¸­ $ N $ æ˜¯å‘é‡ä¸­çš„å…ƒç´ æ•°é‡ï¼Œ$ \\sigma_{\\hat{y}y} $ æ˜¯åæ–¹å·®ï¼Œ$ \\sigma_{\\hat{y}} $ å’Œ $ \\sigma_y $ æ˜¯æ ‡å‡†å·®ï¼Œ$ \\mu_{\\hat{y}} $ å’Œ $ \\mu_y $ æ˜¯å‡å€¼\nImplementation Details æ¨¡å‹çš„ä¸‰ç§å˜ä½“ï¼š Analyses Classification SEEDï¼š EmT-D è¡¨ç°æœ€ä½³ï¼ŒEmT-B å’Œ EmT-S è¡¨ç°ä¹Ÿè‰¯å¥½ï¼ŒRGNN è¡¨ç°ç¬¬äºŒä½³ ä½¿ç”¨ç‰¹å¾ä½œä¸ºè¾“å…¥çš„æ¨¡å‹é€šå¸¸ä¼˜äºç›´æ¥ä½¿ç”¨ EEG ä¿¡å·ä½œä¸ºè¾“å…¥çš„æ¨¡å‹ï¼Œä»æ—¶åºç‰¹å¾è€Œéç›´æ¥ç‰¹å¾å­¦ä¹ é€šå¸¸èƒ½å–å¾—æ›´å¥½çš„æ€§èƒ½ï¼ˆRGNN é™¤å¤–ï¼‰ï¼Œè¿™è¡¨æ˜äº†å­¦ä¹ æ—¶åºä¸Šä¸‹æ–‡ä¿¡æ¯çš„æœ‰æ•ˆæ€§ï¼ŒEmT å€ŸåŠ©åŸºäº GCN çš„æ¨¡å—ï¼Œèƒ½æ›´å¥½åœ°å­¦ä¹ ç©ºé—´ä¿¡æ¯ THU-EP / FACEDï¼š THU-EPï¼šEmT-B å–å¾—äº†æœ€ä½³ F1 åˆ†æ•°ï¼ŒConformer å–å¾—äº†æœ€ä½³ ACC FACEDï¼šEmT-B å–å¾—äº†ç¬¬äºŒä½³ ACC å’Œæœ€ä½³ F1 åˆ†æ•° ç”±äºç±»ä¸å¹³è¡¡ï¼ŒF1 åˆ†æ•°æ¯” ACC æ›´é‡è¦ï¼ŒEmT-B åœ¨è¿™ä¸¤ä¸ªæ•°æ®é›†ä¸Šå‡å–å¾—äº†æœ€é«˜ F1 åˆ†æ•° ä¸ SEED ä¸åŒï¼Œç›´æ¥ä½¿ç”¨ EEG ä½œä¸ºè¾“å…¥çš„ baseline æ¨¡å‹è¡¨ç°æ›´å¥½ï¼Œè¿™å¯èƒ½å› ä¸ºè¿™ä¸¤ä¸ªæ•°æ®é›†çš„è¢«è¯•äººæ•°æ›´å¤š Featuresï¼š SEED (62 channelsï¼Œ15 subjects) ï¼šEmT-D (8 å±‚) è¡¨ç°æœ€ä½³ï¼Œè¯´æ˜ Transformer å±‚æ•°è¶Šå¤šï¼Œå­¦åˆ°çš„ç©ºé—´ä¿¡æ¯è¶Šä¸°å¯Œ THU-EP å’Œ FACED (32 channelsï¼Œmore subjects) ï¼šEmT-B (4 å±‚) è¡¨ç°æ›´å¥½ï¼Œé€šé“æ•°å°‘ä¸”è¢«è¯•é—´å˜å¼‚æ€§å¤§æ—¶ï¼Œæ›´æ·±çš„æ¨¡å‹ï¼ˆEmT-Dï¼‰å®¹æ˜“è¿‡æ‹Ÿåˆ Regression åœ¨ MAHNOB-HCI æ•°æ®é›†ä¸Šï¼ŒEmT-Regr (LP+LSTM) å–å¾—äº†æœ€ä½çš„ RMSEï¼Œè€Œ EmT-Regr (LP+GRU) å–å¾—äº†æœ€ä½³çš„ PCC å’Œ CCC ä½¿ç”¨ MSA ä½œä¸º Token Mixer æ—¶ï¼Œæ¨¡å‹æ€§èƒ½æ€¥å‰§ä¸‹é™ï¼Œç”šè‡³ä½äºæ‰€æœ‰åŸºçº¿æ¨¡å‹ è¿™è¡¨æ˜å¯¹äºå›å½’ä»»åŠ¡ï¼Œèåˆæ‰€æœ‰ç‰‡æ®µçš„ä¿¡æ¯è‡³å…³é‡è¦ï¼Œè€Œ RNN çš„é¡ºåºä¿¡æ¯èåˆèƒ½åŠ›æ¯” MSA æ›´é€‚åˆå»ºæ¨¡è¿ç»­çš„æƒ…ç»ªå˜åŒ– Ablation Study Effect of EEG Features Effect of The Depth and Width of GCNs in RMPG Depthï¼šå¢åŠ  GCN å±‚çš„æ•°é‡ä¼šå¯¼è‡´æ€§èƒ½æ˜¾è‘—ä¸‹é™ï¼Œè¿™ä¸æ›´æ·± GCN ä¸­å­˜åœ¨çš„è¿‡å¹³æ»‘é—®é¢˜ä¸€è‡´ Widthï¼šå®½åº¦ä» 8 å¢åŠ åˆ° 32 æ—¶ï¼Œæ€§èƒ½å‘ˆæ­£ç›¸å…³ï¼›å½“å®½åº¦è¿›ä¸€æ­¥å¢åŠ æ—¶ï¼Œæ€§èƒ½ä¸‹é™ï¼Œè¿™å¯èƒ½æ˜¯ç”±æ›´å¤§çš„æ¨¡å‹å°ºå¯¸å¯¼è‡´çš„è¿‡æ‹Ÿåˆ Effect of The Number of TCT Blocks Classfication (SEED) ï¼šTCT å—çš„æ•°é‡ä» 2 å¢åŠ åˆ° 8 æ—¶ï¼ŒACC å’Œ F1 åˆ†æ•°å‡æ˜¾è‘—æé«˜ï¼Œè¿™è¡¨æ˜å¢åŠ  TCT å—æ•°èƒ½å¢å¼ºæ¨¡å‹æ•æ‰æ—¶åºä¸Šä¸‹æ–‡ä¿¡æ¯çš„èƒ½åŠ›ï¼Œä»è€Œæå‡åˆ†ç±»æ€§èƒ½ Regression (MAHNOB-HCI) ï¼šTCT å—çš„æ•°é‡å¯¹æ€§èƒ½æŒ‡æ ‡å‡ ä¹æ²¡æœ‰å½±å“ Visualization Learned Connections åœ¨ SEED æ•°æ®é›†ä¸Šå­¦ä¹ åˆ°çš„ä¸¤ç§ä¸åŒè¿æ¥æ¨¡å¼çš„å¯è§†åŒ–è¯æ® åœ¨ SEED æ•°æ®é›†ä¸Šï¼Œä¸¤ä¸ªå¯å­¦ä¹ çš„é‚»æ¥çŸ©é˜µæ­ç¤ºäº†æƒ…ç»ªè®¤çŸ¥è¿‡ç¨‹ä¸­ä¸åŒçš„è¿æ¥æ¨¡å¼ï¼š\n(a) ä¸­ä¸»è¦å…³æ³¨é¢å¶ã€é¡¶å¶å’Œé¢å¶åŒºåŸŸä¹‹é—´çš„è¿æ¥ï¼Œè¿™äº›åŒºåŸŸä¸å¿ƒç†æ³¨æ„åŠ›å¯†åˆ‡ç›¸å…³ (b) ä¸­åˆ™åŒ…æ‹¬é¢å¶ã€é¢å¶å’Œé¡¶å¶åŒºåŸŸä¹‹é—´çš„äº’åŠ¨ï¼ˆä¸æƒ…ç»ªç›¸å…³ï¼‰ï¼Œä»¥åŠæ•å¶å’Œé¡¶å¶åŒºåŸŸçš„äº’åŠ¨ï¼ˆä¸è§†è§‰è¿‡ç¨‹ç›¸å…³ï¼Œå› ä¸ºåˆºæ¿€ä¸ºè§†é¢‘ï¼‰ Learned Temporal Contextual Information Classfication (FACED) Regression åˆ†ç±»ä»»åŠ¡åœ¨ TCT å—ä¹‹å‰ï¼Œç‰¹å¾éšæ—¶é—´å˜åŒ–ï¼ŒTCT å—ä¹‹åï¼Œæ¿€æ´»å˜å¾—æ›´åŠ ä¸€è‡´ï¼›è¿™å¯èƒ½æ˜¯å› ä¸ºè‡ªæ³¨æ„åŠ›æœºåˆ¶å…³æ³¨ä¸æ•´ä½“æƒ…ç»ªçŠ¶æ€é«˜åº¦ç›¸å…³çš„éƒ¨åˆ†ï¼Œè€Œ STA å±‚é€šè¿‡èšåˆé‚»è¿‘çš„æ—¶åºä¿¡æ¯æ¥å¹³æ»‘æ³¢åŠ¨ å›å½’ä»»åŠ¡ï¼šç‰¹å¾ç©ºé—´ä¹Ÿæ˜¾ç¤ºå‡ºæ—¶åºå˜åŒ–ï¼›ä¸åˆ†ç±»ä¸åŒï¼Œå›å½’ç‰¹å¾å¹¶éç®€å•å¹³æ»‘ï¼Œå½¢æˆäº†æ›´å¤æ‚çš„è¡¨ç¤º æ€»ç»“ï¼šTCT å—å¤„ç†åˆ†ç±»å’Œå›å½’ä»»åŠ¡çš„æ–¹å¼ä¸åŒï¼šåˆ†ç±»ä¸­ï¼Œç‰¹å¾è¢«å¹³æ»‘ä»¥å¢å¼ºå¯åˆ†ç¦»æ€§ï¼›å›å½’ä¸­ï¼ŒRNN Token Mixer ä¿ç•™äº†æ—¶åºå˜åŒ–ï¼Œä»è€Œå®ç°è¿ç»­æƒ…ç»ªé¢„æµ‹ ","permalink":"https://diefish1024.github.io/posts/literature-notes/emt/","summary":"\u003ch2 id=\"abstract\"\u003eAbstract\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eé—®é¢˜\u003c/strong\u003eï¼šç°æœ‰ EEG æƒ…ç»ªè¯†åˆ«æ–¹æ³•å¯¹é•¿æœŸä¸Šä¸‹æ–‡ä¿¡æ¯å…³æ³¨ä¸è¶³ï¼Œå¯¼è‡´è·¨è¢«è¯•æ³›åŒ–èƒ½åŠ›å‡å¼±\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ–¹æ¡ˆ\u003c/strong\u003eï¼šæå‡º \u003cstrong\u003eEmotion Transformer (EmT)\u003c/strong\u003e ï¼Œä¸º Graph-Transformer æ··å’Œæ¶æ„\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eæ ¸å¿ƒæ¨¡å—\u003c/strong\u003eï¼š\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eTGC\u003c/strong\u003eï¼šå°† EEG ä¿¡å·è½¬æ¢ä¸ºæ—¶åºå›¾åºåˆ—\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eRMPG\u003c/strong\u003eï¼šä½¿ç”¨æ®‹å·®å¤šè§†å›¾é‡‘å­—å¡” GCNï¼Œå­¦ä¹ åŠ¨æ€ã€å¤šå°ºåº¦çš„ç©ºé—´è¿æ¥æ¨¡å¼ï¼Œç”Ÿæˆ tokenï¼ˆæ ¸å¿ƒï¼‰\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eTCT\u003c/strong\u003eï¼šä½¿ç”¨ä»»åŠ¡è‡ªé€‚åº”çš„ Transformerï¼Œå­¦ä¹  token åºåˆ—ä¸Šä¸‹æ–‡ï¼ˆæ ¸å¿ƒï¼‰\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eTSO\u003c/strong\u003eï¼šè¾“å‡ºåˆ†ç±»/å›å½’ç»“æœ\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæˆæœ\u003c/strong\u003eï¼šåœ¨å¤šä¸ªå…¬å¼€æ•°æ®é›†çš„å¹¿ä¹‰è·¨è¢«è¯•ä»»åŠ¡ä¸Šé¢è¶…è¿‡äº† baseline\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"introduction--related-work\"\u003eIntroduction \u0026amp; Related Work\u003c/h2\u003e\n\u003cp\u003eä¸ºä»€ä¹ˆ EEG éš¾ä»¥ä½¿ç”¨è·¨è¢«è¯• (cross-subject) çš„åœºæ™¯ï¼Ÿ\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eä¸ªä½“å·®å¼‚\u003c/strong\u003eï¼šä¸åŒè¢«è¯•ç”Ÿç†ç»“æ„å’Œè®¤çŸ¥ç­–ç•¥å·®å¼‚ï¼Œå¯¼è‡´ EEG æ¨¡å¼ä¸åŒ\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eä½ä¿¡å™ªæ¯”\u003c/strong\u003eï¼šEEG ä¿¡å·å®¹æ˜“å—åˆ°å¤–æºå™ªå£°å¹²æ‰°ï¼ˆè‚Œç”µã€çœ¼ç”µâ€¦â€¦ï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç›®æ ‡æ˜¯å­¦ä¹ ä¸€ç§\u003cstrong\u003eè·¨è¢«è¯•å…±äº«\u003c/strong\u003eã€å…·æœ‰\u003cstrong\u003eæ³›åŒ–èƒ½åŠ›\u003c/strong\u003eçš„æƒ…ç»ªè¡¨å¾\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"gpaph-neural-networks\"\u003eGpaph Neural Networks\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eæ ¸å¿ƒæ€æƒ³\u003c/strong\u003eï¼šEEG æ•°æ®å…·æœ‰éæ¬§å›¾ç»“æ„ï¼Œé€‚åˆä½¿ç”¨ GNN æ¥å¤„ç†\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eä»£è¡¨å·¥ä½œ\u003c/strong\u003eï¼š\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eChebyNet\u003c/strong\u003eï¼šä½¿ç”¨åˆ‡æ¯”é›ªå¤«å¤šé¡¹å¼è¿‘ä¼¼å…‰è°±æ»¤æ³¢ï¼ŒEmT æ¨¡å‹ä¸­é‡‡ç”¨å…¶ä½œä¸º GCN å±‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eGCN\u003c/strong\u003eï¼šé€šè¿‡å±€éƒ¨ä¸€é˜¶èšåˆè¿‘ä¼¼å…‰è°±æ»¤æ³¢\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDGCNN / RGNN\u003c/strong\u003eï¼šä½¿ç”¨ GNNs æå– EEG ç©ºé—´ä¿¡æ¯ï¼›ä¾èµ–å•ä¸€çš„é‚»æ¥çŸ©é˜µï¼Œå¿½ç•¥æ—¶åºä¸Šä¸‹æ–‡ï¼Œå…·æœ‰\u003cstrong\u003eå±€é™æ€§\u003c/strong\u003eï¼›è€Œ EmT é€šè¿‡\u003cstrong\u003eå¤šè§†å›¾å¯å­¦ä¹ é‚»æ¥çŸ©é˜µ\u003c/strong\u003eå’Œ\u003cstrong\u003eæ—¶åºå›¾\u003c/strong\u003eæ¥å¼¥è¡¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3 id=\"temporal-context-learning\"\u003eTemporal Context Learning\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eæ ¸å¿ƒç†å¿µ\u003c/strong\u003e: æƒ…ç»ªæ˜¯è¿ç»­è®¤çŸ¥è¿‡ç¨‹ï¼ŒEEG ä¿¡å·ä¸­åµŒå…¥æ—¶åºä¸Šä¸‹æ–‡ä¿¡æ¯\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eä»£è¡¨å·¥ä½œ\u003c/strong\u003eï¼š\n\u003cul\u003e\n\u003cli\u003eLSTM / TCN / TESANet / Conformer / AMDET\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå±€é™æ€§\u003c/strong\u003eï¼šè¿™äº›æ–¹æ³•é€šå¸¸ä»æ‰å¹³åŒ–çš„ EEG ç‰¹å¾å‘é‡å­¦ä¹ ï¼Œå¯èƒ½\u003cstrong\u003eæœªèƒ½æœ‰æ•ˆå­¦ä¹ ç©ºé—´å…³ç³»\u003c/strong\u003eï¼›EmT åˆ™é€šè¿‡å¹¶è¡Œ GCN å’Œ STA å±‚æ›´æœ‰æ•ˆåœ°æ•æ‰æ—¶ç©ºä¿¡æ¯\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3 id=\"eeg-emotion-recognition\"\u003eEEG Emotion Recognition\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eæ ¸å¿ƒç†å¿µ\u003c/strong\u003eï¼šEEG æƒ…ç»ªè¯†åˆ«é¢ä¸´ä¸ªä½“å·®å¼‚å¤§ã€ä¿¡å™ªæ¯”ä½ç­‰æŒ‘æˆ˜ï¼Œéœ€æå–å…‰è°±ã€ç©ºé—´ã€æ—¶åºç‰¹å¾\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eä»£è¡¨å·¥ä½œ\u003c/strong\u003eï¼š\n\u003cul\u003e\n\u003cli\u003eGCB-Net / TSception\u003c/li\u003e\n\u003cli\u003eå±€é™æ€§ï¼šæ²¡æœ‰å…³æ³¨é•¿æ—¶åºä¸Šä¸‹æ–‡ä¿¡æ¯\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"method\"\u003eMethod\u003c/h2\u003e\n\u003cp\u003eEmT æ˜¯ä¸€ä¸ªç«¯åˆ°ç«¯çš„æ¡†æ¶ï¼ŒåŒ…å«å››å¤§æ¨¡å—ï¼š\u003c/p\u003e","title":"EmT"},{"content":"æ¨ç†æ•ˆç‡å¯¹äº llm æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„é—®é¢˜ã€‚å½“æ¨¡å‹ç”Ÿæˆæ–‡æœ¬æ—¶ï¼Œå°¤å…¶æ˜¯ä»¥è‡ªå›å½’æ–¹å¼é€è¯ç”Ÿæˆæ—¶ï¼Œæ•ˆç‡ç“¶é¢ˆä¼šå˜å¾—éå¸¸æ˜æ˜¾ã€‚KV Cache å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜è€Œè¯ç”Ÿçš„æŠ€æœ¯ã€‚\n1. What is KV Cache? KV Cacheï¼Œå…¨ç§° Key-Value Cacheï¼Œæ˜¯ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºåŠ é€Ÿ Transformer æ¶æ„åœ¨è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹ä¸­çš„æ¨ç†é€Ÿåº¦ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ç¼“å­˜å¹¶é‡ç”¨åœ¨æ³¨æ„åŠ›æœºåˆ¶ä¸­è®¡ç®—å¾—åˆ°çš„ Key (K) å’Œ Value (V) å‘é‡ã€‚\n2. Transformer Attention Mechanism Review è¦ç†è§£ KV Cacheï¼Œé¦–å…ˆéœ€è¦å¯¹ Transformer æ¶æ„ä¸­çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶æœ‰ä¸€ä¸ªåŸºæœ¬è®¤è¯†ã€‚è‡ªæ³¨æ„åŠ›æœºåˆ¶å…è®¸æ¨¡å‹åœ¨å¤„ç†åºåˆ—ä¸­çš„æŸä¸ªè¯æ—¶ï¼Œè€ƒè™‘åºåˆ—ä¸­æ‰€æœ‰å…¶ä»–è¯çš„é‡è¦æ€§ã€‚\næ¯ä¸ªè¾“å…¥ tokenï¼ˆè¯æˆ–å­è¯ï¼‰åœ¨è¿›å…¥æ³¨æ„åŠ›å±‚æ—¶ï¼Œéƒ½ä¼šè¢«è½¬æ¢æˆä¸‰ä¸ªä¸åŒçš„å‘é‡ï¼š\nQ å‘é‡ï¼šä»£è¡¨å½“å‰ token çš„â€œæŸ¥è¯¢â€ä¿¡æ¯ K å‘é‡ï¼šä»£è¡¨æ‰€æœ‰ token çš„â€œé”®â€ä¿¡æ¯ï¼Œç”¨äºä¸ Query è¿›è¡ŒåŒ¹é… V å‘é‡ï¼šä»£è¡¨æ‰€æœ‰ token çš„â€œå€¼â€ä¿¡æ¯ï¼Œç”¨äºåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°æœ€ç»ˆçš„è¾“å‡º è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„è®¡ç®—è¿‡ç¨‹ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š\nè®¡ç®— Query ä¸æ‰€æœ‰ Key çš„ç‚¹ç§¯ï¼Œå¾—åˆ°æ³¨æ„åŠ›åˆ†æ•° å°†æ³¨æ„åŠ›åˆ†æ•°è¿›è¡Œç¼©æ”¾ï¼Œé™¤ä»¥ $ \\sqrt{d_k} $ï¼ˆ$ d_k $ æ˜¯ Key å‘é‡çš„ç»´åº¦) å¯¹ç¼©æ”¾åçš„åˆ†æ•°è¿›è¡Œ Softmaxï¼Œå°†å…¶è½¬æ¢ä¸ºæ³¨æ„åŠ›æƒé‡ï¼Œè¡¨ç¤ºæ¯ä¸ª token å¯¹å½“å‰ token çš„é‡è¦æ€§ å°†æ³¨æ„åŠ›æƒé‡ä¸ Value å‘é‡è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°å½“å‰ token çš„æ³¨æ„åŠ›è¾“å‡º å…¬å¼ä¸ºï¼š $$ \\text{Attention}(Q, K, V) = \\text{softmax}\\left(\\frac{QK^T}{\\sqrt{d_k}}\\right)V $$ å…¶ä¸­çŸ©é˜µ $ Q,K,V \\in \\mathbb{R}^{L \\times d} $ ï¼Œ$ L $ ä¸ºå½“å‰ä¸Šä¸‹æ–‡é•¿åº¦\nï¼ˆå¤„äºç®€æ´æ€§çš„è€ƒè™‘ï¼Œå¿½ç•¥äº† Causal Mask ï¼Œå®é™…ä¸Š $ QK^{T} $ åº”è¯¥ Mask æˆä¸‹ä¸‰è§’çŸ©é˜µæ¥å¼ºåˆ¶ä¸èƒ½çœ‹åˆ°åºåˆ—æœªæ¥çš„ä¿¡æ¯ï¼‰\n3. The Problem KV Cache Solves åœ¨å¤§å‹è¯­è¨€æ¨¡å‹ä¸­ï¼Œå½“æ¨¡å‹ä»¥è‡ªå›å½’æ–¹å¼ç”Ÿæˆæ–‡æœ¬æ—¶ï¼ˆæ¯æ¬¡ç”Ÿæˆä¸€ä¸ªæ–° tokenï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°è¾“å…¥åºåˆ—ä¸­ï¼Œç„¶åæ ¹æ®æ•´ä¸ªåºåˆ—ç”Ÿæˆä¸‹ä¸€ä¸ª tokenï¼‰ï¼Œä¼šé‡åˆ°ä¸€ä¸ªæ•ˆç‡é—®é¢˜ï¼š\nå‡è®¾æˆ‘ä»¬è¦ç”Ÿæˆâ€œä¸­åäººæ°‘â€\nè¾“å…¥ï¼šâ€œä¸­â€ æ¨¡å‹è®¡ç®—â€œä¸­â€çš„ $ Q, K, V $ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œåâ€ è¾“å…¥ï¼šâ€œä¸­åâ€ æ¨¡å‹å†æ¬¡è®¡ç®—â€œä¸­â€å’Œâ€œåâ€çš„ $ Q, K, V $ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œäººâ€ è¾“å…¥ï¼šâ€œä¸­åäººâ€ æ¨¡å‹å†æ¬¡è®¡ç®—â€œä¸­â€ã€â€œåâ€å’Œâ€œäººâ€çš„ $ Q, K, V $ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œæ°‘â€ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ¯ä¸€æ­¥ç”Ÿæˆæ–° token æ—¶ï¼Œéƒ½éœ€è¦é‡æ–°è®¡ç®—ä¹‹å‰å·²ç»å¤„ç†è¿‡çš„æ‰€æœ‰ token çš„ $ K $ å’Œ $ V $ å‘é‡ã€‚è¿™ç§é‡å¤è®¡ç®—åœ¨åºåˆ—è¾ƒé•¿æ—¶ä¼šæ¶ˆè€—å¤§é‡çš„è®¡ç®—èµ„æºå’Œæ—¶é—´ï¼Œæ•ˆç‡ä½ä¸‹ã€‚\n4. How KV Cache Works æ ¹æ®ä¸Šé¢åˆ†æå¾—åˆ°çš„é—®é¢˜ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ° KV Cache çš„æ ¸å¿ƒæ€æƒ³ï¼šå°†å·²ç»è®¡ç®—è¿‡çš„ Key å’Œ Value å‘é‡ç¼“å­˜èµ·æ¥ï¼Œåœ¨åç»­çš„ç”Ÿæˆæ­¥éª¤ä¸­ç›´æ¥é‡ç”¨ï¼Œè€Œä¸æ˜¯é‡æ–°è®¡ç®—ã€‚\nä»¥ç”Ÿæˆâ€œä¸­åäººæ°‘â€ä¸ºä¾‹ï¼Œä½¿ç”¨ KV Cache çš„æµç¨‹å¦‚ä¸‹ï¼š\nè¾“å…¥ï¼šâ€œä¸­â€ è®¡ç®—â€œä¸­â€çš„ $ K_1, V_1 $ å°† $ K_1, V_1 $ å­˜å…¥ KV Cache ä½¿ç”¨ $ Q_1, K_1, V_1 $ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œåâ€ è¾“å…¥ï¼šâ€œåâ€ï¼ˆå½“å‰ token åªæœ‰â€œåâ€ï¼Œä½†æ³¨æ„åŠ›è¦å…³æ³¨æ•´ä¸ªåºåˆ—â€œä¸­åâ€ï¼‰ è®¡ç®—â€œåâ€çš„ $ K_2, V_2 $ å°† $ K_2, V_2 $ æ·»åŠ åˆ° KV Cacheã€‚æ­¤æ—¶ KV Cache åŒ…å« $ [K_1, K_2] $ å’Œ $ [V_1, V_2] $ ä½¿ç”¨å½“å‰ $ Q_2 $ å’Œç¼“å­˜ä¸­çš„ $ [K_1, K_2], [V_1, V_2] $ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œäººâ€ è¾“å…¥ï¼šâ€œäººâ€ è®¡ç®—â€œäººâ€çš„ $ K_3, V_3 $ å°† $ K_3, V_3 $ æ·»åŠ åˆ° KV Cacheã€‚æ­¤æ—¶ KV Cache åŒ…å« $ [K_1, K_2, K_3] $ å’Œ $ [V_1, V_2, V_3] $ ä½¿ç”¨å½“å‰ $ Q_3 $ å’Œç¼“å­˜ä¸­çš„ $ [K_1, K_2, K_3], [V_1, V_2, V_3] $ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œæ°‘â€ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ¯ä¸€æ­¥åªéœ€è¦è®¡ç®—å½“å‰æ–°ç”Ÿæˆ token çš„ $ K, V $ å‘é‡ï¼Œè€Œæ— éœ€é‡æ–°è®¡ç®—ä¹‹å‰æ‰€æœ‰ token çš„ $ K, V $ã€‚\n5. Why Not QKV Cache? å¯èƒ½ä¼šå¥½å¥‡ï¼Œæ—¢ç„¶ K å’Œ V éƒ½éœ€è¦ç¼“å­˜ï¼Œä¸ºä»€ä¹ˆä¸ä¹Ÿç¼“å­˜ Q å‘¢ï¼Ÿä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ºä»€ä¹ˆæ˜¯ KV Cache è€Œä¸æ˜¯ QKV Cacheï¼Ÿ\nåŸå› åœ¨äº Q å‘é‡çš„æ€§è´¨ï¼š\nQ å‘é‡æ˜¯ç”¨æ¥â€œæŸ¥è¯¢â€å½“å‰ token ä¸åºåˆ—ä¸­å…¶ä»– token çš„ç›¸å…³æ€§çš„ã€‚åœ¨è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€æ­¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ tokenï¼Œè¿™ä¸ªæ–° token å¯¹åº”çš„ Query å‘é‡æ˜¯æ–°çš„ï¼Œå®ƒåŸºäºå½“å‰æ­¥çš„éšè—çŠ¶æ€è®¡ç®—å¾—å‡ºã€‚æ¢å¥è¯è¯´ï¼Œæ¯æ¬¡ç”Ÿæˆæ–° token æ—¶ï¼Œå…¶å¯¹åº”çš„ $ Q $ å‘é‡éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œå¹¶ä¸”éœ€è¦é‡æ–°è®¡ç®—ä»¥åæ˜ æœ€æ–°çš„ç”Ÿæˆä¸Šä¸‹æ–‡ã€‚ K å’Œ V å‘é‡åˆ™ä»£è¡¨äº†åºåˆ—ä¸­æ¯ä¸ª token çš„â€œå†…å®¹â€ä¿¡æ¯ã€‚å¯¹äºå·²ç»å¤„ç†è¿‡çš„ tokenï¼Œå®ƒä»¬çš„ $ K $ å’Œ $ V $ å‘é‡ä¸€æ—¦è®¡ç®—å‡ºæ¥ï¼Œå…¶å†…å®¹ä¿¡æ¯å°±æ˜¯å›ºå®šä¸å˜çš„ã€‚å› æ­¤ï¼Œè¿™äº› $ K $ å’Œ $ V $ å‘é‡å¯ä»¥ç›´æ¥è¢«ç¼“å­˜å¹¶åå¤ä½¿ç”¨ï¼Œè€Œæ— éœ€é‡æ–°è®¡ç®—ã€‚ å› æ­¤ï¼Œä¸ç¼“å­˜ Q æ˜¯å› ä¸ºå®ƒåœ¨æ¯ä¸€æ­¥éƒ½æ˜¯ä¸€ä¸ªæ–°çš„è®¡ç®—ç»“æœï¼›è€Œç¼“å­˜ K å’Œ V åˆ™å¯ä»¥æ˜¾è‘—å‡å°‘é‡å¤è®¡ç®—ï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚\n6. KV Cache in Attention Mechanism åœ¨æ•°å­¦ä¸Šï¼Œå½“ä½¿ç”¨ KV Cache è¿›è¡Œè‡ªå›å½’è§£ç æ—¶ï¼Œæ³¨æ„åŠ›å…¬å¼ä¸­çš„ $ K $ å’Œ $ V $ çŸ©é˜µä¼šéšç€ç”Ÿæˆè¿‡ç¨‹çš„è¿›è¡Œè€Œä¸æ–­å¢é•¿ã€‚\nå‡è®¾æˆ‘ä»¬æ­£åœ¨ç”Ÿæˆç¬¬ $ t $ ä¸ª tokenã€‚\nå½“å‰ token çš„ Q å‘é‡æ˜¯ $ Q_t $ ï¼Œè¿™æ˜¯ä¸€ä¸ªè¡Œå‘é‡ï¼Œä»£è¡¨å½“å‰ç¬¬ $ t $ ä¸ª token çš„ Query ï¼Œç»´åº¦ä¸º $ 1 \\times d_k $ K çŸ©é˜µ $ K_{\\text{cached}} $ å°†åŒ…å«ä»ç¬¬ä¸€ä¸ª token åˆ°ç¬¬ $ t $ ä¸ª token çš„æ‰€æœ‰ K å‘é‡ï¼š $ K_{\\text{cached}} = [K_1^T, K_2^T, \\dots, K_t^T]^T $ ï¼Œç»´åº¦ä¸º $ t \\times d_k $ V çŸ©é˜µ $ V_{\\text{cached}} $ å°†åŒ…å«ä»ç¬¬ä¸€ä¸ª token åˆ°ç¬¬ $ t $ ä¸ª token çš„æ‰€æœ‰ V å‘é‡ï¼š $ V_{\\text{cached}} = [V_1^T, V_2^T, \\dots, V_t^T]^T $ ã€‚å…¶ç»´åº¦ä¸º $ t \\times d_v $ é‚£ä¹ˆï¼Œç¬¬ $ t $ ä¸ª token çš„æ³¨æ„åŠ›è®¡ç®—å˜ä¸ºï¼š $$ \\text{Attention}_{t}(Q_t, K_{\\text{cached}}, V_{\\text{cached}}) = \\text{softmax}\\left(\\frac{Q_t K_{\\text{cached}}^T}{\\sqrt{d_k}}\\right)V_{\\text{cached}} $$ å…¶ä¸­\n$ Q_t K_{\\text{cached}}^T $ æ˜¯ä¸€ä¸ª $ 1 \\times t $ çš„è¡Œå‘é‡ï¼Œä»£è¡¨å½“å‰ Query ä¸æ‰€æœ‰å†å² Key çš„ç›¸å…³æ€§åˆ†æ•° $ \\text{softmax} $ æ“ä½œå°†è¿™ä¸ª $ 1 \\times t $ çš„å‘é‡è½¬åŒ–ä¸ºæ³¨æ„åŠ›æƒé‡ è¿™ä¸ª $ 1 \\times t $ çš„æ³¨æ„åŠ›æƒé‡å‘é‡å†ä¸ $ V_{\\text{cached}} $ çŸ©é˜µï¼ˆç»´åº¦ $ t \\times d_v $ï¼‰ç›¸ä¹˜ï¼Œå¾—åˆ°æœ€ç»ˆçš„æ³¨æ„åŠ›è¾“å‡ºï¼Œç»´åº¦æ˜¯ $ 1 \\times d_v $ æ¯æ¬¡ç”Ÿæˆæ–°çš„ token $ t+1 $ æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦è®¡ç®—æ–°çš„ $ Q_{t+1} $ï¼Œå°†æ–°è®¡ç®—çš„ $ K_{t+1} $ å’Œ $ V_{t+1} $ æ‹¼æ¥åˆ° $ K_{\\text{cached}} $ å’Œ $ V_{\\text{cached}} $ æœ«å°¾ï¼Œå½¢æˆ $ K'_{\\text{cached}} = \\text{concat}(K_{\\text{cached}}, K_{t+1}) $ å’Œ $ V'_{\\text{cached}} = \\text{concat}(V_{\\text{cached}}, V_{t+1}) $\n7. Limitations and Considerations å°½ç®¡ KV Cache å¸¦æ¥äº†å·¨å¤§çš„æ€§èƒ½æå‡ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š\nå†…å­˜å ç”¨ï¼šKV Cache éœ€è¦å­˜å‚¨æ‰€æœ‰å·²å¤„ç† token çš„ Key å’Œ Value å‘é‡ã€‚å¯¹äºå¤§å‹æ¨¡å‹å’Œé•¿ä¸Šä¸‹æ–‡åºåˆ—ï¼Œè¿™äº›ç¼“å­˜å¯èƒ½éå¸¸å¤§ï¼Œå¯¼è‡´æ˜¾å­˜ï¼ˆGPU Memoryï¼‰æˆä¸ºç“¶é¢ˆã€‚ ä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶ï¼šç”±äºå†…å­˜é™åˆ¶ï¼ŒKV Cache ä¼šé™åˆ¶æ¨¡å‹èƒ½å¤Ÿå¤„ç†çš„æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦ã€‚ä¸€æ—¦è¾¾åˆ°å†…å­˜ä¸Šé™ï¼Œå°±éœ€è¦é‡‡å–ç­–ç•¥æ¥ç®¡ç†ç¼“å­˜ï¼Œä¾‹å¦‚ä¸¢å¼ƒæœ€æ—©çš„ Key/Value å¯¹ï¼ˆç±»ä¼¼äºå¾ªç¯ç¼“å†²åŒºï¼‰ï¼Œä½†è¿™å¯èƒ½ä¼šå½±å“æ¨¡å‹å¯¹é•¿è·ç¦»ä¾èµ–çš„ç†è§£ã€‚ Summary KV Cache æ˜¯ Transformer æ¨¡å‹åœ¨è‡ªå›å½’æ¨ç†è¿‡ç¨‹ä¸­éå¸¸é‡è¦çš„ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ã€‚é€šè¿‡ç¼“å­˜å¹¶é‡ç”¨å·²ç»è®¡ç®—è¿‡çš„ Key å’Œ Value å‘é‡ï¼Œå®ƒæå¤§åœ°å‡å°‘äº†é‡å¤è®¡ç®—ï¼Œä»è€Œæ˜¾è‘—æå‡äº†å¤§å‹è¯­è¨€æ¨¡å‹çš„ç”Ÿæˆé€Ÿåº¦ã€‚\nReferences KV Cache åŸç†è®²è§£ ï¼ˆBilibiliï¼‰ æ³¨æ„ï¼šæ­¤è§†é¢‘å†…å®¹å­˜åœ¨éƒ¨åˆ†é”™è¯¯ çœ‹å›¾å­¦KV Cacheï¼ˆçŸ¥ä¹ï¼‰ ä¸ºä»€ä¹ˆæ²¡æœ‰Q Cacheï¼ˆçŸ¥ä¹ï¼‰ ","permalink":"https://diefish1024.github.io/posts/ai-infra/kv-cache-%E5%85%A5%E9%97%A8/","summary":"\u003cp\u003eæ¨ç†æ•ˆç‡å¯¹äº llm æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„é—®é¢˜ã€‚å½“æ¨¡å‹ç”Ÿæˆæ–‡æœ¬æ—¶ï¼Œå°¤å…¶æ˜¯ä»¥è‡ªå›å½’æ–¹å¼é€è¯ç”Ÿæˆæ—¶ï¼Œæ•ˆç‡ç“¶é¢ˆä¼šå˜å¾—éå¸¸æ˜æ˜¾ã€‚KV Cache å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜è€Œè¯ç”Ÿçš„æŠ€æœ¯ã€‚\u003c/p\u003e\n\u003ch3 id=\"1-what-is-kv-cache\"\u003e1. What is KV Cache?\u003c/h3\u003e\n\u003cp\u003eKV Cacheï¼Œå…¨ç§° \u003cstrong\u003eKey-Value Cache\u003c/strong\u003eï¼Œæ˜¯ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºåŠ é€Ÿ Transformer æ¶æ„åœ¨è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹ä¸­çš„æ¨ç†é€Ÿåº¦ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯\u003cstrong\u003eç¼“å­˜\u003c/strong\u003eå¹¶\u003cstrong\u003eé‡ç”¨\u003c/strong\u003eåœ¨æ³¨æ„åŠ›æœºåˆ¶ä¸­è®¡ç®—å¾—åˆ°çš„ \u003cstrong\u003eKey (K)\u003c/strong\u003e å’Œ \u003cstrong\u003eValue (V)\u003c/strong\u003e å‘é‡ã€‚\u003c/p\u003e\n\u003ch3 id=\"2-transformer-attention-mechanism-review\"\u003e2. Transformer Attention Mechanism Review\u003c/h3\u003e\n\u003cp\u003eè¦ç†è§£ KV Cacheï¼Œé¦–å…ˆéœ€è¦å¯¹ Transformer æ¶æ„ä¸­çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶æœ‰ä¸€ä¸ªåŸºæœ¬è®¤è¯†ã€‚è‡ªæ³¨æ„åŠ›æœºåˆ¶å…è®¸æ¨¡å‹åœ¨å¤„ç†åºåˆ—ä¸­çš„æŸä¸ªè¯æ—¶ï¼Œè€ƒè™‘åºåˆ—ä¸­æ‰€æœ‰å…¶ä»–è¯çš„é‡è¦æ€§ã€‚\u003c/p\u003e\n\u003cp\u003eæ¯ä¸ªè¾“å…¥ tokenï¼ˆè¯æˆ–å­è¯ï¼‰åœ¨è¿›å…¥æ³¨æ„åŠ›å±‚æ—¶ï¼Œéƒ½ä¼šè¢«è½¬æ¢æˆä¸‰ä¸ªä¸åŒçš„å‘é‡ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eQ å‘é‡ï¼šä»£è¡¨å½“å‰ token çš„â€œæŸ¥è¯¢â€ä¿¡æ¯\u003c/li\u003e\n\u003cli\u003eK å‘é‡ï¼šä»£è¡¨æ‰€æœ‰ token çš„â€œé”®â€ä¿¡æ¯ï¼Œç”¨äºä¸ Query è¿›è¡ŒåŒ¹é…\u003c/li\u003e\n\u003cli\u003eV å‘é‡ï¼šä»£è¡¨æ‰€æœ‰ token çš„â€œå€¼â€ä¿¡æ¯ï¼Œç”¨äºåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°æœ€ç»ˆçš„è¾“å‡º\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè‡ªæ³¨æ„åŠ›æœºåˆ¶çš„è®¡ç®—è¿‡ç¨‹ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eè®¡ç®— Query ä¸æ‰€æœ‰ Key çš„ç‚¹ç§¯ï¼Œå¾—åˆ°\u003cstrong\u003eæ³¨æ„åŠ›åˆ†æ•°\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003eå°†æ³¨æ„åŠ›åˆ†æ•°è¿›è¡Œç¼©æ”¾ï¼Œé™¤ä»¥ $ \\sqrt{d_k} $ï¼ˆ$ d_k $ æ˜¯ Key å‘é‡çš„ç»´åº¦)\u003c/li\u003e\n\u003cli\u003eå¯¹ç¼©æ”¾åçš„åˆ†æ•°è¿›è¡Œ Softmaxï¼Œå°†å…¶è½¬æ¢ä¸º\u003cstrong\u003eæ³¨æ„åŠ›æƒé‡\u003c/strong\u003eï¼Œè¡¨ç¤ºæ¯ä¸ª token å¯¹å½“å‰ token çš„é‡è¦æ€§\u003c/li\u003e\n\u003cli\u003eå°†æ³¨æ„åŠ›æƒé‡ä¸ Value å‘é‡è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°å½“å‰ token çš„æ³¨æ„åŠ›è¾“å‡º\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eå…¬å¼ä¸ºï¼š\n$$ \n\n\\text{Attention}(Q, K, V) = \\text{softmax}\\left(\\frac{QK^T}{\\sqrt{d_k}}\\right)V\n\n $$\nå…¶ä¸­çŸ©é˜µ $ Q,K,V \\in \\mathbb{R}^{L \\times d} $ ï¼Œ$ L $ ä¸ºå½“å‰ä¸Šä¸‹æ–‡é•¿åº¦\u003c/p\u003e","title":"KV Cache å…¥é—¨"},{"content":"Introduction TTA åœ¨å›å½’ä»»åŠ¡ä¸Šçš„å±€é™ï¼šä¸ºåˆ†ç±»ä»»åŠ¡è®¾è®¡ï¼Œä¸€èˆ¬åŸºäºç†µæœ€å°åŒ–å’Œç‰¹å¾å¯¹é½ï¼›ç†µæœ€å°åŒ–ä¸é€‚ç”¨ï¼Œå›å½’æ¨¡å‹äº§ç”Ÿå•ä¸€å€¼ï¼Œä¸äº§ç”Ÿæ¦‚ç‡åˆ†å¸ƒï¼›ç®€å•ç‰¹å¾å¯¹é½å¯¹å›å½’æ¨¡å‹æ•ˆæœä¸ä½³ï¼Œå¯èƒ½åè€Œä¼šç¨€é‡Šéœ€è¦å­¦ä¹ çš„ç‰¹å¾\nProblem Setting è€ƒè™‘ä¸€ä¸ªå›å½’æ¨¡å‹ $ f_\\theta: \\mathcal{X} \\to \\mathbb{R} $ï¼Œå¯ä»¥è¿›ä¸€æ­¥åˆ†è§£ä¸ºç‰¹å¾æå–å™¨ $ g_\\phi: \\mathcal{X} \\to \\mathbb{R}^D $ï¼ˆä»è¾“å…¥ $ \\mathcal{X} $ æå– $ D $ ç»´ç‰¹å¾ $ z $ï¼‰å’Œçº¿æ€§å›å½’å™¨ $ h_\\psi(z) = w^T z + b $ï¼ˆæˆ–è€… $ h_{\\psi}(z)=Wz+b $ï¼‰\n$ f_\\theta $ é¦–å…ˆåœ¨ä¸€ä¸ªæœ‰æ ‡ç­¾çš„æºæ•°æ®é›† $ S = \\{(x_i, y_i)\\}_{i=1}^{N_s} $ ä¸Šè¿›è¡Œé¢„è®­ç»ƒï¼Œæ•°æ®ä»æºåŸŸåˆ†å¸ƒ $ p_s $ ä¸­é‡‡æ ·\nç›®æ ‡æ˜¯ä½¿ç”¨ä¸€ä¸ªæ— æ ‡ç­¾çš„ç›®æ ‡æ•°æ®é›† $ T = \\{x_j\\}_{j=1}^{N_t} $ æ¥é€‚åº”é¢„è®­ç»ƒå¥½çš„æ¨¡å‹ $ f_\\theta $ åˆ°ç›®æ ‡åŸŸ\næˆ‘ä»¬å‡è®¾å­˜åœ¨ covariate shift ï¼Œè¿™æ„å‘³ç€ï¼š\nè¾“å…¥æ•°æ®çš„åˆ†å¸ƒåœ¨æºåŸŸå’Œç›®æ ‡åŸŸä¹‹é—´æ˜¯ä¸åŒçš„ï¼š$ p_s(x) \\neq p_t(x) $ ä½†ç»™å®šè¾“å…¥åï¼Œè¾“å‡ºçš„æ¡ä»¶åˆ†å¸ƒæ˜¯ç›¸åŒçš„ï¼š$ p_s(y|x) = p_t(y|x) $ Test-time Adaptation for Regression Basic Idea: Feature Alignment æœ´ç´ å®ç°ï¼š\nè®¡ç®—æºåŸŸç‰¹å¾ç»Ÿè®¡é‡ï¼šåœ¨æºåŸŸè®­ç»ƒåï¼Œè®¡ç®—æºåŸŸç‰¹å¾çš„å‡å€¼ $ \\mu^s $ å’Œå…ƒç´ çº§æ–¹å·® $ \\sigma^{s2} $ $$ \\mu^s = \\frac{1}{N_s} \\sum_{i=1}^{N_s} z_i^s, \\quad \\sigma^{s2} = \\frac{1}{N_s} \\sum_{i=1}^{N_s} (z_i^s - \\mu^s) \\odot (z_i^s - \\mu^s) \\quad \\text{(1)} $$ å…¶ä¸­ $ z_i^s = g_\\phi(x_i) $ æ˜¯æºç‰¹å¾ï¼Œ$ N_s $ æ˜¯æºæ•°æ®æ ·æœ¬æ•°ï¼Œ$ \\odot $ è¡¨ç¤ºå…ƒç´ çº§ä¹˜ç§¯\nç›®æ ‡åŸŸç‰¹å¾ç»Ÿè®¡é‡ï¼šåœ¨ç›®æ ‡åŸŸï¼Œå¯¹æ¯ä¸ªè¿·ä½ æ‰¹æ¬¡ï¼ˆmini-batchï¼‰$ B = \\{x_j\\}_{j=1}^{N_B} $ï¼Œè®¡ç®—å…¶ç‰¹å¾å‡å€¼ $ \\hat{\\mu}^t $ å’Œæ–¹å·® $ \\hat{\\sigma}^{t2} $ï¼Œè®¡ç®—æ–¹å¼ä¸å…¬å¼ (1) ç±»ä¼¼\nå¯¹é½æŸå¤±å‡½æ•°ï¼šä½¿ç”¨ KL æ•£åº¦æ¥è¡¡é‡ä¸¤ä¸ªå¯¹è§’é«˜æ–¯åˆ†å¸ƒ $ N(\\mu^s, \\sigma^{s2}) $ å’Œ $ N(\\hat{\\mu}^t, \\hat{\\sigma}^{t2}) $ ä¹‹é—´çš„å·®å¼‚ï¼Œå¹¶æœ€å°åŒ–è¯¥å·®å¼‚ã€‚ $$ L_{TTA} (\\phi) = \\frac{1}{2} \\sum_{d=1}^D \\left\\{ D_{KL} (N(\\mu^s_d, \\sigma^s_{d}{}^2)||N(\\hat{\\mu}^t_d, \\hat{\\sigma}^t_{d}{}^2)) + D_{KL} (N(\\hat{\\mu}^t_d, \\hat{\\sigma}^t_{d}{}^2)||N(\\mu^s_d, \\sigma^s_{d}{}^2)) \\right\\} \\quad \\text{(2)} $$ è¿™é‡Œçš„ $ d $ è¡¨ç¤ºå‘é‡çš„ç¬¬ $ d $ ä¸ªå…ƒç´ ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨åŒå‘çš„ KL æ•£åº¦ï¼Œæ˜¯ä¸ºäº†ç»éªŒä¸Šè·å¾—æ›´å¥½çš„ç»“æœ\nä¸€ç»´é«˜æ–¯ KL æ•£åº¦å…¬å¼ï¼š $$ D_{KL} (N(\\mu_1, \\sigma_1^2)||N(\\mu_2, \\sigma_2^2)) = \\dfrac{\\left[ \\log(\\sigma_2^2/\\sigma_1^2) + \\dfrac{(\\mu_1 - \\mu_2)^2 + \\sigma_1^2}{\\sigma_2^2} - 1 \\right]}{2} \\quad \\text{(3)} $$\næœ´ç´ å¯¹é½çš„é—®é¢˜ï¼š\nå›å½’æ¨¡å‹ç‰¹å¾å€¾å‘äºåˆ†å¸ƒåœ¨ä¸€ä¸ªå°å‹çš„å­ç©ºé—´ä¸­ï¼Œè®¸å¤šç‰¹å¾ç»´åº¦æ–¹å·®ä¸ºé›¶æˆ–æ¥è¿‘é›¶ å…¬å¼ (3) ä¸­æ¶‰åŠåˆ°æ–¹å·®åœ¨åˆ†æ¯ä¸Šï¼Œä½¿å¾—è¿™ç§æœ´ç´ å¯¹é½åœ¨é¢å¯¹é›¶æ–¹å·®ç»´åº¦æ—¶å˜å¾—ä¸ç¨³å®š å¯¹æ‰€æœ‰ç»´åº¦â€œä¸€è§†åŒä»â€åœ°å¯¹é½ä¸é€‚ç”¨äºå›å½’ä»»åŠ¡çš„ç‰¹æ€§ï¼Œå› ä¸ºè®¸å¤šç»´åº¦å¯¹æœ€ç»ˆè¾“å‡ºå½±å“å¾ˆå° Significant-subspace Alignment SSA çš„ä¸‰ä¸ªæ­¥éª¤ï¼š\nå­ç©ºé—´æ£€æµ‹ (Subspace detection)ï¼š\nåœ¨æºæ•°æ®é›† $ S $ ä¸Šè¿›è¡Œè®­ç»ƒåï¼Œæ£€æµ‹æºç‰¹å¾åˆ†å¸ƒæ‰€åœ¨çš„å­ç©ºé—´ã€‚ä¸è®¡ç®—æ¯ä¸ªç»´åº¦çš„æ–¹å·®ï¼Œè€Œæ˜¯è®¡ç®—åæ–¹å·®çŸ©é˜µï¼š $$ \\Sigma^s = \\frac{1}{N_s} \\sum_{i=1}^{N_s} (z_i^s - \\mu^s) (z_i^s - \\mu^s)^T \\quad \\text{(4)} $$ å…¶ä¸­ $ \\mu^s $ æ˜¯æºç‰¹å¾çš„å‡å€¼å‘é‡ï¼ˆåŒç† (1)ï¼‰ åŸºäº PCA çš„æ€æƒ³ï¼Œé€šè¿‡å¯¹ $ \\Sigma^s $ è¿›è¡Œç‰¹å¾åˆ†è§£ï¼Œå¾—åˆ°ç‰¹å¾å‘é‡ $ v_d^s $ å’Œå¯¹åº”çš„ç‰¹å¾å€¼ $ \\lambda_d^s $ é€‰å–å‰ K ä¸ªæœ€å¤§çš„ç‰¹å¾å€¼ $ \\lambda_1^s, \\dots, \\lambda_K^s $ åŠå…¶å¯¹åº”çš„æºåŸºå‘é‡ $ v_1^s, \\dots, v_K^s $ æ¥å®šä¹‰æºå­ç©ºé—´ï¼Œè¿™äº›åŸºå‘é‡å¼ æˆçš„å­ç©ºé—´ä»£è¡¨äº†æºç‰¹å¾æ•°æ®æœ€æœ‰ä»£è¡¨æ€§å’Œæœ€é‡è¦çš„å˜åŒ–æ–¹å‘ ç»´åº¦åŠ æƒ (Dimension weighting)ï¼š\nè€ƒè™‘åˆ°å›å½’æ¨¡å‹ $ h_\\psi(z)=w^T z + b $ï¼Œå­ç©ºé—´ç»´åº¦ $ v_d^s $ å¯¹æœ€ç»ˆè¾“å‡ºçš„å½±å“ç”± $ w^T v_d^s $ å†³å®šï¼ˆå³ç‰¹å¾å‘é‡ä¸å›å½’å™¨æƒé‡å‘é‡çš„ç‚¹ç§¯ï¼‰ ä¸ºäº†ä¼˜å…ˆå¯¹é½é‚£äº›å¯¹è¾“å‡ºå½±å“æ›´å¤§çš„å­ç©ºé—´ç»´åº¦ï¼Œä¸ºæ¯ä¸ªå­ç©ºé—´ç»´åº¦ $ d $ å®šä¹‰æƒé‡ $ a_d $ï¼š $$ a_d = 1 + |w^T v_d^s| \\quad \\text{(5)} $$ è¿™ä¸ªæƒé‡ $ a_d $ ä¼šåœ¨å¯¹åº”çš„å­ç©ºé—´åŸºæ–¹å‘å¯¹è¾“å‡ºæœ‰è¾ƒå¤§å½±å“æ—¶å€¼æ›´å¤§ï¼ˆæœ€å°ä¸º 1ï¼‰ã€‚ ç‰¹å¾å¯¹é½ (Feature alignment)ï¼š\nè¿™ä¸€æ­¥åœ¨ç›®æ ‡åŸŸè¿›è¡Œã€‚å¯¹äºç›®æ ‡åŸŸçš„è¿·ä½ æ‰¹æ¬¡ $ B $ï¼Œé¦–å…ˆå°†ç›®æ ‡ç‰¹å¾ $ z^t = g_\\phi(x^t) $ æŠ•å½±åˆ°æºå­ç©ºé—´ã€‚ $$ \\tilde{z}^t = V_s^T (z^t - \\mu^s) \\quad \\text{(6)} $$ å…¶ä¸­ $ V_s = [v_1^s, \\dots, v_K^s] \\in \\mathbb{R}^{D \\times K} $ æ˜¯ç”±å‰ K ä¸ªæºåŸºå‘é‡æ„æˆçš„çŸ©é˜µï¼Œ$ \\tilde{z}^t \\in \\mathbb{R}^K $ æ˜¯æŠ•å½±åçš„ç›®æ ‡ç‰¹å¾ã€‚ ç„¶åï¼Œè®¡ç®—æŠ•å½±åç›®æ ‡ç‰¹å¾çš„è¿·ä½ æ‰¹æ¬¡å‡å€¼ $ \\tilde{\\mu}^t $ å’Œæ–¹å·® $ \\tilde{\\sigma}^{t2} $ ï¼ˆåŒç†å…¬å¼ (1) ï¼‰ æœ€åï¼Œä½¿ç”¨ç»“åˆå­ç©ºé—´æ£€æµ‹å’Œç»´åº¦åŠ æƒçš„æ–°æŸå¤±å‡½æ•°æ¥æœ€å°åŒ–ç›®æ ‡ç‰¹å¾åˆ†å¸ƒä¸æºç‰¹å¾åˆ†å¸ƒåœ¨å­ç©ºé—´ä¸­çš„å·®å¼‚ã€‚æºåŸŸæŠ•å½±åçš„å‡å€¼æ˜¯ 0ï¼Œæ–¹å·®æ˜¯å…¶ç‰¹å¾å€¼ $ \\Lambda^s = [\\lambda_1^s, \\dots, \\lambda_K^s] $ã€‚ $$ \\begin{align}L_{TTA}(\\phi) = \u0026 \\frac{1}{2} \\sum_{d=1}^K a_d \\left\\{ D_{KL} (N(0, \\lambda^s_d)||N(\\tilde{\\mu}^t_d, \\tilde{\\sigma}^t_{d}{}^2)) + D_{KL} (N(\\tilde{\\mu}^t_d, \\tilde{\\sigma}^t_{d}{}^2)||N(0, \\lambda^s_d)) \\right\\} \\\\ = \u0026 \\sum_{d=1}^K a_d \\left\\{ \\frac{(\\tilde{\\mu}^t_d)^2 + \\lambda^s_d}{2\\tilde{\\sigma}^t_{d}{}^2} + \\frac{(\\tilde{\\mu}^t_d)^2 + \\tilde{\\sigma}^t_{d}{}^2}{2\\lambda^s_d} - 1 \\right\\} \\quad \\text{(7)} \\end{align} $$ å…¶ä¸­ $ a_d $ æ˜¯ç»´åº¦æƒé‡ï¼Œ$ \\lambda_d^s $ æ˜¯æºåŸŸå­ç©ºé—´çš„ç¬¬ $ d $ ä¸ªç‰¹å¾å€¼ï¼Œ$ \\tilde{\\mu}_d^t $ å’Œ $ \\tilde{\\sigma}_{d}{}^2 $ æ˜¯æŠ•å½±åçš„ç›®æ ‡ç‰¹å¾åœ¨ç¬¬ $ d $ ä¸ªç»´åº¦ä¸Šçš„å‡å€¼å’Œæ–¹å·® ä¼ªä»£ç ï¼š\nè¾“å…¥ï¼šé¢„è®­ç»ƒå¥½çš„æºæ¨¡å‹ $ f_\\theta $ã€æºåŸºå‘é‡ $ V_s $ã€æºå‡å€¼ $ \\mu^s $ã€æºæ–¹å·® $ \\Lambda^s $ã€ç›®æ ‡æ•°æ®é›† $ T $ è¾“å‡ºï¼šé€‚åº”åçš„æ¨¡å‹ $ f_\\phi^t $ æ­¥éª¤ï¼š è®¡ç®—æºå­ç©ºé—´ä¸­æ¯ä¸ªç»´åº¦çš„æƒé‡ $ a_d $ å¯¹äºç›®æ ‡æ•°æ®é›† $ T $ ä¸­çš„æ¯ä¸ª mini batch $ \\{x\\}_i^B $ï¼š æå–ç›®æ ‡ç‰¹å¾ $ z = g_\\phi(x) $ã€‚ å°†ç›®æ ‡ç‰¹å¾æŠ•å½±åˆ°æºå­ç©ºé—´ $ \\tilde{z} $ è®¡ç®—æŠ•å½±åç›®æ ‡ç‰¹å¾çš„å‡å€¼ $ \\tilde{\\mu}^t $ å’Œæ–¹å·® $ \\tilde{\\sigma}^{t2} $ æ›´æ–°ç‰¹å¾æå–å™¨ $ g_\\phi $ ä»¥æœ€å°åŒ–æŸå¤±å‡½æ•° $ L_{TTA}(\\phi) $ é‡å¤ç›´åˆ°æ”¶æ•›ã€‚ å¯¹è§’é«˜æ–¯åˆ†å¸ƒçš„åˆç†æ€§ ä¸ºä»€ä¹ˆå‡è®¾ç‰¹å¾åˆ†å¸ƒä¸ºå¯¹è§’é«˜æ–¯åˆ†å¸ƒæ˜¯åˆç†çš„ï¼š\nä¸­å¿ƒæé™å®šç†ï¼šå½“ç‰¹å¾è¢«æŠ•å½±åˆ°å­ç©ºé—´åï¼Œå¦‚æœåŸå§‹ç‰¹å¾ç»´åº¦ $ D $ è¶³å¤Ÿå¤§ï¼Œæ ¹æ®ä¸­å¿ƒæé™å®šç†ï¼ŒæŠ•å½±åçš„ç‰¹å¾åˆ†å¸ƒä¼šå€¾å‘äºé«˜æ–¯åˆ†å¸ƒã€‚ PCA çš„å»ç›¸å…³æ€§ï¼šç”±äºå­ç©ºé—´æ£€æµ‹ä½¿ç”¨äº† PCAï¼ŒæŠ•å½±åˆ°ä¸»æˆåˆ†ä¸Šçš„ç‰¹å¾æ˜¯å»ç›¸å…³çš„ï¼Œè¿™æ„å‘³ç€ä¸åŒç»´åº¦ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ï¼Œè¿™ä½¿å¾—å¯¹è§’é«˜æ–¯åˆ†å¸ƒçš„å‡è®¾ï¼ˆå³å„ç»´åº¦ç‹¬ç«‹ï¼‰å˜å¾—åˆç†ã€‚ Appendix A. LIMITATIONï¼šSSA å‡è®¾æ˜¯åå˜é‡åç§»ï¼Œå³ $ p(y|x) $ ä¸å˜ï¼Œæœªæ¥å·¥ä½œå°†è€ƒè™‘ $ p(y|x) $ å˜åŒ–çš„æƒ…å†µ\nB. EVALUATION METRICï¼šRÂ²æ¥è¿‘ 1 è¡¨ç¤ºæ¨¡å‹æ‹Ÿåˆæ•ˆæœå¥½ $$ R^2 = 1 - \\frac{\\sum_{i=1}^N (y_i - \\hat{y}_i)^2}{\\sum_{i=1}^N (y_i - \\bar{y})^2} \\quad \\text{(10)} $$ å…¶ä¸­ $ \\hat{y}_i $ æ˜¯é¢„æµ‹å€¼ï¼Œ$ y_i $ æ˜¯çœŸå®å€¼ï¼Œ$ \\bar{y} $ æ˜¯çœŸå®å€¼çš„å¹³å‡å€¼ã€‚\nD. ADDITIONAL EXPERIMENTAL RESULTSï¼š\nD.1 ç‰¹å¾å¯¹é½çš„åº¦é‡ï¼šæ¯”è¾ƒäº† KL æ•£åº¦ã€2WD å’Œ L1 èŒƒæ•°ä½œä¸ºç‰¹å¾å¯¹é½æŸå¤±çš„æ•ˆæœï¼Œç»“æœæ˜¾ç¤º KL æ•£åº¦ç»“åˆå­ç©ºé—´æ£€æµ‹ï¼ˆSSAï¼‰è¡¨ç°æœ€ä½³ã€‚ å…¬å¼ (11)ï¼š2-Wasserstein Distance for Gaussians $$ W_2^2 (N(\\mu_1, \\sigma_1^2), N(\\mu_2, \\sigma_2^2)) = (\\mu_1 - \\mu_2)^2 + (\\sigma_1 - \\sigma_2)^2 $$ å…¬å¼ (12)ï¼šL1 Norm of Statistics $$ L_1 (N(\\mu_1, \\sigma_1^2), N(\\mu_2, \\sigma_2^2)) = |\\mu_1 - \\mu_2| + |\\sigma_1 - \\sigma_2| $$ å…¬å¼ (13)ï¼šSSA Loss with 2WD $$ L_{TTA-2WD} = \\sum_{d=1}^K a_d \\left\\{ (\\tilde{\\mu}^t_d)^2 + (\\tilde{\\sigma}^t_d - \\sqrt{\\lambda^s_d})^2 \\right\\} $$ å…¬å¼ (14)ï¼šSSA Loss with L1 Norm $$ L_{TTA-L1} = \\sum_{d=1}^K a_d \\left\\{ |\\tilde{\\mu}^t_d| + |\\tilde{\\sigma}^t_d - \\sqrt{\\lambda^s_d}| \\right\\} $$ D.2 ç‰¹å¾å¯è§†åŒ–ï¼šé€šè¿‡ PCA å’Œ UMAP ç­‰é™ç»´æŠ€æœ¯å¯è§†åŒ–äº†æºåŸŸå’Œç›®æ ‡åŸŸç‰¹å¾åˆ†å¸ƒï¼ˆå›¾ 4-5ï¼‰ï¼Œç›´è§‚åœ°å±•ç¤ºäº† SSA å¦‚ä½•æˆåŠŸåœ°å°†ç›®æ ‡ç‰¹å¾åˆ†å¸ƒæ‹‰è¿‘æºåŸŸã€‚ D.3 åŸå§‹ç‰¹å¾ç»´åº¦å¯¹å­ç©ºé—´çš„å½±å“ï¼šåˆ†æäº†åŸå§‹ç‰¹å¾ç»´åº¦å¯¹å­ç©ºé—´çš„é‡è¦æ€§ã€‚ å…¬å¼ (15)ï¼šGradient Norm $ s_d $ $$ s_d = ||\\frac{\\partial \\tilde{z}}{\\partial z_d}||_2 = ||(V_s^T)_d||_2 = ||[v_{1,d}^s, \\dots, v_{K,d}^s]||_2, $$ å…¶ä¸­ $ (V_s^T)_d $ æ˜¯ $ V_s^T $ çš„ç¬¬ $ d $ è¡Œã€‚ å‘ç°ï¼šå›å½’æ¨¡å‹çš„ç‰¹å¾å­ç©ºé—´ç¡®å®å—è®¸å¤šåŸå§‹ç‰¹å¾ç»´åº¦å½±å“å¾ˆå°ï¼ˆå›¾ 6ï¼‰ï¼Œè¿™è¿›ä¸€æ­¥ç¡®è®¤äº†å­ç©ºé—´æ£€æµ‹çš„å¿…è¦æ€§ã€‚ D.4 é™„åŠ æ¶ˆèå®éªŒï¼šè¿›ä¸€æ­¥è¯å®äº†å­ç©ºé—´æ£€æµ‹å¯¹äº SSA æ€§èƒ½çš„é‡è¦æ€§ï¼ˆè¡¨ 13-14ï¼‰ã€‚ D.5 Vision Transformer å®éªŒï¼šåœ¨ Vision Transformer ä¸ŠéªŒè¯äº† SSA çš„æœ‰æ•ˆæ€§ï¼ˆè¡¨ 15-16ï¼‰ï¼Œè¡¨æ˜è¯¥æ–¹æ³•å¯¹ä¸åŒæ¨¡å‹æ¶æ„ä¹Ÿé€‚ç”¨ã€‚ D.6 å¤šä»»åŠ¡å›å½’æ¨¡å‹ï¼šå°† SSA åº”ç”¨äºå¤šä»»åŠ¡å›å½’ï¼Œæ¨¡å‹åŒæ—¶è¾“å‡ºå¤šä¸ªé¢„æµ‹å€¼ï¼ˆå¦‚å¤´éƒ¨å§¿æ€çš„ä¿¯ä»°ã€åèˆªã€æ»šè½¬è§’åº¦ï¼‰ï¼Œç»“æœè¡¨æ˜ SSA åŒæ ·æœ‰æ•ˆï¼ˆè¡¨ 17ï¼‰ã€‚ D.7 ä¸åˆ†ç±» TTA ç»“åˆï¼šæ¢ç´¢äº† SSA ä¸åˆ†ç±» TTA ç»“åˆçš„å¯èƒ½æ€§ï¼ˆè¡¨ 18-20ï¼‰ã€‚ D.8 è¶…å‚æ•°æ•æ„Ÿæ€§ï¼šåˆ†æäº†å­¦ä¹ ç‡å’Œæ‰¹æ¬¡å¤§å°ç­‰è¶…å‚æ•°å¯¹ SSA æ€§èƒ½çš„å½±å“ï¼ˆè¡¨ 21-26ï¼‰ï¼Œå‘ç° SSA åœ¨å…¸å‹å‚æ•°èŒƒå›´å†…è¡¨ç°ç¨³å®šã€‚ D.9 é¢å¤–ç»“æœï¼šæä¾›äº† MAE ç­‰å…¶ä»–æŒ‡æ ‡çš„æ€§èƒ½æ•°æ®ï¼ˆè¡¨ 27-28ï¼‰ã€‚ D.10 åœ¨çº¿è®¾ç½®ï¼šSSA åœ¨åˆ†æ‰¹åœ¨çº¿ï¼ˆbatched onlineï¼‰è®¾ç½®ä¸‹ä¹Ÿè¡¨ç°å‡ºè‰²ï¼ˆè¡¨ 29-31ï¼‰ã€‚ ","permalink":"https://diefish1024.github.io/posts/literature-notes/ssa/","summary":"\u003ch2 id=\"introduction\"\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eTTA åœ¨å›å½’ä»»åŠ¡ä¸Šçš„å±€é™ï¼šä¸ºåˆ†ç±»ä»»åŠ¡è®¾è®¡ï¼Œä¸€èˆ¬åŸºäºç†µæœ€å°åŒ–å’Œç‰¹å¾å¯¹é½ï¼›ç†µæœ€å°åŒ–ä¸é€‚ç”¨ï¼Œå›å½’æ¨¡å‹äº§ç”Ÿå•ä¸€å€¼ï¼Œä¸äº§ç”Ÿæ¦‚ç‡åˆ†å¸ƒï¼›ç®€å•ç‰¹å¾å¯¹é½å¯¹å›å½’æ¨¡å‹æ•ˆæœä¸ä½³ï¼Œå¯èƒ½åè€Œä¼šç¨€é‡Šéœ€è¦å­¦ä¹ çš„ç‰¹å¾\u003c/p\u003e\n\u003ch2 id=\"problem-setting\"\u003eProblem Setting\u003c/h2\u003e\n\u003cp\u003eè€ƒè™‘ä¸€ä¸ªå›å½’æ¨¡å‹ $ f_\\theta: \\mathcal{X} \\to \\mathbb{R} $ï¼Œå¯ä»¥è¿›ä¸€æ­¥åˆ†è§£ä¸º\u003cstrong\u003eç‰¹å¾æå–å™¨\u003c/strong\u003e $ g_\\phi: \\mathcal{X} \\to \\mathbb{R}^D $ï¼ˆä»è¾“å…¥ $ \\mathcal{X} $ æå– $ D $ ç»´ç‰¹å¾ $ z $ï¼‰å’Œ\u003cstrong\u003eçº¿æ€§å›å½’å™¨\u003c/strong\u003e $ h_\\psi(z) = w^T z + b $ï¼ˆæˆ–è€… $ h_{\\psi}(z)=Wz+b $ï¼‰\u003c/p\u003e\n\u003cp\u003e$ f_\\theta $ é¦–å…ˆåœ¨ä¸€ä¸ªæœ‰æ ‡ç­¾çš„\u003cstrong\u003eæºæ•°æ®é›†\u003c/strong\u003e $ S = \\{(x_i, y_i)\\}_{i=1}^{N_s} $ ä¸Šè¿›è¡Œé¢„è®­ç»ƒï¼Œæ•°æ®ä»æºåŸŸåˆ†å¸ƒ $ p_s $ ä¸­é‡‡æ ·\u003c/p\u003e\n\u003cp\u003eç›®æ ‡æ˜¯ä½¿ç”¨ä¸€ä¸ª\u003cstrong\u003eæ— æ ‡ç­¾çš„\u003c/strong\u003eç›®æ ‡æ•°æ®é›† $ T = \\{x_j\\}_{j=1}^{N_t} $ æ¥é€‚åº”é¢„è®­ç»ƒå¥½çš„æ¨¡å‹ $ f_\\theta $ åˆ°ç›®æ ‡åŸŸ\u003c/p\u003e\n\u003cp\u003eæˆ‘ä»¬å‡è®¾å­˜åœ¨ \u003cstrong\u003ecovariate shift\u003c/strong\u003e ï¼Œè¿™æ„å‘³ç€ï¼š\u003c/p\u003e","title":"SSA"},{"content":"Method Problem Set EEG æ•°æ® $ \\{ X_{s,l}^{i},y_{s,l}^{i} \\}_{i=1}^{n_{s,l}} $ ï¼Œè¿›è¡Œæ— ç›‘ç£åœ¨çº¿ K åˆ†ç±»\nSource Model Training å¯¹æºæ•°æ®åš Euclidean alignment (EA) æ•°æ®å¯¹é½ï¼Œå‡å°‘ä¸åŒä¸ªä½“ EEG ä¿¡å·å·®å¼‚\nEA è®¡ç®—æ¯ä¸ªä¸ªä½“æ‰€æœ‰ EEG è¯•æ¬¡åæ–¹å·®çŸ©é˜µçš„ç®—æœ¯å¹³å‡å€¼ $$ R_{s,l} = \\dfrac{1}{n}\\sum_{i=1}^{n} X_{i}(X_{i})^{T} \\implies \\bar{X}_{i} = R_{s,l}^{-1/2}X_{i} $$ ä¹‹åå†æ•´åˆç»è¿‡å¯¹é½çš„å—è¯•è€…æ•°æ®ï¼Œå½¢æˆâ€œæºåŸŸâ€\nåœ¨æ•´åˆåçš„æ•°æ®ä¸Šç‹¬ç«‹è®­ç»ƒ $ M $ ä¸ªæ¨¡å‹\nIncremental EA on Target Data å¯¹æ–°æ•°æ®å¢é‡å¼æ›´æ–°åæ–¹å·®çŸ©é˜µï¼Œå†ç”¨æ–°çš„çŸ©é˜µæ›´æ–°æ‰€æœ‰æµ‹è¯•æ•°æ®\nTarget Label Prediction ç”¨è®­ç»ƒå¥½çš„ $ M $ æ¨¡å‹åˆå§‹åŒ–ç”¨äºé€‚åº”ç›®æ ‡åŸŸçš„ $ M $ ä¸ª TTA æ¨¡å‹ $ f_{m} $\næ–°çš„ $ X_{a} $ ç»è¿‡ IEA è¢«å˜æ¢ä¸º $ X_{a}' $ åè¢«è¾“å…¥åˆ°æ¯ä¸ªæ¨¡å‹ $ f_{m} $ ä¸­è¿›è¡Œåˆ†ç±»ï¼Œè¾“å‡ºæ¦‚ç‡å‘é‡ $ f_{m}(X_{a}') $\nä¹‹åç»“åˆè¿™ $ M $ ä¸ªæ¦‚ç‡å‘é‡æ¥è·å¾—æœ€ç»ˆçš„é¢„æµ‹æ ‡ç­¾ $ \\hat{y}_{a} $\n$ a\\leq M $ æ•°æ®é‡è¾ƒå°‘ï¼šç›´æ¥å¯¹æ‰€æœ‰æ¨¡å‹çš„é¢„æµ‹å‘é‡å¹³å‡ $ a\u003eM $ æ•°æ®é‡è¾ƒå¤šï¼šä½¿ç”¨è°±å…ƒå­¦ä¹ å™¨å¯¹å„ä¸ªæ¨¡å‹è¿›è¡ŒåŠ æƒå¹³å‡ï¼Œæ ¹æ®å†å²è¡¨ç°ï¼ˆé¢„æµ‹çš„åæ–¹å·®çŸ©é˜µï¼‰åˆ†é…ä¸åŒçš„æƒé‡ Target Model Update åœ¨æ•°æ®é‡è¶³å¤Ÿä»¥åï¼ˆ$ a\u003eB $ï¼‰ä½¿ç”¨ä¸€ä¸ªæ»‘åŠ¨æ‰¹æ¬¡çš„æ•°æ®æ›´æ–°æ¨¡å‹ï¼Œåœ¨æ­¤ä¹‹å‰æ¨¡å‹ä¸å˜\nç»„åˆæŸå¤±å‡½æ•°ï¼š $$ L_{M} = L_{CEM}(f_{m};\\{ X'_{i} \\}_{i=a-B+1}^{a}) + L_{MDR}(f_{m};\\{ X'_{i} \\}_{i=a-B+1}^{a}) $$ æœ‰ä¸¤ä¸ªéƒ¨åˆ†\n1) Conditional Entropy Minimization æ¡ä»¶ç†µæœ€å°åŒ–\nä½¿åˆ†ç±»è¾¹ç•Œæ›´åŠ æ¸…æ™° é€šè¿‡æœ€å°åŒ–æ¯ä¸ªé¢„æµ‹çš„æ¡ä»¶ç†µï¼ˆä½¿ç”¨æ¸©åº¦ç¼©æ”¾å› å­ $ T $ è¿›è¡Œæ ¡å‡†ï¼‰ï¼Œä½¿æ¨¡å‹å€¾å‘äºè¾“å‡ºæ¥è¿‘ 0 æˆ– 1 çš„æ¦‚ç‡ 2) Adaptive Marginal Distribution Regularization è‡ªé€‚åº”è¾¹ç¼˜åˆ†å¸ƒæ­£åˆ™åŒ–\né˜²æ­¢å‡ºç°æ‰€æœ‰æ•°æ®éƒ½åœ¨å•ç±»åˆ«å’Œå¯¹é”™è¯¯ç»“æœè¿‡äºè‡ªä¿¡çš„ä¸è‰¯ç»“æœ è®¡ç®—å½“å‰æ‰¹æ¬¡æ¯ä¸ªç±»åˆ«çš„å¹³å‡é¢„æµ‹æ¦‚ç‡ $ p_{k} $ é€šè¿‡è®¾ç½®é˜ˆå€¼å¾—åˆ°ä¼ªæ ‡ç­¾ï¼Œä¼°è®¡ç›®æ ‡åŸŸçš„ç±»åˆ«è¯„è®º $ z_{k} $ æ ¡å‡†å¹³å‡é¢„æµ‹æ¦‚ç‡ $ q'_{k} $ $$ q_{k} = \\dfrac{p_{k}}{c+z_{k}},\\quad q'_{k} = \\dfrac{q_{k}}{\\sum q} $$ $ L_{MDR} = \\sum_{k=1}^{K}q'_{k}\\log q'_{k} $ ï¼ˆé‡‡ç”¨è´Ÿç†µçš„å½¢å¼ï¼‰ Complete T-TIME Algorithm å…ˆé¢„æµ‹ï¼Œåå°å¹¶è¡Œåœ°æ›´æ–°æ¨¡å‹\nExperiment ä½¿ç”¨ä¸‰ä¸ªè¿åŠ¨æƒ³è±¡æ•°æ®é›†\næ¯æ¬¡æŠŠä¸€ä¸ªå—è¯•è€…çš„æ•°æ®ä½œä¸ºç›®æ ‡åŸŸï¼Œå…¶ä½™ä½œä¸ºæºåŸŸ\nClassification Accuracies on Balanced Classes è¿‡äºå¤æ‚çš„ç®—æ³•ç”±äºæ•°æ®ä¸è¶³ï¼Œæ€§èƒ½åè€Œä¸‹é™ åŸºäºç†µçš„æ–¹æ³•æ™®éè¡¨ç°è‰¯å¥½ï¼ŒMCC åœ¨ç¦»çº¿è¿ç§»å­¦ä¹ ä¸­è¡¨ç°æœ€å¥½ T-TIME åœ¨æ‰€æœ‰åœ¨çº¿è¿ç§»å­¦ä¹ ç®—æ³•ä¸­è¡¨ç°æœ€ä½³ï¼Œå¹¶ä¸”å…¶æ€§èƒ½ä¸è¡¨ç°æœ€ä½³çš„ç¦»çº¿è¿ç§»å­¦ä¹ æ–¹æ³•ç›¸å½“ Classification Performance Under Class-Imbalance ä½¿ç”¨éšæœºç§»é™¤æ•°æ®æ¥åˆ›å»ºä¸å¹³è¡¡æ•°æ®é›†\nä¼ ç»Ÿæ–¹æ³•è¡¨ç°è¾ƒå¼± T-TIME è¡¨ç°çªå‡º ","permalink":"https://diefish1024.github.io/posts/literature-notes/t-time/","summary":"\u003ch1 id=\"method\"\u003eMethod\u003c/h1\u003e\n\u003ch3 id=\"problem-set\"\u003eProblem Set\u003c/h3\u003e\n\u003cp\u003eEEG æ•°æ® $ \\{ X_{s,l}^{i},y_{s,l}^{i} \\}_{i=1}^{n_{s,l}} $ ï¼Œè¿›è¡Œæ— ç›‘ç£åœ¨çº¿ K åˆ†ç±»\u003c/p\u003e\n\u003ch3 id=\"source-model-training\"\u003eSource Model Training\u003c/h3\u003e\n\u003cp\u003eå¯¹æºæ•°æ®åš Euclidean alignment (EA) æ•°æ®å¯¹é½ï¼Œå‡å°‘ä¸åŒä¸ªä½“ EEG ä¿¡å·å·®å¼‚\u003c/p\u003e\n\u003cp\u003eEA è®¡ç®—æ¯ä¸ªä¸ªä½“æ‰€æœ‰ EEG è¯•æ¬¡åæ–¹å·®çŸ©é˜µçš„ç®—æœ¯å¹³å‡å€¼\n$$ \n\nR_{s,l} = \\dfrac{1}{n}\\sum_{i=1}^{n} X_{i}(X_{i})^{T} \\implies \\bar{X}_{i} = R_{s,l}^{-1/2}X_{i}\n\n $$\nä¹‹åå†æ•´åˆç»è¿‡å¯¹é½çš„å—è¯•è€…æ•°æ®ï¼Œå½¢æˆâ€œæºåŸŸâ€\u003c/p\u003e\n\u003cp\u003eåœ¨æ•´åˆåçš„æ•°æ®ä¸Šç‹¬ç«‹è®­ç»ƒ $ M $ ä¸ªæ¨¡å‹\u003c/p\u003e\n\u003ch3 id=\"incremental-ea-on-target-data\"\u003eIncremental EA on Target Data\u003c/h3\u003e\n\u003cp\u003eå¯¹æ–°æ•°æ®å¢é‡å¼æ›´æ–°åæ–¹å·®çŸ©é˜µï¼Œå†ç”¨æ–°çš„çŸ©é˜µæ›´æ–°æ‰€æœ‰æµ‹è¯•æ•°æ®\u003c/p\u003e\n\u003ch3 id=\"target-label-prediction\"\u003eTarget Label Prediction\u003c/h3\u003e\n\u003cp\u003eç”¨è®­ç»ƒå¥½çš„ $ M $ æ¨¡å‹åˆå§‹åŒ–ç”¨äºé€‚åº”ç›®æ ‡åŸŸçš„ $ M $ ä¸ª TTA æ¨¡å‹ $ f_{m} $\u003c/p\u003e\n\u003cp\u003eæ–°çš„ $ X_{a} $ ç»è¿‡ IEA è¢«å˜æ¢ä¸º $ X_{a}' $ åè¢«è¾“å…¥åˆ°æ¯ä¸ªæ¨¡å‹ $ f_{m} $ ä¸­è¿›è¡Œåˆ†ç±»ï¼Œè¾“å‡ºæ¦‚ç‡å‘é‡ $ f_{m}(X_{a}') $\u003c/p\u003e","title":"T-TIME"},{"content":"Setting Fully Test-Time Adaptation æ˜¯ä¸€ç§ç‹¬ç‰¹çš„æ¨¡å‹é€‚åº”è®¾å®šã€‚åœ¨æ­¤è®¾å®šä¸‹ï¼Œæ¨¡å‹ $ f_\\theta(x) $ åœ¨è®­ç»ƒé˜¶æ®µå·²é€šè¿‡æºæ•°æ® $ x^s $ å’Œæ ‡ç­¾ $ y^s $ å®Œæˆè®­ç»ƒï¼Œè·å¾—å‚æ•° $ \\theta $ã€‚ä½†åœ¨æµ‹è¯•é˜¶æ®µï¼Œæ¨¡å‹å°†é‡åˆ°ä¸æºæ•°æ®åˆ†å¸ƒä¸åŒçš„æ— æ ‡ç­¾ç›®æ ‡æ•°æ® $ x^t $ã€‚\nFTT-Adaptation ä¸ä»¥ä¸‹æ–¹æ³•ä¸åŒï¼š\nFine-tuningï¼šéœ€è¦ç›®æ ‡æ ‡ç­¾è¿›è¡Œé‡æ–°è®­ç»ƒã€‚ Domain Adaptationï¼šéœ€è¦æºæ•°æ®å’Œç›®æ ‡æ•°æ®è¿›è¡Œè”åˆè®­ç»ƒã€‚ Test-Time Training (TTT)ï¼šéœ€è¦ä¿®æ”¹è®­ç»ƒè¿‡ç¨‹å¹¶å…±åŒä¼˜åŒ–æœ‰ç›‘ç£åŠè‡ªç›‘ç£æŸå¤±ã€‚ ç›¸æ¯”ä¹‹ä¸‹ï¼ŒFTT-Adaptation ä»…èƒ½åˆ©ç”¨é¢„è®­ç»ƒæ¨¡å‹ $ f_\\theta $ å’Œæ— æ ‡ç­¾ç›®æ ‡æ•°æ® $ x^t $ è¿›è¡Œé€‚åº”ï¼Œä¸ä¾èµ–æºæ•°æ®æˆ–é¢å¤–çš„ç›‘ç£ä¿¡æ¯ã€‚\nMethod è®ºæ–‡çš„æ ¸å¿ƒè´¡çŒ®æ˜¯æå‡ºäº† Tent æ–¹æ³•ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡æœ€å°åŒ–æµ‹è¯•ç†µï¼ˆTest Entropy Minimizationï¼‰æ¥é€‚åº”æ¨¡å‹é¢„æµ‹ï¼Œæ—¨åœ¨ä½¿æ¨¡å‹å¯¹æµ‹è¯•æ•°æ®çš„é¢„æµ‹ç»“æœæ›´â€œæœ‰ä¿¡å¿ƒâ€ã€‚\nEntropy Objective Tent çš„æµ‹è¯•æ—¶ç›®æ ‡å‡½æ•°æ˜¯æœ€å°åŒ–æ¨¡å‹é¢„æµ‹ $ \\hat{y} = f_\\theta(x^t) $ çš„ç†µ $ H(\\hat{y}) $ã€‚è®ºæ–‡ä¸­ä½¿ç”¨çš„é¦™å†œç†µè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š\n$$ H(\\hat{y}) = - \\sum_c p(\\hat{y}_c) \\log p(\\hat{y}_c) $$ å…¶ä¸­ï¼Œ $ p(\\hat{y}_c) $ è¡¨ç¤ºæ¨¡å‹é¢„æµ‹ç›®æ ‡æ•°æ® $ x^t $ å±äºç±»åˆ« $ c $ çš„æ¦‚ç‡ã€‚\næœ€å°åŒ–ç†µä¿ƒä½¿æ¨¡å‹è¾“å‡ºæ›´â€œå°–é”â€æˆ–æ›´â€œç¡®å®šâ€çš„é¢„æµ‹åˆ†å¸ƒã€‚ ä¼˜åŠ¿ï¼šç†µæ˜¯ä¸€ç§æ— ç›‘ç£ç›®æ ‡ï¼Œä»…ä¾èµ–äºæ¨¡å‹é¢„æµ‹ï¼Œä¸éœ€è¦çœŸå®æ ‡ç­¾ã€‚æœ€å°åŒ–ç†µä¸å‡å°‘é¢„æµ‹è¯¯å·®å’Œæ•°æ®æ¼‚ç§»ä¹‹é—´å­˜åœ¨å†…åœ¨è”ç³»ï¼Œå› ä¸ºæ›´ç¡®å®šçš„é¢„æµ‹é€šå¸¸æ„å‘³ç€æ›´æ­£ç¡®çš„é¢„æµ‹ã€‚ Modulation Parameters Tent ä¸ç›´æ¥ä¿®æ”¹åŸå§‹æ¨¡å‹çš„å…¨éƒ¨å‚æ•° $ \\theta $ã€‚ç›¸åï¼Œå®ƒä»…æ›´æ–°æ¨¡å‹å†…éƒ¨å½’ä¸€åŒ–å±‚ï¼ˆå¦‚Batch Normalization layersï¼‰ä¸­çš„çº¿æ€§ä¸”ä½ç»´åº¦çš„ä»¿å°„å˜æ¢å‚æ•°ï¼šå°ºåº¦å‚æ•° $ \\gamma $ å’Œåç§»å‚æ•° $ \\beta $ã€‚\nè¿™ä¸€é€‰æ‹©çš„ç†ç”±æ˜¯ï¼šè¿™äº›å‚æ•°åªå æ¨¡å‹æ€»å‚æ•°çš„æå°éƒ¨åˆ†ï¼ˆ\u0026lt;1%ï¼‰ï¼Œä¼˜åŒ–æ•ˆç‡é«˜ä¸”ç¨³å®šã€‚ ç‰¹å¾è°ƒåˆ¶è¿‡ç¨‹åŒ…å«ä¸¤ä¸ªæ­¥éª¤ï¼š 1.Normalization (æ ‡å‡†åŒ–)ï¼šæ ¹æ®å½“å‰æ‰¹æ¬¡æµ‹è¯•æ•°æ®çš„å‡å€¼ $ \\mu $ å’Œæ ‡å‡†å·® $ \\sigma $ æ¥æ ‡å‡†åŒ–ç‰¹å¾ $ x $ï¼Œå³ $ \\hat{x} = (x - \\mu)/\\sigma $ã€‚è¿™é‡Œçš„ $ \\mu, \\sigma $ æ˜¯åœ¨æµ‹è¯•æ—¶ä»å½“å‰æ‰¹æ¬¡æ•°æ®ä¸­ä¼°è®¡çš„ã€‚ 2.Transformation (ä»¿å°„å˜æ¢)ï¼šå¯¹æ ‡å‡†åŒ–åçš„ç‰¹å¾ $ \\hat{x} $ åº”ç”¨ä»¿å°„å˜æ¢ï¼Œå³ $ x' = \\gamma \\hat{x} + \\beta $ã€‚å‚æ•° $ \\gamma $ å’Œ $ \\beta $ é€šè¿‡æœ€å°åŒ–ç†µç›®æ ‡å‡½æ•°è¿›è¡Œä¼˜åŒ–ã€‚ Algorithm Tent ç®—æ³•çš„æµç¨‹å¦‚ä¸‹ï¼š\nInitializationï¼š åŠ è½½é¢„è®­ç»ƒå¥½çš„æºæ¨¡å‹å‚æ•° $ \\theta $ã€‚ å›ºå®šæ‰€æœ‰éä»¿å°„å˜æ¢çš„å‚æ•°ã€‚ ä¸¢å¼ƒæºæ•°æ®ä¸­ä¼°è®¡çš„å½’ä¸€åŒ–ç»Ÿè®¡é‡ã€‚ ä¼˜åŒ–å™¨æ”¶é›†æ‰€æœ‰å½’ä¸€åŒ–å±‚çš„é€šé“çº§ä»¿å°„å˜æ¢å‚æ•° $ \\{\\gamma_{l,k}, \\beta_{l,k}\\} $ã€‚ Iterationï¼šåœ¨çº¿å¤„ç†æ•°æ®æ‰¹æ¬¡ã€‚ Forward Passï¼šå¯¹æ¯ä¸ªæ•°æ®æ‰¹æ¬¡ï¼Œé€å±‚ä¼°è®¡è¯¥æ‰¹æ¬¡æ•°æ®çš„å½’ä¸€åŒ–ç»Ÿè®¡é‡ ($ \\mu, \\sigma $)ã€‚ Backward Passï¼šè®¡ç®—é¢„æµ‹ç†µ $ H(\\hat{y}) $ ç›¸å¯¹äºä»¿å°„å˜æ¢å‚æ•° $ \\gamma, \\beta $ çš„æ¢¯åº¦ $ \\nabla H(\\hat{y}) $ã€‚ Updateï¼šä½¿ç”¨æ¢¯åº¦æ›´æ–° $ \\gamma, \\beta $ å‚æ•°ã€‚Tent é‡‡ç”¨é«˜æ•ˆçš„åœ¨çº¿æ›´æ–°ç­–ç•¥ï¼Œæ¯æ¬¡æ›´æ–°åªå½±å“ä¸‹ä¸€ä¸ªæ‰¹æ¬¡çš„æ•°æ®å¤„ç†ã€‚ Terminationï¼šå¯¹äºåœ¨çº¿é€‚åº”ï¼Œé€‚åº”è¿‡ç¨‹åªè¦æœ‰æµ‹è¯•æ•°æ®å°±æŒç»­è¿›è¡Œã€‚å¯¹äºç¦»çº¿é€‚åº”ï¼Œæ¨¡å‹ä¼šå…ˆè¿›è¡Œæ›´æ–°ï¼Œç„¶åé‡å¤æ¨æ–­ï¼Œé€‚åº”å¯ä»¥æŒç»­å¤šä¸ªEpochsã€‚ Experiments è®ºæ–‡åœ¨å¤šç§è®¡ç®—æœºè§†è§‰ä»»åŠ¡å’Œæ•°æ®é›†ä¸Šå¯¹ Tent è¿›è¡Œäº†å…¨é¢è¯„ä¼°ã€‚\nRobustness To Corruptions åœ¨å›¾åƒåˆ†ç±»çš„é²æ£’æ€§åŸºå‡†æµ‹è¯•ä¸­ï¼Œä½¿ç”¨å—æŸç‰ˆæœ¬çš„ CIFAR-10/100-C å’Œ ImageNet-C æ•°æ®é›†ï¼ˆ15 ç§æŸåç±»å‹ï¼Œä¸åŒä¸¥é‡ç¨‹åº¦ï¼‰ã€‚\nä¸»è¦å‘ç°ï¼š Tent åœ¨ ImageNet-C ä¸Šè¾¾åˆ°äº† 44.0% çš„æœ€ä½é”™è¯¯ç‡ï¼Œä¼˜äº SOTA é²æ£’æ€§è®­ç»ƒæ–¹æ³•ï¼ˆå¦‚Adversarial Noise Training (ANT) çš„ 50.2%ï¼‰å’ŒTest-Time Normalization (BN) åŸºçº¿ï¼ˆ49.9%ï¼‰ã€‚ åœ¨ CIFAR-10/100-C ä¸Šï¼ŒTent ä¹Ÿæ˜¾è‘—ä¼˜äºå…¶ä»– TTA baselineï¼ˆBN, Pseudo-Labeling (PL)ï¼‰ä»¥åŠéœ€è¦è”åˆè®­ç»ƒæºåŸŸå’Œç›®æ ‡åŸŸçš„Domain Adaptationï¼ˆRG, UDA-SSï¼‰å’ŒTest-Time Training (TTT) æ–¹æ³•ã€‚ è¿™äº›æ”¹è¿›ä»…é€šè¿‡ä¸€æ¬¡Epochçš„æµ‹è¯•æ—¶ä¼˜åŒ–å®ç°ï¼Œä¸”æœªæ”¹å˜åŸå§‹æ¨¡å‹è®­ç»ƒã€‚ Source-Free Domain Adaptation è¯„ä¼° Tent åœ¨æ— æºåŸŸé€‚åº”åœºæ™¯ä¸‹çš„æ€§èƒ½ï¼ŒåŒ…æ‹¬æ•°å­—è¯†åˆ«ï¼ˆä» SVHN åˆ° MNIST/MNIST-M/USPSï¼‰å’Œè¯­ä¹‰åˆ†å‰²ï¼ˆä» GTA åˆ° Cityscapesï¼‰ã€‚\nä¸»è¦å‘ç°ï¼š åœ¨æ•°å­—è¯†åˆ«ä»»åŠ¡ä¸­ï¼ŒTent å¤§å¤šæ•°æƒ…å†µä¸‹é”™è¯¯ç‡ä½äºæºæ¨¡å‹å’ŒBNï¼Œéƒ¨åˆ†æƒ…å†µç”šè‡³ä¼˜äºéœ€è¦æºæ•°æ®çš„Domain Adaptationæ–¹æ³•ï¼ˆRG, UDA-SSï¼‰ã€‚ è¯­ä¹‰åˆ†å‰²ä»»åŠ¡ä¸­ï¼ŒTent å°†Intersection-Over-Union (IOU) åˆ†æ•°ä»æºæ¨¡å‹çš„ 28.8% æé«˜åˆ° 35.8%ï¼Œæ˜¾è‘—ä¼˜äº BN çš„ 31.4%ã€‚ Analysis è®ºæ–‡é€šè¿‡å¤šé¡¹åˆ†æå®éªŒæ¢ç©¶äº† Tent çš„å·¥ä½œåŸç†å’Œç‰¹æ€§ï¼š\nTent é™ä½ç†µå’Œè¯¯å·®ï¼šå®éªŒè¯å®ï¼ŒTent æˆåŠŸé™ä½äº†é¢„æµ‹çš„ç†µå€¼å’Œä»»åŠ¡æŸå¤±ï¼ˆå¦‚Softmax Cross-Entropyï¼‰ï¼Œå°è¯äº†ç†µæœ€å°åŒ–ä¸è¯¯å·®å‡å°‘ä¹‹é—´çš„æ­£ç›¸å…³æ€§ã€‚ Tent éœ€è¦ç‰¹å¾è°ƒåˆ¶ï¼šä¸æ›´æ–°å½’ä¸€åŒ–ç»Ÿè®¡é‡æˆ–ä¸ä¼˜åŒ–ä»¿å°„å˜æ¢å‚æ•°ä¼šæ˜¾è‘—é™ä½ Tent æ€§èƒ½ï¼Œè¯´æ˜è¿™äº›ç‰¹å¾è°ƒåˆ¶æ­¥éª¤å¯¹äºé€‚åº”ä¸å¯æˆ–ç¼ºã€‚ Tent æ³›åŒ–åˆ°ä¸åŒçš„ç›®æ ‡æ•°æ®ï¼šé€‚åº”è¿‡ç¨‹å¯¹æœªç”¨äºæ›´æ–°çš„å…¶ä»–æµ‹è¯•æ•°æ®ç‚¹åŒæ ·æœ‰æ•ˆï¼Œè¡¨æ˜å…¶å­¦ä¹ åˆ°çš„è°ƒåˆ¶æ˜¯é€šç”¨çš„ã€‚ Tent è°ƒåˆ¶ä¸å½’ä¸€åŒ–ä¸åŒï¼šå¯¹æ¯”åˆ†ææ˜¾ç¤ºï¼ŒTent çš„ç‰¹å¾è°ƒåˆ¶ä½¿ç‰¹å¾æ›´æ¥è¿‘åœ¨ç›®æ ‡æ ‡ç­¾ä¸Šä¼˜åŒ–çš„Oracleæ¨¡å‹ï¼ˆç†æƒ³æ¨¡å‹ï¼‰ï¼Œè€Œéä»…åƒBatch Normalizationé‚£æ ·æ¥è¿‘åŸå§‹å‚è€ƒåˆ†å¸ƒã€‚ Tent é€‚åº”å…¶ä»–ç½‘ç»œæ¶æ„ï¼šTent åœ¨åŸºäºSelf-Attention å’ŒEquilibrium Solving (MDEQ) çš„æ¨¡å‹ä¸Šä¹Ÿèƒ½æœ‰æ•ˆé™ä½è¯¯å·®ï¼Œå±•ç°äº†å…¶æ™®é€‚æ€§ã€‚ Related Work è®ºæ–‡å›é¡¾äº†ä¸ Tent ç›¸å…³çš„ç°æœ‰å·¥ä½œï¼š\nTrain-Time Adaptation æ–¹æ³•ï¼šä¼ ç»Ÿçš„Domain Adaptationã€Test-Time Training (TTT) ç­‰ï¼Œé€šå¸¸éœ€è¦æºæ•°æ®æˆ–è®­ç»ƒé˜¶æ®µä¿®æ”¹æ¨¡å‹ã€‚ Source-Free Adaptation æ–¹æ³•ï¼šè¿‘æœŸä¸€äº›ä¸ä¾èµ–æºæ•°æ®çš„æ–¹æ³•ï¼Œä½†é€šå¸¸éœ€è¦æ›´å¤æ‚çš„è®¾è®¡ã€ç¦»çº¿ä¼˜åŒ–æˆ–ä¿®æ”¹è®­ç»ƒè¿‡ç¨‹ã€‚Tent çš„ä¼˜åŠ¿åœ¨äºå…¶åœ¨çº¿ã€é«˜æ•ˆä¸”ä¸æ”¹å˜è®­ç»ƒè¿‡ç¨‹ã€‚ Entropy Minimizationï¼šç†µæœ€å°åŒ–å·²è¢«å¹¿æ³›ç”¨äºSemi-Supervised Learningå’ŒDomain Adaptationçš„æ­£åˆ™åŒ–é¡¹ï¼Œä½† Tent é¦–æ¬¡å°†å…¶ä½œä¸ºFully Test-Time Adaptationä¸­å”¯ä¸€çš„æ— ç›‘ç£æŸå¤±æ¥é©±åŠ¨æ¨¡å‹é€‚åº”ã€‚ Feature Modulationï¼šå½’ä¸€åŒ–å±‚å’Œä»¿å°„å˜æ¢å·²è¢«ç”¨äºå„ç§ä»»åŠ¡çš„ç‰¹å¾è°ƒåˆ¶ï¼Œä½† Tent å°†å…¶ä½œä¸ºåœ¨æµ‹è¯•æ—¶é€šè¿‡æ— ç›‘ç£ç›®æ ‡è¿›è¡Œä¼˜åŒ–çš„æ ¸å¿ƒæœºåˆ¶ã€‚ Discussion Tent é€šè¿‡Test Entropy Minimizationå®ç°äº†åœ¨æ•°æ®æ¼‚ç§»æƒ…å†µä¸‹çš„æ³›åŒ–è¯¯å·®é™ä½ã€‚å…¶æ ¸å¿ƒåœ¨äºæ¨¡å‹çš„è‡ªç›‘ç£è‡ªæˆ‘æ”¹è¿›ï¼Œå³ä¾æ®è‡ªèº«çš„é¢„æµ‹åé¦ˆè¿›è¡Œè°ƒæ•´ã€‚\nä¼˜åŠ¿æ€»ç»“ï¼š é«˜æ•ˆï¼šä»…é€šè¿‡åœ¨çº¿ä¼˜åŒ–å°‘æ•°å‚æ•°ï¼ˆ$ \\gamma, \\beta $ï¼‰å®ç°ã€‚ å®ç”¨ï¼šæ— éœ€æºæ•°æ®è®¿é—®ï¼Œä¸æ”¹å˜æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ã€‚ é€šç”¨ï¼šé€‚ç”¨äºå¤šç§æ•°æ®æ¼‚ç§»ç±»å‹å’Œä¸åŒç½‘ç»œæ¶æ„ã€‚ å°½ç®¡ Tent åœ¨å¹¿æ³›çš„åœºæ™¯ä¸­è¡¨ç°å‡ºè‰²ï¼Œä½†ä»å­˜åœ¨æŒ‘æˆ˜ï¼Œä¾‹å¦‚åœ¨ç‰¹å®šå›°éš¾çš„æ•°æ®æ¼‚ç§»ï¼ˆå¦‚ SVHN åˆ° MNIST-M/USPSï¼‰ä¸Šä»æœ‰æå‡ç©ºé—´ã€‚æœªæ¥ç ”ç©¶æ–¹å‘å¯æ¢ç´¢æ›´å…¨é¢çš„å‚æ•°è°ƒæ•´ã€æ›´é€šç”¨çš„Test-Time Adaptation Lossä»¥åŠè¿›ä¸€æ­¥æå‡æ•ˆç‡çš„æ–¹æ³•ã€‚æ€»è€Œè¨€ä¹‹ï¼ŒTent ä¸ºFully Test-Time Adaptation æä¾›äº†ä¸€ä¸ªåˆ›æ–°ä¸”å®ç”¨çš„èŒƒå¼ï¼Œä½¿å¾—æ¨¡å‹èƒ½å¤Ÿåœ¨éƒ¨ç½²åï¼Œåœ¨é¢å¯¹æœªçŸ¥ä¸”æ— æ ‡ç­¾çš„æµ‹è¯•æ•°æ®æ—¶ï¼Œå…·å¤‡å¼ºå¤§çš„è‡ªæˆ‘é€‚åº”èƒ½åŠ›ã€‚\n","permalink":"https://diefish1024.github.io/posts/literature-notes/tent/","summary":"\u003ch1 id=\"setting\"\u003eSetting\u003c/h1\u003e\n\u003cp\u003e\u003cstrong\u003eFully Test-Time Adaptation\u003c/strong\u003e æ˜¯ä¸€ç§ç‹¬ç‰¹çš„æ¨¡å‹é€‚åº”è®¾å®šã€‚åœ¨æ­¤è®¾å®šä¸‹ï¼Œæ¨¡å‹ $ f_\\theta(x) $ åœ¨è®­ç»ƒé˜¶æ®µå·²é€šè¿‡æºæ•°æ® $ x^s $ å’Œæ ‡ç­¾ $ y^s $ å®Œæˆè®­ç»ƒï¼Œè·å¾—å‚æ•° $ \\theta $ã€‚ä½†åœ¨æµ‹è¯•é˜¶æ®µï¼Œæ¨¡å‹å°†é‡åˆ°ä¸æºæ•°æ®åˆ†å¸ƒä¸åŒçš„æ— æ ‡ç­¾ç›®æ ‡æ•°æ® $ x^t $ã€‚\u003c/p\u003e\n\u003cp\u003eFTT-Adaptation ä¸ä»¥ä¸‹æ–¹æ³•ä¸åŒï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eFine-tuning\u003c/strong\u003eï¼šéœ€è¦ç›®æ ‡æ ‡ç­¾è¿›è¡Œé‡æ–°è®­ç»ƒã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDomain Adaptation\u003c/strong\u003eï¼šéœ€è¦æºæ•°æ®å’Œç›®æ ‡æ•°æ®è¿›è¡Œè”åˆè®­ç»ƒã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eTest-Time Training (TTT)\u003c/strong\u003eï¼šéœ€è¦ä¿®æ”¹è®­ç»ƒè¿‡ç¨‹å¹¶å…±åŒä¼˜åŒ–æœ‰ç›‘ç£åŠè‡ªç›‘ç£æŸå¤±ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç›¸æ¯”ä¹‹ä¸‹ï¼ŒFTT-Adaptation ä»…èƒ½åˆ©ç”¨é¢„è®­ç»ƒæ¨¡å‹ $ f_\\theta $ å’Œæ— æ ‡ç­¾ç›®æ ‡æ•°æ® $ x^t $ è¿›è¡Œé€‚åº”ï¼Œä¸ä¾èµ–æºæ•°æ®æˆ–é¢å¤–çš„ç›‘ç£ä¿¡æ¯ã€‚\u003c/p\u003e\n\u003ch2 id=\"method\"\u003eMethod\u003c/h2\u003e\n\u003cp\u003eè®ºæ–‡çš„æ ¸å¿ƒè´¡çŒ®æ˜¯æå‡ºäº† \u003cstrong\u003eTent\u003c/strong\u003e æ–¹æ³•ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡\u003cstrong\u003eæœ€å°åŒ–æµ‹è¯•ç†µ\u003c/strong\u003eï¼ˆ\u003cstrong\u003eTest Entropy Minimization\u003c/strong\u003eï¼‰æ¥é€‚åº”æ¨¡å‹é¢„æµ‹ï¼Œæ—¨åœ¨ä½¿æ¨¡å‹å¯¹æµ‹è¯•æ•°æ®çš„é¢„æµ‹ç»“æœæ›´â€œæœ‰ä¿¡å¿ƒâ€ã€‚\u003c/p\u003e\n\u003ch3 id=\"entropy-objective\"\u003eEntropy Objective\u003c/h3\u003e\n\u003cp\u003eTent çš„æµ‹è¯•æ—¶ç›®æ ‡å‡½æ•°æ˜¯æœ€å°åŒ–æ¨¡å‹é¢„æµ‹ $ \\hat{y} = f_\\theta(x^t) $ çš„\u003cstrong\u003eç†µ $ H(\\hat{y}) $\u003c/strong\u003eã€‚è®ºæ–‡ä¸­ä½¿ç”¨çš„\u003cstrong\u003eé¦™å†œç†µ\u003c/strong\u003eè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š\u003c/p\u003e\n$$ \n\nH(\\hat{y}) = - \\sum_c p(\\hat{y}_c) \\log p(\\hat{y}_c)\n\n $$\n\u003cp\u003eå…¶ä¸­ï¼Œ $ p(\\hat{y}_c) $ è¡¨ç¤ºæ¨¡å‹é¢„æµ‹ç›®æ ‡æ•°æ® $ x^t $ å±äºç±»åˆ« $ c $ çš„æ¦‚ç‡ã€‚\u003c/p\u003e","title":"Tent"}]