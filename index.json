[{"content":"æ¨ç†æ•ˆç‡å¯¹äº llm æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„é—®é¢˜ã€‚å½“æ¨¡å‹ç”Ÿæˆæ–‡æœ¬æ—¶ï¼Œå°¤å…¶æ˜¯ä»¥è‡ªå›å½’æ–¹å¼é€è¯ç”Ÿæˆæ—¶ï¼Œæ•ˆç‡ç“¶é¢ˆä¼šå˜å¾—éå¸¸æ˜æ˜¾ã€‚KV Cache å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜è€Œè¯ç”Ÿçš„æŠ€æœ¯ã€‚\n1. What is KV Cache? KV Cacheï¼Œå…¨ç§° Key-Value Cacheï¼Œæ˜¯ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºåŠ é€Ÿ Transformer æ¶æ„åœ¨è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹ä¸­çš„æ¨ç†é€Ÿåº¦ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ç¼“å­˜å¹¶é‡ç”¨åœ¨æ³¨æ„åŠ›æœºåˆ¶ä¸­è®¡ç®—å¾—åˆ°çš„ Key (K) å’Œ Value (V) å‘é‡ã€‚\n2. Transformer Attention Mechanism Review è¦ç†è§£ KV Cacheï¼Œé¦–å…ˆéœ€è¦å¯¹ Transformer æ¶æ„ä¸­çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶æœ‰ä¸€ä¸ªåŸºæœ¬è®¤è¯†ã€‚è‡ªæ³¨æ„åŠ›æœºåˆ¶å…è®¸æ¨¡å‹åœ¨å¤„ç†åºåˆ—ä¸­çš„æŸä¸ªè¯æ—¶ï¼Œè€ƒè™‘åºåˆ—ä¸­æ‰€æœ‰å…¶ä»–è¯çš„é‡è¦æ€§ã€‚\næ¯ä¸ªè¾“å…¥ tokenï¼ˆè¯æˆ–å­è¯ï¼‰åœ¨è¿›å…¥æ³¨æ„åŠ›å±‚æ—¶ï¼Œéƒ½ä¼šè¢«è½¬æ¢æˆä¸‰ä¸ªä¸åŒçš„å‘é‡ï¼š\nQ å‘é‡ï¼šä»£è¡¨å½“å‰ token çš„â€œæŸ¥è¯¢â€ä¿¡æ¯ K å‘é‡ï¼šä»£è¡¨æ‰€æœ‰ token çš„â€œé”®â€ä¿¡æ¯ï¼Œç”¨äºä¸ Query è¿›è¡ŒåŒ¹é… V å‘é‡ï¼šä»£è¡¨æ‰€æœ‰ token çš„â€œå€¼â€ä¿¡æ¯ï¼Œç”¨äºåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°æœ€ç»ˆçš„è¾“å‡º è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„è®¡ç®—è¿‡ç¨‹ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š\nè®¡ç®— Query ä¸æ‰€æœ‰ Key çš„ç‚¹ç§¯ï¼Œå¾—åˆ°æ³¨æ„åŠ›åˆ†æ•° å°†æ³¨æ„åŠ›åˆ†æ•°è¿›è¡Œç¼©æ”¾ï¼Œé™¤ä»¥ $\\sqrt{d_k}$ï¼ˆ$d_k$ æ˜¯ Key å‘é‡çš„ç»´åº¦) å¯¹ç¼©æ”¾åçš„åˆ†æ•°è¿›è¡Œ Softmaxï¼Œå°†å…¶è½¬æ¢ä¸ºæ³¨æ„åŠ›æƒé‡ï¼Œè¡¨ç¤ºæ¯ä¸ª token å¯¹å½“å‰ token çš„é‡è¦æ€§ å°†æ³¨æ„åŠ›æƒé‡ä¸ Value å‘é‡è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°å½“å‰ token çš„æ³¨æ„åŠ›è¾“å‡º å…¬å¼ä¸ºï¼š $$ \\text{Attention}(Q, K, V) = \\text{softmax}\\left(\\frac{QK^T}{\\sqrt{d_k}}\\right)V $$ å…¶ä¸­çŸ©é˜µ $Q,K,V \\in \\mathbb{R}^{L \\times d}$ ï¼Œ$L$ ä¸ºå½“å‰ä¸Šä¸‹æ–‡é•¿åº¦\nï¼ˆå¤„äºç®€æ´æ€§çš„è€ƒè™‘ï¼Œå¿½ç•¥äº† Causal Mask ï¼Œå®é™…ä¸Š $QK^{T}$ åº”è¯¥ Mask æˆä¸‹ä¸‰è§’çŸ©é˜µæ¥å¼ºåˆ¶ä¸èƒ½çœ‹åˆ°åºåˆ—æœªæ¥çš„ä¿¡æ¯ï¼‰\n3. The Problem KV Cache Solves åœ¨å¤§å‹è¯­è¨€æ¨¡å‹ä¸­ï¼Œå½“æ¨¡å‹ä»¥è‡ªå›å½’æ–¹å¼ç”Ÿæˆæ–‡æœ¬æ—¶ï¼ˆæ¯æ¬¡ç”Ÿæˆä¸€ä¸ªæ–° tokenï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°è¾“å…¥åºåˆ—ä¸­ï¼Œç„¶åæ ¹æ®æ•´ä¸ªåºåˆ—ç”Ÿæˆä¸‹ä¸€ä¸ª tokenï¼‰ï¼Œä¼šé‡åˆ°ä¸€ä¸ªæ•ˆç‡é—®é¢˜ï¼š\nå‡è®¾æˆ‘ä»¬è¦ç”Ÿæˆâ€œä¸­åäººæ°‘â€\nè¾“å…¥ï¼šâ€œä¸­â€ æ¨¡å‹è®¡ç®—â€œä¸­â€çš„ $Q, K, V$ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œåâ€ è¾“å…¥ï¼šâ€œä¸­åâ€ æ¨¡å‹å†æ¬¡è®¡ç®—â€œä¸­â€å’Œâ€œåâ€çš„ $Q, K, V$ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œäººâ€ è¾“å…¥ï¼šâ€œä¸­åäººâ€ æ¨¡å‹å†æ¬¡è®¡ç®—â€œä¸­â€ã€â€œåâ€å’Œâ€œäººâ€çš„ $Q, K, V$ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œæ°‘â€ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ¯ä¸€æ­¥ç”Ÿæˆæ–° token æ—¶ï¼Œéƒ½éœ€è¦é‡æ–°è®¡ç®—ä¹‹å‰å·²ç»å¤„ç†è¿‡çš„æ‰€æœ‰ token çš„ $K$ å’Œ $V$ å‘é‡ã€‚è¿™ç§é‡å¤è®¡ç®—åœ¨åºåˆ—è¾ƒé•¿æ—¶ä¼šæ¶ˆè€—å¤§é‡çš„è®¡ç®—èµ„æºå’Œæ—¶é—´ï¼Œæ•ˆç‡ä½ä¸‹ã€‚\n4. How KV Cache Works æ ¹æ®ä¸Šé¢åˆ†æå¾—åˆ°çš„é—®é¢˜ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ° KV Cache çš„æ ¸å¿ƒæ€æƒ³ï¼šå°†å·²ç»è®¡ç®—è¿‡çš„ Key å’Œ Value å‘é‡ç¼“å­˜èµ·æ¥ï¼Œåœ¨åç»­çš„ç”Ÿæˆæ­¥éª¤ä¸­ç›´æ¥é‡ç”¨ï¼Œè€Œä¸æ˜¯é‡æ–°è®¡ç®—ã€‚\nä»¥ç”Ÿæˆâ€œä¸­åäººæ°‘â€ä¸ºä¾‹ï¼Œä½¿ç”¨ KV Cache çš„æµç¨‹å¦‚ä¸‹ï¼š\nè¾“å…¥ï¼šâ€œä¸­â€ è®¡ç®—â€œä¸­â€çš„ $K_1, V_1$ å°† $K_1, V_1$ å­˜å…¥ KV Cache ä½¿ç”¨ $Q_1, K_1, V_1$ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œåâ€ è¾“å…¥ï¼šâ€œåâ€ï¼ˆå½“å‰ token åªæœ‰â€œåâ€ï¼Œä½†æ³¨æ„åŠ›è¦å…³æ³¨æ•´ä¸ªåºåˆ—â€œä¸­åâ€ï¼‰ è®¡ç®—â€œåâ€çš„ $K_2, V_2$ å°† $K_2, V_2$ æ·»åŠ åˆ° KV Cacheã€‚æ­¤æ—¶ KV Cache åŒ…å« $[K_1, K_2]$ å’Œ $[V_1, V_2]$ ä½¿ç”¨å½“å‰ $Q_2$ å’Œç¼“å­˜ä¸­çš„ $[K_1, K_2], [V_1, V_2]$ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œäººâ€ è¾“å…¥ï¼šâ€œäººâ€ è®¡ç®—â€œäººâ€çš„ $K_3, V_3$ å°† $K_3, V_3$ æ·»åŠ åˆ° KV Cacheã€‚æ­¤æ—¶ KV Cache åŒ…å« $[K_1, K_2, K_3]$ å’Œ $[V_1, V_2, V_3]$ ä½¿ç”¨å½“å‰ $Q_3$ å’Œç¼“å­˜ä¸­çš„ $[K_1, K_2, K_3], [V_1, V_2, V_3]$ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œæ°‘â€ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ¯ä¸€æ­¥åªéœ€è¦è®¡ç®—å½“å‰æ–°ç”Ÿæˆ token çš„ $K, V$ å‘é‡ï¼Œè€Œæ— éœ€é‡æ–°è®¡ç®—ä¹‹å‰æ‰€æœ‰ token çš„ $K, V$ã€‚\n5. Why Not QKV Cache? å¯èƒ½ä¼šå¥½å¥‡ï¼Œæ—¢ç„¶ K å’Œ V éƒ½éœ€è¦ç¼“å­˜ï¼Œä¸ºä»€ä¹ˆä¸ä¹Ÿç¼“å­˜ Q å‘¢ï¼Ÿä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ºä»€ä¹ˆæ˜¯ KV Cache è€Œä¸æ˜¯ QKV Cacheï¼Ÿ\nåŸå› åœ¨äº Q å‘é‡çš„æ€§è´¨ï¼š\nQ å‘é‡æ˜¯ç”¨æ¥â€œæŸ¥è¯¢â€å½“å‰ token ä¸åºåˆ—ä¸­å…¶ä»– token çš„ç›¸å…³æ€§çš„ã€‚åœ¨è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€æ­¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ tokenï¼Œè¿™ä¸ªæ–° token å¯¹åº”çš„ Query å‘é‡æ˜¯æ–°çš„ï¼Œå®ƒåŸºäºå½“å‰æ­¥çš„éšè—çŠ¶æ€è®¡ç®—å¾—å‡ºã€‚æ¢å¥è¯è¯´ï¼Œæ¯æ¬¡ç”Ÿæˆæ–° token æ—¶ï¼Œå…¶å¯¹åº”çš„ $Q$ å‘é‡éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œå¹¶ä¸”éœ€è¦é‡æ–°è®¡ç®—ä»¥åæ˜ æœ€æ–°çš„ç”Ÿæˆä¸Šä¸‹æ–‡ã€‚ K å’Œ V å‘é‡åˆ™ä»£è¡¨äº†åºåˆ—ä¸­æ¯ä¸ª token çš„â€œå†…å®¹â€ä¿¡æ¯ã€‚å¯¹äºå·²ç»å¤„ç†è¿‡çš„ tokenï¼Œå®ƒä»¬çš„ $K$ å’Œ $V$ å‘é‡ä¸€æ—¦è®¡ç®—å‡ºæ¥ï¼Œå…¶å†…å®¹ä¿¡æ¯å°±æ˜¯å›ºå®šä¸å˜çš„ã€‚å› æ­¤ï¼Œè¿™äº› $K$ å’Œ $V$ å‘é‡å¯ä»¥ç›´æ¥è¢«ç¼“å­˜å¹¶åå¤ä½¿ç”¨ï¼Œè€Œæ— éœ€é‡æ–°è®¡ç®—ã€‚ å› æ­¤ï¼Œä¸ç¼“å­˜ Q æ˜¯å› ä¸ºå®ƒåœ¨æ¯ä¸€æ­¥éƒ½æ˜¯ä¸€ä¸ªæ–°çš„è®¡ç®—ç»“æœï¼›è€Œç¼“å­˜ K å’Œ V åˆ™å¯ä»¥æ˜¾è‘—å‡å°‘é‡å¤è®¡ç®—ï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚\n6. KV Cache in Attention Mechanism åœ¨æ•°å­¦ä¸Šï¼Œå½“ä½¿ç”¨ KV Cache è¿›è¡Œè‡ªå›å½’è§£ç æ—¶ï¼Œæ³¨æ„åŠ›å…¬å¼ä¸­çš„ $K$ å’Œ $V$ çŸ©é˜µä¼šéšç€ç”Ÿæˆè¿‡ç¨‹çš„è¿›è¡Œè€Œä¸æ–­å¢é•¿ã€‚\nå‡è®¾æˆ‘ä»¬æ­£åœ¨ç”Ÿæˆç¬¬ $t$ ä¸ª tokenã€‚\nå½“å‰ token çš„ Q å‘é‡æ˜¯ $Q_t$ ï¼Œè¿™æ˜¯ä¸€ä¸ªè¡Œå‘é‡ï¼Œä»£è¡¨å½“å‰ç¬¬ $t$ ä¸ª token çš„ Query ï¼Œç»´åº¦ä¸º $1 \\times d_k$ K çŸ©é˜µ $K_{\\text{cached}}$ å°†åŒ…å«ä»ç¬¬ä¸€ä¸ª token åˆ°ç¬¬ $t$ ä¸ª token çš„æ‰€æœ‰ K å‘é‡ï¼š $K_{\\text{cached}} = [K_1^T, K_2^T, \\dots, K_t^T]^T$ ï¼Œç»´åº¦ä¸º $t \\times d_k$ V çŸ©é˜µ $V_{\\text{cached}}$ å°†åŒ…å«ä»ç¬¬ä¸€ä¸ª token åˆ°ç¬¬ $t$ ä¸ª token çš„æ‰€æœ‰ V å‘é‡ï¼š $V_{\\text{cached}} = [V_1^T, V_2^T, \\dots, V_t^T]^T$ ã€‚å…¶ç»´åº¦ä¸º $t \\times d_v$ é‚£ä¹ˆï¼Œç¬¬ $t$ ä¸ª token çš„æ³¨æ„åŠ›è®¡ç®—å˜ä¸ºï¼š $$ \\text{Attention}_{t}(Q_t, K_{\\text{cached}}, V_{\\text{cached}}) = \\text{softmax}\\left(\\frac{Q_t K_{\\text{cached}}^T}{\\sqrt{d_k}}\\right)V_{\\text{cached}} $$ å…¶ä¸­\n$Q_t K_{\\text{cached}}^T$ æ˜¯ä¸€ä¸ª $1 \\times t$ çš„è¡Œå‘é‡ï¼Œä»£è¡¨å½“å‰ Query ä¸æ‰€æœ‰å†å² Key çš„ç›¸å…³æ€§åˆ†æ•° $\\text{softmax}$ æ“ä½œå°†è¿™ä¸ª $1 \\times t$ çš„å‘é‡è½¬åŒ–ä¸ºæ³¨æ„åŠ›æƒé‡ è¿™ä¸ª $1 \\times t$ çš„æ³¨æ„åŠ›æƒé‡å‘é‡å†ä¸ $V_{\\text{cached}}$ çŸ©é˜µï¼ˆç»´åº¦ $t \\times d_v$ï¼‰ç›¸ä¹˜ï¼Œå¾—åˆ°æœ€ç»ˆçš„æ³¨æ„åŠ›è¾“å‡ºï¼Œç»´åº¦æ˜¯ $1 \\times d_v$ æ¯æ¬¡ç”Ÿæˆæ–°çš„ token $t+1$ æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦è®¡ç®—æ–°çš„ $Q_{t+1}$ï¼Œå°†æ–°è®¡ç®—çš„ $K_{t+1}$ å’Œ $V_{t+1}$ æ‹¼æ¥åˆ° $K_{\\text{cached}}$ å’Œ $V_{\\text{cached}}$ æœ«å°¾ï¼Œå½¢æˆ $K\u0026rsquo;_{\\text{cached}} = \\text{concat}(K_{\\text{cached}}, K_{t+1})$ å’Œ $V\u0026rsquo;_{\\text{cached}} = \\text{concat}(V_{\\text{cached}}, V_{t+1})$\n7. Limitations and Considerations å°½ç®¡ KV Cache å¸¦æ¥äº†å·¨å¤§çš„æ€§èƒ½æå‡ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š\nå†…å­˜å ç”¨ï¼šKV Cache éœ€è¦å­˜å‚¨æ‰€æœ‰å·²å¤„ç† token çš„ Key å’Œ Value å‘é‡ã€‚å¯¹äºå¤§å‹æ¨¡å‹å’Œé•¿ä¸Šä¸‹æ–‡åºåˆ—ï¼Œè¿™äº›ç¼“å­˜å¯èƒ½éå¸¸å¤§ï¼Œå¯¼è‡´æ˜¾å­˜ï¼ˆGPU Memoryï¼‰æˆä¸ºç“¶é¢ˆã€‚ ä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶ï¼šç”±äºå†…å­˜é™åˆ¶ï¼ŒKV Cache ä¼šé™åˆ¶æ¨¡å‹èƒ½å¤Ÿå¤„ç†çš„æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦ã€‚ä¸€æ—¦è¾¾åˆ°å†…å­˜ä¸Šé™ï¼Œå°±éœ€è¦é‡‡å–ç­–ç•¥æ¥ç®¡ç†ç¼“å­˜ï¼Œä¾‹å¦‚ä¸¢å¼ƒæœ€æ—©çš„ Key/Value å¯¹ï¼ˆç±»ä¼¼äºå¾ªç¯ç¼“å†²åŒºï¼‰ï¼Œä½†è¿™å¯èƒ½ä¼šå½±å“æ¨¡å‹å¯¹é•¿è·ç¦»ä¾èµ–çš„ç†è§£ã€‚ Summary KV Cache æ˜¯ Transformer æ¨¡å‹åœ¨è‡ªå›å½’æ¨ç†è¿‡ç¨‹ä¸­éå¸¸é‡è¦çš„ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ã€‚é€šè¿‡ç¼“å­˜å¹¶é‡ç”¨å·²ç»è®¡ç®—è¿‡çš„ Key å’Œ Value å‘é‡ï¼Œå®ƒæå¤§åœ°å‡å°‘äº†é‡å¤è®¡ç®—ï¼Œä»è€Œæ˜¾è‘—æå‡äº†å¤§å‹è¯­è¨€æ¨¡å‹çš„ç”Ÿæˆé€Ÿåº¦ã€‚\nReferences KV Cache åŸç†è®²è§£ ï¼ˆBilibiliï¼‰ æ³¨æ„ï¼šæ­¤è§†é¢‘å†…å®¹å­˜åœ¨éƒ¨åˆ†é”™è¯¯ çœ‹å›¾å­¦KV Cacheï¼ˆçŸ¥ä¹ï¼‰ ä¸ºä»€ä¹ˆæ²¡æœ‰Q Cacheï¼ˆçŸ¥ä¹ï¼‰ ","permalink":"https://diefish1024.github.io/posts/notes/ai-infra/kv-cache-%E5%85%A5%E9%97%A8/","summary":"\u003cp\u003eæ¨ç†æ•ˆç‡å¯¹äº llm æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„é—®é¢˜ã€‚å½“æ¨¡å‹ç”Ÿæˆæ–‡æœ¬æ—¶ï¼Œå°¤å…¶æ˜¯ä»¥è‡ªå›å½’æ–¹å¼é€è¯ç”Ÿæˆæ—¶ï¼Œæ•ˆç‡ç“¶é¢ˆä¼šå˜å¾—éå¸¸æ˜æ˜¾ã€‚KV Cache å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜è€Œè¯ç”Ÿçš„æŠ€æœ¯ã€‚\u003c/p\u003e\n\u003ch3 id=\"1-what-is-kv-cache\"\u003e1. What is KV Cache?\u003c/h3\u003e\n\u003cp\u003eKV Cacheï¼Œå…¨ç§° \u003cstrong\u003eKey-Value Cache\u003c/strong\u003eï¼Œæ˜¯ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºåŠ é€Ÿ Transformer æ¶æ„åœ¨è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹ä¸­çš„æ¨ç†é€Ÿåº¦ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯\u003cstrong\u003eç¼“å­˜\u003c/strong\u003eå¹¶\u003cstrong\u003eé‡ç”¨\u003c/strong\u003eåœ¨æ³¨æ„åŠ›æœºåˆ¶ä¸­è®¡ç®—å¾—åˆ°çš„ \u003cstrong\u003eKey (K)\u003c/strong\u003e å’Œ \u003cstrong\u003eValue (V)\u003c/strong\u003e å‘é‡ã€‚\u003c/p\u003e\n\u003ch3 id=\"2-transformer-attention-mechanism-review\"\u003e2. Transformer Attention Mechanism Review\u003c/h3\u003e\n\u003cp\u003eè¦ç†è§£ KV Cacheï¼Œé¦–å…ˆéœ€è¦å¯¹ Transformer æ¶æ„ä¸­çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶æœ‰ä¸€ä¸ªåŸºæœ¬è®¤è¯†ã€‚è‡ªæ³¨æ„åŠ›æœºåˆ¶å…è®¸æ¨¡å‹åœ¨å¤„ç†åºåˆ—ä¸­çš„æŸä¸ªè¯æ—¶ï¼Œè€ƒè™‘åºåˆ—ä¸­æ‰€æœ‰å…¶ä»–è¯çš„é‡è¦æ€§ã€‚\u003c/p\u003e\n\u003cp\u003eæ¯ä¸ªè¾“å…¥ tokenï¼ˆè¯æˆ–å­è¯ï¼‰åœ¨è¿›å…¥æ³¨æ„åŠ›å±‚æ—¶ï¼Œéƒ½ä¼šè¢«è½¬æ¢æˆä¸‰ä¸ªä¸åŒçš„å‘é‡ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eQ å‘é‡ï¼šä»£è¡¨å½“å‰ token çš„â€œæŸ¥è¯¢â€ä¿¡æ¯\u003c/li\u003e\n\u003cli\u003eK å‘é‡ï¼šä»£è¡¨æ‰€æœ‰ token çš„â€œé”®â€ä¿¡æ¯ï¼Œç”¨äºä¸ Query è¿›è¡ŒåŒ¹é…\u003c/li\u003e\n\u003cli\u003eV å‘é‡ï¼šä»£è¡¨æ‰€æœ‰ token çš„â€œå€¼â€ä¿¡æ¯ï¼Œç”¨äºåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°æœ€ç»ˆçš„è¾“å‡º\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè‡ªæ³¨æ„åŠ›æœºåˆ¶çš„è®¡ç®—è¿‡ç¨‹ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eè®¡ç®— Query ä¸æ‰€æœ‰ Key çš„ç‚¹ç§¯ï¼Œå¾—åˆ°\u003cstrong\u003eæ³¨æ„åŠ›åˆ†æ•°\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003eå°†æ³¨æ„åŠ›åˆ†æ•°è¿›è¡Œç¼©æ”¾ï¼Œé™¤ä»¥ $\\sqrt{d_k}$ï¼ˆ$d_k$ æ˜¯ Key å‘é‡çš„ç»´åº¦)\u003c/li\u003e\n\u003cli\u003eå¯¹ç¼©æ”¾åçš„åˆ†æ•°è¿›è¡Œ Softmaxï¼Œå°†å…¶è½¬æ¢ä¸º\u003cstrong\u003eæ³¨æ„åŠ›æƒé‡\u003c/strong\u003eï¼Œè¡¨ç¤ºæ¯ä¸ª token å¯¹å½“å‰ token çš„é‡è¦æ€§\u003c/li\u003e\n\u003cli\u003eå°†æ³¨æ„åŠ›æƒé‡ä¸ Value å‘é‡è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°å½“å‰ token çš„æ³¨æ„åŠ›è¾“å‡º\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eå…¬å¼ä¸ºï¼š\n$$\n\\text{Attention}(Q, K, V) = \\text{softmax}\\left(\\frac{QK^T}{\\sqrt{d_k}}\\right)V\n$$\nå…¶ä¸­çŸ©é˜µ $Q,K,V \\in \\mathbb{R}^{L \\times d}$ ï¼Œ$L$ ä¸ºå½“å‰ä¸Šä¸‹æ–‡é•¿åº¦\u003c/p\u003e","title":"KV Cache å…¥é—¨"},{"content":"åŒæ­¥å’Œæ¡ä»¶å˜é‡ äº’æ–¥å®ç°äº†åŸå­æ€§ï¼Œä½†æ˜¯æ— æ³•å®ç°ç¡®å®šæ€§ï¼Œä¹Ÿå°±æ˜¯æ— æ³•æ­£ç¡®å®ç° \u0026ldquo;happens-before\u0026rdquo; çš„å…³ç³»\nå› æ­¤éœ€è¦å¼•å…¥æ¡ä»¶å˜é‡æ¥å®ç°çº¿ç¨‹çš„åŒæ­¥ï¼Œå½¢æˆå—æ§åˆ¶çš„å¹¶å‘äº‹ä»¶çš„å‘ç”Ÿé¡ºåºï¼ˆå¯ä»¥ç”¨ä¹å›¢æŒ‡æŒ¥æ¥ç±»æ¯”ï¼‰ï¼ŒæŠŠä¸€ç³»åˆ—ä¸ç¡®å®šçš„çŠ¶æ€åœ¨æŸä¸€ä¸ªæ—¶é—´ç‚¹åŒæ­¥åˆ°äº†ä¸€ä¸ªç¡®å®šçš„çŠ¶æ€ï¼Œå°†å‘æ•£çš„å¹¶å‘ç¨‹åºçŠ¶æ€ â€œæ”¶æŸâ€\nå®ç°åŒæ­¥\nå®ç° $A\\to B$:\n1 2 3 4 5 6 7 A; can_proceed = true; (signal) while(!can_proceed); B // B: wait until the condition is satisfied è¿™æ ·çš„æ€è·¯å¤§è‡´æ­£ç¡®ï¼Œä½†æ˜¯è‡ªé€‰çš„å¾ªç¯æœ‰å¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªæ›´åŠ åº•å±‚çš„æœºåˆ¶æ¥å¸®åŠ©å®ç°è¿™ä¸€ç‚¹\næœ€ç†æƒ³çš„ API æ˜¯ wait_until(cond) ï¼Œä½†æ˜¯è¿‡å»ä¸ºäº†ç®€åŒ–è®¾è®¡ï¼Œå˜æˆäº†\næ¡ä»¶ä¸æ»¡è¶³æ—¶ç­‰å¾…ï¼šwait - ç›´æ¥ç¡çœ ç­‰å¾… æ¡ä»¶æ»¡è¶³æ—¶ç»§ç»­ï¼šsignal/broadcast - å”¤é†’æ‰€æœ‰çº¿ç¨‹ ï¼ˆå°æ—¶å€™çš„ scratch ç¼–ç¨‹å…¶å®å·²ç»æœ‰äº†è¿™æ ·çš„æ€æƒ³ğŸ˜‚ï¼‰\nåœ¨ c++ ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥æŠŠæ¡ä»¶æ”¾åˆ° $\\lambda$ è¡¨è¾¾å¼ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 std::mutex mtx; std::condition_variable cv; void T_player() { std::unique_lock lk(mtx); cv.wait(lk, []{ return can_proceed; } ); cv.notify_all(); lk.unlock(); } æ³¨æ„æ¡ä»¶å˜é‡åœ¨ç­‰å¾…æ—¶éœ€è¦å¸¦ç€ä¸€æŠŠé”ï¼ˆéœ€è¦ç¡®ä¿æ£€æŸ¥å’Œç­‰å¾…æ˜¯åŸå­æ“ä½œï¼‰\nä½¿ç”¨æ¡ä»¶å˜é‡è§£å†³åŒæ­¥é—®é¢˜ å¤§éƒ¨åˆ†çš„åŒæ­¥é—®é¢˜éƒ½å¯ä»¥ç”¨ç»å…¸çš„ç”Ÿäº§è€… - æ¶ˆè´¹è€…é—®é¢˜å½’çº³ï¼š\nProducer å’Œ Consumer å…±äº«ä¸€ä¸ªç¼“å†²åŒºï¼Œå…¶ä¸­\nProducer çœ‹åˆ°ç¼“å†²åŒºæœ‰ç©ºä½å°±ä¼šæ”¾å…¥ï¼Œå¦åˆ™ç­‰å¾… Consumer çœ‹åˆ°ç¼“å†²åŒºæœ‰æ•°æ®å°±å›å»èµ°ï¼Œå¦åˆ™ç­‰å¾… æ˜¾ç„¶ä¸€ä¸ªå¯¹è±¡çš„ç”Ÿäº§å’Œæ¶ˆè´¹å¿…é¡»æ»¡è¶³ \u0026ldquo;happens-before\u0026rdquo; çš„å…³ç³»\nå¯ä»¥ç­‰ä»·æˆæ‰“å°åŒ¹é…çš„æ‹¬å·ï¼Œå¹¶ä¸”åµŒå¥—æ·±åº¦æœ‰ä¸Šé™ï¼ˆç¼“å†²åŒºçš„æ·±åº¦ï¼‰\nå¤„ç†è¿™æ ·çš„é—®é¢˜é¦–å…ˆè¦æƒ³æ¸…æ¥šç¨‹åºç»§ç»­æ‰§è¡Œçš„æ¡ä»¶ï¼Œæ¯”å¦‚ç”Ÿäº§çš„æ¡ä»¶æ˜¯ $d\u0026lt;n$ ï¼Œè€Œæ¶ˆè´¹çš„æ¡ä»¶æ˜¯ $d\u0026gt;0$ ï¼Œç„¶åå¥—å…¥å›ºå®šçš„æ¨¡æ¿ä»£ç å³å¯ï¼š\n1 2 3 4 5 6 mutex_lock(lk); while (!cond) { // cond can be any calculate cond_wait(\u0026amp;cv, lk); } assert(cond); mutex_lock(lk); 1 2 3 4 mutex_lock(lk); cond = true cond_broadcast(\u0026amp;cv); //âš ï¸ mutex_unlock(lk); æ³¨æ„ï¼šå…¨å±€å¹¿æ’­ cond_broadcast ä¸èƒ½è¢«æ›¿æ¢æˆå•ç‹¬å”¤é†’ä¸€ä¸ªçº¿ç¨‹ cond_signal ï¼Œåœ¨è¿™é‡Œæ˜¾ç„¶å¯èƒ½ä¼šå¯¼è‡´æ‰€æœ‰è¿›ç¨‹éƒ½è¢«é”ä½æ— æ³•è§¦å‘æ–°çš„åŒæ­¥å˜é‡ï¼›å¹¶å‘ç¼–ç¨‹å¾ˆå¤šçœ‹èµ·æ¥æ­£ç¡®çš„åœ°æ–¹éƒ½éœ€è¦ä»”ç»†æ€è€ƒ\né‡åˆ°ä»»ä½•åŒæ­¥é—®é¢˜çš„æ ¸å¿ƒéƒ½æ˜¯åŒæ­¥æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Œæ¯”å¦‚æ‹¬å·æ‰“å°å¯ä»¥æ‹“å±•æˆæ‰“å° \u0026lt;\u0026gt;\u0026lt; æˆ–è€… \u0026gt;\u0026lt;\u0026gt; ä¸¤ç§å½¢çŠ¶ï¼Œæ ¸å¿ƒä¹Ÿæ˜¯ç”»å‡ºçŠ¶æ€æœºï¼Œæ‰¾åˆ°åŒæ­¥æ¡ä»¶ï¼Œå†å¥—å…¥æ¨¡æ¿å°±è§£å†³äº†é—®é¢˜\nè®¡ç®—å›¾ä¸å¹¶å‘æ§åˆ¶ å¹¶è¡Œè®¡ç®—çš„æ¨¡å‹å¯ä»¥ç”¨ä¸€ä¸ª DAG è®¡ç®—å›¾å»ç†è§£ï¼Œä»»åŠ¡ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œé€šè¿‡æ‹“æ‰‘æ’åºçš„é¡ºåºå»è§£å†³é—®é¢˜ï¼Œç›¸äº’ä¸å­˜åœ¨ \u0026ldquo;happens-before\u0026rdquo; ä¾èµ–å…³ç³»çš„ä»»åŠ¡éƒ½å¯ä»¥å¹¶å‘è§£å†³\nä¸ºäº†ä¼˜åŒ–æ•ˆç‡ï¼Œæˆ‘ä»¬å¯¹è®¡ç®—ä»»åŠ¡çš„åˆ†é…éœ€è¦ä¿è¯æ¯ä¸ªèŠ‚ç‚¹è®¡ç®—çš„æ¶ˆè€—æ˜¯è¿œå¤§äºåŒæ­¥å’Œé”çš„å¼€é”€çš„ï¼Œå› æ­¤å®é™…ä¸Šå¯èƒ½æ˜¯æŠŠå¾ˆå¤šä¸ªå°çš„ä»»åŠ¡èšåˆæˆä¸€ä¸ªå¤§çš„å¹¶å‘è®¡ç®—èŠ‚ç‚¹ï¼Œäº¤ç»™ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œ\nå®ç°è®¡ç®—å›¾æœ‰ä¸¤ç§æ€è·¯ï¼Œç¬¬ä¸€ç§æ˜¯æœ´ç´ çš„ä¸ºæ¯ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸€ä¸ªçº¿ç¨‹å’Œæ¡ä»¶å˜é‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // The dependency edge is u-\u0026gt;v void T_u() { // calculate u mutex_lock(v-\u0026gt;lock); v-\u0026gt;num_done++; cond_signal(v-\u0026gt;cv); // it\u0026#39;s okay mutex_unlock(v-\u0026gt;lock); } void T_v() { mutex_lock(v-\u0026gt;lock); while (!(v-\u0026gt;num_done == v-\u0026gt;num_predecessors)){ cond_wait(v-\u0026gt;cv, v-\u0026gt;lock); } mutex_unlock(v-\u0026gt;lock); // calculate v } ä½†æ˜¯è¿™æ ·å®é™…ä¼šäº§ç”Ÿè¿‡å¤šçš„çº¿ç¨‹ï¼Œé€ æˆä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ï¼ˆæ¯”å¦‚äº§ç”Ÿäº†å¤šä½™ CPU çš„ core æ•°é‡çš„çº¿ç¨‹ï¼‰ï¼Œå®é™…ä¸Šæ›´ä¼˜çš„åŠæ³•æ˜¯åˆ›å»ºä¸€ä¸ªä»»åŠ¡è°ƒåº¦å™¨çº¿ç¨‹ $T_{\\text{scheduler}}$ æ¥ä¸“é—¨æ§åˆ¶äº§ç”Ÿ $T_{\\text{worker}}$ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 mutex_lock(lk); while (!(all_done || has_job(tid))) { cond_wait(\u0026amp;worker_cv[tid], lk); } mutex_unlock(lk); if (all_done) { break; } else { process_job(tid); } signal(\u0026amp;sched_cv); ","permalink":"https://diefish1024.github.io/posts/notes/nju-os-2025/15.-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E5%90%8C%E6%AD%A5-1/","summary":"\u003ch2 id=\"åŒæ­¥å’Œæ¡ä»¶å˜é‡\"\u003eåŒæ­¥å’Œæ¡ä»¶å˜é‡\u003c/h2\u003e\n\u003cp\u003eäº’æ–¥å®ç°äº†\u003cstrong\u003eåŸå­æ€§\u003c/strong\u003eï¼Œä½†æ˜¯æ— æ³•å®ç°\u003cstrong\u003eç¡®å®šæ€§\u003c/strong\u003eï¼Œä¹Ÿå°±æ˜¯æ— æ³•æ­£ç¡®å®ç° \u0026ldquo;happens-before\u0026rdquo; çš„å…³ç³»\u003c/p\u003e\n\u003cp\u003eå› æ­¤éœ€è¦å¼•å…¥æ¡ä»¶å˜é‡æ¥å®ç°çº¿ç¨‹çš„åŒæ­¥ï¼Œå½¢æˆå—æ§åˆ¶çš„å¹¶å‘äº‹ä»¶çš„\u003cstrong\u003eå‘ç”Ÿé¡ºåº\u003c/strong\u003eï¼ˆå¯ä»¥ç”¨ä¹å›¢æŒ‡æŒ¥æ¥ç±»æ¯”ï¼‰ï¼ŒæŠŠä¸€ç³»åˆ—ä¸ç¡®å®šçš„çŠ¶æ€åœ¨æŸä¸€ä¸ªæ—¶é—´ç‚¹åŒæ­¥åˆ°äº†ä¸€ä¸ªç¡®å®šçš„çŠ¶æ€ï¼Œå°†å‘æ•£çš„å¹¶å‘ç¨‹åºçŠ¶æ€ â€œæ”¶æŸâ€\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå®ç°åŒæ­¥\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå®ç° $A\\to B$:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-gdscript3\" data-lang=\"gdscript3\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ecan_proceed\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esignal\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003ecan_proceed\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eB\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e//\u003c/span\u003e \u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ewait\u003c/span\u003e \u003cspan class=\"n\"\u003euntil\u003c/span\u003e \u003cspan class=\"n\"\u003ethe\u003c/span\u003e \u003cspan class=\"n\"\u003econdition\u003c/span\u003e \u003cspan class=\"n\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003esatisfied\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eè¿™æ ·çš„æ€è·¯å¤§è‡´æ­£ç¡®ï¼Œä½†æ˜¯è‡ªé€‰çš„å¾ªç¯æœ‰å¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªæ›´åŠ åº•å±‚çš„æœºåˆ¶æ¥å¸®åŠ©å®ç°è¿™ä¸€ç‚¹\u003c/p\u003e\n\u003cp\u003eæœ€ç†æƒ³çš„ API æ˜¯ \u003ccode\u003ewait_until(cond)\u003c/code\u003e ï¼Œä½†æ˜¯è¿‡å»ä¸ºäº†ç®€åŒ–è®¾è®¡ï¼Œå˜æˆäº†\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ¡ä»¶ä¸æ»¡è¶³æ—¶ç­‰å¾…ï¼š\u003ccode\u003ewait\u003c/code\u003e - ç›´æ¥ç¡çœ ç­‰å¾…\u003c/li\u003e\n\u003cli\u003eæ¡ä»¶æ»¡è¶³æ—¶ç»§ç»­ï¼š\u003ccode\u003esignal/broadcast\u003c/code\u003e - å”¤é†’æ‰€æœ‰çº¿ç¨‹\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eï¼ˆå°æ—¶å€™çš„ scratch ç¼–ç¨‹å…¶å®å·²ç»æœ‰äº†è¿™æ ·çš„æ€æƒ³ğŸ˜‚ï¼‰\u003c/p\u003e\n\u003cp\u003eåœ¨ c++ ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥æŠŠæ¡ä»¶æ”¾åˆ° $\\lambda$ è¡¨è¾¾å¼ä¸­ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c++\" data-lang=\"c++\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e \u003cspan class=\"n\"\u003emtx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003econdition_variable\u003c/span\u003e \u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eT_player\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eunique_lock\u003c/span\u003e \u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emtx\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"p\"\u003e[]{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ecan_proceed\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enotify_all\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eunlock\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eæ³¨æ„æ¡ä»¶å˜é‡åœ¨ç­‰å¾…æ—¶éœ€è¦å¸¦ç€ä¸€æŠŠé”ï¼ˆéœ€è¦ç¡®ä¿æ£€æŸ¥å’Œç­‰å¾…æ˜¯åŸå­æ“ä½œï¼‰\u003c/p\u003e","title":"å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ (1)"}]