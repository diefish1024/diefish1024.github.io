[{"content":"Exercise 1 Let $ S \\subseteq V $ be a subset of vectors in a vector space $ V $. A finite subset $ S' \\subseteq S $ is maximally linearly independent in $ S $ if\n$ S' $ is linearly independent, and\nfor any $ v \\in S \\setminus S' $ the set $ S' \\cup \\{v\\} $ is not linearly independent.\nProve that:\n(i) $ S' $ is maximally linearly independent in $ S $ if and only if $ S' $ (viewed as a sequence of vectors) is a basis for $ \\operatorname{span}(S) $.\n(ii) A finite subset $ S \\subseteq V $ constitutes a basis for $ V $ if and only if $ S $ is maximally linearly independent in $ V $.\n(ii) Every finite $ S $ must have a maximally linearly independent $ S' \\subseteq S $ (without assuming that $ V $ is finite dimensional).\nProof:\n(i)\nIf $ S' $ is maximally linearly independent in $ S $, then it is linearly independent. For any $ v \\in S \\setminus S' $, $ S' \\cup \\{v\\} $ is dependent, so $ v \\in \\operatorname{span}(S') $. Thus, $ \\operatorname{span}(S) = \\operatorname{span}(S') $, making $ S' $ a basis for $ \\operatorname{span}(S) $.\nConversely, if $ S' $ is a basis for $ \\operatorname{span}(S) $, it is linearly independent. For any $ v \\in S \\setminus S' $, $ v \\in \\operatorname{span}(S) = \\operatorname{span}(S') $, so $ S' \\cup \\{v\\} $ is dependent.\n(ii)\nIf $ S $ is a finite basis for $ V $, it is linearly independent and spans $ V $. For any $ v \\in V \\setminus S $, $ v \\in \\operatorname{span}(S) $, so $ S \\cup \\{v\\} $ is dependent, making $ S $ maximally linearly independent in $ V $.\nConversely, if $ S $ is maximally linearly independent in $ V $, it is linearly independent. For any $ v \\in V \\setminus S $, $ S \\cup \\{v\\} $ is dependent, so $ v \\in \\operatorname{span}(S) $, hence $ \\operatorname{span}(S) = V $, making $ S $ a basis.\n(iii)\nStart with the empty set, which is linearly independent. Iteratively add vectors from $ S $ that preserve independence until no more can be added. The resulting finite subset is maximally linearly independent in $ S $.\nExercise 2 Let $ u_1, \\ldots, u_n, v, w \\in V $ be linearly dependent. Assume that $ u_1, \\ldots, u_n $ are linearly independent. Then one of the following holds.\n(i) $ v $ is a linear combination of $ u_1, \\ldots, u_n $.\n(ii) $ w $ is a linear combination of $ u_1, \\ldots, u_n $.\n(iii) $ u_1, \\ldots, u_n, v $ are all linear combinations of $ u_1, \\ldots, u_n, w $, and vice versa.\nSince $ \\{u_1, \\ldots, u_n, v, w\\} $ is dependent, there exist scalars not all zero such that $ \\sum a_i u_i + b v + c w = 0 $. If $ b = c = 0 $, this contradicts the independence of the $ u_i $. Thus, $ b \\neq 0 $ or $ c \\neq 0 $ (or both).\nIf $ b \\neq 0 $ and $ c = 0 $, then $ v = -\\frac{1}{b} \\sum a_i u_i $, so (i) holds. If $ b = 0 $ and $ c \\neq 0 $, then $ w = -\\frac{1}{c} \\sum a_i u_i $, so (ii) holds. If $ b \\neq 0 $ and $ c \\neq 0 $, then $ v = -\\frac{1}{b} (\\sum a_i u_i + c w) $ and $ w = -\\frac{1}{c} (\\sum a_i u_i + b v) $, so $ \\operatorname{span}\\{u_1, \\ldots, u_n, v\\} = \\operatorname{span}\\{u_1, \\ldots, u_n, w\\} $, and (iii) holds. Exercise 3 Given $ v_1 = \\begin{pmatrix} 1 \\\\ 1 \\\\ 0 \\\\ 1 \\end{pmatrix}, \\quad v_2 = \\begin{pmatrix} 1 \\\\ 3 \\\\ 0 \\\\ 2 \\end{pmatrix}, \\quad v_3 = \\begin{pmatrix} 2 \\\\ 3 \\\\ 2 \\\\ 1 \\end{pmatrix}, \\quad v_4 = \\begin{pmatrix} -1 \\\\ 1 \\\\ 0 \\\\ 0 \\end{pmatrix}, $\nfind the vector that is not a linear combination of the rest.\nThe vector $ v_3 $ is not a linear combination of the rest, as $ \\operatorname{span}\\{v_1, v_2, v_4\\} $ lies in the subspace where the third coordinate is zero, but $ v_3 $ has third coordinate 2.\nExercise 4 Let $ V $ be finite-dimensional. Under what condition the basis of $ V $ is unique?\nThe basis is unique if and only if $ \\dim V = 0 $, i.e., $ V = \\{0\\} $, where the unique basis is the empty set. For $ \\dim V \\geq 1 $, there are infinitely many bases.\nExercise 5 Consider the vector space $ \\mathbb{R}^4 $. Construct a basis containing the following two vectors.\n$ (1, 1, 0, 1), \\ (10, 7, 2, 3). $ One such basis is $ \\{(1,1,0,1), (10,7,2,3), (0,0,1,0), (0,0,0,1)\\} $.\nExercise 6 Let $ V $ be a finite dimensional vector space. Let $ W $ be a subspace of $ V $. Prove that $ W \\subsetneq V \\iff \\dim(W) \u003c \\dim(V) $.\nHere, $ W \\subsetneq V $ means that $ W $ is a proper subset of $ V $, i.e., $ W \\subseteq V $ but $ W \\neq V $.\nIf $ \\dim W \u003c \\dim V $, then $ W \\neq V $, as subspaces of equal dimension coincide.\nConversely, if $ W \\subsetneq V $, suppose $ \\dim W = \\dim V $. Then extending a basis of $ W $ to $ V $ would require no additional vectors, implying $ W = V $, a contradiction. Thus, $ \\dim W \u003c \\dim V $.\nExercise 7 Let $ A $ be an $ m \\times n $ matrix with $ m \u003c n $.\n(i) Prove that the column vectors of $ A $ are linearly dependent.\n(ii) Using (i) to show that for every $ b \\in \\mathbb{R}^m $ the system of linear equations $ Ax = b $ either has no solution or has infinitely many solutions.\n(iii) Prove that the column rank of $ A $ is $ m $ if and only if for every $ b \\in \\mathbb{R}^m $ the system $ Ax = b $ has infinitely many solutions.\n(i)\nThe $ n $ columns are vectors in $ \\mathbb{R}^m $ with $ n \u003e m $, so they are linearly dependent.\n(ii)\nBy (i), $ \\dim \\ker A \\geq 1 $. The solution set to $ Ax = b $ is either empty (no solution) or an affine subspace of dimension $ \\dim \\ker A \\geq 1 $ (infinitely many solutions).\n(iii)\nIf column rank is $ m $, then $ \\operatorname{span} $ of columns is $ \\mathbb{R}^m $, so $ Ax = b $ is always consistent. By (ii), it has infinitely many solutions.\nConversely, if always infinitely many solutions, then always consistent, so column space is $ \\mathbb{R}^m $, hence column rank $ m $.\nExercise 8 Let $ A $ be an $ m \\times n $ matrix. Prove that there is an $ n \\times m $ matrix $ B $ such that $ BA = I $ if and only if the row rank of $ A $ is $ n $.\nThe equation $ BA = I_n $ means $ A $ has a left inverse, equivalent to $ A $ being injective (full column rank), i.e., rank $ n $. Since row rank equals column rank, this is equivalent to row rank $ n $.\n","permalink":"https://diefish1024.github.io/posts/class-notes/math1205h-linear-algebra/math1205h-hw5/","summary":"\u003ch2 id=\"exercise-1\"\u003eExercise 1\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003eLet $ S \\subseteq V $ be a subset of vectors in a vector space $ V $. A finite subset $ S' \\subseteq S $ is maximally linearly independent in $ S $ if\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e$ S' $ is linearly independent, and\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003efor any $ v \\in S \\setminus S' $ the set $ S' \\cup \\{v\\} $ is not linearly independent.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eProve that:\u003c/p\u003e\n\u003cp\u003e(i) $ S' $ is maximally linearly independent in $ S $ if and only if $ S' $ (viewed as a sequence of vectors) is a basis for $ \\operatorname{span}(S) $.\u003c/p\u003e","title":"MATH1205H HW5"},{"content":"Exercise 1 Give a basis for the vector space $ M_{m\\times n}(\\mathbb{R}) $ consisting of all $ m \\times n $ matrices.\nA basis consists of the matrices $ E_{ij} $ for $ 1 \\leq i \\leq m $ and $ 1 \\leq j \\leq n $, where $ E_{ij} $ has a 1 in the $ (i,j) $-th position and 0 elsewhere.\nExercise 2 Give a basis for $ V = \\mathbb{R}^+ = \\{x \\mid x \\in \\mathbb{R} \\text{ with } x \u003e 0\\} $ with $ x \\oplus x' = x \\times x' $ and $ c \\otimes x = x^c $.\nThis is a one-dimensional vector space. A basis is $ \\{e\\} $, where $ e $ is the base of the natural logarithm, since any $ x \u003e 0 $ can be written as $ (\\ln x) \\otimes e = e^{\\ln x} = x $, and the \u0026ldquo;zero\u0026rdquo; element is 1.\nExercise 3 Is there a vector space $ V $ such that\n(i) $ |V| \u003e 1 $, i.e., $ V \\neq \\{0\\} $, and\n(ii) $ |V| $ is finite, i.e., it contains only finitely many vectors?\nNo such vector space exists over $ \\mathbb{R} $. If $ V $ contains a nonzero vector $ v $, then the scalars multiples $ \\{c v \\mid c \\in \\mathbb{R}\\} $ form an infinite set, contradicting the finiteness.\nExercise 4 Find the largest possible number of linearly independent vectors among\n$ v_1 = \\begin{pmatrix} 1 \\\\ -1 \\\\ 0 \\\\ 0 \\end{pmatrix}, \\quad v_2 = \\begin{pmatrix} 1 \\\\ 0 \\\\ -1 \\\\ 0 \\end{pmatrix}, \\quad v_3 = \\begin{pmatrix} 1 \\\\ 0 \\\\ 0 \\\\ -1 \\end{pmatrix}, \\quad v_4 = \\begin{pmatrix} 0 \\\\ 1 \\\\ -1 \\\\ 0 \\end{pmatrix}, \\quad v_5 = \\begin{pmatrix} 0 \\\\ 1 \\\\ 0 \\\\ -1 \\end{pmatrix}, \\quad v_6 = \\begin{pmatrix} 0 \\\\ 0 \\\\ 1 \\\\ -1 \\end{pmatrix}. $ These vectors lie in the three-dimensional subspace of $ \\mathbb{R}^4 $ where the sum of components is zero. Thus, the largest number of linearly independent vectors is 3.\nExercise 5 Find the null space $ N(A) $ and column space $ C(A) $ for the following matrices and give a basis for $ N(A) $ and $ C(A) $ respectively.\n(i) $ A = \\begin{pmatrix} 2 \u0026 3 \u0026 4 \u0026 5 \u0026 1 \\\\ 0 \u0026 1 \u0026 0 \u0026 1 \u0026 0 \\end{pmatrix} $\n(ii) $ A = \\begin{pmatrix} 1 \u0026 0 \u0026 2 \u0026 3 \\\\ 2 \u0026 2 \u0026 4 \u0026 5 \\\\ 1 \u0026 2 \u0026 4 \u0026 3 \\\\ 5 \u0026 6 \u0026 16 \u0026 15 \\\\ 4 \u0026 4 \u0026 10 \u0026 11 \\end{pmatrix} $\n(i)\nThe null space $ N(A) $ has dimension 3ï¼Œ and a basis is $ \\left\\{ \\begin{pmatrix} 1 \\\\ 1 \\\\ 0 \\\\ -1 \\\\ 0\\end{pmatrix}, \\begin{pmatrix}-2 \\\\ 0 \\\\ 1 \\\\ 0 \\\\ 0 \\end{pmatrix}, \\begin{pmatrix}1 \\\\ 0 \\\\ 0 \\\\ 0 \\\\ -2\\end{pmatrix} \\right\\} $.\nThe column space $ C(A) $ is the span of the columns of $ A $, and a basis is $ \\left\\{ \\begin{pmatrix} 2 \\\\ 4 \\\\ 1 \\\\ 1 \\\\ 1 \\end{pmatrix}, \\begin{pmatrix} 3 \\\\ 5 \\\\ 0 \\\\ 0 \\\\ 0 \\end{pmatrix} \\right\\} $.\n(ii)\nThe null space $ N(A) $ has dimension 1, and a basis is $ \\left\\{ \\begin{pmatrix} -4 \\\\ 1 \\\\ -1 \\\\ 2 \\end{pmatrix} \\right\\} $.\nThe column space $ C(A) $ has dimension 3, and a basis is $ \\left\\{ \\begin{pmatrix} 1 \\\\ 2 \\\\ 1 \\\\ 5 \\\\ 4 \\end{pmatrix}, \\begin{pmatrix} 0 \\\\ 2 \\\\ 2 \\\\ 6 \\\\ 4 \\end{pmatrix}, \\begin{pmatrix} 2 \\\\ 4 \\\\ 4 \\\\ 16 \\\\ 10 \\end{pmatrix} \\right\\} $.\nExercise 6 Calculate $ k \\in \\mathbb{R} $ such that the sequence $ v_1 - k v_2 $, $ v_2 - k v_3 $, $ v_3 - k v_4 $, $ v_4 - k v_1 $ is linearly independent, where\n$ v_1 = \\begin{pmatrix} 1 \\\\ 1 \\\\ 1 \\\\ 1 \\end{pmatrix}, \\quad v_2 = \\begin{pmatrix} 0 \\\\ 1 \\\\ 1 \\\\ 1 \\end{pmatrix}, \\quad v_3 = \\begin{pmatrix} 0 \\\\ 0 \\\\ 1 \\\\ 1 \\end{pmatrix}, \\quad v_4 = \\begin{pmatrix} 0 \\\\ 0 \\\\ 0 \\\\ 1 \\end{pmatrix}. $ Sol: $$ \\begin{align*} w_{1} \u0026 = v_{1}-kv_{2} = \\begin{pmatrix} 1 \\\\ 1-k \\\\ 1-k \\\\ 1-k \\end{pmatrix}, w_{2}= v_{2} - kv_{3} = \\begin{pmatrix} 0 \\\\ 1 \\\\ 1-k \\\\ 1-k \\end{pmatrix}, \\\\ \\\\ w_{3} \u0026 = v_{3} - kv_{4} = \\begin{pmatrix} 0\\\\ 0 \\\\ 1 \\\\ 1-k \\end{pmatrix}, w_{4} = v_{4} - kv_{1} = \\begin{pmatrix} -k \\\\ -k \\\\ -k \\\\ 1-k \\end{pmatrix}, \\\\ \\\\ M \u0026 = \\begin{pmatrix} w_{1} \u0026 w_{2} \u0026 w_{3} \u0026 w_{4} \\end{pmatrix} = \\begin{pmatrix} 1 \u0026 0 \u0026 0 \u0026 -k \\\\ 1-k \u0026 1 \u0026 0 \u0026 -k \\\\ 1-k \u0026 1-k \u0026 1 \u0026 -k \\\\ 1-k \u0026 1-k \u0026 1-k \u0026 1-k \\end{pmatrix} \\end{align*} $$ Then we calculate the determinant of matrix $ M $, which is $$ \\det(M) = 1-k^{4} $$ So the sequence is linearly independent if and only if $ k^4 \\neq 1 $, i.e., $ k \\neq \\pm 1 $.\nExercise 7 Let $ V $ be a vector space and $ S_1, S_2 \\subseteq V $. Prove that:\n(i) If $ S_1 \\subseteq S_2 $, then $ \\operatorname{span}(S_1) \\subseteq \\operatorname{span}(S_2) $.\n(ii) $ \\operatorname{span}(S_1) = \\operatorname{span}(\\operatorname{span}(S_1)) $.\n(iii) If $ S_1 \\subseteq \\operatorname{span}(S_2) $, then $ \\operatorname{span}(S_1) \\subseteq \\operatorname{span}(S_2) $.\nProof:\n(i)\nAny linear combination of elements from $ S_1 $ is also a linear combination of elements from $ S_2 $, using zero coefficients for elements in $ S_2 \\setminus S_1 $. Thus, $ \\operatorname{span}(S_1) \\subseteq \\operatorname{span}(S_2) $.\n(ii)\nElements of $ \\operatorname{span}(\\operatorname{span}(S_1)) $ are linear combinations of elements from $ \\operatorname{span}(S_1) $, which are themselves linear combinations from $ S_1 $, hence linear combinations from $ S_1 $. So $ \\operatorname{span}(\\operatorname{span}(S_1)) \\subseteq \\operatorname{span}(S_1) $. The reverse inclusion is immediate.\n(iii)\nEach element of $ S_1 $ is a linear combination from $ S_2 $, so any linear combination from $ S_1 $ is a linear combination of linear combinations from $ S_2 $, hence a linear combination from $ S_2 $. Thus, $ \\operatorname{span}(S_1) \\subseteq \\operatorname{span}(S_2) $.\nExercise 8 Let $ V $ be a vector space and $ v, e_1, \\ldots, e_n \\in V $. We have already used the following terminology in our class. We say that $ v $ can be represented by $ e_1, \\ldots, e_n $ if $ v $ can be written as a linear combination of $ e_1, \\ldots, e_n $, or equivalently\n$ v \\in \\operatorname{span}(\\{e_1, \\ldots, e_n\\}) $.\nThis can be extended as follows. Let $ v \\in V $ and $ S, S_1, S_2 \\subseteq V $\n$ v $ can be represented by $ S $ if $ v \\in \\operatorname{span}(S) $.\n$ S_1 $ can be represented by $ S_2 $ if every $ v \\in S_1 $ can be represented by $ S_2 $.\nProve that:\n(i) $ S_1 $ can be represented by $ S_2 $ if and only if $ \\operatorname{span}(S_1) \\subseteq \\operatorname{span}(S_2) $.\n(ii) If $ S $ can be represented by $ S_1 $, and $ S_1 $ can be represented by $ S_2 $, then $ S $ can be represented by $ S_2 $.\n(iii) Assume $ v \\in S $ and $ v $ can be represented by $ S \\setminus \\{v\\} $, then\n$ \\operatorname{span}(S \\setminus \\{v\\}) = \\operatorname{span}(S) $.\nProof:\n(i)\n$ S_1 $ can be represented by $ S_2 $ means $ S_1 \\subseteq \\operatorname{span}(S_2) $, which by Exercise 7(iii) is equivalent to $ \\operatorname{span}(S_1) \\subseteq \\operatorname{span}(S_2) $.\n(ii)\nIf $ S $ is represented by $ S_1 $, then $ S \\subseteq \\operatorname{span}(S_1) $. If $ S_1 $ is represented by $ S_2 $, then $ \\operatorname{span}(S_1) \\subseteq \\operatorname{span}(S_2) $ by (i). Thus, $ S \\subseteq \\operatorname{span}(S_1) \\subseteq \\operatorname{span}(S_2) $, so $ S $ is represented by $ S_2 $.\n(iii)\nLet $ T = S \\setminus \\{v\\} $. Since $ v \\in \\operatorname{span}(T) $, $ \\operatorname{span}(S) = \\operatorname{span}(T \\cup \\{v\\}) \\subseteq \\operatorname{span}(T) + \\operatorname{span}(\\{v\\}) \\subseteq \\operatorname{span}(T) + \\operatorname{span}(T) = \\operatorname{span}(T) $. Also, $ \\operatorname{span}(T) \\subseteq \\operatorname{span}(S) $, so equality holds.\n","permalink":"https://diefish1024.github.io/posts/class-notes/math1205h-linear-algebra/math1205h-hw4/","summary":"\u003ch2 id=\"exercise-1\"\u003eExercise 1\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003eGive a basis for the vector space $ M_{m\\times n}(\\mathbb{R}) $ consisting of all $ m \\times n $ matrices.\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eA basis consists of the matrices $ E_{ij} $ for $ 1 \\leq i \\leq m $ and $ 1 \\leq j \\leq n $, where $ E_{ij} $ has a 1 in the $ (i,j) $-th position and 0 elsewhere.\u003c/p\u003e\n\u003ch2 id=\"exercise-2\"\u003eExercise 2\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003eGive a basis for $ V = \\mathbb{R}^+ = \\{x \\mid x \\in \\mathbb{R} \\text{ with } x \u003e 0\\} $ with $ x \\oplus x' = x \\times x' $ and $ c \\otimes x = x^c $.\u003c/p\u003e","title":"MATH1205H HW4"},{"content":"Problem 1 è¯æ˜ $$ \\begin{align*} \\sum_{i=0}^{n} (-1)^{i}\\binom{ n }{ i } \\binom{ n+m-i }{ k-i } = \\binom{ m }{ k } \\\\ \\sum_{i=0}^{n} \\binom{ k }{ i } D_{n-i} = \\sum_{j=0}^{n-k} (-1)^{j}\\binom{ n-k }{ j } (n-j)! \\end{align*} $$ è¯ 1\nå¯¹äºç¬¬ä¸€ä¸ªå¼å­ï¼Œæˆ‘ä»¬è€ƒè™‘ç»„åˆæ„ä¹‰ã€‚è®¾æœ‰ $ A,B $ ä¸¤ä¸ªé›†åˆï¼Œåˆ†åˆ«åŒ…å« $ n $ å’Œ $ m $ ä¸ªå…ƒç´ ï¼Œæ€»å…± $ n+m $ ä¸ªå…ƒç´ ã€‚æˆ‘ä»¬å¸Œæœ›ä»é›†åˆ $ B $ ä¸­æ°å¥½é€‰æ‹© $ k $ ä¸ªå…ƒç´ ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å®¹æ–¥åŸç†çš„è¡¥é›†å½¢å¼æ±‚è§£ï¼Œå®šä¹‰äº‹ä»¶ $ A_{i} $ ä¸ºæ‰€é€‰çš„ $ k $ ä¸ªå…ƒç´ ä¸­è‡³å°‘åŒ…å« $ i $ ä¸ªæ¥è‡ª $ A $ çš„å…ƒç´ ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ±‚è§£çš„äº‹ä»¶é›†åˆä¸º $ U\\setminus\\bigcup_{i\\leq n}A_{i} $ï¼Œå¹¶ä¸” $$ \\left| A_{i} \\right| = \\binom{ n }{ i } \\binom{ n+m-i }{ k-i } $$ å› æ­¤æ ¹æ®å®¹æ–¥åŸç†ï¼Œå°±å¯ä»¥å¾—åˆ° $$ \\left| U\\setminus \\bigcup_{i\\leq n}A_{i} \\right| = \\sum_{i=0}^{n} (-1)^{i}\\binom{ n }{ i } \\binom{ n+m-i }{ k-i } = \\binom{ m }{ k } $$\nå¯¹äºç¬¬äºŒä¸ªå¼å­ï¼ŒåŒæ ·è€ƒè™‘ç»„åˆæ„ä¹‰ã€‚æˆ‘ä»¬å¯ä»¥å‡å®š $ n\\geq k $ï¼Œå¦åˆ™ä¸¤ä¾§å‡ä¸ºé›¶ã€‚è®¾æœ‰ $ n $ ä¸ªå…ƒç´ çš„æ’åˆ—ï¼Œåˆ†æˆ $ A $ å’Œ $ B $ ä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«åŒ…å« $ k $ å’Œ $ n-k $ ä¸ªå…ƒç´ ã€‚å·¦ä¾§æ‰€æœ‰æšä¸¾æ‰€æœ‰ $ A $ ä¸­å…ƒç´ çš„ç»„åˆå›ºå®šï¼Œå‰©ä¸‹çš„è¿›è¡Œé”™æ’ï¼Œå¯ä»¥è¡¨ç¤º $ A $ ä¸­å…ƒç´ ä»»æ„ï¼Œ$ B $ ä¸­å…ƒç´ å¿…é¡»ä¸ºé”™æ’çš„æ–¹æ¡ˆæ•°ã€‚æˆ‘ä»¬åŒæ ·è€ƒè™‘é€šè¿‡å®¹æ–¥åŸç†çš„è¡¥é›†å½¢å¼æ¥æ±‚è§£ã€‚å³ä¾§æˆ‘ä»¬å®šä¹‰äº‹ä»¶ $ B_{i} $ è¡¨ç¤º $ B $ ä¸­è‡³å°‘æœ‰ $ i $ ä¸ªå…ƒç´ ä¸æ˜¯é”™æ’ï¼ˆå€¼ç­‰äºè‡ªå·±çš„ç¼–å·ï¼‰ï¼Œå‰©ä¸‹çš„æ•°éšæ„ï¼Œäºæ˜¯ $ \\left| B_{i} \\right|=\\binom{ n-k }{ i }(n-i)! $ã€‚åŒæ—¶æˆ‘ä»¬éœ€è¦æ±‚è§£çš„äº‹ä»¶é›†åˆä¸º $ U\\setminus\\bigcup_{i=1}^{n-k}B_{i} $ï¼Œå› æ­¤æ ¹æ®å®¹æ–¥åŸç†å¯ä»¥å¾—åˆ° $$ \\left| U\\setminus \\bigcup_{j=1}^{n-k}B_{j} \\right| = \\sum_{i=0}^{n} \\binom{ k }{ i } D_{n-i} = \\sum_{j=0}^{n-k} (-1)^{j}\\binom{ n-k }{ j } (n-j)! $$ è¯ 2ï¼š\nè¿™ä¸¤ä¸ªå¼å­å’ŒäºŒé¡¹åæ¼”éƒ½æœ‰ä¸€å®šçš„ç±»ä¼¼ä¹‹å¤„ã€‚ $$ g_{n} = \\sum_{i=0}^{n} \\binom{ n }{ i } f_{i} \\implies f_{n} = \\sum_{i=0}^{n} (-1)^{n-i}\\binom{ n }{ i } g_{i} $$ æˆ‘ä»¬ç›´æ¥è¯æ˜äºŒé¡¹åæ¼”ã€‚\nå°† $ g_{i} $ çš„è¡¨è¾¾å¼å¸¦å…¥è¦è¯æ˜çš„å¼å­ï¼Œåªéœ€è¯æ˜ $$ \\begin{align*} \\\\ f_{n} \u0026 = \\sum_{i=0}^{n} (-1)^{n-i}\\binom{ n }{ i } \\sum_{j=0}^{i} \\binom{ i }{ j } f_{j} \\\\ \u0026 = \\sum_{i=0}^{n} \\sum_{j=0}^{i} (-1)^{n-i}\\binom{ n }{ i } \\binom{ i }{ j } f_{j} \\\\ \u0026 = \\sum_{i=0}^{n} \\sum_{j=0}^{i} (-1)^{n-i}\\binom{ n }{ j } \\binom{ n-j }{ i-j } f_{j} \\\\ \u0026 = \\sum_{j=0}^{n}\\binom{ n }{ j } f_{j} \\sum_{i=j}^{n} (-1)^{n-i}\\binom{ n-j }{ i-j } \\\\ \u0026 = \\sum_{j=0}^{n} \\binom{ n }{ j } f_{j}\\cdot \\left( \\sum_{i=0}^{n-j} (-1)^{n+j-i}\\binom{ n-j }{ i } \\right) \\\\ \u0026 = \\sum_{j=0}^{n} \\binom{ n }{ j } f_{j}\\cdot[n-j=0] \\\\ \u0026 = f_{n} \\end{align*} $$ è¿™å°±è¯æ˜äº†äºŒé¡¹å¼åæ¼”ã€‚\nå› æ­¤å¯¹äºç¬¬ä¸€ä¸ªå¼å­ $$ \\sum_{i=0}^{n} (-1)^{i}\\binom{ n }{ i } \\binom{ n+m-i }{ k-i } = \\sum_{i=0}^{n} (-1)^{n-i}\\binom{ n }{ i } \\binom{ m+i }{ k-n+i } $$ ä»¤ $ g_{i}:=\\binom{ m+i }{ k-n+i } $ï¼Œé‚£ä¹ˆä¸Šå¼å°±æ˜¯ $ \\sum_{i=0}^{n}(-1)^{n-i}\\binom{ n }{ i }g_{i} $ã€‚\næ ¹æ®ç»„åˆæ„ä¹‰ï¼Œæ˜¾ç„¶æœ‰æ’ç­‰å¼ $$ g_{t} = \\binom{ m+t }{ k-n+t } = \\sum_{i=0}^{t} \\binom{ t }{ i } \\binom{ m }{ k-n+(t-i) } = \\sum_{i=0}^{t} \\binom{ t }{ i } \\binom{ m }{ k-n+i } $$ å› æ­¤æˆ‘ä»¬ç›´æ¥å– $ f_{i}=\\binom{ m }{ k-n+i } $ å°±å¯ä»¥å¾—åˆ° $$ \\sum_{i=0}^{n} \\binom{ n }{ i } f_{i} = g_{n} \\implies \\sum_{i=0}^{n} (-1)^{n-i}\\binom{ n }{ i } g_{i} = f_{n} = \\binom{ m }{ k } $$ å¯¹äº $$ \\sum_{i=0}^{n} \\binom{ k }{ i } D_{n-i} = \\sum_{j=0}^{n-k} (-1)^{j}\\binom{ n-k }{ j } (n-j)! $$ ä¼¼ä¹æ„é€ æ¯”è¾ƒå¤æ‚ï¼Œæš‚æ—¶æç½®è¿™ä¸ªæ€è·¯(\nProblem 2 (1)\næœ‰å¤šå°‘ç§æ–¹æ³•å¯ä»¥ä» $ n $ ä¸ªå…ƒç´ çš„åºåˆ—ä¸­é€‰æ‹© $ k $ ä¸ªéè¿ç»­çš„å…ƒç´ ï¼Ÿ\nè§£\nè®¾ä» $ n $ ä¸ªå…ƒç´ çš„åºåˆ—ä¸­é€‰æ‹© $ k $ ä¸ªå…ƒç´ çš„å…¨ä½“é›†åˆä¸º $ U $ï¼Œ$ A_i (1 \\leq i \\leq n-1) $ è¡¨ç¤ºå…ƒç´  $ i $ å’Œ $ i+1 $ åŒæ—¶è¢«é€‰æ‹©çš„äº‹ä»¶ã€‚æˆ‘ä»¬éœ€è¦è®¡ç®— $ \\left| U \\setminus \\bigcup_{i=1}^{n-1} A_i \\right| $ï¼Œå³é€‰æ‹© $ k $ ä¸ªéè¿ç»­å…ƒç´ çš„æ–¹æ¡ˆæ•°ã€‚\né¦–å…ˆï¼Œ$ |U| = \\binom{n}{k} $ï¼Œè¡¨ç¤ºä» $ n $ ä¸ªå…ƒç´ ä¸­é€‰æ‹© $ k $ ä¸ªå…ƒç´ çš„æ€»æ–¹æ¡ˆæ•°ã€‚å¯¹äºæ¯ä¸ª $ A_i $ï¼Œè¡¨ç¤ºå…ƒç´  $ i $ å’Œ $ i+1 $ éƒ½è¢«é€‰ä¸­ï¼Œå‰©ä½™çš„ $ k-2 $ ä¸ªå…ƒç´ ä»é™¤ $ i $ å’Œ $ i+1 $ å¤–çš„ $ n-2 $ ä¸ªå…ƒç´ ä¸­é€‰æ‹©ï¼Œå› æ­¤ $ |A_i| = \\binom{n-2}{k-2} $ã€‚äºæ˜¯ï¼Œå•é¡¹å’Œä¸ºï¼š $$ \\sum_{i=1}^{n-1} |A_i| = (n-1) \\binom{n-2}{k-2}. $$\nå¯¹äºäºŒé‡äº¤é›† $ A_i \\cap A_j (1 \\leq i \u003c j \\leq n-1) $ï¼Œæˆ‘ä»¬éœ€è€ƒè™‘ $ i $ å’Œ $ j $ çš„ç›¸å¯¹ä½ç½®ï¼š\nè‹¥ $ j = i+1 $ï¼Œåˆ™ $ A_i \\cap A_{i+1} $ è¡¨ç¤º $ i, i+1, i+2 $ éƒ½è¢«é€‰ä¸­ï¼Œå…±å ç”¨ 3 ä¸ªä½ç½®ï¼Œå‰©ä½™ $ k-3 $ ä¸ªå…ƒç´ ä» $ n-3 $ ä¸ªä½ç½®ä¸­é€‰ï¼Œæ–¹æ¡ˆæ•°ä¸º $ \\binom{n-3}{k-3} $ã€‚è¿™æ ·çš„ $ (i, i+1) $ å¯¹æœ‰ $ n-2 $ ç§ã€‚ è‹¥ $ j \u003e i+1 $ï¼Œåˆ™ $ A_i \\cap A_j $ è¡¨ç¤ºé€‰ä¸­ $ i, i+1, j, j+1 $ å››ä¸ªå…ƒç´ ï¼Œå‰©ä½™ $ k-4 $ ä¸ªå…ƒç´ ä» $ n-4 $ ä¸ªä½ç½®ä¸­é€‰ï¼Œæ–¹æ¡ˆæ•°ä¸º $ \\binom{n-4}{k-4} $ã€‚è¿™æ ·çš„ $ (i, j) $ å¯¹æœ‰ $ \\binom{n-2}{2} $ ç§ï¼ˆä»»æ„é€‰ä¸¤ä¸ªä¸è¿ç»­çš„ $ A_i $ï¼‰ã€‚ å› æ­¤ï¼ŒäºŒé‡äº¤é›†çš„å’Œä¸ºï¼š $$ \\sum_{1 \\leq i \u003c j \\leq n-1} |A_i \\cap A_j| = (n-2) \\binom{n-3}{k-3} + \\binom{n-2}{2} \\binom{n-4}{k-4}. $$\nå¯¹äº $ m $ é‡äº¤é›† $ \\bigcap_{j=1}^{m} A_{i_j} $ï¼Œå…¶ä¸­ $ 1 \\leq i_1 \u003c i_2 \u003c \\dots \u003c i_m \\leq n-1 $ï¼Œ$ m \\leq \\lfloor k/2 \\rfloor $ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®— $ m $ ä¸ª $ A_{i_j} $ çš„äº¤é›†ã€‚å‡è®¾è¿™ $ m $ ä¸ª $ A_{i_j} $ å½¢æˆ $ j $ ä¸ªè¿é€šå—ï¼ˆå³è¿ç»­çš„ $ A_i $ åºåˆ—ï¼‰ï¼Œåˆ™ï¼š\nè¿é€šå—çš„ä¸ªæ•° $ j $ æ»¡è¶³ $ 1 \\leq j \\leq m $ã€‚ å°† $ m $ ä¸ª $ A_i $ åˆ†æˆ $ j $ ä¸ªè¿é€šå—çš„æ–¹æ¡ˆæ•°ä¸º $ \\binom{m-1}{j-1} $ï¼ˆåŸºäºåˆ†å‰² $ m $ ä¸ªå…ƒç´ ä¸º $ j $ ä¸ªéç©ºæœ‰åºå­é›†çš„ç»„åˆæ•°ï¼‰ã€‚ é€‰æ‹© $ j $ ä¸ªè¿é€šå—åœ¨ $ n-m $ ä¸ªå¯èƒ½ä½ç½®ï¼ˆè€ƒè™‘ $ m $ ä¸ª $ A_i $ å ç”¨ $ m $ ä¸ªä½ç½®åå‰©ä½™çš„é—´éš”ï¼‰çš„æ–¹æ¡ˆæ•°ä¸º $ \\binom{n-m}{j} $ã€‚ æ¯ä¸ªè¿é€šå—å ç”¨è‡³å°‘ 2 ä¸ªå…ƒç´ ï¼ˆä¸€ä¸ª $ A_i $ åŒ…å« 2 ä¸ªå…ƒç´ ï¼Œè¿ç»­çš„ $ A_i $ å…±äº«å…ƒç´ ï¼‰ï¼Œæ€»å…±å ç”¨ $ m+j $ ä¸ªå…ƒç´ ï¼ˆ$ m $ ä¸ª $ A_i $ è´¡çŒ® $ m $ å¯¹å…ƒç´ ï¼Œæ¯å¢åŠ ä¸€ä¸ªå—è¾¹ç•Œå¢åŠ ä¸€ä¸ªå…ƒç´ ï¼‰ã€‚å‰©ä½™çš„ $ k-(m+j) $ ä¸ªå…ƒç´ ä» $ n-(m+j) $ ä¸ªä½ç½®ä¸­é€‰ï¼Œæ–¹æ¡ˆæ•°ä¸º $ \\binom{n-m-j}{k-m-j} $ã€‚ å› æ­¤ï¼Œ$ m $ é‡äº¤é›†çš„å’Œä¸ºï¼š $$ \\sum_{1 \\leq i_1 \u003c i_2 \u003c \\dots \u003c i_m \\leq n-1} \\left| \\bigcap_{j=1}^{m} A_{i_j} \\right| = \\sum_{j=1}^{m} \\binom{m-1}{j-1} \\binom{n-m}{j} \\binom{n-m-j}{k-m-j}. $$\næ ¹æ®å®¹æ–¥åŸç†ï¼Œé€‰æ‹© $ k $ ä¸ªéè¿ç»­å…ƒç´ çš„æ–¹æ¡ˆæ•°ä¸ºï¼š $$ \\left| U \\setminus \\bigcup_{i=1}^{n-1} A_i \\right| = \\binom{n}{k} + \\sum_{m=1}^{\\lfloor k/2 \\rfloor} (-1)^m \\sum_{j=1}^{m} \\binom{m-1}{j-1} \\binom{n-m}{j} \\binom{n-m-j}{k-m-j}. $$ è™½ç„¶è¿™ä¸ªå¼å­è¾ƒéš¾åŒ–ç®€ï¼Œä½†æ˜¯ç›´æ¥ä»ç»„åˆæ„ä¹‰è€ƒè™‘ï¼Œå¯ä»¥å¾—åˆ°ä¸Šè¿°è¡¨è¾¾å¼åº”è¯¥ä¸æ­¤é—­åˆå½¢å¼ç­‰ä»· $$ \\binom{ n-k+1 }{ k } $$ (2)\næœ‰å¤šå°‘ç§æ–¹æ³•å¯ä»¥ä» $ n $ ä¸ªå…ƒç´ çš„å¾ªç¯æ’åˆ—ä¸­é€‰æ‹© $ k $ ä¸ªéè¿ç»­çš„å…ƒç´ ï¼Ÿ\nè§£\nè®¾ä» $ n $ ä¸ªå…ƒç´ çš„å¾ªç¯æ’åˆ—ä¸­é€‰æ‹© $ k $ ä¸ªå…ƒç´ çš„å…¨ä½“é›†åˆä¸º $ U $ï¼Œ$ A_i (1 \\leq i \\leq n) $ è¡¨ç¤ºå…ƒç´  $ i $ å’Œ $ i+1 $ (æ¨¡ $ n $) åŒæ—¶è¢«é€‰æ‹©çš„äº‹ä»¶ã€‚æˆ‘ä»¬éœ€è¦è®¡ç®— $ \\left| U \\setminus \\bigcup_{i=1}^{n} A_i \\right| $ï¼Œå³é€‰æ‹© $ k $ ä¸ªéè¿ç»­å…ƒç´ çš„æ–¹æ¡ˆæ•°ã€‚\né¦–å…ˆï¼Œ$ |U| = \\binom{n}{k} $ï¼Œè¡¨ç¤ºä» $ n $ ä¸ªå…ƒç´ ä¸­é€‰æ‹© $ k $ ä¸ªå…ƒç´ çš„æ€»æ–¹æ¡ˆæ•°ã€‚å¯¹äºæ¯ä¸ª $ A_i $ï¼Œè¡¨ç¤ºå…ƒç´  $ i $ å’Œ $ i+1 $ éƒ½è¢«é€‰ä¸­ï¼Œå‰©ä½™çš„ $ k-2 $ ä¸ªå…ƒç´ ä»é™¤ $ i $ å’Œ $ i+1 $ å¤–çš„ $ n-2 $ ä¸ªå…ƒç´ ä¸­é€‰æ‹©ï¼Œå› æ­¤ $ |A_i| = \\binom{n-2}{k-2} $ã€‚äºæ˜¯ï¼Œå•é¡¹å’Œä¸ºï¼š $$ \\sum_{i=1}^{n} |A_i| = n \\binom{n-2}{k-2}. $$\nå¯¹äºäºŒé‡äº¤é›† $ A_i \\cap A_j (1 \\leq i \u003c j \\leq n) $ï¼Œæˆ‘ä»¬éœ€è€ƒè™‘ $ i $ å’Œ $ j $ çš„ç›¸å¯¹ä½ç½®ï¼š\nè‹¥ $ |i - j| \\equiv 1 \\pmod{n} $ï¼Œåˆ™ $ A_i \\cap A_{i+1} $ è¡¨ç¤º $ i, i+1, i+2 $ éƒ½è¢«é€‰ä¸­ï¼Œå…±å ç”¨ 3 ä¸ªä½ç½®ï¼Œå‰©ä½™ $ k-3 $ ä¸ªå…ƒç´ ä» $ n-3 $ ä¸ªä½ç½®ä¸­é€‰ï¼Œæ–¹æ¡ˆæ•°ä¸º $ \\binom{n-3}{k-3} $ã€‚è¿™æ ·çš„ç›¸é‚»å¯¹æœ‰ $ n $ ç§ã€‚ è‹¥ $ |i - j| \\not\\equiv 1 \\pmod{n} $ ä¸” $ |i - j| \\not\\equiv n-1 \\pmod{n} $ï¼ˆå³éç›¸é‚»ï¼‰ï¼Œåˆ™ $ A_i \\cap A_j $ è¡¨ç¤ºé€‰ä¸­ $ i, i+1, j, j+1 $ å››ä¸ªå…ƒç´ ï¼Œå‰©ä½™ $ k-4 $ ä¸ªå…ƒç´ ä» $ n-4 $ ä¸ªä½ç½®ä¸­é€‰ï¼Œæ–¹æ¡ˆæ•°ä¸º $ \\binom{n-4}{k-4} $ã€‚è¿™æ ·çš„å¯¹æœ‰ $ \\binom{n}{2} - n $ ç§ã€‚ å› æ­¤ï¼ŒäºŒé‡äº¤é›†çš„å’Œä¸ºï¼š $$ \\sum_{1 \\leq i \u003c j \\leq n} |A_i \\cap A_j| = n \\binom{n-3}{k-3} + \\left( \\binom{n}{2} - n \\right) \\binom{n-4}{k-4}. $$\nå¯¹äº $ m $ é‡äº¤é›† $ \\bigcap_{j=1}^{m} A_{i_j} $ï¼Œå…¶ä¸­ $ 1 \\leq i_1 \u003c i_2 \u003c \\dots \u003c i_m \\leq n $ï¼Œ$ m \\leq \\lfloor k/2 \\rfloor $ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®— $ m $ ä¸ª $ A_{i_j} $ çš„äº¤é›†ã€‚å‡è®¾è¿™ $ m $ ä¸ª $ A_{i_j} $ å½¢æˆ $ j $ ä¸ªè¿é€šå—ï¼ˆå³è¿ç»­çš„ $ A_i $ åºåˆ—ï¼‰ï¼Œåˆ™ï¼š\nè¿é€šå—çš„ä¸ªæ•° $ j $ æ»¡è¶³ $ 1 \\leq j \\leq m $ã€‚ å°† $ m $ ä¸ª $ A_i $ åˆ†æˆ $ j $ ä¸ªè¿é€šå—çš„æœ‰åºæ–¹æ¡ˆæ•°ä¸º $ \\binom{m-1}{j-1} $ã€‚ ç”±äºå¾ªç¯æ’åˆ—ï¼Œåˆ†å¸ƒå‰©ä½™é—´éš”çš„æ–¹æ¡ˆæ•°ä¸º $ \\binom{n-m-1}{j-1} $ï¼Œå¹¶ä¹˜ä»¥ $ \\frac{n}{j} $ ä»¥è°ƒæ•´å¾ªç¯è®¡æ•°è‡³æ ‡ç­¾ä½ç½®ã€‚ æ¯ä¸ªè¿é€šå—å ç”¨è‡³å°‘ 2 ä¸ªå…ƒç´ ï¼Œæ€»å…±å ç”¨ $ m + j $ ä¸ªå…ƒç´ ã€‚å‰©ä½™çš„ $ k - (m + j) $ ä¸ªå…ƒç´ ä» $ n - (m + j) $ ä¸ªä½ç½®ä¸­é€‰ï¼Œæ–¹æ¡ˆæ•°ä¸º $ \\binom{n - m - j}{k - m - j} $ã€‚ å› æ­¤ï¼Œ$ m $ é‡äº¤é›†çš„å’Œä¸ºï¼š $$ \\sum_{1 \\leq i_1 \u003c i_2 \u003c \\dots \u003c i_m \\leq n} \\left| \\bigcap_{j=1}^{m} A_{i_j} \\right| = \\sum_{j=1}^{m} \\frac{n}{j} \\binom{m-1}{j-1} \\binom{n-m-1}{j-1} \\binom{n-m-j}{k-m-j}. $$\næ ¹æ®å®¹æ–¥åŸç†ï¼Œé€‰æ‹© $ k $ ä¸ªéè¿ç»­å…ƒç´ çš„æ–¹æ¡ˆæ•°ä¸ºï¼š $$ \\left| U \\setminus \\bigcup_{i=1}^{n} A_i \\right| = \\binom{n}{k} + \\sum_{m=1}^{\\lfloor k / 2 \\rfloor } (-1)^{m}\\sum_{j=1}^{m} \\frac{n}{j} \\binom{ m-1 }{ j-1 } \\binom{ n-m-1 }{ j-1 } \\binom{ n-m-j }{ k-m-j }. $$\nç›´æ¥ä»ç»„åˆæ„ä¹‰è€ƒè™‘ï¼Œä¸Šè¿°è¡¨è¾¾å¼åº”è¯¥ä¸æ­¤é—­åˆå½¢å¼ç­‰ä»·ï¼ˆä½†æ˜¯æˆ‘è¿˜æ˜¯ä¸ä¼šåŒ–ç®€ğŸ˜­ï¼‰ $$ \\binom{n - k}{k} + \\binom{n - k - 1}{k - 1} $$\n(3)\nå‡è®¾æˆ‘ä»¬å¸Œæœ›å°† $ n $ å¯¹å¤«å¦‡å®‰æ’åœ¨ä¸€å¼ æ¡Œå­å‘¨å›´ï¼Œå…¶ä¸­ç”·æ€§å’Œå¥³æ€§äº¤æ›¿æ’åˆ—ï¼Œå¹¶ä¸”æ¯ä½å¥³æ€§ä¸å¥¹çš„ä¸ˆå¤«ä¸ç›¸é‚»ã€‚è®¤ä¸ºé€šè¿‡åº§ä½ä½ç½®çš„ä»»ä½•æ—‹è½¬å¾—åˆ°çš„å®‰æ’æ˜¯ç›¸åŒçš„ã€‚è¯æ˜å®‰æ’çš„æ•°é‡ä¸ºï¼š $$ (n-1)!\\sum_{k=0}^{n} (-1)^{k} \\dfrac{2n}{2n-k}\\binom{ 2n-k }{ k } (n-k)! $$ è§£\nè®¾å…¨ä½“æ’åˆ—äº‹ä»¶çš„é›†åˆä¸º $ U $ï¼Œäº‹ä»¶ $ A_{i} $ è¡¨ç¤ºç¬¬ $ i $ å¯¹å¤«å¦‡ç›¸é‚»ã€‚æˆ‘ä»¬éœ€è¦è®¡ç®— $ \\left| U\\setminus \\bigcup_{i=1}^{n}A_{i} \\right| $ï¼Œå³æ¯å¯¹å¤«å¦‡éƒ½ä¸ç›¸é‚»çš„æ–¹æ¡ˆæ•°ã€‚\né¦–å…ˆå…¨é›† $ \\left| U \\right|= \\frac{1}{n}\\cdot n!\\cdot n! = n!(n-1)! $ã€‚å¯¹äºæ¯ä¸ªäº‹ä»¶ $ A_{i} $ï¼ŒåŠ ä¸Šåœ†æ’åˆ—çš„å¯¹ç§°æ€§ï¼Œå¯ä»¥çœ‹å‡ºåªæœ‰ä¸€ä¸ªç‚¹è¢«å›ºå®šäº†ä½ç½®ï¼ŒåŒæ—¶ä¸€å¯¹å¤«å¦»çš„ç›¸å¯¹ä½ç½®æœ‰ä¸¤ç§å¯èƒ½ï¼Œæ‰€ä»¥ $ \\left| A_{i} \\right|=2(n-1)!\\cdot(n-1)! $ï¼Œä»è€Œ $ \\sum_{i=1}^{n}\\left| A_{i} \\right|=2n(n-1)!(n-1)! $ã€‚\nå¯¹äº $ m $ é‡äº¤é›† $ \\bigcap_{j=1}^{m} A_{i_j} $ï¼Œå…¶ä¸­ $ 1 \\leq i_1 \u003c i_2 \u003c \\dots \u003c i_m \\leq n $ï¼Œ$ m \\leq n $ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®— $ m $ ä¸ª $ A_{i_j} $ çš„äº¤é›†ã€‚è€ƒè™‘åº§ä½ä½ç½®çš„é€‰æ‹©ã€‚å°†è¿™ $ m $ å¯¹ç‰¹å®šçš„å¤«å¦‡æ¯ä¸ªè§†ä¸ºä¸€ä¸ªå—ï¼Œæ¯ä¸ªå—å ç”¨ä¸¤ä¸ªè¿ç»­çš„åº§ä½ã€‚åœ¨ $ 2n $ ä¸ªåº§ä½çš„å¾ªç¯æ’åˆ—ä¸­ï¼Œé€‰æ‹© $ m $ ä¸ªä¸ç›¸é‡å çš„è¿ç»­åº§ä½å¯¹çš„æ–¹æ¡ˆæ•°ä¸º $ \\dfrac{2n}{2n-m} \\dbinom{2n-m}{m} $ï¼ˆç»„åˆæ„ä¹‰ï¼Ÿï¼‰ã€‚\nç„¶åï¼Œå°†è¿™ $ m $ å¯¹å¤«å¦‡åˆ†é…åˆ° $ m $ ä¸ªå—ä¸­çš„æ–¹æ¡ˆæ•°ä¸º $ m! $ã€‚å¯¹äºæ•´ä½“çš„ç”·å¥³æ€§åˆ«äº¤æ›¿æ’åˆ—ï¼Œæœ‰ä¸¤ç§å…¨å±€æ–¹å‘ã€‚å¯¹äºæ¯ä¸ªæ–¹å‘ï¼Œæ¯ä¸ªå—ä¸­å¤«å¦‡çš„æ’åˆ—ç”±æ€§åˆ«ä½ç½®å†³å®šï¼Œä»…æœ‰ä¸€ç§æ–¹å¼ã€‚å‰©ä½™ $ n-m $ åç”·æ€§å’Œ $ n-m $ åå¥³æ€§åˆ†åˆ«å®‰æ’åˆ°å‰©ä½™çš„ç”·æ€§å’Œå¥³æ€§åº§ä½ä¸­çš„æ–¹æ¡ˆæ•°ä¸º $ (n-m)! \\cdot (n-m)! $ã€‚ä¸Šè¿°è®¡ç®—è€ƒè™‘äº†å›ºå®šåº§ä½æ—¶çš„æ€»æ•°ï¼Œéšåé™¤ä»¥ $ 2n $ ä»¥è®¡å…¥æ—‹è½¬ç­‰ä»·ã€‚\nå› æ­¤ï¼Œ$ \\left| \\bigcap_{j=1}^{m} A_{i_j} \\right| = \\dfrac{2}{2n-m} \\dbinom{2n-m}{m} m! (n-m)! (n-m)! $ã€‚äºæ˜¯ï¼Œ$ m $ é‡äº¤é›†çš„å’Œä¸ºï¼š $$ \\sum_{1 \\leq i_1 \u003c \\dots \u003c i_m \\leq n} \\left| \\bigcap_{j=1}^{m} A_{i_j} \\right| = \\dbinom{n}{m} \\dfrac{2}{2n-m} \\dbinom{2n-m}{m} m! (n-m)! (n-m)! = \\dfrac{2}{2n-m} \\dbinom{2n-m}{m} n! (n-m)! . $$\næ ¹æ®å®¹æ–¥åŸç†ï¼Œæ¯å¯¹å¤«å¦‡éƒ½ä¸ç›¸é‚»çš„æ–¹æ¡ˆæ•°ä¸ºï¼š $$ \\left| U \\setminus \\bigcup_{i=1}^{n} A_i \\right| = \\sum_{m=0}^{n} (-1)^{m} \\dfrac{2}{2n-m} \\dbinom{2n-m}{m} n! (n-m)! = (n-1)! \\sum_{k=0}^{n} (-1)^{k} \\dfrac{2n}{2n-k} \\dbinom{2n-k}{k} (n-k)! . $$\nProblem 3 (1)\nå‡è®¾ $ f,g,h $ éƒ½æ˜¯æ•°è®ºå‡½æ•°ï¼Œæ»¡è¶³ $$ g(n) = \\sum_{d|n}df(d), \\quad h(n) = \\sum_{d|n}f(d) $$ è¯æ˜ $$ h(n) = \\dfrac{1}{n} \\sum_{d|n} \\varphi(n/d)g(d) $$ è¯\næˆ‘ä»¬è®² $ g(d) $ å¸¦å…¥ç›®æ ‡è¡¨è¾¾å¼ï¼Œå¾—åˆ° $$ \\begin{align*} h(n) \u0026 = \\dfrac{1}{n} \\sum_{d|n}\\varphi\\left( \\dfrac{n}{d} \\right)\\left( \\sum_{e|d}ef(e) \\right) \\\\ \u0026 = \\dfrac{1}{n} \\sum_{e|d, d|n}\\varphi\\left( \\dfrac{n}{d} \\right)ef(e) \\\\ \u0026 \\xlongequal{d=ek} \\dfrac{1}{n}\\sum_{e|n}\\sum_{k|(n / e)} \\varphi\\left( \\dfrac{n}{ek} \\right)ef(e) \\\\ \u0026 = \\dfrac{1}{n}\\sum_{e|n}ef(e) \\sum_{k|(n / e)} \\varphi\\left( \\dfrac{n / e}{k} \\right) \\end{align*} $$ ç”±äº $ \\sum_{k|m}\\varphi(k)=m $ï¼Œå› æ­¤ $$ \\sum_{k|(n / e)} \\varphi\\left( \\dfrac{n / e}{k} \\right) = \\dfrac{n}{e} $$ å¸¦å…¥å¾—åˆ° $$ h(n) = \\dfrac{1}{n}\\sum_{e|n}ef(e) \\cdot \\dfrac{n}{e} = \\sum_{e|n}f(e) = \\sum_{d|n}f(d) $$ å¾—è¯ï¼\n(2)\nå¸Œæœ›ç”¨ $ q $ ç§é¢œè‰²å¯¹ä¸€æ¡ç”± $ n $ é¢—ç å­ç»„æˆçš„é¡¹é“¾è¿›è¡Œç€è‰²ã€‚ç¡®å®š $ N_n $ï¼Œå³ç€è‰²æ–¹æ¡ˆçš„æ•°é‡ï¼Œå…¶ä¸­å¦‚æœä¸¤ç§ç€è‰²æ–¹æ¡ˆå¯ä»¥é€šè¿‡æ—‹è½¬äº’ç›¸å¾—åˆ°ï¼Œåˆ™è®¤ä¸ºå®ƒä»¬æ˜¯ç›¸åŒçš„ã€‚\nåŒæ ·åœ°ï¼Œå¯ä»¥å°† $ N_n $ å®šä¹‰ä¸ºåœ¨ $ [q] $ ä¸Šçš„å¾ªç¯åºåˆ—çš„æ•°é‡ï¼Œå…¶ä¸­é€šè¿‡æ—‹è½¬å¾—åˆ°çš„ä¸¤ä¸ªåºåˆ—è¢«è®¤ä¸ºæ˜¯ç›¸åŒçš„ã€‚æ±‚ $ N_n $ ã€‚\nï¼ˆæç¤ºï¼šè®¾ $ M(d) $ ä¸ºé•¿åº¦ä¸º $ d $ ä¸”éå‘¨æœŸæ€§çš„å¾ªç¯åºåˆ—çš„æ•°é‡ã€‚ï¼‰\nè§£\næŒ‰ç…§æç¤ºè®¾å‡º $ M(d) $ï¼Œé‚£ä¹ˆæ‰¾é¡¹é“¾æœ€å°çš„å¾ªç¯èŠ‚ï¼Œå®¹æ˜“å¾—åˆ° $$ N_{n} = \\sum_{d|n} M(d) $$ æˆ‘ä»¬éœ€è¦è®¡ç®— $ M(d) $ã€‚è€ƒè™‘æ™®é€šåºåˆ—å’Œå¾ªç¯åºåˆ—ä¹‹é—´çš„å…³ç³»ã€‚å¯¹äºé•¿åº¦ $ n $ï¼Œæ™®é€šåºåˆ—çš„æ€»æ•°ä¸º $ q^{n} $ï¼Œè€Œæ¯ä¸ªæœ€å°å‘¨æœŸä¸º $ d $ çš„å¾ªç¯åºåˆ—å¯¹åº” $ d $ ä¸­ä¸åŒçš„è¡¨ç¤ºï¼Œå› æ­¤æ•°é‡ä¸º $ dM(d) $ï¼Œè¿™å°±å¾—åˆ°äº† $$ q^{n}= \\sum_{d|n}dM(d) $$ å› æ­¤æ ¹æ®ä¸Šä¸€é—®çš„ç»“è®ºï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº† $$ N_{n} = \\dfrac{1}{n}\\sum_{d|n}\\varphi\\left( \\dfrac{d}{n} \\right)q^{d} $$\nProblem 4 è€ƒè™‘ä¸€ä¸ªååºé›† $ \\mathcal{P} = (P, \\preccurlyeq) $ï¼Œå…¶ä¸­ $$ P = \\{(a_1, a_2, a_3, a_4) : a_i \\in [4]\\} $$ å¹¶ä¸” $ (a_1, a_2, a_3, a_4) \\preccurlyeq (b_1, b_2, b_3, b_4) $ å½“ä¸”ä»…å½“å¯¹äºæ‰€æœ‰ $ i $ éƒ½æœ‰ $ a_i \\le b_i $ã€‚æ±‚æ»¡è¶³ $ \\mu(x, y) \u003c 0 $ çš„åºå¯¹ $ x, y \\in P $ çš„æ•°é‡ã€‚\nè§£\nå¯¹äºä¸¤ä¸ª $ x,y\\in P $ï¼Œæ ¹æ®è®²ä¹‰çš„ Lemma 4.24ï¼Œè«æ¯”ä¹Œæ–¯å‡½æ•°çš„ç§¯æ€§ï¼Œå¾—åˆ° $$ \\mu(x,y) = \\prod_{i=1}^{4}\\mu_{[4]}(x_{i},y_{i}) $$ å¯¹äºä¸€ä¸ª $ [4] $ çš„é“¾ï¼Œæˆ‘ä»¬ç›´æ¥è®¡ç®— $ \\mu_{[4]}(a,b) $ï¼š\nå¦‚æœ $ a \\not\\leq b $ï¼Œé‚£ä¹ˆ $ \\mu_{[4]}(a,b)=0 $ã€‚ å¦‚æœ $ a=b $ï¼Œé‚£ä¹ˆ $ \\mu_{[4]}(a,b)=1 $ã€‚ å¦‚æœ $ b=a+1 $ï¼Œé‚£ä¹ˆ $ \\mu_{[4]}(a,b)=-1 $ã€‚ å¦‚æœ $ b\\geq a+2 $ï¼Œé‚£ä¹ˆ $ \\mu_{[4]}(a,b)=-\\sum_{k=a}^{b-1}\\mu_{[4]}(a,k)=0 $ã€‚ å› æ­¤å¯¹äº $ x,y\\in P $ï¼Œ$ \\mu(x,y)\\neq 0 $ å½“ä¸”è¿›è¡Œå¯¹äºæ‰€æœ‰ $ i $ æ»¡è¶³ $ y_{i}-x_{i}\\leq 1 $ã€‚å®šä¹‰ $ k $ ä¸º $ y_{i}=x_{i}+1 $ çš„ä¸‹æ ‡æ•°é‡ï¼Œå…¶ä½™ $ y_{i}=x_{i} $ï¼Œäºæ˜¯å°±æœ‰ $$ \\mu(x,y) = (-1)^{k} $$ å°äº $ 0 $ å½“ä¸”ä»…å½“ $ k=1,3 $ã€‚\næˆ‘ä»¬åˆ†å¼€è®¡ç®— $ k=1,3 $ çš„åºå¯¹æ•°é‡ï¼š\n$ k=1 $ï¼Œæ ¹æ®ç»„åˆæ„ä¹‰å¯ä»¥å¾—åˆ°æ€»æ•°ä¸º $ \\binom{ 4 }{ 1 }\\times 3^{1} \\times 4^{3}=768 $ã€‚ $ k=3 $ï¼Œæ€»æ•°ä¸º $ \\binom{ 4 }{ 3 }\\times 3^{3} \\times 4=432 $ã€‚ å› æ­¤æ€»æ•°ä¸º $ 768+432=1200 $ã€‚\nProblem 5 æŒ‘é€‰ä¸¤ä¸ªåœ¨ $ [100] $ èŒƒå›´å†…å‡åŒ€ã€ç‹¬ç«‹éšæœºçš„æ•°å­— $ a $ å’Œ $ b $ã€‚åœ¨ $ [100] $ ä¸Šçš„ååºå…³ç³»å®šä¹‰ä¸ºæ•´é™¤å…³ç³»ï¼Œæ±‚ $ \\mu(a, b) = -1 $ çš„æ¦‚ç‡ã€‚\nè§£\nè§£\næˆ‘ä»¬è€ƒè™‘ç›´æ¥ç®—å‡ºæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ $ (a,b) $ çš„æ€»æ•°ã€‚å¯¹äº $ \\mu(a,b) $ï¼Œåˆ†ç±»è®¨è®ºï¼š\nå¦‚æœ $ a \\not\\mid b $ï¼Œé‚£ä¹ˆ $ \\mu(a,b)=0 $ã€‚ å¦‚æœ $ a=b $ï¼Œé‚£ä¹ˆ $ \\mu(a,b)=1 $ã€‚ å¦‚æœ $ b=ka $ï¼ˆ$ k \\geq 2 $ï¼‰ï¼Œé‚£ä¹ˆ $ \\mu(a,b)=\\mu(1,k) $ï¼Œå…¶ä¸­ $ \\mu(1,k)=(-1)^{\\omega(k)} $ å½“ $ k $ æ— å¹³æ–¹å› å­ï¼Œå¦åˆ™ $ \\mu(1,k)=0 $ã€‚ å› æ­¤ $ \\mu(a,b)=-1 $ å½“ä¸”ä»…å½“ $ k $ æ— å¹³æ–¹å› å­ä¸” $ \\omega(k) $ ä¸ºå¥‡æ•°ã€‚å®šä¹‰ $ m $ ä¸º $ \\omega(k) $ çš„å¥‡æ•°å€¼ï¼Œå…¶å¯èƒ½å–å€¼ $ m=1,3 $ï¼ˆå›  $ k \\leq 100 $ï¼Œæœ€å¤§ $ m=3 $ï¼‰ã€‚\næˆ‘ä»¬åˆ†å¼€è®¡ç®— $ m=1,3 $ çš„åºå¯¹æ•°é‡ï¼š\n$ m=1 $ï¼ˆ$ k $ ä¸ºç´ æ•°ï¼‰ï¼Œæ€»æ•°ä¸º $ \\sum_{p \\leq 100} \\lfloor 100/p \\rfloor =171 $ã€‚ $ m=3 $ï¼ˆ$ k $ ä¸ºä¸‰ä¸ªä¸åŒç´ æ•°çš„ä¹˜ç§¯ï¼‰ï¼Œæ­¤ç±» $ k=30,42,66,70,78 $ï¼Œæ€»æ•°ä¸º $ \\lfloor 100/30 \\rfloor + \\lfloor 100/42 \\rfloor + \\lfloor 100/66 \\rfloor + \\lfloor 100/70 \\rfloor + \\lfloor 100/78 \\rfloor =3+2+1+1+1=8 $ã€‚ å› æ­¤æ€»æ•°ä¸º $ 171+8=179 $ï¼Œäºæ˜¯ $$ \\mathbb{P}(\\mu(a,b)=-1) = \\dfrac{179}{100^{2}} = \\dfrac{179}{10000}. $$\nProblem 6 è®¾ $ a_1, a_2, \\dots, a_n $ æ˜¯ä¸€äº›å®æ•°ï¼Œå®ƒä»¬çš„ç»å¯¹å€¼éƒ½æ»¡è¶³ $ |a_i| \\ge 1 $ã€‚è€ƒè™‘æ‰€æœ‰ $ 2^n $ ç§çº¿æ€§ç»„åˆ $ \\sum_{i=1}^{n} \\epsilon_i \\cdot a_i $ï¼Œå…¶ä¸­æ¯ä¸ª $ \\epsilon_i $ å¯ä»¥å–å€¼ $ \\{-1, +1\\} $ã€‚è¯·è¯æ˜ï¼Œè¿™äº›å’Œä¸­è½åœ¨ä»»æ„åŒºé—´ $ (x-1, x+1) $ å†…çš„æ•°é‡è‡³å¤šä¸º $ \\binom{n}{\\lfloor n/2 \\rfloor} $ã€‚\nè¯\næˆ‘ä»¬ç¨å¾®è½¬åŒ–ä¸€ä¸‹é¢˜ç›®ï¼Œä»¤ $ b_{i}=2a_{i} $ï¼Œå– $ \\{ b_{n} \\} $ çš„å¹‚é›† $ \\mathcal{P} $ï¼Œå¯¹äº $ S\\in \\mathcal{P} $ï¼Œ$ S $ ä¸­æ‰€æœ‰å…ƒç´ ä¹‹å’Œæ˜¾ç„¶å¯ä»¥æœ‰ä¸€ç»„ $ \\sum_{i=1}^{n}\\epsilon_{i}\\cdot a_{i} $ å¹³ç§»å¾—åˆ°ï¼Œå°±è¿™æ · $ \\mathcal{P} $ å¯ä»¥å’Œ $ 2^{n} $ ä¸­ $ a_{i} $ çš„çº¿æ€§ç»„åˆä¸€ä¸€å¯¹åº”ã€‚å¹¶ä¸”æˆ‘ä»¬åªéœ€è¦è€ƒè™‘è½åœ¨ä»»æ„åŒºé—´ä¸­çš„æ•°é‡ï¼Œæ‰€ä»¥å¹³ç§»æ“ä½œå¹¶ä¸ä¼šé€ æˆå½±å“ï¼Œäºæ˜¯æˆ‘ä»¬çš„é—®é¢˜å°±è½¬åŒ–æˆäº† $ \\mathcal{P} $ ä¸­é›†åˆçš„å…ƒç´ ä¹‹å’Œè½åœ¨ä»»æ„åŒºé—´ $ (x-1,x+1) $ å†…çš„é›†åˆæ•°é‡è‡³å¤šä½ $ \\binom{ n }{ \\lfloor n / 2 \\rfloor } $ã€‚\nå‡è®¾é›†åˆ $ S $ æ˜¯ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„é›†åˆã€‚ç”±äº $ \\left| b_{i} \\right|=2\\left| a_{i} \\right|\u003e2 $ï¼Œå› æ­¤åœ¨ $ S $ çš„åŸºç¡€ä¸Šä»»æ„æ·»åŠ ä¸€ä¸ªåŸæ¥ä¸åŒ…å«çš„å…ƒç´ ï¼Œè‡³å°‘ä¼šå¯¼è‡´å…ƒç´ ä¹‹å’Œå˜åŒ– $ 2 $ï¼Œä»è€Œä¸€å®šä¸ä¼šè½åœ¨ $ (x-1,x+1) $ ä¸­ã€‚è¿™è¯´æ˜äº†è‹¥ $ \\sum_{S}\\in(x-1,x+1) $ï¼Œé‚£ä¹ˆä»»æ„ $ S' $ æ»¡è¶³ $ S\\subset S' $ï¼Œéƒ½æœ‰ $ \\sum_{S'}\\not\\in (x-1,x+1) $ã€‚\nå› æ­¤æˆ‘ä»¬ç›´æ¥è€ƒè™‘ååºé›† $ (\\mathcal{P},\\subseteq) $ã€‚æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œæ˜¾ç„¶å…ƒç´ ä¹‹å’Œè½åœ¨ $ (x-1,x+1) $ çš„æ‰€æœ‰é›†åˆä¸€å®šæ˜¯ä¸€ä¸ªåé“¾ã€‚ç›´æ¥åˆ©ç”¨ Sperner å®šç†ï¼Œå¾—åˆ°æ­¤æ—¶åé“¾çš„æ•°é‡è‡³å¤šä¸º $ \\binom{ n }{ \\lfloor n / 2 \\rfloor } $ï¼Œå› æ­¤æ»¡è¶³æ¡ä»¶çš„é›†åˆæ•°é‡ä¹Ÿè‡³å¤šä¸º $ \\binom{ n }{ \\lfloor n / 2 \\rfloor } $ã€‚\n","permalink":"https://diefish1024.github.io/posts/class-notes/cs0901-combinatorics/cs0901-hw3/","summary":"\u003ch2 id=\"problem-1\"\u003eProblem 1\u003c/h2\u003e\n\u003cp\u003eè¯æ˜\n$$ \n\n\\begin{align*}\n\\sum_{i=0}^{n} (-1)^{i}\\binom{ n }{ i } \\binom{ n+m-i }{ k-i } = \\binom{ m }{ k }  \\\\\n\\sum_{i=0}^{n} \\binom{ k }{ i } D_{n-i} = \\sum_{j=0}^{n-k} (-1)^{j}\\binom{ n-k }{ j } (n-j)!\n\\end{align*}\n\n $$\n\u003cstrong\u003eè¯ 1\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¯¹äºç¬¬ä¸€ä¸ªå¼å­ï¼Œæˆ‘ä»¬è€ƒè™‘ç»„åˆæ„ä¹‰ã€‚è®¾æœ‰ $ A,B $ ä¸¤ä¸ªé›†åˆï¼Œåˆ†åˆ«åŒ…å« $ n $ å’Œ $ m $ ä¸ªå…ƒç´ ï¼Œæ€»å…± $ n+m $ ä¸ªå…ƒç´ ã€‚æˆ‘ä»¬å¸Œæœ›ä»é›†åˆ $ B $ ä¸­æ°å¥½é€‰æ‹© $ k $ ä¸ªå…ƒç´ ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å®¹æ–¥åŸç†çš„è¡¥é›†å½¢å¼æ±‚è§£ï¼Œå®šä¹‰äº‹ä»¶ $ A_{i} $ ä¸ºæ‰€é€‰çš„ $ k $ ä¸ªå…ƒç´ ä¸­è‡³å°‘åŒ…å« $ i $ ä¸ªæ¥è‡ª $ A $ çš„å…ƒç´ ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ±‚è§£çš„äº‹ä»¶é›†åˆä¸º $ U\\setminus\\bigcup_{i\\leq n}A_{i} $ï¼Œå¹¶ä¸”\n$$ \n\n\\left| A_{i} \\right| = \\binom{ n }{ i } \\binom{ n+m-i }{ k-i } \n\n $$\nå› æ­¤æ ¹æ®å®¹æ–¥åŸç†ï¼Œå°±å¯ä»¥å¾—åˆ°\n$$ \n\n\\left| U\\setminus \\bigcup_{i\\leq n}A_{i} \\right| = \\sum_{i=0}^{n} (-1)^{i}\\binom{ n }{ i } \\binom{ n+m-i }{ k-i } = \\binom{ m }{ k }  \n\n $$\u003c/p\u003e","title":"CS0901 HW3"},{"content":"é¢˜ç›®\nProblem 1.1 è®¾ $ \\mathcal{F} $ æ˜¯ä¸€ä¸ªæœ‰é™çš„ $ \\sigma $-ä»£æ•°ã€‚å®šä¹‰å…¶ä¸­â€œæœ€å°\u0026quot;çš„å…ƒç´ ä¸ºå…¶åŒ…å«äº $ \\mathcal{F} $ ä¸­çš„å­é›†ä»…ä¸ºè‡ªèº«å’Œç©ºé›†ï¼Œå½¢å¼åŒ–åœ°æè¿°ï¼Œè‹¥ $ A\\in \\mathcal{F} $ ä¸ºâ€œæœ€å°â€çš„å…ƒç´ ï¼Œé‚£ä¹ˆå¦‚æœ $ B\\in \\mathcal{F} $ å¹¶ä¸” $ B\\subseteq A $ï¼Œé‚£ä¹ˆä¸€å®šæœ‰ $ B\\in \\{ \\emptyset,A \\} $ã€‚\nå¯ä»¥è¯æ˜è¿™æ ·çš„å…ƒç´ å­˜åœ¨å¹¶ä¸”æœ‰é™ï¼šå¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¯æ¬¡ä»»å–ä¸€ä¸ª $ \\mathcal{F} $ ä¸­çš„å…ƒç´ ï¼Œéƒ½èƒ½æ‰¾åˆ°å±äºå®ƒçš„ä¸€ä¸ªæ›´å°çš„å…ƒç´ ï¼Œä½† $ \\mathcal{F} $ æ˜¯æœ‰é™é›†ï¼Œæ‰€ä»¥è¿™æ ·çš„è¿‡ç¨‹ä¸å¯èƒ½ä¸€ç›´é‡å¤ä¸‹å»ï¼Œå› æ­¤â€œæœ€å°â€å…ƒç´ å¿…ç„¶å­˜åœ¨å¹¶ä¸”æœ‰é™ã€‚\næˆ‘ä»¬è®¾æ‰€æœ‰è¿™äº›ä¸åŒçš„â€œæœ€å°â€å…ƒç´ ä¸º $ S=\\{ A_{1},A_{2},\\dots,A_{n} \\} $ã€‚æˆ‘ä»¬å…ˆè¯æ˜è¿™æ„æˆäº†å…¨ç©ºé—´çš„ä¸€ä¸ªåˆ†åˆ’ï¼š\né¦–å…ˆè¿™äº›å…ƒç´ è‚¯å®šä¸¤ä¸¤ä¸ç›¸äº¤ï¼Œå¦åˆ™ä¸æ»¡è¶³â€œæœ€å°â€çš„å®šä¹‰ã€‚å‡è®¾ $ A_{i}\\cap A_{j}= C\\neq\\emptyset $ï¼Œæ ¹æ®â€œæœ€å°â€ï¼Œéç©ºçš„ $ C $ æ˜¯ $ A_{i} $ çš„å­é›†ï¼Œä¸€å®šæœ‰ $ C=A_{i} $ï¼ŒåŒæ ·ä¹Ÿæœ‰ $ C=A_{j} $ï¼Œè¿™å°±æ¨å‡ºäº† $ A_{i}=A_{j} $ï¼Œä»è€ŒçŸ›ç›¾ã€‚\nå…¶æ¬¡è¯æ˜è¿™äº›å…ƒç´ çš„å¹¶é›†ä¸ºå…¨ç©ºé—´ã€‚è®¾å…¨ç©ºé—´ä¸º $ X $ï¼Œå¹¶ä¸” $ A=\\bigcup_{i=1}^{n}A_{i} $ï¼Œä»¤ $ A^{c}=X\\setminus A $ã€‚å¦‚æœ $ A^{c} $ ä¸æ˜¯ç©ºé›†ï¼Œæˆ‘ä»¬è‚¯å®šèƒ½æ‰¾å‡ºä¸€ä¸ªâ€œæœ€å°å…ƒç´ â€ $ A'\\subseteq A^{c} $ï¼Œè¿™ä¸æˆ‘ä»¬å–å‡ºäº†æ‰€æœ‰â€œæœ€å°â€å…ƒç´ çš„å‰é¢˜çŸ›ç›¾ã€‚å› æ­¤ $ X=A $ï¼Œæ‰€æœ‰â€œæœ€å°â€å…ƒç´ çš„å¹¶é›†ä¸ºå…¨ç©ºé—´ã€‚ç»“åˆä¸¤ä¸¤ä¸ç›¸äº¤çš„æ€§è´¨ï¼Œæˆ‘ä»¬å°±è¯æ˜äº†è¿™æ„æˆäº†å…¨ç©ºé—´çš„ä¸€ä¸ªåˆ†åˆ’ã€‚\nä¸‹é¢è¯æ˜ $ \\mathcal{F} $ çš„å¤§å°ä¸º $ 2^{n} $ã€‚æˆ‘ä»¬è€ƒè™‘ $ S $ çš„æ‰€æœ‰å­é›†çš„é›†åˆ $ 2^{S} $ã€‚æ ¹æ® $ \\sigma $-ä»£æ•°çš„æ€§è´¨ï¼Œç”±äº $ S $ çš„ä»»æ„ä¸€ä¸ªå­é›†éƒ½æ˜¯è‹¥å¹²ä¸ª $ \\mathcal{F} $ ä¸­å…ƒç´ çš„å¹¶ï¼Œå› æ­¤å¿…ç„¶ä¹Ÿæ˜¯ $ \\mathcal{F} $ ä¸­çš„å…ƒç´ ï¼Œäºæ˜¯ $ \\mathcal{F} $ ä¸­è‡³å°‘æœ‰ $ 2^{\\left| S \\right|}=2^{n} $ ä¸ªå…ƒç´ ã€‚å¦‚æœé™¤æ­¤ä¹‹å¤– $ \\mathcal{F} $ ä¸­è¿˜æœ‰åˆ«çš„å…ƒç´ ï¼Œæ ¹æ®ä¸Šé¢çš„è¯æ˜ï¼Œè¿™è¿åäº† $ S $ ä¸ºå…¨ç©ºé—´çš„åˆ†åˆ’çš„æ¡ä»¶ï¼Œå› æ­¤ $ \\mathcal{F} $ çš„å¤§å°ä¸º $ 2^{n} $ã€‚\nç»¼ä¸Šæˆ‘ä»¬è¯æ˜äº†æœ‰é™ $ \\sigma $-ä»£æ•° $ \\mathcal{F} $ çš„å¤§å°ä¸º $ 2^{n} $ï¼Œå¹¶ä¸”èƒ½æ‰¾åˆ°ä¸€ä¸ªæ°æœ‰ $ n $ ä¸ªå…ƒç´ çš„å…¨ç©ºé—´çš„åˆ†åˆ’ã€‚\nProblem 1.2 (1)\nè®¾æ¯ä¸ªäººçš„ç”Ÿæ—¥ä¸º $ b_{k} $ï¼Œé‚£ä¹ˆæ ·æœ¬ç©ºé—´ $ \\Omega=\\{ (b_{1},b_{2},\\dots,b_{n})| b_{k}\\in[m]\\text{ for }k\\in[n]\\} $ã€‚å¯¹äºäº‹ä»¶ $ A_{i,j} $ è¡¨ç¤º $ i $ å’Œ $ j $ åœ¨åŒä¸€å¤©ï¼Œæˆ‘ä»¬æœ‰ $$ A_{i,j} = \\{ (b_{1},b_{2},\\dots,b_{n})\\in\\Omega : b_{i} = b_{j} \\} $$ å› æ­¤ $ \\left| A_{i,j} \\right|=m\\cdot m^{n-2} $ï¼Œå¯ä»¥å¾—åˆ° $ \\mathbb{P}(A_{i,j})= \\frac{\\left| A_{i,j} \\right|}{\\left| \\Omega \\right|}=\\frac{1}{m} $ã€‚\nè¦è¯æ˜ä¸¤ä¸¤ç‹¬ç«‹æ€§ï¼Œæˆ‘ä»¬éœ€è¦è¯æ˜å¯¹äºä»»æ„ä¸¤ä¸ªä¸åŒäº‹ä»¶ $ A_{i,j},A_{k,l} $ï¼ˆå…¶ä¸­ $ i\u003c j,k\u003c l $ å¹¶ä¸” $ \\{ i,j \\}\\neq \\{ k,l \\} $ï¼‰ï¼Œéœ€è¦æœ‰ $$ \\mathbb{P}(A_{i,j}\\cap A_{k,l})=\\mathbb{P}(A_{i,j})\\cdot \\mathbb{P}(A_{k,l}) = \\dfrac{1}{m^{2}} $$ ä¸‹é¢æˆ‘ä»¬è®¡ç®— $ \\left| A_{i,j}\\cap A_{k,l} \\right| $ã€‚åˆ†ç±»è®¨è®ºã€‚\nå¦‚æœ $ \\{ i,j \\}\\cap \\{ k,l \\}\\neq \\emptyset $ï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªäº‹ä»¶å…±äº«æŸä¸€ä¸ªå­¦ç”Ÿï¼Œæ­¤æ—¶ç¡®å®šä¸‰ä¸ªäººçš„ç”Ÿæ—¥ç›¸åŒï¼Œæœ‰ $$ |A_{i,j}\\cap A_{k,l}| = m\\cdot m^{n-3} = m^{n-2} $$ å¦‚æœ $ \\{ i,j \\}\\cap \\{ k,l \\}=\\emptyset $ï¼Œæ­¤æ—¶ $$ \\left| A_{i,j}\\cap A_{k,l} \\right| = m^{2}\\cdot m^{n-4}=m^{n-2} $$ å› æ­¤æ— è®ºé‚£ç§æƒ…å†µï¼Œéƒ½æœ‰ $$ \\mathbb{P}(A_{i,j}\\cap A_{k,l})=\\dfrac{\\left| A_{i,j}\\cap A_{k,l} \\right| }{\\left| \\Omega \\right| }= \\dfrac{1}{m^{2}} $$ å› æ­¤ $$ \\mathbb{P}(A_{i,j}\\cap A_{k,l})=\\mathbb{P}(A_{i,j})\\cdot \\mathbb{P}(A_{k,l}) $$\näºæ˜¯è¯æ˜äº† $ A_{i,j} $ ä¸¤ä¸¤ç‹¬ç«‹ã€‚\n(2)\næˆ‘ä»¬ç›´æ¥è€ƒè™‘ $ A_{1,2}, A_{2,3}, A_{1,3} $ ä¸‰ä¸ªäº‹ä»¶ã€‚äº‹ä»¶ $ A_{1,2}\\cap A_{2,3}\\cap A_{1,3} $ è¯´æ˜ $ 1,2,3 $ ä¸‰ä¸ªäººçš„ç”Ÿæ—¥åœ¨åŒä¸€å¤©ï¼Œå› æ­¤ $$ \\mathbb{P}(A_{1,2}\\cap A_{2,3}\\cap A_{1,3}) = \\dfrac{m\\cdot m^{n-3}}{m^{n}} = \\dfrac{1}{m^{2}} $$ ç„¶è€Œ $$ \\mathbb{P}(A_{1,2})\\cdot \\mathbb{P}(A_{2,3})\\cdot \\mathbb{P}(A_{1,3}) = \\left( \\dfrac{1}{m} \\right)^{3} = \\dfrac{1}{m^{3}} \\neq \\mathbb{P}(A_{1,2}\\cap A_{2,3}\\cap A_{1,3}) $$ è¿™å°±è¯´æ˜äº†å®ƒä»¬å¹¶ä¸ç›¸äº’ç‹¬ç«‹ã€‚\n(3)\né¦–å…ˆä¸å¦¨ä»¤ $ n\\leq m $ï¼Œå¦åˆ™å¿…ç„¶æœ‰ä¸¤ä¸ªäººç”Ÿæ—¥ç›¸åŒï¼Œè‚¯å®šä¸æ˜¯æ»¡è¶³æ¡ä»¶çš„ $ n $ çš„æœ€å°å€¼ã€‚æˆ‘ä»¬ç›´æ¥è€ƒè™‘ç­ä¸Šä»»æ„ä¸¤ä¸ªäººçš„ç”Ÿæ—¥éƒ½ä¸ç›¸åŒï¼Œè®¾ä¸ºäº‹ä»¶ $ B $ï¼Œæˆ‘ä»¬éœ€è¦ $ \\mathbb{P}(B)\\leq \\frac{1}{2} $ã€‚ä¸‹é¢è®¡ç®— $ B $ ä¸­å«æœ‰çš„æ ·æœ¬æ•°é‡ $$ \\left| B \\right| = m^{\\underline{n}} $$ å› æ­¤ $$ \\mathbb{P}(B) = \\dfrac{m^{\\underline{n}}}{m^{n}} = \\dfrac{30^{\\underline{n}}}{30^{n}} $$ ä½¿ç”¨è®¡ç®—æœºä¾æ¬¡è®¡ç®— $ n=3,4,\\dots $ æˆ‘ä»¬å¯ä»¥å‘ç° $$ \\mathbb{P}(B)|_{n=6} \\approx 0.59,\\quad \\mathbb{P}(B)|_{n=7} \\approx 0.47 \u003c \\dfrac{1}{2} $$ è¿™å°±å¾—åˆ°äº† $ n_{\\min}=7 $ã€‚\nProblem 1.3 (1) $$ \\begin{align*} \\\\ F \\searrow E \\implies \u0026 \\mathbb{P}(E|F) = \\dfrac{\\mathbb{P}(EF)}{\\mathbb{P}(F)} \\leq \\mathbb{P}(E) \\\\ \\implies \u0026 \\mathbb{P}(EF) \\leq \\mathbb{P}(E)\\cdot \\mathbb{P}(F) \\\\ \\implies \u0026 \\mathbb{P}(F|E) = \\dfrac{\\mathbb{P}(EF)}{\\mathbb{P}(E)} \\leq \\mathbb{P}(F) \\\\ \\implies \u0026 E \\searrow F \\end{align*} $$ (2)\nä¸æ­£ç¡®ï¼Œç›´æ¥ä»¤ $ F,G $ ä¸ºå‘ç”Ÿæ¦‚ç‡ä¸ä¸º $ 1 $ çš„åŒä¸€ä¸ªäº‹ä»¶ï¼Œæ˜¾ç„¶è¿™ä¸ä¼šè¿èƒŒæ¡ä»¶ï¼Œä½†æ˜¯æœ‰ $$ \\mathbb{P}(G|F) = 1 \\not\\le \\mathbb{P}(G) $$\n(3)\nä¸æ­£ç¡®ã€‚è€ƒè™‘é›†åˆ $ \\Omega=\\{ 1,2,3,4 \\} $ï¼Œæ¯ä¸ªæ ·æœ¬ç‚¹çš„æ¦‚ç‡å‡ä¸º $ \\frac{1}{4} $ï¼Œæˆ‘ä»¬ä»¤ $ E=\\{ 1,2 \\},F=\\{ 1,3 \\},G=\\{ 1,4 \\} $ï¼Œè¿™æ—¶ $$ \\mathbb{P}(E|F) = \\dfrac{1}{2} \\leq \\mathbb{P}(E) = \\dfrac{1}{2}, \\mathbb{P}(E|G) = \\dfrac{1}{2}\\leq \\mathbb{P}(E) = \\dfrac{1}{2} $$ ä½†æ˜¯ $$ \\mathbb{P}(E|(F\\cap G)) = 1 \\not\\leq \\mathbb{P}(E) $$\nProblem 2 (1)\nCase 1ï¼šå¦‚æœ $ j\\leq K $ï¼Œé‚£ä¹ˆå¿…ç„¶ä¸ä¼šè¢«å½•ç”¨ï¼Œæ­¤æ—¶ $ \\mathbb{P}(A|B_{j})=0 $ã€‚\nCase 2ï¼šå¦‚æœ $ j=K+1 $ï¼Œé‚£ä¹ˆå¿…ç„¶è¢«å½•ç”¨ï¼Œæ­¤æ—¶ $ \\mathbb{P}(A|B_{j})=1 $ã€‚\nCase 3ï¼šå¦‚æœ $ j\u003eK+1 $ï¼Œè¿™æ˜¯å¦‚æœæƒ³è¦è¢«å½•ç”¨ï¼Œå¿…é¡»è¦æœ‰å‰ $ j-1 $ ä¸ªé¢è¯•è€…ä¸­è¡¨ç°æœ€å¥½çš„äººå‡ºç°åœ¨å‰ $ K $ è½®é¢è¯•ï¼Œå¦åˆ™å°±ä¼šå…ˆäºç¬¬ $ j $ ä¸ªäººè¢«å½•ç”¨ã€‚ç”±äºå‡ºç°åœ¨æ¯ä¸ªä½ç½®çš„æ¦‚ç‡éƒ½ç›¸ç­‰ï¼Œå› æ­¤æ­¤æ—¶ $ \\mathbb{P}(A|B_{j})=\\frac{K}{j-1} $ã€‚\nç»¼ä¸Šï¼Œ $$ \\mathbb{P}(A|B_{j}) = \\begin{cases} 0 \u0026 ,j\\leq K \\\\ \\dfrac{K}{j-1} \u0026 ,j \u003eK \\end{cases} $$ (2)\nç”±äº $ P(B_{j})=\\dfrac{1}{n}\\,\\text{for }j\\in[n] $ï¼Œå› æ­¤æ ¹æ®å…¨æ¦‚ç‡å…¬å¼ï¼Œæœ‰ $$ \\mathbb{P}(A) = \\sum_{j=1}^{n} \\mathbb{P}(A|B_{j})\\cdot \\mathbb{P}(B_{j}) = \\dfrac{1}{n}\\sum_{j=K+1}^{n} \\dfrac{K}{j-1} = \\dfrac{K}{n}\\sum_{j=K}^{n-1} \\dfrac{1}{j} $$\n(3)\næ ¹æ®æç¤ºï¼Œåœ¨ $ n,K $ è¶³å¤Ÿå¤§æ—¶ $$ \\mathbb{P}(A)\\approx \\dfrac{K}{n}\\cdot \\ln \\dfrac{n}{K} \\xlongequal{p= \\frac{K}{n}}-p\\ln p = \\varphi(p) $$ å¯¹ $ \\varphi(p) $ æ±‚æå€¼ï¼Œå®¹æ˜“å¾—åˆ°åœ¨ $ p= \\frac{1}{e} $ æ—¶ $ \\varphi(p)_{\\max}= \\frac{1}{e} $ã€‚\nå› æ­¤æˆ‘ä»¬å– $ K\\approx \\dfrac{n}{e} $ï¼Œå¯ä»¥å¾—åˆ° $$ \\mathbb{P}(A)\\approx \\dfrac{1}{e} \\approx 0.368 $$\nProblem 3 (1)\nç”±äº $ A_{i,\\sigma_{i}}\\in \\{ 0,1 \\} $ï¼Œå› æ­¤ $ \\prod_{i=1}^{n}A_{i,\\sigma(i)}=[\\forall i\\in[n],A_{i,\\sigma(i)}=1]=[\\sigma \\in T_{n}] $ã€‚å› æ­¤ $ \\sum_{\\sigma \\in S}\\prod_{i=1}^{n}A_{i,\\sigma(i)} $ è¡¨ç¤º $ T_{n} $ ä¸­çš„ç½®æ¢çš„æ•°é‡ã€‚\nå¦‚æœä¸€ä¸ªæ˜ å°„ $ f\\in T_{n} $ æ˜¯å®Œç¾åŒ¹é…ï¼Œå¿…ç„¶æœ‰ $ f $ æ˜¯ $ [n] $ çš„ä¸€ä¸ªç½®æ¢ï¼Œå¦åˆ™æ— æ³•è®© $ V_{1},V_{2} $ ä¸­çš„ç‚¹ä¸¤ä¸¤åŒ¹é…ï¼ˆåè¯æ³•æ˜“è¯ï¼‰ï¼›å¹¶ä¸”å¦‚æœ $ f\\in T_{n} $ æ˜¯ $ [n] $ çš„ä¸€ä¸ªç½®æ¢ï¼Œå¸¦å…¥å®šä¹‰ï¼ŒåŒæ ·å®¹æ˜“è¯æ˜è¿™æ˜¯ä¸€ä¸ªå®Œç¾åŒ¹é…ã€‚å› æ­¤ $ f $ æ˜¯ä¸€ä¸ªå®Œç¾åŒ¹é…å’Œ $ f $ æ˜¯ä¸€ä¸ªç½®æ¢ä¸ºå……è¦æ¡ä»¶ã€‚å› æ­¤ $ M $ æˆç«‹å½“ä¸”ä»…å½“ $ f $ ä¸ºä¸€ä¸ªç½®æ¢ï¼Œäºæ˜¯ $ \\left| M \\right|=\\sum_{\\sigma \\in S}\\prod_{i=1}^{n}A_{i,\\sigma(i)} $ã€‚è¿™å°±æœ‰ $$ \\mathbb{P}(M) = \\dfrac{\\left| M \\right| }{\\left| T_{n} \\right|} = \\dfrac{\\sum_{\\sigma \\in S}\\prod_{i=1}^{n}A_{i,\\sigma(i)}}{\\left| T_{n} \\right| } $$ (2)\né¦–å…ˆæ ¹æ®ä¸Šä¸€é—®çš„åˆ†æï¼Œäº‹ä»¶ $ E_{\\emptyset}=M $ï¼ˆæ˜ å°„çš„å€¼åŸŸåˆšå¥½æ˜¯ $ [n] $ ç­‰ä»·äºè¿™æ˜¯ä¸€ä¸ªç½®æ¢ï¼‰ã€‚å› æ­¤äº‹ä»¶ $ E_{\\emptyset} $ çš„è¡¥é›† $ E_{\\emptyset}^{c} $ è¡¨ç¤º $ f $ ä¸æ˜¯æ»¡å°„ï¼Œå€¼åŸŸä¸º $ \\{ 1 \\} $ æˆ– $ \\{ 2 \\} $ï¼Œä¸¤ç§å¯èƒ½åˆ†åˆ«è¡¨ç¤ºå…ƒç´  $ 2 $ æˆ–å…ƒç´  $ 2 $ ä¸åœ¨å€¼åŸŸä¸­ï¼Œå¯¹åº”äº‹ä»¶ $ E_{2} $ å’Œ $ E_{1} $ï¼Œäºæ˜¯ $ E_{\\emptyset}^{c}=E_{1}\\cup E_{2} $ã€‚\næ ¹æ®å®¹æ–¥åŸç† $$ \\mathbb{P}(E_{1}\\cup E_{2}) = \\mathbb{P}(E_{1}) + \\mathbb{P}(E_{2}) - \\mathbb{P}(E_{1}E_{2}) $$ äºæ˜¯ $$ \\mathbb{P}(E_{\\emptyset}) = 1-\\mathbb{P}(E_{1}\\cup E_{2}) = 1-\\mathbb{P}(E_{1})-\\mathbb{P}(E_{2}) + \\mathbb{P}(E_{1}E_{2}) $$ ä¸‹é¢æˆ‘ä»¬å¸¦å…¥ $ E^{+}_{*} $ï¼š\n$ E_{\\emptyset}^{+}=T_{n}\\implies\\mathbb{P}(E_{\\emptyset}^{+})=1 $ã€‚ $ E_{\\{ 1 \\}}^{+} = \\bigcap_{j\\in \\{ 1 \\}}E_{j}=E_{1}\\implies \\mathbb{P}(E_{\\{ 1 \\}}^{+})=\\mathbb{P}(E_{1}) $ã€‚ $ E_{\\{ 2 \\}}^{+} = \\bigcap_{j\\in \\{ 2 \\}}E_{j}=E_{1}\\implies \\mathbb{P}(E_{\\{ 2 \\}}^{+})=\\mathbb{P}(E_{2}) $ã€‚ $ E_{\\{ 1,2 \\}}^{+} = \\bigcap_{j\\in \\{ 1,2 \\}}E_{j}=E_{1}E_{2}\\implies \\mathbb{P}(E_{\\{ 1 \\}}^{+})=\\mathbb{P}(E_{1}E_{2}) $ã€‚ å¾—åˆ° $$ \\mathbb{P}(E_{\\emptyset}) = \\mathbb{P}(E_{\\emptyset}^{+}) - \\mathbb{P}(E_{\\{ 1 \\}}^{+}) - \\mathbb{P}(E_{\\{ 2 \\}}^{+})+\\mathbb{P}(E_{\\{ 1,2 \\}}^{+}) $$ (3) åŒç† $ (2) $ï¼Œæˆ‘ä»¬æœ‰ $ E_{\\emptyset}^{c}=\\bigcup_{i=1}^{n}E_{i} $ï¼Œæ ¹æ®å®¹æ–¥åŸç† $$ \\mathbb{P}\\left( \\bigcup_{i=1}^{n}E_{i} \\right) = \\sum_{r=1}^{n} (-1)^{r-1}\\sum_{J\\subseteq[n],|J|=r}\\mathbb{P}\\left( \\bigcap_{j\\in J}E_{j} \\right) $$\n$ E_{j} $ è¡¨ç¤ºæ˜ å°„çš„å€¼åŸŸæ˜¯ $ [n]\\setminus\\{ j \\} $ çš„å­é›†ã€‚$ \\forall J\\subseteq[n] $ï¼Œæˆ‘ä»¬æœ‰ $ [n]\\setminus J=\\bigcap_{j\\in J}([n]\\setminus \\{ j \\}) $ï¼Œäºæ˜¯ $$ E_{J}^{+} = \\bigcap_{j\\in J}E_{j} \\implies \\mathbb{P}(E_{J}^{+}) = \\mathbb{P}\\left( \\bigcap_{j\\in J}E_{j} \\right) $$ å› æ­¤ $$ \\sum_{r=1}^{n} (-1)^{r-1}\\sum_{J\\subseteq[n],|J|=r}\\mathbb{P}\\left( \\bigcap_{j\\in J}E_{j} \\right) = \\sum_{r=1}^{n} (-1)^{r-1}\\sum_{J\\subseteq[n],|J|=r}\\mathbb{P}\\left( E_{J}^{+} \\right) $$ å¸¦å…¥å¾—åˆ° $$ \\begin{align*} \\mathbb{P}(M)=\\mathbb{P}(E_{\\emptyset}) \u0026 = 1-\\mathbb{P}(E_{\\emptyset}^{+}) \\\\ \u0026 = 1 - \\sum_{r=1}^{n} (-1)^{r-1}\\sum_{J\\subseteq[n],|J|=r}\\mathbb{P}\\left( E_{J}^{+} \\right) \\\\ \u0026 = \\mathbb{P}(E_{\\emptyset}^{+})- \\sum_{r=1}^{n} (-1)^{r-1}\\sum_{J\\subseteq[n],|J|=r}\\mathbb{P}\\left( E_{J}^{+} \\right) \\\\ \u0026 = \\sum_{r=0}^{n} (-1)^{r}\\sum_{J\\subseteq[n],|J|=r}\\mathbb{P}\\left( E_{J}^{+} \\right) \\\\ \u0026 = \\sum_{J\\subseteq[n]}(-1)^{\\left| J \\right| }\\mathbb{P}(E_{J}^{+}) \\end{align*} $$ (4)\nè¦è¯æ˜ $ \\mathbb{P}(E_{J}^{+})=\\left( \\prod_{i=1}^{n}\\left( \\sum_{j\\in [n]\\setminus J} A_{i,j}\\right) \\right) / \\left| T_{n} \\right| $ï¼Œæˆ‘ä»¬åªéœ€è¦è¯æ˜ $ \\left| E_{J}^{+} \\right|=\\prod_{i=1}^{n}\\left( \\sum_{j\\in [n]\\setminus J} A_{i,j}\\right) $ã€‚\næˆ‘ä»¬éœ€è¦æ‰¾å‡ºæ‰€æœ‰åœ¨ $ T_{n} $ ä¸­å¹¶ä¸”å€¼åŸŸä¸º $ [n]\\setminus J $ çš„æ˜ å°„çš„æ•°é‡ã€‚å¯¹äºæ¯ä¸ª $ i $ï¼Œå¯èƒ½çš„ $ f(i) $ çš„æ•°é‡ä¸º $ \\sum_{j\\in [n]\\setminus J}A_{i,j} $ï¼ˆæ˜ å°„åˆ° $ [n]\\setminus J $ å¹¶ä¸”å›¾ä¸­å­˜åœ¨å¯¹åº”çš„è¾¹ï¼‰ã€‚æ ¹æ®ä¹˜æ³•åŸç†ï¼Œç”±äºæ¯ä¸ª $ i $ ç›¸äº’ç‹¬ç«‹ï¼Œå› æ­¤æ€»çš„æ˜ å°„æ•°é‡ä¸º $$ \\left| E_{J}^{+} \\right|=\\prod_{i=1}^{n}\\left( \\sum_{j\\in [n]\\setminus J} A_{i,j}\\right) $$ äºæ˜¯ $$ \\mathbb{P}(E_{J}^{+}) = \\dfrac{\\left| E_{J}^{+} \\right| }{\\left| T_{n} \\right| } = \\dfrac{\\prod_{i=1}^{n}\\left( \\sum_{j\\in [n]\\setminus J} A_{i,j}\\right)}{\\left| T_{n} \\right| } $$ ç›´æ¥å¸¦å…¥ $ (3) $ ä¸­å¾—åˆ°çš„å®¹æ–¥åŸç†å…¬å¼ï¼Œå³å¯å¾—åˆ° $$ \\begin{align*} \\mathbb{P}(M) \u0026 = \\sum_{J\\subseteq[n]}(-1)^{\\left| J \\right| }\\mathbb{P}(E_{J}^{+}) \\\\ \u0026 = \\sum_{J\\subseteq[n]}(-1)^{\\left| J \\right| }\\dfrac{\\prod_{i=1}^{n}\\left( \\sum_{j\\in [n]\\setminus J} A_{i,j}\\right)}{\\left| T_{n} \\right| } \\\\ \u0026 = \\dfrac{\\sum_{J\\subseteq[n]}(-1)^{\\left| J \\right| }\\prod_{i=1}^{n}\\left( \\sum_{j\\in [n]\\setminus J} A_{i,j}\\right)}{\\left| T_{n} \\right| } \\end{align*} $$\nProblem 4 (1)\næˆ‘ä»¬å®šä¹‰ $ A_{k} $ ä¸ºæ‰§è¡Œå®Œ $ k $ æ¬¡ç¼©è¾¹æ“ä½œä»¥åï¼Œæœ€å°å‰² $ C $ ä¸­ä»»æ„ä¸€æ¡è¾¹éƒ½è¿˜æ²¡æœ‰è¢«åˆ æ‰çš„æ¦‚ç‡ï¼Œé‚£ä¹ˆ $ p(G,t)=\\mathbb{P}(A_{n-t}) $ã€‚\nä¸ºäº†åˆ†æ $ A_{k} $ï¼Œæˆ‘ä»¬å®šä¹‰äº‹ä»¶ $ B_{k} $ ä¸ºç¬¬ $ k $ æ¬¡ç¼©è¾¹é€‰æ‹©çš„ä¸æ˜¯ $ C $ ä¸­çš„ç‚¹ï¼Œäºæ˜¯ $ A_{k}=\\bigcap_{i=1}^{k}B_{i} $ã€‚å› æ­¤æ ¹æ®é“¾å¼æ³•åˆ™ï¼Œå¾—åˆ° $$ p(G,t)=\\mathbb{P}(A_{n-t}) = \\prod_{i=1}^{n-t}\\mathbb{P}\\left( B_{i}\\bigg|\\bigcap_{j=1}^{i-1}B_{i} \\right) $$ æˆ‘ä»¬å…³å¿ƒè¿™ä¸ªæ¦‚ç‡çš„ä¸‹ç•Œï¼Œéœ€è¦è¯´æ˜åœ¨å‰ $ i-1 $ è½®éƒ½æ²¡æœ‰é€‰åˆ° $ C $ ä¸­çš„è¾¹çš„æƒ…å†µä¸‹ï¼Œç¬¬ $ i $ è½®æ—¶å›¾ä¸­å‰©ä¸‹çš„è¾¹è¶³å¤Ÿå¤šã€‚è®¾æœ€å°å‰²çš„å¤§å°ä¸º $ k $ï¼Œæ³¨æ„åˆ°æ­¤æ—¶å›¾ä¸­æ¯ä¸ªç‚¹çš„åº¦æ•°éƒ½ä¸å°äº $ k $ï¼Œå¦åˆ™ç›´æ¥å–è¿™äº›è¾¹å°±èƒ½å¾—åˆ°ä¸€ä¸ªæ›´å°çš„å‰²ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨ç¬¬ $ i-1 $ è½®ç»“æŸï¼Œå‰©ä¸‹ $ n-i+1 $ ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå›¾ä¸­è‡³å°‘æœ‰ $ \\frac{k}{2}(n-i+1) $ æ¡è¾¹ï¼Œè¿™å°±å¯ä»¥å¾—åˆ° $$ \\mathbb{P}\\left( B_{i}\\bigg|\\bigcap_{j=1}^{i-1}B_{j} \\right) \\geq 1 - \\dfrac{k}{\\frac{k}{2}\\cdot(n-i+1)} = \\dfrac{n-i-1}{n-i+1} $$ å¸¦å…¥å³å¯å¾—åˆ° $$ \\begin{align*} p(G,t) \u0026 \\geq \\prod_{i=1}^{n-t} \\frac{n-i-1}{n-i+1} = \\dfrac{t(t-1)}{n(n-1)} \\\\ \u0026 = \\dfrac{\\left\\lceil \\frac{n}{\\sqrt{ 2 }} \\right\\rceil \\left\\lceil 1 + \\frac{n}{\\sqrt{ 2 }} \\right\\rceil }{n(n-1)} \\\\ \u0026 \\geq \\dfrac{\\left\\lceil n + \\sqrt{ 2 } \\right\\rceil }{2(n-1)} \u003e \\dfrac{1}{2} \\end{align*} $$ (2)\næˆ‘ä»¬å®šä¹‰äº‹ä»¶ $ A_{1},A_{2} $ åˆ†åˆ«è¡¨ç¤ºæŠŠå›¾ç¼©åˆ° $ G_{1},G_{2} $ åæ²¡æœ‰åˆ æ‰ $ C $ ä¸­çš„è¾¹ï¼Œäº‹ä»¶ $ B_{1},B_{2} $ åˆ†åˆ«è¡¨ç¤º KS ç®—æ³•ä»¥ $ G_{1},G_{2} $ ä¸ºè¾“å…¥ï¼Œæ­£ç¡®è¾“å‡ºäº†æœ€å°å‰²ã€‚\næ ¹æ®ç¬¬ä¸€é—®ï¼Œ$ \\mathbb{P}(A_{i})=p(G,t)\u003e \\frac{1}{2} $ã€‚æ ¹æ®é¢˜ç›®æ¡ä»¶ï¼Œ$ \\mathbb{P}(B_{i})=p(t)\u003e \\frac{c}{\\log t} $ã€‚ç”±äºäº‹ä»¶ $ A_{i},B_{i} $ ç‹¬ç«‹ï¼ˆä¸¤ä¸ªç®—æ³•äº’ä¸å¹²æ‰°ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å¯¹äºä¸€ä¸ªå›¾å…ˆæ‰§è¡Œ contract ç®—æ³•å†æ‰§è¡Œ KS ç®—æ³•èƒ½æ­£ç¡®è¾“å‡ºæœ€å°å‰²çš„æ¦‚ç‡ä¸º $$ \\mathbb{P}(A_{i}\\cap B_{i})=\\mathbb{P}(A_{i})\\cdot\\mathbb{P}(B_{i}) \u003e \\dfrac{1}{2}\\cdot \\dfrac{c}{\\log t} \\xlongequal{c' = c / 2} \\dfrac{c'}{\\log t} $$ ç”±äºæˆ‘ä»¬æœ€åé€‰æ‹©çš„æ˜¯è¾ƒå°çš„è¾¹é›†ï¼Œå› æ­¤ $ \\text{KS}(G_{1}),\\text{KS}(G_{2}) $ ä¸­åªè¦æœ‰ä¸€ä¸ªæ­£ç¡®è¾“å‡ºäº†æœ€å°å‰²ï¼Œæˆ‘ä»¬å°±å¯ä»¥æˆåŠŸæ‰¾åˆ°æœ€å°å‰²ï¼Œå› æ­¤æ­£ç¡®è¾“å‡ºæœ€å°å‰²çš„æ¦‚ç‡ä¸º $$ \\begin{align*} p_{\\text{success}} \u0026 = 1- (1-\\mathbb{P}(A_{1}\\cap B_{1}))(1-\\mathbb{P}(A_{2}\\cap B_{2})) \\\\ \u0026 \u003e 1-\\left( 1-\\dfrac{c'}{\\log t} \\right)^{2} \\\\ \u0026 = \\dfrac{2c'}{\\log t} - \\dfrac{(c')^{2}}{(\\log t)^{2}} \\end{align*} $$\nï¼ˆç»è¯¢é—® ai å…³äº $ \\Omega $ å®šä¹‰åä½œå‡ºï¼‰æ ¹æ® $ \\Omega $ è®°å·çš„å®šä¹‰ï¼Œ$ f(n)=\\Omega(g(n)) $ è¯´æ˜å­˜åœ¨æ­£å¸¸æ•° $ k $ å’Œ $ n_{0} $ ä½¿å¾—å½“ $ n\\geq n_{0} $ æ—¶ï¼Œ$ f(n)\\geq k\\cdot g(n) $ã€‚\nå¯¹äº $ p_{\\text{succsee}} $ï¼Œæˆ‘ä»¬æœ‰ï¼ˆåœ¨ $ n\u003e3 $ æ—¶æ˜¾ç„¶æœ‰ $ t\u003c n $ï¼‰ $$ p_{\\text{success}} \u003e \\dfrac{1}{\\log t}\\left( 2c' - \\dfrac{(c')^{2}}{\\log t} \\right) \u003e \\dfrac{1}{\\log n}\\left( 2c' - \\dfrac{(c')^{2}}{\\log t} \\right) $$\nå½“ $ n $ è¶³å¤Ÿå¤§æ—¶ï¼Œæˆ‘ä»¬æ˜¾ç„¶å¯ä»¥ä½¿å¾— $ \\log t\u003ec' $ï¼Œæ­¤æ—¶ $ 2c'-(c')^{2}/(\\log t)\u003ec' $ï¼Œäºæ˜¯ $$ p_{\\text{success}} \u003e \\dfrac{1}{\\log n}\\cdot c' $$ æ ¹æ®å®šä¹‰ï¼Œè¿™å°±è¯æ˜äº† $ p_{\\text{success}}=\\Omega\\left( \\frac{1}{\\log n} \\right) $ã€‚\n(3)\næ ¹æ® $ (2) $ çš„æç¤ºï¼Œæˆ‘ä»¬è€ƒè™‘é€’å½’è°ƒç”¨ contract ç®—æ³•ã€‚ä¸‹é¢ç»™å‡ºé€’å½’ç®—æ³• $ f $ çš„æè¿°ï¼š\nè¾“å…¥ï¼šæ— å‘å›¾ $ G $ï¼Œè§„æ¨¡ä¸º $ n $ã€‚ è‹¥ $ n\\leq n_{0} $ï¼ˆ$ n_{0} $ ä¸ºä¸€ä¸ªæ¯”è¾ƒå°çš„è¾¹ç•Œå€¼ï¼‰ï¼Œç›´æ¥æš´åŠ›æ±‚å‡ºæœ€å°å‰²ã€‚ å¦åˆ™ä»¤ $ t=\\lceil 1+n / \\sqrt{ 2 } \\rceil $ï¼Œç‹¬ç«‹åˆ†åˆ«æ‰§è¡Œä¸¤æ¬¡ contract ç®—æ³•ï¼š $ G_{1}\\leftarrow\\text{contract}(G,t) $ï¼› $ G_{2}\\leftarrow\\text{contract}(G,t) $ã€‚ åˆ†åˆ«å¯¹ $ G_{1},G_{2} $ æ‰§è¡Œé€’å½’ï¼Œè¿”å› $ \\min\\{ f(G_{1}),f(G_{2}) \\} $ã€‚ æˆ‘ä»¬è®¾ $ p(n) $ ä¸ºå•æ¬¡æ‰§è¡Œç®—æ³• $ f $ åœ¨è§„æ¨¡ä¸º $ n $ çš„å›¾ $ G $ ä¸Šèƒ½è¾¾åˆ°çš„æ­£ç¡®ç‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ‰ $$ p(n) \u003e 1-\\left( 1-\\dfrac{1}{2}p(t) \\right)^{2} = p(t) - \\dfrac{1}{4}p^{2}(t),\\quad t = \\left\\lceil 1+\\dfrac{n}{\\sqrt{ 2 }} \\right\\rceil $$ ç”±äºæˆ‘ä»¬åªç”¨è€ƒè™‘ $ n $ è¾ƒå¤§çš„æƒ…å½¢ï¼Œå› æ­¤å¯ä»¥è¿‘ä¼¼åœ°è®¤ä¸º $ t=\\frac{n}{\\sqrt{ 2 }} $ï¼Œäºæ˜¯ $$ p(n) \u003e p\\left( \\dfrac{n}{\\sqrt{ 2 }} \\right) - \\dfrac{1}{4}p^{2}\\left( \\dfrac{n}{\\sqrt{ 2 }} \\right) $$ ä¸ºäº†åˆ†æè¿™ä¸ªé€’æ¨å¼ï¼Œæˆ‘ä»¬è®¾é€’å½’å±‚æ•°ä¸º $ r=\\left\\lfloor \\log_{\\sqrt{ 2 }} \\frac{n}{n_{0}} \\right\\rfloor=\\Theta(\\log n) $ï¼Œå¦‚æœå½“å‰é€’å½’å±‚æ•°ä¸º $ r-k $ï¼Œä»¤æ¦‚ç‡ä¸º $ q_{k} $ï¼Œäºæ˜¯ $$ q_{k+1} \u003e q_{k} - \\dfrac{1}{4}q_{k}^{2} $$ å¯¹è¿™ä¸ªå¼å­è¿›ä¸€æ­¥åŒ–ç®€ $$ \\begin{align*} \\dfrac{1}{q_{k+1}} \u0026 \u003c \\dfrac{1}{q_{k}\\left( 1-\\frac{1}{4}q_{k} \\right)} \\\\ \u0026 = \\dfrac{1}{q_{k}}\\cdot \\dfrac{1}{1-\\frac{1}{4}q_{k}} \\\\ \u0026 \u003c \\dfrac{1}{q_{k}} \\left( 1 + \\dfrac{1}{4}q_{k} \\right) \\\\ \u0026 = \\dfrac{1}{q_{k}} + \\dfrac{1}{4} \\end{align*} $$ å› æ­¤ $$ \\dfrac{1}{q_{k}} \u003c \\dfrac{1}{q_{0}} + \\dfrac{k}{4} = 1 + \\dfrac{k}{4} \\implies q_{k} \u003e \\dfrac{1}{1 + k / 4} = \\Omega\\left( \\dfrac{1}{k} \\right) $$ ï¼ˆå®é™…ä¸Šæˆ‘ä»¬å¹¶ä¸æ˜¯ä» $ q_{0} $ å¼€å§‹è¿­ä»£ï¼Œä¸è¿‡è¿™å¹¶ä¸å½±å“æˆ‘ä»¬è®¡ç®—ä¸‹ç•Œï¼Œä¸ºäº†è®¡ç®—æ–¹ä¾¿ï¼Œç›´æ¥ä» $ q_{0} $ å¼€å§‹è®¡ç®—ï¼Œå¹¶ä¸”è®¤ä¸º $ q_{0}=1 $ï¼‰\nå›åˆ° $ p(n) $ï¼Œæˆ‘ä»¬è¿™å°±æ¨å‡ºäº† $$ p(n) \u003e \\dfrac{4}{r+4} \\implies p(n) = \\Omega\\left( \\dfrac{1}{\\log n} \\right) $$ æ‰€ä»¥é‡å¤ç®—æ³• $ O(\\log n) $ æ¬¡å¯ä»¥ä»¥æ¯”è¾ƒé«˜çš„æ¦‚ç‡å¾—åˆ°æ­£ç¡®ç­”æ¡ˆã€‚ä¸‹é¢æˆ‘ä»¬è¯æ˜è¿™ä¸ªæ¦‚ç‡å¤§äº $ \\dfrac{2}{3} $ã€‚\nè®¾é‡å¤ç®—æ³• $ \\lceil \\log_{2} n \\rceil $ æ¬¡ï¼Œèƒ½å¾—åˆ°æœ€å°å‰²çš„æ¦‚ç‡ä¸º $ p_{\\text{success}} $ï¼Œé‚£ä¹ˆ $$ p_{\\text{success}} = 1 - (1 - p(n))^{\\lceil \\log_{2} n \\rceil } \u003e 1 - e^{ -p(n) \\cdot \\lceil \\log_{2} n \\rceil } $$\nç”±äºé€’å½’å±‚æ•° $ r=\\left\\lfloor 2\\log_{2} \\dfrac{n}{n_{0}} \\right\\rfloor $ï¼Œå¯¹äºè¶³å¤Ÿå¤§çš„ $ n $ï¼Œæˆ‘ä»¬å¯ä»¥å¿½ç•¥å°å¸¸æ•° $ n_{0} $ï¼Œå› æ­¤ $ r\\approx 2\\log_{2}n $ã€‚äºæ˜¯ $$ p(n) \u003e \\dfrac{4}{r+4} \\approx \\dfrac{2}{\\log_{2}n + 2} $$ å¸¦å…¥å¾—åˆ° $$ p_{\\text{success}} \u003e 1 - e^{ - \\frac{2\\log_{2} n}{\\log_{2}n + 2} } $$\næˆ‘ä»¬è¦è¯æ˜ $ p_{\\text{success}}\u003e\\frac{2}{3} $ï¼Œåªéœ€è¦è¯æ˜ $ \\exp\\left( - \\frac{2\\log_{2}n}{\\log_{2}n + 2} \\right) \u003c \\frac{1}{3} $ï¼Œå³ $$ \\dfrac{2\\log_{2}n}{\\log_{2}n + 2} \u003e \\ln 3 \\approx 1.1 $$ å¯¹äºæ¯”è¾ƒå¤§çš„ $ n $ï¼Œè¿™æ˜¯æ˜¾ç„¶æˆç«‹çš„ã€‚å› æ­¤æˆ‘ä»¬é‡å¤ $ \\lceil \\log_{2}n \\rceil $ æ¬¡è¿™ä¸ªç®—æ³•èƒ½å¾—åˆ°æ­£ç¡®ç­”æ¡ˆçš„æ¦‚ç‡å¤§äº $ \\dfrac{2}{3} $ã€‚\næ¥ç€æ±‚å‡ºè¿™ä¸ªç®—æ³•çš„å¤æ‚åº¦ã€‚è®¾ $ T(n) $ è¡¨ç¤ºè§„æ¨¡ä¸º $ n $ çš„å›¾éœ€è¦çš„è¿ç®—æ¬¡æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å¾—åˆ°é€’æ¨å¼ $$ T(n) = 2T\\left( \\dfrac{n}{\\sqrt{ 2 }} \\right) + O(m) $$ å¦‚æœ $ m=\\Theta(n^{2}) $ï¼Œæ˜¯ç¨ å¯†å›¾ï¼Œé‚£ä¹ˆæ ¹æ®ä¸»å®šç†ï¼Œ$ T(n)=\\Theta(n^{2}\\log n) $ã€‚\nå¦‚æœä¸ºç¨€ç–å›¾ï¼Œé€’å½’é¡¹çš„æ˜¯ä¸»å¯¼ï¼Œå¤æ‚åº¦ä¸º $ T(n)=\\Theta(n^{2}) $ã€‚\nç»¼ä¸Šï¼Œç®—æ³•å¤æ‚åº¦ä¸º $ O(n^{2}\\log ^{2}n)=\\tilde{O}(n^{2}) $ã€‚ä¼˜äºåŸæ¥çš„ç®—æ³•ã€‚\n","permalink":"https://diefish1024.github.io/posts/class-notes/math2701-probability-theory/math2701-hw1/","summary":"\u003cp\u003e\u003ca href=\"https://notes.sjtu.edu.cn/s/gHhl2fhcm\"\u003eé¢˜ç›®\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"problem-11\"\u003eProblem 1.1\u003c/h2\u003e\n\u003cp\u003eè®¾ $ \\mathcal{F} $ æ˜¯ä¸€ä¸ªæœ‰é™çš„ $ \\sigma $-ä»£æ•°ã€‚å®šä¹‰å…¶ä¸­â€œæœ€å°\u0026quot;çš„å…ƒç´ ä¸ºå…¶åŒ…å«äº $ \\mathcal{F} $ ä¸­çš„å­é›†ä»…ä¸ºè‡ªèº«å’Œç©ºé›†ï¼Œå½¢å¼åŒ–åœ°æè¿°ï¼Œè‹¥ $ A\\in \\mathcal{F} $ ä¸ºâ€œæœ€å°â€çš„å…ƒç´ ï¼Œé‚£ä¹ˆå¦‚æœ $ B\\in \\mathcal{F} $ å¹¶ä¸” $ B\\subseteq A $ï¼Œé‚£ä¹ˆä¸€å®šæœ‰ $ B\\in \\{ \\emptyset,A \\} $ã€‚\u003c/p\u003e\n\u003cp\u003eå¯ä»¥è¯æ˜è¿™æ ·çš„å…ƒç´ å­˜åœ¨å¹¶ä¸”æœ‰é™ï¼šå¦‚æœä¸å­˜åœ¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¯æ¬¡ä»»å–ä¸€ä¸ª $ \\mathcal{F} $ ä¸­çš„å…ƒç´ ï¼Œéƒ½èƒ½æ‰¾åˆ°å±äºå®ƒçš„ä¸€ä¸ªæ›´å°çš„å…ƒç´ ï¼Œä½† $ \\mathcal{F} $ æ˜¯æœ‰é™é›†ï¼Œæ‰€ä»¥è¿™æ ·çš„è¿‡ç¨‹ä¸å¯èƒ½ä¸€ç›´é‡å¤ä¸‹å»ï¼Œå› æ­¤â€œæœ€å°â€å…ƒç´ å¿…ç„¶å­˜åœ¨å¹¶ä¸”æœ‰é™ã€‚\u003c/p\u003e\n\u003cp\u003eæˆ‘ä»¬è®¾æ‰€æœ‰è¿™äº›ä¸åŒçš„â€œæœ€å°â€å…ƒç´ ä¸º $ S=\\{ A_{1},A_{2},\\dots,A_{n} \\} $ã€‚æˆ‘ä»¬å…ˆè¯æ˜è¿™æ„æˆäº†å…¨ç©ºé—´çš„ä¸€ä¸ªåˆ†åˆ’ï¼š\u003c/p\u003e\n\u003cp\u003eé¦–å…ˆè¿™äº›å…ƒç´ è‚¯å®šä¸¤ä¸¤ä¸ç›¸äº¤ï¼Œå¦åˆ™ä¸æ»¡è¶³â€œæœ€å°â€çš„å®šä¹‰ã€‚å‡è®¾ $ A_{i}\\cap A_{j}= C\\neq\\emptyset $ï¼Œæ ¹æ®â€œæœ€å°â€ï¼Œéç©ºçš„ $ C $ æ˜¯ $ A_{i} $ çš„å­é›†ï¼Œä¸€å®šæœ‰ $ C=A_{i} $ï¼ŒåŒæ ·ä¹Ÿæœ‰ $ C=A_{j} $ï¼Œè¿™å°±æ¨å‡ºäº† $ A_{i}=A_{j} $ï¼Œä»è€ŒçŸ›ç›¾ã€‚\u003c/p\u003e","title":"MATH2701 HW1"},{"content":"Exercise 1 (Multiplication of block matrices). Consider two block matrices $$ A = \\begin{pmatrix} A_{11} \u0026 \\cdots \u0026 A_{1t} \\\\ \\vdots \u0026 \\ddots \u0026 \\vdots \\\\ A_{p1} \u0026 \\cdots \u0026 A_{pt} \\end{pmatrix} \\quad \\text{and} \\quad B = \\begin{pmatrix} B_{11} \u0026 \\cdots \u0026 B_{1q} \\\\ \\vdots \u0026 \\ddots \u0026 \\vdots \\\\ B_{t1} \u0026 \\cdots \u0026 B_{tq} \\end{pmatrix} $$ Moreover, for every $ i \\in [p] $, $ j \\in [t] $, and $ l \\in [q] $ the number of columns of $ A_{ij} $ is equal to the number of rows of $ B_{jl} $. In particular, $ A_{ij} \\cdot B_{jl} $ is defined. Prove that $$ A \\cdot B = \\begin{pmatrix} C_{11} \u0026 \\cdots \u0026 C_{1q} \\\\ \\vdots \u0026 \\ddots \u0026 \\vdots \\\\ C_{p1} \u0026 \\cdots \u0026 C_{pq} \\end{pmatrix} $$ with $$ C_{il} = \\sum_{j \\in [t]} A_{ij} B_{jl} $$ for any $ i \\in [p] $ and $ l \\in [q] $.\nProof:\nLet $ A = (a_{\\alpha\\beta}) $ and $ B = (b_{\\beta\\gamma}) $. The entry $ (AB)_{\\alpha\\gamma} $ is given by $ (AB)_{\\alpha\\gamma} = \\sum_{\\beta} a_{\\alpha\\beta} b_{\\beta\\gamma} $.\nConsider a specific entry $ (C_{il})_{uv} $ within the block $ C_{il} $ of the product matrix $ AB $. This entry corresponds to a global row index $ \\alpha $ in $ A $\u0026rsquo;s $ i $-th block row (specifically, the $ u $-th row within that block row) and a global column index $ \\gamma $ in $ B $\u0026rsquo;s $ l $-th block column (specifically, the $ v $-th column within that block column).\nThe summation over $ \\beta $ can be partitioned according to the column blocks of $ A $ and the row blocks of $ B $ that correspond to the intermediate index $ j $. Specifically, the range of $ \\beta $ for which $ a_{\\alpha\\beta} $ belongs to $ A_{ij} $ and $ b_{\\beta\\gamma} $ belongs to $ B_{jl} $ forms a segment. Summing these segments yields: $$ (C_{il})_{uv} = \\sum_{\\beta} a_{\\alpha\\beta} b_{\\beta\\gamma} = \\sum_{j=1}^{t} \\left( \\sum_{\\substack{\\beta_j \\in \\text{columns of } A_{ij} \\\\ \\text{and rows of } B_{jl}}} (A_{ij})_{u\\beta_j} (B_{jl})_{\\beta_j v} \\right) $$ The inner sum $ \\sum_{\\beta_j} (A_{ij})_{u\\beta_j} (B_{jl})_{\\beta_j v} $ precisely represents the $ (u,v) $-th entry of the product matrix $ A_{ij} B_{jl} $.\nTherefore, we can write: $$ (C_{il})_{uv} = \\sum_{j=1}^{t} (A_{ij} B_{jl})_{uv} $$ Since this equality holds for every entry $ (u,v) $ in the block $ C_{il} $, it follows that the block matrix equation is true: $$ C_{il} = \\sum_{j \\in [t]} A_{ij} B_{jl} $$\nExercise 2 Let $ P $ be a permutation matrix and consider its column vectors $ p_1, \\ldots, p_n $. (i) Prove that each pair of distinct (i.e., $ i \\neq j $) $ p_i $ and $ p_j $ are perpendicular. (ii) Prove each $ p_i $ is a unit vector. (iii) Using (i) and (ii) prove that $ P^{-1} = P^T $.\n(i)\nFor distinct columns $ p_i $ and $ p_j $ (where $ i \\neq j $), each vector has a single \u0026lsquo;1\u0026rsquo; at different positions.\nWhen computing their dot product $ p_i^T p_j = \\sum_k (p_i)_k (p_j)_k $, for any given $ k $, at least one of $ (p_i)_k $ or $ (p_j)_k $ must be \u0026lsquo;0\u0026rsquo; because their \u0026lsquo;1\u0026rsquo;s are in different rows. Thus, $ (p_i)_k (p_j)_k = 0 $ for all $ k $, which implies $ p_i^T p_j = 0 $. Therefore, $ p_{i} $ and $ p_j $ are perpendicular for $ i \\neq j $.\n(ii)\nA column vector $ p_i $ has exactly one \u0026lsquo;1\u0026rsquo; and all other entries are \u0026lsquo;0\u0026rsquo;, its norm is $ p_i^T p_i = \\sum_k (p_i)_k^2 = 1 $. Therefore, $ \\|p_i\\| = 1 $, proving $ p_i $ is a unit vector.\n(iii)\nConsider the entry $ (P^T P)_{ij} $ of the product $ P^T P $. This entry is the dot product of the $ i $-th column of $ P $ with its $ j $-th column: $ (P^T P)_{ij} = p_i^T p_j $.\nFrom part (i), if $ i \\neq j $, then $ p_i^T p_j = 0 $. From part (ii), if $ i = j $, then $ p_i^T p_i = 1 $. Thus $ P^T P = I $, therefore, $ P^{-1} = P^T $.\nExercise 3 Let $ A = [a_1, \\ldots, a_n] $ be an $ n \\times n $ matrix such that $ A^{-1} = A^T $. Prove: (i) Each pair of distinct column vectors $ a_i $ and $ a_j $ are perpendicular. (ii) Each $ a_i $ is a unit vector. Prove that the same is true for the row vectors of $ A $.\n(i) \u0026amp; (ii) Proof for Column Vectors\nGiven $ A^{-1} = A^T $, it follows that $ A^T A = I $.\nThe entry $ (A^T A)_{kl} $ is the dot product of the $ k $-th column of $ A $ ($ a_k $) and the $ l $-th column of $ A $ ($ a_l $), i.e., $ (A^T A)_{kl} = a_k^T a_l $.\nSince $ A^T A = I $, we have:\nFor $ k \\neq l $: $ a_k^T a_l = 0 $. This proves that distinct column vectors $ a_k $ and $ a_l $ are perpendicular. For $ k = l $: $ a_k^T a_k = 1 $. This proves that $ \\|a_k\\|^2 = 1 $, so each column vector $ a_k $ is a unit vector. Proof for Row Vectors\nLet $ A $ have row vectors $ r_1, \\ldots, r_n $. From $ A^{-1} = A^T $, it also follows that $ A A^T = I $.\nThe entry $ (A A^T)_{kl} $ is the dot product of the $ k $-th row of $ A $ ($ r_k $) and the $ l $-th row of $ A $ ($ r_l $), i.e., $ (A A^T)_{kl} = r_k r_l^T $.\nSince $ A A^T = I $, we have:\nFor $ k \\neq l $: $ r_k r_l^T = 0 $. This proves that distinct row vectors $ r_k $ and $ r_l $ are perpendicular. For $ k = l $: $ r_k r_k^T = 1 $. This proves that $ \\|r_k\\|^2 = 1 $, so each row vector $ r_k $ is a unit vector. Exercise 4 Let $ A $ be a square matrix such that there are $ B $ and $ C $ with $ BA = AC = I $. Note we didn\u0026rsquo;t assume per se $ B = C $. However, prove that $ B = C $. In particular $ A $ is invertible with $ A^{-1} = B = C $.\nProof: $$ \\begin{align*} BA \u0026 = I \\\\ (BA)C \u0026 = IC = C \\\\ B(AC)\u0026 = C \\\\ BI = B \u0026 = C \\end{align*} $$ Thus, $ B $ and $ C $ must be equal. This proves that if both a left inverse and a right inverse exist for a square matrix $ A $, they are unique and identical, defining the inverse $ A^{-1} = B = C $.\nExercise 5 This is intended to repeat what we have learnt in the class. Prove in a vector space: (i) $ 0v = 0 $. (ii) $ (-1)v = -v $. (iii) $ -(v + w) = (-v) + (-w) $. (iv) $ c0 = 0 $. (v) $ c(-v) = (-c)v = -(cv) $.\n(i) $$ 0v = (0+0)v = 2\\cdot0v \\implies 0v = 0 $$ (ii) $$ v + (-1)v = (1 + (-1))v = 0v =0 \\implies (-1)v = -v $$ (iii) $$ (v+w) + ((-v) + (-w)) = (v + (-v)) + (w + (-w)) = 0 \\implies (-v+w) = (-v) + (-w) $$ (iv) $$ c\\cdot \\vec{0} = c\\cdot(\\vec{0} + \\vec{0}) = 2(c \\cdot \\vec{0}) \\implies c\\cdot \\vec{0} = 0 $$ (v) $$ c(-v) = c((-1)v) = (c \\cdot (-1))v = (-c)v $$ $$ cv + (-c)v = (c + (-c))v = 0v = 0 \\implies (-c)v = -(cv) $$\nCombining these, we have $ c(-v) = (-c)v = -(cv) $.\n","permalink":"https://diefish1024.github.io/posts/class-notes/math1205h-linear-algebra/math1205h-hw3/","summary":"\u003ch2 id=\"exercise-1\"\u003eExercise 1\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003e(Multiplication of block matrices). Consider two block matrices\n$$ \n\n A = \\begin{pmatrix}\n A_{11} \u0026 \\cdots \u0026 A_{1t} \\\\\n \\vdots \u0026 \\ddots \u0026 \\vdots \\\\\n A_{p1} \u0026 \\cdots \u0026 A_{pt}\n \\end{pmatrix}\n \\quad \\text{and} \\quad\n B = \\begin{pmatrix}\n B_{11} \u0026 \\cdots \u0026 B_{1q} \\\\\n \\vdots \u0026 \\ddots \u0026 \\vdots \\\\\n B_{t1} \u0026 \\cdots \u0026 B_{tq}\n \\end{pmatrix}\n \n $$\nMoreover, for every $ i \\in [p] $, $ j \\in [t] $, and $ l \\in [q] $ the number of columns of $ A_{ij} $ is equal to the number of rows of $ B_{jl} $. In particular, $ A_{ij} \\cdot B_{jl} $ is defined. Prove that\n$$ \n\n A \\cdot B = \\begin{pmatrix}\n C_{11} \u0026 \\cdots \u0026 C_{1q} \\\\\n \\vdots \u0026 \\ddots \u0026 \\vdots \\\\\n C_{p1} \u0026 \\cdots \u0026 C_{pq}\n \\end{pmatrix}\n \n $$\nwith\n$$ \n\n C_{il} = \\sum_{j \\in [t]} A_{ij} B_{jl}\n \n $$\nfor any $ i \\in [p] $ and $ l \\in [q] $.\u003c/p\u003e","title":"MATH1205H HW3"},{"content":"Exercise 1 What rows or columns or matrices do you multiply to find\nthe second column of $ AB $ ? the first row of $ AB $ ? the entry in row $ 3 $, column $ 5 $ of $ AB $ ? the entry in row $ 1 $, column $ 1 $ of $ CDE $ ? To find the second column of $ AB $, we multiply matrix $ A $ by the second column of matrix $ B $.\nMultiply the first row of $ A $ by matrix $ B $.\nMultiply the third row of $ A $ and the fifth column of $ B $.\nMultiply first the first row of $ C $ by $ D $, then product the first column of $ E $.\nExercise 2 Show that $ (A + B)^2 $ is different from $ A^2 + 2AB + B^2 $, when $ A=\\begin{pmatrix} 1 \u0026 2 \\\\ 0 \u0026 0 \\end{pmatrix} $ and $ B=\\begin{pmatrix} 1 \u0026 0 \\\\ 3 \u0026 0 \\end{pmatrix} $.\nWrite down the correct rule for $ (A + B)(A + B) = A^2 + \\_\\_\\_\\_\\_\\_\\_\\_ + B^2 $.\nFirst, we find the sum of matrices $ A $ and $ B $ : $$ A+B = \\begin{pmatrix} 1 \u0026 2 \\\\ 0 \u0026 0 \\end{pmatrix} + \\begin{pmatrix} 1 \u0026 0 \\\\ 3 \u0026 0 \\end{pmatrix} = \\begin{pmatrix} 1+1 \u0026 2+0 \\\\ 0+3 \u0026 0+0 \\end{pmatrix} = \\begin{pmatrix} 2 \u0026 2 \\\\ 3 \u0026 0 \\end{pmatrix} $$ Next, we compute the square of $ (A+B) $ : $$ (A+B)^2 = \\begin{pmatrix} 2 \u0026 2 \\\\ 3 \u0026 0 \\end{pmatrix} \\begin{pmatrix} 2 \u0026 2 \\\\ 3 \u0026 0 \\end{pmatrix} = \\begin{pmatrix} 10 \u0026 4 \\\\ 6 \u0026 6 \\end{pmatrix} $$ Then we need to compute $ A^2 $, $ B^2 $, and $ 2AB $ separately.\n$$ A^2 = \\begin{pmatrix} 1 \u0026 2 \\\\ 0 \u0026 0 \\end{pmatrix} \\begin{pmatrix} 1 \u0026 2 \\\\ 0 \u0026 0 \\end{pmatrix} = \\begin{pmatrix} 1 \u0026 2 \\\\ 0 \u0026 0 \\end{pmatrix}, B^2 = \\begin{pmatrix} 1 \u0026 0 \\\\ 3 \u0026 0 \\end{pmatrix} \\begin{pmatrix} 1 \u0026 0 \\\\ 3 \u0026 0 \\end{pmatrix} = \\begin{pmatrix} 1 \u0026 0 \\\\ 3 \u0026 0 \\end{pmatrix} $$ $$ AB = \\begin{pmatrix} 1 \u0026 2 \\\\ 0 \u0026 0 \\end{pmatrix} \\begin{pmatrix} 1 \u0026 0 \\\\ 3 \u0026 0 \\end{pmatrix} = \\begin{pmatrix} 7 \u0026 0 \\\\ 0 \u0026 0 \\end{pmatrix} $$ Thus, we can calculate the result $$ A^2 + 2AB + B^2 = \\begin{pmatrix} 1 \u0026 2 \\\\ 0 \u0026 0 \\end{pmatrix} + \\begin{pmatrix} 14 \u0026 0 \\\\ 0 \u0026 0 \\end{pmatrix} + \\begin{pmatrix} 1 \u0026 0 \\\\ 3 \u0026 0 \\end{pmatrix} = \\begin{pmatrix} 16 \u0026 2 \\\\ 3 \u0026 0 \\end{pmatrix} $$ We found: $ (A+B)^2 = \\begin{pmatrix} 10 \u0026 4 \\\\ 6 \u0026 6 \\end{pmatrix} ,A^2 + 2AB + B^2 = \\begin{pmatrix} 16 \u0026 2 \\\\ 3 \u0026 0 \\end{pmatrix} $.\nSince $ \\begin{pmatrix} 10 \u0026 4 \\\\ 6 \u0026 6 \\end{pmatrix} \\neq \\begin{pmatrix} 16 \u0026 2 \\\\ 3 \u0026 0 \\end{pmatrix} $, we have shown that $ (A + B)^2 $ is different from $ A^2 + 2AB + B^2 $ for the given matrices. This difference arises because matrix multiplication is generally not commutative ($ AB \\neq BA $).\nThe correct rule for expanding $ (A+B)(A+B) $ for matrices $ A $ and $ B $ is: $ (A + B)(A + B) = A^2 + \\underline{AB+BA} + B^2 $.\nExercise 3 If you do a row operation on $ A $ and then a column operation, the result is the same as if you did the column operation first. Why is this true?\nProof:\nPerforming a row operation on a matrix $ A $ is equivalent to multiplying $ A $ on its left by a corresponding elementary matrix, let\u0026rsquo;s call it $ E_R $. So, the operation results in $ E_R A $. Then, perform the column operation on the result $ E_R A $. This means multiplying $ E_R A $ on the right by $ E_C $, giving the final result $ (E_R A) E_C $.\nPerforming a column operation on a matrix $ A $ is equivalent to multiplying $ A $ on its right by a corresponding elementary matrix, let\u0026rsquo;s call it $ E_C $. So, the operation results in $ A E_C $. Then, perform the row operation on the result $ A E_C $. This means multiplying $ A E_C $ on the left by $ E_R $, giving the final result $ E_R (A E_C) $.\nAccording to the associativity of matrix multiplication, we have $ (E_R A) E_C = E_R (A E_C) $. Therefore, the final matrix result is the same regardless of the order in which the row and column operations are performed.\nExercise 4 Let $ A=\\begin{pmatrix} 2 \u0026 3 \\\\ 1 \u0026 2 \\\\ 7 \u0026 100 \\end{pmatrix} $. Prove that there is no $ 2 \\times 3 $ matrix $ B $ such that $ AB = I $.\n(Please only use the materials we have learnt so far, in particular the geometric interpretation of $ Ab $ is a linear combination of the column vectors of $ A $).\nProof:\nFirstly, if $ AB=I $, $ I $ must be the $ 3 \\times 3 $ identity matrix ($ I_3 $).\nConsidering the column space of matrix $ A $, which has two column vectors: $ A_1 = \\begin{pmatrix} 2 \\\\ 1 \\\\ 7 \\end{pmatrix} $ and $ A_2 = \\begin{pmatrix} 3 \\\\ 2 \\\\ 100 \\end{pmatrix} $. These two vectors are linearly independent, so the column space $ Col(A) $ is a two-dimensional subspace of $ \\mathbb{R}^3 $ (a plane through the origin).\nIf $ AB=I_3 $, then each column of $ I_3 $ must be in the column space of $ A $. That is, for each standard basis vector $ e_j $ (the columns of $ I_3 $), there must exist a column vector $ b_j $ from $ B $ such that $ A b_j = e_j $. This means $ e_j $ must be a linear combination of $ A $\u0026rsquo;s column vectors, and thus $ e_j \\in Col(A) $.\nThe columns of $ I_3 $ are $ e_1=\\begin{pmatrix} 1 \\\\ 0 \\\\ 0 \\end{pmatrix} $, $ e_2=\\begin{pmatrix} 0 \\\\ 1 \\\\ 0 \\end{pmatrix} $, and $ e_3=\\begin{pmatrix} 0 \\\\ 0 \\\\ 1 \\end{pmatrix} $. These three vectors are linearly independent and span the entire $ \\mathbb{R}^3 $. However, $ Col(A) $ is only a two-dimensional subspace. A two-dimensional subspace cannot contain three linearly independent vectors that span a three-dimensional space.\nTherefore, there is no $ 2 \\times 3 $ matrix $ B $ such that $ AB=I $.\nExercise 5 Let $ m, n \\ge 1 $ and $ A, B $ two $ m \\times n $ matrices. Prove that if for all $ x \\in \\mathbb{R}^n $ we have $ Ax = Bx $, then $ A = B $.\nProof:\nWe are given $ Ax = Bx $ for all $ x \\in \\mathbb{R}^n $. This can be rewritten as $ (A-B)x = 0 $ for all $ x \\in \\mathbb{R}^n $. Let . Then the condition becomes for all .\nConsider the standard basis vectors $ e_1, e_2, \\ldots, e_n $ in $ \\mathbb{R}^n $. Since $ Cx=0 $ for all $ x $, it must hold for each $ e_j $. Therefore, implies that every column of is the zero vector.\nIf all columns of matrix $ C $ are the zero vector, then $ C $ must be the zero matrix. Since $ C=A-B $, we have $ A-B=0 $, which implies $ A=B $.\n","permalink":"https://diefish1024.github.io/posts/class-notes/math1205h-linear-algebra/math1205h-hw2/","summary":"\u003ch2 id=\"exercise-1\"\u003eExercise 1\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003eWhat rows or columns or matrices do you multiply to find\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003ethe second column of $ AB $ ?\u003c/li\u003e\n\u003cli\u003ethe first row of $ AB $ ?\u003c/li\u003e\n\u003cli\u003ethe entry in row $ 3 $, column $ 5 $ of $ AB $ ?\u003c/li\u003e\n\u003cli\u003ethe entry in row $ 1 $, column $ 1 $ of $ CDE $ ?\u003c/li\u003e\n\u003c/ol\u003e\u003c/blockquote\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eTo find the second column of $ AB $, we multiply matrix $ A $ by the second column of matrix $ B $.\u003c/p\u003e","title":"MATH1205H HW2"},{"content":"Problem 1 ç”¨ç”Ÿæˆå‡½æ•°æ±‚è§£é€’æ¨å¼ $$ a_{n} = 4a_{n-1} - 5a_{n-2} + 2a_{n-3} $$ åˆå§‹å€¼ä¸º $ a_{0}=0,a_{1}=3,a_{2}=7 $ã€‚\nè§£ï¼š\nè®¾æ•°åˆ— $ \\{ a_{n} \\} $ çš„ç”Ÿæˆå‡½æ•°ä¸º $ F(x) $ï¼Œé‚£ä¹ˆæ ¹æ®é€’æ¨å¼å’Œåˆå€¼ $ a_{0}=0,a_{1}=3,a_{2}=7 $ å¾—åˆ° $$ F(x) = 4xF(x) - 5x^{2}F(x) + 2x^{3}F(x) + 3x - 5x^{2} $$ å¾—åˆ° $$ F(x) = \\dfrac{5x^{2}-3x}{2x^{3}-5x^{2}+4x-1} = \\dfrac{3x-5x^{2}}{(1-x)^{2}(1-2x)} $$ æˆ‘ä»¬å¸Œæœ›åˆ†è§£æˆ $$ \\dfrac{A}{1-x} + \\dfrac{B}{(1-x)^{2}} + \\dfrac{C}{1-2x} $$ å¾…å®šç³»æ•°å¯ä»¥è§£å¾— $$ F(x) = \\dfrac{-3}{1-x} + \\dfrac{2}{(1-x)^{2}} + \\dfrac{1}{1-2x} $$ å±•å¼€å¾—åˆ° $$ F(x) = \\sum_{n=0}^{\\infty} (-3+2(n+1)+2^{n})x^{n} $$ å› æ­¤ $$ a_{n} = -3+2(n+1)+2^{n} = 2^{n} + 2n - 1 $$\nProblem 2 (1)\nè®¾ $ f(n) $ ä¸ºé›†åˆ $ [n] $ ä¸­ä¸åŒ…å«ä¸¤ä¸ªè¿ç»­æ•°å­—çš„å­é›†æ•°é‡ï¼Œæ±‚ $ f(n) $ çš„é€’æ¨å…³ç³»ã€‚\nè§£ï¼š\nå®¹æ˜“å¾—åˆ° $ f(0)=1,f(1)=2,f(2)=3,f(3)=\\dots $ã€‚è€ƒè™‘é›†åˆ $ [n]=\\{ 1,2,\\dots,n \\} $ï¼Œå¦‚æœé€‰æ‹©çš„å­é›†ä¸­åŒ…å« $ n $ï¼Œé‚£ä¹ˆä¸€å®šä¸åŒ…å« $ n-1 $ï¼Œç­‰ä»·äºä» $ [n-2] $ ä¸­é€‰æ‹©ï¼›å¦‚æœä¸åŒ…å« $ n $ï¼Œé‚£ä¹ˆç­‰ä»·äºä» $ [n-1] $ ä¸­é€‰æ‹©ï¼Œå› æ­¤ $ f(n)=f(n-1)+f(n-2) $ã€‚è¿™æ ·å°±æ‰¾å‡ºäº† $ f(n) $ çš„é€’æ¨å…³ç³»ï¼Œè¿›ä¸€æ­¥åŒç†æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œæˆ‘ä»¬è€ƒè™‘æ±‚å‡ºé€šé¡¹ã€‚\nè®¾ç”Ÿæˆå‡½æ•° $ F(x)=\\sum_{n=0}^{\\infty}f(n)x^{n} $ï¼Œæ»¡è¶³ $ F(x)=xF(x-1)+x^{2}F(x-2)+1+x $ï¼Œè§£å‡º $$ F(x) = \\dfrac{1+x}{1-x-x^{2}} \\xlongequal{\\phi= \\frac{1+\\sqrt{ 5 }}{2},\\psi= \\frac{1-\\sqrt{ 5 }}{2}} \\dfrac{\\phi^{2} / \\sqrt{ 5 }}{1 - \\phi x} - \\dfrac{\\psi^{2} / \\sqrt{ 5 }}{1 - \\psi x} $$ å±•å¼€å¾—åˆ° $$ F(x) = \\sum_{n=0}^{\\infty} \\left( \\dfrac{\\phi^{n+2}- \\psi^{n+2}}{\\sqrt{ 5 }} \\right)x^{n} $$ äºæ˜¯ $$ f(n) = \\dfrac{\\phi^{n+2} - \\psi^{n+2}}{\\sqrt{ 5 }} = \\dfrac{1}{\\sqrt{ 5 }}\\left( \\left( \\dfrac{1+\\sqrt{ 5 }}{2} \\right)^{n+2} - \\left( \\dfrac{1-\\sqrt{ 5 }}{2} \\right)^{n+2} \\right) $$\n(2)\nè®¾ $ f(n,k) $ ä¸ºé›†åˆ $ [n] $ ä¸­ä¸åŒ…å«ä¸¤ä¸ªè¿ç»­æ•°å­—çš„ $ k $-å­é›†ï¼ˆå¤§å°ä¸º $ k $ çš„å­é›†ï¼‰çš„æ•°é‡ã€‚æ±‚ $ f(n,k) $ çš„é€’æ¨å…³ç³»ï¼Œæ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„ç”Ÿæˆå‡½æ•°ï¼Œå¹¶æ±‚å‡ºè¿™äº›æ•°æœ¬èº«ã€‚\nè§£ï¼š\nåŒç†å…ˆè€ƒè™‘ $ f(n,k) $ çš„é€’æ¨å…³ç³»ã€‚ä» $ [n] $ ä¸­é€‰å‡ºä¸åŒ…å«è¿ç»­æ•°å­—çš„å¤§å°ä¸º $ k $ çš„å­é›†ï¼Œå¦‚æœé€‰å‡ºçš„å­é›†åŒ…å« $ n $ï¼Œé‚£ä¹ˆå¯ä»¥çœ‹æˆä» $ [n-2] $ ä¸­é€‰å–æœ‰ $ k-1 $ ä¸ªå…ƒç´ çš„å­é›†ï¼Œå¦åˆ™çœ‹æˆä» $ [n-1] $ ä¸­é€‰å‡º $ k $ ä¸ªå…ƒç´ ï¼Œå¾—åˆ°é€’æ¨å¼ $$ f(n,k)=f(n-2,k-1) + f(n-1,k) $$ è¾¹ç•Œæ¡ä»¶æœ‰ $ f(n,0)=1,f(n,k\u003c 0)=f(n,k\u003en)=0,f(1,1)=1 $ã€‚\näºæ˜¯æˆ‘ä»¬å®šä¹‰ $$ F_{k}(x) = \\sum_{n=0}^{\\infty} f(n,k)x^{n} $$ å¯¹äº $ k=0 $ï¼Œ $$ F_{0}(x) = \\sum_{n=0}^{\\infty} x^{n} = \\dfrac{1}{1-x} $$ $ k=1 $ æ—¶ $$ F_{1}(x) = \\sum_{n=0}^{\\infty} nx^{n} = \\dfrac{x}{(1-x)^{2}} $$ $ k\u003e 1 $ æ—¶è¾¹ç•Œæ¡ä»¶ä¸ä¼šå½±å“é€’æ¨ $$ F_{k}(x) = \\sum_{n=k}^{\\infty} f(n,k)x^{n} = \\sum_{n=k}^{\\infty} f(n-1,k)x^{n} + \\sum_{n=k}^{\\infty} f(n-2,k-1)x^{n} = xF_{k}(x) + x^{2}F_{k-1}(x) $$ äºæ˜¯ $$ F_{k}(x) = \\dfrac{x^{2}}{1-x}F_{k-1}(x) = \\left( \\dfrac{x^{2}}{1-x} \\right)^{k-1}F_{1}(x) = \\dfrac{x^{2k-1}}{(1-x)^{k+1}} $$ ç°åœ¨éœ€è¦ä»è¿™ä¸ªå½¢å¼ä¸­æå–å‡º $ f(n,k) $ã€‚\næ ¹æ®å¹¿ä¹‰äºŒé¡¹å¼å®šç† $$ \\dfrac{1}{(1-x)^{k+1}} = \\sum_{n=0}^{\\infty} \\binom{ n+k }{ k } x^{n} $$ å¸¦å…¥å³å¯å¾—åˆ° $$ F_{k} = \\sum_{n=0}^{\\infty} \\binom{ n+k }{ k } x^{n+2k-1} \\xlongequal{m=n+2k-1} \\sum_{m=2k-1}^{\\infty} \\binom{ m-k+1 }{ k } x^{m} $$\näºæ˜¯ $$ f(n,k)=\\binom{ n-k+1 }{ k } \\quad (n\\geq 2k) $$ ï¼ˆæ˜¾ç„¶ $ n\u003c 2k-1 $ æ—¶ä¸å¯èƒ½æ‰¾å‡ºä¸å«ä¸¤ä¸ªè¿ç»­æ•°å­—ï¼Œå¤§å°ä¸º $ k $ çš„å­é›†ï¼Œç»“æœç¬¦åˆç›´è§‰ï¼‰\n(3)\nè®¾ $ F_{n} $ ä¸ºæ–æ³¢é‚£å¥‘æ•°åˆ—çš„ç¬¬ $ n $ é¡¹ï¼Œè¯æ˜ $$ F_{n+1} = \\sum_{k\\geq 0}\\binom{ k }{ n-k } $$ è¯ï¼š\nç”±äºæ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œæœ‰ $ F_{n+1}=F_{n}+F_{n-1} $ï¼Œå®¹æ˜“æ¨å¯¼å‡ºå…¶ç”Ÿæˆå‡½æ•°ä¸º $ G(x) = \\dfrac{1}{1-x-x^{2}} $ã€‚\nç°åœ¨è€ƒè™‘ $ h_{n}=\\sum_{k\\geq 0}\\binom{ k }{ n-k } $ï¼Œç”Ÿæˆå‡½æ•°ä¸º $ H(x)=\\sum_{n=0}^{\\infty}h_{n}x^{n} $ï¼ŒåŒ–ç®€å¾—åˆ° $$ \\begin{align*} H(x) \u0026 = \\sum_{n=0}^{\\infty} \\sum_{k=0 }^{\\infty} \\binom{ k }{ n-k }x^{n} \\\\ \u0026 \\xlongequal{ i=k,j=n-k} \\sum_{i=0}^{\\infty} \\sum_{j=0}^{\\infty} \\binom{ i }{ j } x^{i+j} \\\\ \u0026 = \\sum_{i=0}^{\\infty} x^{i}\\sum_{j=0}^{i} \\binom{ i }{ j } x^{j} \\\\ \u0026 = \\sum_{i=0}^{\\infty} x^{i}\\cdot(1+x)^{i} = \\sum_{i=0}^{\\infty} (x+x^{2})^{i} \\\\ \u0026 = \\dfrac{1}{1-x-x^{2}} = G(x) \\end{align*} $$ å› æ­¤ $ F_{n+1}=h_{n} $ï¼Œè¯æ¯•ï¼\nProblem 3 (1)\nå¯¹äºä»»æ„æ­£æ•´æ•° $ n $ å’Œ $ k $ï¼Œå®šä¹‰ $ f(n, k) $ å¦‚ä¸‹ï¼šå¯¹äºå°† $ n $ å†™æˆæœ‰åºçš„ $ k $ ä¸ªéè´Ÿæ•´æ•°ä¹‹å’Œçš„æ¯ä¸€ç§æ–¹å¼ï¼Œè®¾ $ S $ ä¸ºè¿™ $ k $ ä¸ªæ•´æ•°çš„ä¹˜ç§¯ã€‚é‚£ä¹ˆ $ f(n, k) $ æ˜¯é€šè¿‡è¿™ç§æ–¹å¼è·å¾—çš„æ‰€æœ‰ $ S $ çš„æ€»å’Œã€‚è¯·æ‰¾åˆ° $ f(n, k) $ çš„åˆé€‚ç”Ÿæˆå‡½æ•°ï¼Œå¹¶æ±‚å‡ºè¿™äº›æ•°æœ¬èº«ã€‚\nè¯ 1\nè®¾ $ x_{1}+x_{2}+\\dots+x_{k}=n $ï¼Œæˆ‘ä»¬éœ€è¦ $ \\prod_{i=1}^{k}x_{i} $ã€‚\nå¯¹äº $ x_{i} $ï¼Œå®ƒå¯¹æ±‚å’Œçš„è´¡çŒ®å°±æ˜¯ $ x_{i} $ï¼Œæ‰€ä»¥æˆ‘ä»¬è€ƒè™‘ç”Ÿæˆå‡½æ•° $ \\sum_{x_{i}=0}^{\\infty}x_{i}z^{x_{i}}=\\frac{z}{(1-z)^{2}} $ã€‚$ k $ ä¸ªè¿™æ ·çš„å˜é‡å åŠ å¯ä»¥è¡¨ç¤ºä¸º $$ \\left( \\sum_{x_{1}=0}^{\\infty} x_{1}z^{x_{1}} \\right)\\left( \\sum_{x_{2}=0}^{\\infty} x_{2}z^{x_{2}} \\right)\\dots\\left( \\sum_{x_{k}=0}^{\\infty} x_{k}z^{x_{k}} \\right) = \\dfrac{z^{k}}{(1-z)^{2k}} $$ å±•å¼€ä»¥åå°±å¯ä»¥å¾—åˆ° $$ \\sum_{x_{1},\\dots,x_{n}} \\prod_{i=1}^{k}x_{i}\\cdot z^{\\sum x_{i}} = \\sum_{n=1}^{\\infty} f(n,k)z^{n} = \\dfrac{z^{k}}{(1-z)^{2k}} $$ å› æ­¤ $ f(n,k) $ çš„ç”Ÿæˆå‡½æ•°ä¸º $$ H_{k}(x) = \\dfrac{x^{k}}{(1-x)^{2k}} $$ ç”±äº $$ \\dfrac{1}{(1-x)^{2k}} = \\sum_{n=0}^{\\infty} \\binom{ n+2k-1 }{ 2k-1 } x^{n} $$ äºæ˜¯ $$ H_{k}(x) = \\sum_{n=0}^{\\infty} \\binom{ n+2k-1 }{ 2k-1 } x^{n+k} \\xlongequal{m=n+k} \\sum_{m=k}^{\\infty} \\binom{ m+k-1 }{ 2k-1 } x^{m} $$ äºæ˜¯ $$ f(n,k) = \\binom{ n+k-1 }{ 2k-1 } $$\nè¯ 2\nè€ƒè™‘é€’æ¨å…³ç³» $$ f(n,k) = \\begin{cases} 0 \u0026 ,k\\geq n+1 \\\\ n \u0026 ,k = 1 \\\\ \\sum_{r=0}^{n} rf(n-r,k-1) \u0026 ,\\text{others} \\end{cases} $$ äºæ˜¯è®¾å¯¹åº”çš„ç”Ÿæˆå‡½æ•°ä¸º $ H_{k}(x) $ã€‚\né¦–å…ˆ $$ H_{1}(x) = \\sum_{n=0}^{\\infty} nx^{n} = \\dfrac{x}{(1-x)^{2}} $$ ä¹‹åæˆ‘ä»¬éœ€è¦å¯¹ $ H_{k}(x) $ å»ºç«‹é€’æ¨å…³ç³»ï¼š $$ \\begin{align*} H_{k}(x) \u0026 = \\sum_{n=0}^{\\infty} f(n,k)x^{n} = \\sum_{n=0}^{\\infty} \\sum_{r=0}^{n} rf(n-r,k-1)x^{n} \\\\ \u0026 \\xlongequal{i=r,j=n-r} \\sum_{i=0}^{\\infty} \\sum_{j=0}^{\\infty} if(j,k-1)x^{i+j} \\\\ \u0026 = \\sum_{j=0}^{\\infty} f(j,k-1)x^{j}\\left( \\sum_{i=0}^{\\infty} ix^{i} \\right) \\\\ \u0026 = H_{1}(x)\\cdot H_{k-1}(x) \\end{align*} $$ äºæ˜¯ $$ H_{k}(x) = \\dfrac{x}{(1-x)^{2}}H_{k-1}(x) = \\dfrac{x^{k}}{(1-x)^{2k}} $$ åç»­æ­¥éª¤ç›¸åŒã€‚\n(2)\nè®¾ $ f(n, k, c) $ ä¸ºå°† $ n $ å†™æˆæœ‰åºçš„ $ k $ ä¸ªæ•´æ•°ä¹‹å’Œçš„æ–¹å¼æ•°é‡ï¼Œå…¶ä¸­æ¯ä¸ªæ•´æ•°è‡³å°‘ä¸º $ c $ã€‚è¯·æ‰¾åˆ° $ f(n, k, c) $ çš„åˆé€‚ç”Ÿæˆå‡½æ•°ï¼Œå¹¶æ±‚å‡ºè¿™äº›æ•°æœ¬èº«ã€‚\nè¯ï¼š\nåŒç† $ (1) $ ï¼Œç”±äºæ­¤æ—¶éœ€è¦çš„æ˜¯è®¡æ•°ï¼Œæ¯ä¸ªå€¼çš„è´¡çŒ®éƒ½æ˜¯ $ 1 $ï¼Œå› æ­¤å¯¹äº $ x_{i} $ çš„ç”Ÿæˆå‡½æ•°ä¸º $ \\sum_{x_{i}=c}^{\\infty}z^{x_{i}} = \\dfrac{z^{c}}{1-z} $ å› æ­¤ $ k $ ä¸ªå˜é‡å åŠ è¡¨ç¤ºä¸º $$ \\left( \\sum_{x_{1}=c}^{\\infty} z^{x_{1}} \\right)\\left( \\sum_{x_{2}=c}^{\\infty} z^{x_{2}} \\right)\\dots\\left( \\sum_{x_{k}=c}^{\\infty} z^{x_{k}} \\right) = \\dfrac{z^{ck}}{(1-z)^{k}} $$ åŒæ—¶å±•å¼€å¯ä»¥å¾—åˆ° $$ H_{c,k}(z) = \\sum_{n=ck}^{\\infty} f(n,c,k)z^{n} = \\dfrac{z^{ck}}{(1-z)^{k}} $$ è¿™å°±å¾—åˆ°äº† $ f(n,c,k) $ çš„ç”Ÿæˆå‡½æ•°ã€‚\nä¸‹é¢æ±‚å‡ºæ•°åˆ—é€šé¡¹ã€‚æ ¹æ®å¹¿ä¹‰äºŒé¡¹å¼å®šç† $$ \\dfrac{1}{(1-z)^{k}} = \\sum_{n=0}^{\\infty} \\binom{ n+k-1 }{ k-1 } z^{n} $$ äºæ˜¯ $$ \\begin{align*} H_{c,k}(z) \u0026 = \\sum_{n=0}^{\\infty} \\binom{ n+k-1 }{ k-1 } z^{n+ck} \\\\ \u0026 \\xlongequal{m = n+ck} \\sum_{m=ck}^{\\infty} \\binom{ m-ck+k-1 }{ k-1 } z^{m} \\end{align*} $$ å¾—åˆ° $$ f(n,c,k) = \\dbinom{ n-ck+k-1 }{ k-1 } $$\n","permalink":"https://diefish1024.github.io/posts/class-notes/cs0901-combinatorics/cs0901-hw2/","summary":"\u003ch2 id=\"problem-1\"\u003eProblem 1\u003c/h2\u003e\n\u003cp\u003eç”¨ç”Ÿæˆå‡½æ•°æ±‚è§£é€’æ¨å¼\n$$ \n\na_{n} = 4a_{n-1} - 5a_{n-2} + 2a_{n-3}\n\n $$\nåˆå§‹å€¼ä¸º $ a_{0}=0,a_{1}=3,a_{2}=7 $ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eè§£\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cp\u003eè®¾æ•°åˆ— $ \\{ a_{n} \\} $ çš„ç”Ÿæˆå‡½æ•°ä¸º $ F(x) $ï¼Œé‚£ä¹ˆæ ¹æ®é€’æ¨å¼å’Œåˆå€¼ $ a_{0}=0,a_{1}=3,a_{2}=7 $ å¾—åˆ°\n$$ \n\nF(x) = 4xF(x) - 5x^{2}F(x) + 2x^{3}F(x) + 3x - 5x^{2}\n\n $$\nå¾—åˆ°\n$$ \n\nF(x) = \\dfrac{5x^{2}-3x}{2x^{3}-5x^{2}+4x-1} = \\dfrac{3x-5x^{2}}{(1-x)^{2}(1-2x)}\n\n $$\næˆ‘ä»¬å¸Œæœ›åˆ†è§£æˆ\n$$ \n\n\\dfrac{A}{1-x} + \\dfrac{B}{(1-x)^{2}} + \\dfrac{C}{1-2x}\n\n $$\nå¾…å®šç³»æ•°å¯ä»¥è§£å¾—\n$$ \n\nF(x) = \\dfrac{-3}{1-x} + \\dfrac{2}{(1-x)^{2}} + \\dfrac{1}{1-2x}\n\n $$\nå±•å¼€å¾—åˆ°\n$$ \n\nF(x) = \\sum_{n=0}^{\\infty} (-3+2(n+1)+2^{n})x^{n}\n\n $$\nå› æ­¤\n$$ \n\na_{n} = -3+2(n+1)+2^{n} = 2^{n} + 2n - 1\n\n $$\u003c/p\u003e","title":"CS0901 HW2"},{"content":"Exercise 1 Let $ f:\\mathbb{R}\\to\\mathbb{R} $ be a function. Prove that the following are equivalent: (i) There is a constant $ a\\in\\mathbb{R} $ such that for every$ x\\in\\mathbb{R} $ we have$ f(x)=ax $. (ii) For all $ x_1,x_2,c,x\\in\\mathbb{R} $ we have $ f(x_1+x_2)=f(x_1)+f(x_2) $ and $ f(cx)=c\\,f(x) $.\n(i â‡’ ii)\nAssume there exists $ a\\in\\mathbb{R} $ such that $ f(x)=a x $ for all $ x\\in\\mathbb{R} $ . Then for any $ x_1,x_2,c,x\\in\\mathbb{R} $ ,\n$ f(x_1+x_2)=a(x_1+x_2)=ax_1+ax_2=f(x_1)+f(x_2) $; $ f(cx)=a(cx)=c(ax)=c\\,f(x) $. Hence (ii) holds.\n(ii â‡’ i)\nAssume (ii) hold for all real scalars. Define $ a:=f(1) $. For any $ x\\in\\mathbb{R} $ we can write $ x=x\\cdot 1 $; by homogeneity, we have $ f(x)=f(x\\cdot 1)=x\\,f(1)=a x $.\nThus (i) holds with $ a=f(1) $. Therefore (i) and (ii) are equivalent.\nExercise 2 Describe geometrically (line, plane, or all of $ \\mathbb{R}^3 $) all linear combinations of the given vectors.\n(a) $ \\begin{pmatrix}1\\\\2\\\\3\\end{pmatrix} $ and $ \\begin{pmatrix}3\\\\6\\\\9\\end{pmatrix} $.\nObserve that$ \\begin{pmatrix}3\\\\6\\\\9\\end{pmatrix}=3\\begin{pmatrix}1\\\\2\\\\3\\end{pmatrix} $, so the two vectors are colinear. Hence their span is $ \\mathrm{Span}=\\{\\, t\\begin{pmatrix}1\\\\2\\\\3\\end{pmatrix}\\mid t\\in\\mathbb{R}\\,\\} $, which is a line. (b) $ \\begin{pmatrix}1\\\\0\\\\0\\end{pmatrix} $ and $ \\begin{pmatrix}0\\\\2\\\\3\\end{pmatrix} $.\nThese two vectors are not scalar multiples of each other, hence they are linearly independent. Therefore their span $ \\mathrm{Span}=\\{\\, \\alpha\\begin{pmatrix}1\\\\0\\\\0\\end{pmatrix}+\\beta\\begin{pmatrix}0\\\\2\\\\3\\end{pmatrix}\\mid \\alpha,\\beta\\in\\mathbb{R}\\,\\} $ is a plane. (c) $ \\begin{pmatrix}2\\\\0\\\\0\\end{pmatrix} $, $ \\begin{pmatrix}0\\\\2\\\\2\\end{pmatrix} $ and $ \\begin{pmatrix}2\\\\2\\\\3\\end{pmatrix} $.\nForm the matrix with these as columns and compute the determinant: $$ \\det\\begin{pmatrix} 2 \u0026 0 \u0026 2\\\\ 0 \u0026 2 \u0026 2\\\\ 0 \u0026 2 \u0026 3 \\end{pmatrix} \\neq 0. $$ Since the determinant is nonzero, the three vectors are linearly independent,therefore their span all of $ \\mathbb{R}^3 $. Answers:\n(a) a line. (b) a plane. (c) all of $ \\mathbb{R}^3 $. Exercise 3 Consider $ v=(1,-2,1) $ and $ w=(0,1,-1) $. Find $ c $ and $ d $ such that $ c v+d w=(3,3,-6) $. Why is $ (3,3,6) $ impossible?\nLet $ c v+d w=(3,3,-6) $. Comparing coordinates: $$ \\begin{cases} c = 3 \\\\ -2c+d=9 \\\\ c-d=-6 \\end{cases} $$ It can be solved that $ c=3 $ and $ d=9 $.\nFor $ (3,3,6) $, the first coordinate again forces $ c=3 $, and the second gives $ d=9 $, hence the third would be $ c-d=3-9=-6\\neq 6 $. Therefore it is impossible. Equivalently, every linear combination satisfies $ y+z=-x $ (since $ y=-2c+d $ and $ z=c-d $), but the vector $ (3,3,6) $ has $ y+z=9\\neq -3 $; hence it does not lie in $ \\mathrm{Span}\\{v,w\\} $.\nExercise 4 In the following, tacitly assume that every matrix operation is well-defined. Prove: (i) $ A+B=B+A $. (ii) $ c(A+B)=cA+cB $. (iii) $ A+(B+C)=(A+B)+C $. (iv) $ A(B+C)=AB+AC $. (v) $ (A+B)C=AC+BC $. (vi) $ A(BC)=(AB)C $.\nWrite $ A=(a_{ij}) $, $ B=(b_{ij}) $, $ C=(c_{ij}) $. Use the entrywise definitions of addition and multiplication.\n(i) Commutativity of addition: For all $ i,j $, $ (A+B)_{ij}=a_{ij}+b_{ij}=b_{ij}+a_{ij}=(B+A)_{ij} $. Hence $ A+B=B+A $.\n(ii) Distributivity of scalar multiplication over addition: For all $ i,j $, $ \\big(c(A+B)\\big)_{ij}=c(a_{ij}+b_{ij})=ca_{ij}+cb_{ij}=(cA+cB)_{ij} $.\n(iii) Associativity of addition: For all $ i,j $, $ \\big(A+(B+C)\\big)_{ij}=a_{ij}+(b_{ij}+c_{ij})=(a_{ij}+b_{ij})+c_{ij}=\\big((A+B)+C\\big)_{ij} $.\n(iv) Left distributivity of multiplication: $$ \\big(A(B+C)\\big)_{ij} =\\sum_k a_{ik}(b_{kj}+c_{kj}) =\\sum_k a_{ik}b_{kj}+\\sum_k a_{ik}c_{kj} =(AB)_{ij}+(AC)_{ij} =(AB+AC)_{ij}. $$\n(v) Right distributivity of multiplication: $$ \\big((A+B)C\\big)_{ij} =\\sum_k (a_{ik}+b_{ik})c_{kj} =\\sum_k a_{ik}c_{kj}+\\sum_k b_{ik}c_{kj} =(AC)_{ij}+(BC)_{ij} =(AC+BC)_{ij}. $$\n(vi) Associativity of multiplication: $$ \\big(A(BC)\\big)_{ij} =\\sum_k a_{ik}(BC)_{kj} =\\sum_k a_{ik}\\sum_\\ell b_{k\\ell}c_{\\ell j} =\\sum_\\ell\\Big(\\sum_k a_{ik}b_{k\\ell}\\Big)c_{\\ell j} =\\big((AB)C\\big)_{ij}. $$\nTherefore all properties (i)â€“(vi) hold.\nExercise 5 Let$ A=\\begin{pmatrix}3\u00261\\\\[2pt] 1\u0026-3\\end{pmatrix} $. Compute $ A^{50} $ and $ A^{51} $.\nFirst compute$ A^2 $: $$ A^2 =\\begin{pmatrix}3\u00261\\\\ 1\u0026-3\\end{pmatrix} \\begin{pmatrix}3\u00261\\\\ 1\u0026-3\\end{pmatrix} =\\begin{pmatrix} 3\\cdot 3+1\\cdot 1 \u0026 3\\cdot 1+1\\cdot(-3)\\\\ 1\\cdot 3+(-3)\\cdot 1 \u0026 1\\cdot 1+(-3)\\cdot(-3) \\end{pmatrix} =\\begin{pmatrix}10\u00260\\\\ 0\u002610\\end{pmatrix} =10\\,I_2. $$ Thus $ A^2=10I_2 $. It follows that for any integer $ n\\ge 1 $,\nif $ n $ is even, $ A^n=(A^2)^{n/2}=10^{n/2}I_2 $; if $ n $ is odd, $ A^n=A\\cdot A^{n-1}=A\\cdot 10^{(n-1)/2}I_2=10^{(n-1)/2}A $. Therefore,\n$ A^{50}=10^{25}I_2 $, $ A^{51}=10^{25}A=10^{25}\\begin{pmatrix}3\u00261\\\\[2pt] 1\u0026-3\\end{pmatrix} $. ","permalink":"https://diefish1024.github.io/posts/class-notes/math1205h-linear-algebra/math1205h-hw1/","summary":"\u003ch2 id=\"exercise-1\"\u003eExercise 1\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003eLet $ f:\\mathbb{R}\\to\\mathbb{R} $ be a function. Prove that the following are equivalent:\n(i) There is a constant $ a\\in\\mathbb{R} $ such that for every$ x\\in\\mathbb{R} $ we have$ f(x)=ax $.\n(ii) For all $ x_1,x_2,c,x\\in\\mathbb{R} $ we have $ f(x_1+x_2)=f(x_1)+f(x_2) $ and $ f(cx)=c\\,f(x) $.\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003e\u003cstrong\u003e(i â‡’ ii)\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eAssume there exists $ a\\in\\mathbb{R} $ such that $ f(x)=a x $ for all $ x\\in\\mathbb{R} $ . Then for any $ x_1,x_2,c,x\\in\\mathbb{R} $ ,\u003c/p\u003e","title":"MATH1205H HW1"},{"content":"è€ƒè™‘ä¸Šä¸€èŠ‚å¼•å…¥çš„äºŒé¡¹å¼å®šç† $$ (1+x)^{n} = \\sum_{k=0}^{n} \\binom{ n }{ k } x^{k} $$ è¿™å¯ä»¥ç†è§£æˆæˆ‘ä»¬æŠŠäºŒé¡¹ç³»æ•°è½¬æ¢æˆäº†ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬èƒ½æ›´æœ‰æ•ˆåœ°æ“ä½œå’Œåˆ†æåºåˆ—ï¼Œè¿™ä¸ªå·¥å…·è¢«æˆä¸ºç”Ÿæˆå‡½æ•°ã€‚\nOrdinary Generating Functions ç»™å®šåºåˆ— $ \\{ a_{n} \\}_{n\\geq 0} $ï¼Œç”± $ \\{ a_{n} \\} $ å®šä¹‰çš„æ™®é€šç”Ÿæˆå‡½æ•° (OGF) ä¸ºï¼š $$ G(x) = \\sum_{n\\geq 0} a_{n}x^{n} $$ è™½ç„¶çœ‹èµ·æ¥ OGF å¹¶æ²¡æœ‰è¢«å¾ˆå¥½çš„å®šä¹‰ï¼Œå¯¹äºå’ŒæŸäº›æ•°åˆ—ï¼Œè¿™ä¸ªå½¢å¼ä¸ä¼šæ”¶æ•›ï¼Œä½†æ˜¯å®é™…ä¸Šç”Ÿæˆå‡½æ•°å¹¶ä¸èƒ½è¢«çœ‹æˆä¸€ä¸ªçœŸæ­£çš„å‡½æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªå½¢å¼å¹‚çº§æ•°ï¼Œå¹¶ä¸”ä¸è¢«è¦æ±‚æ”¶æ•›ã€‚\nä»¥ä¸‹æ˜¯ä¸€äº›ç”Ÿæˆå‡½æ•°çš„åŸºç¡€ä¾‹å­ï¼š $$ G(x) = 1+x+x^{2}+x^{3} +\\dots = \\dfrac{1}{1-x} $$ $$ G(x) = 1+ax+a^{2}x^{2} + a^{3}x^{3} + \\dots = \\dfrac{1}{1-ax} $$\nç»™å®šä¸€ä¸ªåºåˆ—ï¼Œå†™å‡ºä»–çš„ç”Ÿæˆå‡½æ•°æ˜¯å¾ˆå®¹æ˜“çš„ã€‚å°½ç®¡æ‰¾åˆ°ä»–çš„é—­åˆå½¢å¼ä¸å®¹æ˜“ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬ä¸éœ€è¦è¿™æ ·åšã€‚ç›¸åï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘ç»™å®šä¸€ä¸ªé—­åˆå½¢å¼ï¼Œéœ€è¦å¦‚ä½•çŸ¥é“å…¶å¯¹åº”çš„åºåˆ—ã€‚\næˆ‘ä»¬çº¦å®š $ [x^{n}]G(x) $ è¡¨ç¤ºç”Ÿæˆå‡½æ•°ä¸­ $ x^{n} $ çš„ç³»æ•°ã€‚\nç†è®ºä¸Šæˆ‘ä»¬æ€»å¯ä»¥ä½¿ç”¨æ³°å‹’çº§æ•°æ¥å¾—åˆ° $ [x^{n}]G(x) $ã€‚\nNewtonâ€™s Generalized Binomial Theorem\nå¦‚æœ $ x $ æ˜¯ä»»ä½•å®æ•°å¹¶ä¸” $ \\left| x \\right|\u003c1 $ï¼Œå¹¶ä¸” $ r $ æ˜¯ä»»ä½•å¤æ•°ï¼Œæˆ‘ä»¬æœ‰ï¼š $$ (1+x)^{r} = \\sum_{n=0}^{\\infty} \\binom{ r }{ n } x^{n} $$ å…¶ä¸­ $$ \\binom{ r }{ n } = \\dfrac{r^{\\underline{n}}}{n!} $$ ä¾‹å¦‚ $$ \\dfrac{1}{1+x} = (1+x)^{-1} = \\sum_{n=0}^{\\infty} \\binom{ -1 }{ n } x^{n} = 1-x+x^{2}-x^{3}+\\dots $$\nOperations on Generating Functions Convolution å¤šé¡¹å¼ä¹˜æ³•ï¼ˆå·ç§¯ï¼‰åœ¨æŸç§æ„ä¹‰ä¸Šç¼–ç äº†ä¹˜æ³•åŸç†å’ŒåŠ æ³•åŸç†ã€‚ä»¤ $ F(x)=\\sum_{n=0}^{\\infty}f_{n}x^{n},G(x)=\\sum_{n=0}^{\\infty}g_{n}x^{n} $ï¼Œé‚£ä¹ˆ $$ [x^{n}](F(x)G(x)) = \\sum_{n=0}^{\\infty} f_{k}g_{n-k} $$ æˆ‘ä»¬ç§°è¿™ä¸ºå·ç§¯ (convolution) ã€‚è¿™æœ‰æ¸…æ™°çš„ç»„åˆæ„ä¹‰ï¼Œè¡¨ç¤ºä» $ F\\cup G $ ä¸­é€‰æ‹© $ n $ ä¸ªå…ƒç´ ã€‚\nExamples Example 1\nå‡è®¾æœ‰ $ 5 $ ä¸ªç›¸åŒè“è‰²çƒï¼Œ$ 3 $ ä¸ªç›¸åŒç»¿è‰²çƒï¼Œ$ 2 $ ä¸ªç›¸åŒçº¢è‰²çƒï¼Œé—®æœ‰å‡ ç§æ–¹å¼ä»å‡ ç§é€‰æ‹© $ 6 $ ä¸ªçƒï¼Ÿ\nè§£ï¼š\næˆ‘ä»¬é€šè¿‡ç”Ÿæˆå‡½æ•°æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä»¤ $ \\{ b_{n} \\},\\{ g_{n} \\},\\{ r_{n} \\} $ åˆ†åˆ«ä¸ºé€‰æ‹©è“è‰²ã€ç»¿è‰²ã€çº¢è‰²çƒçš„æ–¹æ¡ˆæ•°ï¼Œæ˜¾ç„¶ç”±äºæ¯ç§é¢œè‰²çš„çƒç›¸åŒï¼Œæˆ‘ä»¬å®¹æ˜“å¾—åˆ°ä»–ä»¬å¯¹åº”çš„ç”Ÿæˆå‡½æ•°åˆ†åˆ«ä¸º $$ \\begin{align*} B(x) \u0026 = 1+x+x^{2}+x^{3}+x^{4}+x^{5} \\\\ G(x) \u0026 = 1+x+x^{2}+x^{3} \\\\ R(x) \u0026 = 1+x+x^{2} \\end{align*} $$ é‚£ä¹ˆæˆ‘ä»¬å°±èƒ½å¾—åˆ° $ F(x)=B(x)G(x)R(x) $ ä¸ºé€‰æ‹©ä¸‰ç§çƒæ–¹æ¡ˆçš„ç”Ÿæˆå‡½æ•°ï¼Œé€‰æ‹© $ 6 $ ä¸ªçƒçš„æ–¹æ¡ˆæ•°ä¸º $$ [x^{6}]F(x) = \\dots $$\nExample 2 (Multiset Number)\nå›é¡¾åäºŒé‡è®¡æ•°æ³•ä¸­çš„å¤šé‡é›†æ•° $ \\left( \\binom{ m }{ n } \\right) $ï¼Œè¡¨ç¤ºä» $ [m] $ ä¸­é€‰æ‹©å¤§å°ä¸º $ n $ çš„å¤šé‡é›†ï¼ˆå…è®¸å…ƒç´ é‡å¤ï¼‰çš„æ•°é‡ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ç”Ÿæˆå‡½æ•°è¯æ˜ $$ \\left( \\binom{ m }{ n } \\right) = \\binom{ n+m-1 }{ n } = \\binom{ n+m-1 }{ m-1 } $$ è¯ï¼š\nè®¾ $ \\left( \\binom{ m }{ n } \\right) $ çš„ç”Ÿæˆå‡½æ•°ä¸º $$ F(x) = \\sum_{n=0}^{\\infty} \\left(\\binom{ m }{ n }\\right) x^{n} $$ æˆ‘ä»¬è€ƒè™‘å¯¹äºå•ä¸ªå…ƒç´  $ i $ çš„é›†åˆï¼Œå…¶è¢«é€‰æ‹© $ k $ æ¬¡çš„æ–¹æ¡ˆæ•°æ˜¾ç„¶éƒ½ä¸º $ 1 $ï¼Œæ‰€ä»¥å¯¹åº”ç”Ÿæˆå‡½æ•°ä¸º $$ F_{i}(x) = \\sum_{n=0}^{\\infty} x^{n} = \\dfrac{1}{1-x} $$ äºæ˜¯ $$ F(x) = F_{1}(x)F_{2}(x)\\dots F_{m}(x) = \\dfrac{1}{(1-x)^{m}} $$ ä»è€Œ $$ \\left( \\binom{ m }{ n } \\right) = [x^{n}]F(x) = \\binom{ -m }{ n } (-r)^{n} = \\binom{ n+m-1 }{ n } $$ å› æ­¤å¾—è¯ã€‚\nExample 3\nå¯¹äºæ¯ä¸ªæ­£æ•´æ•° $ n $ï¼Œå°† $ n $ åˆ†å‰²æˆè‹¥å¹²ä¸ªå¥‡æ•°ä¹‹å’Œçš„æ–¹æ¡ˆæ•°ç­‰äºå°† $ n $ åˆ†å‰²æˆè‹¥å¹²ä¸ªä¸åŒçš„æ•°ä¹‹å’Œçš„æ–¹æ¡ˆæ•°ã€‚\nè¯ï¼š\nä»¤ $ o_{n} $ ä¸ºå°† $ n $ åˆ†å‰²æˆå¥‡æ•°çš„çš„æ–¹æ¡ˆæ•°ï¼Œ$ d_{n} $ ä¸ºåˆ†å‰²æˆä¸åŒéƒ¨åˆ†çš„æ–¹æ¡ˆæ•°ï¼Œå¹¶ä¸”ä»¤ $ O_{n} $ å’Œ $ D_{n} $ åˆ†åˆ«ä¸ºä»–ä»¬å¯¹åº”çš„ç”Ÿæˆå‡½æ•°ã€‚\nå¯¹äºå¥‡æ•°ï¼Œæˆ‘ä»¬æœ‰ $$ \\begin{align*} O(x) \u0026 = (1+x+x^{2}+\\dots)(1+x^{3}+(x^{3})^{2} + \\dots)(1+x^{5}+(x^{5})^{2} + \\dots)\\dots \\\\ \u0026 = \\dfrac{1}{1-x}\\cdot \\dfrac{1}{1-x^{3}}\\cdot \\dfrac{1}{1-x^{5}}\\cdot\\dots \\\\ \u0026 = \\prod_{k\\,\\text{mod}\\,2=1} \\dfrac{1}{1-x^{k}} \\end{align*} $$\nå¯¹äºä¸åŒéƒ¨åˆ†ï¼Œæˆ‘ä»¬æœ‰ $$ \\begin{align*} D(x) \u0026 = (1+x)(1+x^{2})(1+x^{3})\\dots \\\\ \u0026 = \\dfrac{1-x^{2}}{1-x}\\cdot \\dfrac{1-x^{4}}{1-x^{2}}\\cdot \\dfrac{1-x^{6}}{1-x^{3}}\\cdot \\dots \\\\ \u0026 = \\prod_{k=1}^{\\infty} \\dfrac{1-x^{2k}}{1-x^{k}} \\\\ \u0026 = \\prod_{k\\,\\text{mod}\\,2=1} \\dfrac{1}{1-x^{k}} \\end{align*} $$ å› æ­¤ $ O(x)=D(x) $ï¼Œä»è€Œ $ o_{n}=d_{n} $ï¼Œæ–¹æ¡ˆæ•°ç›¸ç­‰ã€‚\nOperations Solving Recurrence ç”Ÿæˆå‡½æ•°æœ€é‡è¦çš„åº”ç”¨ä¹‹ä¸€æ˜¯è§£å†³é€’æ¨å…³ç³»å¹¶æ‰¾åˆ°é—­åˆå½¢å¼ï¼Œç°åœ¨æˆ‘ä»¬ä»‹ç»ä¸€äº›ä¾‹å­ã€‚\nä¸€ä¸ªç»å…¸ä¾‹å­æ˜¯æ±‚è§£æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œè¿‡ç¨‹å¯ä»¥å‚è€ƒä½œä¸šè§£ç­”ï¼Œæ­¤å¤„ä¸å†é‡å¤ã€‚\nå¦ä¸€ä¸ªä¾‹å­æ˜¯å¡ç‰¹å…°æ•°ã€‚æˆ‘ä»¬å·²çŸ¥å…¶é€’æ¨å…³ç³»æ˜¯ $$ C_{0}=1,\\quad C_{n} = \\sum_{k=0}^{n-1} C_{k}C_{n-1-k}\\,,\\forall n\\geq 1 $$ æˆ‘ä»¬ä»¤ $ G(x) $ ä¸ºå¡ç‰¹å…°æ•°çš„ç”Ÿæˆå‡½æ•°ã€‚é€’æ¨å…³ç³»è¡¨æ˜æˆ‘ä»¬åº”è¯¥è€ƒè™‘ä¹˜æ³•ã€‚ $$ \\begin{align*} G(x) \u0026 = C_{0} + \\sum_{n=1}^{\\infty} \\sum_{k=0}^{n-1} C_{k}C_{n-1-l}x^{n} \\\\ G(x)^{2} \u0026 = \\left( \\sum_{n=0}^{\\infty} C_{n}x^{n} \\right)^{2} = \\sum_{n=0}^{\\infty} \\left( \\sum_{k=0}^{n} C_{k}C_{n-k} \\right)x^{n} \\\\ \\implies xG(x)^{2} \u0026 = \\sum_{n=1}^{\\infty}\\left( \\sum_{k=0}^{n-1} C_{k}C_{n-1-k} \\right)x^{n} \\\\ \\end{align*} $$ å› æ­¤æˆ‘ä»¬æœ‰ $$ G(x) = 1+ xG(x)^{2} \\implies G(x) = \\dfrac{1\\pm \\sqrt{ 1-4x }}{2x} $$ è¿™ä¸¤ä¸ªè§£ä¸­åªæœ‰ä¸€ä¸ªæ˜¯æˆ‘ä»¬éœ€è¦çš„ç”Ÿæˆå‡½æ•°ï¼Œæ³¨æ„åˆ° $ \\lim_{ x \\to 0 }G(x)=C_{0}=1 $ï¼Œå®¹æ˜“éªŒè¯ $$ G(x) = \\dfrac{1-\\sqrt{ 1-4x }}{2x} $$ ç°åœ¨æˆ‘ä»¬é€šè¿‡å¹¿ä¹‰äºŒé¡¹å¼å®šç†å±•å¼€ $ \\sqrt{ 1-4x }=(1-4x)^{1 / 2} $ ï¼Œå†å¸¦å…¥åŸå¼å¾—åˆ° $$ G(x) = \\sum_{n=0}^{\\infty} \\dfrac{1}{n+1}\\binom{ 2n }{ n } x^{n} $$ è¿™å°±ç®—å‡ºäº† $$ C_{n} = \\dfrac{1}{n+1}\\binom{ 2n }{ n } $$\næœ€åä¸€ä¸ªä¾‹å­æ˜¯ç¬¬äºŒç±»æ–¯ç‰¹æ—æ•°ã€‚å…¶é€’æ¨å…³ç³»ä¸º $$ \\left\\{ 0 \\atop 0 \\right\\} = 0,\\quad \\left\\{ n\\atop k \\right\\} = k\\left\\{ n-1 \\atop k \\right\\} + \\left\\{ n-1 \\atop k-1 \\right\\} \\quad \\text{for } (n,k) \\neq (0,0) $$ ç”±äºå­˜åœ¨ä¸¤ä¸ªç´¢å¼•ï¼Œæ‰€ä»¥æ­¤æ—¶æœ‰ä¸‰ä¸ªç”Ÿæˆå‡½æ•°å€™é€‰ï¼š $$ \\begin{align*} A(x,y) \u0026 = \\sum_{n=0}^{\\infty} \\sum_{k=0}^{\\infty} \\left\\{ n \\atop k \\right\\} x^{n}y^{k} \\\\ B_{k}(x) \u0026 = \\sum_{n=0}^{\\infty} \\left\\{ n\\atop k \\right\\} x^{n} \\\\ C_{n}(y) \u0026 = \\sum_{k=0}^{\\infty} \\left\\{ n \\atop k \\right\\} y^{k} \\end{align*} $$ ç„¶è€Œç”±äºæˆ‘ä»¬å¹¶ä¸çŸ¥é“å¦‚ä½•å¤„ç†å¤šå…ƒç”Ÿæˆå‡½æ•°ï¼Œå› æ­¤ $ A(x,y) $ åº”è¯¥é¦–å…ˆè¢«æ’é™¤ã€‚å¦‚æœé€‰æ‹© $ C_{n}(y) $ï¼Œé‚£ä¹ˆé€’æ¨å…³ç³»ä¸­çš„ $ k\\left\\{ n-1\\atop k \\right\\} $ æ— ç–‘ä¼šæ¶‰åŠåˆ°å¾®åˆ†ï¼Œè¿™ä¼šä½¿å¾—æ“ä½œæ›´åŠ å¤æ‚ã€‚å› æ­¤æˆ‘ä»¬ä½¿ç”¨ $ B_{k}(x) $ ä½œä¸ºç”Ÿæˆå‡½æ•°ã€‚\næ³¨æ„åˆ° $$ B_{k}(x) = \\sum_{n=k}^{\\infty} \\left\\{ n \\atop k \\right\\}x^{k} = kxB_{k}(x) + xB_{k-1}(x) \\quad \\text{for } k\\geq 1 $$ å¹¶ä¸” $ B_{0}(x)=1 $ã€‚\näºæ˜¯ $$ B_{k}(x) = \\dfrac{x}{1-kx}B_{k-1}(x) = \\dfrac{x^{k}}{(1-x)(1-2x)\\dots(1-kx)} = \\prod_{i=1}^{k} \\dfrac{x}{1-ix} $$ æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ‰¾åˆ° $ [x^{n}]B_{k}(x) $ çš„æ˜¾å¼å…¬å¼ã€‚ä¸€ä¸ªå¾ˆè‡ªç„¶çš„æ€è·¯æ˜¯æŠŠ $ B_{k}(x) $ å†™æˆ $$ B_{k}(x) = \\sum_{i=1}^{k} \\dfrac{r_{i}x}{1-ix} $$ ä¸ºäº†æ‰¾åˆ° $ r_{i} $ï¼Œæˆ‘ä»¬å›ºå®šæŸä¸ª $ j\\in[k] $ å¹¶å°†ä¸¤è¾¹ä¹˜ä»¥ $ 1-jx $ã€‚è¿™å°±å¾—åˆ°äº† $$ \\dfrac{x^{k}}{\\prod_{i\\neq j}(1-ix)} = r_{j}x + \\sum_{i\\neq j} \\dfrac{r_{i}x}{1-ix}(1-jx) $$ å†ä»¤ $ x=1 / j $ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº† $$ \\dfrac{(1 /j)^{k}}{\\prod_{i\\neq j}(1-i / j)} = \\dfrac{r_{j}}{j}\\implies r_{j} = \\dfrac{(-1)^{k-j}}{(j-1)!(k-j)!} $$ äºæ˜¯å°±å¾—åˆ°äº† $$ \\left\\{ n\\atop k \\right\\} = [x^{n}]B_{k}(x) = \\sum_{i=1}^{k} r_{i}i^{n-1} = \\sum_{i=1}^{k} \\dfrac{(-1)^{k-i}}{(i-1)!(k-i)!}i^{n-1} $$\nExponential Generating Function ä¸€èˆ¬è€Œè¨€ï¼ŒOGF å¯¹äºè®¡æ•°å­é›†çš„æ•°é‡éå¸¸æœ‰ç”¨ï¼Œç„¶è€Œå®ƒå¯èƒ½ä¸é€‚ç”¨äºè®¡æ•°ç½®æ¢æˆ–è€…å¸¦æ ‡ç­¾å…ƒç´ ã€‚ä¾‹å¦‚ $ [n] $ ä¸Šçš„ç½®æ¢æ•°é‡çš„ OGF æ˜¯ä»€ä¹ˆï¼Œæ˜¾ç„¶æœ‰ $$ F(x) = 1+x+2x^{2}+6x^{3}+\\dots=\\sum_{n=0}^{\\infty} n!x^{n} $$ æˆ‘ä»¬å°è¯•æ‰¾å‡ºå®ƒçš„é—­åˆå½¢å¼ã€‚ç”±äº $ [x^{n}]F(x)=n[x^{n-1}]F(x) $ï¼Œè¿™æç¤ºæˆ‘ä»¬ä½¿ç”¨å¾®åˆ†è¿ç®— $$ F(x) = 1+x(xF(x))' = 1+xF(x) + x^{2}F'(x) $$ ç„¶è€Œè¿™ç±»å¾®åˆ†æ–¹ç¨‹é€šå¸¸æ²¡æœ‰é—­åˆå½¢å¼çš„è§£ã€‚\näºæ˜¯è¿™å°±éœ€è¦å¼•å…¥æŒ‡æ•°ç”Ÿæˆå‡½æ•° (EGF)ï¼Œå®ƒç”¨äºå¤„ç†ç½®æ¢æˆ–è€…å¸¦æ ‡ç­¾å…ƒç´ çš„è®¡æ•°ã€‚\nå¯¹äºåºåˆ— $ \\{ a_{n} \\}_{n\\geq 0} $ï¼Œç”± $ \\{ a_{n} \\} $ å®šä¹‰çš„ EGF ä¸º $$ G(x) = \\sum_{n=0}^{\\infty} \\dfrac{a_{n}}{n!}x^{n} $$ ç½®æ¢ï¼šå®¹æ˜“çœ‹å‡ºç”± $ n! $ å®šä¹‰çš„ EGF ä¸º $ \\dfrac{1}{1-x} $ã€‚\nå¾ªç¯ç½®æ¢ï¼šåœ†æ’åˆ—æ•°é‡ä¸º $ (n-1)! $ï¼Œå®¹æ˜“å¾—åˆ°å…¶ç”Ÿæˆå‡½æ•°ä¸º $ \\sum_{n=1}^{\\infty} \\frac{1}{n}x^{n}=-\\ln(1-x) $ã€‚\nä¸ºäº†æ›´å¥½çš„ç†è§£ EGF çš„ç»„åˆå«ä¹‰ï¼Œæˆ‘ä»¬è€ƒè™‘ä¸¤ä¸ªæŒ‡æ•°ç”Ÿæˆå‡½æ•°çš„ä¹˜ç§¯ã€‚è®¾ $ \\hat{F}(x) = \\sum_{n=0}^{\\infty} \\frac{1}{n!}f_{n}x^{n} $ï¼Œä¸” $ \\hat{G}(x) = \\sum_{n=0}^{\\infty} \\frac{1}{n!}g_{n}x^{n} $ ï¼Œé‚£ä¹ˆå®¹æ˜“çœ‹å‡º $$ [x^{n}](\\hat{F}(x)\\hat{G}(x)) = \\sum_{k=0}^{n} \\dfrac{f_{k}}{k!} \\dfrac{g_{n-k}}{(n-k)!} $$ äºæ˜¯ $ \\hat{F}(x)\\hat{G}(x) $ å¯¹åº”åºåˆ—çš„é€šé¡¹ä¸º $$ h_{n} = n![x^{n}](\\hat{F}(x)\\hat{G}(x)) = \\sum_{k=0}^{n} \\binom{ n }{ k } f_{k}g_{n-k} $$ è¿™è¡¨ç¤ºæˆ‘ä»¬ä¸ä»…æšä¸¾å…ƒç´ çš„æ•°é‡ï¼Œè¿˜æšä¸¾ä»–ä»¬çš„ä½ç½®æˆ–è€…æ ‡ç­¾ã€‚\nç°åœ¨æˆ‘ä»¬è€ƒè™‘æŒ‡æ•°ç”Ÿæˆå‡½æ•°çš„ä¸€ä¸ªåº”ç”¨ã€‚å‡è®¾æœ‰ä¸€ä¸ª $ 1 \\times n $ çš„æ£‹ç›˜ï¼Œæˆ‘ä»¬æƒ³ç”¨è“è‰²ã€ç»¿è‰²å’Œçº¢è‰²ä¸ºæ¯ä¸ªæ ¼å­ç€è‰²ã€‚è¦æ±‚çº¢è‰²æ ¼å­çš„æ•°é‡å¿…é¡»æ˜¯å¶æ•°ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªè“è‰²æ ¼å­ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ç¡®å®šæ£‹ç›˜ç€è‰²çš„æ–¹å¼æ•°é‡ $ f_n $ã€‚ ä»¤ $ \\{b_n\\} $ã€$ \\{g_n\\} $ã€$ \\{r_n\\} $ åˆ†åˆ«ä¸ºç”¨å•ä¸€é¢œè‰²è“è‰²ã€ç»¿è‰²å’Œçº¢è‰²ä¸º $ n $ ä¸ªæ ¼å­ç€è‰²çš„æ–¹å¼æ•°é‡åºåˆ—ã€‚é‚£ä¹ˆå®ƒä»¬å¯¹åº”çš„æŒ‡æ•°ç”Ÿæˆå‡½æ•°æ˜¯ï¼š $$ \\begin{align*} \u0026 \\hat{B}(x) = \\sum_{n \\ge 1} \\frac{1}{n!} x^n = e^x - 1 \\quad (\\text{è‡³å°‘ä¸€ä¸ªè“è‰²æ ¼å­}) \\\\ \u0026 \\hat{G}(x) = \\sum_{n \\ge 0} \\frac{1}{n!} x^n = e^x \\quad (\\text{ä»»æ„æ•°é‡çš„ç»¿è‰²æ ¼å­}) \\\\ \u0026 \\hat{R}(x) = \\sum_{n \\ge 0, n \\text{ å¶æ•°}} \\frac{1}{n!} x^n = 1 + \\frac{x^2}{2!} + \\frac{x^4}{4!} + \\dots = \\frac{e^x + e^{-x}}{2} \\quad (\\text{å¶æ•°ä¸ªçº¢è‰²æ ¼å­}) \\end{align*} $$ å› æ­¤ $ \\{f_n\\} $ çš„æŒ‡æ•°ç”Ÿæˆå‡½æ•°æ˜¯ï¼š $$ \\begin{align*} \\hat{F}(x) \u0026 = \\hat{B}(x) \\cdot \\hat{G}(x) \\cdot \\hat{R}(x) \\\\ \u0026 = (e^x - 1)e^x \\frac{e^x + e^{-x}}{2} \\\\ \u0026 = \\frac{e^{2x} - e^x}{2} (e^x + e^{-x}) \\\\ \u0026 = \\frac{e^{3x} + e^x - e^{2x} - 1}{2} \\\\ \u0026 = \\frac{1}{2} \\left( \\sum_{n \\ge 0} \\frac{3^n}{n!} x^n - \\sum_{n \\ge 0} \\frac{2^n}{n!} x^n + \\sum_{n \\ge 0} \\frac{1^n}{n!} x^n - 1 \\right) \\end{align*} $$ è¿™ç»™å‡ºäº†ï¼š $$ f_n = n! \\cdot [x^n]\\hat{F}(x) = \\begin{cases} 0, \u0026 n = 0 \\\\ \\frac{3^n - 2^n + 1}{2}, \u0026 n \\ge 1 \\end{cases} $$\nç±»ä¼¼åœ°ï¼Œå›æƒ³ä¸€ä¸‹ $ \\left\\{\\substack{n \\\\ k}\\right\\} $ è®¡ç®—å°† $ [n] $ åˆ†å‰²æˆ $ k $ ä¸ªç›¸åŒéç©ºå­é›†çš„æ–¹å¼æ•°é‡ï¼Œå› æ­¤ $ k!\\left\\{\\substack{n \\\\ k}\\right\\} $ å…·æœ‰æŒ‡æ•°ç”Ÿæˆå‡½æ•°ï¼š $$ \\sum_{n \\ge 0} k!\\left\\{\\substack{n \\\\ k}\\right\\} \\frac{x^n}{n!} = (e^x - 1)^k $$\n","permalink":"https://diefish1024.github.io/posts/class-notes/cs0901-combinatorics/lect2-generating-functions/","summary":"\u003cp\u003eè€ƒè™‘ä¸Šä¸€èŠ‚å¼•å…¥çš„äºŒé¡¹å¼å®šç†\n$$ \n\n(1+x)^{n} = \\sum_{k=0}^{n} \\binom{ n }{ k } x^{k}\n\n $$\nè¿™å¯ä»¥ç†è§£æˆæˆ‘ä»¬æŠŠäºŒé¡¹ç³»æ•°è½¬æ¢æˆäº†ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬èƒ½æ›´æœ‰æ•ˆåœ°æ“ä½œå’Œåˆ†æåºåˆ—ï¼Œè¿™ä¸ªå·¥å…·è¢«æˆä¸º\u003cstrong\u003eç”Ÿæˆå‡½æ•°\u003c/strong\u003eã€‚\u003c/p\u003e\n\u003ch2 id=\"ordinary-generating-functions\"\u003eOrdinary Generating Functions\u003c/h2\u003e\n\u003cp\u003eç»™å®šåºåˆ— $ \\{ a_{n} \\}_{n\\geq 0} $ï¼Œç”± $ \\{ a_{n} \\} $ å®šä¹‰çš„\u003cstrong\u003eæ™®é€šç”Ÿæˆå‡½æ•° (OGF)\u003c/strong\u003e ä¸ºï¼š\n$$ \n\nG(x) = \\sum_{n\\geq  0} a_{n}x^{n}\n\n $$\nè™½ç„¶çœ‹èµ·æ¥ OGF å¹¶æ²¡æœ‰è¢«å¾ˆå¥½çš„å®šä¹‰ï¼Œå¯¹äºå’ŒæŸäº›æ•°åˆ—ï¼Œè¿™ä¸ªå½¢å¼ä¸ä¼šæ”¶æ•›ï¼Œä½†æ˜¯å®é™…ä¸Šç”Ÿæˆå‡½æ•°å¹¶ä¸èƒ½è¢«çœ‹æˆä¸€ä¸ªçœŸæ­£çš„å‡½æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ª\u003cstrong\u003eå½¢å¼å¹‚çº§æ•°\u003c/strong\u003eï¼Œå¹¶ä¸”ä¸è¢«è¦æ±‚æ”¶æ•›ã€‚\u003c/p\u003e\n\u003cp\u003eä»¥ä¸‹æ˜¯ä¸€äº›ç”Ÿæˆå‡½æ•°çš„åŸºç¡€ä¾‹å­ï¼š\n$$ \n\nG(x) = 1+x+x^{2}+x^{3} +\\dots = \\dfrac{1}{1-x}\n\n $$\n$$ \n\nG(x) = 1+ax+a^{2}x^{2} + a^{3}x^{3} + \\dots = \\dfrac{1}{1-ax}\n\n $$\u003c/p\u003e\n\u003cp\u003eç»™å®šä¸€ä¸ªåºåˆ—ï¼Œå†™å‡ºä»–çš„ç”Ÿæˆå‡½æ•°æ˜¯å¾ˆå®¹æ˜“çš„ã€‚å°½ç®¡æ‰¾åˆ°ä»–çš„é—­åˆå½¢å¼ä¸å®¹æ˜“ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬ä¸éœ€è¦è¿™æ ·åšã€‚ç›¸åï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘ç»™å®šä¸€ä¸ªé—­åˆå½¢å¼ï¼Œéœ€è¦å¦‚ä½•çŸ¥é“å…¶å¯¹åº”çš„åºåˆ—ã€‚\u003c/p\u003e\n\u003cp\u003eæˆ‘ä»¬çº¦å®š $ [x^{n}]G(x) $ è¡¨ç¤ºç”Ÿæˆå‡½æ•°ä¸­ $ x^{n} $ çš„ç³»æ•°ã€‚\u003c/p\u003e","title":"Lect2-Generating Functions"},{"content":"Introduction æ¡ä»¶æ¦‚ç‡æŒ‡ä¸€ä¸ªäº‹ä»¶åœ¨å¦ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿçš„æ¡ä»¶ä¸‹å‘ç”Ÿçš„æ¦‚ç‡ï¼Œç”¨è®°å· $ \\mathbb{P}(A|B) $ è¡¨ç¤ºï¼Œä»…åœ¨ $ \\mathbb{P}(B)\u003e0 $ æ—¶æœ‰å®šä¹‰ï¼š $$ \\mathbb{P}(A|B) = \\dfrac{\\mathbb{P}(A \\cap B)}{P(B)} $$ å¯ä»¥å†™æˆ $$ \\mathbb{P}(A \\cap B) = \\mathbb{P}(B)\\cdot \\mathbb{P}(A|B) $$\nå¯¹äº $ n $ ä¸ªäº‹ä»¶ï¼Œè¿ç»­ä½¿ç”¨ä¸Šå¼ï¼Œå³å¯å¾—åˆ° $$ \\mathbb{P}\\left( \\bigcap_{i=1}^{n}A_{i} \\right) = \\prod_{k=1}^{n} \\mathbb{P}\\left( A_{k}\\bigg|\\bigcap_{i=1}^{k-1}A_{i} \\right) $$ è¿™ä¸ªå¼å­è¢«ç§°ä¸º é“¾å¼æ³•åˆ™ã€‚\nIndependence å¯¹äºäº‹ä»¶ $ A,B $ï¼Œå¦‚æœ $ \\mathbb{P}(A\\cap B)=\\mathbb{P}(A)\\mathbb{P}(B) $ï¼Œæˆ–è€…ç­‰ä»·åœ° $ \\mathbb{P}(A|B)=\\mathbb{P}(A) $ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§° $ A $ å’Œ $ B $ æ˜¯ç‹¬ç«‹çš„ã€‚è¿™è¡¨æ˜ $ A $ æˆ– $ B $ è‡ªå·±æ˜¯å¦å‘ç”Ÿå¯¹å¯¹æ–¹æ˜¯å¦å‘ç”Ÿæ²¡æœ‰å½±å“ã€‚\næ¨å¹¿åˆ° $ n $ ä¸ªäº‹ä»¶ä¸Šæœ‰ï¼šå¯¹äºäº‹ä»¶ $ A_{1},\\dots,A_{n} $ï¼Œå¦‚æœä»–ä»¬æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œè¯´æ˜å¯¹äºä»»æ„çš„ $ I\\subseteq[n] $ ï¼Œæœ‰ $$ \\mathbb{P}\\left( \\bigcap_{i\\in I}A_{i} \\right) = \\prod_{i\\in I}\\mathbb{P}(A)_{i} $$ è¿™ä¸ªå®šä¹‰éå¸¸å¼ºï¼Œå› ä¸ºå®ƒè¦æ±‚å¯¹äºæ‰€æœ‰çš„ $ I\\subseteq[n] $ éƒ½æˆç«‹ã€‚\nå¦‚æœæŠŠå®šä¹‰æ”¹æˆåªè¦æ±‚ $ I\\in \\binom{ [n] }{ 2 } $ï¼Œå¯ä»¥å¾—åˆ°ä¸¤ä¸¤ç‹¬ç«‹çš„å®šä¹‰ã€‚\nç›®å‰è¿™éƒ½æ˜¯å…³äºæœ‰é™é›†çš„å®šä¹‰ï¼Œå¯¹äºæ— ç©·å¤šä¸ªäº‹ä»¶ $ \\{ A_{j} \\}_{j\\in J} $ï¼ˆè¿™è¦æ±‚ $ J $ æ˜¯å¯æ•°é›†ï¼Œå¦åˆ™æ¦‚ç‡æ²¡æœ‰å®šä¹‰ï¼‰ï¼Œæˆ‘ä»¬è¯´å®ƒä»¬æ˜¯äº’ç›¸ç‹¬ç«‹çš„ï¼Œå½“ä¸”ä»…å½“å¯¹äº $ J $ çš„ä»»æ„ä¸€ä¸ªæœ‰é™å­é›† $ I $ï¼Œ$ \\{ A_{i} \\}_{i\\in I} $ ç›¸äº’ç‹¬ç«‹ã€‚\nLaw of Total Probability å‡è®¾äº‹ä»¶ $ B_{1},B_{2},\\dots,B_{n}\\in \\mathcal{F} $ æ„æˆäº†æ ·æœ¬ç©ºé—´çš„ä¸€ä¸ªåˆ’åˆ†ï¼Œå³ $ \\Omega=\\bigcup_{i=1}^{n}B_{i} $ å¹¶ä¸”å¯¹äº $ i\\neq j $ï¼Œæœ‰ $ B_{i}\\cap B_{j}=\\emptyset $ã€‚æ ¹æ®é›†åˆè®ºçš„çŸ¥è¯†ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å¯¼å‡ºå¯¹äºä»»æ„é›†åˆ $ A $ï¼Œ$ A\\cap B_{i} $ ä¹Ÿæ„æˆäº† $ A $ çš„ä¸€ä¸ªåˆ’åˆ†ã€‚å¦‚æœæˆ‘ä»¬å– $ A\\in\\mathcal{F} $ï¼Œæ ¹æ®æ¦‚ç‡è®ºå…¬ç†ï¼Œæˆ‘ä»¬æœ‰ $$ \\mathbb{P}(A) = \\mathbb{P}\\left( \\bigcup_{n\\geq 1}(A\\cap B_{n}) \\right) = \\sum_{n\\geq 1} \\mathbb{P}(A\\cap B_{i}) $$ è¿™å°±å¾—åˆ°äº† å…¨æ¦‚ç‡å…¬å¼ã€‚å†™æˆæ¡ä»¶æ¦‚ç‡çš„å½¢å¼ï¼Œå¯ä»¥å¾—åˆ° $$ \\mathbb{P}(A) = \\sum_{n\\geq 1}\\mathbb{P}(B_{n})\\mathbb{P}(A|B_{n}) $$\nSome Examples æ— é™æ‚–è®º å‡è®¾æœ‰æ— ç©·ä¸ªçƒï¼Œç”¨ $ k=1,2,\\dots $ æ¥ç¼–å·ï¼Œå¹¶æœ‰ä¸€ä¸ªæ— ç©·å¤§çš„ç®±å­ã€‚è€ƒå¯Ÿâ€œæ”¾çƒâ€å’Œâ€œæ‹¿çƒâ€çš„è¿‡ç¨‹ã€‚\næ”¾çƒè¿‡ç¨‹è¡¨è¿°ä¸ºï¼šå¯¹äº $ n=0,1,2,\\dots $ï¼Œåœ¨ 12 ç‚¹å‰çš„ $ 2^{-n} $ åˆ†é’Ÿæ”¾å…¥ç¼–å·ä¸º $ 10n+1,10n+2,\\dots,10(n+1) $ çš„çƒã€‚\næˆ‘ä»¬å†ä½¿ç”¨ä¸åŒçš„æ–¹å¼æŠŠçƒæ‹¿å‡ºæ¥ï¼ˆå‡è®¾æ‹¿å’Œæ”¾éƒ½åœ¨ç¬é—´å®Œæˆï¼‰ï¼š\n12 ç‚¹å‰ $ 2^{-n} $ åˆ†é’Ÿæ”¾å®Œçƒåï¼Œä»ç®±å­é‡Œæ‹¿å‡º $ 10(n+1) $ å·çƒã€‚\nè¿™ç§æƒ…å†µä¸‹ 12 ç‚¹æ—¶ç®±å­é‡Œä¼šæœ‰æ— ç©·çš„çƒï¼Œå› ä¸ºç¼–å·ä¸æ˜¯ 10 çš„å€æ•°çš„çƒéƒ½æ²¡æœ‰è¢«æ‹¿å‡ºæ¥ã€‚\n12 ç‚¹å‰ $ 2^{-n} $ åˆ†é’Ÿæ”¾å®Œçƒåï¼Œä»ç®±å­é‡Œæ‹¿å‡º $ (n+1) $ å·çƒã€‚\næ­¤æ—¶ 12 ç‚¹æ—¶ç®±å­é‡Œä¸€ä¸ªçƒéƒ½æ²¡æœ‰ï¼Œå› ä¸ºæ¯ä¸ªçƒéƒ½èƒ½æ‰¾åˆ°ä¸€ä¸ªå¯¹åº”çš„æ—¶åˆ»è¢«æ‹¿å‡ºæ¥ã€‚\næˆ‘ä»¬å¯ä»¥å‘ç°åŒæ ·æ˜¯æ‹¿ä¸€ä¸ªçƒï¼Œæœ€åçš„æ•ˆæœå±…ç„¶å®Œå…¨ä¸åŒã€‚æˆ‘ä»¬ç°åœ¨è€ƒè™‘ï¼Œå¦‚æœéšæœºæ‹¿å‡ºä¸€ä¸ªçƒåˆä¼šæ€ä¹ˆæ ·ï¼Ÿ\n12 ç‚¹å‰ $ 2^{-n} $ åˆ†é’Ÿæ”¾å®Œçƒåï¼Œä»ç®±å­é‡Œå‡åŒ€éšæœºåœ°æ‹¿å‡ºä¸€ä¸ªçƒã€‚\næˆ‘ä»¬è®¡ç®—æ¯ä¸ªçƒåœ¨ 12 ç‚¹çš„æ—¶å€™ç•™åœ¨ç®±å­é‡Œçš„æ¦‚ç‡ã€‚ä»¥ 1 å·çƒä¸ºä¾‹ï¼Œå…¶ä½™ç±»ä¼¼ã€‚å¯¹äºæ¯ä¸ª $ n $ï¼Œç”¨äº‹ä»¶ $ A_{n} $ è¡¨ç¤ºåœ¨ $ n $ è½®æ“ä½œå 1 å·çƒè¿˜åœ¨ç®±å­é‡Œè¿™ä¸ªäº‹ä»¶ã€‚æˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ˜¯ $$ A_{\\infty} := \\bigcap_{n\\geq 0}A_{n} = \\lim_{ n \\to \\infty } A_{n} $$ æ ¹æ®ä¸Šä¸€èŠ‚ä¸­æ¦‚ç‡æµ‹åº¦çš„è¿ç»­æ€§ï¼Œæˆ‘ä»¬æœ‰ $ \\mathbb{P}(\\lim_{ n \\to \\infty }A_{n})=\\lim_{ n \\to \\infty }\\mathbb{P}(A_{n}) $ã€‚å› æ­¤åªéœ€è¦è®¡ç®— $ \\mathbb{P}(A_{n}) $ å³å¯ã€‚æˆ‘ä»¬å†å®šä¹‰ä¸€ä¸ªäº‹ä»¶ $ B_{n} $ è¡¨ç¤ºç¬¬ $ n $ è½®æ‹¿å‡ºæ¥çš„ä¸æ˜¯ 1 å·çƒï¼Œåˆ™æœ‰ $ A_{n}=B_{0}\\cap B_{1}\\cap\\dots \\cap B_{n} $ã€‚ä½¿ç”¨é“¾å¼æ³•åˆ™ï¼Œå°±å¯ä»¥å¾—åˆ° $$ \\mathbb{P}(A_{n}) = \\mathbb{P}\\left( \\bigcap_{i=1}^{n}B_{i} \\right) = \\prod_{k=0}^{n}\\mathbb{P}\\left( B_{k}\\bigg|\\bigcap_{i\u003c k}B_{i} \\right) $$ å…¶ä¸­äº‹ä»¶ $ B_{k}|\\bigcap_{i\u003c k}B_{i} $ æœ‰éå¸¸æ˜æ˜¾çš„ç»„åˆæ„ä¹‰ï¼Œæ˜¾ç„¶è¿™ä¸ªæ¦‚ç‡æ˜¯ $ 1- \\dfrac{1}{9(k+1)+1} $ã€‚\nå› æ­¤ $$ \\mathbb{P}(A_{n}) = \\prod_{k=0}^{n} \\left( 1 - \\dfrac{1}{9(k+1)+1} \\right) \\leq e^{ -\\sum_{k=0}^{n} 1/(9k+10) } $$ ç”±äºçº§æ•° $ \\sum_{k=0}^{n} \\frac{1}{9k+10} $ å‘æ•£ï¼Œæ‰€ä»¥ $ \\lim_{ n \\to \\infty }\\mathbb{P}(A_{n})=0 $ï¼Œæ‰€ä»¥ 12 ç‚¹æ—¶ 1 å·çƒè¿˜åœ¨ç®±å­é‡Œçš„æ¦‚ç‡ $ \\mathbb{P}(S_{1}) $ ä¸º 0ã€‚ç±»ä¼¼åœ°ï¼Œè¿˜èƒ½å¾—åˆ°å…¶ä»–çƒçš„æ¦‚ç‡ $ \\mathbb{P}(S_{n})=0 $ã€‚æˆ‘ä»¬ç°åœ¨éœ€è¦çŸ¥é“ 12 ç‚¹æ—¶ç®±å­é‡Œè¿˜æœ‰çƒçš„æ¦‚ç‡ï¼Œå³ $ \\mathbb{P}(\\exists n \\subset \\mathbb{N},S_{n}) $ï¼Œåˆ©ç”¨ä¸Šä¸€å±Šçš„ union-boundï¼Œå¯ä»¥å¾—åˆ° $$ \\mathbb{P}(\\exists n \\subset \\mathbb{N},S_{n}) \\leq \\sum_{n\\geq 1}\\mathbb{P}(S_{n})=0 $$\nKarger æœ€å°å‰²ç®—æ³• ä¸€ä¸ªç»å…¸çš„é—®é¢˜æ˜¯æ±‚å›¾ä¸Šçš„æœ€å°å‰²ã€‚ç»™å®šä¸€ä¸ªè¿é€šæ— å‘å›¾ $ G(V,E) $ï¼Œæˆ‘ä»¬è¯´è¾¹é›† $ C \\subseteq E $ æ˜¯ä¸€ä¸ªå‰²ï¼Œå½“ä¸”ä»…å½“åˆ æ‰ $ C $ ä»¥åå‰©ä¸‹çš„ $ G(V,E\\setminus C) $ æ˜¯ä¸è¿é€šçš„ã€‚æˆ‘ä»¬éœ€è¦å¯»æ‰¾å›¾ä¸Šæœ€å°çš„ä¸€ä¸ªå‰²ã€‚\næˆ‘ä»¬åœ¨æ­¤å¤„è€ƒè™‘ç”¨ä¸€ä¸ªéšæœºç®—æ³•æ±‚è§£è¿™ä¸ªé—®é¢˜ã€‚\nå®šä¹‰å›¾ä¸Šçš„ç¼©è¾¹æ“ä½œï¼šç»™å®š $ e=\\{ u,v \\}\\in E $ï¼Œæˆ‘ä»¬å°† $ u,v $ åˆå¹¶æˆä¸€ä¸ªç‚¹ï¼Œå¹¶åˆ æ‰è¿™æ¡è¾¹ï¼ŒæŠŠç¼©å®Œä¹‹åçš„å›¾è®°ä¸º $ G / e $ã€‚ Kager ç®—æ³•çš„åŸç†éå¸¸ç®€å•ï¼Œä» $ G $ å‡ºå‘ï¼Œæ¯æ¬¡éšæœºé€‰æ‹©ä¸€æ¡è¾¹ï¼ŒæŠŠå®ƒç¼©æ‰ï¼Œé‡å¤æ‰§è¡Œ $ n-2 $ ä¹‹åå›¾é‡Œé¢å°±ä¼šåªå‰©ä¸‹ä¸¤ä¸ªç‚¹ï¼Œè¿™æ—¶æˆ‘ä»¬å†è¾“å‡ºæ‰€æœ‰å‰©ä¸‹çš„è¾¹ã€‚\nè¿™ä¸ªç®—æ³•â€œæœ‰å¯èƒ½â€è¾“å‡ºçœå´ç­”æ¡ˆçš„åŸç†æ˜¯ï¼Œç”±äºæˆ‘ä»¬å…³å¿ƒçš„æ˜¯â€æœ€å°â€çš„å‰²ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¯ä¸€æ­¥é€‰åˆ°å‰²ä¸­çš„è¾¹çš„æ¦‚ç‡å°±ä¸ä¼šå¤ªå¤§ã€‚ä¸ºäº†è°ˆè®ºè¿™ä¸ªæ¦‚ç‡ï¼Œæˆ‘ä»¬éœ€è¦é€‰æ‹©åˆé€‚çš„æ¦‚ç‡ç©ºé—´ã€‚ä¸€ä¸ªè‡ªç„¶çš„æƒ³æ³•æ˜¯é€‰æ‹©ç®—æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€æœ‰åˆ é™¤çš„è¾¹çš„åºåˆ—ä½œä¸ºæ ·æœ¬ç©ºé—´ã€‚\nè®¾ $ C $ æ˜¯ä¸€ä¸ªå›ºå®šçš„æœ€å°å‰²ï¼Œå¹¶ä¸”å…¶å¤§å°ä¸º $ k $ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—æœ€ç»ˆè¾“å‡º $ C $ çš„æ¦‚ç‡ã€‚è¿™éœ€è¦æˆ‘ä»¬æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€æ¬¡éƒ½æ²¡æœ‰é€‰åˆ° $ C $ ä¸­çš„è¾¹ã€‚æˆ‘ä»¬ç”¨ $ A_{k} $ æ¥è¡¨ç¤ºç¬¬ $ k $ æ¬¡æ‰§è¡Œå®Œç¼©è¾¹æ“ä½œåï¼Œ$ C $ ä¸­çš„ä»»æ„ä¸€æ¡è¾¹è¿˜æ²¡æœ‰è¢«åˆ æ‰çš„æ¦‚ç‡ã€‚\nä¸ºäº†åˆ†æ $ \\mathbb{P}(A_{k}) $ï¼ŒåŒç†ä¸Šä¸€ä¸ªä¾‹å­ä¸­çš„æƒ³æ³•ï¼Œæˆ‘ä»¬å®šä¹‰ $ B_{k} $ ä¸ºç¬¬ $ k $ æ¬¡ç¼©è¾¹é€‰æ‹©çš„ä¸æ˜¯ $ C $ ä¸­çš„è¾¹è¿™ä¸€äº‹ä»¶ï¼Œé‚£ä¹ˆæ˜¾ç„¶æœ‰ $ A_{k}=\\bigcap_{i=1}^{k}B_{i} $ï¼Œå› æ­¤æ ¹æ®é“¾å¼æ³•åˆ™ï¼Œæˆ‘ä»¬æœ‰ $$ \\mathbb{P}(\\text{output}=C) = \\mathbb{P}(A_{n-2}) = \\prod_{i=1}^{n-2}\\mathbb{P}\\left(B_{i}\\bigg| \\bigcap_{j=1}^{i-1}B_{j}\\right) $$ æˆ‘ä»¬éœ€è¦æ‰¾å‡ºä¸€ä¸ªè¿™ä¸ªæ¦‚ç‡çš„ä¸‹ç•Œã€‚æˆ‘ä»¬æƒ³è¦è¯´æ˜æ¯ä¸€è½®éƒ½æœ‰æ¯”è¾ƒå¤§çš„æ¦‚ç‡é€‰ä¸åˆ° $ C $ ä¸­çš„è¾¹ï¼Œç”±äºé€‰å–æ˜¯å‡åŒ€çš„ï¼Œæ‰€ä»¥åªéœ€è¦è¯æ˜åœ¨ç¬¬ $ i $ è½®ï¼Œå·²çŸ¥å‰ $ i-1 $ è½®éƒ½æ²¡æœ‰é€‰åˆ° $ C $ ä¸­çš„è¾¹çš„æƒ…å†µä¸‹ï¼Œå›¾ä¸­å‰©ä¸‹çš„è¾¹è¶³å¤Ÿå¤šå³å¯ã€‚\nä¸€ä¸ªé‡è¦çš„è§‚å¯Ÿæ˜¯ï¼Œæ­¤æ—¶å›¾ä¸­æ¯ä¸ªç‚¹çš„åº¦æ•°éƒ½ä¸å°äº $ k $ã€‚åŸå› æ˜¯ç”±äºç¼©è¾¹è¿™ç§æ“ä½œä¸ä¼šç ´åå‰²çš„æ€§è´¨ï¼Œå¦‚æœæœ‰ç‚¹çš„åº¦æ•°å°äº $ k $ï¼Œåœ¨åŸå›¾ä¸­ç›´æ¥å–è¿™äº›è¾¹å°±å¾—åˆ°äº†ä¸€ä¸ªå°äº $ k $ çš„å‰²ã€‚\næœ‰äº†è¿™ä¸ªè§‚å¯Ÿï¼Œæˆ‘ä»¬å°±çŸ¥é“åœ¨ç¬¬ $ i-1 $ è½®ï¼Œå‰©ä¸‹ $ n-i+1 $ ä¸ªé¡¶ç‚¹æ—¶ï¼Œè‡³å°‘è¿˜æœ‰ $ \\frac{k}{2}\\cdot(n-i+1) $ æ¡è¾¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æœ‰ $$ \\mathbb{P}\\left( B_{i}\\bigg|\\bigcap_{j=1}^{i-1}B_{j} \\right) \\geq 1 - \\dfrac{k}{\\frac{k}{2} \\cdot (n-i+1)} = \\dfrac{n-i-1}{n-i+1} $$ è¿™è¯´æ˜ $$ \\mathbb{P}(A_{n-2}) \\geq \\prod_{i=1}^{n-2} \\dfrac{n-i-1}{n-i+1} = \\dfrac{2}{n(n-1)} $$ å› æ­¤æˆ‘ä»¬çš„ç®—æ³•è‡³å°‘æœ‰ $ \\frac{2}{n(n-1)} $ çš„æ¦‚ç‡å¯ä»¥è¾“å‡º $ C $ã€‚å¦‚æœæˆ‘ä»¬é‡å¤è¿™ä¸ªç®—æ³• $ N=50n(n-1) $ æ¬¡ï¼Œå¹¶ä¸”è¾“å‡ºè¿™ä¹ˆå¤šæ¬¡ä¸­æ‰¾åˆ°çš„æœ€å°çš„å‰²ï¼Œé‚£ä¹ˆè¿™ä¸ªå‰²æ˜¯æœ€å°å‰²çš„æ¦‚ç‡è‡³å°‘æœ‰ $$ 1-\\left( 1- \\dfrac{2}{n(n-1)} \\right)^{N} \\geq 1 - e^{ -100 } $$ ä½¿ç”¨å¹¶æŸ¥é›†æ¥ç»´æŠ¤çš„è¯ï¼Œå¤æ‚åº¦å¤§çº¦ä¸º $ O(n^{2}m) $ã€‚\n","permalink":"https://diefish1024.github.io/posts/class-notes/math2701-probability-theory/lect3-conditional-probability/","summary":"\u003ch2 id=\"introduction\"\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eæ¡ä»¶æ¦‚ç‡æŒ‡ä¸€ä¸ªäº‹ä»¶åœ¨å¦ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿçš„æ¡ä»¶ä¸‹å‘ç”Ÿçš„æ¦‚ç‡ï¼Œç”¨è®°å· $ \\mathbb{P}(A|B) $ è¡¨ç¤ºï¼Œä»…åœ¨ $ \\mathbb{P}(B)\u003e0 $\næ—¶æœ‰å®šä¹‰ï¼š\n$$ \n\n\\mathbb{P}(A|B) = \\dfrac{\\mathbb{P}(A \\cap B)}{P(B)}\n\n $$\nå¯ä»¥å†™æˆ\n$$ \n\n\\mathbb{P}(A \\cap B) = \\mathbb{P}(B)\\cdot \\mathbb{P}(A|B)\n\n $$\u003c/p\u003e\n\u003cp\u003eå¯¹äº $ n $ ä¸ªäº‹ä»¶ï¼Œè¿ç»­ä½¿ç”¨ä¸Šå¼ï¼Œå³å¯å¾—åˆ°\n$$ \n\n\\mathbb{P}\\left( \\bigcap_{i=1}^{n}A_{i} \\right) = \\prod_{k=1}^{n} \\mathbb{P}\\left( A_{k}\\bigg|\\bigcap_{i=1}^{k-1}A_{i} \\right)\n\n $$\nè¿™ä¸ªå¼å­è¢«ç§°ä¸º \u003ca href=\"https://en.wikipedia.org/wiki/Chain_rule_(probability)\"\u003eé“¾å¼æ³•åˆ™\u003c/a\u003eã€‚\u003c/p\u003e\n\u003ch2 id=\"independence\"\u003eIndependence\u003c/h2\u003e\n\u003cp\u003eå¯¹äºäº‹ä»¶ $ A,B $ï¼Œå¦‚æœ $ \\mathbb{P}(A\\cap B)=\\mathbb{P}(A)\\mathbb{P}(B) $ï¼Œæˆ–è€…ç­‰ä»·åœ° $ \\mathbb{P}(A|B)=\\mathbb{P}(A) $ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§° $ A $ å’Œ $ B $ æ˜¯ç‹¬ç«‹çš„ã€‚è¿™è¡¨æ˜ $ A $ æˆ– $ B $ è‡ªå·±æ˜¯å¦å‘ç”Ÿå¯¹å¯¹æ–¹æ˜¯å¦å‘ç”Ÿæ²¡æœ‰å½±å“ã€‚\u003c/p\u003e","title":"Lect3-Conditional Probability"},{"content":"Motivation ä¾‹é¢˜ï¼šåœ¨åœ†ä¸Šâ€œéšæœºâ€é€‰ä¸€æ®µå¼§ï¼Œé—®å¼§é•¿å¤§äºåœ†å‘¨çš„ $ \\frac{1}{3} $ çš„æ¦‚ç‡ï¼Ÿï¼ˆBertrand paradoxï¼‰\nè‡³å°‘ä¸‰ç§è‡ªç„¶çš„â€œå‡åŒ€åŒ–â€æ¨¡å‹ä¼šç»™å‡ºä¸åŒç­”æ¡ˆï¼š\nå¯¹å¼§é•¿å‚æ•°å‡åŒ€ï¼ˆåœ¨ $ [0, 2\\pi) $ ä¸Šå‡åŒ€å–é•¿åº¦ï¼Œå†éšæœºèµ·ç‚¹ï¼‰ã€‚ å¯¹ç«¯ç‚¹åœ¨åœ†ä¸Šç‹¬ç«‹å‡åŒ€ï¼ˆç­‰ä»·äºéšæœºä¸¤ç‚¹ç¡®å®šå¼§ï¼Œéœ€æŒ‡å®šå–è¾ƒçŸ­æˆ–è¾ƒé•¿å¼§ï¼‰ã€‚ å¯¹ä¸­å¿ƒè§’æˆ–å‡ ä½•æ„é€ çš„ä¸­é—´é‡å‡åŒ€ï¼ˆå¦‚å‡åŒ€é€‰è§’åº¦åè£å‰ªï¼‰ã€‚ æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•å®šä¹‰â€œéšæœºâ€ï¼Ÿä¸åŒâ€œéšæœºåŒ–â€æ–¹æ¡ˆå¯¼è‡´ä¸åŒç­”æ¡ˆã€‚\nè®¨è®ºæ¦‚ç‡é—®é¢˜å¿…é¡»å…ˆæ˜ç¡®æ¦‚ç‡ç©ºé—´ï¼ˆæ ·æœ¬ç©ºé—´ã€äº‹ä»¶æ—ä¸æ¦‚ç‡æµ‹åº¦ï¼‰ï¼Œå¦åˆ™â€œæ¦‚ç‡â€æ— ä»è°ˆèµ·ã€‚\nProbability Space ä¸€ä¸ªæ¦‚ç‡ç©ºé—´ç”±ä¸‰å…ƒç»„ $ (\\Omega, \\mathcal{F}, \\mathbb{P}) $ æ„æˆï¼š\n$ \\Omega $ï¼šæ ·æœ¬ç©ºé—´ï¼ˆä¸€æ¬¡éšæœºè¯•éªŒæ‰€æœ‰å¯èƒ½ç»“æœï¼‰ã€‚ $ \\mathcal{F} \\subseteq 2^{\\Omega} $ï¼šäº‹ä»¶æ—ï¼ˆå…è®¸è®¨è®ºä¸è¿ç®—çš„é›†åˆï¼‰ã€‚ $ \\mathbb{P} : \\mathcal{F} \\to [0,1] $ï¼šæ¦‚ç‡æµ‹åº¦ï¼ˆèµ‹äºˆäº‹ä»¶æ¦‚ç‡ï¼‰ã€‚ è®°å·è¯´æ˜ï¼š\n$ \\Omega $ï¼šæ ·æœ¬ç©ºé—´ã€‚ $ 2^{\\Omega} $ï¼š$ \\Omega $ çš„å¹‚é›†ï¼ˆæ‰€æœ‰å­é›†çš„é›†åˆï¼‰ã€‚ ä¸ºä»€ä¹ˆ $ \\mathbb{P} $ è¦å®šä¹‰åœ¨ $ \\mathcal{F} $ ä¸Šè€Œéç›´æ¥åœ¨ $ \\Omega $ ä¸Šï¼Ÿ\nç¦»æ•£å¯æ•°æ—¶ï¼Œå– $ \\mathcal{F} = 2^{\\Omega} $ å¯è¡Œï¼Œä¸”å¯¹å•ç‚¹èµ‹å€¼å³å¯ç¡®å®šæ‰€æœ‰äº‹ä»¶çš„æ¦‚ç‡ã€‚ è¿ç»­æ—¶ä¸åŒï¼šå•ç‚¹çš„æ¦‚ç‡é€šå¸¸ä¸º $ 0 $ï¼Œä½†ä¸å¯æ•°å¹¶å¯æœ‰æ­£æ¦‚ç‡ï¼›ä¸” $ 2^{\\Omega} $ ä¸­å­˜åœ¨ä¸å¯æµ‹é›†åˆï¼Œæ— æ³•ä¸€è‡´èµ‹å€¼ï¼ˆè§ä¸‹æ–‡ Vitali set ä¸ Axiom of Choiceï¼‰ã€‚å› æ­¤éœ€é€‰æ‹©ä¸€ä¸ªè¶³å¤Ÿå¤§åˆå¯æ§çš„ $ \\sigma $- ä»£æ•°ä½œä¸ºäº‹ä»¶æ—ã€‚ Sigma-Algebra è¦æ±‚ $ \\mathcal{F} $ æ„æˆä¸€ä¸ª $ \\sigma $- ä»£æ•°ï¼ˆåŸŸï¼‰ï¼š\n$ \\emptyset \\in \\mathcal{F},\\ \\Omega \\in \\mathcal{F} $ã€‚ è‹¥ $ A \\in \\mathcal{F} $ï¼Œåˆ™å…¶è¡¥é›† $ A^{c} \\in \\mathcal{F} $ã€‚ è‹¥ $ A_{1}, A_{2}, \\dots \\in \\mathcal{F} $ï¼Œåˆ™å¯æ•°å¹¶ $ \\bigcup_{n \\ge 1} A_{n} \\in \\mathcal{F} $ã€‚ æ³¨ï¼šç”±å¾·æ‘©æ ¹å¾‹å¾—å¯æ•°äº¤å°é—­ã€‚ â€œ$ \\sigma $â€è¡¨ç¤ºå¯¹å¯æ•°å¹¶å°é—­ã€‚\nç›´è§‰ï¼šè¿™äº›å°é—­æ€§ä¿è¯æˆ‘ä»¬åšå¸¸è§çš„äº‹ä»¶è¿ç®—ä¸â€œè·‘å‡ºâ€å¯æµ‹èŒƒå›´ã€‚\nProbability Measure æ¦‚ç‡æµ‹åº¦ $ \\mathbb{P} : \\mathcal{F} \\to [0,1] $ æ»¡è¶³ï¼š è§„èŒƒåŒ–ï¼š$ \\mathbb{P}(\\emptyset) = 0,\\ \\mathbb{P}(\\Omega) = 1 $ã€‚ è¡¥é›†å…³ç³»ï¼šå¯¹ä»»æ„ $ A \\in \\mathcal{F} $ï¼Œ$ \\mathbb{P}(A) = 1 - \\mathbb{P}(A^{c}) $ã€‚ å¯æ•°å¯åŠ æ€§ï¼ˆå¯¹ä¸¤ä¸¤ä¸äº¤ï¼‰ï¼šè‹¥ $ A_{i} \\cap A_{j} = \\emptyset $ï¼ˆ$ i \\neq j $ï¼‰ï¼Œåˆ™ $$ \\mathbb{P}\\Big( \\bigcup_{n \\ge 1} A_{n} \\Big) = \\sum_{n \\ge 1} \\mathbb{P}(A_{n}) $$ è‹¥ $ \\Omega $ å¯æ•°ä¸” $ \\mathcal{F} = 2^{\\Omega} $ï¼Œè®° $ p_{\\omega} := \\mathbb{P}(\\{\\omega\\}) $ï¼Œåˆ™ä»»æ„ $ A \\subseteq \\Omega $ æ»¡è¶³ $$ \\mathbb{P}(A) = \\sum_{\\omega \\in A} p_{\\omega} $$\nSet Operations and Event Semantics é›†åˆâ€”äº‹ä»¶å¯¹åº”ï¼š\n$ A $ï¼šäº‹ä»¶ $ A $ å‘ç”Ÿã€‚ $ A \\cup B $ï¼šè‡³å°‘ä¸€ä¸ªå‘ç”Ÿã€‚ $ A \\cap B $ï¼šåŒæ—¶å‘ç”Ÿã€‚ $ A \\setminus B $ï¼š$ A $ ä¸”ä¸ $ B $ã€‚ $ A \\subseteq B $ï¼š$ A $ è•´å« $ B $ã€‚ $ A \\cap B = \\emptyset $ï¼šä¸èƒ½åŒæ—¶å‘ç”Ÿã€‚ $ A \\cup B = \\Omega $ï¼šå¿…æœ‰ä¸€ä¸ªå‘ç”Ÿã€‚ è¿™äº›æ“ä½œåœ¨ $ \\mathcal{F} $ å†…å°é—­ï¼ˆç”± $ \\sigma $- ä»£æ•°æ€§è´¨å’Œå¾·æ‘©æ ¹å¾‹ï¼‰ã€‚\nInclusionâ€“Exclusion and Union Bound å•è°ƒæ€§ï¼šè‹¥ $ A \\subseteq B $ï¼Œåˆ™ $ \\mathbb{P}(A) \\le \\mathbb{P}(B) $ã€‚ è¯ï¼šå†™ $ B = A \\cup (B \\setminus A) $ï¼Œå¹¶ä¸ºä¸äº¤ï¼Œæ•… $ \\mathbb{P}(B) = \\mathbb{P}(A) + \\mathbb{P}(B \\setminus A) \\ge \\mathbb{P}(A) $.\näºŒé›†åˆå®¹æ–¥ï¼š $$ \\mathbb{P}(A \\cup B) = \\mathbb{P}(A) + \\mathbb{P}(B) - \\mathbb{P}(A \\cap B) $$\nå¹¶ç•Œï¼ˆunion bound, Boole ä¸ç­‰å¼ï¼‰ï¼š $$ \\mathbb{P}\\Big( \\bigcup_{n} A_{n} \\Big) \\le \\sum_{n} \\mathbb{P}(A_{n}) $$\nLimits of Events é›†åˆåºåˆ—çš„æé™ï¼š è‹¥ $ A_{1} \\subseteq A_{2} \\subseteq \\cdots $ï¼Œåˆ™ $$ \\lim_{n \\to \\infty} A_{n} = \\bigcup_{n \\ge 1} A_{n} $$ è‹¥ $ A_{1} \\supseteq A_{2} \\supseteq \\cdots $ï¼Œåˆ™ $$ \\lim_{n \\to \\infty} A_{n} = \\bigcap_{n \\ge 1} A_{n} $$ æµ‹åº¦çš„â€œè¿ç»­æ€§â€ï¼ˆæé™ä¸æµ‹åº¦äº¤æ¢ï¼‰ï¼š è‹¥ $ A_{n} \\uparrow $ï¼Œåˆ™ $ \\mathbb{P}(\\lim A_{n}) = \\lim\\limits_{n \\to \\infty} \\mathbb{P}(A_{n}) $ã€‚ è‹¥ $ A_{n} \\downarrow $ï¼Œåˆ™ $ \\mathbb{P}(\\lim A_{n}) = \\lim\\limits_{n \\to \\infty} \\mathbb{P}(A_{n}) $ã€‚ é€’å¢æƒ…å½¢ç”¨ä¸äº¤åˆ†è§£ä¸å¯æ•°å¯åŠ æ€§ï¼›é€’å‡æƒ…å½¢ç”¨å¾·æ‘©æ ¹å¾‹è½¬åŒ–ã€‚ è¯ï¼š\nåªè¯æ˜é€’å¢ï¼ˆéé™ï¼‰çš„æƒ…å½¢ã€‚\nä½¿ç”¨æé™çš„å®šä¹‰ï¼Œæœ‰ï¼ˆç±»æ¯”è£‚é¡¹ï¼‰ $$ \\mathbb{P}(\\lim_{ n \\to \\infty } A_{n}) = \\mathbb{P}\\left( \\bigcup_{n\\geq 1}A_{n} \\right) = \\mathbb{P}\\left( A_{1} \\cup \\bigcup_{n\\geq\t2}(A_{n}\\setminus A_{n-1}) \\right) $$ äºæ˜¯å°±æŠŠ $ \\lim_{ n \\to \\infty }A_{n} $ å†™æˆäº†ä¸€å †ä¸äº¤é›†åˆçš„å¹¶ï¼Œé‚£ä¹ˆæ ¹æ® $ \\mathbb{P} $ çš„ç¬¬ä¸‰æ¡å…¬ç†ï¼Œå¯ä»¥å¾—åˆ° $$ \\mathbb{P}(\\lim_{ n \\to \\infty } A_{n}) = \\mathbb{P}(A_{1}) + \\sum_{n\\geq 2}\\mathbb{P}(A_{n}\\setminus A_{n-1}) = \\mathbb{P}(A_{1}) + \\lim_{ N \\to \\infty } \\sum_{n=2}^{N} (\\mathbb{P}(A_{n})- \\mathbb{P}(A_{n-1})) = \\lim_{ n \\to \\infty } \\mathbb{P}(A_{n}) $$\nWhy Not Take All Subsets? å…³äºå‰é¢æåˆ°çš„ä¸ºä»€ä¹ˆäº‹ä»¶é›† $ \\mathcal{F} $ ä¸èƒ½ç›´æ¥ç­‰äº $ 2^{\\Omega} $ çš„é—®é¢˜ï¼Œåœ¨è¿™é‡Œç»™å‡ºä¸€ä¸ªè¯æ˜ã€‚\nè€ƒè™‘é—®é¢˜ï¼Œå¦‚ä½•åœ¨ $ \\Omega = [0,1) $ ä¸Šå®šä¹‰â€œå‡åŒ€åˆ†å¸ƒâ€ $ \\mathbb{P} $ ï¼Ÿ\nç›´è§‰è¦æ±‚ï¼š\né•¿åº¦ä¸€è‡´æ€§ï¼šå¯¹åŒºé—´ $ (a,b) \\subset [0,1) $ï¼Œ$ \\mathbb{P}((a,b)) = b - a $ã€‚ å¹³ç§»ä¸å˜æ€§ï¼šå¯¹ä»»æ„ $ I \\subset [0,1) $ ä¸ $ r \\in [0,1) $ï¼Œæœ‰ $ \\mathbb{P}(I) = \\mathbb{P}(I + r) $ï¼Œå…¶ä¸­ $ I + r = \\{ (x + r) \\bmod 1 : x \\in I \\} $ã€‚ Vitali setï¼ˆä½¿ç”¨ Axiom of Choiceï¼‰è¡¨æ˜ï¼šè‹¥ä»¤ $ \\mathcal{F} = 2^{[0,1)} $ï¼Œå¹¶è¦æ±‚ä¸Šé¢ä¸¤æ¡ä¸ $ \\sigma $- å¯åŠ æ€§ï¼Œåˆ™äº§ç”ŸçŸ›ç›¾ï¼šï¼ˆè¯æ˜ç”¨åˆ°æœ‰ç†æ•°é›†çš„ä»€ä¹ˆæ€§è´¨ï¼Ÿä¸ºä»€ä¹ˆä¸€å®šè¦é€šè¿‡æœ‰ç†æ•°ï¼Ÿï¼‰\nå®šä¹‰ç­‰ä»·å…³ç³» $ x \\sim y \\iff x - y \\in \\mathbb{Q} $ï¼Œå°† $ [0,1) $ åˆ’åˆ†ä¸ºç­‰ä»·ç±»ã€‚ ç”¨ Axiom of Choice ä»æ¯ä¸ªç­‰ä»·ç±»é€‰ä¸€ä»£è¡¨ï¼Œå¾—é›†åˆ $ N $ã€‚ å¯¹æ¯ä¸ª $ r \\in \\mathbb{Q} \\cap [0,1) $ï¼Œä»¤ $ N_{r} := N + r = \\{ (x+r) \\bmod 1: x \\in N\\} $ï¼Œå¯è¯ $ \\{ N_{r} \\} $ ä¸¤ä¸¤ä¸äº¤ï¼ˆåè¯æ³•ï¼‰ä¸”å¹¶ä¸º $ [0,1) $ çš„å¹³ç§»å‰¯æœ¬è¦†ç›–ã€‚ å¯æ•°å¯åŠ æ€§ä¸å¹³ç§»ä¸å˜æ€§ç»™å‡º $$ 1 = \\mathbb{P}([0,1)) = \\sum_{r} \\mathbb{P}(N_{r}) = \\sum_{r} \\mathbb{P}(N) $$ è‹¥ $ \\mathbb{P}(N) = 0 $ï¼Œå³ç«¯ä¸º $ 0 $ï¼›è‹¥ $ \\mathbb{P}(N) \u003e 0 $ï¼Œå³ç«¯ä¸º $ +\\infty $ï¼Œå‡çŸ›ç›¾ã€‚ ç»“è®ºï¼š$ 2^{[0,1)} $ ä¸­å­˜åœ¨ä¸å¯æµ‹é›†åˆï¼Œæ— æ³•ä¸€è‡´èµ‹äºˆæ¦‚ç‡ã€‚ æ­£ç¡®åšæ³•ï¼šå–æœ€å°ä¸”è¶³å¤Ÿçš„ $ \\sigma $- ä»£æ•°ï¼ˆBorel $ \\sigma $- ä»£æ•°ï¼‰\nä»¤ $ \\mathcal{F} $ ä¸ºåŒ…å«æ‰€æœ‰å¼€åŒºé—´çš„æœ€å° $ \\sigma $- ä»£æ•°ï¼ˆBorelï¼‰ã€‚ åœ¨è¯¥ $ \\mathcal{F} $ ä¸Šå­˜åœ¨ä¸é•¿åº¦ä¸€è‡´ä¸”å¹³ç§»ä¸å˜çš„æµ‹åº¦ï¼ˆå‹’è´æ ¼æµ‹åº¦åœ¨ $ [0,1) $ çš„é™åˆ¶ï¼‰ï¼Œä»è€Œå¾—åˆ°æœŸæœ›çš„â€œå‡åŒ€åˆ†å¸ƒâ€ã€‚ Discrete vs Continuous ç¦»æ•£å¯æ•°ï¼š å¯å– $ \\mathcal{F} = 2^{\\Omega} $ï¼Œå¯¹å•ç‚¹èµ‹å€¼ï¼ˆè´¨é‡å‡½æ•°ï¼‰å³å¯å†³å®šæ‰€æœ‰äº‹ä»¶çš„æ¦‚ç‡ã€‚ è¿ç»­ä¸å¯æ•°ï¼š å•ç‚¹æ¦‚ç‡å¸¸ä¸º $ 0 $ï¼Œä½†ä¸å¯æ•°å¹¶å¯å¾—æ­£æ¦‚ç‡ï¼›ä¸å¯æµ‹é›†åˆé˜»æ­¢æˆ‘ä»¬å°† $ \\mathcal{F} $ å–ä¸º $ 2^{\\Omega} $ã€‚å¿…é¡»é€‰å–å¦‚ Borelï¼ˆæˆ–å…¶å®Œå¤‡åŒ–ï¼‰è¿™æ ·çš„â€œå¯æµ‹â€ç»“æ„ã€‚ Summary æ¦‚ç‡è®ºä»¥ $ (\\Omega, \\mathcal{F}, \\mathbb{P}) $ ä¸ºåŸºç¡€å¯¹è±¡ã€‚â€œéšæœºâ€çš„è¯­ä¹‰ç”±æ­¤ä¸‰å…ƒç»„ç²¾ç¡®å®šä¹‰ã€‚ $ \\sigma $- ä»£æ•°çš„å¯æ•°å°é—­æ€§ä¸æµ‹åº¦çš„å¯æ•°å¯åŠ æ€§æ˜¯æŠ€æœ¯ä¸ç›´è§‰çš„ç»Ÿä¸€ï¼›å®ƒä»¬ä¿è¯å¸¸è§äº‹ä»¶è¿ç®—ä¸æé™æ“ä½œçš„å¯ç”¨æ€§ã€‚ å¹¶ç•Œä¸å®¹æ–¥æ˜¯ä¼°ç®—å¤æ‚äº‹ä»¶æ¦‚ç‡çš„å¸¸ç”¨å·¥å…·ã€‚ åœ¨ä¸å¯æ•°ç©ºé—´ï¼ŒAxiom of Choice å¯¼è‡´ä¸å¯æµ‹é›†åˆçš„å­˜åœ¨ï¼Œè§£é‡Šäº†ä¸ºä½•ä¸èƒ½å– $ \\mathcal{F} = 2^{\\Omega} $. ","permalink":"https://diefish1024.github.io/posts/class-notes/math2701-probability-theory/lect2-probability-space/","summary":"\u003ch2 id=\"motivation\"\u003eMotivation\u003c/h2\u003e\n\u003cp\u003eä¾‹é¢˜ï¼šåœ¨åœ†ä¸Šâ€œéšæœºâ€é€‰ä¸€æ®µå¼§ï¼Œé—®å¼§é•¿å¤§äºåœ†å‘¨çš„ $ \\frac{1}{3} $ çš„æ¦‚ç‡ï¼Ÿï¼ˆ\u003ca href=\"https://en.wikipedia.org/wiki/Bertrand_paradox_(probability)\"\u003eBertrand paradox\u003c/a\u003eï¼‰\u003c/p\u003e\n\u003cp\u003eè‡³å°‘ä¸‰ç§è‡ªç„¶çš„â€œå‡åŒ€åŒ–â€æ¨¡å‹ä¼šç»™å‡ºä¸åŒç­”æ¡ˆï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eå¯¹å¼§é•¿å‚æ•°å‡åŒ€ï¼ˆåœ¨ $ [0, 2\\pi) $ ä¸Šå‡åŒ€å–é•¿åº¦ï¼Œå†éšæœºèµ·ç‚¹ï¼‰ã€‚\u003c/li\u003e\n\u003cli\u003eå¯¹ç«¯ç‚¹åœ¨åœ†ä¸Šç‹¬ç«‹å‡åŒ€ï¼ˆç­‰ä»·äºéšæœºä¸¤ç‚¹ç¡®å®šå¼§ï¼Œéœ€æŒ‡å®šå–è¾ƒçŸ­æˆ–è¾ƒé•¿å¼§ï¼‰ã€‚\u003c/li\u003e\n\u003cli\u003eå¯¹ä¸­å¿ƒè§’æˆ–å‡ ä½•æ„é€ çš„ä¸­é—´é‡å‡åŒ€ï¼ˆå¦‚å‡åŒ€é€‰è§’åº¦åè£å‰ªï¼‰ã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eæ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•å®šä¹‰â€œéšæœºâ€ï¼Ÿä¸åŒâ€œéšæœºåŒ–â€æ–¹æ¡ˆå¯¼è‡´ä¸åŒç­”æ¡ˆã€‚\u003c/p\u003e\n\u003cp\u003eè®¨è®ºæ¦‚ç‡é—®é¢˜å¿…é¡»å…ˆæ˜ç¡®æ¦‚ç‡ç©ºé—´ï¼ˆæ ·æœ¬ç©ºé—´ã€äº‹ä»¶æ—ä¸æ¦‚ç‡æµ‹åº¦ï¼‰ï¼Œå¦åˆ™â€œæ¦‚ç‡â€æ— ä»è°ˆèµ·ã€‚\u003c/p\u003e\n\u003ch2 id=\"probability-space\"\u003eProbability Space\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eä¸€ä¸ªæ¦‚ç‡ç©ºé—´ç”±ä¸‰å…ƒç»„ $ (\\Omega, \\mathcal{F}, \\mathbb{P}) $ æ„æˆï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e$ \\Omega $ï¼šæ ·æœ¬ç©ºé—´ï¼ˆä¸€æ¬¡éšæœºè¯•éªŒæ‰€æœ‰å¯èƒ½ç»“æœï¼‰ã€‚\u003c/li\u003e\n\u003cli\u003e$ \\mathcal{F} \\subseteq 2^{\\Omega} $ï¼šäº‹ä»¶æ—ï¼ˆå…è®¸è®¨è®ºä¸è¿ç®—çš„é›†åˆï¼‰ã€‚\u003c/li\u003e\n\u003cli\u003e$ \\mathbb{P} : \\mathcal{F} \\to [0,1] $ï¼šæ¦‚ç‡æµ‹åº¦ï¼ˆèµ‹äºˆäº‹ä»¶æ¦‚ç‡ï¼‰ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eè®°å·è¯´æ˜ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e$ \\Omega $ï¼šæ ·æœ¬ç©ºé—´ã€‚\u003c/li\u003e\n\u003cli\u003e$ 2^{\\Omega} $ï¼š$ \\Omega $ çš„å¹‚é›†ï¼ˆæ‰€æœ‰å­é›†çš„é›†åˆï¼‰ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eä¸ºä»€ä¹ˆ $ \\mathbb{P} $ è¦å®šä¹‰åœ¨ $ \\mathcal{F} $ ä¸Šè€Œéç›´æ¥åœ¨ $ \\Omega $ ä¸Šï¼Ÿ\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eç¦»æ•£å¯æ•°æ—¶ï¼Œå– $ \\mathcal{F} = 2^{\\Omega} $ å¯è¡Œï¼Œä¸”å¯¹å•ç‚¹èµ‹å€¼å³å¯ç¡®å®šæ‰€æœ‰äº‹ä»¶çš„æ¦‚ç‡ã€‚\u003c/li\u003e\n\u003cli\u003eè¿ç»­æ—¶ä¸åŒï¼šå•ç‚¹çš„æ¦‚ç‡é€šå¸¸ä¸º $ 0 $ï¼Œä½†ä¸å¯æ•°å¹¶å¯æœ‰æ­£æ¦‚ç‡ï¼›ä¸” $ 2^{\\Omega} $ ä¸­å­˜åœ¨ä¸å¯æµ‹é›†åˆï¼Œæ— æ³•ä¸€è‡´èµ‹å€¼ï¼ˆè§ä¸‹æ–‡ Vitali set ä¸ Axiom of Choiceï¼‰ã€‚å› æ­¤éœ€é€‰æ‹©ä¸€ä¸ª\u003cstrong\u003eè¶³å¤Ÿå¤§åˆå¯æ§\u003c/strong\u003eçš„ $ \\sigma $- ä»£æ•°ä½œä¸ºäº‹ä»¶æ—ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"sigma-algebra\"\u003eSigma-Algebra\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eè¦æ±‚ $ \\mathcal{F} $ æ„æˆä¸€ä¸ª $ \\sigma $- ä»£æ•°ï¼ˆåŸŸï¼‰ï¼š\u003c/p\u003e","title":"Lect2-Probability Space"},{"content":"Problem 1 (1)\næ±‚ $$ \\sum_{k=0}^{n} \\binom{ 2n }{ 2k } $$\nè§£\n$$ \\begin{align*} \u0026 \\sum_{k=0}^{n} (-1)^{k}\\binom{ n }{ k } = 0 \\\\ \\implies \u0026 \\sum_{k=0}^{2n} (-1)^{k}\\binom{ 2n }{ k } =0 \\\\ \\implies \u0026 \\sum_{k=0}^{2n} \\binom{ 2n }{ 2k } = \\sum_{k=1}^{2n} \\binom{ 2n }{ 2k - 1 } \\end{align*} $$ åŒæ—¶ç”±äº $$ \\sum_{k=0}^{2n} \\binom{ 2n }{ 2k } + \\sum_{k=1}^{2n} \\binom{ 2n }{ 2k - 1 } = \\sum_{k=0}^{2n} \\binom{ 2n }{ k } = 2^{2n} $$ å¾—åˆ° $$ \\sum_{k=0}^{2n} \\binom{ 2n }{ 2k } = 2^{2n-1} $$\n(2)\næ±‚ $$ \\sum_{k=0}^{3n} \\binom{ 3n }{ 3k } $$\nè§£\nåŒç† (1) çš„è§£æ³•ï¼Œè®¾ $ z $ ä¸ºä¸€ä¸ªä¸‰æ¬¡å•ä½æ ¹ï¼Œé‚£ä¹ˆæ ¹æ®äºŒé¡¹å¼å®šç†æœ‰ $$ \\sum_{k=0}^{n} z^{k}\\binom{ n }{ k } = (1 + z)^{n} $$ é‚£ä¹ˆè®¾ $ \\sum_{k=0}^{3n}\\binom{ 3n }{ 3k }=A,\\,\\sum_{k=0}^{3n-1}\\binom{ 3n }{ 3k+1 }=B,\\,\\sum_{k=0}^{3n-1}\\binom{ 3n }{ 3k+2 }=C $ï¼Œå°±èƒ½å¾—åˆ° $$ A + z\\cdot B + z^{2}\\cdot C = (1 + z)^{3n} $$\nè®¾ $ \\omega=e^{ \\frac{2\\pi i}{3} } $ ï¼Œåˆ™æœ‰ $ 1+\\omega+\\omega^{2}=0,\\omega^{3}=1 $. åˆ†åˆ«ä»¤ $ z \\in \\{ 1,\\omega,\\omega^{2} \\} $ å¸¦å…¥ä¸Šå¼ï¼Œå¾—åˆ° $$ \\begin{cases} A + B + C \u0026 = (1+1)^{3n} \\\\ A + \\omega B + \\omega^{2}C \u0026 = (1+\\omega)^{3n} \\\\ A + \\omega^{2}B + \\omega C \u0026 = (1 + \\omega^{2})^{3n} \\end{cases} $$ å°†ä¸‰å¼ç›¸åŠ å¹¶åˆ©ç”¨ $ 1+\\omega+\\omega^{2}=0 $ çš„æ€§è´¨ï¼Œç§»é¡¹å³å¯å¾—åˆ° $$ A = \\dfrac{2^{3n} + (1+\\omega)^{3n} + (1+\\omega^{2})^{3n}}{3} $$ å¸¦å…¥ $ \\omega=-\\dfrac{1}{2}+\\dfrac{\\sqrt{ 3 }}{2}\\cdot i $ å¾—åˆ° $ 1+\\omega=e^{ \\frac{\\pi i}{3} },1+\\omega^{2}=e^{ - \\frac{\\pi i}{3} } $ ï¼Œå¸¦å…¥ä¸Šå¼å¹¶åŒ–ç®€å¯å¾— $$ \\sum_{k=0}^{n} \\binom{ 3n }{ 3k } = \\dfrac{2^{3n} + 2(-1)^{n}}{3} $$\nProblem 2 (1) $$ \\binom{ n }{ m } \\binom{ m }{ k } = \\binom{ n }{ k } \\binom{ n-k }{ m-k } $$ è¯ 1\nè€ƒè™‘å·¦å³ä¸¤è¾¹ç»„åˆæ„ä¹‰ï¼š\n$ \\binom{ n }{ m }\\binom{ m }{ k } $ å¯ä»¥è¡¨ç¤ºåœ¨ $ n $ ä¸ªäººä¸­å…ˆé€‰å‡º $ m $ ä¸ªäººï¼Œå†åœ¨è¿™ $ m $ ä¸ªäººä¸­é€‰å‡º $ k $ ä¸ªäººçš„æ¦‚ç‡ï¼Œæœ¬è´¨ä¸Šæ˜¯æŠŠ $ n $ ä¸ªäººåˆ†æˆäº† $ 3 $ ç±»ï¼Œæ¯ç±»åˆ†åˆ«æœ‰ $ n-m,\\,m-k,\\,k $ ä¸ªäººã€‚\n$ \\binom{ n }{ k }\\binom{ n-k }{ m-k } $ å¯ä»¥çœ‹æˆåœ¨ $ n $ ä¸ªäººé‡Œé¢é€‰å‡º $ k $ ä¸ªäººï¼Œå†åœ¨å‰©ä¸‹ $ n-k $ ä¸ªäººä¸­é€‰å‡º $ m-k $ ä¸ªäººï¼ŒåŒæ ·ä¹Ÿå¯ä»¥çœ‹æˆæ˜¯åˆ†æˆäº†åˆ†åˆ«æœ‰ $ n-m,\\,m-k,\\,k $ ä¸ªäººçš„ä¸‰ç±»ã€‚\nå› æ­¤å·¦å³è¡¨ç¤ºåŒä¸€ä¸ªç»„åˆæ„ä¹‰ï¼Œå€¼å¿…ç„¶ç›¸åŒã€‚\nè¯ 2 $$ \\binom{ n }{ m } \\binom{ m }{ k } = \\dfrac{n^{\\underline{m}}}{m!}\\cdot \\dfrac{m^{\\underline{k}}}{k!} = \\dfrac{n^{\\underline{k}}}{k!}\\cdot \\dfrac{n^{\\underline{m}}}{n^{\\underline{k}}}\\cdot \\dfrac{m^{\\underline{k}}}{m!} = \\dfrac{n^{\\underline{k}}}{k!}\\cdot \\dfrac{(n-k)^{\\underline{m-k}}}{(m-k)!} = \\binom{ n }{ k } \\binom{ n-k }{ m-k } $$\n(2) $$ \\sum_{k=0}^{r} \\binom{ n+k }{ k } = \\binom{ n+r+1 }{ r } $$ è¯ 1\nè€ƒè™‘ç»„åˆæ„ä¹‰ã€‚\nå³å¼å˜å½¢ä¸º $ \\binom{ n+r+1 }{ n+1 } $ å¯ä»¥è¡¨ç¤ºä¸ºåœ¨ $ n+r+1 $ ä¸ªäººä¸­é€‰å‡º $ n+1 $ ä¸ªäººçš„æ–¹æ¡ˆæ•°ã€‚\nå·¦ä¾§å˜å½¢ä¸º $ \\sum \\binom{ n+k }{ n } $ å¯ä»¥çœ‹æˆæšä¸¾è¦é€‰çš„æœ€åä¸€ä¸ªäººæ˜¯ç¬¬ $ n+k+1 $ ä¸ªäººï¼Œåœ¨å‰ $ n+k $ ä¸ªäººä¸­é€‰æ‹© $ n $ ä¸ªäººï¼Œæ‰€æœ‰æƒ…å†µçš„å’Œæ°å¥½ä¹Ÿæ˜¯åœ¨ $ n+r+1 $ ä¸ªäººä¸­é€‰å‡º $ n+1 $ ä¸ªäººçš„æ–¹æ¡ˆæ•°ã€‚\nå› æ­¤å·¦å³ä¸¤æ¬¡å¯ä»¥è¡¨è¾¾åŒä¸€ä¸ªç»„åˆæ„ä¹‰ï¼Œå€¼ç›¸åŒã€‚\nè¯ 2\nè€ƒè™‘ç­‰å¼ $$ \\binom{ n+k }{ k } + \\binom{ n+k }{ k-1 } = \\binom{ n+k+1 }{ k } $$ ç§»é¡¹å¾—åˆ° $$ \\binom{ n+k }{ k } = \\binom{ n+k+1 }{ k } - \\binom{ n+k }{ k-1 } $$ åœ¨æ±‚å’Œå¯å¾— $$ \\sum_{k=0}^{r} \\binom{ n+k }{ k } = \\sum_{k=0}^{r} \\left[ \\binom{ n+k+1 }{ k } - \\binom{ n+k }{ k-1 } \\right] = \\binom{ n+r+1 }{ r } - \\binom{ n }{ -1 } $$ è®¤ä¸º $ \\binom{ n }{ k } $ åœ¨ $ k\u003en $ æˆ–è€… $ k\u003c 0 $ æ—¶ $ \\binom{ n }{ k }=0 $ ï¼Œåˆ™å¯å¾—åˆ° $$ \\sum_{k=0}^{r} \\binom{ n+k }{ k } = \\binom{ n+r+1 }{ r } $$\n(3) $$ \\sum_{k=0}^{n} \\binom{ n }{ k } ^{2}k = n\\binom{ 2n-1 }{ n-1 } $$ è¯ 1\nè€ƒè™‘ç»„åˆæ„ä¹‰ï¼ŒåŒæ ·ä»¥åœ¨ç­çº§ä¸­é€‰äººä¸¾ä¾‹ã€‚\nç”±äº $ 2\\binom{ 2n-1 }{ n-1 }=\\binom{ 2n }{ n } $ï¼Œå³ä¾§å˜å½¢ä¸º $ \\frac{n}{2}\\binom{ 2n }{ n } $ ï¼Œå¯ä»¥è¡¨ç¤ºåœ¨ $ 2n $ ä¸ªäººï¼ˆç”·å¥³å„ä¸€åŠï¼‰çš„ç­çº§ä¸­é€‰å‡º $ n $ ä¸ªäººå½“ç­å§”ï¼Œå†åœ¨è¿™ $ n $ ä¸ªäººä¸­é€‰å‡ºä¸€ä¸ªç”·ç”Ÿå½“ç­é•¿çš„æ–¹æ¡ˆæ•°ã€‚\nå·¦ä¾§å˜æˆ $ \\sum_{k=0}^{n}\\binom{ n }{ k }\\binom{ n }{ n-k }k $ ï¼Œå¯¹äºæ¯ä¸ª $ k $ è¡¨ç¤º $ n $ ä¸ªç”·ç”Ÿ $ n $ ä¸ªå¥³ç”Ÿçš„ç­çº§ä¸­ï¼Œç”·ç”Ÿé€‰å‡º $ k $ ä¸ªäººï¼Œå¥³ç”Ÿé€‰å‡º $ n-k $ ä¸ªäººï¼Œå…± $ n $ ä¸ªäººå½“ç­å§”ï¼Œå†ä» $ k $ ä¸ªç”·ç”Ÿç­å§”ä¸­é€‰å‡ºä¸€ä¸ªäººå½“ç­é•¿çš„æ–¹æ¡ˆæ•°ã€‚æŠŠæ‰€æœ‰ $ k $ çš„æƒ…å†µåˆèµ·æ¥ï¼ŒåŒæ ·å¯ä»¥å¾—åˆ°åœ¨ç”·å¥³å„åŠçš„ $ 2n $ ä¸ªäººä¸­é€‰å‡º $ n $ ä¸ªç­å§”å’Œä¸€ä¸ªç”·ç”Ÿç­é•¿çš„æ–¹æ¡ˆæ•°ã€‚\nå› æ­¤å·¦å³ä¸¤å¼å¯ä»¥è¡¨è¾¾åŒä¸€ä¸ªç»„åˆæ„ä¹‰ï¼Œå€¼ç›¸åŒã€‚\nè¯ 2\nå°†æ’ç­‰å¼ $$ k\\binom{ n }{ k } = n\\binom{ n-1 }{ k-1 } = n\\binom{ n-1 }{ n-k } $$ å¸¦å…¥å·¦å¼ï¼Œå·¦å³ä¸¤ä¾§æ¶ˆå» $ n $ åï¼Œåªéœ€è¯ $$ \\sum_{k=0}^{n} \\binom{ n }{ k } \\binom{ n-1 }{ n-k } = \\binom{ 2n-1 }{ n-1 } $$ æ ¹æ® Vandermonde å·ç§¯ $$ \\sum_{k=0}^{n} \\binom{ n }{ k } \\binom{ n-1 }{ n-k } = \\binom{ n + n - 1 }{ n } = \\binom{ 2n-1 }{ n } $$ å› æ­¤åŸå¼å¾—è¯ï¼\n(4) $$ \\sum_{i=0}^{a} \\binom{ a }{ i } \\binom{ b+i }{ a } = \\sum_{i=0}^{a} \\binom{ a }{ i } \\binom{ b }{ i } 2^{i} $$ è¯ 1\nä»ç»„åˆæ„ä¹‰è¯æ˜ï¼ŒåŒæ ·ä»¥ç­çº§é€‰ç­å§”ä¸¾ä¾‹ã€‚è€ƒè™‘ä¸€ä¸ªç­çº§æœ‰ $ a $ ä¸ªç­å§”å’Œ $ b $ ä¸ªéç­å§”ï¼Œç°è¿›è¡Œç­å§”æ¢å±Šã€‚\nå·¦å¼å¯¹äºæ¯ä¸ª $ i $ ï¼Œ$ \\binom{ a }{ i }\\binom{ b+i }{ a } $ è¡¨ç¤º $ a $ ä¸ªç­å§”ä¸­æœ‰ $ i $ ä¸ªäººæœ‰æ„æ„¿å†å‚ä¸ä¸‹ä¸€å±Šçš„ç­å§”é€‰ä¸¾ï¼Œåœ¨ $ b+i $ ä¸ªäººä¸­é€‰ä¸¾äº§ç”Ÿæ–°çš„ $ a $ ä¸ªç­å§”ã€‚æ¯ç§æƒ…å†µåŠ èµ·æ¥ï¼Œè¡¨ç¤º $ a $ ä¸ªåŸç­å§”è‡ªç”±é€‰æ‹©æ˜¯å¦å‚åŠ é€‰ä¸¾çš„å‰æä¸‹ç­å§”æ¢å±Šçš„æ‰€æœ‰æ–¹æ¡ˆæ•°ã€‚\nå³å¼å¯¹äºæ¯ä¸ª $ i $ ï¼Œå°† $ \\binom{ a }{ i } $ å˜æ¢ä¸º $ \\binom{ a }{ a-i } $ ï¼Œ$ \\binom{ a }{ a-i }\\binom{ b }{ i } $ è¡¨ç¤ºæ–°ä¸€å±Šç­å§”ä¸­æœ‰ $ i $ ä¸ªæ¥è‡ªåŸå…ˆ $ b $ ä¸ªéç­å§”çš„æ–¹æ¡ˆæ•°ï¼Œ$ 2^{i} $ è¡¨ç¤ºå‰©ä¸‹æ²¡é€‰ä¸Šã€æœªçŸ¥ç«é€‰æ„æ„¿çš„ $ i $ ä¸ªåŸç­å§”æ‰€æœ‰ç«é€‰æ„æ„¿çš„å¯èƒ½ã€‚å°†æ¯ç§æƒ…å†µåŠ èµ·æ¥ï¼Œä¹ŸåŒæ ·å¯ä»¥å¾—åˆ° $ a $ ä¸ªåŸç­å§”è‡ªç”±é€‰æ‹©æ˜¯å¦å‚é€‰çš„å‰æä¸‹ç­å§”æ¢å±Šçš„æ–¹æ¡ˆæ•°ã€‚\nå› æ­¤å·¦å³ä¸¤å¼å¯ä»¥è¡¨ç¤ºç›¸åŒçš„ç»„åˆæ„ä¹‰ï¼Œå€¼ç›¸åŒã€‚\nè¯ 2\næ ¹æ® Vandermonde å·ç§¯ $$ \\binom{ b+i }{ a } = \\sum_{j=0}^{i} \\binom{ i }{ j } \\binom{ b }{ a-j } $$ å¸¦å…¥å·¦å¼å¾—åˆ° $$ \\begin{align*} \\sum_{i=0}^{a} \\binom{ a }{ i } \\binom{ b+i }{ a } \u0026 = \\sum_{i=0}^{a} \\sum_{j=0}^{i} \\binom{ b }{ a-j } \\binom{ a }{ i } \\binom{ i }{ j } \\\\ \u0026 = \\sum_{i=0}^{a} \\sum_{j=0}^{i} \\binom{ b }{ a-j } \\binom{ a }{ j } \\binom{ a-j }{ i-j } \\\\ \u0026 = \\sum_{j=0}^{a} \\binom{ b }{ a-j } \\binom{ a }{ j } \\sum_{i=j}^{a} \\binom{ a-j }{ i-j } \\\\ \u0026 = \\sum_{j=0}^{a} \\binom{ b }{ a-j } \\binom{ a }{ a-j } 2^{a-j} \\\\ \u0026 \\xlongequal{i=a-j} \\sum_{i=0}^{a} \\binom{ b }{ i } \\binom{ a }{ i } 2^{i} \\end{align*} $$\nProblem 3 ç»™å®šé›†åˆ $ A=\\{1,2,\\ldots,n\\} $ ä¸æ­£æ•´æ•° $ k $ï¼Œä» $ A $ ä¸­é€‰å‡ºä¸€ç»„æŒ‰ä¸‰è§’é˜µæ’åˆ—çš„ $ \\binom{k+1}{2} $ ä¸ªå­é›† $$ \\begin{matrix} S_{1,1} \\\\ S_{2,1} \u0026 S_{2,2} \\\\ \\vdots \u0026 \\vdots \u0026 \\ddots \\\\ S_{k,1} \u0026 S_{k,2} \u0026 \\dots \u0026 S_{k,k} \\end{matrix} $$ æ»¡è¶³æ¯ä¸ªé›†åˆæ˜¯å®ƒå·¦è¾¹å’Œä¸Šæ–¹çš„é›†åˆï¼ˆå¦‚æœå­˜åœ¨ï¼‰çš„å­é›†ã€‚éœ€è¦æ±‚å‡ºæ»¡è¶³è¿™ä¸ªè¦æ±‚çš„é€‰æ‹©æ–¹æ¡ˆæ•°ã€‚\nè§£\nç”±äºæ¯ä¸ªå…ƒç´ ç›¸äº’ç‹¬ç«‹ï¼Œå…·ä½“æ–¹æ¡ˆå’Œå…ƒç´ æ— å…³ï¼Œå› æ­¤å¯ä»¥è€ƒè™‘ä¸€ä¸ªå…ƒç´ çš„åˆæ³•å‡ºç°æ–¹å¼ï¼ˆåœ¨å“ªäº›é›†åˆä¼šåŒ…å«è¿™ä¸ªå…ƒç´ ï¼‰çš„æ€»æ•°ï¼Œè®¾ä¸º $ f(k) $ ï¼Œé‚£ä¹ˆæœ€åç­”æ¡ˆå³ä¸º $ [f(k)]^{n} $ ã€‚\nç°åœ¨è€ƒè™‘ $ x\\in A $ ï¼Œæ ¹æ®åŒ…å«å…³ç³»ï¼Œä¸éš¾çœ‹å‡ºå¦‚æœ $ x\\in S $ ï¼Œé‚£ä¹ˆ $ S $ å·¦ä¾§å’Œä¸Šæ–¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰çš„é›†åˆéƒ½ä¼šåŒ…å« $ x $ã€‚å› æ­¤å‡ºç° $ x $ çš„é›†åˆåœ¨ $ k $ é˜¶ä¸‰è§’å½¢ä¸­å¯ä»¥å½¢æˆä¸€ä¸ªä» $ (1,1) $ å‡ºå‘ï¼Œæ¯æ¬¡å¯ä»¥å‘å³æˆ–è€…ä¸‹æ–¹é€šè¡Œçš„æœ‰å‘å›¾ã€‚\nè€ƒè™‘æŸä¸ªåˆæ³•æ–¹æ¡ˆï¼Œè®¾å…ƒç´ æœ€åä¸€æ¬¡å‡ºç°åœ¨å¯¹è§’çº¿ï¼ˆ$ S_{1,1},\\dots,S_{k,k} $ï¼‰çš„ä½ç½®ä¸º $ S_{r,r} $ ï¼Œé‚£ä¹ˆæ ¹æ®åŒ…å«å…³ç³»ï¼Œæ­¤æ—¶æ˜¾ç„¶ $ x $ åŒ…å«äºä¸Šæ–¹çš„ $ r $ é˜¶å°ä¸‰è§’é˜µä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¸”ä¸ä¼šå‡ºç°åœ¨ä¸‹æ–¹çš„ $ k-r $ é˜¶å°ä¸‰è§’æ–¹é˜µä¸­ï¼ˆå¦åˆ™å¿…ç„¶ä¼šå†æ¬¡å‡ºç°åœ¨å¯¹è§’çº¿ä¸­ï¼‰ã€‚å› æ­¤åªéœ€è¦è€ƒè™‘ $ x $ åœ¨ä½™ä¸‹éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯å››ä¸ªé¡¶ç‚¹åˆ†åˆ«ä¸ºä¸º $ (r+1,1),(r+1,r),(k,1),(k,r) $ çš„é•¿æ–¹å½¢åŒºåŸŸä¸­çš„åˆæ³•æ–¹æ¡ˆæ•°å³å¯ã€‚\nå¯¹äºè¿™æ ·çš„é•¿æ–¹å½¢åŒºåŸŸï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰è¡Œè€ƒè™‘ï¼Œæ˜¾ç„¶æ ¹æ®åŒ…å«çš„è§„åˆ™ï¼Œ $ x $ åœ¨æ¯ä¸€è¡Œå‡ºç°çš„å½¢å¼å¿…å®šæ˜¯ä»æœ€å·¦ä¾§å¼€å§‹è¿ç»­çš„ä¸€æ®µï¼Œå¹¶ä¸”ä¸Šåˆ°ä¸‹æ¯ä¸€è¡Œ $ x $ å‡ºç°çš„æ¬¡æ•°æ˜¯ä¸é™çš„ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªé—®é¢˜è½¬åŒ–ä¸ºæ±‚ä¸€ä¸ªé•¿åº¦ä¸º $ k-r $ ï¼Œæ¯ä¸ªæ•°èŒƒå›´ä¸º $ 0\\sim r $ çš„å•è°ƒä¸é™åºåˆ—çš„æ–¹æ¡ˆæ•°ã€‚è®¾ç¬¬ $ i $ ä¸ªæ•°çš„å€¼ä¸º $ t_{i} $ ï¼Œé‚£ä¹ˆæ–¹æ¡ˆæ•°ä¸º $$ \\begin{align*} \\sum_{t_{1}=0}^{r} \\sum_{t_{2}=0}^{t_{1}} \\dots \\sum_{t_{k-r}=0}^{t_{k-r-1}} 1 \u0026 = \\sum_{t_{1}=0}^{r} \\dots \\sum_{t_{k-r-1}=0}^{t_{k-r-2}} (t_{k-r-1} + 1) \\\\ \u0026 = \\sum_{t_{1}=0}^{r} \\dots \\sum_{t_{k-r-1}=0}^{t_{k-r-2}} \\binom{ t_{k-r-1} + 1 }{ 1 } \\\\ \u0026 = \\sum_{t_{1}=0}^{r} \\dots \\sum_{t_{k-r-2}=1}^{t_{k-r-3}} \\binom{ t_{k-r-2}+2 }{ 2 } \\\\ \u0026 \\dots \\\\ \u0026 = \\sum_{t_{1}=0}^{r} \\binom{ t_{1} + k-r-1 }{ k-r-1 } = \\binom{ k }{ k-r } \\end{align*} $$ å› æ­¤ $$ f(k) = \\sum_{r=0}^{k} \\binom{ k }{ k-r } = \\sum_{r=0}^{k} \\binom{ k }{ r } = 2^{k} $$ æ‰€ä»¥æ–¹æ¡ˆæ•°ä¸º $$ [f(k)]^{n} = 2^{nk} $$\nProblem 4 ç»™å®šä¸€ä¸ªé•¿åº¦ä¸º $ mn+1 $ çš„åºåˆ— $ a_{0},a_{1},\\ldots,a_{mn} $ï¼Œå…¶ä¸­æ¯ä¸€é¡¹åªå¯èƒ½å– $ 1 $ æˆ– $ 1-m $ï¼Œå¹¶ä¸”æ»¡è¶³æ€»å’Œ $$ \\sum_{i=0}^{mn} a_i = 1 . $$ åœ¨æ­¤æ¡ä»¶ä¸‹ï¼š\n(1)\nè¯æ˜ï¼šåœ¨è¯¥åºåˆ—é‡Œï¼Œå–å€¼ä¸º $ 1 $ çš„é¡¹å…±æœ‰ $ mn-n+1 $ ä¸ªï¼Œè€Œå–å€¼ä¸º $ 1-m $ çš„é¡¹å…±æœ‰ $ n $ ä¸ªã€‚\nè¯\nè®¾ $ 1 $ æœ‰ $ a $ ä¸ªï¼Œ$ 1-m $ æœ‰ $ b $ ä¸ªï¼Œé‚£ä¹ˆå¾—åˆ°æ–¹ç¨‹ $$ \\begin{cases} a + b = mn+1 \\\\ a + (1-m)b = 1 \\end{cases} $$ ç›´æ¥å¯ä»¥è§£å¾— $$ \\begin{cases} a = mn-n+1 \\\\ b=n \\end{cases} $$\n(2)\næŠŠåºåˆ—é¦–å°¾ç›¸æ¥æ’æˆä¸€ä¸ªåœ†ç¯ã€‚è€ƒè™‘æ‰€æœ‰å¯èƒ½çš„â€œèµ·ç‚¹â€é€‰æ‹©ï¼ˆå³å¯¹åºåˆ—åšå¾ªç¯ç§»ä½ï¼‰ã€‚\nè¯æ˜ï¼šæ°å¥½å­˜åœ¨å”¯ä¸€ä¸€ä¸ªèµ·ç‚¹ $ k $ï¼Œä½¿å¾—ä»è¯¥ä½ç½®å¼€å§‹ä¾æ¬¡ç›¸åŠ å¾—åˆ°çš„æ‰€æœ‰éƒ¨åˆ†å’Œéƒ½ä¸ºæ­£ï¼Œå³ $$ a_k,\\ a_k+a_{k+1},\\ \\ldots,\\ a_k+a_{k+1}+\\cdots+a_{k-1} $$ å…¨éƒ¨å¤§äº $ 0 $ï¼ˆä¸‹æ ‡æŒ‰æ¨¡ $ mn+1 $ è®¡ç®—ï¼‰ã€‚\nè¯\nè€ƒè™‘åºåˆ—å‰ç¼€å’Œ $ S_{t} = \\sum_{i=0}^{t}a_{i} $ ï¼Œå¹¶ä¸” $ S_{-1}=0 $ã€‚åœ¨åºåˆ— $ \\{ S_{-1},S_{0},\\dots,S_{mn} \\} $ ä¸­å­˜åœ¨æœ€å°å€¼ $ S_{k} $ï¼Œå¦‚æœæœ‰å¤šä¸ªï¼Œå–å…¶ä¸­ä¸‹æ ‡æœ€å¤§çš„ä¸º $ S_{k} $ï¼Œæ˜¾ç„¶ $ S_{k} $ å”¯ä¸€ã€‚\näºæ˜¯ $ \\forall r\\in \\{ k+1,\\dots,mn \\} $ ï¼Œæœ‰ $ S_{r}\u003eS_{k} $ ï¼Œå› æ­¤ä» $ k+1 $ åˆ° $ r $ çš„å­æ®µå’Œä¸º $ \\sum_{i=k+1}^{r}a_{i}=S_{r}-S_{k}\u003e0 $\nå¹¶ä¸” $ \\forall l\\in \\{ 0,\\dots,k \\}: S_{l-1}\\leq S_{k} $ ï¼Œå› æ­¤ä» $ k+1 $ å¼€å§‹çš„ä¸€æ®µå¾ªç¯åºåˆ—ä¸­çš„å’Œä¸ºï¼ˆè€ƒè™‘åœ¨åŸåºåˆ—ä¸­è¿™ä¸€æ®µçš„è¡¥é›†ï¼‰ï¼š $$ \\sum_{i=k+1}^{mn+1+l}a_{i\\bmod (mn+1)}=\\sum_{i=0}^{mn}a_{i} - \\sum_{i=l}^{k}a_{i}=1-(S_{k}-S_{l-1}) = 1+S_{l-1}-S_{k}\\geq 1 \u003e 0 $$\nç»¼ä¸Šï¼Œæˆ‘ä»¬æ‰¾å‡ºäº†å”¯ä¸€æ»¡è¶³ä»è¯¥ä½ç½®å¼€å§‹å·¦å³çš„éƒ¨åˆ†å’Œéƒ½ä¸ºæ­£çš„ä¸€ä¸ªä½ç½®ï¼Œè¯æ¯•ã€‚\n(3)\næ±‚æ»¡è¶³â€œæ‰€æœ‰å‰ç¼€éƒ¨åˆ†å’Œéƒ½ä¸ºæ­£â€çš„åºåˆ— $ a_{0},a_{1},\\ldots,a_{mn} $ çš„æ€»æ•°ã€‚\nè¯ 1\nä¸è€ƒè™‘ä»»æ„å‰ç¼€å’Œä¸ºæ­£çš„é™åˆ¶ï¼Œæ‰€æœ‰çš„åºåˆ—æ€»æ•°ä¸º $ \\binom{ mn+1 }{ n } $ï¼ˆæ€»å…± $ mn+1 $ ä¸ªæ•°ï¼Œé€‰æ‹© $ n $ ä¸ªæ•°ä¸º $ 1-m $ï¼‰ã€‚\nå¯¹äºä»»æ„ä¸€ä¸ªåºåˆ—ï¼Œæ ¹æ® $ (2) $ çš„ç»“è®ºï¼Œå­˜åœ¨å”¯ä¸€çš„ $ k $ ä½¿å¾—ä» $ k $ å¼€å§‹çš„æ‰€æœ‰å‰ç¼€å’Œä¸ºæ­£ï¼Œå› æ­¤æˆ‘ä»¬å°†æ”¹åºåˆ—çš„ä¸‹æ ‡å‘å·¦å¹³ç§» $ k $ å³å¯å¾—åˆ°ä¸€ä¸ªåˆæ³•çš„åºåˆ—ã€‚\nè¿™è¯´æ˜æ¯ç§åœ†æ’åˆ—éƒ½å¯¹åº”å”¯ä¸€ä¸€ä¸ªåˆæ³•çš„åºåˆ—ï¼Œæ‰€ä»¥ç­”æ¡ˆä¸º $$ \\dfrac{1}{mn+1}\\binom{ mn+1 }{ n } $$\nè¯ 2ï¼ˆæ²¡è¯å‡ºæ¥ğŸ˜­ï¼‰\né¦–å…ˆå¿…ç„¶æœ‰ $ a_{0}=1 $ ï¼Œå¦åˆ™ $ a_{0}=1-m\u003c 0 $ å·²ç»ä¸æ»¡è¶³æ¡ä»¶ã€‚å› æ­¤å¯ä»¥åœ¨åŸåºåˆ—å»æ‰ $ a_{0} $ï¼Œé—®é¢˜çš„çº¦æŸè½¬åŒ–ä¸º $ \\sum_{i=1}^{mn}a_{i}=0 $ ï¼Œä¿è¯ä» $ a_{1} $ å¼€å§‹çš„å‰ç¼€å’Œéè´Ÿå³å¯ã€‚\nå°†é—®é¢˜è½¬åŒ–ä¸ºåœ¨ä¸€ä¸ªäºŒç»´ç½‘æ ¼ä¸Šè·¯å¾„è®¡æ•°çš„æ¨¡å‹ï¼šä»èµ·ç‚¹ $ O(0,0) $ å‡ºå‘ï¼Œæ¯ä¸€æ­¥ä¼šå‘ä¸Šèµ° $ 1 $ æ ¼æˆ–è€…å‘å³èµ° $ 1 $ æ ¼ï¼Œç›®æ ‡èµ°åˆ° $ D(n,n(m-1)) $ï¼Œå…¶ä¸­å‰ç¼€å’Œéè´Ÿçš„çº¦æŸè½¬åŒ–ä¸ºä¸èƒ½è¶Šè¿‡ç›´çº¿ $ l:y=(m-1)x $ ã€‚\næˆ‘ä»¬å°†å‘ä¸Šèµ°çš„æ“ä½œè®°ä¸º $ U $ï¼Œå‘å³èµ°çš„æ“ä½œè®°ä¸º $ R $ï¼Œæ˜¾ç„¶æœ€ç»ˆä¸€ä¸ª $ R $ å¯ä»¥å¯¹åº” $ (m-1) $ ä¸ª $ U $ æ“ä½œã€‚ç”±äºä¸€ä¸ª $ R $ æ“ä½œçš„è·¨åº¦è¿‡å¤§ï¼Œä½¿æˆ‘ä»¬éš¾ä»¥æ“ä½œâ€œè·¯å¾„ä¸­ç¬¬ä¸€ä¸ªä¸åˆæ³•çš„ç‚¹â€ï¼Œå› æ­¤æˆ‘ä»¬è€ƒè™‘å°† $ R $ æ‹†è§£æˆç²’åº¦æ›´å° $ (m-1) $ ä¸ªè¿ç»­çš„ $ r $ æ“ä½œï¼Œå¯ä»¥çœ‹æˆå‘å³ç§»åŠ¨ $ \\dfrac{1}{m-1} $ æ ¼çš„è·ç¦»ã€‚æ­¤æ—¶ä¸€æ¡è·¯å¾„ä¸­å«æœ‰ $ N=n(m-1) $ ä¸ª $ U $ æ“ä½œå’Œ $ r $ æ“ä½œã€‚\nè€ƒè™‘ä¸€æ¡ä¸åˆæ³•çš„è·¯å¾„ï¼Œå¯ä»¥çœ‹æˆä¸€ä¸ªä¸åˆæ³•çš„æ“ä½œåºåˆ— $ S $ï¼Œå•ç‹¬æ‰¾å‡ºç¬¬ä¸€æ¬¡è¶Šè¿‡ $ l $ çš„ $ r $ æ“ä½œï¼Œå¯ä»¥å°† $ S $ åˆ†è§£æˆ $$ S = ArB $$ å…¶ä¸­ $ A $ çš„æœ«å°¾åˆšå¥½åœ¨ $ l $ ä¸Šï¼Œæ»¡è¶³ $ r=U $ ï¼ˆæ•°é‡ï¼‰ï¼Œ$ B $ ä¸ºå‰©ä½™åºåˆ—ã€‚\nç”±äº $ A $ çš„æ€§è´¨æ›´å¥½ï¼Œæ‰€ä»¥å‚è€ƒ Catalan æ•°çš„è¯æ˜ï¼Œæˆ‘ä»¬è€ƒè™‘å°† $ A $ â€œåå°„â€ï¼Œå°†å…¶ä¸­çš„æ‰€æœ‰ $ r $ å’Œ $ U $ æ“ä½œäº’æ¢ï¼Œå¾—åˆ° $ \\overline{A} $ï¼Œä»è€Œæ„é€ å‡º $$ S'=\\overline{A}rB $$ äºæ˜¯æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªä¸åˆæ³•åºåˆ— $ S $ å’ŒæŸä¸ª $ S' $ åºåˆ—çš„åŒå°„ã€‚ä» $ S' $ æ˜ å°„ä¼š $ S $ åŒæ ·åªéœ€è¦æ‰¾å‡ºç¬¬ä¸€æ¬¡åˆ°è¾¾ $ l $ çš„ä½ç½®æ‰¾å‡º $ \\overline{A} $ï¼Œå†è¿›è¡Œä¸€æ¬¡â€œåå°„â€å³å¯ã€‚\næˆ‘ä»¬å†å®šä¹‰ä¸€ä¸ªå‹ç¼©æ“ä½œï¼Œè¡¨ç¤ºä»å·¦åˆ°å³æ‰«æä¸€ä¸ªåºåˆ—ï¼Œé‡åˆ° $ U $ ç›´æ¥åŠ å…¥æ–°çš„åºåˆ—ï¼Œé‡åˆ°ç´¯è®¡é‡åˆ° $ (m-1) $ ä¸ª $ r $ å‘æ–°åºåˆ—ä¸­åŠ å…¥ä¸€ä¸ª $ R $ã€‚è¿™æ ·å¯¹äºä»»æ„ä¸€ä¸ª $ U $ å’Œ $ r $ æ•°é‡å‡ä¸º $ N $ çš„åºåˆ—ï¼Œå‹ç¼©åéƒ½ä¼šå¾—åˆ°ä¸€ä¸ªæ— çº¦æŸçš„ $ U-R $ åºåˆ—ã€‚æˆ‘ä»¬å°†è¿™ä¸ªæ“ä½œè®°ä¸º $ C(S) $ï¼Œ$ S $ è¡¨ç¤ºæ“ä½œçš„ $ U-r $ åºåˆ—ã€‚\näºæ˜¯ç°åœ¨æˆ‘ä»¬å¯¹äºä¸€æ¡ä¸åˆæ³•çš„è·¯å¾„ï¼Œå°†å…¶ç»†åŒ–ä¸º $ U-r $ åºåˆ— $ S $ åå†åå°„ä¸º $ S' $ï¼Œå‹ç¼©åå¾—åˆ° $ P=C(S') $ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— çº¦æŸçš„ $ U-R $ åºåˆ—ï¼Œå«æœ‰ $ n $ ä¸ª $ R $ã€‚\n// é€šè¿‡æ‰‹åŠ¨è®¡ç®—å°æ•°æ®ï¼Œå¯ä»¥çŒœå‡ºä¸€ä¸ªåˆæ³•åºåˆ—å¯¹åº” $ n(m-1) $ ä¸ªéæ³•åºåˆ—çš„ç»“è®ºã€‚å¹¶ä¸”æ³¨æ„åˆ°æœ‰ $ N $ ä¸ª $ U $ æ“ä½œï¼Œå› æ­¤å¸Œæœ›é€šè¿‡å¼•å…¥æŸç§â€œæ ‡è®°æ“ä½œâ€ï¼Œæ¥æ ‡è®°æŸä¸ª $ U $ æ“ä½œï¼Œæ¥æ„é€ å‡ºä¸€ä¸ª $ \\text{éæ³•åºåˆ—} \\leftrightarrow (\\text{åˆæ³•åºåˆ—},u^{*}) $ çš„åŒå°„ï¼Œå…¶ä¸­ $ u^{*} $ è¡¨ç¤ºè¢«æ ‡è®°çš„ $ U $ æ“ä½œã€‚è¿™æ ·è¯´æ˜ä¸€ä¸ªåˆæ³•åºåˆ—å¯¹åº” $ N $ ä¸ªéæ³•åºåˆ—ï¼Œäºæ˜¯åˆæ³•åºåˆ—æ•°é‡ä¸º $$ \\dfrac{1}{N+1}\\binom{ mn }{ n } = \\dfrac{1}{n(m-1)+1}\\binom{ mn }{ n } = \\dfrac{1}{mn+1}\\binom{ mn+1 }{ n } $$\n","permalink":"https://diefish1024.github.io/posts/class-notes/cs0901-combinatorics/cs0901-hw1/","summary":"\u003ch2 id=\"problem-1\"\u003eProblem 1\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003e(1)\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæ±‚\n$$ \n\n\\sum_{k=0}^{n} \\binom{ 2n }{ 2k } \n\n $$\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eè§£\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e$$ \n\n\\begin{align*}\n \u0026 \\sum_{k=0}^{n} (-1)^{k}\\binom{ n }{ k } = 0 \\\\\n\\implies \u0026 \\sum_{k=0}^{2n} (-1)^{k}\\binom{ 2n }{ k } =0 \\\\\n\\implies \u0026 \\sum_{k=0}^{2n} \\binom{ 2n }{ 2k } = \\sum_{k=1}^{2n} \\binom{ 2n }{ 2k - 1 } \n\\end{align*}\n\n $$\nåŒæ—¶ç”±äº\n$$ \n\n\\sum_{k=0}^{2n} \\binom{ 2n }{ 2k } + \\sum_{k=1}^{2n} \\binom{ 2n }{ 2k - 1 } = \\sum_{k=0}^{2n} \\binom{ 2n }{ k } = 2^{2n}\n\n $$\nå¾—åˆ°\n$$ \n\n\\sum_{k=0}^{2n} \\binom{ 2n }{ 2k } = 2^{2n-1}\n\n $$\u003c/p\u003e","title":"CS0901 HW1"},{"content":"Product and Sum Principles åŠ æ³•åŸç†ï¼ˆåˆ†ç±»è®¡æ•°ï¼‰ è‹¥ä¸€ä¸ªä»»åŠ¡å¯åˆ†è§£ä¸ºè‹¥å¹²ä¸ªäº’æ–¥çš„å­ç±»ï¼Œç¬¬ $ i $ ç±»æœ‰ $ a_i $ ç§æ–¹æ¡ˆï¼Œåˆ™æ€»æ•°ä¸º $ \\sum_i a_i $ã€‚ è§£é‡Šï¼šäº’æ–¥ä¿è¯ä¸é‡ä¸æ¼ï¼Œæ±‚å’Œå³â€œæˆ–â€çš„è®¡æ•°ã€‚\nä¹˜æ³•åŸç†ï¼ˆåˆ†æ­¥è®¡æ•°ï¼‰ è‹¥ä¸€ä¸ªä»»åŠ¡åˆ†ä¸ºè‹¥å¹²ä¸ªæœ‰åºæ­¥éª¤ï¼Œæ­¥éª¤ $ i $ æœ‰ $ b_i $ ç§é€‰æ‹©ä¸”ç›¸äº’ç‹¬ç«‹ï¼Œåˆ™æ€»æ•°ä¸º $ \\prod_i b_i $ã€‚ è§£é‡Šï¼šæœ‰åºæ­¥éª¤é€ä¸ªåšå†³å®šï¼Œâ€œä¸”â€çš„è®¡æ•°å¯¹åº”ä¹˜æ³•ã€‚\nConstructing Maps æœ‰äº›ç»„åˆè¯æ˜å¯ä»¥ä¾èµ–äºæ„é€ æ˜ å°„ï¼š\nå•å°„ï¼šä¸åŒåŸåƒæ˜ åˆ°ä¸åŒåƒï¼Œç”¨äºè¯æ˜ä¸‹ç•Œæˆ–â€œå¯åµŒå…¥æ€§â€ã€‚ æ»¡å°„ï¼šåƒè¦†ç›–å…¨ä½“ï¼Œç”¨äºè¯æ˜ä¸Šç•Œå¯è¾¾æˆ–æ„é€ è¦†ç›–ã€‚ åŒå°„ï¼šå»ºç«‹é›†åˆ $ A $ ä¸ $ B $ çš„ä¸€ä¸€å¯¹åº”ï¼Œä»è€Œæ•° $ |A|=|B| $ï¼›è¿™æ˜¯â€œæ•°æŸä¸€ä¸ªé‡ â‡’ æ„é€ åŒå°„â€çš„æ ¸å¿ƒæ€æƒ³ã€‚ Twelvefoldway å°† $ n $ ä¸ªçƒæ”¾å…¥ $ m $ ä¸ªç›’å­ï¼Œçƒä¸ç›’å­å¯â€œå¯åŒºåˆ†/ä¸å¯åŒºåˆ†â€ï¼Œä»¥åŠç›’å­å®¹é‡çº¦æŸâ€œä»»æ„/è‡³å¤š 1/è‡³å°‘ 1â€ã€‚\n$ n $ $ m $ ä»»æ„ $ \\leq 1 $ $ \\geq 1 $ ä¸åŒ ä¸åŒ $ m^{n} $ $ m^{\\underline{n}} $ $ m!\\left\\{ {n \\atop m} \\right\\} $ åŒ ä¸åŒ $ \\binom{ n+m-1 }{ m-1 } $ $ \\binom{ m }{ n } $ $ \\binom{ n-1 }{ m-1 } $ ä¸åŒ åŒ $ \\sum_{k=0}^{\\min(n,m)} \\left\\{ {n \\atop k} \\right\\} $ $ [n \\leq m] $ $ \\left\\{ {n \\atop m} \\right\\} $ åŒ åŒ $ p_{\\leq m}(n) $ $ [n \\leq m] $ $ p(n,m) $ â€œæŠŠ $ n $ ä¸ªä¸åŒçƒåˆ†æˆ $ k $ ä¸ªéç©ºæ— åºç›’â€å¯¹åº”ç¬¬äºŒç±»æ–¯ç‰¹æ—æ•° $ \\left\\{ {n \\atop k} \\right\\} $ã€‚\nStirling Numbers of the Second Kind å®šä¹‰ï¼š$ \\left\\{ {n \\atop k} \\right\\} $ è¡¨ç¤ºâ€œå°† $ n $ ä¸ªä¸åŒå…ƒç´ åˆ†æˆ $ k $ ä¸ªéç©ºæ— åºå—â€çš„æ–¹æ¡ˆæ•°ã€‚\nåŸºæœ¬é€’æ¨ï¼š$$ \\left\\{ {n \\atop k} \\right\\} = \\left\\{ {n-1 \\atop k-1} \\right\\} + k \\left\\{ {n-1 \\atop k} \\right\\}, \\quad \\left\\{ {0 \\atop 0} \\right\\}=1 $$ ä»ç»„åˆæ„ä¹‰ä¸Šç†è§£ï¼Œå…ƒç´  $ n $ è¦ä¹ˆç‹¬è‡ªæˆæ–°å—ï¼ˆ$ \\left\\{ {n-1 \\atop k-1} \\right\\} $ï¼‰ï¼Œè¦ä¹ˆåŠ å…¥å·²æœ‰ $ k $ ä¸ªå—ä¹‹ä¸€ï¼ˆ$ k \\left\\{ {n-1 \\atop k} \\right\\} $ï¼‰ã€‚\nä¸é™é˜¶é˜¶ä¹˜çš„åˆ†å±‚å±•å¼€ï¼š$$ m^{n} = \\sum_{k=1}^{n} \\left\\{ {n \\atop k} \\right\\} m^{\\underline{k}} $$ ç»„åˆè¯æ˜ï¼š\nå°† $ n $ ä¸ªä¸åŒçƒå…ˆâ€œåˆ†ç»„â€ä¸º $ k $ ä¸ªéç©ºæ— åºå—ï¼š $ \\left\\{ {n \\atop k} \\right\\} $ã€‚ ä» $ m $ ä¸ªå¯åŒºåˆ†ç›’ä¸­é€‰å‡ºå¹¶æŒ‰é¡ºåºå¯¹åº”è¿™ $ k $ ä¸ªå—ï¼š $ m^{\\underline{k}} $ã€‚ æŒ‰ $ k $ åˆ†å±‚æ±‚å’Œå³å¾—å…¨éƒ¨æ˜ å°„ $ [n] \\to [m] $ çš„æ€»æ•° $ m^n $ã€‚ å¦ä¸€æ’ç­‰å¼ï¼š$$ \\left\\{ {n \\atop m} \\right\\} = \\sum_{k=0}^{n-1} \\binom{ n-1 }{ k } \\left\\{ {n-k-1 \\atop k-1} \\right\\} $$\nVandermondeâ€™s Convolution èŒƒå¾·è’™å·ç§¯ï¼š $$ \\binom{ r+s }{ n } = \\sum_{k=0}^{n} \\binom{ r }{ k } \\binom{ s }{ n-k } $$\nç»„åˆè¯æ˜ï¼šä» $ r+s $ ä¸ªå…ƒç´ ä¸­é€‰ $ n $ ä¸ªã€‚åˆ†ç±»ï¼šä»å‰ $ r $ ä¸ªå…ƒç´ é€‰ $ k $ ä¸ªã€ä»å $ s $ ä¸ªå…ƒç´ é€‰ $ n-k $ ä¸ªï¼Œ$ k $ éå† $ 0 $ è‡³ $ n $ï¼Œäº’æ–¥ä¸”å®Œå¤‡ï¼Œæ•…æ±‚å’Œã€‚\nä»£æ•°è¯æ˜ï¼šç”¨äºŒé¡¹å¼å®šç†å±•å¼€ $ (1+x)^{r+s} = (1+x)^r (1+x)^s $ï¼Œæ¯”å¯¹ $ x^n $ çš„ç³»æ•°å³å¾—ã€‚\nBinomial Coefficients å¯¹ç§°æ€§ï¼š $ \\binom{ n }{ k } = \\binom{ n }{ n-k } $ ç»„åˆï¼šé€‰ $ k $ ä¸ªç­‰ä»·äºå¼ƒ $ n-k $ ä¸ªã€‚\nPascal æ’ç­‰å¼ï¼š $ \\binom{ n }{ k } = \\binom{ n-1 }{ k } + \\binom{ n-1 }{ k-1 } $ ç»„åˆï¼šè€ƒè™‘æ˜¯å¦åŒ…å«å…ƒç´  $ n $ã€‚\næ€»å’Œï¼š $ \\sum_{k=0}^{n} \\binom{ n }{ k } = 2^{n} $ ç»„åˆï¼šæ¯å…ƒç´ é€‰/ä¸é€‰ä¸¤ç§ï¼Œä¹˜æ³•åŸç†ï¼›æˆ–ä»£æ•°ç”¨ $ (1+1)^n $ã€‚\nâ€œæ›²æ£çƒæ†â€æ’ç­‰å¼ï¼š $ \\sum_{i=r}^{n} \\binom{ i }{ r } = \\binom{ n+1 }{ r+1 } $ ç»„åˆï¼šç»™å®šæœ€å¤§å…ƒç´ ï¼ŒæŒ‰å…¶å€¼åˆ†ç±»ç´¯åŠ ï¼›æˆ–ç”¨ Pascal å åŠ ã€‚\nä¸€é˜¶çŸ©ï¼š $ \\sum_{k=0}^{n} k \\binom{ n }{ k } = n 2^{n-1} $ ç»„åˆï¼šåŒè®¡æ•°â€œé€‰å‡ºå­é›†å¹¶æŒ‡å®šä¸€ä¸ªå·²é€‰æ ‡è®°å…ƒç´ â€ï¼›æˆ–ä»£æ•°å¯¹ $ (1+x)^n $ æ±‚å¯¼ä»¤ $ x=1 $ã€‚\näºŒé¡¹å¼å®šç†ï¼š $ (x+y)^{n} = \\sum_{k=0}^{n} \\binom{ n }{ k } x^{k} y^{n-k} $ ä»£æ•°ï¼šå±•å¼€ä¹˜æ³•ï¼›ç»„åˆï¼šä» $ n $ ä¸ªå› å­ä¸­é€‰ $ k $ æ¬¡å– $ x $ã€‚\nèŒƒå¾·è’™å·ç§¯ï¼šè§ä¸Šä¸€èŠ‚ã€‚\nå‡¸æ€§ä¸å¯¹æ•°å‡¹æ€§ï¼š\nå¯¹äºå›ºå®š $ n $ï¼Œåºåˆ— $ \\left( \\binom{ n }{ 0 }, \\binom{ n }{ 1 }, \\dots, \\binom{ n }{ n } \\right) $ æ˜¯å¯¹ç§°ã€å•å³°ä¸”å¯¹æ•°å‡¹ï¼šå¯¹æ‰€æœ‰å¯è¡Œ $ k $ï¼Œæœ‰ $$ \\binom{ n }{ k }^{2} \\ge \\binom{ n }{ k-1 } \\binom{ n }{ k+1 } $$ è®¡ç®—æ¯”å€¼ $$ \\frac{ \\binom{ n }{ k } }{ \\binom{ n }{ k-1 } } = \\frac{ n-k+1 }{ k }, \\quad \\frac{ \\binom{ n }{ k+1 } }{ \\binom{ n }{ k } } = \\frac{ n-k }{ k+1 } $$ ç”±æ­¤å¾— $$ \\frac{ \\binom{ n }{ k }^{2} }{ \\binom{ n }{ k-1 } \\binom{ n }{ k+1 } } = \\frac{ k (k+1) }{ (n-k+1)(n-k) } \\cdot \\frac{ (n-k+1)(n-k) }{ k (k+1) } = 1 $$ Catalan Numbers ç¬¬ $ n $ ä¸ªå¡ç‰¹å…°æ•° $$ C_n = \\frac{ 1 }{ n+1 } \\binom{ 2n }{ n } $$\nç½‘æ ¼è·¯å¾„æ¨¡å‹ï¼šä»ç‚¹ $ (0,0) $ åˆ° $ (n,n) $ï¼Œæ¯æ­¥å‘å³ $ R $ æˆ–å‘ä¸Š $ U $ï¼Œè¦æ±‚è·¯å¾„å§‹ç»ˆä¸è¶Šè¿‡ä¸»å¯¹è§’çº¿ $ y=x $ã€‚è¿™ç­‰ä»·äºè®¡æ•°é•¿åº¦ $ 2n $ çš„åºåˆ—ï¼Œä»»æ„å‰ç¼€ä¸­ $ U $ çš„æ•°é‡ä¸å°äº $ R $ çš„æ•°é‡ã€‚\nç»å…¸åå°„æ³•è¯æ˜ï¼ˆBallot/Reflectionï¼‰ï¼š\næ€»è·¯å¾„æ•°ï¼šä¸åŠ é™åˆ¶ï¼Œä» $ 2n $ æ­¥ä¸­é€‰å‡º $ n $ æ­¥ä¸º $ U $ï¼Œå…± $ \\binom{ 2n }{ n } $ æ¡ã€‚ è®¡â€œåâ€è·¯å¾„ï¼šè¶Šç•Œçš„è·¯å¾„ã€‚è®¾é¦–æ¬¡è¶Šç•Œçš„æ—¶åˆ»ä¸ºç¬¬ $ t $ æ­¥ï¼Œæ­¤æ—¶ $ R $ æ¯” $ U $ å¤šä¸€ã€‚å°†å‰ $ t $ æ­¥å…³äºç›´çº¿ $ y=x $ åå°„ï¼ˆäº¤æ¢ $ U $ ä¸ $ R $ï¼‰ï¼Œå¾—åˆ°ä¸€æ¡ä» $ (0,0) $ åˆ° $ (n+1,n-1) $ çš„è·¯å¾„ï¼›æ­¤æ„é€ æ˜¯åè·¯å¾„ä¸â€œä» $ (0,0) $ åˆ° $ (n+1,n-1) $ çš„ä»»æ„è·¯å¾„â€ä¹‹é—´çš„åŒå°„ã€‚å› æ­¤åè·¯å¾„æ•°ä¸º $ \\binom{ 2n }{ n-1 } $ã€‚ å¥½è·¯å¾„æ•°ï¼š $ \\binom{ 2n }{ n } - \\binom{ 2n }{ n-1 } = \\frac{ 1 }{ n+1 } \\binom{ 2n }{ n } $ï¼Œå³ $ C_n $ã€‚ æœ¬è´¨æŠ½è±¡ï¼šä¸¤ç±»æ“ä½œ $ U $ ä¸ $ R $ æ€»æ•°ç›¸ç­‰ï¼Œä¸”ä»»æ„æ—¶åˆ»â€œ$ U $ çš„ç´¯è®¡æ•° â‰¥ $ R $ çš„ç´¯è®¡æ•°â€ã€‚åŒæ„åˆ°æŠ•ç¥¨/æ‹¬å·é…å¯¹/å †æ ˆå¯è¡Œåºç­‰å¤§é‡æ¨¡å‹ã€‚\n","permalink":"https://diefish1024.github.io/posts/class-notes/cs0901-combinatorics/lect1-counting/","summary":"\u003ch2 id=\"product-and-sum-principles\"\u003eProduct and Sum Principles\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eåŠ æ³•åŸç†ï¼ˆåˆ†ç±»è®¡æ•°ï¼‰\u003c/strong\u003e\nè‹¥ä¸€ä¸ªä»»åŠ¡å¯åˆ†è§£ä¸ºè‹¥å¹²ä¸ªäº’æ–¥çš„å­ç±»ï¼Œç¬¬ $ i $ ç±»æœ‰ $ a_i $ ç§æ–¹æ¡ˆï¼Œåˆ™æ€»æ•°ä¸º $ \\sum_i a_i $ã€‚\nè§£é‡Šï¼šäº’æ–¥ä¿è¯ä¸é‡ä¸æ¼ï¼Œæ±‚å’Œå³â€œæˆ–â€çš„è®¡æ•°ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eä¹˜æ³•åŸç†ï¼ˆåˆ†æ­¥è®¡æ•°ï¼‰\u003c/strong\u003e\nè‹¥ä¸€ä¸ªä»»åŠ¡åˆ†ä¸ºè‹¥å¹²ä¸ªæœ‰åºæ­¥éª¤ï¼Œæ­¥éª¤ $ i $ æœ‰ $ b_i $ ç§é€‰æ‹©ä¸”ç›¸äº’ç‹¬ç«‹ï¼Œåˆ™æ€»æ•°ä¸º $ \\prod_i b_i $ã€‚\nè§£é‡Šï¼šæœ‰åºæ­¥éª¤é€ä¸ªåšå†³å®šï¼Œâ€œä¸”â€çš„è®¡æ•°å¯¹åº”ä¹˜æ³•ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"constructing-maps\"\u003eConstructing Maps\u003c/h2\u003e\n\u003cp\u003eæœ‰äº›ç»„åˆè¯æ˜å¯ä»¥ä¾èµ–äºæ„é€ æ˜ å°„ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eå•å°„\u003c/strong\u003eï¼šä¸åŒåŸåƒæ˜ åˆ°ä¸åŒåƒï¼Œç”¨äºè¯æ˜ä¸‹ç•Œæˆ–â€œå¯åµŒå…¥æ€§â€ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ»¡å°„\u003c/strong\u003eï¼šåƒè¦†ç›–å…¨ä½“ï¼Œç”¨äºè¯æ˜ä¸Šç•Œå¯è¾¾æˆ–æ„é€ è¦†ç›–ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåŒå°„\u003c/strong\u003eï¼šå»ºç«‹é›†åˆ $ A $ ä¸ $ B $ çš„ä¸€ä¸€å¯¹åº”ï¼Œä»è€Œæ•° $ |A|=|B| $ï¼›è¿™æ˜¯â€œæ•°æŸä¸€ä¸ªé‡ â‡’ æ„é€ åŒå°„â€çš„æ ¸å¿ƒæ€æƒ³ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"twelvefoldway\"\u003e\u003ca href=\"https://en.wikipedia.org/wiki/Twelvefold_way\"\u003eTwelvefoldway\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eå°† $ n $ ä¸ªçƒæ”¾å…¥ $ m $ ä¸ªç›’å­ï¼Œçƒä¸ç›’å­å¯â€œå¯åŒºåˆ†/ä¸å¯åŒºåˆ†â€ï¼Œä»¥åŠç›’å­å®¹é‡çº¦æŸâ€œä»»æ„/è‡³å¤š 1/è‡³å°‘ 1â€ã€‚\u003c/p\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003e$ n $\u003c/th\u003e\n          \u003cth\u003e$ m $\u003c/th\u003e\n          \u003cth\u003eä»»æ„\u003c/th\u003e\n          \u003cth\u003e$ \\leq 1 $\u003c/th\u003e\n          \u003cth\u003e$ \\geq 1 $\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eä¸åŒ\u003c/td\u003e\n          \u003ctd\u003eä¸åŒ\u003c/td\u003e\n          \u003ctd\u003e$ m^{n} $\u003c/td\u003e\n          \u003ctd\u003e$ m^{\\underline{n}} $\u003c/td\u003e\n          \u003ctd\u003e$ m!\\left\\{ {n \\atop m} \\right\\} $\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eåŒ\u003c/td\u003e\n          \u003ctd\u003eä¸åŒ\u003c/td\u003e\n          \u003ctd\u003e$ \\binom{ n+m-1 }{ m-1 } $\u003c/td\u003e\n          \u003ctd\u003e$ \\binom{ m }{ n } $\u003c/td\u003e\n          \u003ctd\u003e$ \\binom{ n-1 }{ m-1 } $\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eä¸åŒ\u003c/td\u003e\n          \u003ctd\u003eåŒ\u003c/td\u003e\n          \u003ctd\u003e$ \\sum_{k=0}^{\\min(n,m)} \\left\\{ {n \\atop k} \\right\\} $\u003c/td\u003e\n          \u003ctd\u003e$ [n \\leq m] $\u003c/td\u003e\n          \u003ctd\u003e$ \\left\\{ {n \\atop m} \\right\\} $\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eåŒ\u003c/td\u003e\n          \u003ctd\u003eåŒ\u003c/td\u003e\n          \u003ctd\u003e$ p_{\\leq m}(n) $\u003c/td\u003e\n          \u003ctd\u003e$ [n \\leq m] $\u003c/td\u003e\n          \u003ctd\u003e$ p(n,m) $\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eâ€œæŠŠ $ n $ ä¸ªä¸åŒçƒåˆ†æˆ $ k $ ä¸ªéç©ºæ— åºç›’â€å¯¹åº”ç¬¬äºŒç±»æ–¯ç‰¹æ—æ•° $ \\left\\{ {n \\atop k} \\right\\} $ã€‚\u003c/p\u003e","title":"Lect1-Counting"},{"content":"è¯¾ç¨‹è®²ä¹‰\nåœ¨è¿™é—¨è¯¾é‡Œï¼Œæˆ‘ä»¬ä¼šä¸“æ³¨äºæ‰€è°“çš„ ç§‘å°”è«å“¥æ´›å¤«ï¼ˆKolmogorovï¼‰çš„å…¬ç†ä½“ç³»ï¼Œå®ƒä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨æ•°å­¦åˆ†æçš„å·¥å…·æ¥ç ”ç©¶æ¦‚ç‡ã€‚\nSt.Â Petersburg Paradox åœ£å½¼å¾—å ¡æ‚–è®ºã€‚å‡è®¾ä¸€ä¸ªåŸºäºæŠ›ç¡¬å¸èµŒåšçš„æ¸¸æˆï¼Œåº„å®¶ä¼šä¸€ç›´æ‰”ç¡¬å¸ç›´åˆ°ç»“æœæ˜¯æ­£é¢ï¼Œå¦‚æœæ‰”äº† $ k $ æ¬¡ï¼Œé‚£ä¹ˆå°±ä¼šç»™ç©å®¶ $ 2^{k} $ å…ƒçš„å¥–é‡‘ã€‚ç°åœ¨çš„é—®é¢˜æ˜¯ä½ æ„¿æ„èŠ±å¤šå°‘é’±æ¥è´­ä¹°ä¸€æ¬¡ç©è¿™ä¸ªæ¸¸æˆçš„æœºä¼šã€‚\nä¸€ä¸ªå¾ˆè‡ªç„¶çš„æƒ³æ³•æ˜¯è®¡ç®—æ¸¸æˆçš„æœŸæœ›ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¾ˆå®¹æ˜“å‘ç°æœŸæœ›æ”¶ç›Šæ˜¯ $$ \\sum_{k \\geq 1} 2^{k}\\cdot 2^{-k} = 1 + 1 + \\dots = +\\infty $$ è¿™è¯´æ˜å¹³å‡æ¯ä¸€è½®æˆ‘ä»¬çš„æ”¶ç›Šæ˜¯æ— ç©·å¤§ï¼Œç„¶è€Œåœ¨ç°å®ç”Ÿæ´»ä¸­ä½ çœŸçš„æ„¿æ„èŠ±å¤§ä»·é’±å»ç©è¿™ä¸ªæ¸¸æˆå—ï¼Ÿæˆ–è€…å¯ä»¥å†™ä¸€ä¸ªç®€å•çš„ç¨‹åºæ¨¡æ‹Ÿä¸€ä¸‹å°±ä¼šå‘ç°ï¼Œåœ¨æ¯”å¦‚é—¨ç¥¨å®šä¸º $ 100 $ å…ƒï¼Œç©å‡ ç™¾å±€ï¼Œè¿˜æ˜¯ä¼šè½»æ˜“åœ°è¾“æ‰å‡ ä¸‡å—é’±ã€‚æˆ‘ä»¬ç”Ÿæ´»ä¸­ä¸€ä¸ªå¸¸è§çš„ç›´è§‰æ˜¯å¦‚æœé‡å¤ä¸€ä¸ªéšæœºè¿‡ç¨‹è¶³å¤Ÿå¤šæ¬¡ï¼Œå¹³å‡æ”¶ç›Šå°±ä¼šé€æ¸è¶‹è¿‘äºæœŸæœ›æ”¶ç›Šï¼Œè¿™åœ¨æ¦‚ç‡è®ºä¸­å«åšå¤§æ•°å®šå¾‹ï¼ˆLaw of large numbersï¼‰ï¼Œä½†æ˜¯åœ¨ç°å®ç”Ÿæ´»ä¸­æˆ‘ä»¬å¹¶æ²¡æœ‰èƒ½åŠ›é‡å¤è¶³å¤Ÿå¤šæ¸¸æˆè½®æ•°å»è¾¾åˆ°è¿™ä¸ªæœŸæœ›å€¼ã€‚é‚£ä¹ˆç°åœ¨çš„é—®é¢˜å°±æ˜¯å¦‚æœå®šä»·ç”¨ $ a\\cdot n $ å…ƒæ¥è´­ä¹° $ n $ æ¬¡æ¸¸æˆæœºä¼šï¼Œ$ a $ å®šä¸ºå¤šå°‘æ˜¯åˆç†çš„ï¼Ÿ\nç”¨è¿™é—¨è¯¾ä¸­åç»­ä¼šå­¦ä¹ åˆ°çš„æ•°å­¦å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ç­”æ¡ˆä¸º $ \\log n $ ï¼ˆè¿™ä¸ªç»“æœä¹Ÿç¬¦åˆæˆ‘ä»¬å®é™…çš„ç›´è§‰ï¼‰ã€‚\néšæœºæ¸¸èµ° å¯¹äºŒç»´éšæœºæ¸¸èµ°é—®é¢˜çš„ä¸€ä¸ªç®€åŒ–çš„å»ºæ¨¡æ˜¯åœ¨ $ \\mathbb{Z}^{2} $ çš„ç½‘æ ¼ä¸Šéšæœºæ¸¸èµ°ï¼Œä»åŸç‚¹ $ (0,0) $ å‡ºå‘ï¼Œæ¯æ¬¡ä»¥ $ \\dfrac{1}{4} $ çš„æ¦‚ç‡å¾€ä¸Šä¸‹å·¦å³å››ä¸ªæ–¹å‘ç§»åŠ¨ã€‚æˆ‘ä»¬ç°åœ¨è¯¢é—®ï¼Œè¿™ä¸ªéšæœºæ¸¸èµ°çš„è·¯å¾„æ˜¯å¦ä¼šæ— æ•°æ¬¡å›åˆ°åŸç‚¹ï¼Ÿç”¨ $ T $ æ¥è¡¨ç¤ºç¬¬ä¸€æ¬¡å›åˆ°åŸç‚¹çš„æ—¶é—´ï¼Œé‚£ä¹ˆå¯ä»¥è¯æ˜æ— æ•°æ¬¡å›åˆ°åŸç‚¹ç­‰ä»·äº $ \\mathbb{P}[T \u003c \\infty] = 1 $ ï¼Œä¹Ÿå°±æ˜¯ $ T $ ä»¥ $ 1 $ çš„æ¦‚ç‡æ˜¯æœ‰é™çš„ï¼Œå½“ç„¶ç›®å‰åªèƒ½ä»ç›´è§‰ä¸Šå»ç†è§£ï¼Œè¿™ä¸ªå†™æ³•éœ€è¦åœ¨åç»­çš„è¯¾ç¨‹ä¸­å»ä¸¥æ ¼å®šä¹‰ã€‚\nå…³äºè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼Œæ³¢åˆ©äºšè¯æ˜äº†å½“è€ƒè™‘ $ n $ ç»´æ ¼ç‚¹ $ \\mathbb{Z}^{n} $ çš„éšæœºæ¸¸èµ°æ—¶ï¼Œå¯¹äº $ n\u003c 2 $ ï¼Œ$ \\mathbb{P}[T \u003c \\infty] = 1 $ ï¼Œå¯¹äº $ n\\geq 2 $ ï¼Œ$ \\mathbb{P}[T \u003c \\infty] \u003c 1 $ã€‚\næŠ•èµ„ç­–ç•¥é—®é¢˜ è€ƒè™‘ä¸€ä¸ªç®€åŒ–çš„æŠ•èµ„æ¨¡å‹ï¼Œå‡è®¾æœ‰ä¸¤æ”¯è‚¡ç¥¨ï¼Œè¿›è¡Œ $ T $ å¤©çš„äº¤æ˜“ï¼Œæ¯ä¸€å¤©é€‰æ‹©ä¸€æ”¯è‚¡ç¥¨è¿›è¡ŒæŠ•èµ„ã€‚å‡è®¾å½“å‰æ˜¯ $ t $ å¤©ï¼Œåœ¨è¿™ä¸€å¤©å¼€å§‹çš„æ—¶å€™ï¼Œéœ€è¦é€‰å®šæŠ•èµ„å“ªä¸€åªï¼Œåœ¨è¿™ä¸€å¤©ç»“æŸçš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ°æ”¶ç›Šã€‚æˆ‘ä»¬å‡è®¾ä¸¤åªè‚¡ç¥¨åœ¨ç¬¬Â $ t $Â å¤©çš„æ”¶ç›Šæ˜¯Â $ r_{1}^{(t)},r_{2}^{(t)}\\in[0, 1] $ã€‚å‡è®¾ç¬¬Â $ t $Â å¤©ç©å®¶é€‰æ‹©äº†æŠ•èµ„è‚¡ç¥¨Â $ a_{t} $ï¼Œåˆ™ç©å®¶åœ¨Â $ t $Â å¤©çš„æ€»æ”¶ç›Šæ˜¯ $$ R(T):=\\sum_{t=1}^{T} r_{a_{t}}^{(t)} $$ é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•é€‰æ‹©ä¸€ä¸ªå¥½çš„æŠ•èµ„ç­–ç•¥ï¼Ÿ\né¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç¡®å¦‚ä½•è¡¡é‡ä¸€ä¸ªæŠ•èµ„ç­–ç•¥çš„å¥½åã€‚ä¸€ä¸ªå¾ˆè‡ªç„¶çš„å‡è®¾æ˜¯æŠŠ $ R(T) $ çœ‹æˆå…³äº $ T $ çš„å‡½æ•°ï¼Œå¸Œæœ› $ R(T) $ èƒ½è¶Šå¤§è¶Šå¥½ã€‚ä½†æ˜¯æˆ‘ä»¬çš„æ”¶ç›Šä¸ä»…ä»…å’Œæˆ‘ä»¬çš„ç­–ç•¥æœ‰å…³ï¼Œè¿˜å’Œä¸¤åªè‚¡ç¥¨æ¯å¤©çš„æ”¶ç›ŠæŒ‚é’©ï¼Œå‡è®¾å¤§ç¯å¢ƒä¸å¥½ï¼Œä¸¤åªè‚¡ç¥¨éƒ½äºé’±ï¼Œé‚£ä¸ç®¡æŠ•èµ„ç­–ç•¥æ€ä¹ˆæ ·éƒ½ä¸èƒ½è·å¾—é«˜æ”¶ç›Šã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥æƒ³åˆ°ç”¨æˆ‘ä»¬çš„ç­–ç•¥å’Œè¡¨ç°æœ€å¥½çš„è‚¡ç¥¨ç›¸æ¯”ï¼Œè¿™ä¹Ÿå°±æ˜¯æ‡Šæ‚”å€¼ (Regret) çš„å®šä¹‰ï¼šå¯¹äºç»™å®šæŠ•èµ„ç­–ç•¥ï¼Œä»¥åŠæ¯å¤©çš„æ”¶ç›Šæƒ…å†µ $ \\vec{r} = \\left(r_{1}^{(t)}, r_{2}^{(t)}\\right)_{1 \\leq t \\leq T} $ $$ \\text{Regret}(T) := \\left( \\max_{a\\in \\{ 1, 2 \\}} \\sum_{t = 1}^{T}r_{a}^{(t)} \\right) - R(T) $$ æœ´ç´ çš„ç†è§£å°±æ˜¯ï¼Œå› ä¸ºæ²¡æœ‰æœªåœå…ˆçŸ¥è€Œäº§ç”Ÿçš„æ‡Šæ‚”ç¨‹åº¦ã€‚\næˆ‘ä»¬å¸Œæœ›ä¸€ä¸ªå¥½çš„æŠ•èµ„ç­–ç•¥æ˜¯ï¼Œä¸ç®¡è‚¡ç¥¨æ”¶ç›Šå¦‚ä½•ï¼Œæˆ‘ä»¬çš„ $ \\text{Regret}(T) $ éƒ½æ¯”è¾ƒå°ã€‚ç”±äº $ \\text{Regret}(T) \\leq T $ ï¼Œå› æ­¤æˆ‘ä»¬å¸Œæœ›ç­–ç•¥æ»¡è¶³ $ \\text{Regret}(T) = o(T) $ ï¼Œè¿™è¡¨ç¤ºå½“ $ T $ è¶³å¤Ÿå¤§æ—¶ï¼Œæˆ‘ä»¬çš„ç­–ç•¥äº‹å®ä¸Šæ‰¾åˆ°äº†æœ€å¥½çš„è‚¡ç¥¨ã€‚\næˆ‘ä»¬å¯ä»¥è¯æ˜ï¼Œå¯¹äºä»»ä½•ç¡®å®šæ€§çš„ç­–ç•¥ï¼Œéƒ½ä¸å¯èƒ½è¾¾åˆ° $ o(T) $ çš„æ‡Šæ‚”å€¼ã€‚ç”±äºæˆ‘ä»¬çš„ç­–ç•¥æ˜¯ç¡®å®šæ€§çš„ï¼Œç¬¬ $ t $ å¤©çš„é€‰æ‹©å®Œå…¨å–å†³äºå‰ $ t-1 $ å¤©çš„é€‰æ‹©å’Œæ”¶ç›Šï¼Œå› æ­¤å¦‚æœå‡è®¾æœ‰ä¸€ä¸ªåäººé’ˆå¯¹æˆ‘ä»¬çš„ç­–ç•¥æ§åˆ¶äº†å¸‚åœºï¼Œé‚£ä»–å°±å¯ä»¥é¢„æµ‹æˆ‘ä»¬çš„é€‰æ‹©ï¼Œå¦‚æœæˆ‘ä»¬ä¼šé€‰æ‹©è‚¡ç¥¨ $ 1 $ ï¼Œé‚£ä»–å°±è®© $ r_{1}^{(t)}=0, r_{2}^{(t)}=1 $ ï¼Œåä¹‹äº¦ç„¶ã€‚è®¡ç®—è¿™æ—¶å€™çš„æ‡Šæ‚”å€¼ï¼Œå¾ˆå®¹æ˜“å‘ç°åœ¨è¿™æ ·é’ˆå¯¹æ€§çš„è®¾ç½®ä¸‹ $ R(T)=0 $ã€‚å¹¶ä¸”ç”±äºæ¯ä¸€å¤©çš„æ”¶ç›Šä¹‹å’Œéƒ½æ˜¯ $ 1 $ ï¼Œ$ T $ å¤©çš„ç´¯è®¡æ”¶ç›Šä¹‹å’Œä¸º $ T $ï¼Œå› æ­¤ä¸€å®šæœ‰ä¸€ä¸ªè‚¡ç¥¨çš„ $ T $ å¤©ç´¯è®¡æ”¶ç›Šä¹‹å’Œ $ \\geq T / 2 $ ï¼Œè¿™æ˜¯å°±æœ‰ $ \\text{Regret}(T)\\geq T / 2 $ã€‚\nOnline Mirror Descent å¯ä»¥çœ‹å‡ºï¼Œç¡®å®šæ€§çš„ç®—æ³•æ•ˆæœä¹‹æ‰€ä»¥ä¸å¥½ï¼Œæ˜¯å› ä¸ºå¯¹æ‰‹å¯ä»¥è¿›è¡Œé’ˆå¯¹æ€§çš„è®¾ç½®ï¼Œå¯¹åº”çš„æˆ‘ä»¬å¯ä»¥ä½¿ç”¨éšæœºåŒ–çš„ç­–ç•¥æ¥é¿å…è¿™ä¸€ç‚¹ã€‚\nè¿™å°±æ˜¯æ‰€è°“çš„åœ¨çº¿é•œåƒä¸‹é™ï¼ˆOnline Mirror Descentï¼‰ ç®—æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªåœ¨è®¡ç®—æœºç§‘å­¦éå¸¸è‘—åçš„ç®—æ³•ï¼Œåœ¨å¤šä¸ªé¢†åŸŸè¢«é‡æ–°å‘ç°è¿‡ï¼Œå› æ­¤ï¼Œå®ƒä¹Ÿæœ‰å¾ˆå¤šå…¶ä»–çš„åå­—ï¼Œæ¯”å¦‚Â Multiplicative weight update methodï¼ŒHedge ç®—æ³•ï¼ŒEXP3 ç®—æ³•ç­‰ã€‚\nç®—æ³•ä¼šæ¯ä¸€è½®ç»´æŠ¤ä¸€ä¸ªåˆ†å¸ƒ $ D_{t} $ï¼Œç©å®¶çš„å†³ç­–æ¥è‡ªäºä»è¿™ä¸ªåˆ†å¸ƒä¸­çš„é‡‡æ ·ï¼Œå¹¶ä¸”ç®—æ³•ä¼šæ ¹æ®æ¯ä¸ªå›åˆçš„åé¦ˆæ¥æ›´æ–°è¿™ä¸ªåˆ†å¸ƒã€‚\nåˆå§‹æƒ…å†µ $ D_{0}=\\left( \\dfrac{1}{2}, \\dfrac{1}{2} \\right) $. å¯¹äº $ t=1,2,\\dots,T $ é€‰æ‹©è‚¡ç¥¨ $ a_{t}\\sim D_{t} $ï¼Œå¹¶è§‚å¯Ÿå¾—åˆ°çš„ $ r_{1}^{(t)},r_{2}^{(t)} $. æ›´æ–° $ D_{t+1} $ï¼Œä½¿å¾— $ D_{t+1}(i) = \\dfrac{D_{t}(i)\\exp(-\\eta \\cdot(1 - r_{i}^{(t)}))}{\\sum_{k=1,2}D_{t}(k)\\exp(-\\eta \\cdot(1 - r_{k}^{(t)}))} $. å…¶ä¸­çš„å‚æ•° $ \\eta=\\sqrt{ \\dfrac{1}{T} } $ ã€‚ ç®—æ³•æœ¬èº«æ€æƒ³å¾ˆç®€å•ï¼šè¿™ä¸€è½®å“ªä¸ªè‚¡ç¥¨è¡¨ç°å¥½ï¼Œå°±åœ¨ä¸‹ä¸€è½®å¢åŠ å®ƒè¢«é€‰å–çš„æ¦‚ç‡ã€‚ç„¶åä¸ºä»€ä¹ˆè¦åƒç®—æ³•è¿™æ ·æ“ä½œï¼Œèƒ½ä¸èƒ½ç”¨åˆ«çš„æ–¹å¼è®¡ç®—ï¼ŒèƒŒåçš„é“ç†å°±è¦å¤æ‚å¾—å¤šã€‚\nå¯ä»¥è¯æ˜è¿™ä¸ªç®—æ³•æ»¡è¶³åœ¨æœŸæœ›ä¸Š $ \\text{Regret}(T)=o(\\sqrt{ T }) $ï¼ˆè¿™ä¸ªç»“æœå¹¶éæœ€ä¼˜ï¼‰ã€‚è¿™ä¸ªç»“è®ºè¡¨ç¤ºï¼Œæœ‰äº›æ—¶å€™ä½¿ç”¨éšæœºåŒ–ï¼Œå¯ä»¥è®©ç®—æ³•çš„æ•ˆæœäº§ç”Ÿè´¨å˜ã€‚\n","permalink":"https://diefish1024.github.io/posts/class-notes/math2701-probability-theory/lect1-introduction/","summary":"\u003cp\u003e\u003ca href=\"https://chihaozhang.com/teaching/Prob2025/lectures/lec1/lec1.html\"\u003eè¯¾ç¨‹è®²ä¹‰\u003c/a\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eåœ¨è¿™é—¨è¯¾é‡Œï¼Œæˆ‘ä»¬ä¼šä¸“æ³¨äºæ‰€è°“çš„ \u003ca href=\"https://en.wikipedia.org/wiki/Probability_axioms\"\u003eç§‘å°”è«å“¥æ´›å¤«ï¼ˆKolmogorovï¼‰çš„å…¬ç†ä½“ç³»\u003c/a\u003eï¼Œå®ƒä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨æ•°å­¦åˆ†æçš„å·¥å…·æ¥ç ”ç©¶æ¦‚ç‡ã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003ch2 id=\"stpetersburg-paradox\"\u003e\u003ca href=\"https://en.wikipedia.org/wiki/St._Petersburg_paradox\"\u003eSt.Â Petersburg Paradox\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eåœ£å½¼å¾—å ¡æ‚–è®ºã€‚å‡è®¾ä¸€ä¸ªåŸºäºæŠ›ç¡¬å¸èµŒåšçš„æ¸¸æˆï¼Œåº„å®¶ä¼šä¸€ç›´æ‰”ç¡¬å¸ç›´åˆ°ç»“æœæ˜¯æ­£é¢ï¼Œå¦‚æœæ‰”äº† $ k $ æ¬¡ï¼Œé‚£ä¹ˆå°±ä¼šç»™ç©å®¶ $ 2^{k} $ å…ƒçš„å¥–é‡‘ã€‚ç°åœ¨çš„é—®é¢˜æ˜¯ä½ æ„¿æ„èŠ±å¤šå°‘é’±æ¥è´­ä¹°ä¸€æ¬¡ç©è¿™ä¸ªæ¸¸æˆçš„æœºä¼šã€‚\u003c/p\u003e\n\u003cp\u003eä¸€ä¸ªå¾ˆè‡ªç„¶çš„æƒ³æ³•æ˜¯è®¡ç®—æ¸¸æˆçš„æœŸæœ›ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¾ˆå®¹æ˜“å‘ç°æœŸæœ›æ”¶ç›Šæ˜¯\n$$ \n\n\\sum_{k \\geq  1} 2^{k}\\cdot 2^{-k} = 1 + 1 + \\dots = +\\infty\n\n $$\nè¿™è¯´æ˜å¹³å‡æ¯ä¸€è½®æˆ‘ä»¬çš„æ”¶ç›Šæ˜¯æ— ç©·å¤§ï¼Œç„¶è€Œåœ¨ç°å®ç”Ÿæ´»ä¸­ä½ çœŸçš„æ„¿æ„èŠ±å¤§ä»·é’±å»ç©è¿™ä¸ªæ¸¸æˆå—ï¼Ÿæˆ–è€…å¯ä»¥å†™ä¸€ä¸ªç®€å•çš„ç¨‹åºæ¨¡æ‹Ÿä¸€ä¸‹å°±ä¼šå‘ç°ï¼Œåœ¨æ¯”å¦‚é—¨ç¥¨å®šä¸º $ 100 $ å…ƒï¼Œç©å‡ ç™¾å±€ï¼Œè¿˜æ˜¯ä¼šè½»æ˜“åœ°è¾“æ‰å‡ ä¸‡å—é’±ã€‚æˆ‘ä»¬ç”Ÿæ´»ä¸­ä¸€ä¸ªå¸¸è§çš„ç›´è§‰æ˜¯å¦‚æœé‡å¤ä¸€ä¸ªéšæœºè¿‡ç¨‹è¶³å¤Ÿå¤šæ¬¡ï¼Œå¹³å‡æ”¶ç›Šå°±ä¼šé€æ¸è¶‹è¿‘äºæœŸæœ›æ”¶ç›Šï¼Œè¿™åœ¨æ¦‚ç‡è®ºä¸­å«åš\u003cstrong\u003eå¤§æ•°å®šå¾‹ï¼ˆ\u003ca href=\"https://en.wikipedia.org/wiki/Law_of_large_numbers\"\u003eLaw of large numbers\u003c/a\u003eï¼‰\u003c/strong\u003eï¼Œä½†æ˜¯åœ¨ç°å®ç”Ÿæ´»ä¸­æˆ‘ä»¬å¹¶æ²¡æœ‰èƒ½åŠ›é‡å¤è¶³å¤Ÿå¤šæ¸¸æˆè½®æ•°å»è¾¾åˆ°è¿™ä¸ªæœŸæœ›å€¼ã€‚é‚£ä¹ˆç°åœ¨çš„é—®é¢˜å°±æ˜¯å¦‚æœå®šä»·ç”¨ $ a\\cdot n $ å…ƒæ¥è´­ä¹° $ n $ æ¬¡æ¸¸æˆæœºä¼šï¼Œ$ a $ å®šä¸ºå¤šå°‘æ˜¯åˆç†çš„ï¼Ÿ\u003c/p\u003e\n\u003cp\u003eç”¨è¿™é—¨è¯¾ä¸­åç»­ä¼šå­¦ä¹ åˆ°çš„æ•°å­¦å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ç­”æ¡ˆä¸º $ \\log n $ ï¼ˆè¿™ä¸ªç»“æœä¹Ÿç¬¦åˆæˆ‘ä»¬å®é™…çš„ç›´è§‰ï¼‰ã€‚\u003c/p\u003e\n\u003ch2 id=\"éšæœºæ¸¸èµ°\"\u003eéšæœºæ¸¸èµ°\u003c/h2\u003e\n\u003cp\u003eå¯¹äºŒç»´éšæœºæ¸¸èµ°é—®é¢˜çš„ä¸€ä¸ªç®€åŒ–çš„å»ºæ¨¡æ˜¯åœ¨ $ \\mathbb{Z}^{2} $ çš„ç½‘æ ¼ä¸Šéšæœºæ¸¸èµ°ï¼Œä»åŸç‚¹ $ (0,0) $ å‡ºå‘ï¼Œæ¯æ¬¡ä»¥ $ \\dfrac{1}{4} $ çš„æ¦‚ç‡å¾€ä¸Šä¸‹å·¦å³å››ä¸ªæ–¹å‘ç§»åŠ¨ã€‚æˆ‘ä»¬ç°åœ¨è¯¢é—®ï¼Œè¿™ä¸ªéšæœºæ¸¸èµ°çš„è·¯å¾„æ˜¯å¦ä¼šæ— æ•°æ¬¡å›åˆ°åŸç‚¹ï¼Ÿç”¨ $ T $ æ¥è¡¨ç¤ºç¬¬ä¸€æ¬¡å›åˆ°åŸç‚¹çš„æ—¶é—´ï¼Œé‚£ä¹ˆå¯ä»¥è¯æ˜æ— æ•°æ¬¡å›åˆ°åŸç‚¹ç­‰ä»·äº $ \\mathbb{P}[T \u003c \\infty] = 1 $ ï¼Œä¹Ÿå°±æ˜¯ $ T $ ä»¥ $ 1 $ çš„æ¦‚ç‡æ˜¯æœ‰é™çš„ï¼Œå½“ç„¶ç›®å‰åªèƒ½ä»ç›´è§‰ä¸Šå»ç†è§£ï¼Œè¿™ä¸ªå†™æ³•éœ€è¦åœ¨åç»­çš„è¯¾ç¨‹ä¸­å»ä¸¥æ ¼å®šä¹‰ã€‚\u003c/p\u003e","title":"Lect1-Introduction"},{"content":"æœ¬æ–‡ç®€è¦ä»‹ç»é€šç”¨çŸ©é˜µä¹˜ï¼ˆGEMMï¼ŒGeneral Matrix Multiplicationï¼‰ä¼˜åŒ–çš„åŸºæœ¬æ¦‚å¿µå’Œæ–¹æ³•ã€‚GEMM æ˜¯ HPC é¢†åŸŸä¸­æœ€åŸºç¡€ä¸”è®¡ç®—å¯†é›†å‹çš„å·¥ä½œè´Ÿè½½ä¹‹ä¸€ã€‚åœ¨äººå·¥æ™ºèƒ½ã€ç§‘å­¦æ¨¡æ‹Ÿå’Œå›¾åƒå¤„ç†ç­‰é¢†åŸŸï¼Œå®ƒçš„æ€§èƒ½ç›´æ¥å½±å“ç€æ•´ä¸ªåº”ç”¨ç¨‹åºçš„æ•ˆç‡ã€‚è™½ç„¶å…¶æ•°å­¦æ¦‚å¿µç®€å•ï¼Œä½†é«˜æ•ˆçš„ GEMM å®ç°å´éœ€è¦å¯¹è®¡ç®—æœºä½“ç³»ç»“æ„æœ‰æ·±åˆ»çš„ç†è§£ï¼ŒåŒ…æ‹¬ç¼“å­˜ã€SIMD æŒ‡ä»¤é›†å’Œå¹¶è¡ŒåŒ–æŠ€æœ¯ã€‚\nNaive GEMM GEMM é€šå¸¸å®šä¹‰ä¸º $ C = A \\times B $ï¼Œå¯¹äºçŸ©é˜µ $ A \\in \\mathbb{R}^{M \\times K} $ï¼ŒçŸ©é˜µ $ B \\in \\mathbb{R}^{K \\times N} $ï¼Œå…¶ä¹˜ç§¯çŸ©é˜µ $ C\\in \\mathbb{R}^{M \\times N} $ å¯ä»¥è¡¨ç¤ºä¸º $$ C_{i,j} = \\sum_{k=0}^{K-1} A_{i,k}\\times B_{k,j} $$ å¯¹åº”çš„æœ´ç´ ä»£ç é€šå¸¸å¦‚ä¸‹ï¼ˆé»˜è®¤è¡Œä¸»åºå­˜å‚¨ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 void gemm_naive(int M, int N, int K, const float* A, const float* B, float* C) { for (int i = 0; i \u0026lt; M; ++i) { for (int j = 0; j \u0026lt; N; ++j) { C[i][j] = 0.0f; // åˆå§‹åŒ– C[i][j] } } for (int i = 0; i \u0026lt; M; ++i) { for (int j = 0; j \u0026lt; N; ++j) { for (int k = 0; k \u0026lt; K; ++k) { C[i][j] += A[i][k] * B[k][j]; } } } } åˆ†æï¼š\næµ®ç‚¹è¿ç®—æ€»æ•°ï¼ˆFLOPsï¼‰ï¼š\nå¯¹äºæ¯ä¸ª $ C_{i,j} $ å…ƒç´ ï¼Œéœ€è¦æ‰§è¡Œ $ K $ æ¬¡ä¹˜æ³•å’Œ $ K $ æ¬¡åŠ æ³•ã€‚ æ€»å…±æœ‰ $ M \\times N $ ä¸ª $ C_{i,j} $ å…ƒç´ ã€‚ æ€»æ“ä½œæ•°çº¦ä¸º $ 2 \\times M \\times N \\times K $ æ¬¡æµ®ç‚¹è¿ç®—ã€‚ å†…å­˜è®¿é—®æ€»æ•°ï¼šå¿½ç•¥å¾ªç¯å˜é‡å’ŒæŒ‡ä»¤çš„å¼€é”€ã€‚\nçŸ©é˜µ $ C $ çš„åˆå§‹åŒ–éœ€è¦ $ M \\times N $ æ¬¡å†™å…¥ï¼›å¾ªç¯ä¸­çŸ©é˜µ $ A $ å’ŒçŸ©é˜µ $ B $ åˆ†åˆ«è¢«è¯»å– $ M \\times N \\times K $ æ¬¡ï¼ŒçŸ©é˜µ $ C $ è¢«è¯»å–å’Œå†™å…¥å…± $ 2 \\times M \\times N \\times K $ æ¬¡ã€‚ æ€»å†…å­˜è®¿é—®æ¬¡æ•°çº¦ä¸º $ 4 M N K + M N $ã€‚ Why Slow? å°½ç®¡ä»£ç ç®€æ´ï¼Œä½†è¿™ç§å®ç°æ–¹å¼å­˜åœ¨ä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆï¼š\nç¼“å­˜åˆ©ç”¨ç‡ä½ï¼šå¯¹ B[k][j] çš„è®¿é—®å¤§æ¦‚ç‡å¯¼è‡´ç¼“å­˜æœªå‘½ä¸­ã€‚ç”±äº B æ˜¯è¡Œä¸»åºå­˜å‚¨ï¼Œæ¯æ¬¡è¿­ä»£ k éƒ½ä¼šè·³åˆ° B çŸ©é˜µçš„ä¸‹ä¸€è¡Œï¼Œè¿™å¯¼è‡´å·¨å¤§çš„å†…å­˜è·¨è¶Šï¼Œç ´åäº†ç©ºé—´å±€éƒ¨æ€§ã€‚\nç¼ºä¹ SIMD å‘é‡åŒ–æ½œåŠ›ï¼šç¼–è¯‘å™¨å¾ˆéš¾å°†è¿™ç§æ··åˆè®¿é—®æ¨¡å¼æœ‰æ•ˆå‘é‡åŒ–ï¼Œå› ä¸ºå¯¹ $ B $ çš„è®¿é—®æ¨¡å¼ä¸ä½³ã€‚\nç®—æ³•æœ¬èº«æ—¶é—´å¤æ‚åº¦ä¸º $ O(N^{3}) $ã€‚\nå¯¹è¿™æ ·çš„çŸ©é˜µä¹˜çš„ç®—æ³•ä¼˜åŒ–å¯åˆ†ä¸ºä¸¤ç±»ï¼š\nåŸºäºç®—æ³•åˆ†æçš„æ–¹æ³•ï¼šæ ¹æ®çŸ©é˜µä¹˜è®¡ç®—ç‰¹æ€§ï¼Œä»æ•°å­¦è§’åº¦ä¼˜åŒ–ï¼Œå…¸å‹çš„ç®—æ³•åŒ…æ‹¬Â Strassen ç®—æ³• å’ŒÂ Coppersmithâ€“Winograd ç®—æ³•ã€‚ åŸºäºè½¯ä»¶ä¼˜åŒ–çš„æ–¹æ³•ï¼šæ ¹æ®è®¡ç®—æœºå­˜å‚¨ç³»ç»Ÿçš„å±‚æ¬¡ç»“æ„ç‰¹æ€§ï¼Œé€‰æ‹©æ€§åœ°è°ƒæ•´è®¡ç®—é¡ºåºï¼Œä¸»è¦æœ‰å¾ªç¯æ‹†åˆ†å‘é‡åŒ–ã€å†…å­˜é‡æ’ç­‰ã€‚ æ•°å­¦è§’åº¦çš„ä¼˜åŒ–æš‚ä¸”ä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒå›´å†…ï¼Œæœ‰æœºä¼šå°†å•ç‹¬ä»‹ç»ï¼Œä¸‹é¢ç»™å‡ºè®¡ç®—æœºä½“ç³»ç»“æ„è§’åº¦çš„ä¸€äº›ä¼˜åŒ–è§’åº¦ã€‚\n1 Ã— 4 Register Blocking å‚è€ƒ how to optimize gemm ä¸€æ–‡ï¼Œæˆ‘ä»¬æŠŠè¾“å‡ºçš„è®¡ç®—æŒ‰ç…§åˆ—æ‹†åˆ†æˆè‹¥å¹²ä¸ª $ 1 \\times 4 $ çš„å°å—ï¼Œé€šè¿‡ä¸€æ¬¡æ€§å¤„ç† $ C $ çš„ä¸€å°å—å†…å­˜æ¥å‡å°‘å†…å­˜æ“ä½œï¼Œæœ€å¤§åŒ–å¯„å­˜å™¨çš„åˆ©ç”¨ç‡ã€‚\nä¸å…¶ä¸€æ¬¡è®¡ç®— $ C_{i,j} $ ä¸€ä¸ªå…ƒç´ ï¼Œä¸å¦‚ä¸€æ¬¡æ€§è®¡ç®— $ C_{i, j\\sim j+3} $ å››ä¸ªè¿ç»­å…ƒç´ ï¼Œè¿™å¾ˆå¥½åœ°åˆ©ç”¨äº† $ C $ çŸ©é˜µè¡Œå†…çš„ç©ºé—´å±€éƒ¨æ€§ã€‚æŠŠè¿™å››ä¸ªå…ƒç´ åŠ è½½åˆ°å¯„å­˜å™¨ï¼Œå¯ä»¥å¤§å¤§å‡å°‘å¯¹ä¸»å­˜çš„è®¿é—®æ¬¡æ•°ã€‚\nä¸‹æ–‡æˆ‘ä»¬å°†æœ€å†…å±‚çš„å¾ªç¯ç§°ä¸ºå¾®å†…æ ¸ï¼ˆmicro kernelï¼‰ï¼Œæ¯”å¦‚ AddDot1x4 å°±æ˜¯ä¸€ä¸ªå¾®å†…æ ¸ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // AddDot1x4: è®¡ç®— C çš„ä¸€ä¸ª 1x4 å—ï¼ˆæŒ‰è¡Œä¸»åºï¼‰ // Ai æŒ‡å‘ A çš„ç¬¬ i è¡Œèµ·å§‹ï¼›Bj æŒ‡å‘ B çš„ç¬¬ j åˆ—æ‰€åœ¨çš„èµ·å§‹ä½ç½®ï¼›Cij æŒ‡å‘ C[i][j] inline void AddDot1x4(int K, const float* Ai, const float* Bj, float* Cij, int N) { float c0 = 0.0f, c1 = 0.0f, c2 = 0.0f, c3 = 0.0f; for (int k = 0; k \u0026lt; K; ++k) { float a = Ai[k]; const float* bk = Bj + k * N; // B[k][j..j+3] c0 += a * bk[0]; c1 += a * bk[1]; c2 += a * bk[2]; c3 += a * bk[3]; } Cij[0] = c0; Cij[1] = c1; Cij[2] = c2; Cij[3] = c3; } void gemm_1x4_blocked(int M, int N, int K, const float* A, const float* B, float* C) { for (int i = 0; i \u0026lt; M; ++i) { const float* Ai = \u0026amp;A[i * K]; for (int j = 0; j \u0026lt; N; j += 4) { int w = std::min(4, N - j); if (w == 4) { AddDot1x4(K, Ai, \u0026amp;B[j], \u0026amp;C[i * N + j], N); } else { // å¤„ç†å°¾éƒ¨ \u0026lt;4 åˆ— for (int jj = 0; jj \u0026lt; w; ++jj) { float acc = 0.f; for (int k = 0; k \u0026lt; K; ++k) acc += Ai[k] * B[k * N + (j + jj)]; C[i * N + j + jj] = acc; } } } } } åˆ†æï¼š\nFLOPsï¼šä»ä¸º $ 2 M N K $ã€‚ å†…å­˜è®¿é—®ï¼šï¼ˆä»¥å…ƒç´ è®¡ï¼Œå¿½ç•¥ç¼“å­˜å‘½ä¸­ï¼‰ è¯»å– $ A $ï¼šå¯¹æ¯ä¸ª $ 1 \\times 4 $ å—ï¼Œæ¯æ¬¡ $ K $ æ¬¡ï¼Œå…± $ \\frac{M N}{4} \\times K = \\frac{M N K}{4} $ã€‚ è¯»å– $ B $ï¼šæ¯æ¬¡ $ 4K $ï¼Œå…± $ \\frac{M N}{4} \\times 4K = M N K $ã€‚ å†™å…¥ $ C $ï¼šæ¯å—å†™ $ 4 $ æ¬¡ï¼Œå…± $ M N $ã€‚æ— éœ€è¯»å– $ C $ï¼ˆå¯„å­˜å™¨ç´¯åŠ åèµ‹å€¼ï¼‰ã€‚ åˆè®¡ï¼š$ \\frac{1}{4} M N K + 1 \\cdot M N K + M N = 1.25\\, M N K + M N $ã€‚ ä¸ naive ç›¸æ¯”ï¼Œ$ A $ çš„è¯»å–å‡å°‘äº† $ 4 \\times $ï¼ˆå¤ç”¨åˆ° 4 ä¸ªè¿ç»­åˆ—ï¼‰ï¼Œ$ B $ çš„è¯»å–æ¬¡æ•°ç›¸åŒä½†è¿ç»­è®¿é—®æ›´å‹å¥½ï¼Œ$ C $ çš„è®¿å­˜ä»æ¯æ¬¡è¿­ä»£è¯»å†™é™ä¸ºä»…å†™ä¸€æ¬¡ã€‚\nåŠ é€Ÿæ¯”ï¼š\nåœ¨å†…å­˜å¸¦å®½ä¸»å¯¼çš„ Roofline æ¨¡å‹ ä¸‹ï¼Œæ€§èƒ½ä¸å†…å­˜è®¿é—®æ¬¡æ•°è¿‘ä¼¼æˆåæ¯”ï¼Œå› æ­¤åŠ é€Ÿæ¯”ä¸º $$ S_{\\text{1x4}} \\approx \\frac{4 M N K + M N}{1.25 M N K + M N} \\approx \\frac{4}{1.25} = 3.2 \\quad (K \\gg 1) $$\nLoop Unrolling and Pointer Optimization ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œæˆ‘ä»¬åœ¨ AddDot1x4 å†…éƒ¨ä½¿ç”¨æŒ‡é’ˆè¿­ä»£ä¸å¾ªç¯å±•å¼€ï¼Œå‡å°‘åœ°å€è®¡ç®—å’Œåˆ†æ”¯å¼€é”€ï¼Œæå‡æŒ‡ä»¤çº§å¹¶è¡Œæ€§ä¸å¯„å­˜å™¨åˆ©ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 inline void AddDot1x4_unroll4(int K, const float* Ai, const float* Bj, float* Cij, int N) { float c0 = 0.f, c1 = 0.f, c2 = 0.f, c3 = 0.f; const float* a = Ai; const float* b = Bj; int k = 0; for (; k + 3 \u0026lt; K; k += 4) { float a0 = a[0], a1 = a[1], a2 = a[2], a3 = a[3]; const float* b0 = b + 0 * N; const float* b1 = b + 1 * N; const float* b2 = b + 2 * N; const float* b3 = b + 3 * N; c0 += a0 * b0[0] + a1 * b1[0] + a2 * b2[0] + a3 * b3[0]; c1 += a0 * b0[1] + a1 * b1[1] + a2 * b2[1] + a3 * b3[1]; c2 += a0 * b0[2] + a1 * b1[2] + a2 * b2[2] + a3 * b3[2]; c3 += a0 * b0[3] + a1 * b1[3] + a2 * b2[3] + a3 * b3[3]; a += 4; b += 4 * N; } for (; k \u0026lt; K; ++k) { float av = *a++; const float* bk = b; b += N; c0 += av * bk[0]; c1 += av * bk[1]; c2 += av * bk[2]; c3 += av * bk[3]; } Cij[0] = c0; Cij[1] = c1; Cij[2] = c2; Cij[3] = c3; } åˆ†æï¼š\nFLOPsï¼šä»ä¸º $ 2 M N K $ã€‚ å†…å­˜è®¿é—®ï¼šä¸ $ 1 \\times 4 $ ç›¸åŒï¼ˆ$ 1.25\\, M N K + M N $ï¼‰ï¼Œä»…å‡å°‘äº†åœ°å€è®¡ç®—å’Œåˆ†æ”¯å¼€é”€ã€‚ åŠ é€Ÿæ¯”ï¼š\nå†…å­˜ä¸»å¯¼ï¼šä¸ $ 1 \\times 4 $ ç›¸åŒï¼Œçº¦ $ 3.2 \\times $ã€‚ è®¡ç®—ä¸»å¯¼ï¼šå¾ªç¯å±•å¼€å¯è¿›ä¸€æ­¥å‡å°‘æŒ‡ä»¤å¼€é”€ï¼Œå¸¸è§æå‡åœ¨ $ 5\\% \\sim 15\\% $ èŒƒå›´ï¼ˆä¸ç¼–è¯‘å™¨å’Œå¾®æ¶æ„ç›¸å…³ï¼‰ã€‚ 4 Ã— 4 Register Blocking ä¸éš¾æ„è¯†åˆ°ï¼Œç”¨ä¸€æ ·çš„é€»è¾‘å¯ä»¥æŠŠä¸Šé¢çš„å¯„å­˜å™¨åˆ†å—ä» $ 1 \\times 4 $ æ‰©å±•åˆ° $ 4 \\times 4 $ã€‚è¿™æ ·å¯ä»¥è¿›ä¸€æ­¥å‡å°‘å†…å­˜æ“ä½œï¼Œæé«˜æ•ˆç‡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // AddDot4x4: è®¡ç®— C çš„ä¸€ä¸ª 4x4 å—ï¼ˆè¡Œä¸»åºï¼Œä¼ å…¥ C çš„èµ·å§‹ä¸º C[i][j]ï¼‰ inline void AddDot4x4(int K, const float* Aij, const float* Bkj, float* Cij, int N, int Kstride) { float c00=0.f,c01=0.f,c02=0.f,c03=0.f, c10=0.f,c11=0.f,c12=0.f,c13=0.f, c20=0.f,c21=0.f,c22=0.f,c23=0.f, c30=0.f,c31=0.f,c32=0.f,c33=0.f; const float* a0 = Aij + 0 * Kstride; const float* a1 = Aij + 1 * Kstride; const float* a2 = Aij + 2 * Kstride; const float* a3 = Aij + 3 * Kstride; for (int k = 0; k \u0026lt; K; ++k) { float a0k = a0[k], a1k = a1[k], a2k = a2[k], a3k = a3[k]; const float* bk = Bkj + k * N; float b0 = bk[0], b1 = bk[1], b2 = bk[2], b3 = bk[3]; c00 += a0k * b0; c01 += a0k * b1; c02 += a0k * b2; c03 += a0k * b3; c10 += a1k * b0; c11 += a1k * b1; c12 += a1k * b2; c13 += a1k * b3; c20 += a2k * b0; c21 += a2k * b1; c22 += a2k * b2; c23 += a2k * b3; c30 += a3k * b0; c31 += a3k * b1; c32 += a3k * b2; c33 += a3k * b3; } Cij[0*N+0]=c00; Cij[0*N+1]=c01; Cij[0*N+2]=c02; Cij[0*N+3]=c03; Cij[1*N+0]=c10; Cij[1*N+1]=c11; Cij[1*N+2]=c12; Cij[1*N+3]=c13; Cij[2*N+0]=c20; Cij[2*N+1]=c21; Cij[2*N+2]=c22; Cij[2*N+3]=c23; Cij[3*N+0]=c30; Cij[3*N+1]=c31; Cij[3*N+2]=c32; Cij[3*N+3]=c33; } åˆ†æï¼š\nFLOPsï¼šä»ä¸º $ 2 M N K $ã€‚ å†…å­˜è®¿é—®ï¼ˆå…ƒç´ è®¡ï¼‰ï¼š è¯»å– $ A $ï¼šæ¯å— $ 4K $ï¼Œå—æ•° $ \\frac{M}{4}\\times\\frac{N}{4} $ï¼Œåˆè®¡ $ \\frac{M N K}{4} $ã€‚ è¯»å– $ B $ï¼šæ¯å— $ 4K $ï¼ŒåŒä¸Šåˆè®¡ $ \\frac{M N K}{4} $ã€‚ å†™å…¥ $ C $ï¼šæ¯å— $ 16 $ æ¬¡ï¼Œå…± $ M $ã€‚ åˆè®¡ï¼š$ 0.5\\, M N K + M N $ã€‚ ä¸ $ 1 \\times 4 $ ç›¸æ¯”ï¼Œ$ B $ çš„è¯»å–ä¹Ÿå‡å°‘äº† $ 4 \\times $ï¼ˆåŒä¸€æ‰¹ $ B[k, j..j+3] $ å¤ç”¨åˆ° 4 è¡Œï¼‰ï¼Œå› æ­¤æ€»ä½“å†…å­˜è®¿é—®æ˜¾è‘—ä¸‹é™ã€‚\nåŠ é€Ÿæ¯”ï¼š $$ S_{\\text{4x4}} \\approx \\frac{4 M N K + M N}{0.5 M N K + M N} \\approx \\frac{4}{0.5} = 8 \\quad (K \\gg 1) $$\nSIMD Vectorization ç°åœ¨æˆ‘ä»¬å¼•å…¥ SIMDï¼Œä»¥ Intel SSE æŒ‡ä»¤é›†ä¸ºä¾‹ï¼ˆ128-bitï¼Œå•ç²¾åº¦å®½åº¦ $ W = 4 $ï¼‰ã€‚ä¸‹é¢ç»™å‡ºä¸ AddDot4x4 å¯¹é½çš„ç®€åŒ–å‘é‡åŒ–å¾®å†…æ ¸ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 #include \u0026lt;immintrin.h\u0026gt; inline void AddDot4x4_SSE(int K, const float* Aij, const float* Bkj, float* Cij, int N, int Kstride) { __m128 c0 = _mm_setzero_ps(); __m128 c1 = _mm_setzero_ps(); __m128 c2 = _mm_setzero_ps(); __m128 c3 = _mm_setzero_ps(); const float* a0 = Aij + 0 * Kstride; const float* a1 = Aij + 1 * Kstride; const float* a2 = Aij + 2 * Kstride; const float* a3 = Aij + 3 * Kstride; for (int k = 0; k \u0026lt; K; ++k) { __m128 b = _mm_loadu_ps(\u0026amp;Bkj[k * N]); // B[k][j..j+3] __m128 a0v = _mm_set1_ps(a0[k]); __m128 a1v = _mm_set1_ps(a1[k]); __m128 a2v = _mm_set1_ps(a2[k]); __m128 a3v = _mm_set1_ps(a3[k]); c0 = _mm_add_ps(c0, _mm_mul_ps(a0v, b)); c1 = _mm_add_ps(c1, _mm_mul_ps(a1v, b)); c2 = _mm_add_ps(c2, _mm_mul_ps(a2v, b)); c3 = _mm_add_ps(c3, _mm_mul_ps(a3v, b)); } _mm_storeu_ps(\u0026amp;Cij[0 * N], c0); _mm_storeu_ps(\u0026amp;Cij[1 * N], c1); _mm_storeu_ps(\u0026amp;Cij[2 * N], c2); _mm_storeu_ps(\u0026amp;Cij[3 * N], c3); } åˆ†æï¼š\nFLOPsï¼šä»ä¸º $ 2 M N K $ã€‚ å†…å­˜è®¿é—®ï¼šä¸æ ‡é‡ 4Ã—4 ç›¸åŒï¼ˆ$ 0.5\\, M N K + M N $ï¼‰ã€‚SIMD ä»…æ”¹å˜ç®—æœ¯ååï¼Œä¸æ”¹å˜ DRAM è®¿å­˜é‡ã€‚ è®¡ç®—ä¸»å¯¼åœºæ™¯çš„ç†è®ºåŠ é€Ÿï¼šçº¦ç­‰äºå‘é‡å®½åº¦ $ W $ï¼ˆSSE å•ç²¾åº¦ä¸º $ 4 $ï¼›AVX2 ä¸º $ 8 $ï¼›AVX-512 ä¸º $ 16 $ï¼‰ã€‚è‹¥æ”¯æŒ FMAï¼ˆå¦‚ AVX2/FMAã€AVX-512ï¼‰ï¼Œæ¯å‘¨æœŸå¯è¿›ä¸€æ­¥æå‡ã€‚ åŠ é€Ÿæ¯”ï¼š\nå†…å­˜ä¸»å¯¼ï¼šçº¦ $ 8 \\times $ï¼ˆåŒ 4Ã—4ï¼‰ã€‚ è®¡ç®—ä¸»å¯¼ï¼š 4Ã—4 ä¸ SIMD çš„æ”¶ç›Šä¸å¯ç›´æ¥ç›¸ä¹˜ï¼Œçº¦ $ 8 \\times W $ çš„ä¸Šç•Œä¸æˆç«‹ï¼›æ›´å®é™…çš„ä¼°è®¡æ˜¯ï¼šåœ¨ 4Ã—4 å°†ç®—æœ¯å¼ºåº¦æ˜¾è‘—æå‡åï¼Œè‹¥ä»å¤„äºè®¡ç®—ä¸»å¯¼ï¼Œåˆ™ SIMD å¯å†å¸¦æ¥ $ W \\times $ å·¦å³çš„é¢å¤–æå‡ã€‚ Cache Blockingï¼ˆMacro-kernelï¼‰ å°½ç®¡ SIMD å’Œå¯„å­˜å™¨åˆ†å—ï¼ˆå¾®å†…æ ¸ï¼‰å¸¦æ¥äº†å·¨å¤§çš„æ€§èƒ½æå‡ï¼Œä½†å½“çŸ©é˜µå°ºå¯¸è¶…å‡º CPU ç¼“å­˜å®¹é‡æ—¶ï¼Œæ€§èƒ½ä»ä¼šå› é«˜æ˜‚çš„å†…å­˜è®¿é—®å»¶è¿Ÿè€Œä¸‹é™ã€‚ç¼“å­˜åˆ†å— (Cache Blocking) æ—¨åœ¨å°†çŸ©é˜µæ“ä½œåˆ†è§£æˆä¸€ç³»åˆ—å°å—æ“ä½œï¼Œä½¿è¿™äº›å—çš„æ•°æ®èƒ½å¤Ÿé•¿æ—¶é—´é©»ç•™åœ¨ä¸åŒçº§åˆ«çš„ç¼“å­˜ä¸­ï¼ˆä¾‹å¦‚ L1ã€L2ã€L3ï¼‰ï¼Œä»è€Œå®ç°æ•°æ®é‡ç”¨æœ€å¤§åŒ–ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // ç¼“å­˜åˆ†å— + 4x4 å¾®å†…æ ¸ void gemm_blocked_4x4(int M, int N, int K, const float* A, const float* B, float* C) { const int MR = 4, NR = 4; const int KC = 128; // éœ€æŒ‰æ¶æ„è°ƒä¼˜ for (int kk = 0; kk \u0026lt; K; kk += KC) { int Kc = std::min(KC, K - kk); for (int i = 0; i \u0026lt; M; i += MR) { int Mb = std::min(MR, M - i); for (int j = 0; j \u0026lt; N; j += NR) { int Nb = std::min(NR, N - j); if (Mb == MR \u0026amp;\u0026amp; Nb == NR) { AddDot4x4(Kc, \u0026amp;A[i * K + kk], \u0026amp;B[kk * N + j], \u0026amp;C[i * N + j], N, K); } else { // é€€åŒ–å¤„ç† for (int ii = 0; ii \u0026lt; Mb; ++ii) for (int jj = 0; jj \u0026lt; Nb; ++jj) { float acc = 0.f; for (int k = 0; k \u0026lt; Kc; ++k) acc += A[(i + ii) * K + (kk + k)] * B[(kk + k) * N + (j + jj)]; C[(i + ii) * N + (j + jj)] = acc + C[(i + ii) * N + (j + jj)]; } } } } } } åˆ†æï¼š\nFLOPsï¼šä»ä¸º $ 2 M N K $ã€‚ DRAM çº§å†…å­˜è®¿é—®ï¼šï¼ˆç†æƒ³åˆ†å—å¹¶æœ‰è‰¯å¥½å¤ç”¨æ—¶ï¼‰ $ A $ï¼šæ¯ä¸ªå…ƒç´ ä» DRAM è¯»å…¥çº¦ $ 1 $ æ¬¡ï¼Œ$ M K $ã€‚ $ B $ï¼šæ¯ä¸ªå…ƒç´ ä» DRAM è¯»å…¥çº¦ $ 1 $ æ¬¡ï¼Œ$ K N $ã€‚ $ C $ï¼šæ¯ä¸ªå…ƒç´ ä» DRAM è¯»å†™å„ $ 1 $ æ¬¡ï¼Œ$ 2 M N $ã€‚ åˆè®¡ï¼š$ M K + K N + 2 M N $ã€‚ é€šè¿‡æŒ‰ $ K $ ç»´åº¦åˆ‡å—ï¼Œ$ A $ ä¸ $ B $ çš„é¢æ¿åœ¨è¾ƒå°çš„ $ K_c $ ä¸Šåå¤è¢«å¾®å†…æ ¸å¤ç”¨ï¼›åªè¦ $ K_c $ã€$ M_r $ã€$ N_r $ é€‰å–å¾—å½“ï¼Œå°±èƒ½ä½¿å¤ç”¨ä¸»è¦å‘ç”Ÿåœ¨ L1/L2/L3 ä¸­ï¼Œä» DRAM çš„è§†è§’çœ‹ï¼Œ$ A $/$ B $ åŸºæœ¬åªéœ€è¯»å–ä¸€æ¬¡ã€‚\nåŠ é€Ÿæ¯”ï¼š $$ S_{\\text{blocked}} \\approx \\frac{4 M N K + M N}{M K + K N + 2 M N} $$\nå½“ $ M = N = K = n $ æ—¶ï¼Œæœ‰ $ S \\approx \\frac{4 n^3}{4 n^2} = n $ï¼Œéšé—®é¢˜è§„æ¨¡çº¿æ€§å¢é•¿ï¼Œå®é™…å—ç¼“å­˜ä¸å¸¦å®½ä¸Šé™é™åˆ¶ã€‚\nData Packing å³ä½¿æœ‰äº†ç¼“å­˜åˆ†å—ï¼Œå¦‚æœåŸå§‹çŸ©é˜µçš„å†…å­˜å¸ƒå±€å¯¼è‡´å—å†…éƒ¨çš„æ•°æ®ä¸è¿ç»­ï¼ˆä¾‹å¦‚ï¼Œè¡Œä¸»åºçŸ©é˜µä¸­çš„åˆ—è®¿é—®ï¼‰ï¼Œç¼“å­˜æ•ˆç‡ä»ç„¶ä¼šå—æŸã€‚æ•°æ®æ‰“åŒ… (Packing) é€šè¿‡å°†éœ€è¦è®¡ç®—çš„çŸ©é˜µå—å¤åˆ¶åˆ°ä¸´æ—¶çš„ã€å†…å­˜è¿ç»­ä¸”å¯¹é½çš„ç¼“å†²åŒºä¸­æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\nå°† $ A $ çš„ $ M_r \\times K_c $ é¢æ¿æŒ‰â€œåˆ—ä¼˜å…ˆã€è¡Œç´§å‡‘â€çš„å½¢å¼æ‰“åŒ…ï¼Œä¾¿äºå¾®å†…æ ¸é¡ºåºè¯»å–ã€‚ å°† $ B $ çš„ $ K_c \\times N_r $ é¢æ¿æŒ‰â€œè¡Œä¼˜å…ˆã€åˆ—ç´§å‡‘â€çš„å½¢å¼æ‰“åŒ…ï¼Œä½¿å¾—æ¯ä¸ª $ k $ çš„ $ B[k, j..j+N_r-1] $ è¿ç»­ã€å¯¹é½ã€‚ ç¤ºä¾‹æ‰“åŒ…ä»£ç ï¼ˆä»¥ $ M_r=4, N_r=4 $ ä¸ºä¾‹ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // pack A: ä»è¡Œä¸»åº A ä¸­å– 4xKcï¼ŒæŒ‰åˆ—ï¼ˆkï¼‰ä¸»åºã€è¡Œï¼ˆrï¼‰ç´§å‡‘å­˜æ”¾ï¼šApack[k*4 + r] void pack_A_4xKc(const float* A, int lda, float* Apack, int Kc) { for (int k = 0; k \u0026lt; Kc; ++k) { Apack[k * 4 + 0] = A[0 * lda + k]; Apack[k * 4 + 1] = A[1 * lda + k]; Apack[k * 4 + 2] = A[2 * lda + k]; Apack[k * 4 + 3] = A[3 * lda + k]; } } // pack B: ä»è¡Œä¸»åº B ä¸­å– Kc x 4ï¼ŒæŒ‰è¡Œï¼ˆkï¼‰ä¸»åºã€åˆ—ï¼ˆcï¼‰ç´§å‡‘å­˜æ”¾ï¼šBpack[k*4 + c] void pack_B_Kc4(const float* B, int ldb, float* Bpack, int Kc) { for (int k = 0; k \u0026lt; Kc; ++k) { const float* bk = B + k * ldb; Bpack[k * 4 + 0] = bk[0]; Bpack[k * 4 + 1] = bk[1]; Bpack[k * 4 + 2] = bk[2]; Bpack[k * 4 + 3] = bk[3]; } } é…åˆæ‰“åŒ…çš„ 4Ã—4 å¾®å†…æ ¸ï¼ˆå†…å±‚çº¿æ€§è®¿é—®ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 inline void AddDot4x4_packed(int Kc, const float* Ap, const float* Bp, float* Cij, int N) { __m128 c0 = _mm_setzero_ps(); __m128 c1 = _mm_setzero_ps(); __m128 c2 = _mm_setzero_ps(); __m128 c3 = _mm_setzero_ps(); for (int k = 0; k \u0026lt; Kc; ++k) { __m128 b = _mm_loadu_ps(\u0026amp;Bp[k * 4]); float a0 = Ap[k * 4 + 0]; float a1 = Ap[k * 4 + 1]; float a2 = Ap[k * 4 + 2]; float a3 = Ap[k * 4 + 3]; c0 = _mm_add_ps(c0, _mm_mul_ps(_mm_set1_ps(a0), b)); c1 = _mm_add_ps(c1, _mm_mul_ps(_mm_set1_ps(a1), b)); c2 = _mm_add_ps(c2, _mm_mul_ps(_mm_set1_ps(a2), b)); c3 = _mm_add_ps(c3, _mm_mul_ps(_mm_set1_ps(a3), b)); } _mm_storeu_ps(\u0026amp;Cij[0 * N], _mm_add_ps(c0, _mm_loadu_ps(\u0026amp;Cij[0 * N]))); _mm_storeu_ps(\u0026amp;Cij[1 * N], _mm_add_ps(c1, _mm_loadu_ps(\u0026amp;Cij[1 * N]))); _mm_storeu_ps(\u0026amp;Cij[2 * N], _mm_add_ps(c2, _mm_loadu_ps(\u0026amp;Cij[2 * N]))); _mm_storeu_ps(\u0026amp;Cij[3 * N], _mm_add_ps(c3, _mm_loadu_ps(\u0026amp;Cij[3 * N]))); } FLOPsï¼šä¸å˜ã€‚ DRAM è®¿å­˜ï¼šä¸â€œç†æƒ³åˆ†å—â€ä¸€è‡´ï¼ˆ$ M K + K N + 2 M N $ï¼‰ï¼Œä½†å¸¸æ•°é¡¹æ›´å°ï¼ˆçº¿æ€§ã€å¯¹é½ã€å¯é¢„å–ï¼‰ï¼ŒSIMD è£…è½½æ›´é«˜æ•ˆã€‚ OpenMP Parallelization åœ¨å¤šæ ¸ CPU ä¸Šï¼Œä½¿ç”¨ OpenMP å¯¹å¤–å±‚å—å¾ªç¯å¹¶è¡Œæ˜¯æå‡æ€§èƒ½çš„æœ‰æ•ˆæ‰‹æ®µã€‚æ¨èåœ¨çº¿ç¨‹ä¹‹é—´åˆ’åˆ† $ (i, j) $ çš„å®å—ï¼Œé¿å…å¯¹åŒä¸€ $ C $ å­å—çš„å†™å†²çªã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 // OpenMP å¹¶è¡Œçš„åˆ†å— GEMMï¼ˆä»¥ 4x4 å¾®å†…æ ¸ + K åˆ†å—ä¸ºä¾‹ï¼‰ void gemm_blocked_omp(int M, int N, int K, const float* A, const float* B, float* C, int num_threads) { const int MR = 4, NR = 4, KC = 256, MC = 256, NC = 256; #pragma omp parallel num_threads(num_threads) { // çº¿ç¨‹ç§æœ‰çš„ä¸´æ—¶æ‰“åŒ…ç¼“å†²åŒº std::vector\u0026lt;float\u0026gt; Ap(MR * KC), Bp(KC * NR); #pragma omp for collapse(2) schedule(static) for (int jc = 0; jc \u0026lt; N; jc += NC) { for (int ic = 0; ic \u0026lt; M; ic += MC) { int Nc = std::min(NC, N - jc); int Mc = std::min(MC, M - ic); for (int pc = 0; pc \u0026lt; K; pc += KC) { int Kc = std::min(KC, K - pc); for (int i = ic; i \u0026lt; ic + Mc; i += MR) { int Mb = std::min(MR, ic + Mc - i); for (int j = jc; j \u0026lt; jc + Nc; j += NR) { int Nb = std::min(NR, jc + Nc - j); if (Mb == MR \u0026amp;\u0026amp; Nb == NR) { pack_A_4xKc(\u0026amp;A[i * K + pc], K, Ap.data(), Kc); pack_B_Kc4(\u0026amp;B[pc * N + j], N, Bp.data(), Kc); AddDot4x4_packed(Kc, Ap.data(), Bp.data(), \u0026amp;C[i * N + j], N); } else { for (int ii = 0; ii \u0026lt; Mb; ++ii) for (int jj = 0; jj \u0026lt; Nb; ++jj) { float acc = 0.f; for (int k = 0; k \u0026lt; Kc; ++k) acc += A[(i + ii) * K + (pc + k)] * B[(pc + k) * N + (j + jj)]; C[(i + ii) * N + (j + jj)] += acc; } } } } } } } } } åˆ†æï¼š\nFLOPsï¼šä¸å˜ã€‚ DRAM è®¿å­˜ï¼šä¸â€œåˆ†å— + æ‰“åŒ…â€çš„å•çº¿ç¨‹ç›¸åŒï¼ˆ$ M K + K N + 2 M N $ï¼‰ã€‚ åŠ é€Ÿä¸Šç•Œï¼š è®¡ç®—ä¸»å¯¼ï¼šç†æƒ³çº¿æ€§åŠ é€Ÿ $ \\leq T $ï¼ˆçº¿ç¨‹æ•°ï¼‰ã€‚ å†…å­˜ä¸»å¯¼ï¼šå—å†…å­˜å¸¦å®½é™åˆ¶ï¼Œ$ \\leq \\frac{\\text{BW}_{\\text{å¹¶è¡Œ}}}{\\text{BW}_{\\text{å•çº¿ç¨‹}}} $ã€‚å½“è¾¾åˆ°å¸¦å®½é¥±å’Œåç»§ç»­åŠ çº¿ç¨‹æ”¶ç›Šæœ‰é™ã€‚ åŠ é€Ÿæ¯”ï¼š\nåœ¨â€œåˆ†å— + æ‰“åŒ…â€åŸºç¡€ä¸Šï¼ŒOpenMP å°†è®¡ç®—å¹¶è¡ŒåŒ–ã€‚ç†æƒ³ä¸Šç•Œï¼ˆè®¡ç®—ä¸»å¯¼ï¼‰ï¼š$$ S_{\\text{blocked+packed+OMP}} \\approx \\min\\left(T,\\ \\frac{\\text{PeakFLOPs}}{\\text{å•çº¿ç¨‹ FLOPs}}\\right) \\times \\frac{4 M N K + M N}{M K + K N + 2 M N} $$ åœ¨å¸¦å®½ä¸»å¯¼æ—¶ï¼Œä¸Šå¼ä¸­ $ T $ æ›¿æ¢ä¸ºå¸¦å®½æ‰©å±•æ¯”ã€‚ Method Comparison ä¸ºä¾¿äºå¯¹æ¯”ï¼Œä¸‹é¢ç»™å‡ºå„ä¼˜åŒ–ç­–ç•¥åœ¨â€œå¿½ç•¥ç¼“å­˜å‘½ä¸­ã€ä»¥å…ƒç´ è®¿é—®è®¡â€çš„å†…å­˜è®¿é—®ä¸å†…å­˜ä¸»å¯¼æ¨¡å‹ä¸‹çš„ç†è®ºåŠ é€Ÿæ¯”ï¼ˆç›¸å¯¹ naiveï¼‰ï¼š\næ–¹æ³• å¾®å†…æ ¸å½¢çŠ¶ FLOPs å†…å­˜è®¿é—®ï¼ˆå…ƒç´ æ•°ï¼‰ ç›¸å¯¹ naive åŠ é€Ÿæ¯”ï¼ˆå†…å­˜ä¸»å¯¼ï¼Œ$ K \\gg 1 $ï¼‰ naive æ—  $ 2MNK $ $ 4MNK + MN $ $ 1.0 $ 1Ã—4 å¯„å­˜å™¨åˆ†å— 1Ã—4 $ 2MNK $ $ 1.25MNK + MN $ $ \\approx 3.2 $ 1Ã—4 + å±•å¼€ 1Ã—4 $ 2MNK $ $ 1.25MNK + MN $ $ \\approx 3.2 $ï¼ˆè®¡ç®—ä¸»å¯¼å† +5%~15%ï¼‰ 4Ã—4 å¯„å­˜å™¨åˆ†å— 4Ã—4 $ 2MNK $ $ 0.5MNK + MN $ $ \\approx 8.0 $ 4Ã—4 + SIMDï¼ˆSSEï¼‰ 4Ã—4 $ 2MNK $ $ 0.5MNK + MN $ å†…å­˜ä¸»å¯¼ $ \\approx 8.0 $ï¼›è®¡ç®—ä¸»å¯¼å† $ \\times 4 $ åˆ†å—ï¼ˆ$ K_{c} $ï¼‰+ æ‰“åŒ… ä»»æ„ $ 2MNK $ $ MK + KN + 2MN $ $ \\frac{4MNK+MN}{MK+KN+2MN} $ï¼ˆæ–¹é˜µçº¦ä¸º $ n $ï¼‰ åˆ†å— + æ‰“åŒ… +OpenMP ä»»æ„ $ 2MNK $ $ MK + KN + 2MN $ ä¸Šå¼ Ã— å¹¶è¡Œæ•ˆç‡ï¼ˆå—å¸¦å®½ä¸å¯ä¼¸ç¼©æ€§é™åˆ¶ï¼‰ ä¸Šè¡¨çš„å†…å­˜è®¿é—®ä¸ºâ€œç†æƒ³åŒ–ã€ä» DRAM è§’åº¦â€çš„ä¼°ç®—ï¼Œå®é™…æ€§èƒ½å–å†³äºç¼“å­˜å‘½ä¸­ã€é¢„å–ã€å¯¹é½ã€è®¿å­˜æŒ‡ä»¤èåˆå’Œå‰ç«¯/åç«¯ç“¶é¢ˆç­‰ã€‚\né‡‡ç”¨ += å†™å›å°†å¼•å…¥å¯¹ $ C $ çš„è¯»æ“ä½œï¼›è‹¥äº‹å…ˆçŸ¥é“ç›®æ ‡ $ C $ å—ä¸ºé›¶ï¼Œå¯è¿›ä¸€æ­¥å‡å°‘è¯»æµé‡ã€‚\nComparing with BLAS Libraries ç°ä»£ BLASï¼ˆå¦‚ Intel MKLã€OpenBLASã€BLISï¼‰æ™®éé‡‡ç”¨â€œä¸‰çº§åˆ†å— + æ•°æ®æ‰“åŒ… + ä¸“ç”¨å¾®å†…æ ¸ï¼ˆå« SIMD/FMAï¼‰â€çš„ä½“ç³»ï¼š æœ€å¤–å±‚ï¼š$ N_c $ã€$ M_c $ã€$ K_c $ çº§åˆ«çš„å®åˆ†å—ï¼ŒåŒ¹é… L3/L2ã€‚ ä¸­å±‚ï¼šé¢æ¿æ‰“åŒ…ï¼ˆAB-panelï¼‰ï¼Œé¡ºåºã€å¯¹é½ã€é¢„å–å‹å¥½ã€‚ å†…å±‚ï¼šæ‰‹å†™/å†…è”æ±‡ç¼–å¾®å†…æ ¸ï¼Œå›ºå®š $ M_r \\times N_r $ï¼Œæ·±åº¦å±•å¼€ï¼Œå¯„å­˜å™¨é˜»å¡ï¼Œåˆ©ç”¨ FMA ä¸æµæ°´çº¿ã€‚ å¯¹ x86ï¼š SSE åœºæ™¯å¸¸è§å¾®å†…æ ¸å¤§å°çº¦ $ 4 \\times 4 $ã€‚ AVX2/AVX-512 åœºæ™¯å¸¸è§ $ M_r, N_r $ æ›´å¤§ï¼ˆå¦‚ $ 6 \\times 16 $ã€$ 8 \\times 30 $ ç­‰ï¼‰ï¼Œå¹¶åˆ©ç”¨ FMAã€‚ è¿™äº›åº“è¿˜ä¼šè¿›è¡Œï¼š å¤šçº§é¢„å–ç­–ç•¥ï¼ˆç¡¬ä»¶/è½¯ä»¶ç»“åˆï¼‰ã€‚ NUMA æ„ŸçŸ¥çš„ä»»åŠ¡åˆ†é…ä¸å†…å­˜å½’å±ï¼ˆfirst-touchï¼‰ã€‚ é’ˆå¯¹è¾¹ç•Œå—çš„ä¸“é—¨è·¯å¾„å’Œå¯¹é½ä¼˜åŒ–ã€‚ Summary ä»â€œå¯„å­˜å™¨åˆ†å—ï¼ˆå¾®å†…æ ¸ï¼‰â†’ SIMD â†’ ç¼“å­˜åˆ†å—ï¼ˆå®å†…æ ¸ï¼‰â†’ æ•°æ®æ‰“åŒ… â†’ OpenMP å¹¶è¡Œâ€çš„è·¯å¾„é€å±‚ä¼˜åŒ–äº† GEMM æ€§èƒ½ã€‚\næ ¸å¿ƒæ€æƒ³ï¼š\nç”¨å¯„å­˜å™¨ä¿å­˜éƒ¨åˆ†å’Œï¼Œæ˜¾è‘—å‡å°‘å¯¹ $ C $ çš„è¯»å†™ã€‚ é€šè¿‡ $ 1 \\times 4 \\to 4 \\times 4 $ æé«˜ $ A $/$ B $ çš„å¤ç”¨ï¼Œé™ä½ DRAM è®¿å­˜ã€‚ ç”¨ SIMD/FMA æé«˜æ¯æ¡æŒ‡ä»¤çš„ FLOPsã€‚ å®åˆ†å—ä¸æ‰“åŒ…è®©å¤ç”¨åœ¨ L1/L2/L3 å†…ç”Ÿæ•ˆï¼Œå°† DRAM æµé‡é™åˆ° $ MK + KN + 2MN $ çš„é‡çº§ã€‚ OpenMP åœ¨å¤šæ ¸æ‰©å±•ååï¼Œä½†éœ€æ³¨æ„å¸¦å®½ç“¶é¢ˆä¸ NUMAã€‚ åœ¨å†…å­˜ä¸»å¯¼æ¨¡å‹ä¸‹çš„ç†è®ºåŠ é€Ÿï¼ˆç›¸å¯¹ naiveï¼‰ï¼š\n$ 1 \\times 4 $ï¼šçº¦ $ 3.2 \\times $ã€‚ $ 4 \\times 4 $ï¼šçº¦ $ 8 \\times $ã€‚ åˆ†å— + æ‰“åŒ…ï¼šçº¦ $ \\frac{4MNK+MN}{MK+KN+2MN} $ï¼ˆæ–¹é˜µè¿‘ä¼¼ $ n $ï¼‰ã€‚ SIMD ä¸ OpenMP çš„æ”¶ç›Šå åŠ å–å†³äºæ˜¯å¦è¿›å…¥è®¡ç®—ä¸»å¯¼ã€‚ References How to optimize GEMMï¼ˆFLAME wikiï¼‰ é€šç”¨çŸ©é˜µä¹˜ï¼ˆGEMMï¼‰ä¼˜åŒ–ç®—æ³• OpenBLAS ","permalink":"https://diefish1024.github.io/posts/hpc/gemm-%E7%AE%97%E6%B3%95%E4%BC%98%E5%8C%96/","summary":"\u003cp\u003eæœ¬æ–‡ç®€è¦ä»‹ç»é€šç”¨çŸ©é˜µä¹˜ï¼ˆ\u003ca href=\"https://en.wikipedia.org/wiki/Basic_Linear_Algebra_Subprograms#Level_3\"\u003eGEMM\u003c/a\u003eï¼ŒGeneral Matrix Multiplicationï¼‰ä¼˜åŒ–çš„åŸºæœ¬æ¦‚å¿µå’Œæ–¹æ³•ã€‚GEMM æ˜¯ HPC é¢†åŸŸä¸­æœ€åŸºç¡€ä¸”è®¡ç®—å¯†é›†å‹çš„å·¥ä½œè´Ÿè½½ä¹‹ä¸€ã€‚åœ¨äººå·¥æ™ºèƒ½ã€ç§‘å­¦æ¨¡æ‹Ÿå’Œå›¾åƒå¤„ç†ç­‰é¢†åŸŸï¼Œå®ƒçš„æ€§èƒ½ç›´æ¥å½±å“ç€æ•´ä¸ªåº”ç”¨ç¨‹åºçš„æ•ˆç‡ã€‚è™½ç„¶å…¶æ•°å­¦æ¦‚å¿µç®€å•ï¼Œä½†é«˜æ•ˆçš„ GEMM å®ç°å´éœ€è¦å¯¹è®¡ç®—æœºä½“ç³»ç»“æ„æœ‰æ·±åˆ»çš„ç†è§£ï¼ŒåŒ…æ‹¬ç¼“å­˜ã€SIMD æŒ‡ä»¤é›†å’Œå¹¶è¡ŒåŒ–æŠ€æœ¯ã€‚\u003c/p\u003e\n\u003ch2 id=\"naive-gemm\"\u003eNaive GEMM\u003c/h2\u003e\n\u003cp\u003eGEMM é€šå¸¸å®šä¹‰ä¸º $ C = A \\times B $ï¼Œå¯¹äºçŸ©é˜µ $ A \\in \\mathbb{R}^{M \\times K} $ï¼ŒçŸ©é˜µ $ B \\in \\mathbb{R}^{K \\times N} $ï¼Œå…¶ä¹˜ç§¯çŸ©é˜µ $ C\\in \\mathbb{R}^{M \\times N} $ å¯ä»¥è¡¨ç¤ºä¸º\n$$ \n\nC_{i,j} = \\sum_{k=0}^{K-1} A_{i,k}\\times B_{k,j} \n\n $$\nå¯¹åº”çš„æœ´ç´ ä»£ç é€šå¸¸å¦‚ä¸‹ï¼ˆé»˜è®¤è¡Œä¸»åºå­˜å‚¨ï¼‰ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-cpp\" data-lang=\"cpp\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003egemm_naive\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eM\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eK\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eM\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mf\"\u003e0.0f\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// åˆå§‹åŒ– C[i][j]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eM\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eK\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eåˆ†æ\u003c/strong\u003eï¼š\u003c/p\u003e","title":"GEMM ç®—æ³•ä¼˜åŒ–"},{"content":"å¦‚ä½•æ›´å¥½æ›´å¿«åœ°è®¿é—®å†…å­˜æ˜¯ HPC ä¸­æœ€å¤§çš„ç“¶é¢ˆä¹‹ä¸€ï¼Œä»…ä»…äº†è§£ SIMD æˆ–å¹¶è¡Œç¼–ç¨‹æ¥å£æ˜¯ä¸è¶³å¤Ÿçš„ï¼Œæœ¬æ–‡å°†æ¢³ç†è®¡ç®—æœºçš„å†…å­˜å±‚æ¬¡ç»“æ„ã€ç¼“å­˜å‹å¥½ç¼–ç¨‹ã€å†…å­˜å¢™ç°è±¡ã€NUMA æ¶æ„ä»¥åŠé¢„å–æŠ€æœ¯ã€‚\nUnderstanding Memory Hierarchy ä¸ºäº†å……åˆ†åˆ©ç”¨ç°ä»£ CPU çš„æ€§èƒ½ï¼Œæˆ‘ä»¬å¿…é¡»ç†è§£æ•°æ®æ˜¯å¦‚ä½•åœ¨ä¸åŒå±‚çº§çš„å†…å­˜ç»„ä»¶ä¹‹é—´æµåŠ¨çš„ã€‚\nRegisters, Caches, and Main Memory å¯„å­˜å™¨ (Registers)ï¼š CPU å†…ç½®çš„ã€å®¹é‡æœ€å°ä½†é€Ÿåº¦æœ€å¿«çš„æ•°æ®å­˜å‚¨å•å…ƒï¼Œç”¨äºå­˜å‚¨æ­£åœ¨è¢« CPU æ´»è·ƒæ“ä½œçš„æ•°æ®ã€‚CPU ç›´æ¥åœ¨å¯„å­˜å™¨ä¸Šæ‰§è¡Œå¤§éƒ¨åˆ†è®¡ç®—ã€‚\nç¼“å­˜ (Cache)ï¼š ä½äº CPU å’Œä¸»å†…å­˜ä¹‹é—´çš„å°å®¹é‡ã€é«˜é€Ÿå­˜å‚¨åŒºåŸŸã€‚å®ƒä»¬çš„ç›®çš„æ˜¯é€šè¿‡å­˜å‚¨æœ€å¯èƒ½è¢« CPU å†æ¬¡è®¿é—®çš„æ•°æ®æ¥å‡å°‘å¯¹ä¸»å†…å­˜çš„è®¿é—®å»¶è¿Ÿã€‚\nL1 ç¼“å­˜ (Level 1 Cache)ï¼šæœ€å°ã€æœ€å¿«ï¼Œé€šå¸¸åˆ†ä¸ºæ•°æ®ç¼“å­˜ (L1d) å’ŒæŒ‡ä»¤ç¼“å­˜ (L1i)ï¼Œæ¯ä¸ª CPU æ ¸å¿ƒç‹¬æœ‰ã€‚å…¶è®¿é—®é€Ÿåº¦ä¸ CPU æ ¸å¿ƒæ—¶é’Ÿå‘¨æœŸç›¸è¿‘ã€‚ L2 ç¼“å­˜ (Level 2 Cache)ï¼šæ¯” L1 å¤§ä¸”æ…¢ï¼Œæ¯ä¸ª CPU æ ¸å¿ƒç‹¬æœ‰æˆ–ç”±å‡ ä¸ªæ ¸å¿ƒå…±äº«ã€‚ L3 ç¼“å­˜ (Level 3 Cache)ï¼šæœ€å¤§ã€æœ€æ…¢çš„ç¼“å­˜ï¼Œé€šå¸¸ç”±åŒä¸€ CPU æ’æ§½ä¸Šçš„æ‰€æœ‰æ ¸å¿ƒå…±äº«ã€‚ ä¸»å†…å­˜ (Main Memory/RAM)ï¼š å®¹é‡è¿œå¤§äºç¼“å­˜ï¼Œä½†è®¿é—®é€Ÿåº¦æ…¢å¾—å¤šã€‚å½“æ•°æ®ä¸åœ¨ä»»ä½•ç¼“å­˜ä¸­æ—¶ï¼ŒCPU å¿…é¡»ä»ä¸»å†…å­˜ä¸­è·å–ã€‚\nTLB (Translation Lookaside Buffer)ï¼š TLB æ˜¯ä¸€ä¸ªä¸“ç”¨çš„é«˜æ€§èƒ½ç¼“å­˜ï¼Œç”¨äºå­˜å‚¨è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢æ˜ å°„ã€‚å½“ CPU è®¿é—®ä¸€ä¸ªè™šæ‹Ÿåœ°å€æ—¶ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥ TLBã€‚å¦‚æœæ‰¾åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€ï¼ˆTLB å‘½ä¸­ï¼‰ï¼Œåˆ™å¯ä»¥å¿«é€Ÿè¿›è¡Œå†…å­˜è®¿é—®ï¼›å¦‚æœæœªæ‰¾åˆ°ï¼ˆTLB æœªå‘½ä¸­ï¼‰ï¼Œåˆ™éœ€è¦æŸ¥è¯¢é¡µè¡¨ï¼Œè¿™å°†å¯¼è‡´æ˜¾è‘—çš„å»¶è¿Ÿã€‚ç†è§£ TLB å¯¹äºä¼˜åŒ–å†…å­˜é¡µè®¿é—®æ¨¡å¼ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§å‹æ•°æ®é›†æ—¶è‡³å…³é‡è¦ã€‚\né€šè¿‡è¿™ç§å¤šçº§å†…å­˜å±‚æ¬¡ç»“æ„è®¿é—®å†…å­˜ï¼Œæˆ‘ä»¬éœ€è¦å°½å¯èƒ½æ»¡è¶³å±€éƒ¨æ€§åŸç†æ¥æé«˜æ•ˆç‡ï¼š\næ—¶é—´å±€éƒ¨æ€§ (Temporal Locality)ï¼šå¦‚æœä¸€ä¸ªæ•°æ®é¡¹æœ€è¿‘è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå®ƒå¾ˆå¯èƒ½åœ¨ä¸ä¹…çš„å°†æ¥å†æ¬¡è¢«è®¿é—®ã€‚ ç©ºé—´å±€éƒ¨æ€§ (Spatial Locality)ï¼šå¦‚æœä¸€ä¸ªæ•°æ®é¡¹è¢«è®¿é—®äº†ï¼Œé‚£ä¹ˆå®ƒé™„è¿‘çš„å†…å­˜åœ°å€ä¸­çš„æ•°æ®é¡¹ä¹Ÿå¾ˆå¯èƒ½åœ¨ä¸ä¹…çš„å°†æ¥è¢«è®¿é—®ã€‚ Cache-Friendly Programming ç¼–å†™â€œç¼“å­˜å‹å¥½â€çš„ä»£ç æ„å‘³ç€ç»„ç»‡æ•°æ®å’Œè®¿é—®æ¨¡å¼ï¼Œæœ€å¤§åŒ–ç¼“å­˜å‘½ä¸­ç‡ã€‚\nCache Line and Performance Impact ç¼“å­˜è¡Œ (Cache Line)ï¼š ç¼“å­˜å’Œä¸»å†…å­˜ä¹‹é—´æ•°æ®ä¼ è¾“çš„æœ€å°å•å…ƒï¼Œé€šå¸¸ä¸º 64 å­—èŠ‚ã€‚å½“ CPU ä»ä¸»å†…å­˜ä¸­è¯·æ±‚ä¸€ä¸ªå­—èŠ‚æ—¶ï¼Œæ•´ä¸ªç¼“å­˜è¡Œéƒ½ä¼šè¢«åŠ è½½åˆ°ç¼“å­˜ä¸­ã€‚ è¿™å¼ºè°ƒäº†ç©ºé—´å±€éƒ¨æ€§ï¼šå¦‚æœä½ çš„ç¨‹åºæŒ‰é¡ºåºè®¿é—®å†…å­˜ï¼Œé‚£ä¹ˆä¸€æ¬¡ç¼“å­˜åŠ è½½å¯ä»¥ä¸ºæœªæ¥çš„è®¿é—®æä¾›å¤šä¸ªæ•°æ®é¡¹ï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚ ä¼ªå…±äº« (False Sharing)ï¼šå¦‚æœä¸¤ä¸ªæˆ–å¤šä¸ªç‹¬ç«‹çš„å˜é‡ä¸å¹¸åœ°ä½äºåŒä¸€ä¸ªç¼“å­˜è¡Œä¸­ï¼Œå¹¶ä¸”è¢«ä¸åŒçš„ CPU æ ¸å¿ƒä¿®æ”¹ï¼Œé‚£ä¹ˆå³ä½¿å®ƒä»¬é€»è¾‘ä¸Šä¸ç›¸å…³ï¼Œä¹Ÿä¼šå› ä¸ºç¼“å­˜ä¸€è‡´æ€§åè®®å¯¼è‡´å¤§é‡çš„ç¼“å­˜è¡Œå¤±æ•ˆå’Œé‡æ–°åŠ è½½ï¼Œä»è€Œä¸¥é‡å½±å“æ€§èƒ½ã€‚ Cache Hit/Miss and Coherence ç¼“å­˜å‘½ä¸­ (Cache Hit)ï¼šå½“ CPU éœ€è¦çš„æ•°æ®å·²ç»åœ¨æŸä¸ªç¼“å­˜çº§åˆ«ä¸­æ—¶ï¼Œè®¿é—®é€Ÿåº¦éå¸¸å¿«ã€‚ ç¼“å­˜æœªå‘½ä¸­ (Cache Miss)ï¼šå½“ CPU éœ€è¦çš„æ•°æ®ä¸åœ¨ä»»ä½•ç¼“å­˜ä¸­æ—¶ï¼Œå¿…é¡»ä»æ›´æ…¢çš„å†…å­˜çº§åˆ«ï¼ˆæœ€ç»ˆæ˜¯ä¸»å†…å­˜ï¼‰è·å–æ•°æ®ï¼Œè¿™ä¼šå¼•å…¥å»¶è¿Ÿã€‚æœªå‘½ä¸­å¯åˆ†ä¸ºï¼š å¼ºåˆ¶æ€§æœªå‘½ä¸­ (Compulsory Miss/Cold Miss)ï¼šé¦–æ¬¡è®¿é—®æ•°æ®ã€‚ å®¹é‡æ€§æœªå‘½ä¸­ (Capacity Miss)ï¼šç¼“å­˜å¤ªå°ï¼Œæ— æ³•å®¹çº³æ‰€æœ‰æ´»è·ƒæ•°æ®ã€‚ å†²çªæ€§æœªå‘½ä¸­ (Conflict Miss)ï¼šå¤šä¸ªæ•°æ®é¡¹æ˜ å°„åˆ°ç¼“å­˜ä¸­çš„åŒä¸€ä¸ªä½ç½®ã€‚ ç¼“å­˜ä¸€è‡´æ€§ (Cache Coherence)ï¼š åœ¨å¤šæ ¸å¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œä¸åŒçš„æ ¸å¿ƒå¯èƒ½æœ‰åŒä¸€ä»½æ•°æ®åœ¨å„è‡ªçš„ç¼“å­˜å‰¯æœ¬ä¸­ã€‚ä¸ºäº†ç¡®ä¿æ‰€æœ‰æ ¸å¿ƒçœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„æœ€æ–°ç‰ˆæœ¬ï¼Œéœ€è¦ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œå¦‚ MESI (Modified, Exclusive, Shared, Invalid) åè®®ã€‚ç†è§£è¿™äº›åè®®æœ‰åŠ©äºé¿å…ä¼ªå…±äº«ç­‰é—®é¢˜ã€‚ SoA vs. AoS é€‰æ‹©æ­£ç¡®çš„æ•°æ®å¸ƒå±€å¯¹ç¼“å­˜æ€§èƒ½è‡³å…³é‡è¦ã€‚è¿™éƒ¨åˆ†åœ¨ HPC ä¸­çš„ C å’Œ C++ ä¸­ä¹Ÿæœ‰æåŠã€‚\nç»“æ„ä½“æ•°ç»„ (AoS: Array of Structs)ï¼š struct Point { float x, y, z; } points[N];\nè¿™ç§å¸ƒå±€ä¸‹ï¼Œä¸€ä¸ª Point ç»“æ„ä½“çš„æ‰€æœ‰æˆå‘˜åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­çš„ã€‚å¦‚æœä½ çš„ä»£ç ç»å¸¸éœ€è¦è®¿é—®ä¸€ä¸ªç‚¹çš„æ‰€æœ‰åæ ‡ï¼Œè¿™ç§å¸ƒå±€æ˜¯é«˜æ•ˆçš„ã€‚ æ•°ç»„ç»“æ„ä½“ (SoA: Struct of Arrays)ï¼š struct { float x[N], y[N], z[N]; } points_soa;\nå¦‚æœä½ éœ€è¦å¯¹æ‰€æœ‰ç‚¹çš„ $ x $ åæ ‡æ‰§è¡Œæ“ä½œï¼Œé‚£ä¹ˆå¯ä»¥é«˜æ•ˆåœ°åˆ©ç”¨ç¼“å­˜è¡Œï¼Œå› ä¸ºå†…å­˜è®¿é—®æ˜¯é«˜åº¦è¿ç»­çš„ã€‚å¯¹äº SIMD å‘é‡åŒ–æ“ä½œæ¥è¯´ï¼ŒSoA é€šå¸¸æ›´ä¼˜åŒ–ã€‚ é€‰æ‹© SoA è¿˜æ˜¯ AoS å–å†³äºæ•°æ®è®¿é—®æ¨¡å¼ï¼šå¦‚æœç»å¸¸éœ€è¦è®¿é—®ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼ŒAoS å¯èƒ½æ›´å¥½ï¼ˆä½†è¦æ³¨æ„ç¼“å­˜è¡Œå¯¹é½å’Œå¡«å……ï¼‰ã€‚å¦‚æœç»å¸¸éœ€è¦å¯¹å¤šä¸ªå¯¹è±¡çš„æŸä¸ªç‰¹å®šå±æ€§è¿›è¡Œæ‰¹å¤„ç†æ“ä½œï¼ŒSoA é€šå¸¸æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚\nThe Memory Wall å†…å­˜å¢™æ˜¯æŒ‡ CPU çš„è®¡ç®—é€Ÿåº¦ä¸ä¸»å†…å­˜çš„è®¿é—®é€Ÿåº¦ä¹‹é—´æ—¥ç›Šæ‰©å¤§çš„å·®è·ã€‚CPU å¤„ç†èƒ½åŠ›çš„å¢é•¿è¿œè¿œå¿«äºå†…å­˜å»¶è¿Ÿçš„æ”¹è¿›é€Ÿåº¦ï¼Œè¿™æ„å‘³ç€å³ä½¿ CPU ç†è®ºä¸Šå¯ä»¥æ‰§è¡Œå¤§é‡çš„æŒ‡ä»¤ï¼Œä½†å¦‚æœå®ƒå¿…é¡»ç»å¸¸ç­‰å¾…æ•°æ®ä»ä¸»å†…å­˜ä¸­åŠ è½½ï¼Œé‚£ä¹ˆå¤§éƒ¨åˆ†æ—¶é—´éƒ½ä¼šå¤„äºç©ºé—²çŠ¶æ€ï¼Œä»è€Œé™åˆ¶äº†å®é™…çš„åº”ç”¨ç¨‹åºæ€§èƒ½ã€‚\nè§£å†³æ–¹æ¡ˆï¼š\nä¼˜åŒ–ç®—æ³•ï¼Œå‡å°‘å¯¹å†…å­˜çš„è®¿é—®æ¬¡æ•°ã€‚ æœ€å¤§åŒ–ç¼“å­˜å‘½ä¸­ç‡ï¼Œåˆ©ç”¨æ•°æ®å±€éƒ¨æ€§ã€‚ é‡‡ç”¨é¢„å–æŠ€æœ¯æ¥éšè—å†…å­˜è®¿é—®å»¶è¿Ÿã€‚ NUMA Architectures Non-Uniform Memory Access Challenges NUMA (Non-Uniform Memory Access) ï¼Œå³éä¸€è‡´æ€§å†…å­˜è®¿é—®æ¶æ„ï¼Œåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­å˜å¾—è¶Šæ¥è¶Šæ™®éã€‚åœ¨ NUMA ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ª CPU (æˆ– CPU æ’æ§½) éƒ½æœ‰ä¸€ç»„ç›´æ¥è¿æ¥çš„æœ¬åœ°å†…å­˜ï¼Œè®¿é—®æœ¬åœ°å†…å­˜æ¯”è®¿é—®è¿æ¥åˆ°å¦ä¸€ä¸ª CPU çš„è¿œç«¯å†…å­˜è¦å¿«å¾—å¤šã€‚ä¸åŒçš„å†…å­˜å™¨ä»¶å’Œ CPU æ ¸å¿ƒä»å±ä¸åŒçš„ Nodeï¼Œæ¯ä¸ª Node éƒ½æœ‰è‡ªå·±çš„é›†æˆå†…å­˜æ§åˆ¶å™¨ï¼ˆIMCï¼ŒIntegrated Memory Controllerï¼‰ã€‚\nå¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨ CPU0 ä¸Šè¿è¡Œï¼Œå´é¢‘ç¹è®¿é—®æŒ‚è½½åœ¨ CPU1 ä¸Šçš„å†…å­˜ï¼Œæ€§èƒ½ä¼šæ˜¾è‘—ä¸‹é™ï¼Œå› ä¸ºæ•°æ®å¿…é¡»é€šè¿‡å¤„ç†å™¨é—´äº’è¿ï¼ˆå¦‚ Intel çš„ UPI æˆ– AMD çš„ Infinity Fabricï¼‰ä¼ è¾“ï¼Œè¿™ä¼šå¼•å…¥é¢å¤–çš„å»¶è¿Ÿã€‚\nä¸å½“çš„å†…å­˜æ”¾ç½®ç­–ç•¥å¯èƒ½å¯¼è‡´ä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆï¼Œç”šè‡³è¶…è¿‡å†…å­˜å¢™çš„é™åˆ¶ã€‚\nNUMA Optimization withÂ numactl ä¸ºäº†åœ¨ NUMA æ¶æ„ä¸‹è·å¾—æœ€ä½³æ€§èƒ½ï¼Œæˆ‘ä»¬å¿…é¡»ç¡®ä¿è®¡ç®—å°½å¯èƒ½åœ°åœ¨é è¿‘å…¶æ‰€è®¿é—®æ•°æ®çš„ CPU æ ¸å¿ƒä¸Šè¿›è¡Œã€‚numactl æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ Linux å‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒå…è®¸æˆ‘ä»¬ç²¾ç¡®æ§åˆ¶è¿›ç¨‹çš„ CPU äº²å’Œæ€§å’Œå†…å­˜åˆ†é…ç­–ç•¥ã€‚\næŸ¥çœ‹ NUMA èŠ‚ç‚¹å¸ƒå±€ï¼šnumactl --hardware å‘½ä»¤å¯ä»¥æ˜¾ç¤ºç³»ç»Ÿä¸­æ‰€æœ‰çš„ NUMA èŠ‚ç‚¹ã€æ¯ä¸ªèŠ‚ç‚¹çš„ CPU æ ¸å¿ƒåŠå…¶æœ¬åœ°å†…å­˜å¤§å°ã€‚ 1 numactl --hardware è¾“å‡ºç¤ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 available: 2 nodes (0-1) node 0 cpus: 0 1 2 3 node 0 size: 16000 MB node 0 free: 15000 MB node 1 cpus: 4 5 6 7 node 1 size: 16000 MB node 1 free: 15000 MB node distances: node 0 1 0: 10 21 1: 21 10 è¿™è¡¨ç¤ºç³»ç»Ÿæœ‰ 2 ä¸ª NUMA èŠ‚ç‚¹ï¼ˆ0 å’Œ 1ï¼‰ã€‚èŠ‚ç‚¹ 0 æ‹¥æœ‰ CPU æ ¸å¿ƒ 0-3ï¼ŒèŠ‚ç‚¹ 1 æ‹¥æœ‰ CPU æ ¸å¿ƒ 4-7ã€‚node distances è¡¨ç¤ºè®¿é—®æœ¬åœ°å†…å­˜çš„æˆæœ¬ä¸º 10ï¼Œè®¿é—®è¿œç«¯å†…å­˜çš„æˆæœ¬ä¸º 21ï¼Œè¿œç«¯è®¿é—®çš„å¼€é”€çº¦ä¸ºæœ¬åœ°çš„ä¸¤å€ã€‚\né‡è¦ numactl é€‰é¡¹ï¼š --cpunodebind \u0026lt;nodes\u0026gt;ï¼šå°†è¿›ç¨‹æˆ–çº¿ç¨‹ç»‘å®šåˆ°æŒ‡å®š NUMA èŠ‚ç‚¹ä¸Šçš„ CPU æ ¸å¿ƒã€‚ä¾‹å¦‚ï¼Œ--cpunodebind=0Â å°†è¿›ç¨‹é™åˆ¶åœ¨èŠ‚ç‚¹ 0 ä¸Šçš„ CPUã€‚ --membind \u0026lt;nodes\u0026gt;ï¼šå¼ºåˆ¶æ‰€æœ‰å†…å­˜åˆ†é…éƒ½æ¥è‡ªæŒ‡å®š NUMA èŠ‚ç‚¹ã€‚ä¾‹å¦‚ï¼Œ--membind=1Â å°†æ‰€æœ‰å†…å­˜éƒ½ä»èŠ‚ç‚¹ 1 åˆ†é…ã€‚ --localallocï¼šåœ¨å½“å‰çº¿ç¨‹è¿è¡Œçš„ NUMA èŠ‚ç‚¹ä¸Šåˆ†é…å†…å­˜ã€‚è¿™æ˜¯æœ€ä½³å®è·µï¼Œå› ä¸ºå®ƒç¡®ä¿äº†æ•°æ®å­˜å‚¨åœ¨è·ç¦»è®¡ç®—æœ€è¿‘çš„ä½ç½®ã€‚ --physcpubind \u0026lt;cpus\u0026gt;ï¼šå°†è¿›ç¨‹æˆ–çº¿ç¨‹ç»‘å®šåˆ°ç‰¹å®šçš„ç‰©ç† CPU æ ¸å¿ƒã€‚ NUMA Memory Access Test å¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„å¤šçº¿ç¨‹æ•°ç»„æ±‚å’Œç¨‹åºæ¥æ¼”ç¤º numactl å¯¹ NUMA æ€§èƒ½çš„å½±å“ã€‚ç¨‹åºä¼šåˆ†é…ä¸€ä¸ªéå¸¸å¤§ï¼ˆè¶³å¤Ÿè¶…å‡º cacheï¼‰çš„æ•°ç»„ï¼Œç„¶åä½¿ç”¨ OpenMP è®©å¤šä¸ªçº¿ç¨‹å¹¶è¡Œè®¡ç®—æ•°ç»„å…ƒç´ çš„æ€»å’Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 #include \u0026lt;iostream\u0026gt; #include \u0026lt;vector\u0026gt; #include \u0026lt;numeric\u0026gt; #include \u0026lt;chrono\u0026gt; #include \u0026lt;omp.h\u0026gt; #include \u0026lt;algorithm\u0026gt; // ç¡®ä¿è¶³å¤Ÿå¤§ä»¥è¶…å‡ºç¼“å­˜å¹¶è§¦åŠ NUMA æ•ˆåº” const size_t ARRAY_SIZE = 1000000000ULL; int main() { std::cout \u0026lt;\u0026lt; \u0026#34;Allocating array of \u0026#34; \u0026lt;\u0026lt; ARRAY_SIZE * sizeof(long long) / (1024 * 1024 * 1024.0) \u0026lt;\u0026lt; \u0026#34; GB...\u0026#34; \u0026lt;\u0026lt; std::endl; std::vector\u0026lt;long long\u0026gt; data(ARRAY_SIZE); #pragma omp parallel for for (size_t i = 0; i \u0026lt; ARRAY_SIZE; ++i) { data[i] = i % 100; } std::cout \u0026lt;\u0026lt; \u0026#34;Array initialized.\u0026#34; \u0026lt;\u0026lt; std::endl; int num_threads = 2; omp_set_num_threads(num_threads); std::cout \u0026lt;\u0026lt; \u0026#34;Using \u0026#34; \u0026lt;\u0026lt; num_threads \u0026lt;\u0026lt; \u0026#34; OpenMP threads.\u0026#34; \u0026lt;\u0026lt; std::endl; long long total_sum = 0; auto start = std::chrono::high_resolution_clock::now(); #pragma omp parallel reduction(+:total_sum) { int thread_id = omp_get_thread_num(); size_t chunk_size = ARRAY_SIZE / num_threads; size_t start_idx = thread_id * chunk_size; size_t end_idx = std::min(start_idx + chunk_size, ARRAY_SIZE); std::cout \u0026lt;\u0026lt; \u0026#34;Thread \u0026#34; \u0026lt;\u0026lt; thread_id \u0026lt;\u0026lt; \u0026#34; processing from \u0026#34; \u0026lt;\u0026lt; start_idx \u0026lt;\u0026lt; \u0026#34; to \u0026#34; \u0026lt;\u0026lt; end_idx \u0026lt;\u0026lt; std::endl; for (size_t i = start_idx; i \u0026lt; end_idx; ++i) { total_sum += data[i]; } } auto end = std::chrono::high_resolution_clock::now(); std::chrono::duration\u0026lt;double\u0026gt; diff = end - start; std::cout \u0026lt;\u0026lt; \u0026#34;Calculated total sum: \u0026#34; \u0026lt;\u0026lt; total_sum \u0026lt;\u0026lt; std::endl; std::cout \u0026lt;\u0026lt; \u0026#34;Time taken: \u0026#34; \u0026lt;\u0026lt; diff.count() \u0026lt;\u0026lt; \u0026#34; seconds\u0026#34; \u0026lt;\u0026lt; std::endl; return 0; } å¯ä»¥ä½¿ç”¨ GCC ç¼–è¯‘è¿™ä¸ªç¨‹åºï¼š\n1 g++ -std=c++11 -O3 -fopenmp numa_test.cpp -o numa_test ï¼ˆç”±äºæˆ‘çš„ç”µè„‘åªæœ‰ä¸€ä¸ª NUMA æ ¸å¿ƒï¼Œæ‰€ä»¥ä¸‹é¢æµ‹è¯•æ— æ³•è¿›è¡Œã€‚ã€‚ã€‚ï¼‰\nBaselineï¼š 1 ./numa_test è¿œç«¯å†…å­˜è®¿é—®ï¼šCPU åœ¨èŠ‚ç‚¹ 1ï¼Œå†…å­˜ç»‘å®šåˆ°èŠ‚ç‚¹ 0ã€‚è¿™æ—¶æ‰€æœ‰æ•°æ®éƒ½æ˜¯è¿œç«¯è®¿é—®ï¼Œç†è®ºä¸Šæ€§èƒ½åº”è¯¥æœ€å·®ã€‚ 1 numactl --cpunodebind=1 --membind=0 ./numa_test æœ¬åœ°å†…å­˜è®¿é—®ï¼šCPU åœ¨èŠ‚ç‚¹ 0ï¼Œå†…å­˜ç»‘å®šåˆ°èŠ‚ç‚¹ 0ã€‚è¿™æ˜¯ç†æ€§çš„ NUMA é…ç½®ï¼Œæ‰€æœ‰æ•°æ®è®¿é—®éƒ½æ˜¯æœ¬åœ°çš„ã€‚ 1 numactl --cpunodebind=0 --membind=0 ./numa_test çœŸå®å¤šçº¿ç¨‹åœºæ™¯ï¼šCPU ç»‘å®šåˆ°èŠ‚ç‚¹ 0 å’Œ 1ï¼Œä½†å†…å­˜ä»…åˆ†é…åˆ°èŠ‚ç‚¹ 0ã€‚è·‘åœ¨èŠ‚ç‚¹ 1 ä¸Šçš„çº¿ç¨‹å°†è¿›è¡Œè¿œç«¯å†…å­˜è®¿é—®ã€‚ 1 2 export OMP_NUM_THREADS=2 numactl --cpunodebind=0,1 --membind=0 ./numa_test Prefetching é¢„å– (Prefetching) æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œå®ƒå°è¯•åœ¨ CPU å®é™…éœ€è¦æ•°æ®ä¹‹å‰ï¼Œå°±å°†å…¶ä»è¾ƒæ…¢çš„å†…å­˜å±‚çº§åŠ è½½åˆ°è¾ƒå¿«çš„ç¼“å­˜ä¸­ã€‚è¿™æœ‰åŠ©äºéšè—å†…å­˜è®¿é—®å»¶è¿Ÿï¼Œä½¿ CPU èƒ½å¤Ÿä¸“æ³¨äºè®¡ç®—ã€‚\nç¡¬ä»¶é¢„å–å™¨ (Hardware Prefetcher)ï¼š ç°ä»£ CPU å†…ç½®çš„æ™ºèƒ½é€»è¾‘å•å…ƒï¼Œå®ƒä»¬ä¼šç›‘æ§å†…å­˜è®¿é—®æ¨¡å¼ï¼Œå¹¶æ ¹æ®æ£€æµ‹åˆ°çš„æ¨¡å¼ï¼ˆå¦‚é¡ºåºè®¿é—®ï¼‰è‡ªåŠ¨é¢„æµ‹æ¥ä¸‹æ¥å¯èƒ½éœ€è¦å“ªäº›æ•°æ®ï¼Œå°†å…¶æå‰åŠ è½½åˆ°ç¼“å­˜ä¸­ã€‚\nä¼˜ç‚¹ï¼šå…¨è‡ªåŠ¨ï¼Œæ— éœ€ç¨‹åºå‘˜å¹²é¢„ã€‚ ç¼ºç‚¹ï¼šæœ‰æ—¶é¢„æµ‹ä¸å‡†ç¡®ï¼Œå¯èƒ½å°†æ— ç”¨æ•°æ®åŠ è½½åˆ°ç¼“å­˜ä¸­ï¼ŒæŒ¤å‡ºæœ‰ç”¨æ•°æ®ï¼Œç”šè‡³å¢åŠ å†…å­˜æ€»çº¿æµé‡ã€‚ ç¼–è¯‘å™¨é¢„å– (Compiler Prefetching)ï¼š ä¸€äº›ç¼–è¯‘å™¨èƒ½å¤Ÿæ ¹æ®ä»£ç ä¸­çš„å¾ªç¯å’Œè®¿é—®æ¨¡å¼ï¼Œåœ¨ç¼–è¯‘æ—¶æ’å…¥é¢„å–æŒ‡ä»¤ã€‚é€šè¿‡ -O3 ç­‰ä¼˜åŒ–é€‰é¡¹æˆ–ç‰¹å®šçš„ç¼–è¯‘å™¨æç¤ºï¼Œå¯ä»¥å¯ç”¨æ­¤åŠŸèƒ½ã€‚\nè½¯ä»¶é¢„å– (Software Prefetching)ï¼š ç¨‹åºå‘˜å¯ä»¥é€šè¿‡ä½¿ç”¨ç‰¹æ®Šçš„ CPU æŒ‡ä»¤ï¼ˆé€šå¸¸é€šè¿‡å†…è”å‡½æ•° Intrinsics æš´éœ²ï¼‰æ˜¾å¼åœ°å‘Šè¯‰ CPU é¢„å–å“ªäº›æ•°æ®ã€‚ ä¾‹å¦‚ï¼Œåœ¨ x86 æ¶æ„ä¸Šï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 #include \u0026lt;xmmintrin.h\u0026gt; // For _mm_prefetch void process_data(int* arr, int n) { for (int i = 0; i \u0026lt; n; ++i) { // åœ¨å®é™…è®¿é—® arr[i + PREFETCH_DISTANCE] ä¹‹å‰æå‰é¢„å– if (i + PREFETCH_DISTANCE \u0026lt; n) { _mm_prefetch((char*)\u0026amp;arr[i + PREFETCH_DISTANCE], _MM_HINT_T0); } // å¤„ç† arr[i] // ... } } å½“ç¡¬ä»¶é¢„å–å™¨æ— æ³•æœ‰æ•ˆåº”å¯¹å¤æ‚çš„è®¿é—®æ¨¡å¼æ—¶ï¼Œè½¯ä»¶é¢„å–å¯ä»¥æä¾›æ›´ç²¾ç¡®çš„æ§åˆ¶ã€‚ éœ€è¦ç¨‹åºå‘˜æ‰‹åŠ¨æ’å…¥ï¼Œå¯èƒ½ä¼šå¢åŠ ä»£ç å¤æ‚æ€§ï¼Œä¸å½“ä½¿ç”¨å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ Summary åœ¨ HPC é¢†åŸŸï¼Œä»…ä¾é  CPU çš„åŸå§‹è®¡ç®—èƒ½åŠ›å’Œå¹¶è¡Œç¼–ç¨‹æ¨¡å‹æ˜¯ä¸å¤Ÿçš„ã€‚æ·±å…¥ç†è§£è®¡ç®—æœºå†…å­˜ï¼Œæ˜¯ç¼–å†™é«˜æ€§èƒ½ä»£ç çš„åŸºç¡€ã€‚é€šè¿‡é‡‡ç”¨ç¼“å­˜å‹å¥½çš„ç¼–ç¨‹ï¼Œå¦‚ä¼˜åŒ–æ•°æ®å¸ƒå±€å’Œåˆ†å—ç®—æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾è‘—æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼ŒçœŸæ­£å‘æŒ¥ç°ä»£ CPU çš„æ½œåŠ›ã€‚\nReference æ¯ä¸ªç¨‹åºå‘˜éƒ½åº”è¯¥çŸ¥é“çš„ CPU çŸ¥è¯†ï¼šNUMAï¼ˆçŸ¥ä¹ï¼‰ æµ…è§£ NUMA æœºåˆ¶ï¼ˆçŸ¥ä¹ï¼‰ ","permalink":"https://diefish1024.github.io/posts/hpc/%E5%85%B3%E4%BA%8E%E5%86%85%E5%AD%98/","summary":"\u003cp\u003eå¦‚ä½•æ›´å¥½æ›´å¿«åœ°è®¿é—®å†…å­˜æ˜¯ HPC ä¸­æœ€å¤§çš„ç“¶é¢ˆä¹‹ä¸€ï¼Œä»…ä»…äº†è§£ SIMD æˆ–å¹¶è¡Œç¼–ç¨‹æ¥å£æ˜¯ä¸è¶³å¤Ÿçš„ï¼Œæœ¬æ–‡å°†æ¢³ç†è®¡ç®—æœºçš„å†…å­˜å±‚æ¬¡ç»“æ„ã€ç¼“å­˜å‹å¥½ç¼–ç¨‹ã€å†…å­˜å¢™ç°è±¡ã€NUMA æ¶æ„ä»¥åŠé¢„å–æŠ€æœ¯ã€‚\u003c/p\u003e\n\u003ch2 id=\"understanding-memory-hierarchy\"\u003eUnderstanding Memory Hierarchy\u003c/h2\u003e\n\u003cp\u003eä¸ºäº†å……åˆ†åˆ©ç”¨ç°ä»£ CPU çš„æ€§èƒ½ï¼Œæˆ‘ä»¬å¿…é¡»ç†è§£æ•°æ®æ˜¯å¦‚ä½•åœ¨ä¸åŒå±‚çº§çš„å†…å­˜ç»„ä»¶ä¹‹é—´æµåŠ¨çš„ã€‚\u003c/p\u003e\n\u003ch3 id=\"registers-caches-and-main-memory\"\u003eRegisters, Caches, and Main Memory\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå¯„å­˜å™¨ (Registers)\u003c/strong\u003eï¼š CPU å†…ç½®çš„ã€å®¹é‡æœ€å°ä½†é€Ÿåº¦æœ€å¿«çš„æ•°æ®å­˜å‚¨å•å…ƒï¼Œç”¨äºå­˜å‚¨æ­£åœ¨è¢« CPU æ´»è·ƒæ“ä½œçš„æ•°æ®ã€‚CPU ç›´æ¥åœ¨å¯„å­˜å™¨ä¸Šæ‰§è¡Œå¤§éƒ¨åˆ†è®¡ç®—ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eç¼“å­˜ (Cache)\u003c/strong\u003eï¼š ä½äº CPU å’Œä¸»å†…å­˜ä¹‹é—´çš„å°å®¹é‡ã€é«˜é€Ÿå­˜å‚¨åŒºåŸŸã€‚å®ƒä»¬çš„ç›®çš„æ˜¯é€šè¿‡å­˜å‚¨æœ€å¯èƒ½è¢« CPU å†æ¬¡è®¿é—®çš„æ•°æ®æ¥å‡å°‘å¯¹ä¸»å†…å­˜çš„è®¿é—®å»¶è¿Ÿã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eL1 ç¼“å­˜ (Level 1 Cache)\u003c/strong\u003eï¼šæœ€å°ã€æœ€å¿«ï¼Œé€šå¸¸åˆ†ä¸ºæ•°æ®ç¼“å­˜ (L1d) å’ŒæŒ‡ä»¤ç¼“å­˜ (L1i)ï¼Œæ¯ä¸ª CPU æ ¸å¿ƒç‹¬æœ‰ã€‚å…¶è®¿é—®é€Ÿåº¦ä¸ CPU æ ¸å¿ƒæ—¶é’Ÿå‘¨æœŸç›¸è¿‘ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eL2 ç¼“å­˜ (Level 2 Cache)\u003c/strong\u003eï¼šæ¯” L1 å¤§ä¸”æ…¢ï¼Œæ¯ä¸ª CPU æ ¸å¿ƒç‹¬æœ‰æˆ–ç”±å‡ ä¸ªæ ¸å¿ƒå…±äº«ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eL3 ç¼“å­˜ (Level 3 Cache)\u003c/strong\u003eï¼šæœ€å¤§ã€æœ€æ…¢çš„ç¼“å­˜ï¼Œé€šå¸¸ç”±åŒä¸€ CPU æ’æ§½ä¸Šçš„æ‰€æœ‰æ ¸å¿ƒå…±äº«ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eä¸»å†…å­˜ (Main Memory/RAM)\u003c/strong\u003eï¼š å®¹é‡è¿œå¤§äºç¼“å­˜ï¼Œä½†è®¿é—®é€Ÿåº¦æ…¢å¾—å¤šã€‚å½“æ•°æ®ä¸åœ¨ä»»ä½•ç¼“å­˜ä¸­æ—¶ï¼ŒCPU å¿…é¡»ä»ä¸»å†…å­˜ä¸­è·å–ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eTLB (Translation Lookaside Buffer)\u003c/strong\u003eï¼š TLB æ˜¯ä¸€ä¸ªä¸“ç”¨çš„é«˜æ€§èƒ½ç¼“å­˜ï¼Œç”¨äºå­˜å‚¨è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢æ˜ å°„ã€‚å½“ CPU è®¿é—®ä¸€ä¸ªè™šæ‹Ÿåœ°å€æ—¶ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥ TLBã€‚å¦‚æœæ‰¾åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€ï¼ˆTLB å‘½ä¸­ï¼‰ï¼Œåˆ™å¯ä»¥å¿«é€Ÿè¿›è¡Œå†…å­˜è®¿é—®ï¼›å¦‚æœæœªæ‰¾åˆ°ï¼ˆTLB æœªå‘½ä¸­ï¼‰ï¼Œåˆ™éœ€è¦æŸ¥è¯¢é¡µè¡¨ï¼Œè¿™å°†å¯¼è‡´æ˜¾è‘—çš„å»¶è¿Ÿã€‚ç†è§£ TLB å¯¹äºä¼˜åŒ–å†…å­˜é¡µè®¿é—®æ¨¡å¼ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§å‹æ•°æ®é›†æ—¶è‡³å…³é‡è¦ã€‚\u003c/p\u003e","title":"å…³äºå†…å­˜"},{"content":"å»å¹´è¶…ç®—é˜Ÿæ‹›æ–°å”¯ä¸€æ²¡æœ‰è§£å†³çš„ä¸€é“é¢˜ï¼Œä»Šåœ¨ Gemini è€å¸ˆçš„å¸®åŠ©ä¸‹æˆåŠŸè§£å†³ï¼Œå†³å®šé‡å†™ä¸€ä»½é¢˜è§£æŠ¥å‘Šã€‚\nDescription é¢˜ç›®ä¼ é€é—¨\né¢˜ç›®è¦æ±‚å‚èµ›è€…ä¼˜åŒ–ä¸€ä¸ª C è¯­è¨€å‡½æ•° rotate_the_bit_vectorï¼Œå‡½æ•°åŠŸèƒ½æ˜¯å¯¹ä¸€ä¸ª bit vector ä¸­çš„ä¸€ä¸ªæŒ‡å®šå­åŒºé—´è¿›è¡Œå¾ªç¯æ—‹è½¬æ“ä½œã€‚\nå…·ä½“è€Œè¨€ï¼Œé¢˜ç›®ç»™çš„ bit_vector æ˜¯ä¸€ç§å†…å­˜ç´§å‡‘çš„æ•°æ®ç»“æ„ï¼Œå°† 8 ä¸ª bit æ‰“åŒ…å­˜å‚¨åˆ°ä¸€ä¸ªå­—èŠ‚ä¸­ã€‚å‚èµ›è€…éœ€è¦åœ¨åªä¿®æ”¹ submit_func.c ä¸€ä¸ªæ–‡ä»¶çš„å‰æä¸‹é‡å†™å…¶ä¸­çš„ rotate_the_bit_vector å‡½æ•°ï¼Œä½¿å…¶åœ¨å¤§è§„æ¨¡æ•°æ®æ—¶å°½å¯èƒ½å¿«ã€‚\næœ€åè¯„åˆ†ç¨‹åºä¼šé€šè¿‡ä¸‰ä¸ªä¸åŒçš„ benchmark (-s, -m, -l) æ¥è¡¡é‡ï¼Œæ¯ä¸ªæµ‹è¯•ä¸­çš„æ•°æ®è§„æ¨¡ä¼šéšç€å±‚æ•°çš„å¢åŠ è€Œå‡ ä½•çº§å¢é•¿ï¼Œæœ€ç»ˆçš„å¾—åˆ†å–å†³äºè§„å®šæ—¶é—´å†…èƒ½åˆ°è¾¾çš„â€œå±‚æ•°â€ï¼Œå±‚æ•°è¶Šé«˜ã€‚è¯´æ˜æ€§èƒ½è¶Šå¥½ï¼Œæœ€ç»ˆåˆ†æ•°ä¹Ÿè¶Šé«˜ã€‚\nAnalysis Three-Reversal Algorithm å‡è®¾è¦ç§»åŠ¨çš„åŒºé—´é•¿åº¦ä¸º $ n $ ï¼Œéœ€è¦ç§»åŠ¨ $ k $ ä½ï¼›ç”±äºå‘å³æ—‹è½¬ $ k $ ä½å¯ä»¥ç­‰æ•ˆäºå‘å·¦æ—‹è½¬ $ n-k $ ä½ï¼Œå› æ­¤åªè®¨è®ºå‘å·¦çš„ç§»åŠ¨ã€‚\né¢˜ç›®æä¾›äº†ä¸€ä¸ªåˆå§‹çš„æ€§èƒ½æå·®çš„å®ç°ï¼Œé€šè¿‡é€ä½ç§»åŠ¨ $ k $ æ¬¡æ¥å®ç° $ k $ ä½å¾ªç¯æ—‹è½¬ï¼Œå¤æ‚åº¦ä¸º $ O(n^{2}) $ã€‚æ ¹æ®è¿™ä¸ªåŸå§‹å®ç°å¾ˆå®¹æ˜“æƒ³åˆ°ä¸€ä¸ªåˆæ­¥çš„ä¼˜åŒ–æ–¹æ¡ˆï¼š\né—®é¢˜çš„æ ¸å¿ƒæ˜¯æŠŠæ•°ç»„ [A|B] å˜æˆ [B|A] ï¼Œä¸€ä¸ªç»å…¸çš„ç®—æ³•æ˜¯ä¸‰æ­¥ç¿»è½¬æ³•ï¼šå¦‚æœæˆ‘ä»¬æŠŠç¿»è½¬æ“ä½œè®°ä¸º ' ï¼ŒA' è¡¨ç¤ºæ•°ç»„ A å‰ååè½¬ï¼Œé‚£ä¹ˆå¯ä»¥å‘ç°åŸé—®é¢˜çš„æ“ä½œå®é™…ä¸Šç­‰ä»·äºä¸‰æ¬¡ç¿»è½¬æ“ä½œï¼š[A'|B']' = [B|A] ï¼Œå¤æ‚åº¦ä¸º $ O(n) $ ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 #include \u0026#34;./bit_vector.h\u0026#34; #include \u0026lt;assert.h\u0026gt; #include \u0026lt;stdbool.h\u0026gt; #include \u0026lt;sys/types.h\u0026gt; static void reverse_bits(bit_vector_t* const bit_vector, size_t start, size_t end) { while (start \u0026lt; end) { bool temp = bit_vector_get(bit_vector, start); bit_vector_set(bit_vector, start, bit_vector_get(bit_vector, end)); bit_vector_set(bit_vector, end, temp); start++; end--; } } static size_t modulo(const ssize_t n, const size_t m) { const ssize_t signed_m = (ssize_t)m; assert(signed_m \u0026gt; 0); const ssize_t result = ((n % signed_m) + signed_m) % signed_m; assert(result \u0026gt;= 0); return (size_t)result; } void rotate_the_bit_vector(bit_vector_t* const bit_vector, const size_t bit_offset, const size_t bit_length, const ssize_t bit_right_amount) { assert(bit_offset + bit_length \u0026lt;= bit_vector_get_bit_sz(bit_vector)); if (bit_length \u0026lt;= 1) { return; } size_t left_shift = modulo(-bit_right_amount, bit_length); if (left_shift == 0) { return; } // 1. reverse [0, left_shift - 1] reverse_bits(bit_vector, bit_offset, bit_offset + left_shift - 1); // 2. reverse [left_shift, bit_length - 1] reverse_bits(bit_vector, bit_offset + left_shift, bit_offset + bit_length - 1); // 3. reverse [0, bit_length - 1] reverse_bits(bit_vector, bit_offset, bit_offset + bit_length - 1); } è¿è¡Œæµ‹è¯•ç¨‹åºå‘ç°åªèƒ½å¾—åˆ° 72 pts\n1 2 3 4 5 6 7 8 9 check result: PASSED performance of -s: 26 performance of -m: 32 performance of -l: 37 ------score-------- -s : 60.00 /100 -m : 72.73 /100 -l : 76.00 /100 total score: 71.82 /100 Performance Analysis with perf æ ¹æ®é¢˜ç›®çš„æç¤ºï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ perf å·¥å…·æ¥åˆ†ææ€§èƒ½çš„ç“¶é¢ˆï¼š\n1 perf record ./everybit -s è¿è¡Œç»“æŸä¹‹åç”Ÿæˆäº†ä¸€ä¸ªåä¸º perf.data çš„æ–‡ä»¶ï¼Œä¹‹åå†è¿è¡ŒæŒ‡ä»¤åˆ†ææŠ¥å‘Š\n1 perf report è¾“å‡ºçš„äº¤äº’å¼ç•Œé¢æ˜¾ç¤º\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 Overhead Command Shared Object Symbol 47.99% everybit everybit [.] bit_vector_set 20.29% everybit everybit [.] bit_vector_get 16.12% everybit everybit [.] bitmask 11.66% everybit everybit [.] reverse_bits 3.26% everybit libc.so.6 [.] __random 0.15% everybit libc.so.6 [.] rand 0.08% everybit [vdso] [.] __vdso_clock_gettime 0.08% everybit everybit [.] bit_vector_randfill 0.08% everybit ld-linux-x86-64.so.2 [.] _dl_init_paths 0.08% everybit ld-linux-x86-64.so.2 [.] handle_intel.constprop.0 0.08% everybit libc.so.6 [.] __random_r 0.08% everybit libc.so.6 [.] _int_free 0.08% everybit libc.so.6 [.] memmove å‘ç°ä¸»è¦çš„æ€§èƒ½ç“¶é¢ˆåœ¨ bit_vector_set å’Œ bit_vector_get ä¸¤ä¸ªæ“ä½œï¼Œè¿™è¡¨æ˜è™½ç„¶æˆ‘ä»¬çš„ç®—æ³•æœ¬èº«é«˜æ•ˆï¼Œä½†æ˜¯å…¶æ€§èƒ½ä¸¥é‡ä¾èµ–è¿™ä¸¤ä¸ªæ•ˆç‡ä½ä¸‹çš„ API ï¼Œè¿™æŒ‡å‡ºäº†æˆ‘ä»¬çš„ä¸‹ä¸€æ­¥ä¼˜åŒ–æ–¹å‘å°±æ˜¯è¿™ä¸¤ä¸ªæ“ä½œæœ¬èº«ï¼Œä»»ä½•ä¸ç»•å¼€è¿™ä¸¤ä¸ªå‡½æ•°çš„ä¼˜åŒ–éƒ½æ˜¯æ²»æ ‡ä¸æ²»æœ¬ã€‚\nSpace-for-Time æ—¢ç„¶ç“¶é¢ˆåœ¨äºé€ä½æ“ä½œï¼Œé‚£ä¹ˆä¼˜åŒ–çš„æ ¸å¿ƒæ€æƒ³å¿…ç„¶æ˜¯ç”¨å—çº§æ“ä½œæ›¿ä»£ä½çº§æ“ä½œã€‚å› æ­¤æˆ‘ä»¬éœ€è¦æ”¾å¼ƒä¹‹å‰ç¿»è½¬çš„åšæ³•ï¼Œå› ä¸ºè¿™å¿…ç„¶ä¼šæ¶‰åŠåˆ°ä½çº§æ“ä½œã€‚\nä½œä¸ºæ›¿ä»£ï¼Œæˆ‘ä»¬å¾ˆè‡ªç„¶æœ‰ç”¨ç©ºé—´æ¢æ—¶é—´çš„æƒ³æ³•ï¼š\nåœ¨å †ä¸Šç”¨ malloc å¼€è¾Ÿä¸€å—è¶³å¤Ÿå¤§çš„ä¸´æ—¶ç¼“å†²åŒº temp_bufferã€‚ å°†åŸæ•°ç»„éœ€è¦æ—‹è½¬çš„ B å’Œ A ä¸¤éƒ¨åˆ†ï¼Œä¾æ¬¡æ‹·è´åˆ° temp_buffer ä¸­ï¼Œä½¿å…¶å†…å®¹ç›´æ¥å˜æˆæ—‹è½¬åçš„ [B|A] é¡ºåºã€‚ å°† temp_buffer çš„å†…å®¹ä¸€æ¬¡æ€§æ‹·è´å›åŸæ•°ç»„ã€‚ ç”±äºæ“ä½œåŒºé—´æ˜¯éå­—èŠ‚å¯¹é½çš„ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨ memcpyã€‚å› æ­¤ï¼Œé—®é¢˜çš„å…³é”®å°±å˜æˆäº†å®ç°ä¸€ä¸ªé«˜æ€§èƒ½ã€æ”¯æŒä»»æ„æ¯”ç‰¹åç§»çš„ bithack_memcpy å‡½æ•°ã€‚\næŒ‰ç…§è¿™ä¸ªæ€è·¯ä¼˜åŒ–åçš„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 #include \u0026#34;./bit_vector.h\u0026#34; #include \u0026lt;assert.h\u0026gt; #include \u0026lt;stdbool.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;sys/types.h\u0026gt; // alloca.h is no longer needed for the final version // #include \u0026lt;alloca.h\u0026gt; #include \u0026lt;stdint.h\u0026gt; /** * @brief A highly optimized bit-level memcpy. * * Copies \u0026#39;bit_len\u0026#39; bits from a source buffer at a given bit offset to a * destination buffer at another bit offset. This function is the core of the * performance optimization, using 64-bit word operations for the bulk of the copy. * * @param dst_buf The destination memory buffer. * @param dst_offset The starting bit offset in the destination buffer. * @param src_buf The source memory buffer. * @param src_offset The starting bit offset in the source buffer. * @param bit_len The number of bits to copy. */ static void bithack_memcpy(char* dst_buf, size_t dst_offset, const char* src_buf, size_t src_offset, size_t bit_len) { if (bit_len == 0) { return; } size_t bits_copied = 0; // Handle the head: copy bit by bit until the destination is byte-aligned. int head_bits = (8 - (dst_offset % 8)) % 8; if (head_bits \u0026gt; bit_len) { head_bits = bit_len; } for (int i = 0; i \u0026lt; head_bits; i++) { if ((src_buf[(src_offset + i) / 8] \u0026gt;\u0026gt; ((src_offset + i) % 8)) \u0026amp; 1) dst_buf[(dst_offset + i) / 8] |= (1 \u0026lt;\u0026lt; ((dst_offset + i) % 8)); else dst_buf[(dst_offset + i) / 8] \u0026amp;= ~(1 \u0026lt;\u0026lt; ((dst_offset + i) % 8)); } bits_copied += head_bits; // Handle the middle: use 64-bit word operations for maximum speed. while (bit_len - bits_copied \u0026gt;= 64) { size_t current_src_offset = src_offset + bits_copied; size_t current_dst_offset = dst_offset + bits_copied; uint64_t src_word; memcpy(\u0026amp;src_word, src_buf + current_src_offset / 8, sizeof(src_word)); int bit_shift = current_src_offset % 8; if (bit_shift != 0) { uint8_t next_byte = src_buf[current_src_offset / 8 + 8]; src_word = (src_word \u0026gt;\u0026gt; bit_shift) | (((uint64_t)next_byte) \u0026lt;\u0026lt; (64 - bit_shift)); } memcpy(dst_buf + current_dst_offset / 8, \u0026amp;src_word, sizeof(src_word)); bits_copied += 64; } // Handle the tail: copy the remaining bits one by one. for (size_t i = bits_copied; i \u0026lt; bit_len; i++) { if ((src_buf[(src_offset + i) / 8] \u0026gt;\u0026gt; ((src_offset + i) % 8)) \u0026amp; 1) dst_buf[(dst_offset + i) / 8] |= (1 \u0026lt;\u0026lt; ((dst_offset + i) % 8)); else dst_buf[(dst_offset + i) / 8] \u0026amp;= ~(1 \u0026lt;\u0026lt; ((dst_offset + i) % 8)); } } static size_t modulo(const ssize_t n, const size_t m) { const ssize_t signed_m = (ssize_t)m; assert(signed_m \u0026gt; 0); const ssize_t result = ((n % signed_m) + signed_m) % signed_m; assert(result \u0026gt;= 0); return (size_t)result; } void rotate_the_bit_vector(bit_vector_t* const bit_vector, const size_t bit_offset, const size_t bit_length, const ssize_t bit_right_amount) { assert(bit_offset + bit_length \u0026lt;= bit_vector_get_bit_sz(bit_vector)); if (bit_length \u0026lt;= 1) { return; } size_t left_shift = modulo(-bit_right_amount, bit_length); if (left_shift == 0) { return; } size_t buf_byte_size = (bit_length + 7) / 8; char* temp_buffer = (char*)malloc(buf_byte_size); if (temp_buffer == NULL) { exit(1); } size_t first_part_len = bit_length - left_shift; size_t second_part_len = left_shift; bithack_memcpy(temp_buffer, 0, bit_vector-\u0026gt;buf, bit_offset + left_shift, first_part_len); bithack_memcpy(temp_buffer, first_part_len, bit_vector-\u0026gt;buf, bit_offset, second_part_len); bithack_memcpy(bit_vector-\u0026gt;buf, bit_offset, temp_buffer, 0, bit_length); free(temp_buffer); } ç°åœ¨å¯ä»¥å®Œç¾è·å¾—æ»¡åˆ†ï¼š\n1 2 3 4 5 6 7 8 9 check result: PASSED performance of -s: 37 performance of -m: 40 performance of -l: 44 ------score-------- -s : 100.00 /100 -m : 100.00 /100 -l : 100.00 /100 total score: 100.00 /100 250918 upd: ç¨å¾®ä¼˜åŒ–ä¸€ä¸‹ middle å¾ªç¯ä¸­çš„é™¤æ³•å’Œå–æ¨¡æ“ä½œï¼Œå¯ä»¥å†æé«˜ä¸€äº›æ€§èƒ½ã€‚\nDetails æœ€ç»ˆçš„æ»¡åˆ†ä»£ç å®Œå…¨å›´ç»• bithack_memcpy å‡½æ•°æ„å»ºã€‚å…¶å·¥ä½œåŸç†çš„å…³é”®åœ¨äºåˆ†å—å¤„ç†å’Œå¯¹åº•å±‚ç¡¬ä»¶åŸç†çš„ç†è§£ã€‚\nå‡½æ•°å°†ä»»æ„æ‹·è´ä»»åŠ¡æ‹†åˆ†ä¸ºä¸‰æ®µï¼šHead , Middle å’Œ Tailã€‚Head éƒ¨åˆ†é€šè¿‡é€ä½æ‹·è´ï¼Œå…¶å”¯ä¸€ç›®çš„æ˜¯è®©æ¥ä¸‹æ¥çš„ç›®æ ‡åœ°å€å®ç°å­—èŠ‚å¯¹é½ã€‚Tail éƒ¨åˆ†åˆ™å¤„ç†æœ€åå‰©ä¸‹çš„ã€ä¸è¶³ä¸€ä¸ªå—çš„é›¶æ•£æ¯”ç‰¹ã€‚\næ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒåœ¨ Middle éƒ¨åˆ†ï¼Œå®ƒä»¥ 64 ä½ï¼ˆ8 å­—èŠ‚ï¼‰ä¸ºå•ä½è¿›è¡Œå—æ‹·è´ã€‚å…¶ä¸­å¤„ç†éå¯¹é½æºæ•°æ®çš„é€»è¾‘æ˜¯ç²¾é«“æ‰€åœ¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 uint64_t src_word; // 1. é¢„è¯»å–ï¼šä»æºåœ°å€çš„å­—èŠ‚è¾¹ç•Œå¼€å§‹ï¼Œå®‰å…¨åœ°è¯»å–8ä¸ªå­—èŠ‚ã€‚ // è¿™å¯¼è‡´æˆ‘ä»¬æ‹¿åˆ°çš„æ•°æ®ç›¸å¯¹äºçœŸæ­£çš„èµ·å§‹ç‚¹æœ‰ä¸€ä¸ªåç§»ã€‚ memcpy(\u0026amp;src_word, src_buf + current_src_offset / 8, sizeof(src_word)); int bit_shift = current_src_offset % 8; if (bit_shift != 0) { // 2. æŠ“å–ï¼šè¯»å–ç´§é‚»çš„ä¸‹ä¸€ä¸ªå­—èŠ‚ï¼Œå®ƒåŒ…å«äº†æˆ‘ä»¬ç¼ºå¤±çš„æ•°æ®ã€‚ uint8_t next_byte = src_buf[current_src_offset / 8 + 8]; // 3. ç§»ä½ä¸æ‹¼æ¥ï¼š // a. (src_word \u0026gt;\u0026gt; bit_shift): å°†é¢„è¯»å–çš„æ•°æ®å³ç§»ï¼Œä¸¢å¼ƒå¤´éƒ¨å¤šä½™çš„æ¯”ç‰¹ã€‚ // b. (((uint64_t)next_byte) \u0026lt;\u0026lt; (64 - bit_shift)): // å°†ä¸‹ä¸€ä¸ªå­—èŠ‚å·¦ç§»ï¼Œä½¿å…¶æ°å¥½èƒ½å¡«å……å³ç§»ååœ¨é«˜ä½ç•™ä¸‹çš„ç©ºç¼ºã€‚ // c. | : é€šè¿‡æˆ–è¿ç®—ï¼Œå°†ä¸¤éƒ¨åˆ†æ‹¼æ¥ï¼Œé‡ç»„å‡ºæˆ‘ä»¬çœŸæ­£éœ€è¦çš„64ä¸ªæ¯”ç‰¹ã€‚ src_word = (src_word \u0026gt;\u0026gt; bit_shift) | (((uint64_t)next_byte) \u0026lt;\u0026lt; (64 - bit_shift)); } // 4. å†™å…¥ï¼šå› ä¸ºç›®æ ‡åœ°å€å·²å¯¹é½ï¼Œæ‰€ä»¥å¯ä»¥é«˜æ•ˆåœ°å°†é‡ç»„å¥½çš„ 64 ä½æ•°æ®å†™å…¥ã€‚ memcpy(dst_buf + current_dst_offset / 8, \u0026amp;src_word, sizeof(src_word)); å…¶é«˜æ€§èƒ½çš„æ ¹æºåœ¨äºä¸¤ä¸ªæ ¸å¿ƒçš„åº•å±‚åŸç†ï¼šå†…å­˜å¯¹é½ (Data Alignment) ä¸ æ•°æ®å±€éƒ¨æ€§ (Data Locality)ã€‚\nData Alignmentï¼šCPU è®¿é—®å†…å­˜ä»¥â€œå­—â€ï¼ˆWordï¼Œ64 ä½ CPU å³ 8 å­—èŠ‚ï¼‰ä¸ºå•ä½ã€‚å¦‚æœæ•°æ®åœ°å€æ˜¯å…¶å¤§å°çš„å€æ•°ï¼ŒCPU å°±èƒ½ä¸€æ¬¡å†…å­˜äº‹åŠ¡å®Œæˆè¯»å†™ï¼Œè¿™å«å¯¹é½è®¿é—®ã€‚éå¯¹é½è®¿é—®åˆ™å¯èƒ½éœ€è¦ä¸¤æ¬¡å†…å­˜äº‹åŠ¡å’Œå†…éƒ¨æ‹¼æ¥ï¼Œæ€§èƒ½å¤§å¹…ä¸‹é™ã€‚bithack_memcpy çš„â€œå¤´éƒ¨å¤„ç†â€é˜¶æ®µï¼Œå…¶å”¯ä¸€ç›®çš„å°±æ˜¯å®ç°ç›®æ ‡åœ°å€çš„å­—èŠ‚å¯¹é½ï¼Œç¡®ä¿å ä¸»å¯¼åœ°ä½çš„ä¸­éƒ¨å¾ªç¯å¯ä»¥æ‰§è¡Œæœ€é«˜æ•ˆçš„å¯¹é½å†™å…¥æ“ä½œã€‚\nMemory Locality \u0026amp; Cachingï¼šCPU å†…éƒ¨æœ‰å¤šçº§ Cacheï¼Œé€Ÿåº¦è¿œå¿«äº RAMã€‚å½“ CPU è®¿é—®æŸå—å†…å­˜æ—¶ï¼Œä¼šæŠŠå…¶é‚»è¿‘çš„ä¸€æ•´ä¸ª Cache Line éƒ½é¢„åŠ è½½åˆ°ç¼“å­˜ä¸­ã€‚è¿™å°±æ˜¯ç©ºé—´å±€éƒ¨æ€§åŸç† (Principle of Spatial Locality)ã€‚æˆ‘ä»¬çš„ bithack_memcpy å‡½æ•°åˆ©ç”¨äº†è¿™ä¸€ç‚¹ï¼Œæ— è®ºæ˜¯ä»åŸæ•°ç»„è¯»ï¼Œè¿˜æ˜¯åœ¨ä¸´æ—¶ç¼“å†²åŒºé‡Œè¯»å†™ï¼Œæ“ä½œçš„éƒ½æ˜¯è¿ç»­çš„å¤§å—å†…å­˜ã€‚å½“å¾ªç¯å¤„ç†ç¬¬ä¸€ä¸ª 64 ä½å­—æ—¶ï¼ŒCPU å¾ˆå¯èƒ½å·²ç»å°†åé¢å‡ ç™¾ä¸ªå­—èŠ‚çš„æ•°æ®é¢„åŠ è½½åˆ°äº†çš„ L1 Cache ä¸­ï¼Œåç»­è¿­ä»£æ— éœ€è®¿é—®æ…¢é€Ÿçš„å†…å­˜ï¼Œç¼“å­˜å‘½ä¸­ç‡ (Cache Hit Rate) æé«˜ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œæœ€åˆçš„ä¸‰æ­¥ç¿»è½¬æ³•åœ¨å†…å­˜ä¸­â€œæ¥å›è·³è·ƒâ€åœ°è®¿é—®å•ä¸ªæ¯”ç‰¹ï¼Œç ´åäº†ç©ºé—´å±€éƒ¨æ€§ï¼Œå¯¼è‡´ç¼“å­˜å‘½ä¸­ç‡æä½ï¼Œæ€§èƒ½è‡ªç„¶ä¸ä½³ã€‚\nåœ¨å¼€è¾Ÿç¼“å†²åŒºçš„é€‰æ‹©ä¸Šé¢ï¼Œç¬”è€…ä¸€å¼€å§‹é€‰æ‹©äº† alloc ï¼Œç›¸æ¯”äºå †å†…å­˜ï¼Œæ ˆå†…å­˜æ›´å¿«ä¸”ä¸éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼Œä½†æ˜¯å‘ç°åœ¨æµ‹è¯•åˆ°ä¸€å®šçš„å±‚æ•°ä¹‹åå°±ä¼šç”±äºæ•°æ®é‡è¿‡å¤§è€Œå‡ºç° Segment Falut ï¼Œå› æ­¤æœ€åè¿˜æ˜¯é€‰æ‹©äº†ä½¿ç”¨ malloc æ¥åˆ†é…ç¼“å†²åŒºã€‚\n","permalink":"https://diefish1024.github.io/posts/solutions/xflops2024-bithack/","summary":"\u003cp\u003eå»å¹´è¶…ç®—é˜Ÿæ‹›æ–°å”¯ä¸€æ²¡æœ‰è§£å†³çš„ä¸€é“é¢˜ï¼Œä»Šåœ¨ Gemini è€å¸ˆçš„å¸®åŠ©ä¸‹æˆåŠŸè§£å†³ï¼Œå†³å®šé‡å†™ä¸€ä»½é¢˜è§£æŠ¥å‘Šã€‚\u003c/p\u003e\n\u003ch2 id=\"description\"\u003eDescription\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/HPC-SJTU/Xflops2024_1st_exam/tree/main/Bithack\"\u003eé¢˜ç›®ä¼ é€é—¨\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eé¢˜ç›®è¦æ±‚å‚èµ›è€…ä¼˜åŒ–ä¸€ä¸ª C è¯­è¨€å‡½æ•° \u003ccode\u003erotate_the_bit_vector\u003c/code\u003eï¼Œå‡½æ•°åŠŸèƒ½æ˜¯å¯¹ä¸€ä¸ª bit vector ä¸­çš„ä¸€ä¸ªæŒ‡å®šå­åŒºé—´è¿›è¡Œ\u003cstrong\u003eå¾ªç¯æ—‹è½¬\u003c/strong\u003eæ“ä½œã€‚\u003c/p\u003e\n\u003cp\u003eå…·ä½“è€Œè¨€ï¼Œé¢˜ç›®ç»™çš„ \u003ccode\u003ebit_vector\u003c/code\u003e æ˜¯ä¸€ç§å†…å­˜ç´§å‡‘çš„æ•°æ®ç»“æ„ï¼Œå°† 8 ä¸ª bit æ‰“åŒ…å­˜å‚¨åˆ°ä¸€ä¸ªå­—èŠ‚ä¸­ã€‚å‚èµ›è€…éœ€è¦åœ¨åªä¿®æ”¹ \u003ccode\u003esubmit_func.c\u003c/code\u003e ä¸€ä¸ªæ–‡ä»¶çš„å‰æä¸‹é‡å†™å…¶ä¸­çš„ \u003ccode\u003erotate_the_bit_vector\u003c/code\u003e å‡½æ•°ï¼Œä½¿å…¶åœ¨å¤§è§„æ¨¡æ•°æ®æ—¶å°½å¯èƒ½å¿«ã€‚\u003c/p\u003e\n\u003cp\u003eæœ€åè¯„åˆ†ç¨‹åºä¼šé€šè¿‡ä¸‰ä¸ªä¸åŒçš„ benchmark (\u003ccode\u003e-s\u003c/code\u003e, \u003ccode\u003e-m\u003c/code\u003e, \u003ccode\u003e-l\u003c/code\u003e) æ¥è¡¡é‡ï¼Œæ¯ä¸ªæµ‹è¯•ä¸­çš„æ•°æ®è§„æ¨¡ä¼šéšç€å±‚æ•°çš„å¢åŠ è€Œå‡ ä½•çº§å¢é•¿ï¼Œæœ€ç»ˆçš„å¾—åˆ†å–å†³äºè§„å®šæ—¶é—´å†…èƒ½åˆ°è¾¾çš„â€œå±‚æ•°â€ï¼Œå±‚æ•°è¶Šé«˜ã€‚è¯´æ˜æ€§èƒ½è¶Šå¥½ï¼Œæœ€ç»ˆåˆ†æ•°ä¹Ÿè¶Šé«˜ã€‚\u003c/p\u003e\n\u003ch2 id=\"analysis\"\u003eAnalysis\u003c/h2\u003e\n\u003ch3 id=\"three-reversal-algorithm\"\u003eThree-Reversal Algorithm\u003c/h3\u003e\n\u003cp\u003eå‡è®¾è¦ç§»åŠ¨çš„åŒºé—´é•¿åº¦ä¸º $ n $ ï¼Œéœ€è¦ç§»åŠ¨ $ k $ ä½ï¼›ç”±äºå‘å³æ—‹è½¬ $ k $ ä½å¯ä»¥ç­‰æ•ˆäºå‘å·¦æ—‹è½¬ $ n-k $ ä½ï¼Œå› æ­¤åªè®¨è®ºå‘å·¦çš„ç§»åŠ¨ã€‚\u003c/p\u003e\n\u003cp\u003eé¢˜ç›®æä¾›äº†ä¸€ä¸ªåˆå§‹çš„æ€§èƒ½æå·®çš„å®ç°ï¼Œé€šè¿‡é€ä½ç§»åŠ¨ $ k $ æ¬¡æ¥å®ç° $ k $ ä½å¾ªç¯æ—‹è½¬ï¼Œå¤æ‚åº¦ä¸º $ O(n^{2}) $ã€‚æ ¹æ®è¿™ä¸ªåŸå§‹å®ç°å¾ˆå®¹æ˜“æƒ³åˆ°ä¸€ä¸ªåˆæ­¥çš„ä¼˜åŒ–æ–¹æ¡ˆï¼š\u003c/p\u003e\n\u003cp\u003eé—®é¢˜çš„æ ¸å¿ƒæ˜¯æŠŠæ•°ç»„ \u003ccode\u003e[A|B]\u003c/code\u003e å˜æˆ \u003ccode\u003e[B|A]\u003c/code\u003e ï¼Œä¸€ä¸ªç»å…¸çš„ç®—æ³•æ˜¯\u003cstrong\u003eä¸‰æ­¥ç¿»è½¬æ³•\u003c/strong\u003eï¼šå¦‚æœæˆ‘ä»¬æŠŠç¿»è½¬æ“ä½œè®°ä¸º \u003ccode\u003e'\u003c/code\u003e ï¼Œ\u003ccode\u003eA'\u003c/code\u003e è¡¨ç¤ºæ•°ç»„ \u003ccode\u003eA\u003c/code\u003e å‰ååè½¬ï¼Œé‚£ä¹ˆå¯ä»¥å‘ç°åŸé—®é¢˜çš„æ“ä½œå®é™…ä¸Šç­‰ä»·äºä¸‰æ¬¡ç¿»è½¬æ“ä½œï¼š\u003ccode\u003e[A'|B']' = [B|A]\u003c/code\u003e ï¼Œå¤æ‚åº¦ä¸º $ O(n) $ ï¼Œä»£ç å¦‚ä¸‹ï¼š\u003c/p\u003e","title":"Xflops2024-Bithack"},{"content":"1. What is SIMD? SIMDï¼Œå³ Single Instruction Multiple Data ï¼Œæ˜¯ä¸€ç§å¹¶è¡Œè®¡ç®—çš„æ¨¡å¼ã€‚ä¼ ç»Ÿçš„å•æŒ‡ä»¤å•æ•°æ®æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯ä¸€æ¡æŒ‡ä»¤ CPU åªèƒ½å¤„ç†ä¸€ä»½æ•°æ®ï¼Œè¿™åœ¨ç§‘å­¦è®¡ç®—å’Œå›¾åƒæ¸²æŸ“ç­‰å¤§é‡æ•°æ®å¯†é›†çš„ä»»åŠ¡ä¸­æ˜¯éå¸¸ä½æ•ˆçš„ã€‚\nSIMD çš„æ ¸å¿ƒæ€æƒ³æ˜¯ç”¨ä¸€æ¡æŒ‡ä»¤åŒæ—¶å¯¹å¤šä¸ªæ•°æ®è¿›è¡Œæ“ä½œï¼Œç°ä»£çš„ CPU ä¸ºæ­¤è®¾è®¡äº†ç‰¹æ®Šçš„ç¡¬ä»¶å•å…ƒï¼ŒåŒ…æ‹¬å®½ä½ï¼ˆæ¯”å¦‚ 128ã€256 æˆ– 512 ä½ï¼‰çš„å‘é‡å¯„å­˜å™¨ (Vector Registers) å’Œèƒ½å¤Ÿæ“ä½œè¿™äº›å¯„å­˜å™¨çš„å‘é‡æŒ‡ä»¤ (Vector Instructions)ã€‚ä¸€ä¸ªå‘é‡æ“ä½œå¯ä»¥åŒæ—¶å®Œæˆå¤šä¸ªæ ‡é‡æ“ä½œï¼Œä»è€Œå®ç°æ•°æ®å¹¶è¡Œ (Data Parallelism)ï¼Œæé«˜æ•ˆç‡ã€‚å‡è®¾ä¸€ä¸ª 256 ä½çš„å‘é‡å¯„å­˜å™¨å¯ä»¥å®¹çº³ 8 ä¸ª 32 ä½æµ®ç‚¹æ•°ï¼Œä¸€æ¡å‘é‡åŠ æ³•æŒ‡ä»¤å°±å¯ä»¥ä¸€æ¬¡æ€§å®Œæˆ 8 ä¸ªæµ®ç‚¹æ•°çš„åŠ æ³•ï¼Œç†è®ºä¸Šå°†è¿™éƒ¨åˆ†è®¡ç®—çš„ååé‡æå‡è‡³åŸæ¥çš„ 8 å€ï¼›å¹¶ä¸”ç›¸æ¯”äºæ‰§è¡Œ 8 æ¡ç‹¬ç«‹çš„æ ‡é‡åŠ æ³•æŒ‡ä»¤ï¼ŒCPU åªéœ€è¦è·å–å¹¶è§£ç ä¸€æ¡å‘é‡åŠ æ³•æŒ‡ä»¤ï¼Œè¿™é™ä½äº†æŒ‡ä»¤æµæ°´çº¿çš„å‹åŠ›ã€‚\n2. How SIMD Works è¦ç†è§£ SIMD çš„å·¥ä½œåŸç†ï¼Œéœ€è¦äº†è§£ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼šå‘é‡å¯„å­˜å™¨å’Œå‘é‡æŒ‡ä»¤ã€‚\n2.1. Vector Registers å‘é‡å¯„å­˜å™¨æ˜¯ CPU å†…éƒ¨çš„ç‰¹æ®Šå­˜å‚¨å•å…ƒï¼Œå…¶å®½åº¦è¿œå¤§äºé€šç”¨å¯„å­˜å™¨ã€‚ä¸åŒçš„ Instruction Set Architecture (ISA, æŒ‡ä»¤é›†æ¶æ„) æä¾›äº†ä¸åŒå®½åº¦å’Œåç§°çš„å‘é‡å¯„å­˜å™¨ã€‚\nSSE (Streaming SIMD Extensions)ï¼šæä¾›äº† 128 ä½çš„ XMM å¯„å­˜å™¨ã€‚\nAVX (Advanced Vector Extensions)ï¼šæä¾›äº† 256 ä½çš„ YMM å¯„å­˜å™¨ã€‚\nAVX-512ï¼šæä¾›äº† 512 ä½çš„ ZMM å¯„å­˜å™¨ã€‚\nARM NEONï¼šä¸»è¦ç”¨äºç§»åŠ¨è®¾å¤‡ï¼Œæä¾› 128 ä½çš„å‘é‡å¯„å­˜å™¨ã€‚\næ¯”å¦‚ä¸€ä¸ª YMM å¯„å­˜å™¨å¯ä»¥åŒæ—¶å­˜æ”¾ 8 ä¸ªå•ç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ8 * 32 ä½ = 256 ä½ï¼‰æˆ– 4 ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ4 * 64 ä½ = 256 ä½ï¼‰ã€‚\n2.2. Vector Instructions å‘é‡æŒ‡ä»¤æ˜¯ä¸“é—¨ç”¨æ¥æ“ä½œå‘é‡å¯„å­˜å™¨ä¸­æ•°æ®çš„æŒ‡ä»¤ã€‚è¿™äº›æŒ‡ä»¤é€šå¸¸ä¸æ ‡é‡æŒ‡ä»¤åŠŸèƒ½å¯¹åº”ï¼Œä½†ä½œç”¨äºæ•´ä¸ªå‘é‡ã€‚\nç®—æœ¯è¿ç®—ï¼šå‘é‡åŠ ã€å‡ã€ä¹˜ã€é™¤ã€‚\né€»è¾‘è¿ç®—ï¼šå‘é‡ä¸ã€æˆ–ã€å¼‚æˆ–ã€‚\næ•°æ®åŠ è½½/å­˜å‚¨ï¼šå°†å†…å­˜ä¸­çš„è¿ç»­æ•°æ®å—åŠ è½½åˆ°å‘é‡å¯„å­˜å™¨ï¼Œæˆ–å°†å¯„å­˜å™¨ä¸­çš„æ•°æ®å­˜å›å†…å­˜ã€‚\næ•°æ®é‡æ’ (Shuffle/Permute)ï¼šåœ¨å‘é‡å¯„å­˜å™¨å†…éƒ¨é‡æ–°æ’åˆ—æ•°æ®å…ƒç´ ï¼Œè¿™æ˜¯è®¸å¤šé«˜çº§ç®—æ³•ä¼˜åŒ–çš„å…³é”®ã€‚\n3. SIMD Programming Models å®é™…ç¼–ç¨‹ä¸­ï¼Œä¸»è¦é€šè¿‡ä¸¤ç§å‡¡æ˜¯æ¥åˆ©ç”¨ SIMDï¼šè‡ªåŠ¨å‘é‡åŒ–å’Œæ‰‹åŠ¨å‘é‡åŒ–ã€‚\n3.1 Automatic Vectorization Automatic Vectorization (è‡ªåŠ¨å‘é‡åŒ–) æ˜¯æŒ‡ç¼–è¯‘å™¨è‡ªåŠ¨åˆ†æä»£ç ï¼ˆé€šå¸¸æ˜¯å¾ªç¯ï¼‰ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º SIMD æŒ‡ä»¤çš„è¿‡ç¨‹ã€‚è¿™æ˜¯æœ€ç®€å•ã€æœ€ç›´æ¥çš„ä¼˜åŒ–æ–¹å¼ã€‚\nè¦è®©ç¼–è¯‘å™¨æˆåŠŸè¿›è¡Œè‡ªåŠ¨å‘é‡åŒ–ï¼Œä»£ç éœ€è¦æ»¡è¶³ä¸€äº›æ¡ä»¶ï¼š\nå¾ªç¯ç»“æ„ç®€å•: å¾ªç¯ä½“å†…éƒ¨æ²¡æœ‰å¤æ‚çš„åˆ†æ”¯åˆ¤æ–­ã€‚\næ— æ•°æ®ä¾èµ–: å¾ªç¯çš„æ¯æ¬¡è¿­ä»£ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ã€‚ä¾‹å¦‚ï¼Œa[i] = a[i-1] + 1 è¿™æ ·çš„ä»£ç å°±å­˜åœ¨æ•°æ®ä¾èµ–ï¼Œæ— æ³•è¢«ç›´æ¥å‘é‡åŒ–ã€‚\nå†…å­˜è®¿é—®è¿ç»­: å¯¹æ•°ç»„çš„è®¿é—®æ˜¯è¿ç»­çš„ï¼Œä¾‹å¦‚ row-major order (è¡Œä¸»åº) è®¿é—®ã€‚\nä¸€ä¸ªèƒ½è¢«è‡ªåŠ¨å‘é‡åŒ–çš„ç®€å•ä¾‹å­ï¼š\n1 2 3 4 5 6 7 void vector_add(float* a, float* b, float* c, int n) { for (int i = 0; i \u0026lt; n; ++i) { // æ¯æ¬¡è¿­ä»£ä¹‹é—´æ²¡æœ‰æ•°æ®ä¾èµ– // å†…å­˜è®¿é—®ä¹Ÿæ˜¯è¿ç»­çš„ c[i] = a[i] + b[i]; } } ç°ä»£çš„ç¼–è¯‘å™¨ï¼ˆæ¯”å¦‚ Clang, GCCï¼‰åœ¨å¼€å¯ä¼˜åŒ–é€‰é¡¹æ—¶ä¼šé»˜è®¤å°è¯•è‡ªåŠ¨å‘é‡åŒ–ã€‚\n3.2 Manual Vectorization with Intrinsics å½“è‡ªåŠ¨å‘é‡åŒ–ä¸èƒ½æ»¡è¶³æ€§èƒ½è¦æ±‚ï¼Œæˆ–è€…å¾ªç¯é€»è¾‘å¤ªå¤æ‚å¯¼è‡´ç¼–è¯‘å™¨æ— æ³•åˆ†ææ—¶ï¼Œå°±éœ€è¦è¿›è¡Œæ‰‹åŠ¨å‘é‡åŒ–ã€‚æœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨ Intrinsics (å†…å»ºå‡½æ•°)ã€‚\nIntrinsics æ˜¯ç¼–è¯‘å™¨æä¾›çš„ã€ä¸ç‰¹å®šæ±‡ç¼–æŒ‡ä»¤ä¸€ä¸€å¯¹åº”çš„å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥å’Œè°ƒç”¨æ™®é€šå‡½æ•°ä¸€æ ·ä½¿ç”¨ï¼Œè€Œç¼–è¯‘å™¨ä¼šç›´æ¥å°†å…¶ç¿»è¯‘æˆå¯¹åº”çš„ SIMD æŒ‡ä»¤ã€‚\nè¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯ï¼š\nå¯ä»¥ç²¾å‡†æ§åˆ¶ä½¿ç”¨å“ªæ¡ SIMD æŒ‡ä»¤ï¼Œå®ç°æœ€å¤§ç¨‹åº¦çš„ä¼˜åŒ–ã€‚ å¯ä»¥å®ç°è‡ªåŠ¨å‘é‡åŒ–æ— æ³•å®Œæˆçš„å¤æ‚é€»è¾‘ã€‚ ç¼ºç‚¹æ˜¯ï¼š\nä»£ç å¯ç§»æ¤æ€§å·®ï¼Œå’Œç‰¹å®šçš„æ¶æ„å¼ºç›¸å…³ï¼ŒåŸºäºç‰¹å®š ISA ç¼–å†™çš„ä»£ç ä¸èƒ½åœ¨ä¸æ”¯æŒè¯¥æŒ‡ä»¤é›†çš„ CPU ä¸Šè¿è¡Œï¼ˆé™¤éä½¿ç”¨ qemu ï¼‰ã€‚ éœ€è¦å­¦ä¹ ç‰¹å®šæŒ‡ä»¤é›†å¯¹åº”çš„å‡½æ•°ï¼Œéå¸¸ç¹çã€‚ 3.3 An Example å¯ä»¥é€šè¿‡ä¸€ä¸ªå®ä¾‹æ¥å¯¹æ¯”æ™®é€šå®ç°å’Œä½¿ç”¨ AVX Intrinsics çš„æ‰‹åŠ¨å‘é‡åŒ–å®ç°ã€‚\næ™®é€šå®ç°ï¼š\n1 2 3 4 5 6 // ä¼ ç»Ÿçš„æ ‡é‡å®ç° void scalar_add(float* a, float* b, float* c, int n) { for (int i = 0; i \u0026lt; n; ++i) { c[i] = a[i] + b[i]; } } æ‰‹åŠ¨å‘é‡åŒ–ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // å¼•å…¥AVXå¤´æ–‡ä»¶ #include \u0026lt;immintrin.h\u0026gt; void avx_add(float* a, float* b, float* c, int n) { // å‡è®¾ n æ˜¯8çš„å€æ•°ï¼Œä¾¿äºæ¼”ç¤º for (int i = 0; i \u0026lt; n; i += 8) { // 1. ä»å†…å­˜åŠ è½½8ä¸ªæµ®ç‚¹æ•°åˆ° YMM å¯„å­˜å™¨ __m256 vec_a = _mm256_load_ps(\u0026amp;a[i]); __m256 vec_b = _mm256_load_ps(\u0026amp;b[i]); // 2. æ‰§è¡Œå‘é‡åŠ æ³•ï¼Œä¸€æ¡æŒ‡ä»¤å®Œæˆ8ä¸ªæµ®ç‚¹æ•°ç›¸åŠ  __m256 vec_c = _mm256_add_ps(vec_a, vec_b); // 3. å°†è®¡ç®—ç»“æœä» YMM å¯„å­˜å™¨å­˜å›å†…å­˜ _mm256_store_ps(\u0026amp;c[i], vec_c); } } __m256 æ˜¯ AVX ä¸­çš„æ•°æ®ç±»å‹ï¼Œä»£è¡¨ä¸€ä¸ª 256 ä½çš„å‘é‡ã€‚ _mm256_load_ps ä»å†…å­˜åŠ è½½æ•°æ®åˆ°å‘é‡å¯„å­˜å™¨ã€‚ _mm256_add_ps æ‰§è¡Œå•ç²¾åº¦æµ®ç‚¹æ•°çš„å‘é‡åŠ æ³•ã€‚ _mm256_store_ps å°†ç»“æœå­˜å›å†…å­˜ã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¾ªç¯è¿­ä»£æ¬¡æ•°å‡å°‘ä¸ºåŸæ¥çš„ 1/8ï¼Œå¹¶ä¸”æ¯æ¬¡è¿­ä»£å¤„ç†çš„æ•°æ®é‡æ˜¯åŸæ¥çš„ 8 å€ï¼Œç†è®ºä¸Šæ€§èƒ½æå‡å·¨å¤§ï¼Œä½†æ˜¯ç”±äºè¿™ä¸ªå…¥æ°´å¹³æœ‰é™ï¼Œå†™çš„ benchmark æ²¡æ‰“è¿‡ç¼–è¯‘å™¨è‡ªåŠ¨ä¼˜åŒ–âœ‹ğŸ˜­ğŸ¤šå¯èƒ½éœ€è¦å¤æ‚ä¸€ç‚¹çš„ä»»åŠ¡æ‰èƒ½æ˜æ˜¾ä½“ç°æ€§èƒ½çš„ä¼˜è¶Šæ€§ã€‚\nSummary SIMD æ˜¯ä¸€ç§åˆ©ç”¨ Data Parallelism (æ•°æ®å¹¶è¡Œ) æå‡æ€§èƒ½çš„å…³é”®æŠ€æœ¯ã€‚\nå…¶æ ¸å¿ƒæ˜¯é€šè¿‡ Vector Registers (å‘é‡å¯„å­˜å™¨) å’Œ Vector Instructions (å‘é‡æŒ‡ä»¤)ï¼Œå®ç°å•æŒ‡ä»¤å¤„ç†å¤šæ•°æ®çš„ç›®æ ‡ã€‚\nAutomatic Vectorization (è‡ªåŠ¨å‘é‡åŒ–) æ˜¯æœ€ä¾¿æ·çš„ SIMD ä¼˜åŒ–æ–¹æ³•ï¼Œä¾èµ–äºç¼–è¯‘å™¨çš„èƒ½åŠ›ã€‚\nå½“éœ€è¦æè‡´æ€§èƒ½å’Œç²¾ç¡®æ§åˆ¶æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Intrinsics (å†…å»ºå‡½æ•°) è¿›è¡Œæ‰‹åŠ¨å‘é‡åŒ–ã€‚\nReferences å‘é‡åŒ– - HPCå…¥é—¨æŒ‡å— lect19 - NJU OS 2025 ","permalink":"https://diefish1024.github.io/posts/hpc/simd-%E5%85%A5%E9%97%A8/","summary":"\u003ch2 id=\"1-what-is-simd\"\u003e1. What is SIMD?\u003c/h2\u003e\n\u003cp\u003eSIMDï¼Œå³ \u003cstrong\u003eSingle Instruction Multiple Data\u003c/strong\u003e ï¼Œæ˜¯ä¸€ç§å¹¶è¡Œè®¡ç®—çš„æ¨¡å¼ã€‚ä¼ ç»Ÿçš„å•æŒ‡ä»¤å•æ•°æ®æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯ä¸€æ¡æŒ‡ä»¤ CPU åªèƒ½å¤„ç†ä¸€ä»½æ•°æ®ï¼Œè¿™åœ¨ç§‘å­¦è®¡ç®—å’Œå›¾åƒæ¸²æŸ“ç­‰å¤§é‡æ•°æ®å¯†é›†çš„ä»»åŠ¡ä¸­æ˜¯éå¸¸ä½æ•ˆçš„ã€‚\u003c/p\u003e\n\u003cp\u003eSIMD çš„æ ¸å¿ƒæ€æƒ³æ˜¯\u003cstrong\u003eç”¨ä¸€æ¡æŒ‡ä»¤åŒæ—¶å¯¹å¤šä¸ªæ•°æ®è¿›è¡Œæ“ä½œ\u003c/strong\u003eï¼Œç°ä»£çš„ CPU ä¸ºæ­¤è®¾è®¡äº†ç‰¹æ®Šçš„ç¡¬ä»¶å•å…ƒï¼ŒåŒ…æ‹¬å®½ä½ï¼ˆæ¯”å¦‚ 128ã€256 æˆ– 512 ä½ï¼‰çš„\u003cstrong\u003eå‘é‡å¯„å­˜å™¨ (Vector Registers)\u003c/strong\u003e å’Œèƒ½å¤Ÿæ“ä½œè¿™äº›å¯„å­˜å™¨çš„\u003cstrong\u003eå‘é‡æŒ‡ä»¤ (Vector Instructions)\u003c/strong\u003eã€‚ä¸€ä¸ªå‘é‡æ“ä½œå¯ä»¥åŒæ—¶å®Œæˆå¤šä¸ªæ ‡é‡æ“ä½œï¼Œä»è€Œå®ç°\u003cstrong\u003eæ•°æ®å¹¶è¡Œ (Data Parallelism)\u003c/strong\u003eï¼Œæé«˜æ•ˆç‡ã€‚å‡è®¾ä¸€ä¸ª 256 ä½çš„å‘é‡å¯„å­˜å™¨å¯ä»¥å®¹çº³ 8 ä¸ª 32 ä½æµ®ç‚¹æ•°ï¼Œä¸€æ¡å‘é‡åŠ æ³•æŒ‡ä»¤å°±å¯ä»¥ä¸€æ¬¡æ€§å®Œæˆ 8 ä¸ªæµ®ç‚¹æ•°çš„åŠ æ³•ï¼Œç†è®ºä¸Šå°†è¿™éƒ¨åˆ†è®¡ç®—çš„ååé‡æå‡è‡³åŸæ¥çš„ 8 å€ï¼›å¹¶ä¸”ç›¸æ¯”äºæ‰§è¡Œ 8 æ¡ç‹¬ç«‹çš„æ ‡é‡åŠ æ³•æŒ‡ä»¤ï¼ŒCPU åªéœ€è¦è·å–å¹¶è§£ç ä¸€æ¡å‘é‡åŠ æ³•æŒ‡ä»¤ï¼Œè¿™é™ä½äº†æŒ‡ä»¤æµæ°´çº¿çš„å‹åŠ›ã€‚\u003c/p\u003e\n\u003ch2 id=\"2-how-simd-works\"\u003e2. How SIMD Works\u003c/h2\u003e\n\u003cp\u003eè¦ç†è§£ SIMD çš„å·¥ä½œåŸç†ï¼Œéœ€è¦äº†è§£ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼šå‘é‡å¯„å­˜å™¨å’Œå‘é‡æŒ‡ä»¤ã€‚\u003c/p\u003e\n\u003ch3 id=\"21-vector-registers\"\u003e2.1. Vector Registers\u003c/h3\u003e\n\u003cp\u003eå‘é‡å¯„å­˜å™¨æ˜¯ CPU å†…éƒ¨çš„ç‰¹æ®Šå­˜å‚¨å•å…ƒï¼Œå…¶å®½åº¦è¿œå¤§äºé€šç”¨å¯„å­˜å™¨ã€‚ä¸åŒçš„ \u003cstrong\u003eInstruction Set Architecture (ISA, æŒ‡ä»¤é›†æ¶æ„)\u003c/strong\u003e æä¾›äº†ä¸åŒå®½åº¦å’Œåç§°çš„å‘é‡å¯„å­˜å™¨ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eSSE (Streaming SIMD Extensions)\u003c/strong\u003eï¼šæä¾›äº† 128 ä½çš„ \u003ccode\u003eXMM\u003c/code\u003e å¯„å­˜å™¨ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eAVX (Advanced Vector Extensions)\u003c/strong\u003eï¼šæä¾›äº† 256 ä½çš„ \u003ccode\u003eYMM\u003c/code\u003e å¯„å­˜å™¨ã€‚\u003c/p\u003e","title":"SIMD å…¥é—¨"},{"content":"é’ˆå¯¹ CUMCM-2025 å¼€å§‹å­¦ä¹  COPT æ±‚è§£å™¨çš„ä½¿ç”¨ï¼Œå­¦ä¹ å¦‚ä½•åº”ç”¨ COPT çš„ Python API (coptpy) æ¥å»ºæ¨¡å¹¶æ±‚è§£æ•°å­¦å»ºæ¨¡ä¸­å¸¸è§çš„ç¦»æ•£ä¼˜åŒ–é—®é¢˜ã€‚\nBasic API æœ¬èŠ‚å°†ä»‹ç» COPT æ±‚è§£å™¨ Python API (coptpy) çš„æ ¸å¿ƒç»„ä»¶å’Œå¸¸ç”¨æ–¹æ³•ã€‚\nEnvr Class Envr ç±»ç”¨äºåˆ›å»ºä¸€ä¸ª COPT ç¯å¢ƒã€‚å®ƒæ˜¯æ‰€æœ‰æ¨¡å‹æ“ä½œçš„èµ·ç‚¹ã€‚\nCreating Environment and Model:\n1 2 3 4 5 import coptpy as cp from coptpy import COPT env = cp.Envr() # åˆ›å»ºä¸€ä¸ª COPT ç¯å¢ƒå®ä¾‹ model = env.createModel(name=\u0026#39;YourModelName\u0026#39;) # åœ¨ç¯å¢ƒä¸­åˆ›å»ºä¸€ä¸ªæ¨¡å‹ nameï¼šæ¨¡å‹çš„åç§°ï¼Œæ­¤ä¸ºå¯é€‰å‚æ•°ã€‚ Model Class Properties and Methods Model ç±»æ˜¯ COPT çš„æ ¸å¿ƒï¼Œä»£è¡¨äº†ä¼˜åŒ–æ¨¡å‹ï¼ŒåŒ…å«äº†æ‰€æœ‰å˜é‡ã€çº¦æŸå’Œç›®æ ‡å‡½æ•°ã€‚\nBasic Properties åœ¨æ¨¡å‹æ±‚è§£åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å±æ€§è·å–å…¶åŸºæœ¬ä¿¡æ¯ï¼š\nmodel.statusï¼šæ¨¡å‹è§£çš„çŠ¶æ€ã€‚æ­¤å±æ€§æŒ‡ç¤ºæ¨¡å‹æ˜¯å¦æ‰¾åˆ°äº†æœ€ä¼˜è§£ã€æ— å¯è¡Œè§£ç­‰ã€‚ä¾‹å¦‚ï¼ŒCOPT.OPTIMAL è¡¨ç¤ºå·²æ‰¾åˆ°æœ€ä¼˜è§£ã€‚ model.objvalï¼šç›®æ ‡å‡½æ•°å€¼ã€‚æ­¤å±æ€§å­˜å‚¨æ¨¡å‹çš„æœ€ä¼˜ç›®æ ‡å‡½æ•°å€¼ã€‚ Adding Variables å¯ä»¥é€šè¿‡ addVar() å’Œ addVars() æ–¹æ³•å‘æ¨¡å‹ä¸­æ·»åŠ å†³ç­–å˜é‡ã€‚\nAdding a Single Variable:\nä½¿ç”¨ model.addVar() æ–¹æ³•å‘æ¨¡å‹ä¸­æ·»åŠ ä¸€ä¸ªå•ç‹¬çš„å†³ç­–å˜é‡ã€‚\n1 x = model.addVar(lb=0.0, ub=cp.COPT.INFINITY, vtype=cp.COPT.CONTINUOUS, name=\u0026#39;x_var\u0026#39;) lbï¼šå˜é‡çš„ä¸‹ç•Œï¼ˆé»˜è®¤ä¸º $ 0.0 $ï¼‰ã€‚ ubï¼šå˜é‡çš„ä¸Šç•Œï¼ˆé»˜è®¤ä¸º COPT.INFINITYï¼Œè¡¨ç¤ºæ­£æ— ç©·ï¼‰ã€‚ vtypeï¼šå˜é‡çš„ç±»å‹ï¼Œå¯ä»¥æ˜¯ï¼š cp.COPT.CONTINUOUS (è¿ç»­å˜é‡) cp.COPT.INTEGER (æ•´æ•°å˜é‡) cp.COPT.BINARY (äºŒè¿›åˆ¶å˜é‡ï¼Œå³ $ 0 $ æˆ– $ 1 $) nameï¼šå˜é‡çš„åç§°ã€‚ Adding Multiple Variables:\nä½¿ç”¨ model.addVars() æ–¹æ³•ä¸€æ¬¡æ€§æ·»åŠ ä¸€ç»„å˜é‡ã€‚è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª tupledict å¯¹è±¡ï¼Œå…¶é”®ä¸ºå˜é‡çš„ä¸‹æ ‡ï¼Œå€¼ä¸ºç›¸åº”çš„ Var å¯¹è±¡ã€‚\n1 model.addVars(*indices, lb=0.0, ub=cp.COPT.INFINITY, obj=0.0, vtype=cp.COPT.CONTINUOUS, nameprefix=\u0026#34;\u0026#34;) *indicesï¼šç”¨äºå®šä¹‰å˜é‡ä¸‹æ ‡çš„å‚æ•°ã€‚ lb/ub/vtypeï¼šå«ä¹‰ä¸ addVar ç›¸åŒã€‚ objï¼šå˜é‡åœ¨ç›®æ ‡å‡½æ•°ä¸­çš„ç³»æ•°ï¼Œé»˜è®¤ä¸º $ 0.0 $ã€‚ nameprefixï¼šå˜é‡åç§°çš„å‰ç¼€ã€‚ Form 1: Using Integer Parameters to Define Dimensions:\nè¿™å°†åˆ›å»ºä¸€ä¸ªå…·æœ‰ç»™å®šç»´åº¦å’Œè¿ç»­æ•´æ•°ä¸‹æ ‡çš„å˜é‡ç»„ã€‚\n1 2 3 4 # æ·»åŠ ä¸€ä¸ª 2x3 çš„æ•´æ•°å˜é‡ xï¼Œå…±è®¡ 6 ä¸ªå˜é‡ï¼Œä¸‹æ ‡ä» (0,0) åˆ° (1,2) x = model.addVars(2, 3, vtype=COPT.INTEGER, nameprefix=\u0026#39;x\u0026#39;) print(x.select()) è¾“å‡ºï¼š\n1 [\u0026lt;coptpy.Var: x(0,0)\u0026gt;, \u0026lt;coptpy.Var: x(0,1)\u0026gt;, \u0026lt;coptpy.Var: x(0,2)\u0026gt;, \u0026lt;coptpy.Var: x(1,0)\u0026gt;, \u0026lt;coptpy.Var: x(1,1)\u0026gt;, \u0026lt;coptpy.Var: x(1,2)\u0026gt;] å¯ä»¥é€šè¿‡ä¸‹æ ‡è®¿é—®è¿™äº›å˜é‡ï¼š\n1 2 3 for i in range(2): for j in range(3): print(x[i,j].name, end=\u0026#39; \u0026#39;) è¾“å‡ºï¼š\n1 x(0,0) x(0,1) x(0,2) x(1,0) x(1,1) x(1,2) å¯ä»¥çœ‹åˆ° $ x $ å®é™…ä¸Šæ˜¯ä¸€ä¸ª tupledict å¯¹è±¡ï¼Œå…¶é”®æ˜¯å˜é‡ä¸‹æ ‡ï¼ˆå¦‚ (0,0)ï¼‰ï¼Œå€¼æ˜¯ Var å¯¹è±¡ã€‚\nForm 2: Using tuplelist for Non-contiguous Indices:\nå½“å˜é‡ä¸‹æ ‡ä¸æ˜¯è¿ç»­æ•´æ•°æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ coptpy.tuplelist æ¥æ˜ç¡®æŒ‡å®šéœ€è¦åˆ›å»ºçš„å˜é‡ã€‚\n1 2 3 4 t = cp.tuplelist([(0, 1), (1, 2)]) x = model.addVars(t, nameprefix=\u0026#34;t\u0026#34;) print(x.select()) è¾“å‡ºï¼š\n1 [\u0026lt;coptpy.Var: t(0,1)\u0026gt;, \u0026lt;coptpy.Var: t(1,2)\u0026gt;] Form 3: Using Multiple Lists for Cartesian Product:\n*indices å¯ä»¥æ˜¯å¤šä¸ªåˆ—è¡¨ï¼ŒaddVars ä¼šè‡ªåŠ¨ç”Ÿæˆè¿™äº›åˆ—è¡¨çš„ç¬›å¡å°”ç§¯ä½œä¸ºå˜é‡çš„ä¸‹æ ‡ã€‚\n1 2 3 4 5 t = [\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;] # åˆ›å»º x[\u0026#39;a\u0026#39;,0,0], x[\u0026#39;a\u0026#39;,0,1], ..., x[\u0026#39;b\u0026#39;,1,2] ç­‰å˜é‡ x = model.addVars(t, range(2), range(3)) print(x.select()) è¾“å‡ºï¼š\n1 [\u0026lt;coptpy.Var: C(a,0,0)\u0026gt;, \u0026lt;coptpy.Var: C(a,0,1)\u0026gt;, \u0026lt;coptpy.Var: C(a,0,2)\u0026gt;, \u0026lt;coptpy.Var: C(a,1,0)\u0026gt;, \u0026lt;coptpy.Var: C(a,1,1)\u0026gt;, \u0026lt;coptpy.Var: C(a,1,2)\u0026gt;, \u0026lt;coptpy.Var: C(b,0,0)\u0026gt;, \u0026lt;coptpy.Var: C(b,0,1)\u0026gt;, \u0026lt;coptpy.Var: C(b,0,2)\u0026gt;, \u0026lt;coptpy.Var: C(b,1,0)\u0026gt;, \u0026lt;coptpy.Var: C(b,1,1)\u0026gt;, \u0026lt;coptpy.Var: C(b,1,2)\u0026gt;] ä»æ­¤ç¤ºä¾‹å¯ä»¥çœ‹å‡ºï¼Œå˜é‡çš„ä¸‹æ ‡ä¹Ÿå¯ä»¥æ˜¯å­—ç¬¦ä¸²ç±»å‹ã€‚\nAdding Constraints å¯ä»¥é€šè¿‡ addConstr() å’Œ addConstrs() æ–¹æ³•å‘æ¨¡å‹ä¸­æ·»åŠ çº¦æŸã€‚\nAdding a Single Constraint:\nä½¿ç”¨ model.addConstr() æ·»åŠ ä¸€ä¸ªçº¦æŸã€‚\n1 model.addConstr(lhs, sense=None, rhs=None, name=\u0026#34;\u0026#34;) lhsï¼šçº¦æŸçš„å·¦ä¾§è¡¨è¾¾å¼ã€‚å¯¹äºçº¿æ€§çº¦æŸï¼Œå¯ä»¥æ˜¯ Var å¯¹è±¡ã€LinExpr å¯¹è±¡æˆ– ConstrBuilder å¯¹è±¡ã€‚ senseï¼šçº¦æŸçš„ç±»å‹ï¼Œå¯ä»¥æ˜¯ï¼š cp.COPT.LESS_EQUAL (\u0026lt;=) cp.COPT.EQUAL (==) cp.COPT.GREATER_EQUAL (\u0026gt;=) rhsï¼šçº¦æŸçš„å³ä¾§å€¼ã€‚ nameï¼šçº¦æŸçš„åç§°ã€‚ ä¾‹å­ï¼š\n1 2 3 # å‡è®¾ x å’Œ y éƒ½æ˜¯æ¨¡å‹ä¸­çš„å˜é‡ # æ·»åŠ ä¸€ä¸ªçº¿æ€§çº¦æŸ x + y \u0026lt;= 10 model.addConstr(x + y \u0026lt;= 10, name=\u0026#34;total_limit\u0026#34;) Adding Multiple Constraints:\nä½¿ç”¨ model.addConstrs() æ–¹æ³•æ·»åŠ ä¸€ç»„ç±»ä¼¼çš„çº¦æŸï¼Œé€šå¸¸é€šè¿‡ç”Ÿæˆå™¨è¡¨è¾¾å¼æ¥å®Œæˆã€‚\n1 2 3 # å‡è®¾ x å’Œ y æ˜¯é€šè¿‡ addVars ç”Ÿæˆçš„å˜é‡ç»„ # æ·»åŠ  10 ä¸ªçº¿æ€§çº¦æŸï¼Œæ¯ä¸ªçº¦æŸå½¢å¦‚ï¼šx[i] + y[i] \u0026gt;= 2.0 model.addConstrs(x[i] + y[i] \u0026gt;= 2.0 for i in range(10), nameprefix=\u0026#34;pairwise_sum\u0026#34;) nameprefixï¼šçº¦æŸåç§°çš„å‰ç¼€ï¼ŒCOPT ä¼šè‡ªåŠ¨åœ¨å…¶åæ·»åŠ ä¸‹æ ‡ã€‚ Adding Indicator Constraints:\næŒ‡ç¤ºçº¦æŸæ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„çº¦æŸï¼Œå®ƒåœ¨ä¸€ä¸ªäºŒå€¼å˜é‡å–ç‰¹å®šå€¼æ—¶æ¿€æ´»ä¸€ä¸ªçº¿æ€§çº¦æŸã€‚\n1 model.addGenConstrIndicator(binvar, binval, lhs, sense=None, rhs=None) binvarï¼šä½œä¸ºæŒ‡ç¤ºå™¨åŠŸèƒ½çš„äºŒè¿›åˆ¶å˜é‡ã€‚ binvalï¼šbinvar çš„ç›®æ ‡å€¼ï¼ˆTrue æˆ– False / $ 1 $ æˆ– $ 0 $ï¼‰ï¼Œå½“ binvar å–æ­¤å€¼æ—¶ï¼Œçº¿æ€§çº¦æŸè¢«æ¿€æ´»ã€‚ lhs/sense/rhsï¼šå®šä¹‰è¢«æ¿€æ´»çš„çº¿æ€§çº¦æŸï¼ˆä¸ addConstr ç±»ä¼¼ï¼‰ã€‚ ä¾‹å­ï¼š\n1 2 3 # å‡è®¾ x æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶å˜é‡ï¼Œy å’Œ z æ˜¯æ¨¡å‹ä¸­çš„å˜é‡ # æ·»åŠ ä¸€ä¸ª Indicator çº¦æŸï¼šå½“ x ä¸º True (å³ x=1) æ—¶ï¼Œçº¿æ€§çº¦æŸ y + 2*z \u0026gt;= 3 æˆç«‹ model.addGenConstrIndicator(x, True, y + 2*z \u0026gt;= 3, name=\u0026#34;indicator_constr\u0026#34;) Setting the Objective Function ä½¿ç”¨ model.setObjective() æ–¹æ³•å®šä¹‰æ¨¡å‹çš„ä¼˜åŒ–ç›®æ ‡ã€‚\n1 model.setObjective(expr, sense=None) exprï¼šç›®æ ‡å‡½æ•°è¡¨è¾¾å¼ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ª LinExpr å¯¹è±¡ã€‚ senseï¼šç›®æ ‡çš„ä¼˜åŒ–æ–¹å‘ï¼Œå¯ä»¥æ˜¯ cp.COPT.MAXIMIZE æˆ– cp.COPT.MINIMIZEã€‚ ä¾‹å­ï¼š\n1 2 # å‡è®¾ profit æ˜¯ä¸€ä¸ªçº¿æ€§è¡¨è¾¾å¼ model.setObjective(profit, COPT.MAXIMIZE) Retrieving Model Information ä»¥ä¸‹æ–¹æ³•ç”¨äºè·å–æ¨¡å‹æ±‚è§£åçš„å„ç§ä¿¡æ¯ã€‚\nGetting All Variables:\n1 vars = model.getVars() è¿”å›ä¸€ä¸ª VarArray å¯¹è±¡ï¼ŒåŒ…å«æ¨¡å‹ä¸­çš„æ‰€æœ‰å˜é‡ã€‚ Getting LP Analysis Results:\n1 values, slacks, duals, redcosts = model.getLpSolution() ä»…é€‚ç”¨äºçº¿æ€§è§„åˆ’ (LP) æ¨¡å‹ã€‚ è¿”å›ä¸€ä¸ªå››å…ƒç»„ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼š valuesï¼šå˜é‡çš„å–å€¼ã€‚ slacksï¼šæ¾å¼›å˜é‡çš„å–å€¼ã€‚ dualsï¼šçº¦æŸçš„å¯¹å¶å˜é‡å–å€¼ã€‚ redcostsï¼šå˜é‡çš„ Reduced Costã€‚ Getting Specific Model Information:\n1 model.getInfo(infoname, args) infonameï¼šå¾…è·å–ä¿¡æ¯çš„åç§°ï¼ˆå¦‚ COPT.Info.VarPrimal è·å–å˜é‡å€¼ï¼ŒCOPT.Info.ConDual è·å–å¯¹å¶å€¼ç­‰ï¼‰ã€‚ argsï¼šæŒ‡å®šè¦è·å–ä¿¡æ¯çš„å˜é‡æˆ–çº¦æŸã€‚ è‹¥ args ä¸ºå•ä¸ª Var æˆ– Constraint å¯¹è±¡ï¼Œåˆ™è¿”å›å…¶ä¿¡æ¯å€¼å¸¸é‡ã€‚ è‹¥ args ä¸ºåˆ—è¡¨ã€VarArray æˆ– ConstrArray å¯¹è±¡ï¼Œåˆ™è¿”å›ä¿¡æ¯å€¼ç»„æˆçš„åˆ—è¡¨ã€‚ è‹¥ args ä¸ºå­—å…¸æˆ– tupledict å¯¹è±¡ï¼Œåˆ™è¿”å›é”®ä¸ºæŒ‡å®šå˜é‡/çº¦æŸçš„ä¸‹æ ‡ï¼Œå€¼ä¸ºå…¶ä¿¡æ¯å€¼çš„ tupledict å¯¹è±¡ã€‚ Cloning a Model 1 mcopy = model.clone() åˆ›å»ºæ¨¡å‹çš„æ·±æ‹·è´ï¼Œmcopy æ˜¯ä¸€ä¸ªä¸åŸæ¨¡å‹ç‹¬ç«‹çš„æ–°æ¨¡å‹å®ä¾‹ã€‚ Var Class Var ç±»è¡¨ç¤ºæ¨¡å‹ä¸­çš„ä¸€ä¸ªå•ç‹¬å†³ç­–å˜é‡ã€‚\nAttributes åœ¨æ¨¡å‹æ±‚è§£åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å±æ€§è·å–å˜é‡çš„ç›¸åº”ä¿¡æ¯ã€‚\nvar.x æˆ– var.Valueï¼šå˜é‡çš„å½“å‰å–å€¼ã€‚ var.nameï¼šå˜é‡çš„åç§°ã€‚ var.Slackï¼šæ¾å¼›å˜é‡çš„å–å€¼ï¼ˆå¯¹äºçº¦æŸï¼Œæ­¤å±æ€§åœ¨å˜é‡å±‚é¢é€šå¸¸ä¸ç›´æ¥ä½¿ç”¨ï¼‰ã€‚ var.Dualï¼šå¯¹å¶å˜é‡çš„å–å€¼ï¼ˆä¸çº¦æŸçš„å¯¹å¶å€¼ç›¸å…³ï¼Œåœ¨å˜é‡å±‚é¢é€šå¸¸ä¸ç›´æ¥ä½¿ç”¨ï¼‰ã€‚ var.LBï¼šå˜é‡çš„ä¸‹ç•Œã€‚ var.UBï¼šå˜é‡çš„ä¸Šç•Œã€‚ Methods varname = v.getName()ï¼šè·å–å˜é‡ v çš„åç§°ã€‚ v.setName('new_name')ï¼šè®¾ç½®å˜é‡ v çš„åç§°ã€‚ x.remove()ï¼šä»æ¨¡å‹ä¸­åˆ é™¤å˜é‡ xã€‚ VarArray Class VarArray ç±»æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å®¹å™¨ï¼Œç”¨äºå­˜å‚¨ä¸€ç»„ Var å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œmodel.getVars() çš„è¿”å›å€¼å°±æ˜¯ VarArray ç±»å‹ã€‚\nMethods var = vararr.getVar(idx)ï¼šæ ¹æ®å˜é‡åœ¨ VarArray å¯¹è±¡ä¸­çš„ä¸‹æ ‡è·å–ç›¸åº”çš„å˜é‡ï¼Œè¿”å›ä¸€ä¸ª Var å¯¹è±¡ã€‚ varall = vararr.getAll()ï¼šè·å– VarArray å¯¹è±¡ä¸­çš„æ‰€æœ‰å˜é‡ï¼Œè¿”å›ä¸€ä¸ªåˆ—è¡¨ã€‚ arrsize = vararr.getSize()ï¼šè·å– vararr ä¸­å˜é‡çš„ä¸ªæ•°ã€‚ Important Data Structures coptpy åº“æä¾›äº†ä¸€äº›ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œä»¥æ–¹ä¾¿å¤„ç†å˜é‡å’Œçº¦æŸçš„é›†åˆï¼Œç‰¹åˆ«æ˜¯å¤šç»´æƒ…å†µã€‚\nmultidict multidict å‡½æ•°å¯ä»¥å°†è¾“å…¥å­—å…¸æ‹†åˆ†ä¸ºå¤šä¸ªå¹³è¡Œå­—å…¸ã€‚å½“æœ‰ä¸€ä¸ªå­—å…¸ï¼Œå…¶å€¼æ˜¯åˆ—è¡¨æˆ–å…ƒç»„ï¼Œå¹¶ä¸”å¸Œæœ›å°†æ¯ä¸ªå­å…ƒç´ ä½œä¸ºå•ç‹¬çš„å­—å…¸æ—¶ï¼Œå®ƒéå¸¸æœ‰ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 import coptpy as cp # å°†è¾“å…¥çš„å­—å…¸å¯¹è±¡æ‹†åˆ†ä¸ºé”®ä¸å¤šä¸ªå­—å…¸å¯¹è±¡å¹¶è¿”å› keys, dict1, dict2 = cp.multidict({ \u0026#34;hello\u0026#34;: [0, 1], \u0026#34;world\u0026#34;: [2, 3] }) print(f\u0026#34;keys: {keys}\u0026#34;) print(f\u0026#34;dict1: {dict1}\u0026#34;) print(f\u0026#34;dict2: {dict2}\u0026#34;) è¾“å‡ºï¼š\n1 2 3 keys: [\u0026#39;hello\u0026#39;, \u0026#39;world\u0026#39;] dict1: {\u0026#39;hello\u0026#39;: 0, \u0026#39;world\u0026#39;: 2} dict2: {\u0026#39;hello\u0026#39;: 1, \u0026#39;world\u0026#39;: 3} multidict è¿”å›ä¸€ä¸ªå…ƒç»„ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯åŸå§‹å­—å…¸çš„æ‰€æœ‰é”®ç»„æˆçš„åˆ—è¡¨ï¼Œéšåçš„å…ƒç´ æ˜¯æ ¹æ®åŸå§‹å­—å…¸å€¼ä¸­å¯¹åº”ä½ç½®å…ƒç´ ç”Ÿæˆçš„å­—å…¸ã€‚\ntupledict tupledict æ˜¯ Python å†…ç½® dict çš„å­ç±»ï¼Œä¸“ä¸ºä½¿ç”¨å…ƒç»„ä½œä¸ºé”®çš„å­—å…¸è¿›è¡Œäº†ä¼˜åŒ–ã€‚å®ƒç»§æ‰¿äº† dict çš„æ‰€æœ‰æ–¹æ³•ï¼Œå¹¶é¢å¤–æä¾›äº† selectã€sum å’Œ prod ç­‰æ–¹ä¾¿çš„é›†åˆæ“ä½œã€‚model.addVars() çš„è¿”å›å€¼å°±æ˜¯ä¸€ä¸ª tupledictã€‚\nCreating a tupledict:\n1 2 d = cp.tupledict([((1,1),\u0026#39;a\u0026#39;), ((1,2),\u0026#39;b\u0026#39;),((2,1),\u0026#39;c\u0026#39;),((2,2),\u0026#39;d\u0026#39;)]) print(d) è¾“å‡ºï¼š\n1 {(1, 1): \u0026#39;a\u0026#39;, (1, 2): \u0026#39;b\u0026#39;, (2, 1): \u0026#39;c\u0026#39;, (2, 2): \u0026#39;d\u0026#39;} å¯ä»¥ä½¿ç”¨ä¸‹æ ‡è®¿é—® tupledict ä¸­çš„å…ƒç´ ï¼Œå¦‚åŒè®¿é—®æ™®é€šå­—å…¸ä¸€æ ·ï¼š\n1 2 3 for i in range(1, 3): for j in range(1, 3): print(d[i,j], end=\u0026#39; \u0026#39;) è¾“å‡ºï¼š\n1 a b c d select Method:\ntupledict.select(pattern) æ–¹æ³•æ ¹æ®æŒ‡å®šçš„æ¨¡å¼ç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„é¡¹ï¼Œè¿”å›åŒ…å«æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å€¼çš„åˆ—è¡¨ã€‚pattern ä¸­çš„ * ä»£è¡¨é€šé…ç¬¦ã€‚æ³¨æ„ï¼Œpattern åŒ¹é…çš„æ˜¯ tupledict çš„é”®ã€‚\n1 2 3 4 5 d = cp.tupledict([((1,1),\u0026#39;a\u0026#39;), ((1,2),\u0026#39;b\u0026#39;),((2,1),\u0026#39;c\u0026#39;),((2,2),\u0026#39;d\u0026#39;)]) print(d.select(2,\u0026#39;*\u0026#39;)) # ç­›é€‰ç¬¬ä¸€ä¸ªé”®ä¸º 2 çš„é¡¹ print(d.select(1,2)) # ç­›é€‰ç²¾ç¡®é”®ä¸º (1,2) çš„é¡¹ print(d.select()) # ç­›é€‰æ‰€æœ‰é¡¹ è¾“å‡ºï¼š\n1 2 3 [\u0026#39;c\u0026#39;, \u0026#39;d\u0026#39;] [\u0026#39;b\u0026#39;] [\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;, \u0026#39;c\u0026#39;, \u0026#39;d\u0026#39;] sum Method:\nexpr = tupledict.sum(pattern) æ–¹æ³•æ ¹æ®æŒ‡å®šçš„æ¨¡å¼ç­›é€‰å¹¶ç´¯åŠ é¡¹ï¼Œè¿”å›ä¸€ä¸ª LinExpr å¯¹è±¡ï¼ˆå¦‚æœ tupledict ä¸­çš„å€¼æ˜¯æ•°å­—ï¼‰ã€‚è¿™é‡Œçš„ pattern ç”¨æ³•ä¸ select æ–¹æ³•å®Œå…¨ç›¸åŒã€‚\n1 2 d = cp.tupledict([((1,1),1), ((1,2),2),((2,1),3),((2,2),4)]) print(d.sum(\u0026#39;*\u0026#39;, 2)) # åŒ¹é…ç¬¬äºŒä¸ªé”®ä¸º 2 çš„é¡¹ï¼Œå³ d[(1,2)] å’Œ d[(2,2)]ï¼Œå¹¶æ±‚å’Œ è¾“å‡ºï¼š\n1 6.0 prod Method:\nexpr = d.prod(coeff, pattern) æ–¹æ³•æ ¹æ®æŒ‡å®šçš„æ¨¡å¼ç­›é€‰ï¼Œå¹¶ä¸ä¹˜ç§¯ç³»æ•°ç´¯ä¹˜é¡¹ï¼Œè¿”å›ä¸€ä¸ª LinExpr å¯¹è±¡ã€‚coeff æ˜¯ä¸€ä¸ªå­—å…¸æˆ– tupledict ç±»å‹ï¼Œå…¶é”®éœ€è¦ä¸ d çš„é”®å¯¹åº”ã€‚pattern çš„å«ä¹‰ä¸ select ç›¸åŒã€‚æœ¬è´¨ä¸Šï¼Œprod æ–¹æ³•æ‰§è¡Œçš„æ˜¯ç‚¹ç§¯æ“ä½œã€‚\n1 2 3 4 5 6 d = cp.tupledict([((1,1),1), ((1,2),2),((2,1),3),((2,2),4)]) coef = cp.tupledict([((1,1),2), ((1,2),2),((2,1),3),((2,2),3)]) # åŒ¹é…ç¬¬äºŒä¸ªé”®ä¸º 2 çš„é¡¹ï¼Œå³ d[(1,2)] å’Œ d[(2,2)] # è®¡ç®— (d[(1,2)] * coeff[(1,2)]) + (d[(2,2)] * coeff[(2,2)]) # å³ (2 * 2) + (4 * 3) = 4 + 12 = 16 print(d.prod(coef, \u0026#39;*\u0026#39;, 2)) è¾“å‡ºï¼š\n1 16.0 tuplelist tuplelist æ˜¯ Python å†…ç½® list çš„å­ç±»ï¼Œä¸“é—¨ç”¨äºå­˜å‚¨å…ƒç»„åˆ—è¡¨ã€‚å®ƒç»§æ‰¿äº† list çš„æ‰€æœ‰æ–¹æ³•ï¼Œå¹¶å¢å¼ºäº† select å’Œ add ç­‰åŠŸèƒ½ã€‚\nCreating a tuplelist:\n1 2 3 4 5 tl1 = cp.tuplelist([(0, 1), (1, 2)]) tl2 = cp.tuplelist([(\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;), (\u0026#39;b\u0026#39;, \u0026#39;c\u0026#39;)]) print(tl1) print(tl2) è¾“å‡ºï¼š\n1 2 [(0, 1), (1, 2)] [(\u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;), (\u0026#39;b\u0026#39;, \u0026#39;c\u0026#39;)] å¯ä»¥ç›´æ¥ç”¨ç´¢å¼•è®¿é—®åˆ—è¡¨çš„æˆå‘˜ã€‚\nadd Method:\ntl.add((2, 3)) æ–¹æ³•ç”¨äºå‘ tuplelist ä¸­æ·»åŠ æˆå‘˜ï¼ŒåŠŸèƒ½ç±»ä¼¼äº list.append()ã€‚\n1 2 3 tl = cp.tuplelist([(0, 1), (1, 2)]) tl.add((2, 3)) print(tl) è¾“å‡ºï¼š\n1 [(0, 1), (1, 2), (2, 3)] select Method:\nselect æ–¹æ³•çš„æ€æƒ³ä¸ tupledict ä¸­çš„ select ç›¸åŒï¼Œæ ¹æ®æŒ‡å®šçš„æ¨¡å¼ç­›é€‰ç¬¦åˆæ¡ä»¶çš„å…ƒç»„ã€‚\n1 2 tl = cp.tuplelist([(0, 1), (1, 2)]) print(tl.select(0,\u0026#39;*\u0026#39;)) # ç­›é€‰ç¬¬ä¸€ä¸ªå…ƒç´ ä¸º 0 çš„å…ƒç»„ è¾“å‡ºï¼š\n1 [(0, 1)] Mixed-Integer Programming (MIP) ç¦»æ•£ä¼˜åŒ–çš„æ ¸å¿ƒå·¥å…·æ˜¯æ··åˆæ•´æ•°è§„åˆ’ (Mixed-Integer Programming, MIP)ã€‚ä¸€ä¸ªæ ‡å‡†çš„ MIP æ¨¡å‹åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒè¦ç´ ï¼š\nå†³ç­–å˜é‡ (Decision Variables)ï¼šæ¨¡å‹ä¸­éœ€è¦æ±‚è§£çš„æœªçŸ¥æ•°ã€‚åœ¨ç¦»æ•£ä¼˜åŒ–ä¸­ï¼Œè¿™äº›å˜é‡é€šå¸¸è¢«çº¦æŸä¸ºæ•´æ•°ï¼ˆä¾‹å¦‚ï¼Œå·¥äººæ•°ã€äº§å“ä»¶æ•°ï¼‰æˆ– 0-1 äºŒè¿›åˆ¶å˜é‡ï¼ˆä¾‹å¦‚ï¼ŒæŸä¸ªå†³ç­–æ˜¯å¦æ‰§è¡Œï¼‰ã€‚\nç›®æ ‡å‡½æ•° (Objective Function)ï¼šä¸€ä¸ªå…³äºå†³ç­–å˜é‡çš„çº¿æ€§è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æœ€å¤§åŒ–ï¼ˆå¦‚åˆ©æ¶¦ã€æ•ˆç‡ï¼‰æˆ–æœ€å°åŒ–ï¼ˆå¦‚æˆæœ¬ã€è·ç¦»ï¼‰ã€‚\nçº¦æŸæ¡ä»¶ (Constraints)ï¼šä¸€ç³»åˆ—å…³äºå†³ç­–å˜é‡çš„çº¿æ€§ç­‰å¼æˆ–ä¸ç­‰å¼ï¼Œç”¨äºå®šä¹‰é—®é¢˜çš„å¯è¡ŒåŸŸã€‚\næˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯å°†ä¸€ä¸ªå…·ä½“é—®é¢˜ç”¨è¿™ä¸‰ä¸ªè¦ç´ æ¸…æ™°åœ°è¡¨è¾¾å‡ºæ¥ï¼Œç„¶åäº¤ç»™ COPT è¿›è¡Œæ±‚è§£ã€‚\n0-1 Knapsack Problem å¯¹äº 0-1 èƒŒåŒ…é—®é¢˜ï¼Œå®šä¹‰ $ N $ ä¸ºç‰©å“æ€»æ•°ï¼Œ$ w_{i},v_{i} $ åˆ†åˆ«ä¸ºç‰©å“ $ i $ çš„é‡é‡å’Œä»·å€¼ï¼Œ$ C $ ä¸ºèƒŒåŒ…çš„å®¹é‡ã€‚é‚£ä¹ˆå°±å¯ä»¥åˆ—å‡ºè¿™ä¸ªé—®é¢˜çš„ä¸‰ä¸ªè¦ç´ ï¼š\nå†³ç­–å˜é‡ï¼šå®šä¹‰äºŒè¿›åˆ¶ä¸² $ x_{i} $ è¡¨ç¤ºæ˜¯å¦é€‰å–ã€‚ $$ x_i \\in \\{0, 1\\}, \\quad \\forall i \\in \\{1, ..., N\\} $$ ç›®æ ‡å‡½æ•°ï¼šæœ€å¤§åŒ–èƒŒåŒ…å†…ç‰©å“çš„æ€»ä»·å€¼ã€‚ $$ \\max \\sum_{i=1}^{N} v_i x_i $$ çº¦æŸæ¡ä»¶ï¼šè£…å…¥èƒŒåŒ…çš„ç‰©å“æ€»é‡é‡ä¸èƒ½è¶…è¿‡èƒŒåŒ…å®¹é‡ã€‚ $$ \\text{s.t.} \\quad \\sum_{i=1}^{N} w_i x_i \\leq C $$ é‚£ä¹ˆå°±å¯ä»¥å¾—åˆ° COPT çš„æ±‚è§£ä»£ç ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 import coptpy as cp from coptpy import COPT # 1. åˆ›å»ºç¯å¢ƒå’Œæ¨¡å‹ env = cp.Envr() model = env.createModel(\u0026#34;Knapsack\u0026#34;) # 2. å®šä¹‰æ•°æ® weights = [4, 5, 2, 6, 3] # é‡é‡ values = [10, 12, 5, 15, 7] # ä»·å€¼ capacity = 12 # èƒŒåŒ…å®¹é‡ n = len(weights) # 3. åˆ›å»ºå†³ç­–å˜é‡ # x[i] = 1 if item i is selected, 0 otherwise x = model.addVars(n, vtype=COPT.BINARY, nameprefix=\u0026#34;x\u0026#34;) # 4. è®¾ç½®ç›®æ ‡å‡½æ•° model.setObjective(cp.quicksum(values[i] * x[i] for i in range(n)), COPT.MAXIMIZE) # 5. æ·»åŠ çº¦æŸæ¡ä»¶ model.addConstr(cp.quicksum(weights[i] * x[i] for i in range(n)) \u0026lt;= capacity) # 6. æ±‚è§£æ¨¡å‹ model.solve() # 7. æ‰“å°ç»“æœ if model.status == COPT.OPTIMAL: print(\u0026#34;Optimal solution found.\u0026#34;) print(f\u0026#34;Total value: {model.objval:.2f}\u0026#34;) selected_items = [i for i in range(n) if x[i].x \u0026gt; 0.5] print(f\u0026#34;Selected items (indices): {selected_items}\u0026#34;) else: print(\u0026#34;No optimal solution found.\u0026#34;) Traveling Salesperson Problem (TSP) æ—…è¡Œå•†é—®é¢˜ã€‚ç»™å®šä¸€ç³»åˆ—åŸå¸‚å’Œæ¯å¯¹åŸå¸‚ä¹‹é—´çš„è·ç¦»ï¼Œæ±‚è§£è®¿é—®æ¯ä¸€åº§åŸå¸‚ä¸€æ¬¡å¹¶æœ€ç»ˆå›åˆ°èµ·å§‹åŸå¸‚çš„æœ€çŸ­å¯èƒ½è·¯å¾„ã€‚æ­¤é—®é¢˜çš„ä¸€ä¸ªç»å…¸ MIP æ¨¡å‹æ˜¯ Miller-Tucker-Zemlin (MTZ) å…¬å¼ã€‚\nå®šä¹‰ $ N $ ä¸ºåŸå¸‚æ€»æ•°é‡ï¼Œ$ d_{i,j} $ ä¸ºåŸå¸‚ $ i $ åˆ°åŸå¸‚ $ j $ çš„è·ç¦»ï¼Œé‚£ä¹ˆå¯ä»¥å¾—åˆ°ï¼š\nå†³ç­–å˜é‡ï¼š äºŒè¿›åˆ¶å˜é‡ $ x_{i,j} $ ï¼Œè¡¨ç¤ºæ˜¯å¦ç»è¿‡ $ i $ åˆ° $ j $ ä¹‹é—´è·¯å¾„ã€‚ $$ x_{ij} \\in \\{0, 1\\}, \\quad \\forall i, j \\in \\{0, ..., N-1\\}, i \\neq j $$ è¾…åŠ©è¿ç»­å˜é‡ $ u_{i} $ ç”¨äºæ¶ˆé™¤å­å›è·¯ $$ u_i \\ge 0, \\quad \\forall i \\in \\{0, ..., N-1\\} $$ ç›®æ ‡å‡½æ•°ï¼šæœ€å°åŒ–æ€»è·¯ç¨‹ã€‚ $$ \\min \\sum_{i=0}^{N-1} \\sum_{j=0, j\\neq i}^{N-1} d_{i,j} x_{i,j} $$ çº¦æŸæ¡ä»¶ï¼š æ¯ä¸ªåŸå¸‚å¿…é¡»ä¸”åªèƒ½è¿›å…¥ä¸€æ¬¡ã€‚ $$ \\sum_{i=0, i\\neq j}^{N-1} x_{i,j} = 1, \\quad \\forall j \\in \\{0, ..., N-1\\} $$ æ¯ä¸ªåŸå¸‚å¿…é¡»ä¸”åªèƒ½ç¦»å¼€ä¸€æ¬¡ã€‚ $$ \\sum_{j=0, j\\neq i}^{N-1} x_{ij} = 1, \\quad \\forall i \\in \\{0, ..., N-1\\} $$ æ¶ˆé™¤å­å›è·¯çº¦æŸã€‚ $$ u_i - u_j + N \\cdot x_{ij} \\le N-1, \\quad \\forall i, j \\in \\{1, ..., N-1\\}, i \\neq j $$ é‚£ä¹ˆå°±å¯ä»¥å¾—åˆ°ä»£ç ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 import coptpy as cp from coptpy import COPT import random # 1. åˆ›å»ºç¯å¢ƒå’Œæ¨¡å‹ env = cp.Envr() model = env.createModel(\u0026#34;TSP\u0026#34;) # 2. å®šä¹‰æ•°æ® n_cities = 10 # ç”ŸæˆéšæœºåŸå¸‚åæ ‡ coords = {i: (random.randint(0, 100), random.randint(0, 100)) for i in range(n_cities)} # è®¡ç®—è·ç¦»çŸ©é˜µ distances = {(i, j): ((coords[i][0] - coords[j][0])**2 + (coords[i][1] - coords[j][1])**2)**0.5 for i in range(n_cities) for j in range(n_cities) if i != j} # 3. åˆ›å»ºå†³ç­–å˜é‡ # x[i, j] = 1 if path from city i to j is taken, 0 otherwise x = model.addVars(distances.keys(), vtype=COPT.BINARY, nameprefix=\u0026#34;x\u0026#34;) # è¾…åŠ©å˜é‡ç”¨äºæ¶ˆé™¤å­å›è·¯ u = model.addVars(n_cities, vtype=COPT.CONTINUOUS, nameprefix=\u0026#34;u\u0026#34;) # 4. è®¾ç½®ç›®æ ‡å‡½æ•° model.setObjective(x.prod(distances), COPT.MINIMIZE) # 5. æ·»åŠ çº¦æŸæ¡ä»¶ # æ¯ä¸ªåŸå¸‚å¿…é¡»ç¦»å¼€ä¸€æ¬¡ model.addConstrs((cp.quicksum(x[i, j] for j in range(n_cities) if i != j) == 1 for i in range(n_cities)), nameprefix=\u0026#34;leave\u0026#34;) # æ¯ä¸ªåŸå¸‚å¿…é¡»è¿›å…¥ä¸€æ¬¡ model.addConstrs((cp.quicksum(x[i, j] for i in range(n_cities) if i != j) == 1 for j in range(n_cities)), nameprefix=\u0026#34;enter\u0026#34;) # æ¶ˆé™¤å­å›è·¯ (MTZ) model.addConstrs((u[i] - u[j] + n_cities * x[i, j] \u0026lt;= n_cities - 1 for i in range(1, n_cities) for j in range(1, n_cities) if i != j), nameprefix=\u0026#34;subtour\u0026#34;) # 6. æ±‚è§£æ¨¡å‹ # ä¸ºå¤æ‚é—®é¢˜è®¾ç½®æ—¶é—´é™åˆ¶ model.setParam(COPT.Param.TimeLimit, 60) model.solve() # 7. æ‰“å°ç»“æœ if model.status == COPT.OPTIMAL: print(f\u0026#34;Optimal solution found with total distance: {model.objval:.2f}\u0026#34;) path = [] current_city = 0 while len(path) \u0026lt; n_cities: path.append(current_city) for j in range(n_cities): if current_city != j and x[current_city, j].x \u0026gt; 0.5: current_city = j break print(f\u0026#34;Path: {path}\u0026#34;) å…¶ä½™é—®é¢˜æ–¹æ³•å‡ç±»ä¼¼ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ï¼Œæ€»ä¹‹è§£å†³é—®é¢˜çš„æµç¨‹å°±æ˜¯å®šä¹‰å†³ç­–å˜é‡ï¼Œæ„å»ºç›®æ ‡å‡½æ•°ï¼Œæ„å»ºçº¦æŸä¸‰æ­¥ã€‚\nAdvanced Tips åœ¨æ¯”èµ›ä¸­éœ€è¦é«˜æ•ˆçš„å»ºæ¨¡å’Œè°ƒè¯•ã€‚\nDebugging Infeasible Models å½“æ¨¡å‹æ²¡æœ‰å¯è¡Œè§£æ—¶ (model.status == COPT.INFEASIBLE)ï¼Œæ„å‘³ç€çº¦æŸæ¡ä»¶ä¹‹é—´å­˜åœ¨å†²çªã€‚æ‰¾å‡ºé—®é¢˜æ‰€åœ¨éå¸¸å›°éš¾ã€‚COPT æä¾›äº†ä¸å¯çº¦ä¸ä¸€è‡´å­ç³»ç»Ÿ (Irreducible Inconsistent Subsystem, IIS) å·¥å…·æ¥å®šä½é—®é¢˜ã€‚IIS æ˜¯åŸå§‹æ¨¡å‹çº¦æŸçš„ä¸€ä¸ªæœ€å°å­é›†ï¼Œå…¶æœ¬èº«æ˜¯ä¸å¯è¡Œçš„ã€‚\nä½¿ç”¨æµç¨‹ï¼š\né¦–å…ˆè°ƒç”¨ model.solve() å¹¶ç¡®è®¤æ¨¡å‹çŠ¶æ€ä¸ºä¸å¯è¡Œã€‚ è°ƒç”¨ model.computeIIS() æ¥è®¡ç®— IISã€‚ éå†æ¨¡å‹çš„çº¦æŸï¼Œé€šè¿‡æ£€æŸ¥å…¶ IISConstr å±æ€§ï¼Œæ‰¾å‡ºå±äº IIS çš„çº¦æŸã€‚è¿™äº›çº¦æŸå°±æ˜¯å¯¼è‡´æ¨¡å‹ä¸å¯è¡Œçš„å…ƒå‡¶ã€‚ 1 2 3 4 5 6 7 8 9 # (åœ¨æ¨¡å‹æ±‚è§£å) if model.status == COPT.INFEASIBLE: print(\u0026#34;Model is infeasible. Computing IIS...\u0026#34;) model.computeIIS() print(\u0026#34;The following constraints are in the IIS:\u0026#34;) for constr in model.getConstrs(): if constr.IISConstr: print(f\u0026#34;- {constr.name}\u0026#34;) Parameter Tuning for Performance å¯¹äºå¤§è§„æ¨¡æˆ–å¤æ‚çš„ MIP é—®é¢˜ï¼Œé»˜è®¤å‚æ•°å¯èƒ½æ— æ³•åœ¨æœ‰é™æ—¶é—´å†…æ‰¾åˆ°å¥½çš„è§£ã€‚å¯ä»¥ä½¿ç”¨ COPT çš„å‚æ•°è°ƒä¼˜å·¥å…· (Tuner) è‡ªåŠ¨å¯»æ‰¾æœ€ä½³å‚æ•°ç»„åˆã€‚\nåœ¨ Python ä¸­ï¼Œå¯ä»¥é€šè¿‡ model.tune() æ–¹æ³•æ¥å¯åŠ¨è°ƒä¼˜å™¨ã€‚å®ƒä¼šå°è¯•ä¸åŒçš„å‚æ•°è®¾ç½®ï¼Œå¹¶åœ¨è°ƒä¼˜è¿‡ç¨‹ç»“æŸåï¼Œå°†æœ€ä¼˜å‚æ•°åº”ç”¨åˆ°æ¨¡å‹ä¸Šã€‚\n1 2 3 4 5 6 7 # åœ¨è°ƒç”¨ solve() ä¹‹å‰ï¼Œå¯ä»¥å…ˆè°ƒç”¨ tune() print(\u0026#34;Starting parameter tuning...\u0026#34;) model.tune() # è°ƒä¼˜åï¼Œå¯ä»¥ç›´æ¥æ±‚è§£æ¨¡å‹ print(\u0026#34;Tuning finished. Solving with best parameters...\u0026#34;) model.solve() References Pythonæ¥å£ - æ‰æ ‘æ±‚è§£å™¨ç”¨æˆ·æŒ‡å— coptæ±‚è§£å™¨çš„ä½¿ç”¨\u0026mdash;-å¸¸è§apiï¼ˆçŸ¥ä¹ï¼‰ ","permalink":"https://diefish1024.github.io/posts/misc/copt-%E6%B1%82%E8%A7%A3%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/","summary":"\u003cp\u003eé’ˆå¯¹ CUMCM-2025 å¼€å§‹å­¦ä¹  COPT æ±‚è§£å™¨çš„ä½¿ç”¨ï¼Œå­¦ä¹ å¦‚ä½•åº”ç”¨ COPT çš„ Python API (\u003ccode\u003ecoptpy\u003c/code\u003e) æ¥å»ºæ¨¡å¹¶æ±‚è§£æ•°å­¦å»ºæ¨¡ä¸­å¸¸è§çš„ç¦»æ•£ä¼˜åŒ–é—®é¢˜ã€‚\u003c/p\u003e\n\u003ch2 id=\"basic-api\"\u003eBasic API\u003c/h2\u003e\n\u003cp\u003eæœ¬èŠ‚å°†ä»‹ç» \u003ccode\u003eCOPT\u003c/code\u003e æ±‚è§£å™¨ \u003ccode\u003ePython API (coptpy)\u003c/code\u003e çš„æ ¸å¿ƒç»„ä»¶å’Œå¸¸ç”¨æ–¹æ³•ã€‚\u003c/p\u003e\n\u003ch3 id=\"envr-class\"\u003eEnvr Class\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eEnvr\u003c/code\u003e ç±»ç”¨äºåˆ›å»ºä¸€ä¸ª \u003ccode\u003eCOPT\u003c/code\u003e ç¯å¢ƒã€‚å®ƒæ˜¯æ‰€æœ‰æ¨¡å‹æ“ä½œçš„èµ·ç‚¹ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eCreating Environment and Model:\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"nn\"\u003ecoptpy\u003c/span\u003e \u003cspan class=\"k\"\u003eas\u003c/span\u003e \u003cspan class=\"nn\"\u003ecp\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003ecoptpy\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"n\"\u003eCOPT\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eenv\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecp\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnvr\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# åˆ›å»ºä¸€ä¸ª COPT ç¯å¢ƒå®ä¾‹\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003emodel\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eenv\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecreateModel\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;YourModelName\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e  \u003cspan class=\"c1\"\u003e# åœ¨ç¯å¢ƒä¸­åˆ›å»ºä¸€ä¸ªæ¨¡å‹\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e\u003ccode\u003ename\u003c/code\u003eï¼šæ¨¡å‹çš„åç§°ï¼Œæ­¤ä¸ºå¯é€‰å‚æ•°ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"model-class-properties-and-methods\"\u003eModel Class Properties and Methods\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eModel\u003c/code\u003e ç±»æ˜¯ \u003ccode\u003eCOPT\u003c/code\u003e çš„æ ¸å¿ƒï¼Œä»£è¡¨äº†ä¼˜åŒ–æ¨¡å‹ï¼ŒåŒ…å«äº†æ‰€æœ‰å˜é‡ã€çº¦æŸå’Œç›®æ ‡å‡½æ•°ã€‚\u003c/p\u003e\n\u003ch4 id=\"basic-properties\"\u003eBasic Properties\u003c/h4\u003e\n\u003cp\u003eåœ¨æ¨¡å‹æ±‚è§£åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å±æ€§è·å–å…¶åŸºæœ¬ä¿¡æ¯ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003emodel.status\u003c/code\u003eï¼š\u003cstrong\u003eæ¨¡å‹è§£çš„çŠ¶æ€\u003c/strong\u003eã€‚æ­¤å±æ€§æŒ‡ç¤ºæ¨¡å‹æ˜¯å¦æ‰¾åˆ°äº†æœ€ä¼˜è§£ã€æ— å¯è¡Œè§£ç­‰ã€‚ä¾‹å¦‚ï¼Œ\u003ccode\u003eCOPT.OPTIMAL\u003c/code\u003e è¡¨ç¤ºå·²æ‰¾åˆ°æœ€ä¼˜è§£ã€‚\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003emodel.objval\u003c/code\u003eï¼š\u003cstrong\u003eç›®æ ‡å‡½æ•°å€¼\u003c/strong\u003eã€‚æ­¤å±æ€§å­˜å‚¨æ¨¡å‹çš„æœ€ä¼˜ç›®æ ‡å‡½æ•°å€¼ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"adding-variables\"\u003eAdding Variables\u003c/h4\u003e\n\u003cp\u003eå¯ä»¥é€šè¿‡ \u003ccode\u003eaddVar()\u003c/code\u003e å’Œ \u003ccode\u003eaddVars()\u003c/code\u003e æ–¹æ³•å‘æ¨¡å‹ä¸­æ·»åŠ å†³ç­–å˜é‡ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eAdding a Single Variable:\u003c/strong\u003e\u003c/p\u003e","title":"COPT æ±‚è§£å™¨å­¦ä¹ ç¬”è®°"},{"content":"File Allocation Table è¦è®¾è®¡å¹¶å®ç°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å…³æ³¨å¹¶è§£å†³å­˜å‚¨åª’ä»‹å¸¦æ¥çš„ä¸¤å¤§æ ¸å¿ƒæŒ‘æˆ˜ï¼š\nè¯»å†™æ”¾å¤§ (Read/Write Amplification)ï¼šç°ä»£å­˜å‚¨è®¾å¤‡ï¼ˆæ— è®ºæ˜¯æœºæ¢°ç¡¬ç›˜è¿˜æ˜¯å›ºæ€ç¡¬ç›˜ï¼‰çš„ç‰©ç†ç‰¹æ€§å†³å®šäº†ï¼Œå®ƒä»¬æœ€é«˜æ•ˆçš„è¯»å†™æ–¹å¼æ˜¯æ“ä½œè¿ç»­çš„å¤§å—æ•°æ®åŒºåŸŸï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºä¸€ä¸ªå— (Block)ã€‚å¦‚æœéœ€è¦ä¿®æ”¹ä¸€ä¸ªå—ä¸­å“ªæ€•ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œä¹Ÿå¿…é¡»å°†æ•´ä¸ªå—è¯»å…¥å†…å­˜ã€ä¿®æ”¹ã€å†å®Œæ•´å†™å›ã€‚è¿™ç§â€œæ“ä½œå°‘é‡æ•°æ®å´å¯¼è‡´æ•´å—æ•°æ®è¢«è¯»å†™â€çš„ç°è±¡å°±æ˜¯è¯»å†™æ”¾å¤§ï¼Œå®ƒä¼šä¸¥é‡å½±å“æ€§èƒ½ã€‚\nå±€éƒ¨æ€§ (Locality)ï¼šç¨‹åºçš„å†…å­˜è®¿é—®è¡Œä¸ºé€šå¸¸å…·æœ‰å±€éƒ¨æ€§åŸç† (Principle of Locality)ï¼Œå³åœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œè®¿é—®çš„åœ°å€ä¼šé›†ä¸­åœ¨æŸä¸ªåŒºåŸŸã€‚æ–‡ä»¶ç³»ç»Ÿå¯ä»¥é€šè¿‡åˆç†çš„æ•°æ®æ’å¸ƒï¼Œè®©ç‰©ç†ä¸Šç›¸é‚»çš„æ•°æ®å—åœ¨é€»è¾‘ä¸Šä¹Ÿç›¸å…³è”ï¼ˆä¾‹å¦‚ï¼Œå±äºåŒä¸€ä¸ªæ–‡ä»¶ï¼‰ï¼Œä»è€Œåœ¨è¯»å–ä¸€å—æ•°æ®æ—¶ï¼Œå¯ä»¥åˆ©ç”¨é¢„è¯»æœºåˆ¶å°†åç»­å¯èƒ½è¢«è®¿é—®çš„æ•°æ®ä¹ŸåŠ è½½åˆ°å†…å­˜ç¼“å­˜ä¸­ï¼Œæé«˜æ•ˆç‡ã€‚\nåœ¨è½¯ç›˜ä¸Šå®ç°æ–‡ä»¶ç³»ç»Ÿ æˆ‘ä»¬çš„éœ€æ±‚æ˜¯ä¸ºä¸€ä¸ªå­˜å‚¨å®¹é‡å¾ˆå°çš„è®¾å¤‡ï¼ˆå¦‚è½¯ç›˜ï¼‰è®¾è®¡ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œä½¿ç”¨å¤æ‚çš„æ ‘å½¢æ•°æ®ç»“æ„ï¼ˆå¦‚ B+ æ ‘ï¼‰ä¼šå› ä¸ºå…ƒæ•°æ®æœ¬èº«å ç”¨è¿‡å¤šç©ºé—´è€Œæ˜¾å¾—æµªè´¹ã€‚å› æ­¤ï¼Œä¸€ä¸ªç®€å•çš„é“¾å¼ç»“æ„æ˜¯æ›´åˆé€‚çš„é€‰æ‹©ã€‚\nç›®å½•çš„å®ç°\nåœ¨ç®€å•çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œç›®å½•æœ¬èº«å¯ä»¥è¢«å®ç°ä¸ºä¸€ä¸ªæ™®é€šçš„æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶çš„ç‰¹æ®Šä¹‹å¤„åœ¨äºï¼Œå®ƒçš„å†…å®¹éµå¾ªä¸€ç§å›ºå®šæ ¼å¼ï¼Œå³ä¸€ä¸ªç›®å½•é¡¹æ•°ç»„ã€‚\n1 2 3 4 5 6 // ä¸€ä¸ªç®€å•çš„ç›®å½•é¡¹ (dentry) ç»“æ„ struct dentry { char filename[256]; // æ–‡ä»¶å unsigned int start_block; // æ–‡ä»¶æ•°æ®èµ·å§‹å—çš„ç¼–å· unsigned int size; // æ–‡ä»¶å¤§å° (ä»¥å­—èŠ‚ä¸ºå•ä½) }; å½“æˆ‘ä»¬éœ€è¦æ‰“å¼€ä¸€ä¸ªç›®å½•æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿåªéœ€è¯»å–è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶å°†å…¶è§£æä¸ºä¸€ä¸ª struct dentry æ•°ç»„å³å¯ã€‚\næ–‡ä»¶æ•°æ®çš„å­˜å‚¨\nç”¨é“¾è¡¨æ¥ç»„ç»‡ä¸€ä¸ªæ–‡ä»¶çš„æ‰€æœ‰æ•°æ®å—ï¼Œä¸»è¦æœ‰ä¸¤ç§å®ç°æ€è·¯ã€‚\næ–¹æ³•ä¸€ï¼šåœ¨æ¯ä¸ªæ•°æ®å—åæ”¾ç½®æŒ‡é’ˆ\nè¿™ç§æ–¹æ³•éå¸¸ç›´è§‚ã€‚æ¯ä¸ªæ•°æ®å—çš„æœ«å°¾éƒ½ç•™å‡ºä¸€å°å—ç©ºé—´ï¼Œç”¨äºå­˜æ”¾ä¸‹ä¸€ä¸ªæ•°æ®å—çš„åœ°å€æˆ–ç¼–å·ã€‚\nä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œé€»è¾‘æ¸…æ™°ã€‚\nç¼ºç‚¹ï¼š\næå·®çš„éšæœºè®¿é—®æ€§èƒ½ï¼šè¦è®¿é—®æ–‡ä»¶çš„ç¬¬ N ä¸ªæ•°æ®å—ï¼Œå¿…é¡»ä»ç¬¬ä¸€ä¸ªå—å¼€å§‹ï¼Œä¾æ¬¡è¯»å…¥å‰ N-1 ä¸ªå—æ¥æ‰¾åˆ°ç¬¬ N å—çš„æŒ‡é’ˆã€‚è¿™éœ€è¦ N-1 æ¬¡ç£ç›˜ I/Oï¼Œå¯¹äºå¤§æ–‡ä»¶è€Œè¨€æ˜¯æ¯ç­æ€§çš„ã€‚\nç©ºé—´æµªè´¹ï¼šæ¯ä¸ªæ•°æ®å—éƒ½ä¸èƒ½è¢« 100% ç”¨æ¥å­˜å‚¨æ–‡ä»¶å†…å®¹ï¼Œå¿…é¡»ç‰ºç‰²ä¸€éƒ¨åˆ†ç©ºé—´ç»™æŒ‡é’ˆã€‚\næ–¹æ³•äºŒï¼šå°†æŒ‡é’ˆé›†ä¸­å­˜æ”¾åœ¨æ–‡ä»¶ç³»ç»Ÿçš„æŸä¸ªåŒºåŸŸ\nä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰æ•°æ®å—çš„â€œé“¾è¡¨æŒ‡é’ˆâ€æŠ½ç¦»å‡ºæ¥ï¼Œé›†ä¸­å­˜æ”¾åœ¨ä¸€ä¸ªè¢«ç§°ä¸ºæ–‡ä»¶åˆ†é…è¡¨ (File Allocation Table, FAT) çš„æ ¸å¿ƒæ•°æ®ç»“æ„ä¸­ã€‚\nFAT æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¤§æ•°ç»„ã€‚æ•°ç»„çš„ä¸‹æ ‡ä¸ç£ç›˜ä¸Šçš„æ•°æ®å—ç¼–å·ä¸€ä¸€å¯¹åº”ã€‚æ•°ç»„ä¸­å­˜å‚¨çš„å€¼åˆ™æ˜¯è¯¥æ–‡ä»¶é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªæ•°æ®å—çš„ç¼–å·ã€‚\nå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ\nä¸€ä¸ªæ–‡ä»¶çš„èµ·å§‹å—å·è®°å½•åœ¨å®ƒçš„ç›®å½•é¡¹ (dentry) ä¸­ã€‚\nå‡è®¾æ–‡ä»¶ä»ç¬¬ 100 å·å—å¼€å§‹ï¼Œæˆ‘ä»¬æŸ¥è¯¢ FAT[100]ï¼Œå¦‚æœå€¼ä¸º 105ï¼Œé‚£ä¹ˆ 105 å·å—å°±æ˜¯æ–‡ä»¶çš„ç¬¬äºŒä¸ªæ•°æ®å—ã€‚\næ¥ç€æˆ‘ä»¬æŸ¥è¯¢ FAT[105]ï¼Œå¾—åˆ°ä¸‹ä¸€ä¸ªå—å·ï¼Œå¦‚æ­¤å¾€å¤ï¼Œç›´åˆ°é‡åˆ°ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ç»“å°¾æ ‡è®°ã€‚\nä¼˜ç‚¹ï¼š\nå¤§å¹…æ”¹å–„çš„éšæœºè®¿é—®ï¼šè™½ç„¶ä»ç„¶éœ€è¦éå†é“¾è¡¨ï¼Œä½†è¿™ä¸ªéå†è¿‡ç¨‹å‘ç”Ÿåœ¨ FAT è¡¨å†…éƒ¨ã€‚å› ä¸º FAT è¡¨ç›¸æ¯”æ•´ä¸ªç£ç›˜è¦å°å¾—å¤šï¼Œå¯ä»¥è¢«å®Œæ•´åŠ è½½åˆ°å†…å­˜ä¸­ç¼“å­˜ã€‚è¦è®¿é—®ç¬¬ N ä¸ªæ•°æ®å—ï¼Œåªéœ€è¦åœ¨å†…å­˜ä¸­è¿›è¡Œ N-1 æ¬¡æ•°ç»„æŸ¥è¯¢ï¼Œè¿™æ¯” N-1 æ¬¡ç£ç›˜ I/O å¿«äº†å‡ ä¸ªæ•°é‡çº§ã€‚\næ•°æ®å—çº¯å‡€ï¼šæ•°æ®å—å¯ä»¥ 100% ç”¨äºå­˜å‚¨æ–‡ä»¶å†…å®¹ï¼Œæ²¡æœ‰å…ƒæ•°æ®æ··å…¥ã€‚\nå†™å›ç­–ç•¥ï¼šå¯¹æ–‡ä»¶ç»“æ„çš„ä¿®æ”¹ï¼ˆå¦‚æ–°å¢/åˆ é™¤æ•°æ®å—ï¼‰å¯ä»¥å…ˆåœ¨å†…å­˜ä¸­çš„ FAT ç¼“å­˜ä¸Šè¿›è¡Œï¼Œç„¶ååˆ©ç”¨å»¶è¿Ÿå†™å› (Write-back Caching) æœºåˆ¶ï¼Œåœ¨ç¨åçš„æŸä¸ªæ—¶åˆ»ä¸€æ¬¡æ€§å°†æ›´æ–°åçš„ FAT è¡¨å†™å›ç£ç›˜ï¼Œåˆå¹¶äº†å¤šæ¬¡ I/O æ“ä½œï¼Œæå‡äº†æ€§èƒ½ã€‚\nUnix æ–‡ä»¶ç³»ç»Ÿ FAT æ–‡ä»¶ç³»ç»Ÿè™½ç„¶å·§å¦™ï¼Œä½†ä»æœ‰å…¶å±€é™æ€§ï¼Œæ— æ³•æ»¡è¶³ç°ä»£æ“ä½œç³»ç»Ÿçš„å¤æ‚éœ€æ±‚ï¼š\næ”¯æŒé“¾æ¥ï¼šæˆ‘ä»¬å¸Œæœ›å¤šä¸ªæ–‡ä»¶åå¯ä»¥æŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶å®ä½“ã€‚\næ”¯æŒé«˜æ•ˆçš„ä»»æ„å¤§å°æ–‡ä»¶éšæœºè®¿é—®ï¼šå¯¹äºéå¸¸å¤§çš„æ–‡ä»¶ï¼Œåœ¨ FAT è¡¨ä¸­çº¿æ€§æ‰«æä»ç„¶è€—æ—¶ã€‚æˆ‘ä»¬éœ€è¦ä¸€ç§èƒ½å®ç° O(1) æˆ– O(logN) å¤æ‚åº¦æŸ¥æ‰¾çš„æ•°æ®ç»“æ„ã€‚\nä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼ŒUnix æ–‡ä»¶ç³»ç»Ÿå¼•å…¥äº†ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼šinode (ç´¢å¼•èŠ‚ç‚¹)ã€‚\ninode æ˜¯ä¸€ä¸ªç‹¬ç«‹äºæ–‡ä»¶åçš„å…ƒæ•°æ®ç»“æ„ï¼Œå®ƒå­˜å‚¨äº†é™¤æ–‡ä»¶åä¹‹å¤–çš„ã€å…³äºä¸€ä¸ªæ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š\næ–‡ä»¶æ¨¡å¼ï¼ˆæƒé™ä½ï¼‰ æ‰€æœ‰è€…å’Œç”¨æˆ·ç»„ ID æ–‡ä»¶å¤§å° æ—¶é—´æˆ³ï¼ˆåˆ›å»ºã€ä¿®æ”¹ã€è®¿é—®æ—¶é—´ï¼‰ ç”¨äºç´¢å¼•æ–‡ä»¶æ•°æ®å—çš„æ•°æ®ç»“æ„ inode çš„å¼•å…¥å°†æ–‡ä»¶åå’Œæ–‡ä»¶å…ƒæ•°æ®å½»åº•åˆ†ç¦»ã€‚ç›®å½•é¡¹ (dentry) çš„ä½œç”¨è¢«ç®€åŒ–ä¸ºåªç»´æŠ¤ æ–‡ä»¶å -\u0026gt; inode ç¼–å· çš„æ˜ å°„å…³ç³»ã€‚è¿™å¤©ç„¶åœ°æ”¯æŒäº†ç¡¬é“¾æ¥ (Hard Link)ï¼šå¤šä¸ªä¸åŒçš„ç›®å½•é¡¹å¯ä»¥åŒ…å«ç›¸åŒçš„ inode ç¼–å·ï¼ŒæŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶å®ä½“ã€‚\nä¸ºäº†è§£å†³é«˜æ•ˆéšæœºè®¿é—®é—®é¢˜ï¼Œext2 æ–‡ä»¶ç³»ç»Ÿçš„ inode é‡‡ç”¨äº†ä¸€ç§éå¸¸ç»å…¸çš„å¤šçº§ç´¢å¼•ç»“æ„ï¼š\n1 2 3 4 5 6 7 8 // ext2 inode ç»“æ„ç¤ºæ„ struct ext2_inode { // ... å…¶ä»–å…ƒæ•°æ® ... unsigned int direct_blocks[12]; // 12ä¸ªç›´æ¥æŒ‡é’ˆ unsigned int singly_indirect_block; // 1ä¸ªä¸€çº§é—´æ¥æŒ‡é’ˆ unsigned int doubly_indirect_block; // 1ä¸ªäºŒçº§é—´æ¥æŒ‡é’ˆ unsigned int triply_indirect_block; // 1ä¸ªä¸‰çº§é—´æ¥æŒ‡é’ˆ }; ç›´æ¥æŒ‡é’ˆ (Direct Pointers)ï¼š inode ä¸­ç›´æ¥åŒ…å« 12 ä¸ªæŒ‡é’ˆï¼Œæ¯ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªæ•°æ®å—ã€‚å¯¹äºå°æ–‡ä»¶ï¼ˆå°äº 12 ä¸ªå—ï¼‰ï¼Œåªéœ€è¯»å– inode å°±å¯ä»¥è·å¾—æ‰€æœ‰æ•°æ®å—çš„ä½ç½®ï¼Œè®¿é—®é€Ÿåº¦æå¿«ã€‚\nä¸€çº§é—´æ¥æŒ‡é’ˆ (Singly Indirect Pointer)ï¼š å¦‚æœæ–‡ä»¶å¤§äº 12 ä¸ªå—ï¼Œæ–‡ä»¶ç³»ç»Ÿä¼šå¯ç”¨è¿™ä¸ªæŒ‡é’ˆã€‚å®ƒæŒ‡å‘ä¸€ä¸ªâ€œæŒ‡é’ˆå—â€ï¼Œè¿™ä¸ªå—é‡Œä¸å­˜æ•°æ®ï¼Œè€Œæ˜¯å­˜æ»¡äº†æŒ‡å‘æ•°æ®å—çš„æŒ‡é’ˆã€‚å‡è®¾ä¸€ä¸ªå—èƒ½å­˜ 1024 ä¸ªæŒ‡é’ˆï¼Œè¿™ä¸€çº§å°±èƒ½å¤šç´¢å¼• 1024 ä¸ªæ•°æ®å—ã€‚\näºŒçº§/ä¸‰çº§é—´æ¥æŒ‡é’ˆ (Doubly/Triply Indirect Pointers)ï¼š ä»¥æ­¤ç±»æ¨ï¼ŒäºŒçº§é—´æ¥æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå­˜å‚¨ç€ä¸€çº§é—´æ¥æŒ‡é’ˆå—åœ°å€çš„å—ã€‚è¿™ç§æ ‘çŠ¶çš„ç´¢å¼•ç»“æ„ï¼Œä»…éœ€æå°‘çš„å‡ æ¬¡ç£ç›˜è¯»å–ï¼ˆæœ€å¤š 4 æ¬¡ï¼Œinode -\u0026gt; ä¸‰çº§ -\u0026gt; äºŒçº§ -\u0026gt; ä¸€çº§ -\u0026gt; æ•°æ®å—ï¼‰ï¼Œå°±èƒ½å®šä½è¶…å¤§æ–‡ä»¶ä¸­ä»»æ„ä¸€ä¸ªæ•°æ®å—çš„ä½ç½®ï¼Œå®ç°äº†çœŸæ­£é«˜æ•ˆçš„éšæœºè®¿é—® (Random Access)ã€‚\nå­˜å‚¨å™¨ä¸Šçš„æ•°æ®ç»“æ„ ä¼ ç»Ÿä¸Šï¼Œæ–‡ä»¶ç³»ç»Ÿçš„æ‰€æœ‰é€»è¾‘éƒ½å®ç°åœ¨æ“ä½œç³»ç»Ÿçš„å†…æ ¸ (Kernel) ä¸­ï¼Œå› ä¸ºå®ƒéœ€è¦ç›´æ¥ç®¡ç†ç¡¬ä»¶å¹¶ä¿è¯ç³»ç»Ÿå®‰å…¨ä¸æ€§èƒ½ã€‚\nç„¶è€Œï¼Œç°ä»£æ“ä½œç³»ç»Ÿæä¾›äº†ä¸€äº›æœºåˆ¶ï¼Œå…è®¸åœ¨ç”¨æˆ·ç©ºé—´ (User Space) å®ç°æ–‡ä»¶ç³»ç»Ÿï¼Œæœ€è‘—åçš„å°±æ˜¯ FUSE (Filesystem in Userspace)ã€‚\nFUSE çš„å·¥ä½œåŸç†æ˜¯ï¼Œå†…æ ¸æä¾›ä¸€ä¸ªé€šç”¨çš„æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ï¼Œå½“æœ‰æ–‡ä»¶æ“ä½œè¯·æ±‚æ—¶ï¼Œè¯¥é©±åŠ¨ä¼šå°†è¯·æ±‚è½¬å‘ç»™ä¸€ä¸ªåœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œçš„å®ˆæŠ¤è¿›ç¨‹ã€‚è¿™ä¸ªè¿›ç¨‹è´Ÿè´£å®ç°æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿé€»è¾‘ï¼ˆå¦‚ä½•è§£æè·¯å¾„ã€è¯»å–æ•°æ®ç­‰ï¼‰ï¼Œç„¶åå°†ç»“æœè¿”å›ç»™å†…æ ¸ã€‚\nä¼˜ç‚¹ï¼šå¼€å‘ã€è°ƒè¯•å’Œæµ‹è¯•å˜å¾—æä¸ºæ–¹ä¾¿ï¼Œæ— éœ€ä¿®æ”¹å’Œé‡æ–°ç¼–è¯‘å†…æ ¸ã€‚ä¸€ä¸ªç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿçš„å´©æºƒä¹Ÿä¸ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚è¿™å‚¬ç”Ÿäº†å¤§é‡åˆ›æ–°çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¦‚ sshfsï¼ˆå°†è¿œç¨‹æœåŠ¡å™¨ç›®å½•æŒ‚è½½åˆ°æœ¬åœ°ï¼‰ã€s3fsï¼ˆå°†äº‘å­˜å‚¨æŒ‚è½½åˆ°æœ¬åœ°ï¼‰ç­‰ã€‚\nç¼ºç‚¹ï¼šæ¯æ¬¡æ–‡ä»¶æ“ä½œéƒ½éœ€è¦åœ¨å†…æ ¸æ€å’Œç”¨æˆ·æ€ä¹‹é—´è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ (Context Switch)ï¼Œå¸¦æ¥äº†é¢å¤–çš„æ€§èƒ½å¼€é”€ï¼Œé€šå¸¸ä¸é€‚ç”¨äºå¯¹æ€§èƒ½è¦æ±‚æè‡´çš„åœºæ™¯ã€‚\n","permalink":"https://diefish1024.github.io/posts/class-notes/nju-os-2025/23-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AE%9E%E7%8E%B0/","summary":"\u003ch2 id=\"file-allocation-table\"\u003eFile Allocation Table\u003c/h2\u003e\n\u003cp\u003eè¦è®¾è®¡å¹¶å®ç°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å…³æ³¨å¹¶è§£å†³å­˜å‚¨åª’ä»‹å¸¦æ¥çš„ä¸¤å¤§æ ¸å¿ƒæŒ‘æˆ˜ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eè¯»å†™æ”¾å¤§ (Read/Write Amplification)\u003c/strong\u003eï¼šç°ä»£å­˜å‚¨è®¾å¤‡ï¼ˆæ— è®ºæ˜¯æœºæ¢°ç¡¬ç›˜è¿˜æ˜¯å›ºæ€ç¡¬ç›˜ï¼‰çš„ç‰©ç†ç‰¹æ€§å†³å®šäº†ï¼Œå®ƒä»¬æœ€é«˜æ•ˆçš„è¯»å†™æ–¹å¼æ˜¯æ“ä½œè¿ç»­çš„å¤§å—æ•°æ®åŒºåŸŸï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºä¸€ä¸ª\u003cstrong\u003eå— (Block)\u003c/strong\u003eã€‚å¦‚æœéœ€è¦ä¿®æ”¹ä¸€ä¸ªå—ä¸­å“ªæ€•ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œä¹Ÿå¿…é¡»å°†æ•´ä¸ªå—è¯»å…¥å†…å­˜ã€ä¿®æ”¹ã€å†å®Œæ•´å†™å›ã€‚è¿™ç§â€œæ“ä½œå°‘é‡æ•°æ®å´å¯¼è‡´æ•´å—æ•°æ®è¢«è¯»å†™â€çš„ç°è±¡å°±æ˜¯è¯»å†™æ”¾å¤§ï¼Œå®ƒä¼šä¸¥é‡å½±å“æ€§èƒ½ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå±€éƒ¨æ€§ (Locality)\u003c/strong\u003eï¼šç¨‹åºçš„å†…å­˜è®¿é—®è¡Œä¸ºé€šå¸¸å…·æœ‰\u003cstrong\u003eå±€éƒ¨æ€§åŸç† (Principle of Locality)\u003c/strong\u003eï¼Œå³åœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œè®¿é—®çš„åœ°å€ä¼šé›†ä¸­åœ¨æŸä¸ªåŒºåŸŸã€‚æ–‡ä»¶ç³»ç»Ÿå¯ä»¥é€šè¿‡åˆç†çš„æ•°æ®æ’å¸ƒï¼Œè®©ç‰©ç†ä¸Šç›¸é‚»çš„æ•°æ®å—åœ¨é€»è¾‘ä¸Šä¹Ÿç›¸å…³è”ï¼ˆä¾‹å¦‚ï¼Œå±äºåŒä¸€ä¸ªæ–‡ä»¶ï¼‰ï¼Œä»è€Œåœ¨è¯»å–ä¸€å—æ•°æ®æ—¶ï¼Œå¯ä»¥åˆ©ç”¨é¢„è¯»æœºåˆ¶å°†åç»­å¯èƒ½è¢«è®¿é—®çš„æ•°æ®ä¹ŸåŠ è½½åˆ°å†…å­˜ç¼“å­˜ä¸­ï¼Œæé«˜æ•ˆç‡ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"åœ¨è½¯ç›˜ä¸Šå®ç°æ–‡ä»¶ç³»ç»Ÿ\"\u003eåœ¨è½¯ç›˜ä¸Šå®ç°æ–‡ä»¶ç³»ç»Ÿ\u003c/h3\u003e\n\u003cp\u003eæˆ‘ä»¬çš„éœ€æ±‚æ˜¯ä¸ºä¸€ä¸ªå­˜å‚¨å®¹é‡å¾ˆå°çš„è®¾å¤‡ï¼ˆå¦‚è½¯ç›˜ï¼‰è®¾è®¡ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œä½¿ç”¨å¤æ‚çš„æ ‘å½¢æ•°æ®ç»“æ„ï¼ˆå¦‚ B+ æ ‘ï¼‰ä¼šå› ä¸ºå…ƒæ•°æ®æœ¬èº«å ç”¨è¿‡å¤šç©ºé—´è€Œæ˜¾å¾—æµªè´¹ã€‚å› æ­¤ï¼Œä¸€ä¸ªç®€å•çš„é“¾å¼ç»“æ„æ˜¯æ›´åˆé€‚çš„é€‰æ‹©ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eç›®å½•çš„å®ç°\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eåœ¨ç®€å•çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œç›®å½•æœ¬èº«å¯ä»¥è¢«å®ç°ä¸ºä¸€ä¸ªæ™®é€šçš„æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶çš„ç‰¹æ®Šä¹‹å¤„åœ¨äºï¼Œå®ƒçš„å†…å®¹éµå¾ªä¸€ç§å›ºå®šæ ¼å¼ï¼Œå³ä¸€ä¸ªç›®å½•é¡¹æ•°ç»„ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// ä¸€ä¸ªç®€å•çš„ç›®å½•é¡¹ (dentry) ç»“æ„\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003edentry\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003efilename\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// æ–‡ä»¶å\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003estart_block\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// æ–‡ä»¶æ•°æ®èµ·å§‹å—çš„ç¼–å·\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e         \u003cspan class=\"c1\"\u003e// æ–‡ä»¶å¤§å° (ä»¥å­—èŠ‚ä¸ºå•ä½)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eå½“æˆ‘ä»¬éœ€è¦æ‰“å¼€ä¸€ä¸ªç›®å½•æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿåªéœ€è¯»å–è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶å°†å…¶è§£æä¸ºä¸€ä¸ª \u003ccode\u003estruct dentry\u003c/code\u003e æ•°ç»„å³å¯ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæ–‡ä»¶æ•°æ®çš„å­˜å‚¨\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eç”¨é“¾è¡¨æ¥ç»„ç»‡ä¸€ä¸ªæ–‡ä»¶çš„æ‰€æœ‰æ•°æ®å—ï¼Œä¸»è¦æœ‰ä¸¤ç§å®ç°æ€è·¯ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eæ–¹æ³•ä¸€ï¼šåœ¨æ¯ä¸ªæ•°æ®å—åæ”¾ç½®æŒ‡é’ˆ\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eè¿™ç§æ–¹æ³•éå¸¸ç›´è§‚ã€‚æ¯ä¸ªæ•°æ®å—çš„æœ«å°¾éƒ½ç•™å‡ºä¸€å°å—ç©ºé—´ï¼Œç”¨äºå­˜æ”¾ä¸‹ä¸€ä¸ªæ•°æ®å—çš„åœ°å€æˆ–ç¼–å·ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eä¼˜ç‚¹\u003c/strong\u003eï¼šå®ç°ç®€å•ï¼Œé€»è¾‘æ¸…æ™°ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eç¼ºç‚¹\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eæå·®çš„éšæœºè®¿é—®æ€§èƒ½\u003c/strong\u003eï¼šè¦è®¿é—®æ–‡ä»¶çš„ç¬¬ N ä¸ªæ•°æ®å—ï¼Œå¿…é¡»ä»ç¬¬ä¸€ä¸ªå—å¼€å§‹ï¼Œä¾æ¬¡è¯»å…¥å‰ N-1 ä¸ªå—æ¥æ‰¾åˆ°ç¬¬ N å—çš„æŒ‡é’ˆã€‚è¿™éœ€è¦ N-1 æ¬¡ç£ç›˜ I/Oï¼Œå¯¹äºå¤§æ–‡ä»¶è€Œè¨€æ˜¯æ¯ç­æ€§çš„ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eç©ºé—´æµªè´¹\u003c/strong\u003eï¼šæ¯ä¸ªæ•°æ®å—éƒ½ä¸èƒ½è¢« 100% ç”¨æ¥å­˜å‚¨æ–‡ä»¶å†…å®¹ï¼Œå¿…é¡»ç‰ºç‰²ä¸€éƒ¨åˆ†ç©ºé—´ç»™æŒ‡é’ˆã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eæ–¹æ³•äºŒï¼šå°†æŒ‡é’ˆé›†ä¸­å­˜æ”¾åœ¨æ–‡ä»¶ç³»ç»Ÿçš„æŸä¸ªåŒºåŸŸ\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰æ•°æ®å—çš„â€œé“¾è¡¨æŒ‡é’ˆâ€æŠ½ç¦»å‡ºæ¥ï¼Œé›†ä¸­å­˜æ”¾åœ¨ä¸€ä¸ªè¢«ç§°ä¸º\u003cstrong\u003eæ–‡ä»¶åˆ†é…è¡¨ (File Allocation Table, FAT)\u003c/strong\u003e çš„æ ¸å¿ƒæ•°æ®ç»“æ„ä¸­ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eFAT\u003c/strong\u003e æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¤§æ•°ç»„ã€‚æ•°ç»„çš„\u003cstrong\u003eä¸‹æ ‡\u003c/strong\u003eä¸ç£ç›˜ä¸Šçš„æ•°æ®å—ç¼–å·ä¸€ä¸€å¯¹åº”ã€‚æ•°ç»„ä¸­å­˜å‚¨çš„\u003cstrong\u003eå€¼\u003c/strong\u003eåˆ™æ˜¯è¯¥æ–‡ä»¶é“¾è¡¨ä¸­çš„\u003cstrong\u003eä¸‹ä¸€ä¸ªæ•°æ®å—çš„ç¼–å·\u003c/strong\u003eã€‚\u003c/p\u003e","title":"23. æ–‡ä»¶ç³»ç»Ÿçš„å®ç°"},{"content":"1. Why Memory Performance Matters in HPC? åœ¨ HPC é¢†åŸŸï¼Œæˆ‘ä»¬å¸¸å¸¸å…³æ³¨ CPU çš„æµ®ç‚¹è¿ç®—èƒ½åŠ› (FLOPS)ï¼Œä½†çœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆå¾€å¾€ä¸åœ¨äºè®¡ç®—æœ¬èº«ï¼Œè€Œåœ¨äºæ•°æ®è®¿é—®ã€‚ç°ä»£ CPU çš„è®¡ç®—é€Ÿåº¦è¿œè¶…äºå†…å­˜çš„è®¿é—®é€Ÿåº¦ï¼Œè¿™ç§å·®è·è¢«ç§°ä¸ºå†…å­˜å¢™ (Memory Wall)ã€‚ç¨‹åºçš„å¤§éƒ¨åˆ†æ—¶é—´å¯èƒ½éƒ½æ¶ˆè€—åœ¨ç­‰å¾…æ•°æ®ä»å†…å­˜åŠ è½½åˆ° CPU å¯„å­˜å™¨çš„è¿‡ç¨‹ä¸­ã€‚å› æ­¤ï¼Œä¼˜åŒ–å†…å­˜è®¿é—®æ¨¡å¼ï¼Œæœ€å¤§é™åº¦åœ°åˆ©ç”¨ Cacheï¼Œæ˜¯æå‡ C/C++ ç¨‹åºæ€§èƒ½è‡³å…³é‡è¦çš„ä¸€ç¯ã€‚\n2. Memory Alignment å†…å­˜å¯¹é½æ˜¯æŒ‡ä¸€ä¸ªæ•°æ®å¯¹è±¡çš„å†…å­˜åœ°å€æ˜¯å…¶è‡ªèº«å¤§å°æˆ–ç‰¹å®šå­—èŠ‚æ•°ï¼ˆé€šå¸¸æ˜¯ 2 çš„å¹‚ï¼‰çš„æ•´æ•°å€ã€‚ä¾‹å¦‚ä¸€ä¸ª 4 å­—èŠ‚çš„ int ç±»å‹å˜é‡ï¼Œå¦‚æœå…¶å†…å­˜åœ°å€æ˜¯ 4 çš„å€æ•°ï¼ˆå¦‚ 0x...00, 0x...04, 0x...08ï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯å†…å­˜å¯¹é½çš„ã€‚\n2.2 Why is Alignment Important? CPU å¹¶ä¸æ˜¯é€å­—èŠ‚åœ°ä»å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œè€Œæ˜¯ä»¥å—ï¼ˆé€šå¸¸æ˜¯ç¼“å­˜è¡Œ (Cache Line)ï¼Œä¾‹å¦‚ 64 å­—èŠ‚ï¼‰ä¸ºå•ä½è¿›è¡Œè¯»å–ã€‚\næ€§èƒ½æå‡ï¼šå¦‚æœä¸€ä¸ªæ•°æ®è·¨è¶Šäº†ä¸¤ä¸ªç¼“å­˜è¡Œï¼ŒCPU å°±éœ€è¦æ‰§è¡Œä¸¤æ¬¡å†…å­˜è¯»å–æ“ä½œæ‰èƒ½è·å–è¿™ä¸€ä¸ªæ•°æ®ï¼Œè¿™ä¼šæµªè´¹ä¸€å€çš„æ—¶é—´ã€‚å¦‚æœæ•°æ®æ˜¯å¯¹é½çš„ï¼Œå°±å¯ä»¥ä¿è¯å®ƒå®Œæ•´åœ°è½åœ¨ä¸€ä¸ªç¼“å­˜è¡Œå†…ï¼ŒCPU åªéœ€ä¸€æ¬¡è¯»å–æ“ä½œã€‚\nç¡¬ä»¶è¦æ±‚ï¼šè®¸å¤šç°ä»£ CPU æŒ‡ä»¤é›†ï¼Œå°¤å…¶æ˜¯ç”¨äºå¹¶è¡Œè®¡ç®—çš„ SIMD æŒ‡ä»¤å¼ºåˆ¶è¦æ±‚æ“ä½œçš„æ•°æ®å¿…é¡»æ˜¯å†…å­˜å¯¹é½çš„ï¼Œå¯¹æœªå¯¹é½çš„æ•°æ®æ‰§è¡Œè¿™äº›æŒ‡ä»¤å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå´©æºƒæˆ–æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚\n2.3 How to Achieve Alignment in C/C++? C++11 alignasï¼šè¿™æ˜¯ Modern C++ çš„æ ‡å‡†æ–¹å¼ï¼Œå¯ä»¥æŒ‡å®šå˜é‡æˆ–ç±»å‹çš„å¯¹é½è¦æ±‚ã€‚ 1 2 3 4 5 6 7 8 // å£°æ˜ä¸€ä¸ªæŒ‰ 64 å­—èŠ‚å¯¹é½çš„æ•°ç»„ alignas(64) float aligned_array[1024]; // å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œä½¿å…¶æ¯ä¸ªå®ä¾‹éƒ½æŒ‰ 32 å­—èŠ‚å¯¹é½ struct alignas(32) MyData { float a; int b; }; GCC/Clang __attribute__((aligned(N)))ï¼šç‰¹å®šäºç¼–è¯‘å™¨çš„æ‰©å±•ã€‚ 1 2 // å£°æ˜ä¸€ä¸ªæŒ‰ 64 å­—èŠ‚å¯¹é½çš„æ•°ç»„ float aligned_array[1024] __attribute__((aligned(64))); åŠ¨æ€å†…å­˜å¯¹é½ï¼šæ ‡å‡†çš„ malloc ä¸ä¿è¯ç‰¹å®šçš„å¯¹é½æ–¹å¼ï¼ˆé€šå¸¸åªä¿è¯åŸºæœ¬ç±»å‹çš„å¯¹é½ï¼‰ã€‚éœ€è¦ä½¿ç”¨ä¸“ç”¨å‡½æ•°ã€‚ 1 2 3 4 5 6 #include \u0026lt;stdlib.h\u0026gt; // C11 æ ‡å‡† // åˆ†é… 1024 ä¸ª floatï¼Œå¹¶æŒ‰ 64 å­—èŠ‚å¯¹é½ float* dynamic_array = (float*)aligned_alloc(64, 1024 * sizeof(float)); free(dynamic_array); // å¿…é¡»ç”¨ free é‡Šæ”¾ 3. Data Locality æ•°æ®å±€éƒ¨æ€§æ˜¯ç¼“å­˜å·¥ä½œçš„åŸºæœ¬åŸç†ï¼Œä¹Ÿæ˜¯æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒã€‚æè¿°äº† CPU è®¿é—®å†…å­˜åœ°å€çš„é›†ä¸­ç¨‹åº¦ã€‚\n3.1 Temporal and Spatial Locality æ—¶é—´å±€éƒ¨æ€§ (Temporal Locality)ï¼šå¦‚æœä¸€ä¸ªæ•°æ®é¡¹è¢«è®¿é—®ï¼Œé‚£ä¹ˆåœ¨ä¸ä¹…çš„å°†æ¥å®ƒå¾ˆå¯èƒ½å†æ¬¡è¢«è®¿é—®ã€‚\nç©ºé—´å±€éƒ¨æ€§ (Spatial Locality)ï¼šå¦‚æœä¸€ä¸ªæ•°æ®é¡¹è¢«è®¿é—®ï¼Œé‚£ä¹ˆä¸å®ƒåœ°å€ç›¸è¿‘çš„æ•°æ®é¡¹å¾ˆå¯èƒ½åœ¨ä¸ä¹…çš„å°†æ¥è¢«è®¿é—®ã€‚\nå½“ CPU è®¿é—®ä¸€ä¸ªå†…å­˜åœ°å€æ—¶ï¼Œå®ƒä¼šå°†åŒ…å«è¯¥åœ°å€çš„æ•´ä¸ªç¼“å­˜è¡ŒåŠ è½½åˆ°ç¼“å­˜ä¸­ã€‚å……åˆ†åˆ©ç”¨è¿™ä¸¤ä¸ªå±€éƒ¨æ€§åŸåˆ™ï¼Œå¯ä»¥æå¤§åœ°æé«˜ç¼“å­˜å‘½ä¸­ç‡ (Cache Hit Rate)ï¼Œå‡å°‘è®¿é—®ä¸»å†…å­˜çš„æ¬¡æ•°ã€‚\n3.2 Optimizing Storage Layout æ•°æ®åœ¨å†…å­˜ä¸­çš„å¸ƒå±€æ–¹å¼ç›´æ¥å½±å“ç©ºé—´å±€éƒ¨æ€§ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§é‡å¯¹è±¡æ—¶ã€‚\nAoS (Array of Structures)ï¼šç»“æ„ä½“æ•°ç»„ã€‚è¿™æ˜¯æœ€ç›´è§‚çš„å­˜å‚¨æ–¹å¼ã€‚ 1 2 3 4 struct Point { float x, y, z; }; Point points[N]; å†…å­˜å¸ƒå±€ï¼š[x0, y0, z0, x1, y1, z1, ...]\nåœ¨è¿™ç§å¸ƒå±€ä¸‹å½“æˆ‘ä»¬æƒ³è¦è®¿é—®ä¸€ä¸ªç‚¹çš„åæ ‡æ—¶ç©ºé—´å±€éƒ¨æ€§è¾ƒå¥½ï¼›ç„¶åç›¸å¯¹æ‰€æœ‰ç‚¹çš„ x åæ ‡è¿›è¡Œæ“ä½œæ—¶ï¼Œy å’Œ z ä¹Ÿä¼šè¢«ä¸€åŒåŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œæ±¡æŸ“äº†ç¼“å­˜ï¼Œé€ æˆæ€§èƒ½æµªè´¹ã€‚\nSoA (Structure of Arrays)ï¼šæ•°ç»„ç»“æ„ä½“ã€‚ 1 2 3 4 5 6 struct Points { float x[N]; float y[N]; float z[N]; }; Points points; å†…å­˜å¸ƒå±€ï¼š[x0, x1, ..., xN-1, y0, y1, ..., yN-1, ...]\nåœ¨è¿™ç§å¸ƒå±€ä¸‹å½“æˆ‘ä»¬éœ€è¦å¯¹æ‰€æœ‰ç‚¹çš„ x åæ ‡è¿›è¡Œæ“ä½œæ—¶ï¼Œå› ä¸ºæ‰€æœ‰ x çš„æ•°æ®åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­çš„ï¼Œç©ºé—´å±€éƒ¨æ€§å¥½ï¼Œæœ‰åˆ©äº SIMD å‘é‡åŒ–ï¼›ç„¶è€Œå½“éœ€è¦è®¿é—®ä¸€ä¸ªç‚¹çš„æ‰€æœ‰åæ ‡æ—¶ï¼Œéœ€è¦ä¸‰æ¬¡å†…å­˜è®¿é—®ï¼Œå¯¼è‡´å±€éƒ¨æ€§è¾ƒå·®ã€‚\nåœ¨ HPC ä¸­ï¼Œå¤§é‡çš„è®¡ç®—é€šå¸¸æ˜¯é’ˆå¯¹æŸä¸€ç‰¹å®šå±æ€§çš„ï¼Œå› æ­¤ SoA å¸ƒå±€å¾€å¾€èƒ½å¸¦æ¥æ›´å¥½çš„æ€§èƒ½ï¼Œå°¤å…¶æ˜¯åœ¨éœ€è¦å‘é‡åŒ–ä¼˜åŒ–æ—¶ã€‚\n3.3 Optimizing Access Patterns ä¸€æ—¦æ•°æ®åœ¨å†…å­˜ä¸­å®Œæˆå¸ƒå±€ï¼Œç¨‹åºè®¿é—®å®ƒçš„é¡ºåºå°±æˆä¸ºå½±å“æ€§èƒ½çš„ä¸‹ä¸€ä¸ªå…³é”®å› ç´ ã€‚ä»¥ç¬¦åˆå…¶å­˜å‚¨é¡ºåºå¹¶æœ€å¤§åŒ–ç¼“å­˜åˆ©ç”¨ç‡çš„æ–¹å¼è®¿é—®æ•°æ®ï¼Œæ˜¯æŒ–æ˜æ•°æ®å±€éƒ¨æ€§æ½œåŠ›çš„åŸºç¡€ã€‚\néå†é¡ºåº (Row-Major Order) C/C++ ä¸­çš„å¤šç»´æ•°ç»„é»˜è®¤æ˜¯è¡Œä¸»åº (Row-Major) å­˜å‚¨çš„ã€‚è¿™æ„å‘³ç€äºŒç»´æ•°ç»„ A[M][N] åœ¨å†…å­˜ä¸­æ˜¯æŒ‰è¡Œè¿ç»­å­˜æ”¾çš„ã€‚\nå†…å­˜å¸ƒå±€: A[0][0], A[0][1], ..., A[0][N-1], A[1][0], ...\nä¸ºäº†ä¿è¯æœ€ä½³çš„ç©ºé—´å±€éƒ¨æ€§ï¼Œå†…å±‚å¾ªç¯åº”è¯¥éå†æœ€å³è¾¹çš„ç´¢å¼•ã€‚\né«˜æ•ˆçš„è®¿é—®æ–¹å¼ (cache-firendly)ï¼š 1 2 3 4 5 for (int i = 0; i \u0026lt; M; i++) { for (int j = 0; j \u0026lt; N; j++) { A[i][j] = ...; // è®¿é—®æ¨¡å¼ä¸å­˜å‚¨æ¨¡å¼ä¸€è‡´ï¼Œé¡ºåºè®¿é—® } } ä½æ•ˆçš„è®¿é—®æ–¹å¼ (cache-disaster)ï¼š 1 2 3 4 5 for (int j = 0; j \u0026lt; N; j++) { for (int i = 0; i \u0026lt; M; i++) { A[i][j] = ...; // è·¨è¡Œè·³è·ƒè®¿é—®ï¼Œæ¯æ¬¡è®¿é—®éƒ½å¯èƒ½å¯¼è‡´ç¼“å­˜æœªå‘½ä¸­ } } å¾ªç¯åˆ†å— (Loop Tiling / Blocking)\nå¯¹äºå¤§å‹çŸ©é˜µè¿ç®—ï¼ˆå¦‚çŸ©é˜µä¹˜æ³•ï¼‰ï¼Œå³ä½¿è®¿é—®é¡ºåºæ­£ç¡®ï¼Œæ•°æ®é‡å¤ªå¤§ä¹Ÿæ— æ³•å…¨éƒ¨è£…å…¥ç¼“å­˜ã€‚å¾ªç¯åˆ†å—æ˜¯ä¸€ç§å°†è®¡ç®—åˆ†è§£ä¸ºé€‚åˆç¼“å­˜å¤§å°çš„å­é—®é¢˜çš„æ–¹æ³•ï¼Œå¯ä»¥åŒæ—¶æå‡æ—¶é—´å’Œç©ºé—´å±€éƒ¨æ€§ã€‚\næœªä¼˜åŒ–çš„çŸ©é˜µä¹˜æ³•ï¼š 1 2 3 4 5 6 7 8 for (int i = 0; i \u0026lt; N; i++) { for (int j = 0; j \u0026lt; N; j++) { for (int k = 0; k \u0026lt; N; k++) { C[i][j] += A[i][k] * B[k][j]; } } } // B[k][j] çš„è®¿é—®æ˜¯åˆ—è®¿é—®ï¼Œæ•ˆç‡ä½ä¸‹ã€‚ ä½¿ç”¨å¾ªç¯åˆ†å—ä¼˜åŒ–ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 int block_size = 16; // å—å¤§å°éœ€æ ¹æ®ç¼“å­˜å¤§å°è°ƒæ•´ for (int i0 = 0; i0 \u0026lt; N; i0 += block_size) { for (int j0 = 0; j0 \u0026lt; N; j0 += block_size) { for (int k0 = 0; k0 \u0026lt; N; k0 += block_size) { // åœ¨ç¼“å­˜ä¸­è®¡ç®—ä¸€ä¸ªå­çŸ©é˜µå— for (int i = i0; i \u0026lt; i0 + block_size; i++) { for (int j = j0; j \u0026lt; j0 + block_size; j++) { for (int k = k0; k \u0026lt; k0 + block_size; k++) { C[i][j] += A[i][k] * B[k][j]; } } } } } } é€šè¿‡åˆ†å—ï¼Œç¨‹åºå¯ä»¥æŠŠä¸€å°å—æ•°æ®åŠ è½½åˆ°ç¼“å­˜ä¸­å¹¶å……åˆ†å¤ç”¨ï¼Œç„¶åå†å¤„ç†ä¸‹ä¸€å—ï¼Œå¤§å¤§æé«˜äº†ç¼“å­˜å‘½ä¸­ç‡ã€‚\n4. False Sharing in Parallel Computing åœ¨å¤šæ ¸å¹¶è¡Œç¼–ç¨‹ï¼ˆå¦‚ OpenMP, pthreadsï¼‰ä¸­ï¼Œä¸€ä¸ªéå¸¸éšè”½çš„æ€§èƒ½æ€æ‰‹æ˜¯ä¼ªå…±äº«ã€‚\nåŸç†ï¼šç¼“å­˜ä¸ä»…ä»…åœ¨ CPU å’Œä¸»å­˜ä¹‹é—´å·¥ä½œï¼Œè¿˜åœ¨å¤šä¸ªæ ¸å¿ƒä¹‹é—´ä¿æŒæ•°æ®ä¸€è‡´æ€§ (Coherence)ã€‚å½“ä¸€ä¸ªæ ¸å¿ƒä¿®æ”¹äº†å…¶ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œè¯¥ç¼“å­˜è¡Œä¼šè¢«æ ‡è®°ä¸ºâ€œdirtyâ€ï¼Œä¸€è‡´æ€§åè®®ä¼šä½¿å…¶ä»–æ ¸å¿ƒä¸­ç›¸åŒçš„ç¼“å­˜è¡Œå¤±æ•ˆã€‚\nä¼ªå…±äº«ï¼šå¦‚æœä¸¤ä¸ªæ ¸å¿ƒä¸Šçš„çº¿ç¨‹é¢‘ç¹ä¿®æ”¹ä¸åŒçš„å˜é‡ï¼Œä½†è¿™äº›å˜é‡ç¢°å·§ä½äºåŒä¸€ä¸ªç¼“å­˜è¡Œä¸­ï¼Œé‚£ä¹ˆæ¯æ¬¡ä¿®æ”¹éƒ½ä¼šå¯¼è‡´å¯¹æ–¹çš„ç¼“å­˜è¡Œå¤±æ•ˆå¹¶éœ€è¦é‡æ–°ä»ä¸»å­˜åŠ è½½ã€‚è¿™ç§ç”±ä¸ç›¸å…³çš„å˜é‡å…±äº«åŒä¸€ä¸ªç¼“å­˜è¡Œè€Œå¯¼è‡´çš„æ€§èƒ½ä¸‹é™ï¼Œå°±æ˜¯ä¼ªå…±äº«ã€‚\n1 2 3 4 5 6 7 8 int results[NUM_THREADS]; // å‡è®¾ NUM_THREADS=2 #pragma omp parallel { int tid = omp_get_thread_num(); results[tid] = some_calculation(); } // å¦‚æœ results[0] å’Œ results[1] åœ¨åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œ // çº¿ç¨‹ 0 ä¿®æ”¹ results[0] ä¼šä½¿çº¿ç¨‹ 1 çš„ç¼“å­˜è¡Œå¤±æ•ˆï¼Œåä¹‹äº¦ç„¶ã€‚ è§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨è¿›è¡Œå†…å­˜å¡«å…… (Padding)ï¼Œç¡®ä¿æ¯ä¸ªçº¿ç¨‹æ“ä½œçš„æ•°æ®ä½äºä¸åŒçš„ç¼“å­˜è¡Œã€‚ 1 2 3 4 5 struct PaddedResult { int value; char padding[64 - sizeof(int)]; // å‡è®¾ç¼“å­˜è¡Œå¤§å°ä¸º 64 å­—èŠ‚ }; PaddedResult results[NUM_THREADS]; Summary å†…å­˜å¯¹é½æ˜¯åˆ©ç”¨ç¡¬ä»¶ç‰¹æ€§çš„åŸºç¡€ï¼Œç¡®ä¿å•æ¬¡æ“ä½œçš„æ•ˆç‡å’Œ SIMD çš„å¯è¡Œæ€§ã€‚\næ•°æ®å±€éƒ¨æ€§æ˜¯æ ¸å¿ƒä¼˜åŒ–æ€æƒ³ï¼Œé€šè¿‡ä¼˜åŒ–å­˜å‚¨å¸ƒå±€ (AoS vs SoA) å’Œè®¿é—®æ¨¡å¼ (éå†é¡ºåºã€å¾ªç¯åˆ†å—) æ¥æœ€å¤§åŒ–ç¼“å­˜åˆ©ç”¨ç‡ã€‚\nåœ¨å¹¶è¡Œç¯å¢ƒä¸­ï¼Œå¿…é¡»è­¦æƒ•ä¼ªå…±äº«ç­‰é™·é˜±ï¼Œé€šè¿‡åˆç†çš„å†…å­˜å¸ƒå±€é¿å…å¤šæ ¸é—´çš„æ€§èƒ½å¹²æ‰°ã€‚\nReferences HPC ä¸­çš„ C/C++ - HPC å…¥é—¨æŒ‡å— ","permalink":"https://diefish1024.github.io/posts/hpc/hpc-%E4%B8%AD%E7%9A%84-c-%E5%92%8C-c/","summary":"\u003ch2 id=\"1-why-memory-performance-matters-in-hpc\"\u003e1. Why Memory Performance Matters in HPC?\u003c/h2\u003e\n\u003cp\u003eåœ¨ HPC é¢†åŸŸï¼Œæˆ‘ä»¬å¸¸å¸¸å…³æ³¨ CPU çš„æµ®ç‚¹è¿ç®—èƒ½åŠ› (FLOPS)ï¼Œä½†çœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆå¾€å¾€ä¸åœ¨äºè®¡ç®—æœ¬èº«ï¼Œè€Œåœ¨äº\u003cstrong\u003eæ•°æ®è®¿é—®\u003c/strong\u003eã€‚ç°ä»£ CPU çš„è®¡ç®—é€Ÿåº¦è¿œè¶…äºå†…å­˜çš„è®¿é—®é€Ÿåº¦ï¼Œè¿™ç§å·®è·è¢«ç§°ä¸º\u003cstrong\u003eå†…å­˜å¢™ (Memory Wall)\u003c/strong\u003eã€‚ç¨‹åºçš„å¤§éƒ¨åˆ†æ—¶é—´å¯èƒ½éƒ½æ¶ˆè€—åœ¨ç­‰å¾…æ•°æ®ä»å†…å­˜åŠ è½½åˆ° CPU å¯„å­˜å™¨çš„è¿‡ç¨‹ä¸­ã€‚å› æ­¤ï¼Œä¼˜åŒ–å†…å­˜è®¿é—®æ¨¡å¼ï¼Œæœ€å¤§é™åº¦åœ°åˆ©ç”¨ Cacheï¼Œæ˜¯æå‡ C/C++ ç¨‹åºæ€§èƒ½è‡³å…³é‡è¦çš„ä¸€ç¯ã€‚\u003c/p\u003e\n\u003ch2 id=\"2-memory-alignment\"\u003e2. Memory Alignment\u003c/h2\u003e\n\u003cp\u003eå†…å­˜å¯¹é½æ˜¯æŒ‡ä¸€ä¸ªæ•°æ®å¯¹è±¡çš„å†…å­˜åœ°å€æ˜¯å…¶è‡ªèº«å¤§å°æˆ–ç‰¹å®šå­—èŠ‚æ•°ï¼ˆé€šå¸¸æ˜¯ 2 çš„å¹‚ï¼‰çš„æ•´æ•°å€ã€‚ä¾‹å¦‚ä¸€ä¸ª 4 å­—èŠ‚çš„ \u003ccode\u003eint\u003c/code\u003e ç±»å‹å˜é‡ï¼Œå¦‚æœå…¶å†…å­˜åœ°å€æ˜¯ 4 çš„å€æ•°ï¼ˆå¦‚ \u003ccode\u003e0x...00\u003c/code\u003e, \u003ccode\u003e0x...04\u003c/code\u003e, \u003ccode\u003e0x...08\u003c/code\u003eï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯å†…å­˜å¯¹é½çš„ã€‚\u003c/p\u003e\n\u003ch3 id=\"22-why-is-alignment-important\"\u003e2.2 Why is Alignment Important?\u003c/h3\u003e\n\u003cp\u003eCPU å¹¶ä¸æ˜¯é€å­—èŠ‚åœ°ä»å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œè€Œæ˜¯ä»¥å—ï¼ˆé€šå¸¸æ˜¯\u003cstrong\u003eç¼“å­˜è¡Œ (Cache Line)\u003c/strong\u003eï¼Œä¾‹å¦‚ 64 å­—èŠ‚ï¼‰ä¸ºå•ä½è¿›è¡Œè¯»å–ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eæ€§èƒ½æå‡\u003c/strong\u003eï¼šå¦‚æœä¸€ä¸ªæ•°æ®è·¨è¶Šäº†ä¸¤ä¸ªç¼“å­˜è¡Œï¼ŒCPU å°±éœ€è¦æ‰§è¡Œä¸¤æ¬¡å†…å­˜è¯»å–æ“ä½œæ‰èƒ½è·å–è¿™ä¸€ä¸ªæ•°æ®ï¼Œè¿™ä¼šæµªè´¹ä¸€å€çš„æ—¶é—´ã€‚å¦‚æœæ•°æ®æ˜¯å¯¹é½çš„ï¼Œå°±å¯ä»¥ä¿è¯å®ƒå®Œæ•´åœ°è½åœ¨ä¸€ä¸ªç¼“å­˜è¡Œå†…ï¼ŒCPU åªéœ€ä¸€æ¬¡è¯»å–æ“ä½œã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eç¡¬ä»¶è¦æ±‚\u003c/strong\u003eï¼šè®¸å¤šç°ä»£ CPU æŒ‡ä»¤é›†ï¼Œå°¤å…¶æ˜¯ç”¨äºå¹¶è¡Œè®¡ç®—çš„ \u003cstrong\u003eSIMD\u003c/strong\u003e æŒ‡ä»¤å¼ºåˆ¶è¦æ±‚æ“ä½œçš„æ•°æ®å¿…é¡»æ˜¯å†…å­˜å¯¹é½çš„ï¼Œå¯¹æœªå¯¹é½çš„æ•°æ®æ‰§è¡Œè¿™äº›æŒ‡ä»¤å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå´©æºƒæˆ–æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"23-how-to-achieve-alignment-in-cc\"\u003e2.3 How to Achieve Alignment in C/C++?\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eC++11 \u003ccode\u003ealignas\u003c/code\u003e\u003c/strong\u003eï¼šè¿™æ˜¯ Modern C++ çš„æ ‡å‡†æ–¹å¼ï¼Œå¯ä»¥æŒ‡å®šå˜é‡æˆ–ç±»å‹çš„å¯¹é½è¦æ±‚ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c++\" data-lang=\"c++\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// å£°æ˜ä¸€ä¸ªæŒ‰ 64 å­—èŠ‚å¯¹é½çš„æ•°ç»„\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003ealignas\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e64\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ealigned_array\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œä½¿å…¶æ¯ä¸ªå®ä¾‹éƒ½æŒ‰ 32 å­—èŠ‚å¯¹é½\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nf\"\u003ealignas\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e32\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eMyData\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eGCC/Clang \u003ccode\u003e__attribute__((aligned(N)))\u003c/code\u003e\u003c/strong\u003eï¼šç‰¹å®šäºç¼–è¯‘å™¨çš„æ‰©å±•ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// å£°æ˜ä¸€ä¸ªæŒ‰ 64 å­—èŠ‚å¯¹é½çš„æ•°ç»„\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e \u003cspan class=\"n\"\u003ealigned_array\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"nf\"\u003e__attribute__\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"nf\"\u003ealigned\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e64\u003c/span\u003e\u003cspan class=\"p\"\u003e)));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eåŠ¨æ€å†…å­˜å¯¹é½\u003c/strong\u003eï¼šæ ‡å‡†çš„ \u003ccode\u003emalloc\u003c/code\u003e ä¸ä¿è¯ç‰¹å®šçš„å¯¹é½æ–¹å¼ï¼ˆé€šå¸¸åªä¿è¯åŸºæœ¬ç±»å‹çš„å¯¹é½ï¼‰ã€‚éœ€è¦ä½¿ç”¨ä¸“ç”¨å‡½æ•°ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;stdlib.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// C11 æ ‡å‡†\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// åˆ†é… 1024 ä¸ª floatï¼Œå¹¶æŒ‰ 64 å­—èŠ‚å¯¹é½\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003edynamic_array\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"nf\"\u003ealigned_alloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e64\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1024\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003efloat\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nf\"\u003efree\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edynamic_array\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// å¿…é¡»ç”¨ free é‡Šæ”¾\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"3-data-locality\"\u003e3. Data Locality\u003c/h2\u003e\n\u003cp\u003eæ•°æ®å±€éƒ¨æ€§æ˜¯ç¼“å­˜å·¥ä½œçš„åŸºæœ¬åŸç†ï¼Œä¹Ÿæ˜¯æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒã€‚æè¿°äº† CPU è®¿é—®å†…å­˜åœ°å€çš„é›†ä¸­ç¨‹åº¦ã€‚\u003c/p\u003e","title":"HPC ä¸­çš„ C å’Œ C++"},{"content":"Abstract ç°æœ‰ TTA æ–¹æ³•åœ¨å¤„ç†å›¾æ•°æ®æ—¶ï¼Œå¯¹èŠ‚ç‚¹å±æ€§åç§»æœ‰æ•ˆï¼Œä½†æ˜¯å¯¹å›¾ç»“æ„åç§»ï¼ˆåŒè´¨æ€§ã€èŠ‚ç‚¹åº¦çš„å˜åŒ–ï¼‰æ•ˆæœå¾ˆå·®ã€‚åŸå› æ˜¯ç»“æ„åç§»ä¼šä¸¥é‡ç ´åèŠ‚ç‚¹è¡¨ç¤ºçš„è´¨é‡ï¼Œä½¿ä¸åŒç±»åˆ«çš„èŠ‚ç‚¹åœ¨ç‰¹å¾ç©ºé—´ä¸­æ··åœ¨ä¸€èµ·ã€‚ä¸ºæ­¤è®ºæ–‡æå‡ºäº† Matcha æ¡†æ¶ï¼Œé€šè¿‡åœ¨æµ‹è¯•çš„æ—¶å€™è‡ªé€‚åº”åœ°è°ƒæ•´ GNN çš„â€œè·³æ•°èšåˆå‚æ•° (hop-aggregation parameters)â€ï¼Œå¹¶ä¸”å¼•å…¥äº†æ–°çš„é¢„æµ‹æ„ŸçŸ¥çš„èšç±»æŸå¤±å‡½æ•°æ¥è¡¨ç¤ºæ¢å¤èŠ‚ç‚¹è¡¨ç¤ºçš„è´¨é‡ï¼Œä»è€Œæœ‰æ•ˆåº”å¯¹ç»“æ„åç§»ï¼Œå¹¶èƒ½å’Œç°æœ‰ TTA æ–¹æ³•ç›¸ç»“åˆï¼Œè¿›ä¸€æ­¥æé«˜æ€§èƒ½ã€‚\nIntroduction GNN çš„è„†å¼±æ€§ï¼šGNNs åœ¨å„ç±»å›¾ä»»åŠ¡ä¸Šçš„è¡¨ç°ä¾èµ–äºè®­ç»ƒæ•°æ®å’Œæµ‹è¯•æ•°æ®åˆ†å¸ƒç›¸åŒçš„å‡è®¾ï¼Œç„¶è€Œåœ¨ç°å®ä¸–ç•Œä¸­ï¼Œå›¾çš„åˆ†å¸ƒå¸¸å¸¸ä¼šå‘ç”Ÿå˜åŒ–ï¼ˆåˆ†å¸ƒåç§»ï¼‰ï¼Œåˆ†ä¸ºï¼š\nå±æ€§åç§» (Attribute Shift)ï¼šèŠ‚ç‚¹çš„ç‰¹å¾å‘ç”Ÿå˜åŒ–ã€‚ä¾‹å¦‚ä¸åŒç¤¾äº¤å¹³å°ï¼Œå³ä½¿ç”¨æˆ·ä¸€æ ·ï¼Œå…¶è´¦å·çš„å†…å®¹ä¹Ÿä¼šå› ä¸ºå¹³å°å·®å¼‚è€Œä¸åŒã€‚\nç»“æ„åç§» (Structure Shift)ï¼šèŠ‚ç‚¹çš„è¿æ¥æ–¹å¼å‘ç”Ÿå˜åŒ–ã€‚æ¯”å¦‚å·¥ä½œå¹³å°ç”¨æˆ·å€¾å‘äºè¿æ¥åŒäº‹ï¼Œç”Ÿæ´»å¹³å°ç”¨æˆ·å€¾å‘äºè¿æ¥å®¶äººæœ‹å‹ã€‚è¿™ç§è¿æ¥æ¨¡å¼çš„å˜åŒ–å°±æ˜¯ç»“æ„åç§»ï¼Œå…·ä½“è¡¨ç°ä¸ºåŒè´¨æ€§ (Homophily) å’Œ èŠ‚ç‚¹åº¦ (Degree) çš„å˜åŒ–ã€‚\nTTA çš„å±€é™æ€§ï¼šTTA å…è®¸ä¸€ä¸ªé¢„è®­ç»ƒå¥½çš„æ¨¡å‹åœ¨ä¸è®¿é—®åŸå§‹è®­ç»ƒæ•°æ®çš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨æ— æ ‡ç­¾çš„æµ‹è¯•æ•°æ®è¿›è¡Œè‡ªé€‚åº”è°ƒæ•´ ã€‚ç›®å‰ TTA åœ¨è®¡ç®—æœºè§†è§‰é¢†åŸŸå¤„ç†å›¾åƒæŸåã€é£æ ¼å˜åŒ–ç­‰å±æ€§åç§»é—®é¢˜ä¸Šå¾ˆæˆåŠŸ ã€‚ç„¶è€Œä¸ºå›¾åƒå¤„ç†è®¾è®¡çš„ TTA æ–¹æ³•ç›´æ¥åº”ç”¨åˆ°å›¾ä¸Šæ—¶ï¼Œå…¶åœ¨å¤„ç†å›¾ç»“æ„åç§»æ—¶çš„æ€§èƒ½æå‡éå¸¸æœ‰é™ï¼Œå‡ ä¹å¤±æ•ˆã€‚\nAnalysis ä¸¤ç§åç§»æ–¹å¼å¯¹ GNN çš„å½±å“å­˜åœ¨æœ¬è´¨ä¸åŒã€‚\nPerliminaries è®ºæ–‡èšç„¦äº GTTA ä»»åŠ¡ã€‚ä¸€ä¸ª GNN æ¨¡å‹å¯ä»¥è¢«çœ‹æˆä¸¤ä¸ªéƒ¨åˆ†çš„ç»„åˆï¼Œä¸€ä¸ªç‰¹å¾æå–å™¨ $ f_{S} $ ï¼Œä¸€ä¸ªåˆ†ç±»å™¨ $ g_{S} $ ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªçº¿æ€§å±‚ã€‚\nä¸¤ç§åç§»çš„æ­£å¼å®šä¹‰ï¼š\nå±æ€§åç§»ï¼šæºå›¾å’Œç›®æ ‡å›¾ä¸­ï¼ŒèŠ‚ç‚¹çš„æ¡ä»¶æ¦‚ç‡åˆ†å¸ƒä¸åŒ $ \\mathbb{P}^{S}_{x | y} \\neq \\mathbb{P}^{T}_{x | y} $ ã€‚ ç»“æ„åç§»ï¼šå›¾çš„é‚»æ¥çŸ©é˜µå’Œæ ‡ç­¾çš„è”åˆåˆ†å¸ƒä¸åŒï¼Œå³ $ \\mathbb{P}^{S}_{A \\times Y} \\neq \\mathbb{P}^{T}_{A \\times Y} $ ã€‚è®ºæ–‡ä¸»è¦å…³æ³¨ä¸¤ç§å…·ä½“çš„ç»“æ„åç§»ï¼š åº¦åç§»ï¼šæºå›¾å’Œç›®æ ‡å›¾çš„å¹³å‡èŠ‚ç‚¹åº¦æ•°ä¸åŒã€‚ åŒè´¨æ€§åç§»ï¼šæºå›¾å’Œç›®æ ‡å›¾çš„åŒè´¨æ€§æ°´å¹³ä¸åŒã€‚å…¶ä¸­å›¾çš„æ‰€æœ‰èŠ‚ç‚¹åŒè´¨æ€§çš„å¹³å‡å€¼ $ h(\\mathcal{G}) = \\dfrac{1}{N}\\sum_{i}h_{i} $ ï¼Œå•ä¸ªèŠ‚ç‚¹ $ v_{i} $ çš„åŒè´¨æ€§è®¡ç®—å…¬å¼ä¸ºï¼š $$ h_{i} = \\dfrac{\\left| \\{ v_{j} \\in \\mathbb{N}(v_{i}): y_{j} = y_{i} \\} \\right|}{d_{i}} $$ å…¶ä¸­ $ y $ è¡¨ç¤ºèŠ‚ç‚¹æ ‡ç­¾ï¼Œ$ d $ è¡¨ç¤ºèŠ‚ç‚¹åº¦æ•°ã€‚ Impact of Distribution Shifts é€šè¿‡æ•°å­¦å»ºæ¨¡æ¥æ˜¾ç¤ºä¸¤ç§åç§»çš„ä¸åŒå½±å“æœºåˆ¶ã€‚\nåˆ†æå·¥å…·\nCSBM (ä¸Šä¸‹æ–‡éšæœºå—æ¨¡å‹)ï¼šå¹¿æ³›ç”¨äº GNN åˆ†æçš„éšæœºå›¾ç”Ÿæˆå™¨ã€‚å‚æ•° $ \\mu_{+},\\mu_{-} $ ç¼–ç èŠ‚ç‚¹å±æ€§ï¼Œè€Œ $ d,h $ å‚æ•°ç¼–ç å›¾çš„ç»“æ„ã€‚\nå•å±‚ GCNï¼šä¸ºäº†ç®€åŒ–åˆ†æï¼Œä½¿ç”¨äº†ä¸€ä¸ªå•å±‚çš„ GCN æ¨¡å‹ï¼Œå…¶èŠ‚ç‚¹è¡¨ç¤º $ z_{i} $ çš„è®¡ç®—å…¬å¼ä¸ºï¼š $$ z_{i} = x_{i} + \\gamma \\cdot \\dfrac{1}{d_{i}} \\sum_{v_{j} \\in \\mathbb{N}(v_{i})}x_{j} $$ å…¶ä¸­ $ \\gamma $ æ˜¯ä¸€ä¸ªå…³é”®çš„è·³æ•°èšåˆå‚æ•°ï¼Œæ§åˆ¶èŠ‚ç‚¹è‡ªèº«ç‰¹å¾å’Œé‚»å±…å¹³å‡ç‰¹å¾çš„æ··åˆæ¯”ä¾‹ã€‚\næ¨è®º 3.1\nåœ¨ CSBM å›¾ä¸Šï¼Œä¸€ä¸ªèŠ‚ç‚¹çš„æœ€ç»ˆè¡¨ç¤º $ z_{i} $ æœä»ä¸€ä¸ªæ­£æ€åˆ†å¸ƒï¼Œå…¶å‡å€¼å–å†³äºèŠ‚ç‚¹çš„çœŸå®ç±»åˆ«ã€å›¾çš„åŒè´¨æ€§ $ h_{i} $ ä»¥åŠ $ \\gamma $ å‚æ•°ï¼Œè€Œæ–¹å·®å–å†³äºèŠ‚ç‚¹åº¦æ•° $ d_{i} $ å’Œ $ \\gamma $ å‚æ•° $$ z_{i} \\sim \\mathcal{N}\\left( (1 + \\gamma h_{i})\\mu_{+} + \\gamma(1-h_{i})\\mu_{-}, \\left( 1 + \\dfrac{\\gamma^{2}}{d_{i}} \\right)I \\right) $$\næ¨è®º 3.2\nåŸºäº 3.1 ç›´æ¥ç»™å‡ºäº†æ¨¡å‹é¢„æœŸå‡†ç¡®ç‡çš„å…¬å¼ $$ \\text{Acc} = \\varPhi\\left( \\sqrt{ \\dfrac{d}{d+\\gamma^{2}} } \\cdot \\left| 1 + \\gamma(2h - 1) \\right| \\cdot \\| \\mu \\|_{2} \\right) $$ æ ¹æ®è¿™ä¸ªå…¬å¼ï¼Œåªéœ€è¦è¾“å…¥å›¾çš„åº¦æ•°ï¼ŒåŒè´¨æ€§å’Œ $ \\gamma $ å‚æ•°å°±èƒ½ç›´æ¥è®¡ç®—å‡ºæ¨¡å‹çš„ç†è®ºæœ€é«˜å‡†ç¡®ç‡ï¼Œä»è€Œè®©å®šé‡åˆ†ææˆä¸ºå¯èƒ½ã€‚\nå‡†ç¡®ç‡å·®è·åˆ†è§£\nè®ºæ–‡æŒ‡å‡ºå½“æ¨¡å‹æ€§èƒ½ä¸‹é™æ—¶ï¼Œå¯èƒ½çš„åŸå› æœ‰ä¸¤ç§ï¼š\nè¡¨ç¤ºé€€åŒ– $ \\Delta_{f} $ï¼šGNN çš„ç‰¹å¾æå–å™¨å‡ºç°äº†é—®é¢˜ï¼Œå…¶ç”Ÿæˆçš„èŠ‚ç‚¹è¡¨ç¤ºæœ¬èº«è´¨é‡å°±å¾ˆå·®ï¼Œæ— æ³•åŒºåˆ†ä¸åŒç±»å‹çš„èŠ‚ç‚¹ã€‚\nåˆ†ç±»å™¨åç§» $ \\Delta_{g} $ï¼šæŒ‡ç‰¹å¾æå–å™¨æœ¬èº«æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯åˆ†ç±»å™¨å‡ºç°äº†é—®é¢˜ã€‚\nå‘½é¢˜ 3.3 (å±æ€§åç§»çš„å½±å“)\nç†è®ºè¯æ˜ï¼Œåœ¨å±æ€§åç§»ä¸‹ï¼Œæ€§èƒ½æŸå¤±å®Œå…¨æ¥è‡ªäºåˆ†ç±»å™¨åç§» $ \\Delta_{g} $ ï¼Œè€Œè¡¨ç¤ºé€€åŒ– $ \\Delta_{f} $ ä¸ºé›¶ ã€‚ $$ \\Delta_{f} = 0, \\Delta_{g} = \\Theta (\\| \\Delta \\mu \\| _{2}^{2}) $$\nè¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆç°æœ‰çš„ TTA æ–¹æ³•ï¼ˆä¸»è¦è°ƒæ•´åˆ†ç±»å™¨ï¼‰åœ¨å¤„ç†å±æ€§åç§»æ—¶æœ‰æ•ˆ ã€‚\nå‘½é¢˜ 3.4 (ç»“æ„åç§»çš„å½±å“)\nç†è®ºè¯æ˜ï¼Œåœ¨ç»“æ„åç§»ä¸‹ï¼Œæƒ…å†µæ°æ°ç›¸å ã€‚æ€§èƒ½æŸå¤±å®Œå…¨æ¥è‡ªäºè¡¨ç¤ºé€€åŒ– $ \\Delta_{f} $ï¼Œè€Œåˆ†ç±»å™¨åç§» $ \\Delta_{g} $ ä¸ºé›¶ ã€‚ $$ \\Delta_{f} = \\Theta(\\Delta h + \\Delta g),\\Delta_{g} = 0 $$\nè¿™æ˜¯è®ºæ–‡çš„æ ¸å¿ƒå‘ç°ï¼Œæ­ç¤ºäº†ç°æœ‰ TTA æ–¹æ³•åœ¨ç»“æ„åç§»ä¸‹å¤±æ•ˆçš„æ ¹æœ¬åŸå› ï¼šå®ƒä»¬æ²¡æœ‰ä¿®å¤é—®é¢˜çš„æ ¹æºâ€”â€”å·²ç»é€€åŒ–äº†çš„èŠ‚ç‚¹è¡¨ç¤º ã€‚\nå‘½é¢˜ 3.5 (è°ƒæ•´è·³èšæ•°å‚æ•°)\næ—¢ç„¶ç»“æ„åç§»çš„ç—…æ ¹åœ¨äºè¡¨ç¤ºé€€åŒ–ï¼Œé‚£ä¹ˆæ²»ç–—æ–¹æ¡ˆå°±å¿…é¡»è°ƒæ•´ç‰¹å¾æå–å™¨ ã€‚\nè®ºæ–‡è¯æ˜è°ƒæ•´è·³æ•°èšåˆå‚æ•° $ \\gamma $ æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ–¹æ³•ï¼Œå¯ä»¥ç¼“è§£è¡¨ç¤ºé€€åŒ–é—®é¢˜ ã€‚\nå…¶å…³é”®åœ¨äºï¼Œæœ€ä¼˜çš„ $ \\gamma $ å€¼æœ¬èº«å°±ä¾èµ–äºå›¾çš„åº¦å’ŒåŒè´¨æ€§ $ \\gamma_{T} = d_{T}(2h_{T} - 1) $ã€‚å› æ­¤ï¼Œé€šè¿‡åœ¨æµ‹è¯•æ—¶å°† $ \\gamma $ è°ƒæ•´åˆ°é€‚åº”ç›®æ ‡å›¾çš„æ–°å€¼ï¼Œå°±å¯ä»¥æå‡æ¨¡å‹çš„å‡†ç¡®ç‡ ã€‚è¿™ä¸ºåç»­ Matcha æ¡†æ¶çš„æå‡ºæä¾›äº†ç†è®ºåŸºç¡€ã€‚\nAdapting Hop-Aggregation Parameters æ ¹æ®å‰é¢çš„åˆ†æï¼Œè§£å†³ç»“æ„åç§»çš„å½±å“å…³é”®åœ¨äºè°ƒæ•´ç‰¹å¾æå–å™¨ $ f_{S} $ æ¥æ¢å¤èŠ‚ç‚¹è¡¨ç¤ºçš„è´¨é‡ã€‚\nå‘½é¢˜ 3.5 (è°ƒæ•´ $ \\gamma $ çš„æœ‰æ•ˆæ€§)\nè®ºæ–‡è¿›ä¸€æ­¥è¯æ˜è°ƒæ•´è·³æ•°èšåˆå‚æ•° $ \\gamma $ æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ–¹æ³•ã€‚å‘½é¢˜æŒ‡å‡ºï¼Œæœ€ä¼˜çš„ $ \\gamma $ ä¾èµ–äºå›¾çš„åº¦å’ŒåŒè´¨æ€§ï¼ˆå³ $ \\gamma_{T}^{*} = d_{T}(2h_{T} - 1) $ ï¼‰ï¼Œå½“å›¾ä»æºå›¾å˜ä¸ºç›®æ ‡å›¾æ—¶ï¼Œæœ€ä¼˜çš„ $ \\gamma $ ä¹Ÿä¼šæ”¹å˜ã€‚å› æ­¤åœ¨æµ‹è¯•æ—¶æŠŠ $ \\gamma $ è°ƒæ•´åˆ°ç›®æ ‡å›¾çš„æœ€ä¼˜å€¼å°±å¯ä»¥æ˜¾è‘—ç¼“è§£è¡¨ç¤ºé€€åŒ–ï¼Œæå‡æ¨¡å‹å‡†ç¡®ç‡ã€‚\nProposed Framework åŸºäºä»¥ä¸Šæ´å¯Ÿï¼Œè®ºæ–‡è®¾è®¡äº† Matcha æ¡†æ¶ï¼Œæ—¨åœ¨è§£å†³ä¸¤ä¸ªæŒ‘æˆ˜ï¼š1. åœ¨æ²¡æœ‰æ ‡ç­¾çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•æ›´æ–°è·³æ•°èšåˆå‚æ•°ä»¥åº”å¯¹ç»“æ„åç§»ï¼Ÿ 2. å¦‚ä½•ç¡®ä¿ç®—æ³•ä¸ç°æœ‰çš„ TTA ç®—æ³•å…¼å®¹ï¼Œä»¥åŒæ—¶è§£å†³ç»“æ„å’Œå±æ€§åç§»ï¼Ÿ\nPrediction-Informed Clustering Loss ä¼ ç»Ÿçš„ TTA æ–¹æ³•ä¸»è¦é‡‡ç”¨ç†µï¼ˆentropyï¼‰ä½œä¸ºä»£ç†æŸå¤±å‡½æ•°ï¼Œä½†è®ºæ–‡å‘ç°ç†µæœ€å°åŒ–åœ¨æå‡è¡¨ç¤ºè´¨é‡æ–¹é¢æ•ˆæœæœ‰é™ï¼Œå› ä¸ºå®ƒå¯¹ logits çš„å°ºåº¦æ•æ„Ÿï¼Œå®¹æ˜“å¯¼è‡´å¹³å‡¡è§£ã€‚\nä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®ºæ–‡æå‡ºäº†ä¸€ç§æ–°é¢–çš„é¢„æµ‹æ„ŸçŸ¥èšç±»æŸå¤± (Prediction-Informed Clustering, PIC) æŸå¤±ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šä¸€ä¸ªå¥½çš„èŠ‚ç‚¹è¡¨ç¤ºåº”è¯¥ä½¿å¾—åŒç±»èŠ‚ç‚¹åœ¨ç‰¹å¾ç©ºé—´ä¸­ç´§å¯†èšé›†ï¼Œè€Œä¸åŒç±»èŠ‚ç‚¹åˆ™ç›¸äº’è¿œç¦»ã€‚\nå…¶è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š\nè®¡ç®—è´¨å¿ƒï¼šåˆ©ç”¨æ¨¡å‹å½“å‰çš„è½¯é¢„æµ‹ç»“æœ $ \\hat{Y} $ ä½œä¸ºâ€œä¼ªç±»åˆ«â€ä¿¡æ¯ï¼Œè®¡ç®—æ¯ä¸ªä¼ªç±»åˆ« $ c $ çš„è´¨å¿ƒ $ \\mu_c $ å’Œæ‰€æœ‰èŠ‚ç‚¹çš„æ€»è´¨å¿ƒ $ \\mu_* $ã€‚$$ \\mu_{c} = \\frac{\\sum_{i=1}^{N}\\hat{Y}_{i,c}z_{i}}{\\sum_{i=1}^{N}\\hat{Y}_{i,c}}, \\quad \\mu_{*} = \\frac{1}{N}\\sum_{i=1}^{N}z_{i} $$ è®¡ç®—æ–¹å·®ï¼šè®¡ç®—ç±»å†…æ–¹å·® $ \\sigma_{intra}^2 $ï¼ˆå¸Œæœ›å®ƒå°ï¼‰å’Œç±»é—´æ–¹å·® $ \\sigma_{inter}^2 $ï¼ˆå¸Œæœ›å®ƒå¤§ï¼‰ã€‚$$ \\sigma_{intra}^{2} = \\sum_{i=1}^{N}\\sum_{c=1}^{C}\\hat{Y}_{i,c}||z_{i}-\\mu_{c}||_{2}^{2} $$ $$ \\sigma_{inter}^{2} = \\sum_{c=1}^{C}(\\sum_{i=1}^{N}\\hat{Y}_{i,c})||\\mu_{c}-\\mu_{*}||_{2}^{2} $$ PIC æŸå¤±å‡½æ•°ï¼šæœ€ç»ˆçš„ PIC æŸå¤±è¢«å®šä¹‰ä¸ºç±»å†…æ–¹å·®å æ€»æ–¹å·®çš„æ¯”ä¾‹ã€‚$$ \\mathcal{L}_{PIC} = \\frac{\\sigma_{intra}^{2}}{\\sigma_{intra}^{2} + \\sigma_{inter}^{2}} $$ é€šè¿‡æœ€å°åŒ–è¿™ä¸ªæŸå¤±ï¼Œæ¨¡å‹ä¼šè°ƒæ•´ $ \\gamma $ æ¥ä¼˜åŒ–èŠ‚ç‚¹è¡¨ç¤º $ Z $ï¼Œä½¿å¾—ç±»å†…å°½å¯èƒ½ç´§å‡‘ï¼Œç±»é—´å°½å¯èƒ½åˆ†ç¦»ã€‚è¿™ç§æ¯”ç‡å½¢å¼å¯¹è¡¨ç¤ºçš„å°ºåº¦ä¸æ•æ„Ÿï¼Œå¯ä»¥æœ‰æ•ˆé¿å…å¹³å‡¡è§£ã€‚ Integration of Generic TTA Methods Matcha æ¡†æ¶å¯ä»¥å’Œä»»ä½•ç°æœ‰çš„ TTA æ–¹æ³•ï¼ˆè®ºæ–‡ä¸­ç§°ä¸º BaseTTAï¼‰æ— ç¼é›†æˆã€‚\nåº”ç”¨é€šç”¨ TTAï¼šä½¿ç”¨ BaseTTAï¼ˆå¦‚ Tent, T3Aï¼‰å¯¹å½“å‰æ¨¡å‹è¿›è¡Œè°ƒæ•´ï¼Œå¾—åˆ°ä¸€ä¸ªåˆæ­¥çš„è½¯é¢„æµ‹ $ \\hat{Y} $ ã€‚è¿™ä¸€æ­¥ä¸»è¦å¤„ç†å±æ€§åç§»ã€‚\næ›´æ–°è·³æ•°èšåˆå‚æ•°ï¼šå°† $ \\hat{Y} $ ä½œä¸ºä¼ªæ ‡ç­¾ï¼Œè®¡ç®— $ \\mathcal{L}_{PIC} $ æŸå¤±ï¼Œå¹¶æ ¹æ®è¯¥æŸå¤±çš„æ¢¯åº¦åªæ›´æ–°è·³æ•°èšåˆå‚æ•° $ \\gamma $ ã€‚è¿™ä¸€æ­¥ä¸“é—¨åº”å¯¹ç»“æ„åç§»ï¼Œä»¥æ¢å¤è¡¨ç¤ºè´¨é‡ã€‚\nè¿™ä¸ªè¿‡ç¨‹å½¢æˆäº†ä¸€ç§ååŒæ•ˆåº”ï¼šé€šè¿‡è°ƒæ•´ $ \\gamma $ å¾—åˆ°çš„æ›´å¥½è¡¨ç¤ºï¼Œä¸º BaseTTA æä¾›äº†æ›´é«˜è´¨é‡çš„è¾“å…¥ï¼Œä½¿å…¶èƒ½åšå‡ºæ›´å‡†çš„é¢„æµ‹ï¼›è€Œæ›´å‡†çš„é¢„æµ‹åˆä¸º $ \\mathcal{L}_{PIC} $ æä¾›äº†æ›´å¯é çš„ä¼ªæ ‡ç­¾ï¼Œä»è€Œæ›´å¥½åœ°æŒ‡å¯¼ $ \\gamma $ çš„æ›´æ–°ã€‚\nExperiments è®ºæ–‡åœ¨åˆæˆæ•°æ®é›†ï¼ˆCSBMï¼‰å’Œå¤šä¸ªçœŸå®ä¸–ç•Œæ•°æ®é›†ï¼ˆå¦‚ Syn-Cora, Syn-Products ç­‰ï¼‰ä¸Šè¿›è¡Œäº†å¹¿æ³›çš„å®éªŒï¼Œä»¥éªŒè¯ Matcha çš„æœ‰æ•ˆæ€§ã€‚\nMatcha Handles Various Structure Shifts ä¸»è¦ç»“æœï¼š\nä¸ä¸è¿›è¡Œè‡ªé€‚åº”çš„æ¨¡å‹ï¼ˆERMï¼‰ç›¸æ¯”ï¼Œå•ç‹¬ä½¿ç”¨ Matchaï¼ˆERM+Matchaï¼‰å¯ä»¥æ˜¾è‘—æå‡æ¨¡å‹æ€§èƒ½ï¼Œåœ¨çœŸå®ä¸–ç•Œæ•°æ®é›†ä¸Šæœ€é«˜æå‡ 31.95%ã€‚ ä¸å…¶ä»–åŸºçº¿æ–¹æ³•ç›¸æ¯”ï¼ŒMatcha åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å–å¾—äº†æœ€ä½³æ€§èƒ½ï¼Œæœ€é«˜è¶…å‡º 40.61%ã€‚ Matcha ä¸åŸºçº¿ TTA æ–¹æ³•ç»“åˆæ—¶ï¼Œèƒ½è¿›ä¸€æ­¥æå‡å®ƒä»¬çš„æ€§èƒ½ï¼Œæœ€é«˜å¯è¾¾ 22.72%ï¼ˆåˆæˆæ•°æ®ï¼‰å’Œ 39.31%ï¼ˆçœŸå®æ•°æ®ï¼‰ã€‚è¿™äº›ç»“æœæœ‰åŠ›åœ°è¯æ˜äº† Matcha çš„æœ‰æ•ˆæ€§ã€‚ Matcha Restores The Representation Quality é™¤äº†æ€§èƒ½æå‡ï¼Œè®ºæ–‡è¿˜é€šè¿‡ t-SNE å¯è§†åŒ–æ–¹æ³•ï¼ŒéªŒè¯äº† Matcha æ˜¯å¦æˆåŠŸæ¢å¤äº†èŠ‚ç‚¹è¡¨ç¤ºçš„è´¨é‡ã€‚\nåœ¨ç»“æ„åç§»ä¸‹ï¼ˆbï¼‰ï¼ŒåŸå§‹æ¨¡å‹çš„èŠ‚ç‚¹è¡¨ç¤ºå˜å¾—æ··ä¹±ä¸å ªã€‚åœ¨ä½¿ç”¨å…¶ä»–æŸå¤±å‡½æ•°ï¼ˆc, d, eï¼‰åï¼Œè¡¨ç¤ºè´¨é‡è™½æœ‰æ”¹å–„ä½†ä»ä¸ç†æƒ³ã€‚è€Œä½¿ç”¨ Matcha çš„ PIC æŸå¤±åï¼ˆfï¼‰ï¼ŒèŠ‚ç‚¹è¡¨ç¤ºé‡æ–°å½¢æˆäº†éå¸¸æ¸…æ™°çš„èšç±»ç»“æ„ï¼Œè¯æ˜å…¶æˆåŠŸæ¢å¤äº†è¡¨ç¤ºè´¨é‡ã€‚\nConclusion æœ¬æ–‡çš„è´¡çŒ®å¯ä»¥æ€»ç»“ä¸ºï¼š\nç†è®ºåˆ†æï¼šé¦–æ¬¡ä»ç†è®ºä¸Šæ­ç¤ºäº†å±æ€§åç§»å’Œç»“æ„åç§»å¯¹ GNN æœ‰ç€æˆªç„¶ä¸åŒçš„å½±å“æ¨¡å¼ï¼Œè§£é‡Šäº†ä¸ºä½•é€šç”¨ TTA æ–¹æ³•åœ¨ç»“æ„åç§»ä¸‹ä¼šå¤±æ•ˆã€‚ æå‡ºæ¡†æ¶ï¼šæå‡ºäº†ä¸€ä¸ªå³æ’å³ç”¨çš„ TTA æ¡†æ¶ Matchaï¼Œé€šè¿‡ä¸€ç§æ–°é¢–çš„é¢„æµ‹æ„ŸçŸ¥èšç±»æŸå¤±ï¼ˆPIC Lossï¼‰ æ¥æŒ‡å¯¼è·³æ•°èšåˆå‚æ•°çš„è‡ªé€‚åº”è°ƒæ•´ï¼Œä»è€Œæ¢å¤å› ç»“æ„åç§»è€Œé€€åŒ–çš„èŠ‚ç‚¹è¡¨ç¤ºè´¨é‡ã€‚ å®éªŒéªŒè¯ï¼šåœ¨å¤šç§æ•°æ®é›†å’Œåœºæ™¯ä¸‹çš„å¹¿æ³›å®éªŒï¼Œä¸€è‡´ä¸”æ˜¾è‘—åœ°è¯æ˜äº† Matcha æ¡†æ¶çš„æœ‰æ•ˆæ€§ã€é«˜æ•ˆæ€§å’Œé€šç”¨æ€§ã€‚ ","permalink":"https://diefish1024.github.io/posts/literature-notes/matcha/","summary":"\u003ch2 id=\"abstract\"\u003eAbstract\u003c/h2\u003e\n\u003cp\u003eç°æœ‰ TTA æ–¹æ³•åœ¨å¤„ç†å›¾æ•°æ®æ—¶ï¼Œå¯¹\u003cstrong\u003eèŠ‚ç‚¹å±æ€§åç§»\u003c/strong\u003eæœ‰æ•ˆï¼Œä½†æ˜¯å¯¹\u003cstrong\u003eå›¾ç»“æ„åç§»\u003c/strong\u003eï¼ˆåŒè´¨æ€§ã€èŠ‚ç‚¹åº¦çš„å˜åŒ–ï¼‰æ•ˆæœå¾ˆå·®ã€‚åŸå› æ˜¯\u003cstrong\u003eç»“æ„åç§»ä¼šä¸¥é‡ç ´åèŠ‚ç‚¹è¡¨ç¤ºçš„è´¨é‡\u003c/strong\u003eï¼Œä½¿ä¸åŒç±»åˆ«çš„èŠ‚ç‚¹åœ¨ç‰¹å¾ç©ºé—´ä¸­æ··åœ¨ä¸€èµ·ã€‚ä¸ºæ­¤è®ºæ–‡æå‡ºäº† Matcha æ¡†æ¶ï¼Œé€šè¿‡åœ¨æµ‹è¯•çš„æ—¶å€™\u003cstrong\u003eè‡ªé€‚åº”åœ°è°ƒæ•´ GNN çš„â€œè·³æ•°èšåˆå‚æ•° (hop-aggregation parameters)â€\u003c/strong\u003eï¼Œå¹¶ä¸”å¼•å…¥äº†æ–°çš„\u003cstrong\u003eé¢„æµ‹æ„ŸçŸ¥çš„èšç±»æŸå¤±å‡½æ•°\u003c/strong\u003eæ¥è¡¨ç¤ºæ¢å¤èŠ‚ç‚¹è¡¨ç¤ºçš„è´¨é‡ï¼Œä»è€Œæœ‰æ•ˆåº”å¯¹ç»“æ„åç§»ï¼Œå¹¶èƒ½å’Œç°æœ‰ TTA æ–¹æ³•ç›¸ç»“åˆï¼Œè¿›ä¸€æ­¥æé«˜æ€§èƒ½ã€‚\u003c/p\u003e\n\u003ch2 id=\"introduction\"\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eGNN çš„è„†å¼±æ€§\u003c/strong\u003eï¼šGNNs åœ¨å„ç±»å›¾ä»»åŠ¡ä¸Šçš„è¡¨ç°ä¾èµ–äºè®­ç»ƒæ•°æ®å’Œæµ‹è¯•æ•°æ®åˆ†å¸ƒç›¸åŒçš„å‡è®¾ï¼Œç„¶è€Œåœ¨ç°å®ä¸–ç•Œä¸­ï¼Œå›¾çš„åˆ†å¸ƒå¸¸å¸¸ä¼šå‘ç”Ÿå˜åŒ–ï¼ˆåˆ†å¸ƒåç§»ï¼‰ï¼Œåˆ†ä¸ºï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå±æ€§åç§» (Attribute Shift)\u003c/strong\u003eï¼šèŠ‚ç‚¹çš„ç‰¹å¾å‘ç”Ÿå˜åŒ–ã€‚ä¾‹å¦‚ä¸åŒç¤¾äº¤å¹³å°ï¼Œå³ä½¿ç”¨æˆ·ä¸€æ ·ï¼Œå…¶è´¦å·çš„å†…å®¹ä¹Ÿä¼šå› ä¸ºå¹³å°å·®å¼‚è€Œä¸åŒã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eç»“æ„åç§» (Structure Shift)\u003c/strong\u003eï¼šèŠ‚ç‚¹çš„è¿æ¥æ–¹å¼å‘ç”Ÿå˜åŒ–ã€‚æ¯”å¦‚å·¥ä½œå¹³å°ç”¨æˆ·å€¾å‘äºè¿æ¥åŒäº‹ï¼Œç”Ÿæ´»å¹³å°ç”¨æˆ·å€¾å‘äºè¿æ¥å®¶äººæœ‹å‹ã€‚è¿™ç§è¿æ¥æ¨¡å¼çš„å˜åŒ–å°±æ˜¯ç»“æ„åç§»ï¼Œå…·ä½“è¡¨ç°ä¸º\u003cstrong\u003eåŒè´¨æ€§ (Homophily)\u003c/strong\u003e å’Œ \u003cstrong\u003eèŠ‚ç‚¹åº¦ (Degree)\u003c/strong\u003e çš„å˜åŒ–ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eTTA çš„å±€é™æ€§\u003c/strong\u003eï¼šTTA å…è®¸ä¸€ä¸ªé¢„è®­ç»ƒå¥½çš„æ¨¡å‹åœ¨ä¸è®¿é—®åŸå§‹è®­ç»ƒæ•°æ®çš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨æ— æ ‡ç­¾çš„æµ‹è¯•æ•°æ®è¿›è¡Œè‡ªé€‚åº”è°ƒæ•´ ã€‚ç›®å‰ TTA åœ¨è®¡ç®—æœºè§†è§‰é¢†åŸŸå¤„ç†å›¾åƒæŸåã€é£æ ¼å˜åŒ–ç­‰å±æ€§åç§»é—®é¢˜ä¸Šå¾ˆæˆåŠŸ ã€‚ç„¶è€Œä¸ºå›¾åƒå¤„ç†è®¾è®¡çš„ TTA æ–¹æ³•ç›´æ¥åº”ç”¨åˆ°å›¾ä¸Šæ—¶ï¼Œå…¶åœ¨å¤„ç†å›¾ç»“æ„åç§»æ—¶çš„æ€§èƒ½æå‡éå¸¸æœ‰é™ï¼Œå‡ ä¹å¤±æ•ˆã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg alt=\"400\" loading=\"lazy\" src=\"/images/matcha/pasted-image-20250828111414.png\"\u003e\u003c/p\u003e\n\u003ch2 id=\"analysis\"\u003eAnalysis\u003c/h2\u003e\n\u003cp\u003eä¸¤ç§åç§»æ–¹å¼å¯¹ GNN çš„å½±å“å­˜åœ¨æœ¬è´¨ä¸åŒã€‚\u003c/p\u003e\n\u003ch3 id=\"perliminaries\"\u003ePerliminaries\u003c/h3\u003e\n\u003cp\u003eè®ºæ–‡èšç„¦äº GTTA ä»»åŠ¡ã€‚ä¸€ä¸ª GNN æ¨¡å‹å¯ä»¥è¢«çœ‹æˆä¸¤ä¸ªéƒ¨åˆ†çš„ç»„åˆï¼Œä¸€ä¸ª\u003cstrong\u003eç‰¹å¾æå–å™¨ $ f_{S} $\u003c/strong\u003e ï¼Œä¸€ä¸ª\u003cstrong\u003eåˆ†ç±»å™¨ $ g_{S} $\u003c/strong\u003e ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªçº¿æ€§å±‚ã€‚\u003c/p\u003e\n\u003cp\u003eä¸¤ç§åç§»çš„æ­£å¼å®šä¹‰ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eå±æ€§åç§»\u003c/strong\u003eï¼šæºå›¾å’Œç›®æ ‡å›¾ä¸­ï¼ŒèŠ‚ç‚¹çš„æ¡ä»¶æ¦‚ç‡åˆ†å¸ƒä¸åŒ $ \\mathbb{P}^{S}_{x | y} \\neq \\mathbb{P}^{T}_{x | y} $ ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eç»“æ„åç§»\u003c/strong\u003eï¼šå›¾çš„é‚»æ¥çŸ©é˜µå’Œæ ‡ç­¾çš„è”åˆåˆ†å¸ƒä¸åŒï¼Œå³ $ \\mathbb{P}^{S}_{A \\times Y} \\neq \\mathbb{P}^{T}_{A \\times Y} $ ã€‚è®ºæ–‡ä¸»è¦å…³æ³¨ä¸¤ç§å…·ä½“çš„ç»“æ„åç§»ï¼š\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eåº¦åç§»\u003c/strong\u003eï¼šæºå›¾å’Œç›®æ ‡å›¾çš„å¹³å‡èŠ‚ç‚¹åº¦æ•°ä¸åŒã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåŒè´¨æ€§åç§»\u003c/strong\u003eï¼šæºå›¾å’Œç›®æ ‡å›¾çš„åŒè´¨æ€§æ°´å¹³ä¸åŒã€‚å…¶ä¸­å›¾çš„æ‰€æœ‰èŠ‚ç‚¹åŒè´¨æ€§çš„å¹³å‡å€¼ $ h(\\mathcal{G}) = \\dfrac{1}{N}\\sum_{i}h_{i} $ ï¼Œå•ä¸ªèŠ‚ç‚¹ $ v_{i} $ çš„åŒè´¨æ€§è®¡ç®—å…¬å¼ä¸ºï¼š $$ \n h_{i} = \\dfrac{\\left| \\{ v_{j} \\in \\mathbb{N}(v_{i}): y_{j} = y_{i} \\} \\right|}{d_{i}}  \n $$ å…¶ä¸­ $ y $ è¡¨ç¤ºèŠ‚ç‚¹æ ‡ç­¾ï¼Œ$ d $ è¡¨ç¤ºèŠ‚ç‚¹åº¦æ•°ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"impact-of-distribution-shifts\"\u003eImpact of Distribution Shifts\u003c/h3\u003e\n\u003cp\u003eé€šè¿‡æ•°å­¦å»ºæ¨¡æ¥æ˜¾ç¤ºä¸¤ç§åç§»çš„ä¸åŒå½±å“æœºåˆ¶ã€‚\u003c/p\u003e","title":"Matcha"},{"content":"HPC é¢†åŸŸä¸­ï¼Œé™¤äº†åŸºäºå…±äº«å†…å­˜çš„ OpenMP, è¿˜æœ‰ä¸€ç§æ›´å¹¿æ³›åº”ç”¨äºåˆ†å¸ƒå¼å†…å­˜ç³»ç»Ÿçš„å¹¶è¡Œç¼–ç¨‹èŒƒå¼â€”â€”æ¶ˆæ¯ä¼ é€’æ¥å£ (MPI)ã€‚MPI ä¸ä¾èµ–äºå…±äº«å†…å­˜ï¼Œè€Œæ˜¯é€šè¿‡è¿›ç¨‹é—´çš„æ˜¾å¼æ¶ˆæ¯ä¼ é€’æ¥å®ç°æ•°æ®äº¤æ¢å’ŒåŒæ­¥ï¼Œä»è€Œèƒ½æ”¯æŒæ›´å¤§è§„æ¨¡çš„é›†ç¾¤è®¡ç®—ï¼Œæ˜¯æ„å»ºå¤§è§„æ¨¡ HPC é›†ç¾¤ä¸å¯æˆ–ç¼ºçš„å·¥å…·ã€‚\n1. What is MPI? MPI (Message Passing Interface) æ˜¯ä¸€ç§ç”¨äºåˆ†å¸ƒå¼å†…å­˜ç³»ç»Ÿå¹¶è¡Œç¼–ç¨‹çš„æ ‡å‡†åŒ–é€šä¿¡åè®®å’Œåº“å‡½æ•°è§„èŒƒã€‚å®ƒå®šä¹‰äº†ä¸€å¥—å¯ç§»æ¤çš„å‡½æ•°æ¥å£ï¼Œå…è®¸åœ¨å¹¶è¡Œè®¡ç®—ç¯å¢ƒä¸­ç‹¬ç«‹è¿è¡Œçš„è¿›ç¨‹ä¹‹é—´è¿›è¡Œæ¶ˆæ¯ä¼ é€’ï¼Œä»è€Œå®ç°æ•°æ®äº¤æ¢å’ŒååŒå·¥ä½œã€‚MPI ä¸æŒ‡å®šå¦‚ä½•å¯åŠ¨è¿›ç¨‹ï¼Œä¹Ÿä¸è¦æ±‚æ‰€æœ‰è¿›ç¨‹åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œè¿™ä½¿å¾—å®ƒéå¸¸é€‚åˆç”¨äºé›†ç¾¤æˆ–å¤šèŠ‚ç‚¹ç¯å¢ƒä¸­çš„å¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—ã€‚\n2. The MPI Programming Model åˆ†å¸ƒå¼å†…å­˜æ¨¡å‹\nåœ¨åˆ†å¸ƒå¼å†…å­˜æ¨¡å‹ä¸­ï¼Œå„ä¸ªå¤„ç†èŠ‚ç‚¹å¯ä»¥ç‹¬ç«‹è¿è¡Œè‡ªå·±çš„è¿›ç¨‹ï¼Œä½¿ç”¨è‡ªå·±çš„æœ¬åœ°å†…å­˜æ¥å­˜å‚¨å’Œå¤„ç†æ•°æ®ã€‚æ¯ä¸ªè¿›ç¨‹çš„å†…å­˜æ˜¯ç§æœ‰çš„ï¼Œå…¶ä»–è¿›ç¨‹æ— æ³•ç›´æ¥è®¿é—®å®ƒä»¬ã€‚å¦‚æœä¸€ä¸ªè¿›ç¨‹éœ€è¦è®¿é—®å¦ä¸€ä¸ªè¿›ç¨‹çš„æ•°æ®ï¼Œå°±å¿…é¡»é€šè¿‡æ˜¾å¼çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶å°†æ•°æ®ä»ä¸€ä¸ªè¿›ç¨‹å‘é€åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ã€‚åŒä¸€ä¸ªèŠ‚ç‚¹ï¼ˆæœåŠ¡å™¨ï¼‰å†…éƒ¨éœ€è¦å€ŸåŠ©é«˜é€Ÿæ•°æ®æ€»çº¿ç­‰ç¡¬ä»¶å®ç°ï¼Œè€Œè·¨èŠ‚ç‚¹çš„é€šä¿¡é€šå¸¸ç”±ç½‘ç»œè¿æ¥æ¥å®ç°ï¼Œæ¯”å¦‚é€šè¿‡é«˜é€Ÿä»¥å¤ªç½‘ã€IBï¼ˆInfiniBandï¼‰ç­‰ã€‚\næ ¸å¿ƒæ¦‚å¿µ\nè¿›ç¨‹ (Process)ï¼šä¸€ä¸ª MPI ç¨‹åºç”±ä¸€ä¸ªæˆ–å¤šä¸ªç‹¬ç«‹çš„è¿›ç¨‹ç»„æˆã€‚è¿™äº›è¿›ç¨‹é€šè¿‡è°ƒç”¨ MPI åº“å‡½æ•°æ¥è¿›è¡Œé€šä¿¡ã€‚\né€šä¿¡å­ (Communicator)ï¼šä¸€ä¸ªé€šä¿¡å­ï¼ˆMPI_Commï¼‰å®šä¹‰äº†ä¸€ä¸ªå¯ä»¥äº’ç›¸é€šä¿¡çš„è¿›ç¨‹ç»„ã€‚æœ€å¸¸ç”¨çš„é€šä¿¡å­æ˜¯ MPI_COMM_WORLDï¼Œå®ƒåŒ…å«äº†ç¨‹åºå¯åŠ¨æ—¶çš„æ‰€æœ‰è¿›ç¨‹ã€‚\nç§© (Rank)ï¼šåœ¨åŒä¸€ä¸ªé€šä¿¡å­å†…ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½è¢«èµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ•´æ•°æ ‡è¯†ï¼Œç§°ä¸ºç§©ã€‚ç§©çš„èŒƒå›´æ˜¯ä» 0 åˆ° è¿›ç¨‹æ€»æ•° - 1ã€‚\næ¶ˆæ¯ä¼ é€’ (Message Passing)ï¼šè¿›ç¨‹é—´é€šä¿¡çš„æ ¸å¿ƒæœºåˆ¶ï¼Œåˆ†ä¸ºä¸¤å¤§ç±»ï¼š\nç‚¹å¯¹ç‚¹é€šä¿¡ (Point-to-Point)ï¼šåœ¨ä¸¤ä¸ªæŒ‡å®šçš„è¿›ç¨‹ä¹‹é—´è¿›è¡Œã€‚ é›†ä½“é€šä¿¡ (Collective)ï¼šåœ¨ä¸€ä¸ªé€šä¿¡å­å†…çš„æ‰€æœ‰è¿›ç¨‹å…±åŒå‚ä¸çš„é€šä¿¡ã€‚ é€šä¿¡åè®®ï¼šMPI æä¾›äº†å¤šç§é€šä¿¡åè®®ï¼Œå¦‚é˜»å¡é€šä¿¡ï¼ˆBlockingï¼‰ã€éé˜»å¡é€šä¿¡ï¼ˆNon-blockingï¼‰ã€åŒæ­¥é€šä¿¡ï¼ˆSynchronousï¼‰ç­‰ã€‚\n3. Basic Functions and Concepts ä¸€ä¸ªåŸºç¡€çš„ MPI ç¨‹åºæ€»æ˜¯åŒ…å«åˆå§‹åŒ–ã€æ‰§è¡Œå¹¶è¡Œä»£ç å’Œç»“æŸè¿™å‡ ä¸ªéƒ¨åˆ†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 #include \u0026lt;mpi.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; int main(int argc, char** argv) { // 1. åˆå§‹åŒ– MPI ç¯å¢ƒ MPI_Init(\u0026amp;argc, \u0026amp;argv); int world_size; int world_rank; char processor_name[MPI_MAX_PROCESSOR_NAME]; int name_len; // 2. è·å–é€šä¿¡å­ä¿¡æ¯ MPI_Comm_size(MPI_COMM_WORLD, \u0026amp;world_size); // è·å–æ€»è¿›ç¨‹æ•° MPI_Comm_rank(MPI_COMM_WORLD, \u0026amp;world_rank); // è·å–å½“å‰è¿›ç¨‹çš„ç§© // è·å–å¤„ç†å™¨åç§° (å¯é€‰) MPI_Get_processor_name(processor_name, \u0026amp;name_len); // 3. åŸºäºç§©æ‰§è¡Œä¸åŒçš„ä»£ç  printf(\u0026#34;Hello world from processor %s, rank %d out of %d processors\\n\u0026#34;, processor_name, world_rank, world_size); // 4. ç»“æŸ MPI ç¯å¢ƒ MPI_Finalize(); return 0; } MPI_Init()ï¼šåˆå§‹åŒ– MPI æ‰§è¡Œç¯å¢ƒï¼Œå¿…é¡»æ˜¯ç¬¬ä¸€ä¸ªè¢«è°ƒç”¨çš„ MPI å‡½æ•°ã€‚ MPI_Comm_size()ï¼šè·å–æŒ‡å®šé€šä¿¡å­ï¼ˆè¿™é‡Œæ˜¯ MPI_COMM_WORLDï¼‰ä¸­çš„æ€»è¿›ç¨‹æ•°ã€‚ MPI_Comm_rank()ï¼šè·å–å½“å‰è¿›ç¨‹åœ¨æŒ‡å®šé€šä¿¡å­ä¸­çš„ç§©ã€‚ MPI_Finalize()ï¼šæ¸…ç†å¹¶ç»“æŸ MPI ç¯å¢ƒï¼Œå¿…é¡»æ˜¯æœ€åä¸€ä¸ªè¢«è°ƒç”¨çš„ MPI å‡½æ•°ã€‚ 4. Point-to-Point Communication ç‚¹å¯¹ç‚¹é€šä¿¡æ˜¯ MPI ä¸­æœ€åŸºæœ¬çš„é€šä¿¡æ¨¡å¼ï¼Œç”¨äºåœ¨ä¸€ä¸ªè¿›ç¨‹å‘å¦ä¸€ä¸ªè¿›ç¨‹å‘é€æ•°æ®ã€‚æ ¸å¿ƒæ“ä½œæ˜¯ Send å’Œ Recvã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 #include \u0026lt;mpi.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; int main(int argc, char** argv) { MPI_Init(\u0026amp;argc, \u0026amp;argv); int world_rank, world_size; MPI_Comm_rank(MPI_COMM_WORLD, \u0026amp;world_rank); MPI_Comm_size(MPI_COMM_WORLD, \u0026amp;world_size); if (world_size \u0026lt; 2) { if (world_rank == 0) printf(\u0026#34;This program requires at least 2 processes.\\n\u0026#34;); MPI_Finalize(); return 1; } int number; if (world_rank == 0) { // è¿›ç¨‹ 0 å‘é€æ•°æ®ç»™è¿›ç¨‹ 1 number = 42; MPI_Send(\u0026amp;number, 1, MPI_INT, 1, 0, MPI_COMM_WORLD); printf(\u0026#34;Process 0 sent number %d to process 1\\n\u0026#34;, number); } else if (world_rank == 1) { // è¿›ç¨‹ 1 æ¥æ”¶æ¥è‡ªè¿›ç¨‹ 0 çš„æ•°æ® MPI_Recv(\u0026amp;number, 1, MPI_INT, 0, 0, MPI_COMM_WORLD, MPI_STATUS_IGNORE); printf(\u0026#34;Process 1 received number %d from process 0\\n\u0026#34;, number); } MPI_Finalize(); return 0; } MPI_Send(void* data, int count, MPI_Datatype datatype, int dest, int tag, MPI_Comm comm):\ndataï¼šå‘é€ç¼“å†²åŒºæŒ‡é’ˆã€‚ countï¼šå‘é€çš„æ•°æ®å…ƒç´ ä¸ªæ•°ã€‚ datatypeï¼šå‘é€çš„æ•°æ®ç±»å‹ (å¦‚ MPI_INT, MPI_FLOAT)ã€‚ destï¼šç›®æ ‡è¿›ç¨‹çš„ç§©ã€‚ tagï¼šæ¶ˆæ¯æ ‡ç­¾ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„æ¶ˆæ¯ã€‚ commï¼šä½¿ç”¨çš„é€šä¿¡å­ã€‚ MPI_Recv(void* data, int count, MPI_Datatype datatype, int source, int tag, MPI_Comm comm, MPI_Status* status):\ndataï¼šæ¥æ”¶ç¼“å†²åŒºæŒ‡é’ˆã€‚ sourceï¼šæºè¿›ç¨‹çš„ç§©ã€‚ statusï¼šè¿”å›æ¶ˆæ¯çš„çŠ¶æ€ä¿¡æ¯ (å¯å¡« MPI_STATUS_IGNORE å¿½ç•¥)ã€‚ 5. Collective Communication é›†ä½“é€šä¿¡æ˜¯æ¶‰åŠä¸€ä¸ªé€šä¿¡å­ä¸­æ‰€æœ‰è¿›ç¨‹çš„é€šä¿¡æ“ä½œï¼Œå¸¸ç”¨äºå®ç°æ•°æ®åˆ†å‘ã€ç»“æœæ”¶é›†å’ŒåŒæ­¥ç­‰å¤æ‚æ“ä½œã€‚\nå¹¿æ’­ (MPI_Bcast)ï¼šå°†ä¸€ä¸ªè¿›ç¨‹ï¼ˆæ ¹è¿›ç¨‹ï¼‰çš„æ•°æ®å‘é€ç»™é€šä¿¡å­ä¸­çš„æ‰€æœ‰å…¶ä»–è¿›ç¨‹ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 #include \u0026lt;mpi.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; int main(int argc, char** argv) { MPI_Init(\u0026amp;argc, \u0026amp;argv); int world_size; int world_rank; MPI_Comm_rank(MPI_COMM_WORLD, \u0026amp;world_rank); MPI_Comm_size(MPI_COMM_WORLD, \u0026amp;world_size); int* data = NULL; int data_size; if (world_rank == 0) { // ä¸»è¿›ç¨‹åˆå§‹åŒ–æ•°æ® data_size = 5; data = (int*)malloc(data_size * sizeof(int)); for (int i = 0; i \u0026lt; data_size; i++) data[i] = i + 1; printf(\u0026#34;è¿›ç¨‹ 0 å¹¿æ’­æ•°æ®ï¼š\u0026#34;); for (int i = 0; i \u0026lt; data_size; i++) printf(\u0026#34;%d \u0026#34;, data[i]); printf(\u0026#34;\\n\u0026#34;); } MPI_Bcast(\u0026amp;data_size, 1, MPI_INT, 0, MPI_COMM_WORLD); // åˆ†é…ç¼“å†²åŒº if (world_rank != 0) { data = (int*)malloc(data_size * sizeof(int)); } MPI_Bcast(data, data_size, MPI_INT, 0, MPI_COMM_WORLD); printf(\u0026#34;è¿›ç¨‹ %d æ¥æ”¶åˆ°çš„æ•°æ®ï¼š\u0026#34;, world_rank); for (int i = 0; i \u0026lt; data_size; i++) { printf(\u0026#34;%d \u0026#34;, data[i]); } printf(\u0026#34;\\n\u0026#34;); free(data); MPI_Finalize(); return 0; } åˆ†å‘ (MPI_Scatter)ï¼šå°†æ ¹è¿›ç¨‹ä¸­çš„ä¸€ä¸ªæ•°ç»„ï¼Œåˆ‡åˆ†æˆè‹¥å¹²å—ï¼Œç„¶ååˆ†å‘ç»™é€šä¿¡å­ä¸­çš„æ‰€æœ‰è¿›ç¨‹ï¼ˆåŒ…æ‹¬æ ¹è¿›ç¨‹è‡ªå·±ï¼‰ã€‚\nå½’çº¦ (MPI_Reduce)ï¼šä»æ‰€æœ‰è¿›ç¨‹ä¸­æ”¶é›†æ•°æ®ï¼Œå¹¶é€šè¿‡æŒ‡å®šçš„æ“ä½œï¼ˆå¦‚æ±‚å’Œã€æœ€å¤§å€¼ï¼‰å°†å®ƒä»¬åˆå¹¶åˆ°æ ¹è¿›ç¨‹çš„å˜é‡ä¸­ã€‚\nä¸‹é¢çš„ä¾‹å­é€šè¿‡ Scatter å’Œ Reduce é«˜æ•ˆåœ°å¹¶è¡Œè®¡ç®—äº†ä¸¤ä¸ªå‘é‡çš„ç‚¹ç§¯ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 #include \u0026lt;mpi.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;math.h\u0026gt; #include \u0026lt;time.h\u0026gt; int main(int argc, char** argv) { MPI_Init(\u0026amp;argc, \u0026amp;argv); int rank, size; MPI_Comm_rank(MPI_COMM_WORLD, \u0026amp;rank); MPI_Comm_size(MPI_COMM_WORLD, \u0026amp;size); const int vector_size = 1000000; const int local_size = vector_size / size; float *full_A = NULL; float *full_B = NULL; if (rank == 0) { full_A = (float*)malloc(vector_size * sizeof(float)); full_B = (float*)malloc(vector_size * sizeof(float)); // ä½¿ç”¨å›ºå®šç§å­åˆå§‹åŒ–å®Œæ•´å‘é‡ï¼ˆä¿è¯å¯é‡å¤æ€§ï¼‰ srand(12345); for (int i = 0; i \u0026lt; vector_size; i++) { full_A[i] = (float)rand() / RAND_MAX; full_B[i] = (float)rand() / RAND_MAX; } } float *local_A = (float*)malloc(local_size * sizeof(float)); float *local_B = (float*)malloc(local_size * sizeof(float)); //============ å¹¶è¡Œè®¡ç®— ============ float global_dot = 0.0; MPI_Scatter(full_A, local_size, MPI_FLOAT, local_A, local_size, MPI_FLOAT, 0, MPI_COMM_WORLD); MPI_Scatter(full_B, local_size, MPI_FLOAT, local_B, local_size, MPI_FLOAT, 0, MPI_COMM_WORLD); float local_dot = 0.0; for (int i = 0; i \u0026lt; local_size; ++i) { local_dot += (double)local_A[i] * (double)local_B[i]; } MPI_Reduce(\u0026amp;local_dot, \u0026amp;global_dot, 1, MPI_FLOAT, MPI_SUM, 0, MPI_COMM_WORLD); //============ä¸²è¡Œè®¡ç®—============ if (rank == 0) { double serial_dot = 0.0; for (int i = 0; i \u0026lt; vector_size; i++) { serial_dot += (double)full_A[i] * (double)full_B[i]; } double abs_error = fabs(global_dot - serial_dot); printf(\u0026#34;å¹¶è¡Œç‚¹ç§¯ï¼š%.16f\\n\u0026#34;, global_dot); printf(\u0026#34;ä¸²è¡Œç‚¹ç§¯ï¼š%.16f\\n\u0026#34;, serial_dot); printf(\u0026#34;ç»å¯¹è¯¯å·®ï¼š%.6e\\n\u0026#34;, abs_error); free(full_A); free(full_B); } free(local_A); free(local_B); MPI_Finalize(); return 0; } 6. Communication Modes MPI æä¾›äº†ä¸åŒçš„é€šä¿¡æ¨¡å¼ï¼Œä»¥åº”å¯¹ä¸åŒçš„æ€§èƒ½éœ€æ±‚ã€‚\né˜»å¡é€šä¿¡ (Blocking)ï¼šMPI_Send å’Œ MPI_Recv éƒ½æ˜¯é˜»å¡çš„ã€‚\nMPI_Send ä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°å‘é€ç¼“å†²åŒºçš„æ•°æ®å¯ä»¥è¢«å®‰å…¨åœ°é‡ç”¨ï¼ˆé€šå¸¸æ˜¯æ•°æ®å·²è¢«æ‹·è´åˆ°ç³»ç»Ÿç¼“å†²åŒºæˆ–å·²å‘é€åˆ°æ¥æ”¶æ–¹ï¼‰ã€‚ MPI_Recv ä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°æ¶ˆæ¯å®Œå…¨æ¥æ”¶åˆ°æ¥æ”¶ç¼“å†²åŒºã€‚ ä¼˜ç‚¹ï¼šç¼–ç¨‹ç®€å•ï¼Œé€»è¾‘æ¸…æ™°ã€‚ ç¼ºç‚¹ï¼šå¯èƒ½å¯¼è‡´è¿›ç¨‹é•¿æ—¶é—´ç­‰å¾…ï¼Œé€ æˆæ€§èƒ½ç“¶é¢ˆã€‚ éé˜»å¡é€šä¿¡ (Non-blocking)ï¼šMPI_Isend å’Œ MPI_Irecv æ˜¯éé˜»å¡çš„ã€‚\nå‡½æ•°ä¼šç«‹å³è¿”å›ï¼Œå…è®¸ç¨‹åºåœ¨é€šä¿¡è¿›è¡Œçš„åŒæ—¶æ‰§è¡Œå…¶ä»–è®¡ç®—ä»»åŠ¡ã€‚ éœ€è¦é…åˆ MPI_Wait æˆ– MPI_Test æ¥æ£€æŸ¥é€šä¿¡æ˜¯å¦å®Œæˆã€‚ ä¼˜ç‚¹ï¼šå¯ä»¥å®ç° è®¡ç®—å’Œé€šä¿¡çš„é‡å ï¼Œæ˜¯ MPI æ€§èƒ½ä¼˜åŒ–çš„å…³é”®ã€‚ ç¼ºç‚¹ï¼šç¼–ç¨‹å¤æ‚åº¦æ›´é«˜ã€‚ æ ¸å¿ƒå‡½æ•°ï¼š MPI_Isend: éé˜»å¡å‘é€ã€‚ MPI_Irecv: éé˜»å¡æ¥æ”¶ã€‚ MPI_Wait: ç­‰å¾…ä¸€ä¸ªéé˜»å¡æ“ä½œå®Œæˆã€‚ 7. How to Compile and Run é€šå¸¸ HPC é›†ç¾¤ä¼šé¢„è£… MPI ç¯å¢ƒã€‚åœ¨ Ubuntu/Debian ç³»ç»Ÿä¸Šï¼Œå¯ä»¥è¿™æ ·å®‰è£…ï¼š\n1 sudo apt-get install openmpi-bin libopenmpi-dev ç¼–è¯‘ï¼šä½¿ç”¨ mpicc ç¼–è¯‘å™¨åŒ…è£…å™¨ï¼Œå®ƒä¼šè‡ªåŠ¨é“¾æ¥ MPI åº“ã€‚ 1 mpicc my_program.c -o my_program è¿è¡Œï¼šä½¿ç”¨ mpirun æˆ– mpiexec å‘½ä»¤å¯åŠ¨ç¨‹åºã€‚-np å‚æ•°æŒ‡å®šè¦å¯åŠ¨çš„è¿›ç¨‹æ€»æ•°ã€‚ 1 2 # å¯åŠ¨ 4 ä¸ªè¿›ç¨‹æ¥è¿è¡Œç¨‹åº mpirun -np 4 ./my_program Summary MPI æ˜¯åˆ†å¸ƒå¼å†…å­˜å¹¶è¡Œç¼–ç¨‹çš„åŸºçŸ³ï¼Œå®ƒé€šè¿‡ä¸€å¥—æ ‡å‡†åŒ–çš„å‡½æ•°æ¥å£ï¼Œå®ç°äº†è¿›ç¨‹é—´çš„æ˜¾å¼æ¶ˆæ¯ä¼ é€’ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†ä¸€ä¸ªå¤§ä»»åŠ¡åˆ†è§£ç»™å¤šä¸ªç‹¬ç«‹è¿›ç¨‹ï¼Œé€šè¿‡ ç‚¹å¯¹ç‚¹é€šä¿¡ å’Œ é›†ä½“é€šä¿¡ ååŒå·¥ä½œã€‚è™½ç„¶ç¼–ç¨‹æ¨¡å‹æ¯” OpenMP æ›´å¤æ‚ï¼Œä½†å®ƒæ‘†è„±äº†å•æœºå†…å­˜çš„é™åˆ¶ï¼Œèƒ½å¤Ÿæ‰©å±•åˆ°æ•°åƒä¸ªè®¡ç®—èŠ‚ç‚¹ï¼Œæ˜¯è§£å†³è¶…å¤§è§„æ¨¡è®¡ç®—é—®é¢˜çš„é¦–é€‰å·¥å…·ã€‚\nReferences MPI - HPCå…¥é—¨æŒ‡å— Open MPI å…¥é—¨ç¬”è®° | JinBridge ","permalink":"https://diefish1024.github.io/posts/hpc/mpi-%E5%85%A5%E9%97%A8/","summary":"\u003cp\u003eHPC é¢†åŸŸä¸­ï¼Œé™¤äº†åŸºäºå…±äº«å†…å­˜çš„ OpenMP, è¿˜æœ‰ä¸€ç§æ›´å¹¿æ³›åº”ç”¨äº\u003cstrong\u003eåˆ†å¸ƒå¼å†…å­˜\u003c/strong\u003eç³»ç»Ÿçš„å¹¶è¡Œç¼–ç¨‹èŒƒå¼â€”â€”\u003cstrong\u003eæ¶ˆæ¯ä¼ é€’æ¥å£ (MPI)\u003c/strong\u003eã€‚MPI ä¸ä¾èµ–äºå…±äº«å†…å­˜ï¼Œè€Œæ˜¯é€šè¿‡è¿›ç¨‹é—´çš„æ˜¾å¼æ¶ˆæ¯ä¼ é€’æ¥å®ç°æ•°æ®äº¤æ¢å’ŒåŒæ­¥ï¼Œä»è€Œèƒ½æ”¯æŒæ›´å¤§è§„æ¨¡çš„é›†ç¾¤è®¡ç®—ï¼Œæ˜¯æ„å»ºå¤§è§„æ¨¡ HPC é›†ç¾¤ä¸å¯æˆ–ç¼ºçš„å·¥å…·ã€‚\u003c/p\u003e\n\u003ch2 id=\"1-what-is-mpi\"\u003e1. What is MPI?\u003c/h2\u003e\n\u003cp\u003eMPI (Message Passing Interface) æ˜¯ä¸€ç§ç”¨äº\u003cstrong\u003eåˆ†å¸ƒå¼å†…å­˜\u003c/strong\u003eç³»ç»Ÿå¹¶è¡Œç¼–ç¨‹çš„æ ‡å‡†åŒ–é€šä¿¡åè®®å’Œåº“å‡½æ•°è§„èŒƒã€‚å®ƒå®šä¹‰äº†ä¸€å¥—å¯ç§»æ¤çš„å‡½æ•°æ¥å£ï¼Œå…è®¸åœ¨å¹¶è¡Œè®¡ç®—ç¯å¢ƒä¸­ç‹¬ç«‹è¿è¡Œçš„è¿›ç¨‹ä¹‹é—´è¿›è¡Œ\u003cstrong\u003eæ¶ˆæ¯ä¼ é€’\u003c/strong\u003eï¼Œä»è€Œå®ç°æ•°æ®äº¤æ¢å’ŒååŒå·¥ä½œã€‚MPI ä¸æŒ‡å®šå¦‚ä½•å¯åŠ¨è¿›ç¨‹ï¼Œä¹Ÿä¸è¦æ±‚æ‰€æœ‰è¿›ç¨‹åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œè¿™ä½¿å¾—å®ƒéå¸¸é€‚åˆç”¨äº\u003cstrong\u003eé›†ç¾¤æˆ–å¤šèŠ‚ç‚¹ç¯å¢ƒ\u003c/strong\u003eä¸­çš„å¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—ã€‚\u003c/p\u003e\n\u003ch2 id=\"2-the-mpi-programming-model\"\u003e2. The MPI Programming Model\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ†å¸ƒå¼å†…å­˜æ¨¡å‹\u003c/strong\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eåœ¨åˆ†å¸ƒå¼å†…å­˜æ¨¡å‹ä¸­ï¼Œå„ä¸ªå¤„ç†èŠ‚ç‚¹å¯ä»¥ç‹¬ç«‹è¿è¡Œè‡ªå·±çš„è¿›ç¨‹ï¼Œä½¿ç”¨è‡ªå·±çš„æœ¬åœ°å†…å­˜æ¥å­˜å‚¨å’Œå¤„ç†æ•°æ®ã€‚æ¯ä¸ªè¿›ç¨‹çš„å†…å­˜æ˜¯ç§æœ‰çš„ï¼Œå…¶ä»–è¿›ç¨‹æ— æ³•ç›´æ¥è®¿é—®å®ƒä»¬ã€‚å¦‚æœä¸€ä¸ªè¿›ç¨‹éœ€è¦è®¿é—®å¦ä¸€ä¸ªè¿›ç¨‹çš„æ•°æ®ï¼Œå°±å¿…é¡»é€šè¿‡æ˜¾å¼çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶å°†æ•°æ®ä»ä¸€ä¸ªè¿›ç¨‹å‘é€åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ã€‚åŒä¸€ä¸ªèŠ‚ç‚¹ï¼ˆæœåŠ¡å™¨ï¼‰å†…éƒ¨éœ€è¦å€ŸåŠ©é«˜é€Ÿæ•°æ®æ€»çº¿ç­‰ç¡¬ä»¶å®ç°ï¼Œè€Œè·¨èŠ‚ç‚¹çš„é€šä¿¡é€šå¸¸ç”±ç½‘ç»œè¿æ¥æ¥å®ç°ï¼Œæ¯”å¦‚é€šè¿‡é«˜é€Ÿä»¥å¤ªç½‘ã€IBï¼ˆInfiniBandï¼‰ç­‰ã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003e\u003cstrong\u003eæ ¸å¿ƒæ¦‚å¿µ\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eè¿›ç¨‹ (Process)\u003c/strong\u003eï¼šä¸€ä¸ª MPI ç¨‹åºç”±ä¸€ä¸ªæˆ–å¤šä¸ªç‹¬ç«‹çš„è¿›ç¨‹ç»„æˆã€‚è¿™äº›è¿›ç¨‹é€šè¿‡è°ƒç”¨ MPI åº“å‡½æ•°æ¥è¿›è¡Œé€šä¿¡ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eé€šä¿¡å­ (Communicator)\u003c/strong\u003eï¼šä¸€ä¸ªé€šä¿¡å­ï¼ˆ\u003ccode\u003eMPI_Comm\u003c/code\u003eï¼‰å®šä¹‰äº†ä¸€ä¸ªå¯ä»¥äº’ç›¸é€šä¿¡çš„è¿›ç¨‹ç»„ã€‚æœ€å¸¸ç”¨çš„é€šä¿¡å­æ˜¯ \u003ccode\u003eMPI_COMM_WORLD\u003c/code\u003eï¼Œå®ƒåŒ…å«äº†ç¨‹åºå¯åŠ¨æ—¶çš„æ‰€æœ‰è¿›ç¨‹ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eç§© (Rank)\u003c/strong\u003eï¼šåœ¨åŒä¸€ä¸ªé€šä¿¡å­å†…ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½è¢«èµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„æ•´æ•°æ ‡è¯†ï¼Œç§°ä¸ºç§©ã€‚ç§©çš„èŒƒå›´æ˜¯ä» \u003ccode\u003e0\u003c/code\u003e åˆ° \u003ccode\u003eè¿›ç¨‹æ€»æ•° - 1\u003c/code\u003eã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eæ¶ˆæ¯ä¼ é€’ (Message Passing)\u003c/strong\u003eï¼šè¿›ç¨‹é—´é€šä¿¡çš„æ ¸å¿ƒæœºåˆ¶ï¼Œåˆ†ä¸ºä¸¤å¤§ç±»ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eç‚¹å¯¹ç‚¹é€šä¿¡ (Point-to-Point)\u003c/strong\u003eï¼šåœ¨ä¸¤ä¸ªæŒ‡å®šçš„è¿›ç¨‹ä¹‹é—´è¿›è¡Œã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eé›†ä½“é€šä¿¡ (Collective)\u003c/strong\u003eï¼šåœ¨ä¸€ä¸ªé€šä¿¡å­å†…çš„æ‰€æœ‰è¿›ç¨‹å…±åŒå‚ä¸çš„é€šä¿¡ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eé€šä¿¡åè®®\u003c/strong\u003eï¼šMPI æä¾›äº†å¤šç§é€šä¿¡åè®®ï¼Œå¦‚é˜»å¡é€šä¿¡ï¼ˆBlockingï¼‰ã€éé˜»å¡é€šä¿¡ï¼ˆNon-blockingï¼‰ã€åŒæ­¥é€šä¿¡ï¼ˆSynchronousï¼‰ç­‰ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"3-basic-functions-and-concepts\"\u003e3. Basic Functions and Concepts\u003c/h2\u003e\n\u003cp\u003eä¸€ä¸ªåŸºç¡€çš„ MPI ç¨‹åºæ€»æ˜¯åŒ…å«åˆå§‹åŒ–ã€æ‰§è¡Œå¹¶è¡Œä»£ç å’Œç»“æŸè¿™å‡ ä¸ªéƒ¨åˆ†ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;mpi.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;stdio.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eargc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"o\"\u003e**\u003c/span\u003e \u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// 1. åˆå§‹åŒ– MPI ç¯å¢ƒ\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003eMPI_Init\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eargc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eworld_size\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eworld_rank\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003eprocessor_name\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eMPI_MAX_PROCESSOR_NAME\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ename_len\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// 2. è·å–é€šä¿¡å­ä¿¡æ¯\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003eMPI_Comm_size\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMPI_COMM_WORLD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eworld_size\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// è·å–æ€»è¿›ç¨‹æ•°\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003eMPI_Comm_rank\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMPI_COMM_WORLD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eworld_rank\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// è·å–å½“å‰è¿›ç¨‹çš„ç§©\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// è·å–å¤„ç†å™¨åç§° (å¯é€‰)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003eMPI_Get_processor_name\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprocessor_name\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ename_len\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// 3. åŸºäºç§©æ‰§è¡Œä¸åŒçš„ä»£ç \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello world from processor %s, rank %d out of %d processors\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e           \u003cspan class=\"n\"\u003eprocessor_name\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eworld_rank\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eworld_size\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// 4. ç»“æŸ MPI ç¯å¢ƒ\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003eMPI_Finalize\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eMPI_Init()\u003c/code\u003e\u003c/strong\u003eï¼šåˆå§‹åŒ– MPI æ‰§è¡Œç¯å¢ƒï¼Œå¿…é¡»æ˜¯ç¬¬ä¸€ä¸ªè¢«è°ƒç”¨çš„ MPI å‡½æ•°ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eMPI_Comm_size()\u003c/code\u003e\u003c/strong\u003eï¼šè·å–æŒ‡å®šé€šä¿¡å­ï¼ˆè¿™é‡Œæ˜¯ \u003ccode\u003eMPI_COMM_WORLD\u003c/code\u003eï¼‰ä¸­çš„æ€»è¿›ç¨‹æ•°ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eMPI_Comm_rank()\u003c/code\u003e\u003c/strong\u003eï¼šè·å–å½“å‰è¿›ç¨‹åœ¨æŒ‡å®šé€šä¿¡å­ä¸­çš„ç§©ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eMPI_Finalize()\u003c/code\u003e\u003c/strong\u003eï¼šæ¸…ç†å¹¶ç»“æŸ MPI ç¯å¢ƒï¼Œå¿…é¡»æ˜¯æœ€åä¸€ä¸ªè¢«è°ƒç”¨çš„ MPI å‡½æ•°ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"4-point-to-point-communication\"\u003e4. Point-to-Point Communication\u003c/h2\u003e\n\u003cp\u003eç‚¹å¯¹ç‚¹é€šä¿¡æ˜¯ MPI ä¸­æœ€åŸºæœ¬çš„é€šä¿¡æ¨¡å¼ï¼Œç”¨äºåœ¨ä¸€ä¸ªè¿›ç¨‹å‘å¦ä¸€ä¸ªè¿›ç¨‹å‘é€æ•°æ®ã€‚æ ¸å¿ƒæ“ä½œæ˜¯ \u003ccode\u003eSend\u003c/code\u003e å’Œ \u003ccode\u003eRecv\u003c/code\u003eã€‚\u003c/p\u003e","title":"MPI å…¥é—¨"},{"content":"ç”±äºé«˜æ€§èƒ½è®¡ç®—åœºæ™¯ä¸‹çš„å¹¶è¡Œç¼–ç¨‹ä»»åŠ¡çš„ç‰¹æ€§ï¼ŒOpenMP å¯ä»¥é€šè¿‡ç®€å•å—é™çš„è¯­æ³•æå¤§åœ°åŒ–ç®€äº†å¹¶è¡Œç¼–ç¨‹çš„å¤æ‚æ€§ï¼Œåœ¨æ™®é€šçš„ä¸²è¡Œä»£ç ä¸­æ·»åŠ ä¸€äº›æŒ‡ä»¤å°±èƒ½å¤Ÿå®ç°é«˜æ•ˆå¹¶è¡ŒåŒ–ã€‚\n1. What is OpenMP? OpenMP (Open Multi-Processing) æ˜¯ä¸€ç§ç”¨äºå…±äº«å†…å­˜å¤šå¤„ç†å™¨ç³»ç»Ÿå¹¶è¡Œç¼–ç¨‹çš„ APIã€‚å®ƒé€šè¿‡åœ¨ C, C++, æˆ– Fortran ä»£ç ä¸­æ·»åŠ  #pragma çš„æ–¹å¼ï¼Œè®©å¼€å‘è€…å¯ä»¥è½»æ¾åœ°å°†ä¸²è¡Œä»£ç å¹¶è¡ŒåŒ–ï¼Œè€Œæ— éœ€æ‰‹åŠ¨ç®¡ç†å¤æ‚çš„çº¿ç¨‹åˆ›å»ºã€åŒæ­¥å’Œé”€æ¯è¿‡ç¨‹ã€‚\n2. The OpenMP Programming Model å…±äº«å†…å­˜æ¨¡å‹ï¼šæ‰€æœ‰çº¿ç¨‹åœ¨åŒä¸€ä¸ªåœ°å€ç©ºé—´ä¸­å…±äº«æ•°æ®ã€‚è¿™æ„å‘³ç€ä¸åŒçº¿ç¨‹å¯ä»¥è®¿é—®ç›¸åŒçš„å†…å­˜ä½ç½®ï¼Œå¹¶ä¸”å¯ä»¥å…±äº«å˜é‡çš„å€¼ã€‚\nå…±äº«å˜é‡ï¼šåœ¨å¹¶è¡ŒåŒºåŸŸä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¤§å¤šæ•°å˜é‡æ˜¯å…±äº«çš„ï¼Œå³æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®å’Œä¿®æ”¹è¿™äº›å˜é‡çš„å€¼ã€‚\nç§æœ‰å˜é‡ï¼šæŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰å˜é‡çš„ç§æœ‰å‰¯æœ¬ï¼Œè¿™æ ·ä¸åŒçº¿ç¨‹ä¹‹é—´ä¸ä¼šç›¸äº’å¹²æ‰°ã€‚OpenMP é€šè¿‡Â privateÂ æŒ‡ä»¤æŒ‡å®šè¿™äº›å˜é‡ã€‚\næ•°æ®ç«äº‰ï¼ˆRace Conditionï¼‰ï¼šç”±äºå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å’Œä¿®æ”¹å…±äº«å˜é‡ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ç«äº‰é—®é¢˜ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼ŒOpenMP æä¾›äº†åŒæ­¥æœºåˆ¶ï¼Œå¦‚Â criticalÂ å’ŒÂ atomicÂ ç­‰ã€‚\nå¹¶è¡ŒåŒºåŸŸï¼ˆParallel Regionï¼‰ï¼šæ˜¯ OpenMP ç¼–ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µã€‚å®ƒæ˜¯ç”±ç¼–è¯‘å™¨æŒ‡ä»¤ #pragma omp parallelÂ æŒ‡å®šçš„ä¸€æ®µä»£ç ï¼Œå‘Šè¯‰ OpenMP åœ¨è¿™æ®µä»£ç ä¸­åˆ›å»ºå¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œã€‚\nFork-Join æ‰§è¡Œæ¨¡å‹ï¼šä»å•çº¿ç¨‹å¼€å§‹æ‰§è¡Œï¼Œè¿›å…¥å¹¶è¡ŒåŒºåŸŸå¼€å§‹å¹¶è¡Œæ‰§è¡Œï¼Œåœ¨å¹¶è¡ŒåŒºåŸŸç»“å°¾è¿›è¡ŒåŒæ­¥å’Œç»“æŸçº¿ç¨‹ã€‚\n3. Core Directives and Constructs OpenMP çš„åŠŸèƒ½ä¸»è¦æ˜¯é€šè¿‡ç¼–è¯‘æŒ‡ä»¤ï¼ˆDirectivesï¼‰å’Œç›¸å…³çš„å­å¥ï¼ˆClausesï¼‰æ¥å®ç°çš„ã€‚\nparallelï¼šç”¨äºåˆ›å»ºä¸€ä¸ªå¹¶è¡ŒåŒºåŸŸã€‚ 1 2 3 4 5 #pragma omp parallel { // è¿™éƒ¨åˆ†ä»£ç å°†ç”±å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ printf(\u0026#34;Hello from thread %d\\n\u0026#34;, omp_get_thread_num()); } forï¼šç”¨äºå¹¶è¡ŒåŒ– for å¾ªç¯ï¼Œå¿…é¡»ä¸ parallel ç»“åˆä½¿ç”¨ã€‚å®ƒä¼šè‡ªåŠ¨å°†å¾ªç¯è¿­ä»£åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ï¼Œè¿™æ˜¯ OpenMP æœ€å¸¸ç”¨ã€æœ€é«˜æ•ˆçš„æŒ‡ä»¤ä¹‹ä¸€ã€‚ 1 2 3 4 #pragma omp parallel for for (int i = 0; i \u0026lt; n; i++) { // å¾ªç¯çš„ n æ¬¡è¿­ä»£ä¼šè¢«åˆ†é…ç»™ä¸åŒçº¿ç¨‹ } sectionsï¼šç”¨äºå°†ä¸åŒçš„ã€ç‹¬ç«‹çš„ä»»åŠ¡ä»£ç å—åˆ†é…ç»™ä¸åŒçº¿ç¨‹ã€‚é€‚ç”¨äºä»»åŠ¡å¹¶è¡Œè€Œä¸æ˜¯æ•°æ®å¹¶è¡Œã€‚ 1 2 3 4 5 6 7 #pragma omp parallel sections { #pragma omp section { /* task A */ } #pragma omp section { /* task B */ } } 4. Data Scoping æ•°æ®ä½œç”¨åŸŸå®šä¹‰äº†å¹¶è¡ŒåŒºåŸŸä¸­å˜é‡å¦‚ä½•è¢«çº¿ç¨‹å…±äº«æˆ–è€…ç§æœ‰ï¼ŒOpenMP é€šè¿‡å­å¥ clauses æ¥æ§åˆ¶å˜é‡å±æ€§ã€‚\nshared(list)ï¼šå˜é‡åœ¨æ‰€æœ‰çº¿ç¨‹é—´å…±äº«åŒä¸€ä»½å†…å­˜ï¼Œè¿™æ˜¯å¤§å¤šæ•°å˜é‡çš„é»˜è®¤è®¾ç½®ã€‚è¯»å†™å…±äº«å˜é‡é€šå¸¸éœ€è¦åŒæ­¥ã€‚ 1 2 3 4 5 int a; #pragma omp parallel for shared(a) for (int i = 0; i \u0026lt; n; i++) { // aä¸ºå…¬æœ‰å˜é‡ } private(list)ï¼šæ¯ä¸ªçº¿ç¨‹åœ¨å¹¶è¡ŒåŒºåŸŸä¸­æœ‰è‡ªå·±ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼Œçº¿ç¨‹ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°ã€‚å¹¶è¡ŒåŒºåŸŸå†…ç”³æ˜çš„å˜é‡é»˜è®¤ä¸ºç§æœ‰çš„ï¼Œå¹¶è¡ŒåŒºåŸŸå¤–ç”³æ˜çš„å˜é‡éœ€è¦æ˜¾å¼ç”³æ˜ privateã€‚ firstprivate(list)ï¼šæ˜¯ private çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚ç§æœ‰å‰¯æœ¬ä¼šç”¨ä¸»çº¿ç¨‹ä¸­åŸå§‹å˜é‡çš„å€¼è¿›è¡Œ åˆå§‹åŒ–ã€‚ lastprivate(list)ï¼šæ˜¯ private çš„å¦ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚å½“å¹¶è¡Œç»“æŸåï¼Œå¾ªç¯ä¸­æœ€åä¸€æ¬¡è¿­ä»£ï¼ˆæˆ– sections ä¸­æœ€åä¸€ä¸ª sectionï¼‰çš„çº¿ç¨‹ä¼šå°†å…¶ç§æœ‰å‰¯æœ¬çš„å€¼æ‹·è´å›ä¸»çº¿ç¨‹çš„åŸå§‹å˜é‡ã€‚ 1 2 3 4 5 6 int a; #pragma omp parallel for private(a) for (int i = 0; i \u0026lt; n; i++) { int b; //a,bå‡ä¸ºç§æœ‰å˜é‡ } reduction(operator:list)ï¼šç”¨äºè§£å†³å¹¶è¡Œè®¡ç®—ä¸­çš„å½’çº¦æ“ä½œï¼ˆå¦‚æ±‚å’Œã€æ±‚ç§¯ï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹ä¼šè®¡ç®—ä¸€ä¸ªå±€éƒ¨ç»“æœï¼Œå¹¶è¡ŒåŒºç»“æŸåï¼Œæ‰€æœ‰å±€éƒ¨ç»“æœä¼šé€šè¿‡æŒ‡å®šçš„æ“ä½œç¬¦ (+, *, - ç­‰) åˆå¹¶åˆ°ä¸»çº¿ç¨‹çš„å…¨å±€å˜é‡ä¸­ï¼Œä»è€Œé¿å…äº†ç«äº‰ã€‚ ï¼ˆè§„çº¦çš„è¿ç®—ç¬¦è§„åˆ™ï¼‰ 1 2 3 4 5 int sum = 0; #pragma omp parallel for reduction(+:sum) for (int i = 0; i \u0026lt; 10; i++) { sum += i; } 5. Loop Scheduling å½“ä½¿ç”¨ omp for æ—¶ï¼ŒOpenMP éœ€è¦å†³å®šå¦‚ä½•å°†å¾ªç¯çš„è¿­ä»£æ¬¡æ•°åˆ†é…ç»™çº¿ç¨‹ã€‚è¿™é€šè¿‡ schedule å­å¥æ§åˆ¶ï¼Œå…¶é€‰æ‹©ä¼šå½±å“è´Ÿè½½å‡è¡¡ (Load Balancing) å’Œå¼€é”€ (Overhead)ã€‚\nschedule(static, [chunk_size])ï¼šé™æ€è°ƒåº¦ã€‚åœ¨ç¼–è¯‘æ—¶å°±å°†è¿­ä»£å¹³å‡åˆ†é…å¥½ã€‚å¼€é”€æœ€å°ï¼Œé€‚ç”¨äºæ¯æ¬¡è¿­ä»£è®¡ç®—é‡éƒ½ç›¸ç­‰çš„å¾ªç¯ã€‚ 1 2 3 4 #pragma omp parallel for schedule(static, 3) for (int i = 0; i \u0026lt; n; i++) { // æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œ3ä¸ªè¿ç»­çš„è¿­ä»£ } schedule(dynamic, [chunk_size])ï¼šåŠ¨æ€è°ƒåº¦ã€‚çº¿ç¨‹æ¯æ¬¡å®Œæˆä¸€ä¸ªï¼ˆæˆ– chunk_size ä¸ªï¼‰è¿­ä»£åï¼ŒåŠ¨æ€åœ°å»ä»»åŠ¡é˜Ÿåˆ—é¢†å–æ–°çš„ä»»åŠ¡ã€‚å¼€é”€è¾ƒå¤§ï¼Œä½†é€‚ç”¨äºæ¯æ¬¡è¿­ä»£è®¡ç®—é‡ä¸å‡åŒ€çš„åœºæ™¯ã€‚\nschedule(guided, [chunk_size])ï¼šå¼•å¯¼å¼è°ƒåº¦ã€‚åŠ¨æ€è°ƒåº¦çš„ä¸€ç§ä¼˜åŒ–ã€‚å¼€å§‹æ—¶åˆ†é…å¤§å—ä»»åŠ¡ï¼Œéšç€ä»»åŠ¡å‰©ä½™é‡å‡å°‘ï¼Œåˆ†é…çš„ä»»åŠ¡å—ä¹Ÿè¶Šæ¥è¶Šå°ã€‚æ˜¯ static å’Œ dynamic çš„ä¸€ç§æŠ˜ä¸­ã€‚\nautoï¼šè‡ªåŠ¨è°ƒåº¦å°†è°ƒåº¦ç­–ç•¥çš„é€‰æ‹©æƒäº¤ç»™ç¼–è¯‘å™¨æˆ–è¿è¡Œæ—¶åº“ï¼Œç”±å®ƒä»¬å†³å®šæœ€ä½³çš„è°ƒåº¦æ–¹å¼ã€‚\nschedule(runtime)ï¼šç”±ç¯å¢ƒå˜é‡ OMP_SCHEDULE å†³å®šä½¿ç”¨å“ªç§è°ƒåº¦ç­–ç•¥ï¼Œå¢åŠ äº†çµæ´»æ€§ã€‚\n6. Synchronization Control åŒæ­¥æ˜¯ç”¨æ¥åè°ƒçº¿ç¨‹é—´çš„æ‰§è¡Œé¡ºåºå’Œä¿è¯å¯¹å…±äº«æ•°æ®è®¿é—®çš„æ­£ç¡®æ€§ã€‚\ncriticalï¼šå®šä¹‰ä¸€ä¸ªä¸´ç•ŒåŒºï¼ŒåŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è¿›å…¥è¯¥ä»£ç å—ï¼Œå¼€é”€è¾ƒå¤§ã€‚\natomicï¼šé’ˆå¯¹å•æ¡å†…å­˜æ›´æ–°è¯­å¥ï¼ˆå¦‚ x++, x = x + 1ï¼‰æä¾›åŸå­æ“ä½œã€‚æ¯” critical æ›´è½»é‡ï¼Œæ˜¯ä¿æŠ¤ç®€å•æ›´æ–°çš„é¦–é€‰ã€‚\nbarrierï¼šä¸€ä¸ªåŒæ­¥ç‚¹ã€‚æ‰€æœ‰çº¿ç¨‹å¿…é¡»æ‰§è¡Œåˆ° barrier å¤„æ‰ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œæ²¡æœ‰ä»»ä½•çº¿ç¨‹å¯ä»¥æå‰ã€‚åœ¨å¹¶è¡ŒåŒºåŸŸæœ«å°¾ä¼šæœ‰ä¸€ä¸ªéšå¼çš„ barrierã€‚\nmasterï¼šæŒ‡å®šä¸€å—ä»£ç åªç”±ä¸»çº¿ç¨‹æ‰§è¡Œã€‚\nsingleï¼šæŒ‡å®šä¸€å—ä»£ç åªç”±çº¿ç¨‹ç»„ä¸­ç¬¬ä¸€ä¸ªåˆ°è¾¾çš„çº¿ç¨‹æ‰§è¡Œã€‚\n7. Environment Variables OpenMP å…è®¸é€šè¿‡ç¯å¢ƒå˜é‡åœ¨è¿è¡Œæ—¶æ§åˆ¶å¹¶è¡Œè¡Œä¸ºï¼Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘ä»£ç ã€‚\nOMP_NUM_THREADSï¼šè®¾ç½®å¹¶è¡ŒåŒºé»˜è®¤ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œè¿™æ˜¯æœ€å¸¸ç”¨çš„ç¯å¢ƒå˜é‡ã€‚\nOMP_SCHEDULEï¼šå½“ä»£ç ä¸­ä½¿ç”¨ schedule(runtime) æ—¶ï¼Œè¯¥å˜é‡ç”¨äºè®¾å®šå¾ªç¯è°ƒåº¦ç­–ç•¥å’Œå—å¤§å°ï¼Œä¾‹å¦‚ï¼š\u0026quot;dynamic,4\u0026quot;ã€‚\nOMP_PROC_BINDï¼šæ§åˆ¶çº¿ç¨‹ä¸å¤„ç†å™¨æ ¸å¿ƒçš„äº²å’Œæ€§ï¼ˆç»‘å®šå…³ç³»ï¼‰ï¼Œå¯¹æ€§èƒ½ä¼˜åŒ–éå¸¸é‡è¦ã€‚\n8. How to Compile and Run ç¼–è¯‘ C/C++ ä»£ç æ—¶ï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ªç‰¹å®šçš„ç¼–è¯‘å™¨æ ‡å¿—æ¥å¯ç”¨ OpenMP æ”¯æŒã€‚\nGCC / G++ï¼š 1 g++ -fopenmp my_program.cpp -o my_program Reference HPC å…¥é—¨æŒ‡å— OpenMP å…¥é—¨ç¬”è®° | JinBridge ","permalink":"https://diefish1024.github.io/posts/hpc/openmp-%E5%85%A5%E9%97%A8/","summary":"\u003cp\u003eç”±äºé«˜æ€§èƒ½è®¡ç®—åœºæ™¯ä¸‹çš„å¹¶è¡Œç¼–ç¨‹ä»»åŠ¡çš„ç‰¹æ€§ï¼ŒOpenMP å¯ä»¥é€šè¿‡ç®€å•å—é™çš„è¯­æ³•æå¤§åœ°åŒ–ç®€äº†å¹¶è¡Œç¼–ç¨‹çš„å¤æ‚æ€§ï¼Œåœ¨æ™®é€šçš„ä¸²è¡Œä»£ç ä¸­æ·»åŠ ä¸€äº›æŒ‡ä»¤å°±èƒ½å¤Ÿå®ç°é«˜æ•ˆå¹¶è¡ŒåŒ–ã€‚\u003c/p\u003e\n\u003ch2 id=\"1-what-is-openmp\"\u003e1. What is OpenMP?\u003c/h2\u003e\n\u003cp\u003eOpenMP (Open Multi-Processing) æ˜¯ä¸€ç§ç”¨äº\u003cstrong\u003eå…±äº«å†…å­˜\u003c/strong\u003eå¤šå¤„ç†å™¨ç³»ç»Ÿå¹¶è¡Œç¼–ç¨‹çš„ APIã€‚å®ƒé€šè¿‡åœ¨ C, C++, æˆ– Fortran ä»£ç ä¸­æ·»åŠ  \u003ccode\u003e#pragma\u003c/code\u003e çš„æ–¹å¼ï¼Œè®©å¼€å‘è€…å¯ä»¥è½»æ¾åœ°å°†ä¸²è¡Œä»£ç å¹¶è¡ŒåŒ–ï¼Œè€Œæ— éœ€æ‰‹åŠ¨ç®¡ç†å¤æ‚çš„çº¿ç¨‹åˆ›å»ºã€åŒæ­¥å’Œé”€æ¯è¿‡ç¨‹ã€‚\u003c/p\u003e\n\u003ch2 id=\"2-the-openmp-programming-model\"\u003e2. The OpenMP Programming Model\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eå…±äº«å†…å­˜æ¨¡å‹\u003c/strong\u003eï¼šæ‰€æœ‰çº¿ç¨‹åœ¨åŒä¸€ä¸ªåœ°å€ç©ºé—´ä¸­å…±äº«æ•°æ®ã€‚è¿™æ„å‘³ç€ä¸åŒçº¿ç¨‹å¯ä»¥è®¿é—®ç›¸åŒçš„å†…å­˜ä½ç½®ï¼Œå¹¶ä¸”å¯ä»¥å…±äº«å˜é‡çš„å€¼ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå…±äº«å˜é‡\u003c/strong\u003eï¼šåœ¨å¹¶è¡ŒåŒºåŸŸä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¤§å¤šæ•°å˜é‡æ˜¯å…±äº«çš„ï¼Œå³æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®å’Œä¿®æ”¹è¿™äº›å˜é‡çš„å€¼ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eç§æœ‰å˜é‡\u003c/strong\u003eï¼šæŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰å˜é‡çš„ç§æœ‰å‰¯æœ¬ï¼Œè¿™æ ·ä¸åŒçº¿ç¨‹ä¹‹é—´ä¸ä¼šç›¸äº’å¹²æ‰°ã€‚OpenMP é€šè¿‡Â \u003ccode\u003eprivate\u003c/code\u003eÂ æŒ‡ä»¤æŒ‡å®šè¿™äº›å˜é‡ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eæ•°æ®ç«äº‰ï¼ˆRace Conditionï¼‰\u003c/strong\u003eï¼šç”±äºå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å’Œä¿®æ”¹å…±äº«å˜é‡ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ç«äº‰é—®é¢˜ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼ŒOpenMP æä¾›äº†åŒæ­¥æœºåˆ¶ï¼Œå¦‚Â \u003ccode\u003ecritical\u003c/code\u003eÂ å’ŒÂ \u003ccode\u003eatomic\u003c/code\u003eÂ ç­‰ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eå¹¶è¡ŒåŒºåŸŸï¼ˆParallel Regionï¼‰\u003c/strong\u003eï¼šæ˜¯ OpenMP ç¼–ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µã€‚å®ƒæ˜¯ç”±ç¼–è¯‘å™¨æŒ‡ä»¤ \u003ccode\u003e#pragma omp parallel\u003c/code\u003eÂ æŒ‡å®šçš„ä¸€æ®µä»£ç ï¼Œå‘Šè¯‰ OpenMP åœ¨è¿™æ®µä»£ç ä¸­åˆ›å»ºå¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eFork-Join æ‰§è¡Œæ¨¡å‹\u003c/strong\u003eï¼šä»å•çº¿ç¨‹å¼€å§‹æ‰§è¡Œï¼Œè¿›å…¥å¹¶è¡ŒåŒºåŸŸå¼€å§‹å¹¶è¡Œæ‰§è¡Œï¼Œåœ¨å¹¶è¡ŒåŒºåŸŸç»“å°¾è¿›è¡ŒåŒæ­¥å’Œç»“æŸçº¿ç¨‹ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/images/openmp-%E5%85%A5%E9%97%A8/pasted-image-20250827105206.png\"\u003e\u003c/p\u003e\n\u003ch2 id=\"3-core-directives-and-constructs\"\u003e3. Core Directives and Constructs\u003c/h2\u003e\n\u003cp\u003eOpenMP çš„åŠŸèƒ½ä¸»è¦æ˜¯é€šè¿‡ç¼–è¯‘æŒ‡ä»¤ï¼ˆDirectivesï¼‰å’Œç›¸å…³çš„å­å¥ï¼ˆClausesï¼‰æ¥å®ç°çš„ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eparallel\u003c/code\u003e\u003c/strong\u003eï¼šç”¨äºåˆ›å»ºä¸€ä¸ªå¹¶è¡ŒåŒºåŸŸã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#pragma omp parallel\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// è¿™éƒ¨åˆ†ä»£ç å°†ç”±å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello from thread %d\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003eomp_get_thread_num\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003efor\u003c/code\u003e\u003c/strong\u003eï¼šç”¨äºå¹¶è¡ŒåŒ– \u003ccode\u003efor\u003c/code\u003e å¾ªç¯ï¼Œå¿…é¡»ä¸ \u003ccode\u003eparallel\u003c/code\u003e ç»“åˆä½¿ç”¨ã€‚å®ƒä¼šè‡ªåŠ¨å°†å¾ªç¯è¿­ä»£åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ï¼Œè¿™æ˜¯ OpenMP æœ€å¸¸ç”¨ã€æœ€é«˜æ•ˆçš„æŒ‡ä»¤ä¹‹ä¸€ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#pragma omp parallel for\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// å¾ªç¯çš„ n æ¬¡è¿­ä»£ä¼šè¢«åˆ†é…ç»™ä¸åŒçº¿ç¨‹\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003esections\u003c/code\u003e\u003c/strong\u003eï¼šç”¨äºå°†ä¸åŒçš„ã€ç‹¬ç«‹çš„ä»»åŠ¡ä»£ç å—åˆ†é…ç»™ä¸åŒçº¿ç¨‹ã€‚é€‚ç”¨äºä»»åŠ¡å¹¶è¡Œè€Œä¸æ˜¯æ•°æ®å¹¶è¡Œã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#pragma omp parallel sections\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"cp\"\u003e#pragma omp section\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e    \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"cm\"\u003e/* task A */\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"cp\"\u003e#pragma omp section\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e    \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"cm\"\u003e/* task B */\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"4-data-scoping\"\u003e4. Data Scoping\u003c/h2\u003e\n\u003cp\u003eæ•°æ®ä½œç”¨åŸŸå®šä¹‰äº†å¹¶è¡ŒåŒºåŸŸä¸­å˜é‡å¦‚ä½•è¢«çº¿ç¨‹å…±äº«æˆ–è€…ç§æœ‰ï¼ŒOpenMP é€šè¿‡å­å¥ clauses æ¥æ§åˆ¶å˜é‡å±æ€§ã€‚\u003c/p\u003e","title":"OpenMP å…¥é—¨"},{"content":"ç›®å½•æ ‘ æ–‡ä»¶çš„æŠ½è±¡ æ“ä½œç³»ç»Ÿå°†ç‰©ç†å­˜å‚¨è®¾å¤‡ï¼ˆå¦‚ç£ç›˜ï¼‰çš„å¤æ‚æ€§éšè—èµ·æ¥ï¼Œæä¾›äº†ä¸€ä¸ªç®€å•ã€ç»Ÿä¸€çš„æŠ½è±¡â€”â€”æ–‡ä»¶\næ–‡ä»¶å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ç£ç›˜ï¼Œå³ä¸€ä¸ªå‘½åçš„ã€ä¸€ç»´çš„å­—èŠ‚åºåˆ—ï¼Œæ”¯æŒ read, write, lseek ç­‰æ“ä½œ\nè¿™ç§æŠ½è±¡ä½¿å¾—ä¸Šå±‚åº”ç”¨æ— éœ€å…³å¿ƒæ•°æ®åœ¨ç‰©ç†ç£ç›˜ä¸Šçš„å…·ä½“ä½ç½®å’Œå­˜å‚¨æ–¹å¼\nç›®å½•çš„å¼•å…¥ å½“æ–‡ä»¶æ•°é‡å¢å¤šæ—¶ï¼Œéœ€è¦ä¸€ç§æ–¹å¼æ¥ç»„ç»‡å’Œç®¡ç†å®ƒä»¬\næ“ä½œç³»ç»Ÿå¼•å…¥äº†ç›®å½• (Directory) çš„æ¦‚å¿µï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå…¶å†…å®¹æ˜¯å…¶ä»–æ–‡ä»¶æˆ–ç›®å½•çš„åˆ—è¡¨\né€šè¿‡å°†æ–‡ä»¶å’Œç›®å½•ç»„ç»‡æˆä¸€ä¸ªå±‚æ¬¡åŒ–çš„æ ‘çŠ¶ç»“æ„ï¼Œå³ç›®å½•æ ‘ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å¯¹æ–‡ä»¶è¿›è¡Œåˆ†ç±»ã€æŸ¥æ‰¾å’Œç®¡ç†\nå¤šæ•°ç±» Unix ç³»ç»Ÿéµå¾ª FHS (Filesystem Hierarchy Standard) çš„ç›®å½•ç»“æ„çº¦å®šï¼Œä¸ºè½¯ä»¶å’Œç”¨æˆ·é¢„æµ‹æ–‡ä»¶ä½ç½®æä¾›äº†ä¾¿åˆ©\nç›®å½•æ“ä½œ API æ“ä½œç³»ç»Ÿæä¾›äº†ä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨æ¥æ“ä½œç›®å½•æ ‘ï¼Œæ ¸å¿ƒæ“ä½œå›´ç»•â€œå¢åˆ æ”¹æŸ¥â€\nmkdir: åˆ›å»ºä¸€ä¸ªæ–°çš„ç›®å½• rmdir: åˆ é™¤ä¸€ä¸ªç©ºçš„ç›®å½• getdents: è¯»å–ç›®å½•ä¸­çš„æ¡ç›® (directory entries) link / unlink: åˆ›å»ºæˆ–åˆ é™¤æ–‡ä»¶çš„é“¾æ¥ é“¾æ¥ é“¾æ¥æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œå®ƒå…è®¸ä¸€ä¸ªæ–‡ä»¶æ‹¥æœ‰å¤šä¸ªåå­—æˆ–å­˜åœ¨äºç›®å½•æ ‘çš„å¤šä¸ªä½ç½®\né“¾æ¥ä¸»è¦åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šç¡¬é“¾æ¥å’Œè½¯é“¾æ¥ï¼ˆç¬¦å·é“¾æ¥ï¼‰\nç¡¬é“¾æ¥ Hard Link å®šä¹‰ï¼šç¡¬é“¾æ¥æ˜¯è®©å¤šä¸ªç›®å½•æ¡ç›®ï¼ˆæ–‡ä»¶åï¼‰ç›´æ¥æŒ‡å‘ç£ç›˜ä¸ŠåŒä¸€ä¸ªæ–‡ä»¶ç´¢å¼•èŠ‚ç‚¹ (inode)\næ¯ä¸ªæ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ inodeï¼Œå®ƒåŒ…å«äº†æ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆå¦‚æƒé™ã€å¤§å°ã€æ•°æ®å—ä½ç½®ç­‰ï¼‰å’Œæ•°æ®æœ¬èº«\nåˆ›å»ºä¸€ä¸ªç¡¬é“¾æ¥ï¼Œç›¸å½“äºä¸ºåŒä¸€ä¸ª inode å¢åŠ äº†ä¸€ä¸ªæ–°çš„å…¥å£ç‚¹ï¼ˆæ–‡ä»¶åï¼‰\nç‰¹æ€§ï¼š\næ‰€æœ‰æŒ‡å‘åŒä¸€ä¸ª inode çš„ç¡¬é“¾æ¥åœ°ä½å¹³ç­‰ï¼Œæ²¡æœ‰ä¸»æ¬¡ä¹‹åˆ† inode å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªé“¾æ¥è®¡æ•° (reference count), åªæœ‰å½“è¿™ä¸ªè®¡æ•°å‡åˆ° 0 æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿæ‰ä¼šçœŸæ­£åˆ é™¤è¯¥ inode å’Œå¯¹åº”çš„æ•°æ®å—ï¼Œè¿™ä¹Ÿæ˜¯ unlink ç³»ç»Ÿè°ƒç”¨çš„ç”±æ¥ é™åˆ¶ï¼š\nä¸èƒ½ä¸ºç›®å½•åˆ›å»ºç¡¬é“¾æ¥ï¼Œä»¥é˜²æ­¢åœ¨ç›®å½•æ ‘ä¸­äº§ç”Ÿå¾ªç¯ ä¸èƒ½è·¨è¶Šä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå› ä¸º inode å·åªåœ¨å½“å‰æ–‡ä»¶ç³»ç»Ÿå†…å”¯ä¸€ï¼‰ è½¯é“¾æ¥ Symbolic Link å®šä¹‰ï¼šè½¯é“¾æ¥ï¼Œä¹Ÿç§°ç¬¦å·é“¾æ¥ (symlink)ï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå®ƒçš„å†…å®¹æ˜¯å¦ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„è·¯å¾„\nè½¯é“¾æ¥æœ¬èº«æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ inode å’Œæ•°æ®å—ï¼Œå…¶æ•°æ®å—ä¸­å­˜å‚¨çš„æ˜¯ä¸€ä¸ªæ–‡æœ¬å­—ç¬¦ä¸²ï¼Œå³ç›®æ ‡å¯¹è±¡çš„è·¯å¾„åï¼Œå½“è®¿é—®è½¯é“¾æ¥æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šè§£æå…¶å†…å®¹ï¼Œå¹¶å°†è®¿é—®è¯·æ±‚é‡å®šå‘åˆ°å®ƒæ‰€æŒ‡å‘çš„è·¯å¾„\nç‰¹æ€§ï¼š\næå…¶çµæ´»ï¼Œå› ä¸ºå®ƒæœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªè·¯å¾„çš„â€œå¿«æ·æ–¹å¼â€ å¯ä»¥é“¾æ¥åˆ°ç›®å½• å¯ä»¥è·¨è¶Šä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿ å¯ä»¥åˆ›å»ºä¸€ä¸ªâ€œæ‚¬ç©ºâ€çš„é“¾æ¥ (dangling link)ï¼Œå³å®ƒæŒ‡å‘çš„ç›®æ ‡è·¯å¾„å½“å‰å¹¶ä¸å­˜åœ¨ åˆ é™¤è½¯é“¾æ¥æœ¬èº«ï¼Œå¯¹å®ƒæŒ‡å‘çš„åŸå§‹æ–‡ä»¶æ²¡æœ‰ä»»ä½•å½±å“ åº”ç”¨:\nå¸¸ç”¨äºç®¡ç†è½¯ä»¶ç‰ˆæœ¬ï¼Œä¾‹å¦‚è®©ä¸€ä¸ªé€šç”¨çš„å‘½ä»¤ï¼ˆå¦‚ pythonï¼‰æŒ‡å‘ä¸€ä¸ªå…·ä½“çš„ç‰ˆæœ¬æ–‡ä»¶ï¼ˆå¦‚ /usr/bin/python3.9ï¼‰ è¢« NixOS ç­‰ç³»ç»Ÿç”¨æ¥æ„å»ºé«˜åº¦å¯å¤ç°å’Œéš”ç¦»çš„ç¯å¢ƒï¼Œé€šè¿‡å¤§é‡ä½¿ç”¨è½¯é“¾æ¥å°†ä¸åŒç‰ˆæœ¬çš„è½¯ä»¶åŒ…ç»„åˆæˆä¸€ä¸ªè™šæ‹Ÿçš„æ–‡ä»¶ç³»ç»Ÿç»“æ„ æ–‡ä»¶çš„å…ƒæ•°æ® åŸºæœ¬å…ƒæ•°æ® æ–‡ä»¶ä½œä¸ºæ“ä½œç³»ç»Ÿä¸­çš„å¯¹è±¡ï¼Œæ‹¥æœ‰ä¸€ç³»åˆ—çš„å±æ€§ (attributes)ï¼Œè¿™äº›å±æ€§å°±æ˜¯å…ƒæ•°æ® (metadata), ä½ å¯ä»¥é€šè¿‡ ls -l å‘½ä»¤æŸ¥çœ‹æ–‡ä»¶çš„ä¸»è¦å…ƒæ•°æ®ï¼Œè¿™åŒ…æ‹¬æ–‡ä»¶çš„ç±»å‹ã€æ‰€æœ‰è€…ã€å¤§å°ã€ä¿®æ”¹æ—¶é—´ç­‰å…³é”®ä¿¡æ¯\nå…¶ä¸­ï¼Œæ¨¡å¼ (Mode) å­—æ®µå®šä¹‰äº†æ–‡ä»¶çš„è®¿é—®æƒé™ï¼Œå®ƒåˆ†ä¸ºä¸‰ç»„ï¼Œåˆ†åˆ«å¯¹åº”æ‰€æœ‰è€… (owner)ã€æ‰€å±ç»„ (group) å’Œå…¶ä»–ç”¨æˆ· (other)ï¼Œæ¯ç»„éƒ½åŒ…å«è¯» (r)ã€å†™ (w)ã€æ‰§è¡Œ (x) ä¸‰ç§æƒé™\nä¸€ä¸ªå¸¸è§çš„æƒé™ä¾‹å­æ˜¯ 755ï¼Œè¿™æ˜¯ä¸€ä¸ªå…«è¿›åˆ¶æ•°ï¼Œå¸¸ç”¨äºç¨‹åºæˆ–ç›®å½•\nç¬¬ä¸€ä¸ª 7 ä»£è¡¨æ‰€æœ‰è€…æƒé™, 7=4+2+1, æ„å‘³ç€è¯»ã€å†™ã€æ‰§è¡Œ (rwx) æƒé™å…¨å¼€ ç¬¬äºŒä¸ª 5 ä»£è¡¨æ‰€å±ç»„æƒé™, 5=4+0+1, æ„å‘³ç€è¯»ã€æ‰§è¡Œ (r-x) æƒé™ ç¬¬ä¸‰ä¸ª 5 ä»£è¡¨å…¶ä»–ç”¨æˆ·æƒé™, 5=4+0+1, åŒæ ·æ˜¯è¯»ã€æ‰§è¡Œ (r-x) æƒé™ Extended Attributes (xattr) æ‰©å±•å±æ€§ xattr æ˜¯ç°ä»£æ–‡ä»¶ç³»ç»Ÿæä¾›çš„ä¸€é¡¹å¼ºå¤§åŠŸèƒ½ï¼Œå®ƒå…è®¸ä¸ºæ–‡ä»¶é™„åŠ ä¸€ä¸ªçµæ´»çš„ key-value é”®å€¼å¯¹å­—å…¸ï¼Œç”¨äºå­˜å‚¨æ ‡å‡†å…ƒæ•°æ®æ— æ³•è¦†ç›–çš„ä»»æ„ä¿¡æ¯ï¼Œæ“ä½œç³»ç»Ÿæä¾›äº† fsetxattr å’Œ fgetxattr ç­‰ç³»ç»Ÿè°ƒç”¨æ¥æ“ä½œè¿™äº›å±æ€§\nåº”ç”¨ï¼š\nmacOS çš„å®‰å…¨éš”ç¦»æœºåˆ¶å°±æ˜¯ä¸€ä¸ªå…¸å‹ä¾‹å­ï¼Œå½“ä»ç½‘ç»œä¸‹è½½æ–‡ä»¶åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ  com.apple.quarantine å±æ€§ï¼Œè®°å½•ä¸‹è½½æ¥æºï¼ˆURLï¼‰å’Œæ—¶é—´ï¼Œé¦–æ¬¡æ‰“å¼€æ—¶ï¼Œç³»ç»Ÿä¼šæ£€æŸ¥æ­¤å±æ€§å¹¶å‘ç”¨æˆ·å‘å‡ºå®‰å…¨è­¦å‘Š\næ–‡ä»¶å†…å®¹å…ƒä¿¡æ¯: åº”ç”¨ç¨‹åºå¯ä»¥åˆ©ç”¨ xattr å­˜å‚¨ä¸æ–‡ä»¶å†…å®¹ç›¸å…³çš„å…ƒä¿¡æ¯ï¼Œä¾‹å¦‚ï¼Œå›¾ç‰‡æµè§ˆå™¨å¯ä»¥å­˜å‚¨ç…§ç‰‡çš„ EXIF æ•°æ®å‰¯æœ¬ï¼Œæˆ–è€…éŸ³ä¹æ’­æ”¾å™¨å¯ä»¥å­˜å‚¨æ­Œæ›²çš„æ¼”å”±è€…å’Œä¸“è¾‘ä¿¡æ¯ï¼Œä¾¿äºç®¡ç†å’Œæœç´¢ï¼›ç›¸æ¯”äºæ–‡ä»¶ç›®å½•åªèƒ½æŒ‰ç…§æ–‡ä»¶æ ‡é¢˜ç´¢å¼•ï¼Œè¿™ç§ä»¥å†…å®¹ä½œä¸ºç´¢å¼•æ‰æ˜¯ç°ä»£æ–‡ä»¶ç³»ç»Ÿæ›´åˆç†çš„åšæ³•\nç¼ºé™·ï¼šè™½ç„¶ xattr åŠŸèƒ½å¼ºå¤§ï¼Œä½†å®ƒâ€œå¥½ç”¨ä¸ç«â€çš„åŸå› åœ¨äºå…¶å›ºæœ‰çš„ç¼ºé™·\nç¼ºä¹æ ‡å‡†åŒ–ä¸å…¼å®¹æ€§: xattr çš„é”®åæ²¡æœ‰ç»Ÿä¸€æ ‡å‡†ï¼Œä¸åŒåº”ç”¨å’Œç³»ç»Ÿé—´éšæ„å®šä¹‰ï¼Œå¯¼è‡´æ•°æ®éš¾ä»¥äº’é€šï¼Œä¾‹å¦‚ï¼Œcom.apple.quarantine å±æ€§åœ¨ Linux æˆ– Windows ä¸Šæ²¡æœ‰æ„ä¹‰ å·¥å…·æ”¯æŒä¸å®Œå–„: è®¸å¤šç»å…¸çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå¦‚ cp, mv, tar, rsync ç­‰ï¼Œé»˜è®¤ä¸ä¼šå¤„ç†æ‰©å±•å±æ€§ï¼Œåœ¨æ‰§è¡Œæ–‡ä»¶å¤åˆ¶æˆ–æ‰“åŒ…æ—¶ï¼Œè¿™äº›é‡è¦çš„å…ƒæ•°æ®å¯èƒ½ä¼šè¢«é™é»˜ä¸¢å¼ƒï¼Œç”¨æˆ·å¿…é¡»æ˜¾å¼ä½¿ç”¨ç‰¹å®šå‚æ•°ï¼ˆå¦‚ cp --preserve=xattr, rsync -Xï¼‰æ‰èƒ½ä¿ç•™å®ƒä»¬ï¼Œè¿™å¯¹ä¾èµ– xattr çš„ç³»ç»Ÿï¼ˆå¦‚ä½¿ç”¨äº† SELinuxï¼‰å¯èƒ½æ˜¯ç¾éš¾æ€§çš„ å¯è§æ€§ä½: æ‰©å±•å±æ€§å¯¹äºæ™®é€šç”¨æˆ·æ˜¯ä¸å¯è§çš„ï¼Œls -l å‘½ä»¤å¹¶ä¸ä¼šæ˜¾ç¤ºå®ƒä»¬ï¼Œéœ€è¦ä½¿ç”¨ getfattr æˆ– xattr -l ç­‰ä¸“ç”¨å·¥å…·æ‰èƒ½æŸ¥çœ‹ï¼Œè¿™ä½¿å¾—é—®é¢˜æ’æŸ¥å˜å¾—æ›´åŠ å›°éš¾ Access Control List (ACL) ä¼ ç»Ÿçš„ user/group/other æƒé™æ¨¡å‹åœ¨å¤„ç†å¤æ‚çš„å…±äº«éœ€æ±‚æ—¶æ˜¾å¾—åŠ›ä¸ä»å¿ƒï¼Œä¾‹å¦‚éœ€è¦è®©ç”¨æˆ· bob è®¿é—® alice çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œä½† bob ä¸åœ¨ alice çš„ç”¨æˆ·ç»„é‡Œï¼Œè€Œåˆä¸æƒ³æŠŠæ–‡ä»¶æƒé™å¼€æ”¾ç»™æ‰€æœ‰â€œå…¶ä»–ç”¨æˆ·â€ï¼ŒACL å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç±»é—®é¢˜è€Œç”Ÿçš„\nACL æä¾›äº†æ¯”ä¼ ç»Ÿæ¨¡å‹æ›´ç²¾ç»†ã€æ›´çµæ´»çš„è®¿é—®æ§åˆ¶æœºåˆ¶ï¼Œå®ƒå…è®¸ä½ ä¸ºä»»æ„æŒ‡å®šçš„ç”¨æˆ·æˆ–ç”¨æˆ·ç»„è®¾ç½®ç‹¬ç«‹çš„æƒé™\næ–‡ä»¶ç³»ç»Ÿçº§ API ä¸é’ˆå¯¹å•ä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„æ“ä½œä¸åŒï¼Œæ–‡ä»¶ç³»ç»Ÿè¿˜æä¾›äº†ä¸€ç³»åˆ—â€œç³»ç»Ÿçº§â€çš„ APIï¼Œç”¨äºç®¡ç†æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„å’Œè¡Œä¸º\næŒ‚è½½ Mount åœ¨ç±» Unix ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰çš„æ–‡ä»¶å’Œç›®å½•éƒ½ç»„ç»‡åœ¨ä¸€æ£µä»¥æ ¹ç›®å½• / ä¸ºèµ·ç‚¹çš„å·¨å¤§ç›®å½•æ ‘ä¸‹ï¼Œè€Œåœ¨ Windows ä¸­ï¼Œæ–‡ä»¶ç³»ç»Ÿåˆ™åˆ†æ•£åœ¨ä¸åŒçš„â€œç›˜ç¬¦â€ä¸‹ï¼ˆC:ã€D: ç­‰ï¼‰\næŒ‚è½½ (mount) æ˜¯æ„å»ºè¿™æ£µç»Ÿä¸€ç›®å½•æ ‘çš„æ ¸å¿ƒæœºåˆ¶, å®ƒçš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼ˆé€šå¸¸æ¥è‡ªä¸€ä¸ªç‹¬ç«‹çš„å­˜å‚¨è®¾å¤‡ï¼Œå¦‚ç¡¬ç›˜åˆ†åŒºã€U ç›˜æˆ–å…‰ç›˜ï¼‰â€œé™„åŠ â€åˆ°ç°æœ‰ç›®å½•æ ‘çš„ä¸€ä¸ªæŒ‚è½½ç‚¹ (mount point) ä¸Š, æŒ‚è½½ç‚¹æ˜¯ä¸€ä¸ªå·²å­˜åœ¨çš„ç©ºç›®å½•\nä¾‹å¦‚ï¼Œå‘½ä»¤ mount /dev/sdb1 /mnt/data å°±å°† /dev/sdb1 è¿™ä¸ªåˆ†åŒºä¸Šçš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°äº† /mnt/data ç›®å½•, æ­¤åï¼Œå¯¹ /mnt/data ç›®å½•å†…å®¹çš„è®¿é—®ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹ /dev/sdb1 åˆ†åŒºæ ¹ç›®å½•çš„è®¿é—®, æ•´ä¸ª Linux ç³»ç»Ÿçš„æ ¹ç›®å½• / æœ¬èº«ä¹Ÿæ˜¯åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶æŒ‚è½½çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ\nå›ç¯è®¾å¤‡ Loopback Device mount å‘½ä»¤é€šå¸¸æ“ä½œçš„æ˜¯å—è®¾å¤‡ (block device)ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬éœ€è¦æŒ‚è½½ä¸€ä¸ªå­˜åœ¨äºæ–‡ä»¶ä¸­çš„æ–‡ä»¶ç³»ç»Ÿé•œåƒï¼ˆä¾‹å¦‚ä¸€ä¸ª .iso å…‰ç›˜é•œåƒæ–‡ä»¶ï¼‰, æ–‡ä»¶ä¸æ˜¯å—è®¾å¤‡ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥æŒ‚è½½\nä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒLinux æä¾›äº†å›ç¯è®¾å¤‡ (loopback device), è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„å—è®¾å¤‡ï¼Œå®ƒä¸å¯¹åº”ä»»ä½•ç‰©ç†ç¡¬ä»¶ï¼Œè€Œæ˜¯å°†ä¸€ä¸ªæ™®é€šæ–‡ä»¶ä½œä¸ºå…¶åç«¯å­˜å‚¨\nå®ƒçš„å·¥ä½œæµç¨‹å¯ä»¥æƒ³è±¡æˆä¸€ä¸ªé€‚é…å™¨ï¼š\nå°†æ–‡ä»¶é•œåƒä¸ä¸€ä¸ªå›ç¯è®¾å¤‡ï¼ˆå¦‚ /dev/loop0ï¼‰å…³è”èµ·æ¥, è¿™æ—¶ï¼Œæ“ä½œç³»ç»Ÿçœ‹å¾… /dev/loop0 å°±åƒçœ‹å¾…ä¸€ä¸ªçœŸå®çš„ç‰©ç†ç£ç›˜ä¸€æ · å¯¹è¿™ä¸ªå›ç¯è®¾å¤‡æ‰§è¡Œ mount æ“ä½œï¼Œå°†å…¶æŒ‚è½½åˆ°æŒ‡å®šç›®å½• è¿™ä¸ªè¿‡ç¨‹çš„åº•å±‚æ˜¯é€šè¿‡ ioctl ç³»ç»Ÿè°ƒç”¨å®ç°çš„ï¼Œå®ƒå‘ loop é©±åŠ¨å‘é€ LOOP_SET_FD ç­‰å‘½ä»¤ï¼Œå°†æ–‡ä»¶æè¿°ç¬¦ä¸ä¸€ä¸ªç©ºé—²çš„ loop è®¾å¤‡è¿›è¡Œç»‘å®š\nè”åˆæ–‡ä»¶ç³»ç»Ÿ OverlayFS OverlayFS æ˜¯ä¸€ç§å¼ºå¤§çš„è”åˆæ–‡ä»¶ç³»ç»Ÿ (UnionFS)ï¼Œå®ƒå…è®¸å°†å¤šä¸ªä¸åŒçš„ç›®å½•ï¼ˆç§°ä¸ºå±‚ï¼‰â€œå †å â€èµ·æ¥ï¼Œå¯¹å¤–æä¾›ä¸€ä¸ªç»Ÿä¸€çš„ã€åˆå¹¶åçš„è§†å›¾\næˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªéå¸¸å½¢è±¡çš„æ¯”å–»æ¥ç†è§£å®ƒçš„å·¥ä½œåŸç†ï¼š\nåº•å±‚ (lowerdir): æƒ³è±¡ä¸€å¼ å·²ç»å°åˆ·å¥½çš„ã€ä¸å¯ä¿®æ”¹çš„åŸå§‹ç”»ç¨¿, è¿™å°±æ˜¯åªè¯»çš„åº•å±‚, å®ƒå¯ä»¥æœ‰å¾ˆå¤šå¼ ï¼Œå±‚å±‚å æ”¾ ä¸Šå±‚ (upperdir)ï¼šåœ¨åŸå§‹ç”»ç¨¿ä¸Šè¦†ç›–ä¸€å¼ é€æ˜çš„å¡‘æ–™è–„è†œ, è¿™å°±æ˜¯å¯å†™çš„ä¸Šå±‚ åˆå¹¶è§†å›¾ (merged view)ï¼šä½ é€è¿‡è¿™å¼ é€æ˜è–„è†œçœ‹åˆ°çš„æœ€ç»ˆæ™¯è±¡ï¼Œå°±æ˜¯ OverlayFS å‘ˆç°ç»™ä½ çš„ç›®å½• åŸºäºè¿™ä¸ªæ¨¡å‹ï¼Œæ‰€æœ‰æ“ä½œéƒ½å˜å¾—éå¸¸ç›´è§‚ï¼š\nè¯»å–æ–‡ä»¶: å½“ä½ è¯»å–ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œç›¸å½“äºé€è¿‡é€æ˜è–„è†œçœ‹ç”»ç¨¿, å¦‚æœæ–‡ä»¶åªå­˜åœ¨äºåº•å±‚ï¼Œä½ ä¼šç›´æ¥çœ‹åˆ°å®ƒ, å¦‚æœæ–‡ä»¶åœ¨ä¸Šå±‚ä¹Ÿå­˜åœ¨ï¼Œé‚£ä¹ˆä¸Šå±‚çš„ç‰ˆæœ¬ä¼šâ€œé®ç›–â€ä½åº•å±‚çš„ç‰ˆæœ¬\nä¿®æ”¹æ–‡ä»¶ï¼šä½ ä¸èƒ½ç›´æ¥ä¿®æ”¹åŸå§‹ç”»ç¨¿ï¼ˆlowerdirï¼‰ï¼Œå½“ä½ ç¬¬ä¸€æ¬¡å°è¯•ä¿®æ”¹ä¸€ä¸ªæ¥è‡ªåº•å±‚çš„æ–‡ä»¶æ—¶ï¼Œç³»ç»Ÿä¼šå¯åŠ¨å†™æ—¶å¤åˆ¶ (Copy-on-Write) æœºåˆ¶ï¼Œå…ˆæŠŠè¿™ä¸ªæ–‡ä»¶ä»åº•å±‚å¤åˆ¶ä¸€ä»½åˆ°ä¸Šå±‚çš„é€æ˜è–„è†œä¸Šï¼Œç„¶åä½ æ‰€æœ‰çš„ä¿®æ”¹éƒ½å‘ç”Ÿåœ¨è¿™ä»½å¤åˆ¶å“ä¸Š\nåˆ›å»ºæ–‡ä»¶ï¼šè¿™å°±åƒç›´æ¥åœ¨é€æ˜è–„è†œä¸Šç”»æ–°çš„å†…å®¹ï¼Œå®Œå…¨ä¸å½±å“ä¸‹é¢çš„åŸå§‹ç”»ç¨¿\nåˆ é™¤æ–‡ä»¶ï¼šä½ æ— æ³•æ“¦é™¤åŸå§‹ç”»ç¨¿çš„å†…å®¹, å½“ä½ åˆ é™¤ä¸€ä¸ªæ¥è‡ªåº•å±‚çš„æ–‡ä»¶æ—¶ï¼Œç³»ç»Ÿä¼šåœ¨ä¸Šå±‚åˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„â€œç™½ç‚¹â€æ–‡ä»¶ (whiteout)ï¼Œåƒè´´äº†ä¸€å¼ ä¸é€æ˜çš„å°è´´çº¸ï¼Œåˆšå¥½é®ä½åº•å±‚çš„æ–‡ä»¶ï¼Œè®©å®ƒçœ‹èµ·æ¥åƒæ˜¯è¢«åˆ é™¤äº†\nè¿™ç§åˆ†å±‚å’Œå†™æ—¶å¤åˆ¶çš„æœºåˆ¶æ˜¯ Docker ç­‰å®¹å™¨æŠ€æœ¯çš„æ ¸å¿ƒ, å®¹å™¨é•œåƒå°±æ˜¯åªè¯»çš„ lowerdirï¼Œè€Œæ¯ä¸ªè¿è¡Œçš„å®¹å™¨éƒ½æœ‰è‡ªå·±ä¸“å±çš„å¯å†™ upperdirï¼Œè¿™ä½¿å¾—æˆç™¾ä¸Šåƒä¸ªå®¹å™¨å¯ä»¥å…±äº«åŒä¸€ä¸ªåŸºç¡€é•œåƒï¼ŒåŒæ—¶ä¿æŒå„è‡ªçš„éš”ç¦»æ€§ï¼Œæå¤§åœ°èŠ‚çœäº†å­˜å‚¨ç©ºé—´å’Œéƒ¨ç½²æ—¶é—´\næ–‡ä»¶ç³»ç»Ÿå¿«ç…§ Snapshot ä¸€äº›é«˜çº§çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ Btrfs, ZFSï¼‰æˆ–é€»è¾‘å·ç®¡ç†å™¨ï¼ˆLVMï¼‰æ”¯æŒå¿«ç…§ (snapshot) åŠŸèƒ½ï¼Œå®ƒå¯ä»¥åœ¨ç¬é—´â€œå†»ç»“â€å¹¶åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿåœ¨æŸä¸ªæ—¶é—´ç‚¹çš„å®Œæ•´å‰¯æœ¬\nå¿«ç…§çš„å®ç°ä¹Ÿå¸¸å¸¸ä¾èµ–äºå†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼Œåˆ›å»ºå¿«ç…§æ—¶ï¼Œå¹¶ä¸ä¼šç«‹å³å¤åˆ¶æ‰€æœ‰æ•°æ®ï¼Œè€Œåªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæŒ‡å‘å½“å‰æ•°æ®å—çš„æŒ‡é’ˆé›†åˆ, å½“ä¹‹åæœ‰æ•°æ®å—è¢«ä¿®æ”¹æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿä¸ä¼šè¦†ç›–æ—§çš„æ•°æ®å—ï¼Œè€Œæ˜¯å°†ä¿®æ”¹å†™å…¥æ–°çš„ä½ç½®ï¼Œå¹¶è®©æ—§çš„å¿«ç…§æŒ‡é’ˆç»§ç»­æŒ‡å‘æœªä¿®æ”¹çš„æ—§æ•°æ®å—\nè¿™ä¸ªåŠŸèƒ½å¯¹äºç³»ç»Ÿå¤‡ä»½ã€å¿«é€Ÿå›æ»šå’Œåˆ›å»ºå®‰å…¨çš„æµ‹è¯•ç¯å¢ƒéå¸¸æœ‰ç”¨\n","permalink":"https://diefish1024.github.io/posts/class-notes/nju-os-2025/22-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F-api/","summary":"\u003ch2 id=\"ç›®å½•æ ‘\"\u003eç›®å½•æ ‘\u003c/h2\u003e\n\u003ch3 id=\"æ–‡ä»¶çš„æŠ½è±¡\"\u003eæ–‡ä»¶çš„æŠ½è±¡\u003c/h3\u003e\n\u003cp\u003eæ“ä½œç³»ç»Ÿå°†ç‰©ç†å­˜å‚¨è®¾å¤‡ï¼ˆå¦‚ç£ç›˜ï¼‰çš„å¤æ‚æ€§éšè—èµ·æ¥ï¼Œæä¾›äº†ä¸€ä¸ªç®€å•ã€ç»Ÿä¸€çš„æŠ½è±¡â€”â€”\u003cstrong\u003eæ–‡ä»¶\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæ–‡ä»¶å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ª\u003cstrong\u003eè™šæ‹Ÿçš„ç£ç›˜\u003c/strong\u003eï¼Œå³ä¸€ä¸ªå‘½åçš„ã€ä¸€ç»´çš„\u003cstrong\u003eå­—èŠ‚åºåˆ—\u003c/strong\u003eï¼Œæ”¯æŒ \u003ccode\u003eread\u003c/code\u003e, \u003ccode\u003ewrite\u003c/code\u003e, \u003ccode\u003elseek\u003c/code\u003e ç­‰æ“ä½œ\u003c/p\u003e\n\u003cp\u003eè¿™ç§æŠ½è±¡ä½¿å¾—ä¸Šå±‚åº”ç”¨æ— éœ€å…³å¿ƒæ•°æ®åœ¨ç‰©ç†ç£ç›˜ä¸Šçš„å…·ä½“ä½ç½®å’Œå­˜å‚¨æ–¹å¼\u003c/p\u003e\n\u003ch3 id=\"ç›®å½•çš„å¼•å…¥\"\u003eç›®å½•çš„å¼•å…¥\u003c/h3\u003e\n\u003cp\u003eå½“æ–‡ä»¶æ•°é‡å¢å¤šæ—¶ï¼Œéœ€è¦ä¸€ç§æ–¹å¼æ¥ç»„ç»‡å’Œç®¡ç†å®ƒä»¬\u003c/p\u003e\n\u003cp\u003eæ“ä½œç³»ç»Ÿå¼•å…¥äº†\u003cstrong\u003eç›®å½• (Directory)\u003c/strong\u003e çš„æ¦‚å¿µï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå…¶å†…å®¹æ˜¯å…¶ä»–æ–‡ä»¶æˆ–ç›®å½•çš„åˆ—è¡¨\u003c/p\u003e\n\u003cp\u003eé€šè¿‡å°†æ–‡ä»¶å’Œç›®å½•ç»„ç»‡æˆä¸€ä¸ªå±‚æ¬¡åŒ–çš„\u003cstrong\u003eæ ‘çŠ¶ç»“æ„\u003c/strong\u003eï¼Œå³\u003cstrong\u003eç›®å½•æ ‘\u003c/strong\u003eï¼Œå¯ä»¥æ–¹ä¾¿åœ°å¯¹æ–‡ä»¶è¿›è¡Œåˆ†ç±»ã€æŸ¥æ‰¾å’Œç®¡ç†\u003c/p\u003e\n\u003cp\u003eå¤šæ•°ç±» Unix ç³»ç»Ÿéµå¾ª \u003cstrong\u003eFHS (Filesystem Hierarchy Standard)\u003c/strong\u003e çš„ç›®å½•ç»“æ„çº¦å®šï¼Œä¸ºè½¯ä»¶å’Œç”¨æˆ·é¢„æµ‹æ–‡ä»¶ä½ç½®æä¾›äº†ä¾¿åˆ©\u003c/p\u003e\n\u003ch3 id=\"ç›®å½•æ“ä½œ-api\"\u003eç›®å½•æ“ä½œ API\u003c/h3\u003e\n\u003cp\u003eæ“ä½œç³»ç»Ÿæä¾›äº†ä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨æ¥æ“ä½œç›®å½•æ ‘ï¼Œæ ¸å¿ƒæ“ä½œå›´ç»•â€œå¢åˆ æ”¹æŸ¥â€\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003emkdir\u003c/code\u003e: åˆ›å»ºä¸€ä¸ªæ–°çš„ç›®å½•\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ermdir\u003c/code\u003e: åˆ é™¤ä¸€ä¸ªç©ºçš„ç›®å½•\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egetdents\u003c/code\u003e: è¯»å–ç›®å½•ä¸­çš„æ¡ç›® (\u003cstrong\u003ed\u003c/strong\u003eirectory \u003cstrong\u003eent\u003c/strong\u003erie\u003cstrong\u003es\u003c/strong\u003e)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003elink\u003c/code\u003e / \u003ccode\u003eunlink\u003c/code\u003e: åˆ›å»ºæˆ–åˆ é™¤æ–‡ä»¶çš„é“¾æ¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"é“¾æ¥\"\u003eé“¾æ¥\u003c/h3\u003e\n\u003cp\u003eé“¾æ¥æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œå®ƒå…è®¸ä¸€ä¸ªæ–‡ä»¶æ‹¥æœ‰å¤šä¸ªåå­—æˆ–å­˜åœ¨äºç›®å½•æ ‘çš„å¤šä¸ªä½ç½®\u003c/p\u003e\n\u003cp\u003eé“¾æ¥ä¸»è¦åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š\u003cstrong\u003eç¡¬é“¾æ¥\u003c/strong\u003eå’Œ\u003cstrong\u003eè½¯é“¾æ¥ï¼ˆç¬¦å·é“¾æ¥ï¼‰\u003c/strong\u003e\u003c/p\u003e\n\u003ch4 id=\"ç¡¬é“¾æ¥-hard-link\"\u003eç¡¬é“¾æ¥ Hard Link\u003c/h4\u003e\n\u003cp\u003e\u003cstrong\u003eå®šä¹‰\u003c/strong\u003eï¼š\u003cstrong\u003eç¡¬é“¾æ¥\u003c/strong\u003eæ˜¯è®©å¤šä¸ªç›®å½•æ¡ç›®ï¼ˆæ–‡ä»¶åï¼‰ç›´æ¥æŒ‡å‘ç£ç›˜ä¸ŠåŒä¸€ä¸ª\u003cstrong\u003eæ–‡ä»¶ç´¢å¼•èŠ‚ç‚¹ (inode)\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæ¯ä¸ªæ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ \u003ccode\u003einode\u003c/code\u003eï¼Œå®ƒåŒ…å«äº†æ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆå¦‚æƒé™ã€å¤§å°ã€æ•°æ®å—ä½ç½®ç­‰ï¼‰å’Œæ•°æ®æœ¬èº«\u003c/p\u003e\n\u003cp\u003eåˆ›å»ºä¸€ä¸ªç¡¬é“¾æ¥ï¼Œç›¸å½“äºä¸ºåŒä¸€ä¸ª \u003ccode\u003einode\u003c/code\u003e å¢åŠ äº†ä¸€ä¸ªæ–°çš„å…¥å£ç‚¹ï¼ˆæ–‡ä»¶åï¼‰\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eç‰¹æ€§\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ‰€æœ‰æŒ‡å‘åŒä¸€ä¸ª \u003ccode\u003einode\u003c/code\u003e çš„ç¡¬é“¾æ¥åœ°ä½å¹³ç­‰ï¼Œæ²¡æœ‰ä¸»æ¬¡ä¹‹åˆ†\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003einode\u003c/code\u003e å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª\u003cstrong\u003eé“¾æ¥è®¡æ•° (reference count)\u003c/strong\u003e, åªæœ‰å½“è¿™ä¸ªè®¡æ•°å‡åˆ° 0 æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿæ‰ä¼šçœŸæ­£åˆ é™¤è¯¥ \u003ccode\u003einode\u003c/code\u003e å’Œå¯¹åº”çš„æ•°æ®å—ï¼Œè¿™ä¹Ÿæ˜¯ \u003ccode\u003eunlink\u003c/code\u003e ç³»ç»Ÿè°ƒç”¨çš„ç”±æ¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eé™åˆ¶\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eä¸èƒ½ä¸ºç›®å½•åˆ›å»ºç¡¬é“¾æ¥ï¼Œä»¥é˜²æ­¢åœ¨ç›®å½•æ ‘ä¸­äº§ç”Ÿå¾ªç¯\u003c/li\u003e\n\u003cli\u003eä¸èƒ½è·¨è¶Šä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå› ä¸º \u003ccode\u003einode\u003c/code\u003e å·åªåœ¨å½“å‰æ–‡ä»¶ç³»ç»Ÿå†…å”¯ä¸€ï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"è½¯é“¾æ¥-symbolic-link\"\u003eè½¯é“¾æ¥ Symbolic Link\u003c/h4\u003e\n\u003cp\u003e\u003cstrong\u003eå®šä¹‰\u003c/strong\u003eï¼š\u003cstrong\u003eè½¯é“¾æ¥\u003c/strong\u003eï¼Œä¹Ÿç§°\u003cstrong\u003eç¬¦å·é“¾æ¥ (symlink)\u003c/strong\u003eï¼Œæ˜¯ä¸€ä¸ª\u003cstrong\u003eç‰¹æ®Šçš„æ–‡ä»¶\u003c/strong\u003eï¼Œå®ƒçš„å†…å®¹æ˜¯å¦ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„\u003cstrong\u003eè·¯å¾„\u003c/strong\u003e\u003c/p\u003e","title":"22. æ–‡ä»¶ç³»ç»Ÿ API"},{"content":"ç§‘æ™®æ€§è´¨ï¼Œç®€å•è®°å½•ä¸€ä¸‹\n1-Bit çš„å­˜å‚¨ï¼šç£é“ è¦å®ç°â€œæŒä¹…åŒ–â€å­˜å‚¨ï¼Œæ ¸å¿ƒæ˜¯è¦æ‰¾åˆ°ä¸€ä¸ªèƒ½åå¤æ”¹å†™çš„çŠ¶æ€ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°èƒ½å¤Ÿåˆ©ç”¨ç£çš„ç‰¹æ€§ï¼Œè¿™å°±æœ‰äº†ç£å¸¦çš„åˆæ­¥æƒ³æ³•ï¼š\nä¸€ä¸ªé•¿æ¡çš„å¸¦å­ä¸Šé¢å‡åŒ€æœ‰ç£æ€§ç‰©è´¨ å®šä½åˆ°ç‰¹å®šä½ç½®ä¹‹åé€šè¿‡æ”¾å¤§æ„Ÿåº”ç”µæµè¯»å– ç”¨ç”µç£é“æ”¹å˜ç£åŒ–æ–¹å‘æ¥å†™å…¥æ•°æ® ä¸ºäº†æé«˜å­˜å‚¨å¯†åº¦ï¼Œå¯ä»¥æŠŠè¿™æ ·çš„å¸¦å­ç»™å·èµ·æ¥ï¼Œäºæ˜¯å°±å¾—åˆ°äº†ç£å¸¦\nè¿™æ ·çš„å­˜å‚¨æ–¹å¼ä¸»è¦ç¼ºç‚¹æ˜¯å‡ ä¹ä¸èƒ½éšæœºè¯»å†™ï¼ˆæ¯”å¦‚ç£å¸¦æ”¶éŸ³æœºéœ€è¦å€’å¸¦ï¼‰ï¼Œä¸€èˆ¬ç”¨äºå†·æ•°æ®çš„å­˜æ¡£å’Œå¤‡ä»½\nä¸ºäº†è§£å†³è¿™ä¸ªç¼ºç‚¹ï¼Œå¯ä»¥æƒ³åˆ°ç”¨æ—‹è½¬çš„äºŒç»´å¹³é¢æ¥æ›¿ä»£å·èµ·æ¥çš„å¸¦å­ï¼Œè¿™æ ·è¯»å†™å»¶è¿Ÿå°±ä¸ä¼šè¶…è¿‡æ—‹è½¬çš„å‘¨æœŸï¼Œè¿™å°±å¾—åˆ°äº†ç£é¼“ï¼š\nå†åœ¨ç£é¼“çš„åŸºç¡€ä¸Šè¿›ä¸€æ­¥å†…å·ï¼ŒæŠŠç”¨åœ†ç›˜ä»£æ›¿æŸ±é¢ï¼Œä»è€Œå¯ä»¥å †å èµ·æ¥ï¼Œè¿›ä¸€æ­¥æé«˜äº†å­˜å‚¨å¯†åº¦ï¼Œè¿™å°±å¾—åˆ°äº†ç£ç›˜ï¼š\nç£ç›˜ä½œä¸ºå­˜å‚¨è®¾å¤‡çš„éšæœºè¯»å†™æ€§èƒ½è™½ç„¶ç›¸æ¯”ç£å¸¦æœ‰äº†å¾ˆå¤§çš„æ”¹å–„ï¼Œä½†æ˜¯è¿˜æ˜¯éœ€è¦ç­‰å¾…å®šä½åˆ°æ­£ç¡®çš„ä½ç½®ï¼Œæ€§èƒ½ä»ç„¶ä¸å¤Ÿä¼˜ç§€ï¼Œä¸ºäº†è¯»å†™å®šä½åˆ°ä¸€ä¸ªæ‰‡åŒºé€šå¸¸éœ€è¦èŠ±è´¹å‡ ä¸ªæ¯«ç§’çš„æ—¶é—´ï¼Œè¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ç¼“å­˜å’Œè°ƒåº¦ç®—æ³•æ¥ç¼“è§£ï¼Œè®©æ•°æ®å°½å¯èƒ½è¿ç»­å­˜å‚¨\nå½“æˆ‘ä»¬åœ¨ç£ç›˜çš„åŸºç¡€ä¸ŠæŠŠè¯»å†™å¤´å’Œç›˜ç‰‡æœ¬ä½“åˆ†å¼€ï¼Œæˆ‘ä»¬å°±å®ç°äº†æ•°æ®çš„ç§»åŠ¨ï¼Œè¿™ä¹Ÿå°±å¾—åˆ°äº†è½¯ç›˜ï¼Œè¿™æ˜¯ä¸Šä¸ªæ•°æ®æ•°æ®å‘è¡Œçš„ä¸»è¦æ–¹å¼ï¼Œè™½ç„¶æ€§èƒ½å’Œå¯é æ€§éƒ½æ¯”è¾ƒä½ï¼Œä½†æ˜¯èƒœåœ¨äº†ä¾¿æ·ã€å¯ç§»åŠ¨\n1-Bit çš„å­˜å‚¨ï¼šæŒ–å‘ å¤äººå®ç°æŒä¹…åŒ–å­˜å‚¨çš„æ–¹å¼æ˜¯åœ¨çŸ³å¤´ä¸Šåˆ»å­—ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡æŒ–å‘æ¥å­˜å‚¨ä¿¡æ¯ï¼Œè¿™ç§æ–¹å¼å¯ä»¥è·¨è¶Šéå¸¸é•¿çš„æ—¶é—´\nè€Œç°ä»£å·¥ä¸šä½¿æˆ‘ä»¬å¯ä»¥æŒ–å‡ºæ›´åŠ ç²¾ç»†çš„å‘ï¼Œä»è€Œå¯ä»¥å­˜å‚¨æ›´é«˜å¯†åº¦çš„ä¿¡æ¯\nä¸ºäº†è¯»å–è¿™æ ·çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ä»å…‰å­¦çš„è§’åº¦è€ƒè™‘ï¼šåœ¨åå°„å¹³é¢ä¸ŠæŒ–ç²—ç³™å‘ï¼Œæ¿€å…‰æ‰«è¿‡è¡¨é¢ï¼Œåœ¨å¹³é¢ä¼šåå°„å›æ¥ï¼Œåœ¨å‘é‡Œä¼šå‘ç”Ÿæ¼«åå°„ï¼Œäºæ˜¯æˆ‘ä»¬åªè¦æ£€æµ‹æ˜¯å¦æ”¶åˆ°åå°„å…‰å°±å¯ä»¥è¯†åˆ«æ˜¯å‘è¿˜æ˜¯è¡¨é¢ï¼Œè¿™ä¹Ÿå°±æ˜¯å…‰ç›˜\nå…‰ç›˜æœ€æœ‰è¶£çš„ç‰¹æ€§æ˜¯å®¹æ˜“å¤åˆ¶ï¼Œæˆ‘ä»¬è¦åˆ¶é€ å…‰ç›˜å¯ä»¥å…ˆä»”ç»†åœ°åˆ¶é€ ä¸€å¼ åè½¬çš„ç›˜ç‰‡ï¼Œå‘çš„ä½ç½®å¯¹åº”å…¶è¡¨é¢çš„çªèµ·ï¼Œä¹‹ååªéœ€è¦ç›´æ¥ç”¨è¿™ä¸ªç›˜ç‰‡å‹åˆ¶åŠ çƒ­çš„å¡‘æ–™å†é•€ä¸Šåå°„è†œå°±å¯ä»¥å¾—åˆ°ä¸€å¼ å…‰ç›˜ï¼Œè¿™ç§æ–¹å¼å¯ä»¥è¾¾åˆ°æé«˜çš„å†™å…¥é€Ÿåº¦\nå½“ç„¶è¿™ç§æŒ–å‘æ–¹å¼çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§å°±æ˜¯ä¸èƒ½ä¿®æ”¹å·²ç»å†™å…¥çš„å†…å®¹çš„ï¼Œå¾ˆéš¾å¡«ä¸Šä¸€ä¸ªå·²ç»æŒ–äº†çš„å‘ï¼ˆå½“ç„¶é€šè¿‡ç‰¹æ®Šçš„åˆ¶é€ ææ–™å’Œå·¥è‰ºä¹Ÿæ˜¯å¯ä»¥åšåˆ°çš„ï¼‰ï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´é‡Œé¢å­˜å‚¨çš„æ•°æ®æ˜¯ append only çš„ï¼Œæƒ³è¦ä¿®æ”¹ä¹‹å‰çš„å†…å®¹å¯ä»¥é‡‡ç”¨å¯æŒä¹…åŒ–äºŒå‰æ ‘çš„ç»“æ„\nå…‰ç›˜ä½œä¸ºå­˜å‚¨è®¾å¤‡ï¼Œä»·æ ¼ä½çš„åŒæ—¶å®¹é‡å’Œå¯é æ€§éƒ½æ¯”è¾ƒé«˜ï¼ŒåŒæ—¶é¡ºåºè¯»æ€§èƒ½ä¸€èˆ¬ï¼Œéšæœºè¯»æ€§èƒ½ä½å¹¶ä¸”å¾ˆéš¾å†™å…¥ï¼Œä¸€ä¸ªé‡è¦çš„åº”ç”¨å¸¸è§å°±æ˜¯æ•°å­—æ—¶ä»£çš„å†…å®¹åˆ†å‘\nç°ä»£è¿™ç§æŒ–å‘çš„å­˜å‚¨æ–¹å¼è¿˜æœ‰ä¸€ç§åº”ç”¨æ–¹å¼æ˜¯å›å½’å¤äººçŸ³ç¢‘çš„å½¢å¼ï¼ŒæŠŠä¿¡æ¯åˆ»åœ¨å¾ˆç¨³å®šçš„ææ–™ä¸Šæ¥åšåˆ°æ°¸ä¹…å­˜å‚¨\n1-Bit çš„å­˜å‚¨ï¼šç”µè· å‰ä¸¤ç§å­˜å‚¨ä»‹è´¨éƒ½å­˜åœ¨æ¯”è¾ƒå¤§çš„ç¼ºé™·ï¼š\nç£ï¼šä¾èµ–æœºæ¢°éƒ¨ä»¶ï¼Œä»è€Œæ— æ³•é¿å… ms çº§åˆ«çš„å»¶è¿Ÿ å‘ï¼ˆå…‰ï¼‰ï¼šæŒ–å‘æ•ˆç‡ä½ï¼ŒåŒæ—¶å¡«å‘å¾ˆå›°éš¾ è€Œç”µè·åˆ™æ˜¯ä¸€ç§éå¸¸ç†æƒ³çš„å­˜å‚¨ä»‹è´¨ï¼šç”µå­çš„å¯†åº¦æé«˜ï¼Œå¹¶ä¸”ç”µè·¯çš„é€Ÿåº¦æå¿«ï¼ˆè¿˜å¤©ç„¶å¹¶è¡Œï¼‰\nåœ¨ç”µè·¯ä¸­å®ç° 1-bit çš„æŒä¹…å­˜å‚¨ï¼Œä¸€ä¸ªæƒ³æ³•æ˜¯æˆ‘ä»¬å¯ä»¥æŒ–ä¸€ä¸ªå‘ï¼Œä¸¤ç§çŠ¶æ€åˆ†åˆ«æ˜¯ï¼š\nåœ¨å‘é‡Œå¡«å…¥ç”µå­ ä»å‘é‡Œæ”¾è·‘ç”µå­ è€Œè¿™å°±å¾—åˆ°äº†é—ªå­˜ (Flash Memory) ï¼š å…¶ä½œä¸ºå­˜å‚¨è®¾å¤‡ï¼Œä»·æ ¼ä½ï¼Œå®¹é‡å’Œå¯é æ€§é«˜ï¼Œè€Œä¸”è¯»å†™æ€§èƒ½æé«˜ï¼ˆç”±äºç”µè·¯å¤©ç„¶å¹¶è¡Œï¼Œæ‰€ä»¥å®¹é‡è¶Šå¤§ï¼Œé€Ÿåº¦è¶Šå¿«ï¼‰\nç„¶è€Œï¼Œé—ªå­˜çš„ç‰©ç†åŸç†ä¹Ÿå¸¦æ¥äº†å…¶å›ºæœ‰çš„ç¼ºé™·ï¼Œå³ä¼šç£¨æŸ (wear out)\næ¯æ¬¡æ”¾ç”µ (erase) æ“ä½œéƒ½æ— æ³• 100% å°†ç”µå­æ”¾å¹²å‡€ï¼Œè¿™ä¼šå¯¹å­˜å‚¨å•å…ƒé€ æˆå¾®å°çš„ã€ä¸å¯é€†çš„æŸä¼¤ åœ¨ç»å†æ•°åƒæˆ–æ•°ä¸‡æ¬¡æ“¦å†™å¾ªç¯åï¼Œä¸€äº›å­˜å‚¨å•å…ƒä¼šå› ä¸ºç´¯ç§¯çš„æŸä¼¤è€Œå¤±æ•ˆï¼Œæ— æ³•å†å¯é åœ°å­˜å‚¨æ•°æ®ï¼Œè¿™è¢«ç§°ä¸º â€œæ­»å•å…ƒ (Dead Cell)â€ ä¸ºäº†è§£å†³é—ªå­˜çš„ç£¨æŸé—®é¢˜ï¼Œå¹¶å°†å…¶æ›´å¥½åœ°å‘ˆç°ç»™æ“ä½œç³»ç»Ÿï¼Œç°ä»£å›ºæ€å­˜å‚¨è®¾å¤‡ï¼ˆå¦‚ SSDã€U ç›˜ã€SD å¡ï¼‰å†…éƒ¨å®é™…ä¸Šéƒ½é›†æˆäº†ä¸€ä¸ªå¾®å‹è®¡ç®—æœºç³»ç»Ÿ\nè¿™ä¸ªç³»ç»Ÿè¿è¡Œç€ä¸€å±‚è¢«ç§°ä¸º FTL (Flash Translation Layer) çš„å›ºä»¶ï¼Œå®ƒçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€æ˜¯ ç£¨æŸå‡è¡¡ (Wear Leveling)\nFTL ä¼šè®°å½•æ¯ä¸ªç‰©ç†å—çš„æ“¦å†™æ¬¡æ•°ï¼Œå½“æ“ä½œç³»ç»Ÿè¯·æ±‚å†™å…¥æŸä¸ªé€»è¾‘åœ°å€æ—¶ï¼ŒFTL ä¼šé¿å…æ€»æ˜¯å†™å…¥åŒä¸€ä¸ªç‰©ç†å—ï¼Œè€Œæ˜¯å°†å†™å…¥è¯·æ±‚é‡å®šå‘åˆ°ä¸€ä¸ªè¾ƒå°‘è¢«ä½¿ç”¨çš„ç‰©ç†å—ä¸Šï¼Œè¿™ç§æœºåˆ¶ç±»ä¼¼äºæ“ä½œç³»ç»Ÿä¸­çš„è™šæ‹Ÿå†…å­˜ï¼Œé€šè¿‡å¼•å…¥ä¸€ä¸ªé—´æ¥å±‚ï¼ˆé€»è¾‘åœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ï¼‰æ¥éšè—åº•å±‚ç¡¬ä»¶çš„å¤æ‚æ€§å¹¶ä¼˜åŒ–å…¶ä½¿ç”¨å¯¿å‘½\nè¿™ä¹Ÿæ„å‘³ç€ï¼Œå³ä¾¿æ˜¯ä¾¿å®œçš„ U ç›˜ æˆ– SD å¡ï¼Œå…¶å†…éƒ¨ä¹Ÿå¯èƒ½åŒ…å«ä¸€ä¸ª ARM èŠ¯ç‰‡æ¥è¿è¡Œ FTLï¼Œè€Œé«˜æ€§èƒ½çš„ SSD åˆ™æ‹¥æœ‰æ›´å¼ºå¤§çš„å¤„ç†å™¨ã€ç¼“å­˜å’Œæ›´å¤æ‚çš„ FTL ç®—æ³•ï¼Œä»è€Œæä¾›æ›´é•¿çš„å¯¿å‘½å’Œæ›´é«˜çš„æ€§èƒ½\nè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸åº”è¯¥è´­ä¹°è¿‡äºå»‰ä»·çš„ U ç›˜ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½ä¼šåœ¨ FTL ä¸Šå·å·¥å‡æ–™ï¼Œç”šè‡³ä¼ªé€ å®¹é‡å’Œå‚å•†ä¿¡æ¯ï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤±\nå­˜å‚¨è®¾å¤‡ä¸æ“ä½œç³»ç»Ÿ å—è®¾å¤‡æŠ½è±¡ æ— è®ºæ˜¯æ—‹è½¬çš„ç£ç›˜è¿˜æ˜¯é—ªå­˜èŠ¯ç‰‡ï¼Œå®ƒä»¬éƒ½ä¸é€‚åˆä»¥å•ä¸ªå­—èŠ‚ä¸ºå•ä½è¿›è¡Œå¯»å€ï¼Œå› ä¸ºå®šä½å’Œå…ƒæ•°æ®ï¼ˆå¦‚æ‰‡åŒºå¤´ã€ECC æ ¡éªŒç ï¼‰çš„å¼€é”€å¤ªå¤§\nå› æ­¤ï¼Œå­˜å‚¨è®¾å¤‡å°†å®ƒä»¬çš„å­˜å‚¨ç©ºé—´åˆ’åˆ†ä¸ºå›ºå®šå¤§å°çš„å— (Block)ï¼Œå¹¶ä»¥å—ä¸ºå•ä½è¿›è¡Œè¯»å†™ï¼Œè¿™å¤§å¤§æ‘Šé”€äº†å•æ¬¡ I/O æ“ä½œçš„å¼€é”€ï¼Œè¿™äº›è®¾å¤‡åœ¨æ“ä½œç³»ç»Ÿä¸­è¢«ç§°ä¸ºå—è®¾å¤‡ (Block Devices)\næ“ä½œç³»ç»Ÿçœ‹åˆ°çš„æ˜¯ä¸€ä¸ªçº¿æ€§çš„ã€ä» 0 å¼€å§‹ç¼–å·çš„å—æ•°ç»„ struct block disk[NUM_BLOCKS]ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥åƒè¯»å†™æ–‡ä»¶ä¸€æ ·è¯»å†™å—è®¾å¤‡ï¼ˆä¾‹å¦‚ /dev/sdaï¼‰ï¼Œä½†è¿™æ ·åšçš„æ•ˆç‡å¾ˆä½ï¼Œå¦‚æœéšæœºè¯»å†™ä¸€ä¸ªå­—èŠ‚ï¼Œæ“ä½œç³»ç»Ÿå’Œè®¾å¤‡ç¡¬ä»¶æœ€ç»ˆå¯èƒ½ä¼šè¯»å–æˆ–å†™å…¥æ•´ä¸ªå—ï¼Œå¯¼è‡´è¯»/å†™æ”¾å¤§ (read/write amplification) çš„é—®é¢˜ï¼Œå› æ­¤ï¼Œä¸Šå±‚çš„æ–‡ä»¶ç³»ç»Ÿè¢«è®¾è®¡ä¸ºèƒ½å¤Ÿæ„ŸçŸ¥â€œå—â€çš„å­˜åœ¨ï¼Œå¹¶ä»¥å—ä¸ºå•ä½æ¥ç»„ç»‡å’Œç®¡ç†æ•°æ®\nä¸ºäº†é«˜æ•ˆåœ°ç®¡ç†å¯¹å—è®¾å¤‡çš„è®¿é—®ï¼Œæ“ä½œç³»ç»Ÿæä¾›äº†ä¸€ä¸ªä¸“é—¨çš„ I/O æ ˆ\nåœ¨ Linux ä¸­ï¼Œä¸Šå±‚æ–‡ä»¶ç³»ç»Ÿæˆ–åº”ç”¨ç¨‹åºé€šè¿‡å— I/O (Bio) å±‚æäº¤è¯·æ±‚ï¼ŒBio å±‚æä¾›äº†ä¸€ä¸ªè¯·æ±‚/å“åº”æ¥å£ï¼Œå®ƒå°†ä¸Šå±‚çš„è¯»å†™è¯·æ±‚å°è£…æˆ struct bio ç»“æ„ä½“ï¼Œè¿™äº›è¯·æ±‚è¢«æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾… I/O è°ƒåº¦å™¨ (I/O Scheduler) è¿›è¡Œå¤„ç†ï¼Œè°ƒåº¦å™¨ä¼šæ ¹æ®ç­–ç•¥ï¼ˆä¾‹å¦‚åˆå¹¶ç›¸é‚»çš„è¯·æ±‚ã€æ’åºè¯·æ±‚ä»¥å‡å°‘ç£å¤´å¯»é“æ—¶é—´ï¼‰æ¥ä¼˜åŒ–é˜Ÿåˆ—\nç°ä»£ Linux å†…æ ¸ä½¿ç”¨å¤šé˜Ÿåˆ—å— I/O (Multi-queue block I/O, blk-mq) æœºåˆ¶ï¼Œä¸ºæ¯ä¸ª CPU æ ¸å¿ƒ åˆ†é…ç‹¬ç«‹çš„è¯·æ±‚é˜Ÿåˆ—ï¼Œå……åˆ†åˆ©ç”¨äº†ç°ä»£å¤šæ ¸å¤„ç†å™¨å’Œé«˜é€Ÿ SSD çš„å¹¶è¡Œæ€§\næœ€ç»ˆï¼Œç”±è®¾å¤‡é©±åŠ¨ç¨‹åºå°†å¤„ç†å¥½çš„è¯·æ±‚å‘é€ç»™ç¡¬ä»¶æ‰§è¡Œ\n","permalink":"https://diefish1024.github.io/posts/class-notes/nju-os-2025/21-%E5%AD%98%E5%82%A8%E8%AE%BE%E5%A4%87%E5%8E%9F%E7%90%86/","summary":"\u003cp\u003eç§‘æ™®æ€§è´¨ï¼Œç®€å•è®°å½•ä¸€ä¸‹\u003c/p\u003e\n\u003ch2 id=\"1-bit-çš„å­˜å‚¨ç£é“\"\u003e1-Bit çš„å­˜å‚¨ï¼šç£é“\u003c/h2\u003e\n\u003cp\u003eè¦å®ç°â€œæŒä¹…åŒ–â€å­˜å‚¨ï¼Œæ ¸å¿ƒæ˜¯è¦æ‰¾åˆ°ä¸€ä¸ªèƒ½åå¤æ”¹å†™çš„çŠ¶æ€ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°èƒ½å¤Ÿåˆ©ç”¨ç£çš„ç‰¹æ€§ï¼Œè¿™å°±æœ‰äº†ç£å¸¦çš„åˆæ­¥æƒ³æ³•ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eä¸€ä¸ªé•¿æ¡çš„å¸¦å­ä¸Šé¢å‡åŒ€æœ‰ç£æ€§ç‰©è´¨\u003c/li\u003e\n\u003cli\u003eå®šä½åˆ°ç‰¹å®šä½ç½®ä¹‹åé€šè¿‡æ”¾å¤§æ„Ÿåº”ç”µæµè¯»å–\u003c/li\u003e\n\u003cli\u003eç”¨ç”µç£é“æ”¹å˜ç£åŒ–æ–¹å‘æ¥å†™å…¥æ•°æ®\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä¸ºäº†æé«˜å­˜å‚¨å¯†åº¦ï¼Œå¯ä»¥æŠŠè¿™æ ·çš„å¸¦å­ç»™å·èµ·æ¥ï¼Œäºæ˜¯å°±å¾—åˆ°äº†ç£å¸¦\u003c/p\u003e\n\u003cp\u003eè¿™æ ·çš„å­˜å‚¨æ–¹å¼ä¸»è¦ç¼ºç‚¹æ˜¯\u003cstrong\u003eå‡ ä¹ä¸èƒ½éšæœºè¯»å†™\u003c/strong\u003eï¼ˆæ¯”å¦‚ç£å¸¦æ”¶éŸ³æœºéœ€è¦å€’å¸¦ï¼‰ï¼Œä¸€èˆ¬ç”¨äºå†·æ•°æ®çš„å­˜æ¡£å’Œå¤‡ä»½\u003c/p\u003e\n\u003cp\u003eä¸ºäº†è§£å†³è¿™ä¸ªç¼ºç‚¹ï¼Œå¯ä»¥æƒ³åˆ°ç”¨æ—‹è½¬çš„äºŒç»´å¹³é¢æ¥æ›¿ä»£å·èµ·æ¥çš„å¸¦å­ï¼Œè¿™æ ·è¯»å†™å»¶è¿Ÿå°±ä¸ä¼šè¶…è¿‡æ—‹è½¬çš„å‘¨æœŸï¼Œè¿™å°±å¾—åˆ°äº†\u003cstrong\u003eç£é¼“\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/images/21-%E5%AD%98%E5%82%A8%E8%AE%BE%E5%A4%87%E5%8E%9F%E7%90%86/pasted-image-20250805012735.png\"\u003e\u003c/p\u003e\n\u003cp\u003eå†åœ¨ç£é¼“çš„åŸºç¡€ä¸Šè¿›ä¸€æ­¥å†…å·ï¼ŒæŠŠç”¨åœ†ç›˜ä»£æ›¿æŸ±é¢ï¼Œä»è€Œå¯ä»¥å †å èµ·æ¥ï¼Œè¿›ä¸€æ­¥æé«˜äº†å­˜å‚¨å¯†åº¦ï¼Œè¿™å°±å¾—åˆ°äº†\u003cstrong\u003eç£ç›˜\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"/images/21-%E5%AD%98%E5%82%A8%E8%AE%BE%E5%A4%87%E5%8E%9F%E7%90%86/pasted-image-20250805012958.png\"\u003e\u003c/p\u003e\n\u003cp\u003eç£ç›˜ä½œä¸ºå­˜å‚¨è®¾å¤‡çš„éšæœºè¯»å†™æ€§èƒ½è™½ç„¶ç›¸æ¯”ç£å¸¦æœ‰äº†å¾ˆå¤§çš„æ”¹å–„ï¼Œä½†æ˜¯è¿˜æ˜¯éœ€è¦ç­‰å¾…å®šä½åˆ°æ­£ç¡®çš„ä½ç½®ï¼Œæ€§èƒ½ä»ç„¶ä¸å¤Ÿä¼˜ç§€ï¼Œä¸ºäº†è¯»å†™å®šä½åˆ°ä¸€ä¸ªæ‰‡åŒºé€šå¸¸éœ€è¦èŠ±è´¹å‡ ä¸ªæ¯«ç§’çš„æ—¶é—´ï¼Œè¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ç¼“å­˜å’Œè°ƒåº¦ç®—æ³•æ¥ç¼“è§£ï¼Œè®©æ•°æ®å°½å¯èƒ½è¿ç»­å­˜å‚¨\u003c/p\u003e\n\u003cp\u003eå½“æˆ‘ä»¬åœ¨ç£ç›˜çš„åŸºç¡€ä¸ŠæŠŠè¯»å†™å¤´å’Œç›˜ç‰‡æœ¬ä½“åˆ†å¼€ï¼Œæˆ‘ä»¬å°±å®ç°äº†æ•°æ®çš„ç§»åŠ¨ï¼Œè¿™ä¹Ÿå°±å¾—åˆ°äº†\u003cstrong\u003eè½¯ç›˜\u003c/strong\u003eï¼Œè¿™æ˜¯ä¸Šä¸ªæ•°æ®æ•°æ®å‘è¡Œçš„ä¸»è¦æ–¹å¼ï¼Œè™½ç„¶æ€§èƒ½å’Œå¯é æ€§éƒ½æ¯”è¾ƒä½ï¼Œä½†æ˜¯èƒœåœ¨äº†ä¾¿æ·ã€å¯ç§»åŠ¨\u003c/p\u003e\n\u003ch2 id=\"1-bit-çš„å­˜å‚¨æŒ–å‘\"\u003e1-Bit çš„å­˜å‚¨ï¼šæŒ–å‘\u003c/h2\u003e\n\u003cp\u003eå¤äººå®ç°æŒä¹…åŒ–å­˜å‚¨çš„æ–¹å¼æ˜¯åœ¨çŸ³å¤´ä¸Šåˆ»å­—ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡æŒ–å‘æ¥å­˜å‚¨ä¿¡æ¯ï¼Œè¿™ç§æ–¹å¼å¯ä»¥è·¨è¶Šéå¸¸é•¿çš„æ—¶é—´\u003c/p\u003e\n\u003cp\u003eè€Œç°ä»£å·¥ä¸šä½¿æˆ‘ä»¬å¯ä»¥æŒ–å‡ºæ›´åŠ ç²¾ç»†çš„å‘ï¼Œä»è€Œå¯ä»¥å­˜å‚¨æ›´é«˜å¯†åº¦çš„ä¿¡æ¯\u003c/p\u003e\n\u003cp\u003eä¸ºäº†è¯»å–è¿™æ ·çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ä»å…‰å­¦çš„è§’åº¦è€ƒè™‘ï¼šåœ¨åå°„å¹³é¢ä¸ŠæŒ–ç²—ç³™å‘ï¼Œæ¿€å…‰æ‰«è¿‡è¡¨é¢ï¼Œåœ¨å¹³é¢ä¼šåå°„å›æ¥ï¼Œåœ¨å‘é‡Œä¼šå‘ç”Ÿæ¼«åå°„ï¼Œäºæ˜¯æˆ‘ä»¬åªè¦æ£€æµ‹æ˜¯å¦æ”¶åˆ°åå°„å…‰å°±å¯ä»¥è¯†åˆ«æ˜¯å‘è¿˜æ˜¯è¡¨é¢ï¼Œè¿™ä¹Ÿå°±æ˜¯\u003cstrong\u003eå…‰ç›˜\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå…‰ç›˜æœ€æœ‰è¶£çš„ç‰¹æ€§æ˜¯å®¹æ˜“å¤åˆ¶ï¼Œæˆ‘ä»¬è¦åˆ¶é€ å…‰ç›˜å¯ä»¥å…ˆä»”ç»†åœ°åˆ¶é€ ä¸€å¼ åè½¬çš„ç›˜ç‰‡ï¼Œå‘çš„ä½ç½®å¯¹åº”å…¶è¡¨é¢çš„çªèµ·ï¼Œä¹‹ååªéœ€è¦ç›´æ¥ç”¨è¿™ä¸ªç›˜ç‰‡å‹åˆ¶åŠ çƒ­çš„å¡‘æ–™å†é•€ä¸Šåå°„è†œå°±å¯ä»¥å¾—åˆ°ä¸€å¼ å…‰ç›˜ï¼Œè¿™ç§æ–¹å¼å¯ä»¥è¾¾åˆ°æé«˜çš„å†™å…¥é€Ÿåº¦\u003c/p\u003e\n\u003cp\u003eå½“ç„¶è¿™ç§æŒ–å‘æ–¹å¼çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§å°±æ˜¯ä¸èƒ½ä¿®æ”¹å·²ç»å†™å…¥çš„å†…å®¹çš„ï¼Œå¾ˆéš¾å¡«ä¸Šä¸€ä¸ªå·²ç»æŒ–äº†çš„å‘ï¼ˆå½“ç„¶é€šè¿‡ç‰¹æ®Šçš„åˆ¶é€ ææ–™å’Œå·¥è‰ºä¹Ÿæ˜¯å¯ä»¥åšåˆ°çš„ï¼‰ï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´é‡Œé¢å­˜å‚¨çš„æ•°æ®æ˜¯ append only çš„ï¼Œæƒ³è¦ä¿®æ”¹ä¹‹å‰çš„å†…å®¹å¯ä»¥é‡‡ç”¨å¯æŒä¹…åŒ–äºŒå‰æ ‘çš„ç»“æ„\u003c/p\u003e\n\u003cp\u003eå…‰ç›˜ä½œä¸ºå­˜å‚¨è®¾å¤‡ï¼Œä»·æ ¼ä½çš„åŒæ—¶å®¹é‡å’Œå¯é æ€§éƒ½æ¯”è¾ƒé«˜ï¼ŒåŒæ—¶é¡ºåºè¯»æ€§èƒ½ä¸€èˆ¬ï¼Œéšæœºè¯»æ€§èƒ½ä½å¹¶ä¸”å¾ˆéš¾å†™å…¥ï¼Œä¸€ä¸ªé‡è¦çš„åº”ç”¨å¸¸è§å°±æ˜¯æ•°å­—æ—¶ä»£çš„å†…å®¹åˆ†å‘\u003c/p\u003e\n\u003cp\u003eç°ä»£è¿™ç§æŒ–å‘çš„å­˜å‚¨æ–¹å¼è¿˜æœ‰ä¸€ç§åº”ç”¨æ–¹å¼æ˜¯å›å½’å¤äººçŸ³ç¢‘çš„å½¢å¼ï¼ŒæŠŠä¿¡æ¯åˆ»åœ¨å¾ˆç¨³å®šçš„ææ–™ä¸Šæ¥åšåˆ°æ°¸ä¹…å­˜å‚¨\u003c/p\u003e\n\u003ch2 id=\"1-bit-çš„å­˜å‚¨ç”µè·\"\u003e1-Bit çš„å­˜å‚¨ï¼šç”µè·\u003c/h2\u003e\n\u003cp\u003eå‰ä¸¤ç§å­˜å‚¨ä»‹è´¨éƒ½å­˜åœ¨æ¯”è¾ƒå¤§çš„ç¼ºé™·ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eç£ï¼šä¾èµ–æœºæ¢°éƒ¨ä»¶ï¼Œä»è€Œæ— æ³•é¿å… ms çº§åˆ«çš„å»¶è¿Ÿ\u003c/li\u003e\n\u003cli\u003eå‘ï¼ˆå…‰ï¼‰ï¼šæŒ–å‘æ•ˆç‡ä½ï¼ŒåŒæ—¶å¡«å‘å¾ˆå›°éš¾\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè€Œç”µè·åˆ™æ˜¯ä¸€ç§éå¸¸ç†æƒ³çš„å­˜å‚¨ä»‹è´¨ï¼šç”µå­çš„å¯†åº¦æé«˜ï¼Œå¹¶ä¸”ç”µè·¯çš„é€Ÿåº¦æå¿«ï¼ˆè¿˜å¤©ç„¶å¹¶è¡Œï¼‰\u003c/p\u003e\n\u003cp\u003eåœ¨ç”µè·¯ä¸­å®ç° 1-bit çš„æŒä¹…å­˜å‚¨ï¼Œä¸€ä¸ªæƒ³æ³•æ˜¯æˆ‘ä»¬å¯ä»¥æŒ–ä¸€ä¸ªå‘ï¼Œä¸¤ç§çŠ¶æ€åˆ†åˆ«æ˜¯ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåœ¨å‘é‡Œå¡«å…¥ç”µå­\u003c/li\u003e\n\u003cli\u003eä»å‘é‡Œæ”¾è·‘ç”µå­\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè€Œè¿™å°±å¾—åˆ°äº†\u003cstrong\u003eé—ªå­˜ (Flash Memory)\u003c/strong\u003e ï¼š\n\u003cimg loading=\"lazy\" src=\"/images/21-%E5%AD%98%E5%82%A8%E8%AE%BE%E5%A4%87%E5%8E%9F%E7%90%86/pasted-image-20250805112704.png\"\u003e\nå…¶ä½œä¸ºå­˜å‚¨è®¾å¤‡ï¼Œä»·æ ¼ä½ï¼Œå®¹é‡å’Œå¯é æ€§é«˜ï¼Œè€Œä¸”è¯»å†™æ€§èƒ½æé«˜ï¼ˆç”±äºç”µè·¯å¤©ç„¶å¹¶è¡Œï¼Œæ‰€ä»¥å®¹é‡è¶Šå¤§ï¼Œé€Ÿåº¦è¶Šå¿«ï¼‰\u003c/p\u003e\n\u003cp\u003eç„¶è€Œï¼Œé—ªå­˜çš„ç‰©ç†åŸç†ä¹Ÿå¸¦æ¥äº†å…¶å›ºæœ‰çš„ç¼ºé™·ï¼Œå³\u003cstrong\u003eä¼šç£¨æŸ (wear out)\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ¯æ¬¡æ”¾ç”µ (erase) æ“ä½œéƒ½æ— æ³• 100% å°†ç”µå­æ”¾å¹²å‡€ï¼Œè¿™ä¼šå¯¹å­˜å‚¨å•å…ƒé€ æˆå¾®å°çš„ã€ä¸å¯é€†çš„æŸä¼¤\u003c/li\u003e\n\u003cli\u003eåœ¨ç»å†æ•°åƒæˆ–æ•°ä¸‡æ¬¡æ“¦å†™å¾ªç¯åï¼Œä¸€äº›å­˜å‚¨å•å…ƒä¼šå› ä¸ºç´¯ç§¯çš„æŸä¼¤è€Œå¤±æ•ˆï¼Œæ— æ³•å†å¯é åœ°å­˜å‚¨æ•°æ®ï¼Œè¿™è¢«ç§°ä¸º â€œ\u003cstrong\u003eæ­»å•å…ƒ (Dead Cell)\u003c/strong\u003eâ€\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä¸ºäº†è§£å†³é—ªå­˜çš„ç£¨æŸé—®é¢˜ï¼Œå¹¶å°†å…¶æ›´å¥½åœ°å‘ˆç°ç»™æ“ä½œç³»ç»Ÿï¼Œç°ä»£å›ºæ€å­˜å‚¨è®¾å¤‡ï¼ˆå¦‚ SSDã€U ç›˜ã€SD å¡ï¼‰å†…éƒ¨å®é™…ä¸Šéƒ½é›†æˆäº†ä¸€ä¸ªå¾®å‹è®¡ç®—æœºç³»ç»Ÿ\u003c/p\u003e\n\u003cp\u003eè¿™ä¸ªç³»ç»Ÿè¿è¡Œç€ä¸€å±‚è¢«ç§°ä¸º \u003cstrong\u003eFTL (Flash Translation Layer)\u003c/strong\u003e çš„å›ºä»¶ï¼Œå®ƒçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€æ˜¯ \u003cstrong\u003eç£¨æŸå‡è¡¡ (Wear Leveling)\u003c/strong\u003e\u003c/p\u003e","title":"21. å­˜å‚¨è®¾å¤‡åŸç†"},{"content":"è¾“å…¥è¾“å‡ºè®¾å¤‡ Everything is a File åœ¨ Unix-like ç³»ç»Ÿä¸­ï¼Œä¸å¤–éƒ¨è®¾å¤‡äº¤äº’çš„æ ¸å¿ƒæ€æƒ³æ˜¯ Everything is a File\næ–‡ä»¶æè¿°ç¬¦ (File Descriptor)ï¼šæ“ä½œç³»ç»Ÿä¸ºä¸Šå±‚è½¯ä»¶æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æŠ½è±¡ï¼Œå³æ–‡ä»¶æè¿°ç¬¦ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘å†…æ ¸ä¸­ä»»ä½• I/O å¯¹è±¡çš„â€œæŒ‡é’ˆâ€æˆ–å¥æŸ„\nç»Ÿä¸€æ¥å£ï¼šæ— è®ºæ˜¯æ™®é€šæ–‡ä»¶ã€ç¡¬ä»¶è®¾å¤‡ï¼ˆå¦‚ç»ˆç«¯ã€ç£ç›˜ï¼‰ã€è¿˜æ˜¯ç½‘ç»œè¿æ¥ï¼Œéƒ½å¯ä»¥é€šè¿‡ open è·å¾—ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶åä½¿ç”¨ç›¸åŒçš„ read/write ç­‰ç³»ç»Ÿè°ƒç”¨æ¥è¿›è¡Œæ“ä½œï¼Œè¿™æå¤§åœ°ç®€åŒ–äº†åº”ç”¨ç¨‹åºçš„ç¼–å†™\nè®¾å¤‡æ§åˆ¶å™¨ä¸ MMIO â€œæ–‡ä»¶â€è¿™ä¸ªç¾å¥½çš„æŠ½è±¡èƒŒåï¼Œæ˜¯å…·ä½“çš„ç¡¬ä»¶å·¥ä½œåŸç†\nè®¾å¤‡æ§åˆ¶å™¨ (Device Controller)ï¼šæ¯ä¸ª I/O è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å« CPUã€å†…å­˜å’Œå¯„å­˜å™¨çš„å¾®å‹è®¡ç®—æœºï¼Œä½œä¸º CPU å’Œç‰©ç†è®¾å¤‡ä¹‹é—´çš„æ¡¥æ¢\nè®¾å¤‡å¯„å­˜å™¨ï¼šæ§åˆ¶å™¨é€šè¿‡ä¸€ç»„å¯„å­˜å™¨ä¸ CPU é€šä¿¡ï¼Œé€šå¸¸åŒ…æ‹¬ï¼š\nçŠ¶æ€å¯„å­˜å™¨ï¼šç”¨äºè¡¨ç¤ºè®¾å¤‡å½“å‰æ˜¯å¦ç¹å¿™ã€æ˜¯å¦å‡†å¤‡å¥½ç­‰ æŒ‡ä»¤å¯„å­˜å™¨ï¼šCPU å†™å…¥æŒ‡ä»¤ï¼Œå‘Šè¯‰è®¾å¤‡è¦åšä»€ä¹ˆ æ•°æ®å¯„å­˜å™¨ï¼šç”¨äºåœ¨ CPU å’Œè®¾å¤‡ä¹‹é—´ä¼ è¾“æ•°æ® å†…å­˜æ˜ å°„ I/O (MMIO)ï¼šä¸ºäº†è®© CPU èƒ½è®¿é—®è¿™äº›å¯„å­˜å™¨ï¼Œç°ä»£ç³»ç»Ÿæ™®éé‡‡ç”¨ MMIO (Memory-Mapped I/O)ï¼Œæ“ä½œç³»ç»Ÿä¼šå°†è®¾å¤‡çš„å¯„å­˜å™¨æ˜ å°„åˆ°ç‰©ç†å†…å­˜åœ°å€ç©ºé—´ä¸­çš„ç‰¹å®šåŒºåŸŸï¼Œè¿™æ ·ä¸€æ¥ï¼ŒCPU å°±å¯ä»¥åƒè®¿é—®æ™®é€šå†…å­˜ä¸€æ ·ï¼Œä½¿ç”¨æ ‡å‡†çš„ load/store æŒ‡ä»¤æ¥è¯»å†™è®¾å¤‡å¯„å­˜å™¨ï¼Œä»è€Œå®ç°å¯¹è®¾å¤‡çš„æ§åˆ¶\nGPIO GPIO (General-Purpose Input/Output) æ˜¯ç†è§£ I/O è®¾å¤‡åŸç†æœ€ç›´è§‚çš„ä¾‹å­ï¼ŒGPIO å°±æ˜¯ä¸€ä¸ªç‰©ç†å¼•è„šï¼Œå¯ä»¥é€šè¿‡ç¼–ç¨‹è®¾ç½®ä¸ºè¾“å…¥æˆ–è¾“å‡ºæ¨¡å¼\né€šè¿‡ MMIOï¼Œä¸€ä¸ª GPIO å¼•è„šçš„ç”µå¹³çŠ¶æ€è¢«æ˜ å°„åˆ°ä¸€ä¸ªç‰¹å®šçš„å†…å­˜åœ°å€ï¼Œå½“ CPU å‘è¿™ä¸ªåœ°å€å†™å…¥ 1 æ—¶ï¼Œå¼•è„šå°±å˜ä¸ºé«˜ç”µå¹³ï¼›å†™å…¥ 0 æ—¶ï¼Œåˆ™å˜ä¸ºä½ç”µå¹³ï¼Œè¿™ä¸ªè¿‡ç¨‹å°†ä¸€æ¡å†…å­˜å†™æŒ‡ä»¤ç›´æ¥è½¬åŒ–ä¸ºäº†ä¸€ä¸ªç‰©ç†ä¸–ç•Œçš„åŠ¨ä½œï¼ˆæ¯”å¦‚ç‚¹äº®ä¸€ä¸ª LEDï¼‰\nè¾“å…¥è¾“å‡ºè®¾å¤‡æ¡ˆä¾‹ ä¸²å£ä¸é”®ç›˜ ç»å…¸çš„ I/O è®¾å¤‡ï¼Œå±•ç¤ºäº†æœ€åŸºç¡€çš„è®¾å¤‡äº¤äº’æ–¹å¼\nç«¯å£ I/Oï¼šå®ƒä»¬é€šå¸¸ä½¿ç”¨ç«¯å£ I/O (Port I/O) ä¸ CPU é€šä¿¡ï¼Œè®¾å¤‡å¯„å­˜å™¨è¢«æ˜ å°„åˆ°ä¸“ç”¨çš„ I/O ç«¯å£åœ°å€ï¼ˆè€Œéå†…å­˜åœ°å€ï¼‰ï¼ŒCPU éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„ in/out æŒ‡ä»¤æ¥è¯»å†™è¿™äº›ç«¯å£\nå‘æŒ‡å®šç«¯å£å†™å…¥ä¸åŒçš„æ•°å€¼ï¼Œç›¸å½“äºå‘è®¾å¤‡å‘é€ä¸åŒçš„æŒ‡ä»¤ï¼ˆå¦‚è®¾ç½®æ³¢ç‰¹ç‡ã€æ§åˆ¶é”®ç›˜ LED ç¯ï¼‰ï¼Œè€Œä»æŒ‡å®šç«¯å£è¯»å–æ•°æ®åˆ™æ˜¯æ¥æ”¶è®¾å¤‡çš„çŠ¶æ€æˆ–è¾“å…¥ï¼ˆå¦‚ä¸²å£æ”¶åˆ°çš„å­—ç¬¦ã€é”®ç›˜æŒ‰é”®çš„æ‰«æç ï¼‰\nç£ç›˜æ§åˆ¶å™¨ä¸ PIO æ—©æœŸçš„ç£ç›˜æ§åˆ¶å™¨ï¼ˆå¦‚ ATA/IDEï¼‰å±•ç¤ºäº†ä¸€ç§æ›´å¤æ‚ä½†æ•ˆç‡è¾ƒä½çš„äº¤äº’æ¨¡å¼ï¼šPIO åè®®ï¼šå…¨ç§°ä¸ºProgrammed I/Oï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ•°æ®çš„ä¼ è¾“å®Œå…¨ç”± CPU æ§åˆ¶\nå·¥ä½œæµç¨‹ï¼š\nCPU å‘ç£ç›˜æ§åˆ¶å™¨çš„æŒ‡ä»¤å¯„å­˜å™¨å†™å…¥å‘½ä»¤ï¼ˆå¦‚â€œè¯»å–ç¬¬ N ä¸ªæ‰‡åŒºâ€ï¼‰ CPU è¿›å…¥è½®è¯¢ (Polling) çŠ¶æ€ï¼Œåå¤è¯»å–çŠ¶æ€å¯„å­˜å™¨ï¼Œç›´åˆ°è®¾å¤‡æŠ¥å‘Šâ€œæ•°æ®å‡†å¤‡å°±ç»ªâ€ CPU åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ï¼Œé€ä¸ªå­—èŠ‚æˆ–å­—åœ°å°†æ•°æ®ä»ç£ç›˜çš„æ•°æ®å¯„å­˜å™¨è¯»å…¥ CPU å¯„å­˜å™¨ï¼Œå†å†™å…¥å†…å­˜ ç¼ºç‚¹ï¼šåœ¨è½®è¯¢å’Œæ•°æ®ä¼ è¾“æœŸé—´ï¼ŒCPU è¢«å®Œå…¨å ç”¨ï¼Œæ— æ³•æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œæ•ˆç‡æå…¶ä½ä¸‹\næ‰“å°æœºä¸ DSL æ‰“å°æœºè¿™ç±»è®¾å¤‡ï¼Œå°†äº¤äº’æ¨¡å‹æå‡åˆ°äº†ä¸€ä¸ªæ–°çš„é«˜åº¦\né¢†åŸŸä¸“ç”¨è¯­è¨€ (DSL)ï¼šæ‰“å°æœºä¸æ˜¯ç®€å•åœ°æ¥æ”¶åƒç´ æ•°æ®ï¼Œè€Œæ˜¯ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„è®¡ç®—æœºï¼Œæ¥æ”¶å¹¶è§£é‡Šç”¨é¡µé¢æè¿°è¯­è¨€ï¼ˆå¦‚ PostScript æˆ– PCLï¼‰ç¼–å†™çš„â€œç¨‹åºâ€\nCPUï¼ˆé©±åŠ¨ç¨‹åºï¼‰çš„è§’è‰²æ›´åƒæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå°†åº”ç”¨ç¨‹åºçš„æ‰“å°è¯·æ±‚ï¼ˆå¦‚ä¸€ä¸ª Word æ–‡æ¡£ï¼‰ç¼–è¯‘æˆä¸€ä¸² PostScript æŒ‡ä»¤æµï¼Œç„¶åå‘é€ç»™æ‰“å°æœº\næ‰“å°æœºå†…éƒ¨çš„å¤„ç†å™¨è´Ÿè´£æ‰§è¡Œè¿™äº›æŒ‡ä»¤ï¼Œå°†æŠ½è±¡çš„æè¿°ï¼ˆå¦‚â€œåœ¨è¿™é‡Œç”»ä¸€æ¡çº¿â€ã€â€œä½¿ç”¨è¿™ä¸ªå­—ä½“æ˜¾ç¤ºæ–‡æœ¬â€ï¼‰ç¿»è¯‘æˆæ‰“å°å¤´çš„ç‰©ç†åŠ¨ä½œ\næ€»çº¿ä¸å¯æ‰©å±•æ€§ å•ä¸ªè®¡ç®—æœºç³»ç»Ÿéœ€è¦è¿æ¥å¤šç§å¤šæ ·çš„è®¾å¤‡ï¼Œè¿™å°±éœ€è¦ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ‰©å±•æœºåˆ¶â€”â€”æ€»çº¿ (Bus)\næ€»çº¿æ˜¯ä¸€ç»„å…±äº«çš„ç”µå­çº¿è·¯ï¼Œå®ƒå®šä¹‰äº†ä¸€å¥—åè®®ï¼Œå…è®¸ CPUã€å†…å­˜å’Œå¤šä¸ª I/O è®¾å¤‡ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼Œå®ƒæä¾›äº†ä¸€ç§â€œè®¾å¤‡è™šæ‹ŸåŒ–â€ï¼ŒCPU åªéœ€ä¸æ€»çº¿æ§åˆ¶å™¨é€šä¿¡ï¼Œç”±æ€»çº¿è´Ÿè´£å°†è¯·æ±‚è½¬å‘åˆ°æ­£ç¡®çš„è®¾å¤‡\nå¯æ‰©å±•æ€§ï¼šé€šè¿‡æ ‡å‡†çš„æ‰©å±•æ’æ§½ï¼ˆå¦‚æ—©æœŸçš„ ISAã€ç°ä»£çš„ PCIeï¼‰ï¼Œç”¨æˆ·å¯ä»¥å‘ç³»ç»Ÿä¸­æ·»åŠ æ— ç©·æ— å°½çš„æ–°è®¾å¤‡ï¼Œè€Œæ— éœ€ä¿®æ”¹ä¸»æ¿æˆ– CPU çš„è®¾è®¡ PCIe æ€»çº¿ä¸ DMA PCIe (PCI Express) æ˜¯ç›®å‰ä¸»æµçš„é«˜é€Ÿæ€»çº¿æ ‡å‡†ï¼Œå®ƒå¼•å…¥äº†ä¸€é¡¹é©å‘½æ€§çš„æŠ€æœ¯æ¥è§£å†³ PIO çš„æ•ˆç‡é—®é¢˜ï¼šDMAï¼Œå…¨ç§°ä¸ºç›´æ¥å†…å­˜è®¿é—® (Direct Memory Access)ï¼Œå®ƒå…è®¸è®¾å¤‡æ§åˆ¶å™¨åœ¨æ²¡æœ‰ CPU å¹²é¢„çš„æƒ…å†µä¸‹ï¼Œç›´æ¥ä¸ä¸»å†…å­˜è¿›è¡Œæ•°æ®ä¼ è¾“\nå·¥ä½œæµç¨‹ï¼š\nCPU è®¾ç½® DMA æ§åˆ¶å™¨ï¼Œå‘Šè¯‰å®ƒæºåœ°å€ã€ç›®æ ‡åœ°å€å’Œä¼ è¾“å¤§å° CPU å‘è®¾å¤‡å‘å‡ºâ€œå¼€å§‹ä¼ è¾“â€çš„æŒ‡ä»¤åï¼Œå°±å¯ä»¥å»æ‰§è¡Œå…¶ä»–ä»»åŠ¡äº† DMA æ§åˆ¶å™¨å…¨æƒè´Ÿè´£æ•°æ®çš„æ¬è¿ ä¼ è¾“å®Œæˆåï¼ŒDMA æ§åˆ¶å™¨é€šè¿‡ä¸­æ–­é€šçŸ¥ CPU ä¼˜åŠ¿ï¼šDMA æå¤§åœ°è§£æ”¾äº† CPUï¼Œä½¿å…¶ä¸éœ€è¦è´Ÿè´£æ¬è¿æ•°æ®ï¼Œä»è€Œæ˜¾è‘—æå‡äº†æ•´ä¸ªç³»ç»Ÿçš„ I/O ååé‡å’Œæ•ˆç‡ï¼Œæ˜¯æ‰€æœ‰ç°ä»£é«˜æ€§èƒ½è®¾å¤‡ï¼ˆæ˜¾å¡ã€NVMe ç¡¬ç›˜ã€é«˜é€Ÿç½‘å¡ï¼‰çš„åŸºç¡€\nè®¾å¤‡é©±åŠ¨ç¨‹åº file_operations ç»“æ„ä½“ æ“ä½œç³»ç»Ÿå†…æ ¸é€šè¿‡åä¸º file_operations çš„ç»“æ„ä½“è½å®â€œEverything is a Fileâ€çš„æ€æƒ³\næ ¸å¿ƒæœºåˆ¶ï¼šè¿™ä¸ªç»“æ„ä½“æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆåˆ—è¡¨ï¼Œå®šä¹‰äº†ä¸€ç³»åˆ—æ ‡å‡†çš„æ–‡ä»¶æ“ä½œï¼Œå¦‚ read, write, open, llseek, ioctl ç­‰\né©±åŠ¨çš„æœ¬è´¨ï¼šä¸€ä¸ªè®¾å¤‡é©±åŠ¨ç¨‹åº (Device Driver) çš„æ ¸å¿ƒï¼Œå°±æ˜¯ä¸ºç‰¹å®šçš„ç¡¬ä»¶æˆ–è™šæ‹Ÿè®¾å¤‡ï¼Œæä¾›ä¸€å¥—å…·ä½“çš„ file_operations å®ç°ï¼Œå½“ä¸€ä¸ªè®¾å¤‡è¢«æ³¨å†Œåˆ°ç³»ç»Ÿä¸­æ—¶ï¼Œå†…æ ¸å°±ä¼šå°†è¿™ä¸ªè®¾å¤‡çš„â€œæ–‡ä»¶â€ä¸è¿™å¥—æ“ä½œå‡½æ•°å…³è”èµ·æ¥\né©±åŠ¨çš„ç¿»è¯‘èŒè´£ è®¾å¤‡é©±åŠ¨ç¨‹åºçš„æ ¸å¿ƒèŒè´£ï¼Œå°±æ˜¯ç¿»è¯‘åº”ç”¨ç¨‹åºå’Œç‰©ç†ç¡¬ä»¶ä¹‹é—´çš„äº¤äº’\nç¿»è¯‘è¿‡ç¨‹ï¼šå½“ä¸€ä¸ªç”¨æˆ·ç¨‹åºå¯¹æ–‡ä»¶æè¿°ç¬¦æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼ˆä¾‹å¦‚ read(fd, buf, size)ï¼‰ï¼Œå†…æ ¸ä¼šï¼š\né€šè¿‡ fd æ‰¾åˆ°å¯¹åº”çš„å†…æ ¸æ–‡ä»¶å¯¹è±¡ ä»æ–‡ä»¶å¯¹è±¡ä¸­æ‰¾åˆ°å…³è”çš„ file_operations ç»“æ„ä½“ è°ƒç”¨å…¶ä¸­çš„ .read å‡½æ•°æŒ‡é’ˆï¼Œå¹¶å°†ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ä¼ é€’è¿‡å» é©±åŠ¨çš„å®ç°ï¼šé©±åŠ¨ç¨‹åºä¸­çš„ .read å‡½æ•°åˆ™è´Ÿè´£æ‰§è¡Œè®¾å¤‡ç›¸å…³çš„åº•å±‚æ“ä½œï¼Œæ¯”å¦‚é€šè¿‡ MMIO æˆ– PIO å‘è®¾å¤‡æ§åˆ¶å™¨å‘é€æŒ‡ä»¤ï¼Œç­‰å¾…æ•°æ®å°±ç»ªï¼Œç„¶åå°†æ•°æ®ä»è®¾å¤‡å¯„å­˜å™¨ä¸­è¯»å‡ºï¼Œæœ€åå¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´çš„ buf ä¸­\nè™šæ‹Ÿè®¾å¤‡ï¼šè¿™ä¸ªæ¨¡å‹åŒæ ·é€‚ç”¨äºè™šæ‹Ÿè®¾å¤‡ï¼Œä¾‹å¦‚å¯¹ /dev/null çš„ write æ“ä½œï¼Œå…¶é©±åŠ¨å®ç°ä»…ä»…æ˜¯ç›´æ¥è¿”å›å†™å…¥çš„å­—èŠ‚æ•°ï¼Œè€Œä»€ä¹ˆä¹Ÿä¸åšï¼Œå¯¹ /proc/stat çš„ read æ“ä½œï¼Œåˆ™æ˜¯è¯»å–å†…æ ¸ä¸­çš„ç»Ÿè®¡æ•°æ®å¹¶æ ¼å¼åŒ–æˆå­—ç¬¦ä¸²è¿”å›\nioctl ä¸‡èƒ½æ¥å£ å¯¹äºè¯»å†™æ•°æ®æµä¹‹å¤–çš„è®¾å¤‡æ§åˆ¶å’Œé…ç½®éœ€æ±‚ï¼ˆå¦‚è®¾ç½®é”®ç›˜é‡å¤ç‡ã€è·å–ç£ç›˜å¥åº·ä¿¡æ¯ã€é…ç½®ç½‘ç»œå‚æ•°ç­‰ï¼‰ï¼Œread/write æ¨¡å‹æ˜¾ç„¶ä¸èƒ½æ»¡è¶³ï¼Œä¸ºæ­¤ï¼ŒUnix ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªé€šç”¨çš„ ioctl (I/O Control) ç³»ç»Ÿè°ƒç”¨\nioctl æ˜¯ä¸€ä¸ªé«˜åº¦çµæ´»çš„æ¥å£ï¼Œå®ƒçš„å…·ä½“è¡Œä¸ºå®Œå…¨ç”±è®¾å¤‡é©±åŠ¨ç¨‹åºå®šä¹‰ï¼Œåº”ç”¨ç¨‹åºé€šè¿‡ä¼ é€’ä¸€ä¸ªè®¾å¤‡ä¸“å±çš„å‘½ä»¤ç å’Œå‚æ•°ï¼Œæ¥æ‰§è¡Œç‰¹å®šçš„æ§åˆ¶åŠŸèƒ½\nè™½ç„¶å¼ºå¤§ï¼Œä½† ioctl ä¹Ÿå¸¦æ¥äº†å·¨å¤§çš„å¤æ‚æ€§ï¼Œå› ä¸ºæ¯ä¸ªè®¾å¤‡çš„å‘½ä»¤é›†éƒ½ä¸åŒï¼Œå½¢æˆäº†ä¸€ç³»åˆ—éšè—çš„ã€éæ ‡å‡†çš„åè®®ï¼Œåº”ç”¨ç¨‹åºéœ€è¦çŸ¥é“è¿™äº›ç»†èŠ‚æ‰èƒ½ä¸è®¾å¤‡æ·±åº¦äº¤äº’ï¼ˆæ˜¯å·¨å¤§çš„å±å±±ğŸ’©ï¼‰\nå®é™…æ¡ˆä¾‹ï¼š\nlibc ç¼“å†²ï¼šlibc åº“é€šè¿‡å¯¹æ–‡ä»¶æè¿°ç¬¦ 1 (stdout) æ‰§è¡Œä¸€ä¸ª tty è®¾å¤‡ä¸“å±çš„ ioctl å‘½ä»¤ï¼ˆå¦‚ TCGETSï¼‰ï¼Œæ¥åˆ¤æ–­è¾“å‡ºç›®æ ‡æ˜¯å¦ä¸ºä¸€ä¸ªäº¤äº’å¼ç»ˆç«¯ï¼Œä»è€Œå†³å®šæ˜¯é‡‡ç”¨è¡Œç¼“å†²è¿˜æ˜¯å…¨ç¼“å†²\nKVM è™šæ‹ŸåŒ–ï¼šKVM å°±æ˜¯ä¸€ä¸ªé€šè¿‡ ioctl æš´éœ²å…¨éƒ¨åŠŸèƒ½çš„å¤æ‚è®¾å¤‡ï¼Œç”¨æˆ·ç¨‹åºæ‰“å¼€ /dev/kvm åï¼Œé€šè¿‡ä¸€ç³»åˆ— ioctl å‘½ä»¤ï¼ˆå¦‚ KVM_CREATE_VM, KVM_SET_REGS, KVM_RUNï¼‰æ¥åˆ›å»ºè™šæ‹Ÿæœºã€è®¾å®š CPU çŠ¶æ€å¹¶è¿è¡Œè™šæ‹Ÿæœºï¼Œç›´åˆ°å‘ç”Ÿ VM Exit äº‹ä»¶è¿”å›åˆ°ç”¨æˆ·æ€\n","permalink":"https://diefish1024.github.io/posts/class-notes/nju-os-2025/20-%E8%AE%BE%E5%A4%87%E5%92%8C%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F/","summary":"\u003ch2 id=\"è¾“å…¥è¾“å‡ºè®¾å¤‡\"\u003eè¾“å…¥è¾“å‡ºè®¾å¤‡\u003c/h2\u003e\n\u003ch3 id=\"everything-is-a-file\"\u003eEverything is a File\u003c/h3\u003e\n\u003cp\u003eåœ¨ Unix-like ç³»ç»Ÿä¸­ï¼Œä¸å¤–éƒ¨è®¾å¤‡äº¤äº’çš„æ ¸å¿ƒæ€æƒ³æ˜¯ \u003cstrong\u003eEverything is a File\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eæ–‡ä»¶æè¿°ç¬¦ (File Descriptor)\u003c/strong\u003eï¼šæ“ä½œç³»ç»Ÿä¸ºä¸Šå±‚è½¯ä»¶æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æŠ½è±¡ï¼Œå³æ–‡ä»¶æè¿°ç¬¦ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘å†…æ ¸ä¸­ä»»ä½• I/O å¯¹è±¡çš„â€œæŒ‡é’ˆâ€æˆ–å¥æŸ„\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eç»Ÿä¸€æ¥å£\u003c/strong\u003eï¼šæ— è®ºæ˜¯æ™®é€šæ–‡ä»¶ã€ç¡¬ä»¶è®¾å¤‡ï¼ˆå¦‚ç»ˆç«¯ã€ç£ç›˜ï¼‰ã€è¿˜æ˜¯ç½‘ç»œè¿æ¥ï¼Œéƒ½å¯ä»¥é€šè¿‡ \u003ccode\u003eopen\u003c/code\u003e è·å¾—ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶åä½¿ç”¨ç›¸åŒçš„ \u003ccode\u003eread\u003c/code\u003e/\u003ccode\u003ewrite\u003c/code\u003e ç­‰ç³»ç»Ÿè°ƒç”¨æ¥è¿›è¡Œæ“ä½œï¼Œè¿™æå¤§åœ°ç®€åŒ–äº†åº”ç”¨ç¨‹åºçš„ç¼–å†™\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"è®¾å¤‡æ§åˆ¶å™¨ä¸-mmio\"\u003eè®¾å¤‡æ§åˆ¶å™¨ä¸ MMIO\u003c/h3\u003e\n\u003cp\u003eâ€œæ–‡ä»¶â€è¿™ä¸ªç¾å¥½çš„æŠ½è±¡èƒŒåï¼Œæ˜¯å…·ä½“çš„ç¡¬ä»¶å·¥ä½œåŸç†\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eè®¾å¤‡æ§åˆ¶å™¨ (Device Controller)\u003c/strong\u003eï¼šæ¯ä¸ª I/O è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒ…å« CPUã€å†…å­˜å’Œå¯„å­˜å™¨çš„å¾®å‹è®¡ç®—æœºï¼Œä½œä¸º CPU å’Œç‰©ç†è®¾å¤‡ä¹‹é—´çš„æ¡¥æ¢\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eè®¾å¤‡å¯„å­˜å™¨\u003c/strong\u003eï¼šæ§åˆ¶å™¨é€šè¿‡ä¸€ç»„\u003cstrong\u003eå¯„å­˜å™¨\u003c/strong\u003eä¸ CPU é€šä¿¡ï¼Œé€šå¸¸åŒ…æ‹¬ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eçŠ¶æ€å¯„å­˜å™¨\u003c/strong\u003eï¼šç”¨äºè¡¨ç¤ºè®¾å¤‡å½“å‰æ˜¯å¦ç¹å¿™ã€æ˜¯å¦å‡†å¤‡å¥½ç­‰\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæŒ‡ä»¤å¯„å­˜å™¨\u003c/strong\u003eï¼šCPU å†™å…¥æŒ‡ä»¤ï¼Œå‘Šè¯‰è®¾å¤‡è¦åšä»€ä¹ˆ\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ•°æ®å¯„å­˜å™¨\u003c/strong\u003eï¼šç”¨äºåœ¨ CPU å’Œè®¾å¤‡ä¹‹é—´ä¼ è¾“æ•°æ®\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå†…å­˜æ˜ å°„ I/O (MMIO)\u003c/strong\u003eï¼šä¸ºäº†è®© CPU èƒ½è®¿é—®è¿™äº›å¯„å­˜å™¨ï¼Œç°ä»£ç³»ç»Ÿæ™®éé‡‡ç”¨ \u003cstrong\u003eMMIO (Memory-Mapped I/O)\u003c/strong\u003eï¼Œæ“ä½œç³»ç»Ÿä¼šå°†è®¾å¤‡çš„å¯„å­˜å™¨æ˜ å°„åˆ°ç‰©ç†å†…å­˜åœ°å€ç©ºé—´ä¸­çš„ç‰¹å®šåŒºåŸŸï¼Œè¿™æ ·ä¸€æ¥ï¼ŒCPU å°±å¯ä»¥åƒè®¿é—®æ™®é€šå†…å­˜ä¸€æ ·ï¼Œä½¿ç”¨æ ‡å‡†çš„ \u003ccode\u003eload\u003c/code\u003e/\u003ccode\u003estore\u003c/code\u003e æŒ‡ä»¤æ¥è¯»å†™è®¾å¤‡å¯„å­˜å™¨ï¼Œä»è€Œå®ç°å¯¹è®¾å¤‡çš„æ§åˆ¶\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"gpio\"\u003eGPIO\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eGPIO (General-Purpose Input/Output)\u003c/strong\u003e æ˜¯ç†è§£ I/O è®¾å¤‡åŸç†æœ€ç›´è§‚çš„ä¾‹å­ï¼ŒGPIO å°±æ˜¯ä¸€ä¸ªç‰©ç†å¼•è„šï¼Œå¯ä»¥é€šè¿‡ç¼–ç¨‹è®¾ç½®ä¸ºè¾“å…¥æˆ–è¾“å‡ºæ¨¡å¼\u003c/p\u003e\n\u003cp\u003eé€šè¿‡ MMIOï¼Œä¸€ä¸ª GPIO å¼•è„šçš„ç”µå¹³çŠ¶æ€è¢«æ˜ å°„åˆ°ä¸€ä¸ªç‰¹å®šçš„å†…å­˜åœ°å€ï¼Œå½“ CPU å‘è¿™ä¸ªåœ°å€å†™å…¥ \u003ccode\u003e1\u003c/code\u003e æ—¶ï¼Œå¼•è„šå°±å˜ä¸ºé«˜ç”µå¹³ï¼›å†™å…¥ \u003ccode\u003e0\u003c/code\u003e æ—¶ï¼Œåˆ™å˜ä¸ºä½ç”µå¹³ï¼Œè¿™ä¸ªè¿‡ç¨‹å°†ä¸€æ¡å†…å­˜å†™æŒ‡ä»¤ç›´æ¥è½¬åŒ–ä¸ºäº†ä¸€ä¸ªç‰©ç†ä¸–ç•Œçš„åŠ¨ä½œï¼ˆæ¯”å¦‚ç‚¹äº®ä¸€ä¸ª LEDï¼‰\u003c/p\u003e","title":"20. è®¾å¤‡å’Œé©±åŠ¨ç¨‹åº"},{"content":"CPU å†…çš„å¹¶è¡Œç¼–ç¨‹ CPU çš„åŠŸè€— $ P=C\\cdot V^{2}\\cdot f $ å¯¼è‡´çºµä½¿æœ‰æ›´å¤§çš„ç”µè·¯ï¼Œçƒ­åŠŸè€—é™åˆ¶äº†æ€§èƒ½ä¸Šé™ï¼Œä»è€Œæœ‰ä¸€å µâ€œåŠŸè€—å¢™â€é™åˆ¶äº† CPU çš„æ€§èƒ½ï¼Œä¸ºæ­¤éœ€è¦è€ƒè™‘å¦‚ä½•åœ¨é™ä½ $ V $ å’Œ $ f $ çš„åŒæ—¶ç”¨é¢ç§¯æ¢æ€§èƒ½\næœ‰ä¸¤ä¸ªæ€è·¯ï¼š\nè®©ä¸€æ¡æŒ‡ä»¤èƒ½å¤„ç†æ›´å¤šçš„æ•°æ®ï¼šSIMD (Single Instruction, Multiple Data)\nâ€œä¸€æ¡æŒ‡ä»¤â€ æµªè´¹çš„èƒ½é‡å¤§è‡´æ˜¯å®šæ•° å¤„ç†çš„æ•°æ®è¶Šå¤šï¼Œæµªè´¹è¶Šå°‘ ç”¨æ›´å¤šæ›´ç®€å•çš„å¤„ç†å™¨ï¼šå¤šå¤„ç†å™¨ç³»ç»Ÿã€å¼‚æ„å¤šå¤„ç†å™¨\nåŒç­‰é¢ç§¯ï¼Œå¤„ç†å™¨è¶Šç®€å•ï¼Œæ•°é‡è¶Šå¤š å¼‚æ„è®¡ç®—ï¼šæœ€ç»å…¸çš„ä¾‹å­æ˜¯å¤§å°æ ¸æ¶æ„ï¼ˆå¦‚ Apple M1ï¼‰ SIMD SIMD çš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨ç¡¬ä»¶å±‚é¢å®ç°æ•°æ®çº§å¹¶è¡Œï¼Œå®ƒé€šè¿‡å¼•å…¥ä¸“é—¨çš„ç¡¬ä»¶å•å…ƒæ¥è¾¾æˆè¿™ä¸ªç›®æ ‡ï¼š\nå®½ä½å¯„å­˜å™¨ (Wide Registers)ï¼šCPU å†…éƒ¨å¢åŠ äº†æ¯”é€šç”¨å¯„å­˜å™¨å®½å¾ˆå¤šçš„ä¸“ç”¨å¯„å­˜å™¨\nIntel çš„ SSE æŒ‡ä»¤é›†å¼•å…¥äº† 128 ä½çš„ XMM å¯„å­˜å™¨ï¼Œè€Œæœ€æ–°çš„ AVX-512 æ‹¥æœ‰ 512 ä½çš„ ZMM å¯„å­˜å™¨ è¿™äº›å®½ä½å¯„å­˜å™¨å¯ä»¥ä¸€æ¬¡æ€§è£…å…¥å¤šä¸ªæ•°æ®å…ƒç´ ï¼Œæ¯”å¦‚ä¸€ä¸ª 128 ä½çš„å¯„å­˜å™¨å¯ä»¥åŒæ—¶å®¹çº³ 4 ä¸ª 32 ä½çš„æµ®ç‚¹æ•°ï¼Œæˆ–è€… 16 ä¸ª 8 ä½çš„æ•´æ•° è¿™äº›è¢«æ‰“åŒ…åœ¨ä¸€èµ·çš„æ•°æ®è¢«ç§°ä¸º Vector å‘é‡å¤„ç†å•å…ƒ (Vector ALU)ï¼šCPU å†…éƒ¨ä¹Ÿé…å¤‡äº†èƒ½å¤Ÿå¯¹æ•´ä¸ªå‘é‡è¿›è¡Œå¹¶è¡Œè®¡ç®—çš„ ALU\nå½“æ‰§è¡Œä¸€æ¡ SIMD æŒ‡ä»¤æ—¶ï¼Œè¿™ä¸ªç‰¹æ®Šçš„ ALU ä¼šåœ¨åŒä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼ŒåŒæ—¶å¯¹å¯„å­˜å™¨ä¸­çš„ 4 å¯¹æµ®ç‚¹æ•°åˆ†åˆ«æ‰§è¡Œæ“ä½œ ä¾‹å­ï¼šå‡è®¾æˆ‘ä»¬è¦è®¡ç®—ä¸¤ä¸ªæ•°ç»„ A å’Œ B çš„å’Œï¼Œå­˜å…¥æ•°ç»„ Cï¼Œæ¯ä¸ªæ•°ç»„éƒ½æœ‰ 4 ä¸ªå…ƒç´ ã€‚\nTraditionalï¼š\nload A[0] load B[0] add -\u0026gt; store C[0] load A[1] load B[1] add -\u0026gt; store C[1] \u0026hellip; é‡å¤ 4 æ¬¡ï¼Œéœ€è¦æ‰§è¡Œ 4 è½®ç‹¬ç«‹çš„â€œload-compute-storeâ€æŒ‡ä»¤ SIMDï¼š\nLOADï¼šå°†æ•°ç»„ A çš„ 4 ä¸ªå…ƒç´ ä¸€æ¬¡æ€§åŠ è½½åˆ°ä¸€ä¸ª 128 ä½çš„ XMM å¯„å­˜å™¨ä¸­ LOADï¼šå°†æ•°ç»„ B çš„ 4 ä¸ªå…ƒç´ åŠ è½½åˆ°å¦ä¸€ä¸ª XMM å¯„å­˜å™¨ä¸­ VADDPSï¼šCPU çš„å‘é‡å¤„ç†å•å…ƒå¯¹è¿™ä¸¤ä¸ªå¯„å­˜å™¨ä¸­çš„ 4 å¯¹å…ƒç´  åŒæ—¶ è¿›è¡ŒåŠ æ³•è¿ç®— STOREï¼šå°†è®¡ç®—ç»“æœå¯„å­˜å™¨ä¸­çš„ 4 ä¸ªå’Œå€¼ä¸€æ¬¡æ€§å­˜å›å†…å­˜ä¸­çš„æ•°ç»„ C é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒåŸæ¥éœ€è¦å¾ªç¯å¤šæ¬¡çš„è®¡ç®—è¢«å‹ç¼©æˆäº†å‡ æ¡é«˜æ•ˆçš„å‘é‡æŒ‡ä»¤ï¼Œæå¤§åœ°æå‡äº†ååç‡ï¼Œå°¤å…¶æ˜¯åœ¨å›¾åƒå¤„ç†ã€è§†é¢‘ç¼–è§£ç ã€ç§‘å­¦è®¡ç®—å’Œäººå·¥æ™ºèƒ½ç­‰éœ€è¦å¤§é‡é‡å¤æ€§è®¡ç®—çš„é¢†åŸŸï¼Œæ•ˆæœéå¸¸æ˜¾è‘—\nGPU å’Œ GPGPU ç¬¬äºŒç§å…‹æœâ€œåŠŸè€—å¢™â€çš„æ€è·¯â€”â€”ä½¿ç”¨æ›´å¤šã€æ›´ç®€å•çš„å¤„ç†å™¨â€”â€”ç›´æ¥å‚¬ç”Ÿäº† GPU (Graphics Processing Unit) çš„å‘å±•ï¼Œå®ƒæœ€åˆä¸ºå›¾å½¢æ¸²æŸ“è¿™ç§é«˜åº¦å¹¶è¡Œçš„ä»»åŠ¡è€Œè®¾è®¡ï¼Œå…¶æ¶æ„è¢«è¯æ˜éå¸¸æœ‰æ•ˆï¼Œæœ€ç»ˆæ¼”å˜æˆäº†ä¸€ä¸ªé€šç”¨è®¡ç®—çš„å¼ºå¤§å¼•æ“\nä» PPU åˆ° GPU å¯¹ä¸“ç”¨å›¾å½¢ç¡¬ä»¶çš„éœ€æ±‚åœ¨æ—©æœŸæ¸¸æˆæœºä¸­å°±å¾ˆæ˜æ˜¾ï¼šCPU åœ¨æ¸²æŸ“æ–¹é¢æ•ˆç‡æä½ï¼Œè®¡ç®—å±å¹•ä¸Šæ¯ä¸ªåƒç´ çš„é¢œè‰²ï¼Œæ¯ç§’é‡å¤ 60 æ¬¡ï¼Œè¿™ç§â€œå¤§è§„æ¨¡å¹¶è¡Œâ€ä»»åŠ¡ä¼šå®Œå…¨å‹å®ä¸ºä¸²è¡Œä»»åŠ¡è®¾è®¡çš„ CPU\næ—©æœŸæ–¹æ¡ˆ - PPUï¼šæ—©æœŸç³»ç»Ÿå°†å›¾å½¢ä»»åŠ¡äº¤ç»™ PPU (Picture Processing Unit) å¤„ç†ï¼Œè¿™æ˜¯ä¸€ç§é¢†åŸŸä¸“ç”¨ç¡¬ä»¶ï¼Œå®ƒæ“ä½œçš„æ˜¯é«˜çº§å›¾å½¢å¯¹è±¡ï¼Œå¦‚ tiles (8x8 åƒç´ å—) å’Œ sprites (å¯ç§»åŠ¨çš„å‰æ™¯è§’è‰²)ï¼Œè€Œéå•ä¸ªåƒç´ ï¼ŒCPU çš„å·¥ä½œè¢«ç®€åŒ–ä¸ºå‘Šè¯‰ PPU è¯¥ç”» å“ªä¸ª å›¾å—ä»¥åŠç”»åœ¨ å“ªé‡Œ\nå›ºå®šåŠŸèƒ½ Pipelineï¼šéšç€ 3D å›¾å½¢çš„å‡ºç°ï¼Œç®€å•çš„ PPU æ¨¡å‹æ¼”å˜ä¸ºæ›´å¤æ‚ä½†ä»ç„¶å›ºåŒ–çš„ â€œå›ºå®šåŠŸèƒ½ç®¡çº¿â€ (Fixed-Function Pipeline)ï¼Œå®ƒæœ‰ä¸€ç³»åˆ—ç¡¬ä»¶å®ç°çš„å›ºå®šé˜¶æ®µï¼Œè™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†é™¤äº†è°ƒæ•´é¢„è®¾å‚æ•°å¤–ï¼Œå‡ ä¹æ²¡æœ‰åˆ›é€ æ€§ç©ºé—´\néšåå¼€å‘è€…ä¸ºäº†è‡ªå®šä¹‰è§†è§‰æ•ˆæœï¼ŒæŠŠå›¾å½¢ç®¡çº¿ä¸­çš„å…³é”®éƒ¨åˆ†è¢«æ›¿æ¢ä¸ºå¯ç¼–ç¨‹å•å…ƒï¼Œå‘å±•å‡ºäº†å¯ç¼–ç¨‹çš„ç‰¹æ€§\nè¿™ç§å¯ç¼–ç¨‹æ€§èµ‹äºˆäº†å¼€å‘è€…å‰æ‰€æœªæœ‰çš„æ§åˆ¶åŠ›ï¼Œä¹Ÿæ ‡å¿—ç€ç°ä»£ GPU çš„è¯ç”Ÿ\nGPGPU äººä»¬å¾ˆå¿«æ„è¯†åˆ°ï¼Œä¸€ä¸ªä¸ºåƒç´ å¹¶è¡Œæ‰§è¡Œæ•°ç™¾ä¸‡ä¸ªç®€å•ç¨‹åºçš„èŠ¯ç‰‡ï¼Œç”¨é€”è¿œä¸æ­¢äºå›¾å½¢\næ—©æœŸçš„ hack ï¼šæœ€åˆçš„ GPGPU (General-Purpose computing on GPU) æ˜¯å¼€å‘è€…å°†ä¸€ä¸ªç§‘å­¦é—®é¢˜ï¼ˆå¦‚çŸ©é˜µä¹˜æ³•ï¼‰ä¼ªè£…æˆä¸€ä¸ªå›¾å½¢ä»»åŠ¡ï¼Œä¾‹å¦‚å°†çŸ©é˜µä½œä¸ºâ€œçº¹ç†â€åŠ è½½ï¼Œç„¶åç¼–å†™ä¸€ä¸ªâ€œç‰‡å…ƒç€è‰²å™¨â€æ¥è¿›è¡Œä¹˜æ³•è®¡ç®—ï¼Œæœ€åå°†ç»“æœâ€œé¢œè‰²â€å†™å‡º æ¼”å˜ä¸ºè®¡ç®—å¹³å°ï¼šè¿™ç§å¼ºå¤§ä½†ç¹ççš„æ–¹æ³•è¯æ˜äº†å…¶å¯è¡Œæ€§ï¼Œç¡¬ä»¶å‚å•†ï¼ˆæ¯”å¦‚ Nvidiaï¼‰éšå³æ¨å‡ºäº†ä¸“ç”¨çš„ç¼–ç¨‹æ¡†æ¶ï¼ˆCUDAï¼‰å’Œå¼€æ”¾æ ‡å‡†ï¼ˆOpenCLï¼‰ï¼Œè¿™äº›å¹³å°å½»åº•å‰¥ç¦»äº†å›¾å½¢æ¥å£ï¼Œå°† GPU å¼ºå¤§çš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›ç›´æ¥æš´éœ²ç»™å¼€å‘è€… AI æ—¶ä»£çš„å¹¶è¡Œç¼–ç¨‹ éšç€ GPGPU å¹³å°çš„æˆç†Ÿï¼Œå¯ç¼–ç¨‹çš„ Shader æ¨¡å‹ä¹Ÿæ¼”å˜æˆäº†æ›´é€šç”¨çš„çº¿ç¨‹æ¨¡å‹ï¼Œæœ€ç»ˆåœ¨ AI æ—¶ä»£å¤§æ”¾å¼‚å½©\nSIMTï¼šå•æŒ‡ä»¤ï¼Œå¤šçº¿ç¨‹ CUDA ç¼–ç¨‹æ¨¡å‹çš„æ ¸å¿ƒæ˜¯ SIMT (Single Instruction, Multiple Threads)ï¼Œè¿™æ˜¯å¯¹ SIMD æ€æƒ³çš„æ‰©å±•\nGPU ç¨‹åºä¸­æ¯ä¸ªåƒç´ æ‰§è¡Œä¸€æ¬¡çš„â€œç€è‰²å™¨â€ï¼Œåœ¨ CUDA è¢«çœ‹ä½œæ˜¯ä¸€ä¸ª Kernel å‡½æ•°ï¼Œä¼šè¢«æˆåƒä¸Šä¸‡ç”šè‡³æ•°ç™¾ä¸‡ä¸ª çº¿ç¨‹ å¹¶è¡Œæ‰§è¡Œ\nSIMT çš„é­”æ³•åœ¨äºï¼ŒGPU ä¼šå°†çº¿ç¨‹åˆ†ç»„ï¼ˆé€šå¸¸ 32 ä¸ªçº¿ç¨‹ä¸ºä¸€ä¸ª Warpï¼‰ï¼Œä¸€ä¸ª Warp å†…çš„æ‰€æœ‰çº¿ç¨‹å…±äº«åŒä¸€ä¸ªç¨‹åºè®¡æ•°å™¨ (PC)ï¼Œåœ¨ç¡¬ä»¶å±‚é¢ï¼Œå®ƒä»¬åœ¨åŒä¸€æ—¶åˆ»æ‰§è¡Œå®Œå…¨ç›¸åŒçš„æŒ‡ä»¤\nè¿™å®é™…ä¸Šåˆ›é€ äº†ä¸€ç§ç±»ä¼¼å·¨å‹ SIMD çš„æ•ˆæœï¼Œæ¯ä¸ªçº¿ç¨‹è™½ç„¶æœ‰è‡ªå·±ç‹¬ç«‹çš„å¯„å­˜å™¨å’Œæ•°æ®ï¼ˆé€šè¿‡ threadIdx ç­‰å†…ç½®å˜é‡åŒºåˆ†ï¼‰ï¼Œä½†å®ƒä»¬çš„æ‰§è¡Œæµè¢«æ†ç»‘åœ¨ä¸€èµ·ï¼Œè¿™ä½¿å¾—æ§åˆ¶å•å…ƒçš„è®¾è®¡å¯ä»¥æå…¶ç®€åŒ–ï¼Œä»è€Œåœ¨èŠ¯ç‰‡ä¸Šé›†æˆæµ·é‡çš„è®¡ç®—æ ¸å¿ƒ\nChallenges SIMT æ¶æ„åœ¨å¸¦æ¥å·¨å¤§å¹¶è¡Œä¼˜åŠ¿çš„åŒæ—¶ï¼Œä¹Ÿç»™å¸¦æ¥äº†æŒ‘æˆ˜ï¼š\nå†…å­˜åˆå¹¶ (Memory Coalescing)ï¼šå½“ä¸€ä¸ª Warp ä¸­çš„å¤šä¸ªçº¿ç¨‹è¿ç»­è®¿é—®å†…å­˜æ—¶ï¼ŒGPU ç¡¬ä»¶èƒ½å°†è¿™ 32 ä¸ªç‹¬ç«‹çš„è®¿é—®è¯·æ±‚åˆå¹¶æˆä¸€ç¬”æˆ–å‡ ç¬”å¤§çš„å†…å­˜äº‹åŠ¡ï¼Œè¿™æ˜¯ CUDA æ€§èƒ½ä¼˜åŒ–çš„å…³é”®\nåˆ†æ”¯å‘æ•£ (Branch Divergence)ï¼šSIMT æœ€å¤§çš„éš¾ç‚¹åœ¨äºå¤„ç†åˆ†æ”¯ï¼Œå¦‚æœä¸€ä¸ª Warp å†…çš„çº¿ç¨‹åœ¨ if-else è¯­å¥ä¸Šåšå‡ºä¸åŒé€‰æ‹©ï¼Œç”±äºå®ƒä»¬å…±äº«åŒä¸€ä¸ª PCï¼Œç¡¬ä»¶å¿…é¡»ä¸²è¡Œåœ°æ‰§è¡Œ if è·¯å¾„å’Œ else è·¯å¾„ï¼Œå¹¶åœ¨æ‰§è¡Œæ¯ä¸ªè·¯å¾„æ—¶ï¼Œå°†å¦ä¸€éƒ¨åˆ†çº¿ç¨‹æš‚æ—¶å±è”½ï¼Œè¿™ä¼šä½¿ Warp çš„æ‰§è¡Œé€Ÿåº¦å–å†³äºå†…éƒ¨æ‰§è¡Œæœ€æ…¢çš„çº¿ç¨‹\nå…±äº«å†…å­˜ (Shared Memory)ï¼šè™½ç„¶ CUDA çº¿ç¨‹å¯ä»¥è®¿é—®å…±äº«å†…å­˜ï¼Œä½†å¦‚ä½•é¿å…è®¿é—®å†²çª (Bank Conflict)ï¼Œå¦‚ä½•ç»„ç»‡æ•°æ®ä»¥æœ€å¤§åŒ–å¹¶è¡ŒåŠ è½½ï¼Œéƒ½ä¼šå¢åŠ  CUDA ç¨‹åºçš„ç¼–å†™éš¾åº¦\nå°½ç®¡ç¼–å†™é«˜æ•ˆçš„ CUDA ç¨‹åºå……æ»¡æŒ‘æˆ˜ï¼Œä½†å…¶å›æŠ¥æ˜¯å·¨å¤§çš„ï¼Œå°¤å…¶å¯¹äºé‚£äº›è®¡ç®—å¯†é›†ã€æ¨¡å¼å›ºå®šçš„ä»»åŠ¡ï¼Œä¾‹å¦‚æ·±åº¦å­¦ä¹ ä¸­çš„çŸ©é˜µä¹˜æ³•å’Œå·ç§¯è¿ç®—ï¼ŒGPU èƒ½æä¾›æ¯” CPU é«˜å‡ºæ•°ä¸ªæ•°é‡çº§çš„æ€§èƒ½å’Œèƒ½æ•ˆæ¯”\n","permalink":"https://diefish1024.github.io/posts/class-notes/nju-os-2025/19-%E7%9C%9F%E5%AE%9E%E4%B8%96%E7%95%8C%E7%9A%84%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-2/","summary":"\u003ch2 id=\"cpu-å†…çš„å¹¶è¡Œç¼–ç¨‹\"\u003eCPU å†…çš„å¹¶è¡Œç¼–ç¨‹\u003c/h2\u003e\n\u003cp\u003eCPU çš„åŠŸè€— $ P=C\\cdot V^{2}\\cdot f $ å¯¼è‡´çºµä½¿æœ‰æ›´å¤§çš„ç”µè·¯ï¼Œçƒ­åŠŸè€—é™åˆ¶äº†æ€§èƒ½ä¸Šé™ï¼Œä»è€Œæœ‰ä¸€å µâ€œåŠŸè€—å¢™â€é™åˆ¶äº† CPU çš„æ€§èƒ½ï¼Œä¸ºæ­¤éœ€è¦è€ƒè™‘å¦‚ä½•åœ¨é™ä½ $ V $ å’Œ $ f $ çš„åŒæ—¶ç”¨é¢ç§¯æ¢æ€§èƒ½\u003c/p\u003e\n\u003cp\u003eæœ‰ä¸¤ä¸ªæ€è·¯ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eè®©ä¸€æ¡æŒ‡ä»¤èƒ½å¤„ç†æ›´å¤šçš„æ•°æ®\u003c/strong\u003eï¼šSIMD (Single Instruction, Multiple Data)\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eâ€œä¸€æ¡æŒ‡ä»¤â€ æµªè´¹çš„èƒ½é‡å¤§è‡´æ˜¯å®šæ•°\u003c/li\u003e\n\u003cli\u003eå¤„ç†çš„æ•°æ®è¶Šå¤šï¼Œæµªè´¹è¶Šå°‘\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eç”¨æ›´å¤šæ›´ç®€å•çš„å¤„ç†å™¨\u003c/strong\u003eï¼šå¤šå¤„ç†å™¨ç³»ç»Ÿã€å¼‚æ„å¤šå¤„ç†å™¨\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåŒç­‰é¢ç§¯ï¼Œå¤„ç†å™¨è¶Šç®€å•ï¼Œæ•°é‡è¶Šå¤š\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå¼‚æ„è®¡ç®—\u003c/strong\u003eï¼šæœ€ç»å…¸çš„ä¾‹å­æ˜¯\u003cstrong\u003eå¤§å°æ ¸æ¶æ„\u003c/strong\u003eï¼ˆå¦‚ Apple M1ï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"simd\"\u003eSIMD\u003c/h3\u003e\n\u003cp\u003eSIMD çš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨ç¡¬ä»¶å±‚é¢å®ç°æ•°æ®çº§å¹¶è¡Œï¼Œå®ƒé€šè¿‡å¼•å…¥ä¸“é—¨çš„ç¡¬ä»¶å•å…ƒæ¥è¾¾æˆè¿™ä¸ªç›®æ ‡ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå®½ä½å¯„å­˜å™¨ (Wide Registers)\u003c/strong\u003eï¼šCPU å†…éƒ¨å¢åŠ äº†æ¯”é€šç”¨å¯„å­˜å™¨å®½å¾ˆå¤šçš„ä¸“ç”¨å¯„å­˜å™¨\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIntel çš„ SSE æŒ‡ä»¤é›†å¼•å…¥äº† 128 ä½çš„ XMM å¯„å­˜å™¨ï¼Œè€Œæœ€æ–°çš„ AVX-512 æ‹¥æœ‰ 512 ä½çš„ ZMM å¯„å­˜å™¨\u003c/li\u003e\n\u003cli\u003eè¿™äº›å®½ä½å¯„å­˜å™¨å¯ä»¥ä¸€æ¬¡æ€§è£…å…¥å¤šä¸ªæ•°æ®å…ƒç´ ï¼Œæ¯”å¦‚ä¸€ä¸ª 128 ä½çš„å¯„å­˜å™¨å¯ä»¥åŒæ—¶å®¹çº³ 4 ä¸ª 32 ä½çš„æµ®ç‚¹æ•°ï¼Œæˆ–è€… 16 ä¸ª 8 ä½çš„æ•´æ•°\u003c/li\u003e\n\u003cli\u003eè¿™äº›è¢«æ‰“åŒ…åœ¨ä¸€èµ·çš„æ•°æ®è¢«ç§°ä¸º Vector\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå‘é‡å¤„ç†å•å…ƒ (Vector ALU)\u003c/strong\u003eï¼šCPU å†…éƒ¨ä¹Ÿé…å¤‡äº†èƒ½å¤Ÿå¯¹æ•´ä¸ªå‘é‡è¿›è¡Œå¹¶è¡Œè®¡ç®—çš„ ALU\u003c/p\u003e","title":"19. çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹ (2)"},{"content":"å¹¶å‘ç¼–ç¨‹çš„æ ¸å¿ƒæŠ½è±¡æ˜¯å®ç°ä¸€ä¸ªè®¡ç®—å›¾ï¼Œè®¡ç®—å‘ç”Ÿåœ¨èŠ‚ç‚¹ä¸Šï¼Œè¾¹è¡¨ç¤ºèŠ‚ç‚¹ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼ŒåŒæ—¶è®¡ç®—å›¾åœ¨è¿è¡Œæ—¶å¯èƒ½æ˜¯åŠ¨æ€å˜åŒ–çš„\nä½¿ç”¨æ¡ä»¶å˜é‡ã€é”ã€ä¿¡å·é‡ç­‰ api å»å®ç°è®¡ç®—å›¾å¹¶ä¸æ˜¯ä¸€ä¸ªä¼˜é›…çš„å®ç°æ–¹å¼ï¼Œå› ä¸ºè¿™æ ·ä¼šåœ¨ä»£ç ä¸­å¼•å…¥ä¼—å¤šå¹²æ‰°ä»£ç ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´ä¸€äº›é—®é¢˜\nä¸ºæ­¤å¯ä»¥å¢åŠ ä¸€äº›åŠŸèƒ½å—é™çš„è¯­æ³•ï¼Œå¯ä»¥åœ¨åŒæ ·æè¿°è®¡ç®—å›¾çš„åŠŸèƒ½ä¸‹å‡å°‘äº†è®¸å¤šæ½œåœ¨çš„é—®é¢˜\né«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶è¡Œç¼–ç¨‹ åœ¨é«˜æ€§èƒ½è®¡ç®—ä¸­ï¼Œè®¡ç®—å›¾é€šå¸¸æ˜“äºé™æ€åˆ‡åˆ†ï¼Œå°¤å…¶é€‚ç”¨äºç‰©ç†æ¨¡æ‹Ÿçš„ç½‘æ ¼åˆ’åˆ†ï¼Œä¸ºæ­¤ HPC å‘å±•å‡ºå¤šç§é«˜æ•ˆçš„å¹¶è¡Œç¼–ç¨‹æ¨¡å‹ï¼Œå…·ä½“å­¦ä¹ å¯ä»¥å‚è€ƒ SJTU HPC å­¦ä¹ æ‰‹å†Œ\nMPI: åˆ†å¸ƒå¼å†…å­˜å¹¶è¡Œ æ¯ä¸ª MPI è¿›ç¨‹æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œè¿›ç¨‹é—´é€šè¿‡æ˜¾å¼æ¶ˆæ¯ä¼ é€’ï¼ˆå‘é€/æ¥æ”¶ï¼‰äº¤æ¢æ•°æ®\nOpenMP: å…±äº«å†…å­˜å¹¶è¡Œ å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€åœ°å€ç©ºé—´ä¸­å¹¶è¡Œæ‰§è¡Œï¼Œæ‰€æœ‰çº¿ç¨‹å¯ä»¥ç›´æ¥è®¿é—®ç›¸åŒçš„æ•°æ®ï¼Œä½¿ç”¨Â #pragma ompÂ æŒ‡ä»¤å®ç°å¹¶è¡ŒåŒ–\nå¯¹éè®¡ç®—æœºä¸“ä¸šæ¥è¯´éå¸¸å‹å¥½ï¼Œåªéœ€è¦åœ¨æ­£å¸¸çš„ä»£ç ä¸Šé¢åŠ ä¸Šç¼–è¯‘æŒ‡ä»¤å³å¯ï¼Œèƒ½è½»æ¾å®ç°é«˜æ•ˆçš„å¹¶è¡Œä¼˜åŒ–\nCUDA: GPU å¼‚æ„å¹¶è¡Œ CPU è°ƒåº¦ï¼ŒGPU æ‰§è¡Œå¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—\næ¦‚å¿µï¼š\næ ¸å‡½æ•° (Kernel) ï¼šåœ¨ GPU ä¸Šå¹¶è¡Œæ‰§è¡Œçš„å‡½æ•° çº¿ç¨‹å±‚æ¬¡ï¼šçº¿ç¨‹ (threadIdx) ç»„æˆçº¿ç¨‹å— (blockIdx)ï¼Œçº¿ç¨‹å—ç»„æˆç½‘æ ¼ (gridDim) å†…å­˜å±‚æ¬¡ï¼šå¯„å­˜å™¨ã€å…±äº«å†…å­˜ï¼ˆå—å†…é«˜é€Ÿï¼‰ã€å…¨å±€å†…å­˜ï¼ˆæ‰€æœ‰çº¿ç¨‹å¯è®¿é—®ï¼‰ æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹ ä» Web 1.0 åˆ° Web 2.0 åœ¨ Web æ—¶ä»£ç”¨çš„æœ€å¹¿æ³›çš„æ˜¯ Javascript\nAsynchronous JavaScript and XML (Ajax; ~1999) å…è®¸ç½‘é¡µå®ç°â€œåå°åˆ·æ–°â€ jQuery $ (2006): A DOM Query Language (ç¼–ç¨‹æŠ½è±¡) Web 2.0 æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹ çº¿ç¨‹å¼€é”€å¤§ï¼Œå¹¶ä¸”å¤§å¤šæ•° Web å¼€å‘è€…éš¾ä»¥è¿›è¡Œå¹¶å‘ç¼–ç¨‹\nä»è€Œæœ‰äº†event-based concurrency (åŠ¨æ€è®¡ç®—å›¾) çš„æœºåˆ¶ï¼šç¦æ­¢ä»»ä½•è®¡ç®—èŠ‚ç‚¹å¹¶è¡Œï¼ˆå’Œé«˜æ€§èƒ½è®¡ç®—çš„é€‰æ‹©ä¸åŒï¼‰\nå…è®¸ç½‘ç»œè¯·æ±‚ã€sleep åœ¨åå°è¿›è¡Œï¼ˆè¿™æ‰æ˜¯ä¸»è¦å¼€é”€ï¼‰ï¼Œæ‰§è¡Œå®Œä¹‹åäº§ç”Ÿæ–°çš„è®¡ç®—èŠ‚ç‚¹ äº‹ä»¶å¯ä»¥åœ¨æµè§ˆå™¨é‡Œçœ‹åˆ° ç›´æ¥ç”¨è¿™æ ·çš„æ–¹å¼æè¿°è®¡ç®—å›¾ä¼šäº§ç”Ÿå¤§é‡å±å±±ä»£ç  (Callback hell) ï¼Œç°ä»£çš„é€‰æ‹©æ˜¯åŠ¨æ€æè¿°è®¡ç®—å›¾\næ•°æ®ä¸­å¿ƒçš„å¹¶å‘ç¼–ç¨‹ æ•°æ®ä¸­å¿ƒä»¥æµ·é‡åˆ†å¸ƒå¼æ•°æ®ä¸ºä¸­å¿ƒï¼Œéœ€è¦å¤„ç†çš„éœ€æ±‚æœ‰ï¼š\nå®æ—¶çš„â€œå°æ•°æ®â€å¤„ç†ï¼šå†…å®¹åˆ†å‘ã€å¼¹å¹•â€¦â€¦ ç¦»çº¿çš„â€œå¤§æ•°æ®â€å¤„ç†ï¼šå†…å®¹ç´¢å¼•ã€æ•°æ®æŒ–æ˜â€¦â€¦ ä¸º AI æä¾›æ”¯æŒ æ•°æ®ä¸­å¿ƒé‡Œçš„å¹¶å‘ç¼–ç¨‹éœ€è¦æ»¡è¶³é«˜ååé‡å’Œä½å»¶è¿Ÿçš„ç‰¹ç‚¹ï¼Œéš¾ç‚¹åœ¨äºï¼š\nå¤„ç†äº‹ä»¶å¯èƒ½éœ€è¦è¯»å†™æŒä¹…å­˜å‚¨æˆ–è¯·æ±‚ç½‘ç»œä¸Šçš„æœåŠ¡ï¼Œä»è€Œå¯¼è‡´å»¶è¿Ÿä¸ç¡®å®š çº¿ç¨‹ç»´æŠ¤å’Œä¸Šä¸‹æ–‡åˆ‡æ¢éƒ½ä¼šå¸¦æ¥å¼€é”€ åœ¨æ•°æ®ä¸­å¿ƒè¿›è¡Œå¹¶å‘ç¼–ç¨‹æ—¶ï¼Œä¼ ç»Ÿçš„é€šè¿‡æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹ã€é”ç­‰ä½çº§å¹¶å‘åŸè¯­çš„æ–¹å¼å˜å¾—è¶Šæ¥è¶Šå¤æ‚ä¸”éš¾ä»¥æ‰©å±•ï¼Œå› æ­¤ä»Šå¤©çš„è§£å†³æ–¹æ¡ˆæ˜¯æ— æœåŠ¡å™¨è®¡ç®— (Serverless Computing) ï¼Œç‰¹åˆ«æ˜¯å‡½æ•°å³æœåŠ¡ (Function as a Service, FaaS) ï¼Œå…¶ä¼˜åŠ¿åœ¨äº\nå¼€å‘äººå‘˜ä¸å†éœ€è¦ç›´æ¥å¤„ç†åº•å±‚çš„å¹¶å‘é—®é¢˜ FaaS å‡½æ•°é€šå¸¸æ˜¯çŸ­æš‚çš„ã€æ— çŠ¶æ€çš„ï¼Œå¹¶ä¸”æ¯ä¸ªè¯·æ±‚é€šå¸¸è§¦å‘ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°å®ä¾‹ï¼Œä¸åŒçš„å‡½æ•°å®ä¾‹ä¹‹é—´é€šå¸¸ä¸å…±äº«å†…å­˜ï¼Œè¿™ä»æ ¹æœ¬ä¸Šè§„é¿äº†ä¼ ç»Ÿå¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ç”±äºå…±äº«å†…å­˜é—®é¢˜ è¿™æ ·çš„èŒƒå¼ä½¿å¾—ç°ä»£å­˜å‚¨ç³»ç»Ÿå®ç°é«˜å¯é ã€ä½å»¶è¿Ÿçš„å¤šå‰¯æœ¬åˆ†å¸ƒå¼å­˜å‚¨å’Œè®¡ç®—å˜å¾—éå¸¸ Challenge ï¼Œæ•°æ®ä¸€è‡´æ€§ã€æœåŠ¡æ—¶åˆ»å¯ç”¨å’Œå®¹å¿æœºå™¨ç¦»çº¿ä¸‰ä¸ªç‰¹æ€§ä¸å¯ä»¥å…¼å¾— åç¨‹ åç¨‹æ˜¯ä¸€ç§ç¨‹åºç»„ä»¶ï¼Œä¸çº¿ç¨‹åœ¨æ¦‚å¿µä¸Šæœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„ï¼Œæ¯”å¦‚éƒ½åœ¨è¿›ç¨‹å†…éƒ¨æ‹¥æœ‰ç‹¬ç«‹çš„æ ˆå¸§ï¼Œå¹¶èƒ½åœ¨è¿è¡Œæ—¶ç»´æŠ¤è‡ªå·±çš„çŠ¶æ€ï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªå…±äº«å†…å­˜çš„çŠ¶æ€æœº\nç„¶è€Œï¼Œåç¨‹ä¸çº¿ç¨‹æœ€å¤§çš„ä¸åŒåœ¨äºå®ƒä»¬çš„è°ƒåº¦æ–¹å¼å’Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼š\nåä½œå¼è°ƒåº¦ï¼šåç¨‹çš„æ‰§è¡Œæ˜¯åä½œå¼çš„ï¼Œä¼šâ€œä¸€ç›´æ‰§è¡Œâ€ ï¼Œç›´åˆ°é‡åˆ° yield() ç­‰æŒ‡ä»¤æ—¶ï¼Œæ‰ä¼šä¸»åŠ¨æ”¾å¼ƒå¤„ç†å™¨æ§åˆ¶æƒï¼Œå°†æ‰§è¡Œæƒäº¤è¿˜ç»™è°ƒç”¨è€…æˆ–è°ƒåº¦å™¨ï¼Œè¿™ä¸çº¿ç¨‹çš„æŠ¢å å¼è°ƒåº¦ï¼ˆç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶ä¸­æ–­å’Œåˆ‡æ¢ï¼‰ä¸åŒ\næ“ä½œç³»ç»Ÿâ€œä¸æ„ŸçŸ¥â€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šå½“åç¨‹é€šè¿‡ yield() è¿›è¡Œåˆ‡æ¢æ—¶ï¼Œè¿™ä»…ä»…æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨çº§åˆ«çš„æ“ä½œï¼Œä¸éœ€è¦åƒçº¿ç¨‹åˆ‡æ¢é‚£æ ·ï¼Œä¿å­˜å’Œæ¢å¤å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå› æ­¤è¿™ç§åˆ‡æ¢å¼€é”€éå¸¸å°ï¼Œå¹¶ä¸”æ˜¯æ“ä½œç³»ç»Ÿå®Œå…¨ä¸æ„ŸçŸ¥\né˜»å¡ I/O çš„å±€é™æ€§ï¼šç”±äºåç¨‹æ˜¯åä½œå¼æ‰§è¡Œçš„ï¼Œå¦‚æœåœ¨ä¸€ä¸ªåç¨‹å†…éƒ¨æ‰§è¡Œäº†é˜»å¡æ€§æ“ä½œï¼ˆå¦‚è€—æ—¶çš„ I/O æ“ä½œæˆ– sleep()ï¼‰ï¼Œé‚£ä¹ˆå½“å‰æ‰€åœ¨çš„æ•´ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹éƒ½ä¼šè¢«å¡ä½ï¼Œè¿™æ„å‘³ç€æ‰€æœ‰åœ¨è¯¥çº¿ç¨‹ä¸Šè¿è¡Œçš„åç¨‹éƒ½å°†åœæ­¢æ‰§è¡Œï¼Œä»è€Œå¤±å»äº†å¹¶è¡Œ\nç¤ºä¾‹\n1 2 3 4 5 6 7 8 9 10 11 import random def T_worker(name): i = 0 while (i := i + 1): print(f\u0026#39;[{name}] i = {i}\u0026#39;) yield() threads = [T_worker(i) for i in range(1000000)] while True: random.choice(threads).send(None) è¿™ä¸ªä¾‹å­å¾ˆå¥½åœ°é˜é‡Šäº†åç¨‹çš„ç‰¹ç‚¹ï¼š\nåœ¨åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸­æ‰§è¡Œï¼šè™½ç„¶åˆ›å»ºäº†éå¸¸å¤šä¸ª T_worker å¯¹è±¡ï¼Œä½†å®ƒä»¬éƒ½è¿è¡Œåœ¨ç¨‹åºçš„åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸­ï¼Œå¼€é”€è¿œå°äºåˆ›å»ºç›¸åŒæ•°é‡ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ ç”±ç¨‹åºæ§åˆ¶è°ƒåº¦ï¼šwhile True: random.choice(threads).send(None) è¿™æ®µä»£ç æ˜¯è‡ªå®šä¹‰çš„ç®€å•è°ƒåº¦å™¨ï¼Œå®ƒéšæœºé€‰æ‹©ä¸€ä¸ªåç¨‹å¹¶æ¿€æ´»å®ƒï¼Œä½¿å…¶æ‰§è¡Œç›´åˆ°é‡åˆ° yield() æš‚åœï¼Œç„¶åå†é€‰æ‹©ä¸‹ä¸€ä¸ªåç¨‹ èµ„æºå ç”¨æä½ï¼šç”±äºä¸æ¶‰åŠæ“ä½œç³»ç»Ÿå±‚é¢çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œé™¤äº†åç¨‹æœ¬èº«æ‰€éœ€è¦çš„ä¸€å°å—å†…å­˜ç”¨äºä¿å­˜å…¶æ ˆå¸§å’ŒçŠ¶æ€å¤–ï¼Œåç¨‹ä¸å ç”¨é¢å¤–çš„æ“ä½œç³»ç»Ÿèµ„æºï¼Œå› æ­¤å¯ä»¥åˆ›å»ºæµ·é‡çš„åç¨‹å®ä¾‹ï¼Œéå¸¸é€‚åˆé«˜å¹¶å‘çš„ I/O å¯†é›†å‹ä»»åŠ¡ã€‚ ","permalink":"https://diefish1024.github.io/posts/class-notes/nju-os-2025/18-%E7%9C%9F%E5%AE%9E%E4%B8%96%E7%95%8C%E7%9A%84%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B-1/","summary":"\u003cp\u003eå¹¶å‘ç¼–ç¨‹çš„æ ¸å¿ƒæŠ½è±¡æ˜¯å®ç°ä¸€ä¸ªè®¡ç®—å›¾ï¼Œè®¡ç®—å‘ç”Ÿåœ¨èŠ‚ç‚¹ä¸Šï¼Œè¾¹è¡¨ç¤ºèŠ‚ç‚¹ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼ŒåŒæ—¶è®¡ç®—å›¾åœ¨è¿è¡Œæ—¶å¯èƒ½æ˜¯åŠ¨æ€å˜åŒ–çš„\u003c/p\u003e\n\u003cp\u003eä½¿ç”¨æ¡ä»¶å˜é‡ã€é”ã€ä¿¡å·é‡ç­‰ api å»å®ç°è®¡ç®—å›¾å¹¶ä¸æ˜¯ä¸€ä¸ªä¼˜é›…çš„å®ç°æ–¹å¼ï¼Œå› ä¸ºè¿™æ ·ä¼šåœ¨ä»£ç ä¸­å¼•å…¥ä¼—å¤š\u003cstrong\u003eå¹²æ‰°ä»£ç \u003c/strong\u003eï¼Œä¹Ÿå¯èƒ½å¯¼è‡´ä¸€äº›é—®é¢˜\u003c/p\u003e\n\u003cp\u003eä¸ºæ­¤å¯ä»¥å¢åŠ ä¸€äº›åŠŸèƒ½å—é™çš„\u003cstrong\u003eè¯­æ³•\u003c/strong\u003eï¼Œå¯ä»¥åœ¨åŒæ ·æè¿°è®¡ç®—å›¾çš„åŠŸèƒ½ä¸‹å‡å°‘äº†è®¸å¤šæ½œåœ¨çš„é—®é¢˜\u003c/p\u003e\n\u003ch2 id=\"é«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶è¡Œç¼–ç¨‹\"\u003eé«˜æ€§èƒ½è®¡ç®—ä¸­çš„å¹¶è¡Œç¼–ç¨‹\u003c/h2\u003e\n\u003cp\u003eåœ¨é«˜æ€§èƒ½è®¡ç®—ä¸­ï¼Œè®¡ç®—å›¾é€šå¸¸æ˜“äº\u003cstrong\u003eé™æ€åˆ‡åˆ†\u003c/strong\u003eï¼Œå°¤å…¶é€‚ç”¨äºç‰©ç†æ¨¡æ‹Ÿçš„ç½‘æ ¼åˆ’åˆ†ï¼Œä¸ºæ­¤ HPC å‘å±•å‡ºå¤šç§é«˜æ•ˆçš„å¹¶è¡Œç¼–ç¨‹æ¨¡å‹ï¼Œå…·ä½“å­¦ä¹ å¯ä»¥å‚è€ƒ \u003ca href=\"https://xflops.sjtu.edu.cn/hpc-start-guide/parallel-computing/basic/\"\u003eSJTU HPC å­¦ä¹ æ‰‹å†Œ\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"mpi-åˆ†å¸ƒå¼å†…å­˜å¹¶è¡Œ\"\u003eMPI: åˆ†å¸ƒå¼å†…å­˜å¹¶è¡Œ\u003c/h4\u003e\n\u003cp\u003eæ¯ä¸ª MPI è¿›ç¨‹æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œè¿›ç¨‹é—´é€šè¿‡\u003cstrong\u003eæ˜¾å¼æ¶ˆæ¯ä¼ é€’\u003c/strong\u003eï¼ˆå‘é€/æ¥æ”¶ï¼‰äº¤æ¢æ•°æ®\u003c/p\u003e\n\u003ch4 id=\"openmp-å…±äº«å†…å­˜å¹¶è¡Œ\"\u003eOpenMP: å…±äº«å†…å­˜å¹¶è¡Œ\u003c/h4\u003e\n\u003cp\u003eå¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€åœ°å€ç©ºé—´ä¸­å¹¶è¡Œæ‰§è¡Œï¼Œæ‰€æœ‰çº¿ç¨‹å¯ä»¥ç›´æ¥è®¿é—®ç›¸åŒçš„æ•°æ®ï¼Œä½¿ç”¨Â \u003ccode\u003e#pragma omp\u003c/code\u003eÂ æŒ‡ä»¤å®ç°å¹¶è¡ŒåŒ–\u003c/p\u003e\n\u003cp\u003eå¯¹éè®¡ç®—æœºä¸“ä¸šæ¥è¯´éå¸¸å‹å¥½ï¼Œåªéœ€è¦åœ¨æ­£å¸¸çš„ä»£ç ä¸Šé¢åŠ ä¸Šç¼–è¯‘æŒ‡ä»¤å³å¯ï¼Œèƒ½è½»æ¾å®ç°é«˜æ•ˆçš„å¹¶è¡Œä¼˜åŒ–\u003c/p\u003e\n\u003ch4 id=\"cuda-gpu-å¼‚æ„å¹¶è¡Œ\"\u003eCUDA: GPU å¼‚æ„å¹¶è¡Œ\u003c/h4\u003e\n\u003cp\u003eCPU è°ƒåº¦ï¼ŒGPU æ‰§è¡Œå¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eæ¦‚å¿µ\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eæ ¸å‡½æ•° (Kernel)\u003c/strong\u003e ï¼šåœ¨ GPU ä¸Šå¹¶è¡Œæ‰§è¡Œçš„å‡½æ•°\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eçº¿ç¨‹å±‚æ¬¡\u003c/strong\u003eï¼šçº¿ç¨‹ (\u003ccode\u003ethreadIdx\u003c/code\u003e) ç»„æˆçº¿ç¨‹å— (\u003ccode\u003eblockIdx\u003c/code\u003e)ï¼Œçº¿ç¨‹å—ç»„æˆç½‘æ ¼ (\u003ccode\u003egridDim\u003c/code\u003e)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå†…å­˜å±‚æ¬¡\u003c/strong\u003eï¼šå¯„å­˜å™¨ã€å…±äº«å†…å­˜ï¼ˆå—å†…é«˜é€Ÿï¼‰ã€å…¨å±€å†…å­˜ï¼ˆæ‰€æœ‰çº¿ç¨‹å¯è®¿é—®ï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"æˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹\"\u003eæˆ‘ä»¬èº«è¾¹çš„å¹¶å‘ç¼–ç¨‹\u003c/h2\u003e\n\u003ch4 id=\"ä»-web-10-åˆ°-web-20\"\u003eä» Web 1.0 åˆ° Web 2.0\u003c/h4\u003e\n\u003cp\u003eåœ¨ Web æ—¶ä»£ç”¨çš„æœ€å¹¿æ³›çš„æ˜¯ Javascript\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAsynchronous JavaScript and XML\u003c/strong\u003e (Ajax; ~1999)\n\u003cul\u003e\n\u003cli\u003eå…è®¸ç½‘é¡µå®ç°â€œåå°åˆ·æ–°â€\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ejQuery $ (2006): A DOM Query Language\u003c/strong\u003e (ç¼–ç¨‹æŠ½è±¡)\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"web-20-æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹\"\u003eWeb 2.0 æ—¶ä»£çš„å¹¶å‘ç¼–ç¨‹\u003c/h4\u003e\n\u003cp\u003eçº¿ç¨‹å¼€é”€å¤§ï¼Œå¹¶ä¸”å¤§å¤šæ•° Web å¼€å‘è€…éš¾ä»¥è¿›è¡Œå¹¶å‘ç¼–ç¨‹\u003c/p\u003e","title":"18. çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹ (1)"},{"content":"æ•°æ®ç«äº‰ å¤§å¤šå¹¶å‘ bug æœ€åéƒ½ä¼šä½“ç°ä¸ºæ•°æ®ç«äº‰ (Data Race)\nå¯¹äºé¡ºåºç¨‹åºè€Œè¨€ï¼Œå‡½æ•° f() è¿”å›ä¹‹åå°±å·²ç»å®Œæˆäº†æ‰€æœ‰çš„çŠ¶æ€ä¿®æ”¹ï¼Œå¯¹äºå…¶ä»–éƒ¨åˆ†è€Œè¨€è¿™ä¸ªä¿®æ”¹æ˜¯ç«‹å³ç”Ÿæ•ˆçš„ï¼›å¦‚æœå¯¹äºå¹¶å‘ç¨‹åºè€Œè¨€æ¨¡å¼çš„åˆ‡æ¢ä¹Ÿåœ¨ç¬é—´å®Œæˆï¼Œé‚£å°±ä¸ä¼šå¯¼è‡´å¹¶å‘çš„é—®é¢˜\nç„¶è€Œå®é™…ä¸Šæ¨¡å¼çš„åˆ‡æ¢éœ€è¦æ—¶é—´ï¼Œæ‰§è¡Œçš„æ“ä½œåœ¨æœªæ¥ä¸€æ®µæ—¶é—´ä¹‹åæ‰ä¼šå°±ç»ªï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å®é™…ç¼–ç¨‹æ—¶æ€»æ˜¯å®¹æ˜“æœ‰â€œç«‹å³ç”Ÿæ•ˆâ€çš„è‚Œè‚‰è®°å¿†ï¼Œè¿™å°±å¯¼è‡´äº†å¹¶å‘é—®é¢˜çš„å¯èƒ½æ€§\nä¸è¿‡å¯¹äºå‡½æ•°å¼ç¼–ç¨‹è€Œè¨€ï¼Œæ“ä½œä¸å­˜åœ¨å¯¹å¤–çŠ¶æ€çš„ä¿®æ”¹ï¼Œæ²¡æœ‰å‰¯ä½œç”¨ï¼ˆåªä¼šæ“ä½œå±€éƒ¨å˜é‡ï¼‰ï¼Œè¿™å°±ä¸ä¼šå¯¼è‡´å¹¶å‘é—®é¢˜\nData Race å‘ç”Ÿçš„å®è´¨æ˜¯ä¸åŒçš„çº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€å†…å­˜ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™ï¼Œå½¢è±¡çš„ç†è§£å°±æ˜¯ä¸åŒçš„å†…å­˜è®¿é—®åœ¨â€œèµ›è·‘â€ï¼Œè·‘èµ¢çš„æ“ä½œå…ˆæ‰§è¡Œ\nNot that easy: è™½ç„¶æˆ‘ä»¬å°†æ•°æ®ç«äº‰å½¢è±¡åœ°æ¯”å–»ä¸ºâ€œèµ›è·‘â€ï¼Œä½†å®é™…ä¸Šï¼Œå“ªä¸€ä¸ªæ“ä½œèƒ½â€œè·‘èµ¢â€å¹¶æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•å’Œç¡®å®šï¼Œå…¶å¤æ‚æ€§ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢\nå¼±å†…å­˜æ¨¡å‹ (Weak memory model)ï¼šåœ¨ç°ä»£å¤„ç†å™¨æ¶æ„ä¸­ï¼Œä¸ºäº†æå‡æ€§èƒ½ï¼Œå¤„ç†å™¨å¯èƒ½ä¼šå¯¹å†…å­˜æ“ä½œè¿›è¡Œé‡æ’åºã€‚è¿™æ„å‘³ç€ï¼Œä¸åŒçš„çº¿ç¨‹æˆ–â€œè§‚å¯Ÿè€…â€åœ¨ä¸åŒæ—¶é—´ç‚¹çœ‹åˆ°å…±äº«å†…å­˜çš„çŠ¶æ€å¯èƒ½æ˜¯ä¸ä¸€è‡´çš„ã€‚ä¸€ä¸ªçº¿ç¨‹å¯¹å†…å­˜çš„å†™å…¥æ“ä½œï¼Œå¯èƒ½ä¸ä¼šç«‹å³å¯¹æ‰€æœ‰å…¶ä»–çº¿ç¨‹å¯è§ï¼Œå¯¼è‡´ä¸åŒçº¿ç¨‹è§‚å¯Ÿåˆ°ä¸åŒçš„ç»“æœã€‚è¿™ç§å†…å­˜æ¨¡å‹çš„ä¸€è‡´æ€§é—®é¢˜ä½¿å¾—ç¡®å®šå“ªä¸ªæ“ä½œâ€œå…ˆå‘ç”Ÿâ€å˜å¾—éå¸¸å›°éš¾ä¸”ä¸ç¡®å®šã€‚\næœªå®šä¹‰è¡Œä¸º (Undefined Behavior)ï¼šä» C++11 æ ‡å‡†å¼€å§‹ï¼Œæ•°æ®ç«äº‰è¢«æ˜ç¡®è§„å®šä¸ºæœªå®šä¹‰è¡Œä¸ºã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ çš„ç¨‹åºå‘ç”Ÿäº†æ•°æ®ç«äº‰ï¼Œç¼–è¯‘å™¨å¯ä»¥è‡ªç”±åœ°äº§ç”Ÿä»»ä½•è¡Œä¸ºï¼Œæ— è®ºæ˜¯å´©æºƒã€äº§ç”Ÿé”™è¯¯ç»“æœï¼Œè¿˜æ˜¯çœ‹ä¼¼æ­£å¸¸è¿è¡Œä½†ç»“æœä¸å¯é¢„æµ‹ã€‚è¿™ä½¿å¾—æ•°æ®ç«äº‰æˆä¸ºéå¸¸å±é™©ä¸”éš¾ä»¥è°ƒè¯•çš„å¹¶å‘é”™è¯¯ï¼Œå› ä¸ºå®ƒçš„è¡¨ç°å¯èƒ½æ˜¯ä¸ç¡®å®šã€ä¸ç¨³å®šçš„ã€‚\nå¤šçº¿ç¨‹ä¸å¤šå†…å­˜çš„å¤æ‚äº¤äº’ï¼šåœ¨å®é™…çš„å¹¶å‘ç¨‹åºä¸­ï¼Œé€šå¸¸ä¼šæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å¤šä¸ªå…±äº«å†…å­˜ä½ç½®ã€‚è¿™äº›çº¿ç¨‹å’Œå†…å­˜ä¹‹é—´å­˜åœ¨å¤æ‚çš„è¯»ï¼ˆRï¼‰å†™ï¼ˆWï¼‰äº¤äº’ã€‚ä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªå†…å­˜ä½ç½®çš„å†™å…¥å¯èƒ½å½±å“åˆ°å…¶ä»–å¤šä¸ªçº¿ç¨‹å¯¹è¯¥ä½ç½®çš„è¯»å–ï¼ŒåŒæ—¶ï¼Œå¤šä¸ªå†…å­˜ä½ç½®ä¹‹é—´ä¹Ÿå¯èƒ½å­˜åœ¨å¤æ‚çš„ä¾èµ–å…³ç³»å’Œç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚è¿™ç§é”™ç»¼å¤æ‚çš„äº¤äº’ç½‘ç»œè¿›ä¸€æ­¥åŠ å‰§äº†æ•°æ®ç«äº‰çš„ä¸å¯é¢„æµ‹æ€§ã€‚\nä¸ºäº†æ¶ˆç­æ•°æ®ç«äº‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯ç¨‹åºçš„ serializability ï¼Œå¯èƒ½ç«äº‰çš„å†…å­˜è®¿é—®è¦ä¹ˆäº’æ–¥ï¼Œè¦ä¹ˆåŒæ­¥\nå®é™…ç¼–ç¨‹ä¸­é‡åˆ°çš„æ•°æ®ç«äº‰ bug å¤§å¤šå±äºä¸Šé”™äº†é”å’Œå¿˜è®°ä¸Šé”ä¸¤ç§æƒ…å†µçš„å˜ç§\nCase 1: ä¸Šé”™äº†é”\n1 2 void T_1() { spin_lock(\u0026amp;A); sum++; spin_unlock(\u0026amp;A); } void T_2() { spin_lock(\u0026amp;B); sum++; spin_unlock(\u0026amp;B); } Case 2: å¿˜è®°ä¸Šé”\n1 2 void T_1() { spin_lock(\u0026amp;A); sum++; spin_unlock(\u0026amp;A); } void T_2() { sum++; } ä½†æ˜¯å®é™…ç³»ç»Ÿé¢ä¸´çš„æƒ…å†µæ¯”è¿™å¤æ‚çš„å¤šï¼Œå› ä¸º\nå†…å­˜å¯ä»¥æ˜¯åœ°å€ç©ºé—´çš„ä»»ä½•å†…å­˜ï¼Œæ¯”å¦‚å…¨å±€å˜é‡ã€å †å†…å­˜åˆ†é…çš„å˜é‡ã€ç¨‹åºçš„æ ˆâ€¦â€¦ è®¿é—®å¯ä»¥å‘ç”Ÿåœ¨ä»»ä½•ä»£ç ï¼Œæ¯”å¦‚è‡ªå·±çš„ä»£ç ã€æ¡†æ¶ä»£ç ã€ä¸€è¡Œæ²¡è¯»åˆ°çš„æ±‡ç¼–æŒ‡ä»¤ã€æŸæ¡ ret æŒ‡ä»¤ â€œä¸€è¡Œæ²¡è¯»åˆ°çš„æ±‡ç¼–æŒ‡ä»¤â€é€ æˆçš„è®¿é—®çš„æƒ…å†µæœ‰ç¼–è¯‘å™¨ä¼˜åŒ–é€ æˆçš„æŒ‡ä»¤é‡æ’ã€ç¡¬ä»¶å±‚é¢å¼±å†…å­˜æ¨¡å‹çš„å†…å­˜è®¿é—®é‡æ’ã€è¿˜æœ‰ä¸€äº›é«˜å±‚è¯­è¨€æ“ä½œçš„éšå¼å†…å­˜è®¿é—® å®é™…ç³»ç»Ÿä¸­è™½ç„¶éš¾ä»¥é¿å…ï¼Œä½†æ˜¯ä¼šå°½å¯èƒ½ä¿è¯åº•å±‚çš„ç»“æ„å¯¹ä¸Šå±‚å°½å¯èƒ½å°é—­æ¥é˜²æ­¢è¿™ç§é”™è¯¯ æ­»é” æ­»é” (Deadlock) æ˜¯æŒ‡ä¸€ä¸ªç¾¤ä½“ä¸­çš„æ¯ä¸ªæˆå‘˜éƒ½åœ¨ç­‰å¾…å…¶ä»–æˆå‘˜ï¼ˆåŒ…æ‹¬è‡ªèº«ï¼‰é‡‡å–è¡ŒåŠ¨çš„çŠ¶æ€\næ­»é”æœ‰ä¸¤ç§ï¼š\nAA-Deadlock: è‡ªå·±ç­‰å¾…è‡ªå·±\n1 2 3 4 5 6 7 lock(\u0026amp;lk); // lk-\u0026gt;locked == âœ…; proceed ... // Possibly in interrupt handler lock(\u0026amp;lk); // while (lk-\u0026gt;locked == âŒ) ; è¿™æ ·çš„é”™è¯¯è™½ç„¶çœ‹èµ·æ¥å¾ˆå‚»ï¼Œä½†æ˜¯åœ¨çœŸå®ç¨‹åºå¤æ‚çš„æ§åˆ¶æµä¸­æ˜¯å¯èƒ½å‡ºç°çš„\nABBA-Deadlock: ä¸¤ä¸ªï¼ˆå¤šä¸ªï¼‰é”äº’ç›¸ç­‰å¾…\næ¯”å¦‚ 16. å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ä¿¡å·é‡ ä¸­çš„å“²å­¦å®¶åƒé¥­é—®é¢˜\nHow? æƒ³è¦æ¶ˆé™¤æ­»é”ï¼Œå¯ä»¥ä»æ­»é”äº§ç”Ÿçš„å¿…è¦æ¡ä»¶å…¥æ‰‹ï¼Œé€šå¸¸ç§°ä¸ºéœå°”å¾·ï¼ˆHoltï¼‰æ¡ä»¶ï¼Œ å¯ä»¥å½¢è±¡åœ°æŠŠé”çœ‹æˆè¢‹å­é‡Œçš„çƒï¼š\näº’æ–¥ (Mutual-exclusion)ï¼š ä¸€ä¸ªå£è¢‹ä¸€ä¸ªçƒï¼Œå³èµ„æºæ˜¯äº’æ–¥çš„ï¼Œä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹å ç”¨ å¦‚æœèµ„æºå¯ä»¥å…±äº«ï¼ˆä¾‹å¦‚ï¼Œåªè¯»æ–‡ä»¶ï¼‰ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿæ­»é” è¯·æ±‚å¹¶ä¿æŒ (Wait-for)ï¼š å¾—åˆ°çƒçš„äººæƒ³è¦æ›´å¤šçš„çƒï¼Œå³ä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰è‡³å°‘ä¸€ä¸ªèµ„æºçš„åŒæ—¶ï¼Œåˆåœ¨ç­‰å¾…è·å–å…¶ä»–è¢«å ç”¨çš„èµ„æº å¦‚æœçº¿ç¨‹åœ¨è¯·æ±‚æ–°èµ„æºæ—¶ï¼Œå¿…é¡»é‡Šæ”¾æ‰€æœ‰å·²æŒæœ‰çš„èµ„æºï¼Œåˆ™å¯ä»¥é¿å…æ­»é” ä¸å¯æŠ¢å  (No-preemption)ï¼š ä¸èƒ½æŠ¢åˆ«äººçš„æŒæœ‰çš„çƒï¼Œå³èµ„æºä¸èƒ½è¢«å¼ºåˆ¶ä»æŒæœ‰è€…æ‰‹ä¸­æŠ¢èµ°ï¼Œåªèƒ½ç”±æŒæœ‰è€…è‡ªæ„¿é‡Šæ”¾ å¦‚æœç³»ç»Ÿå¯ä»¥æŠ¢å èµ„æºï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ä¸­æ–­å¼ºåˆ¶é‡Šæ”¾ï¼‰ï¼Œåˆ™å¯ä»¥æ‰“ç ´æ­¤æ¡ä»¶ å¾ªç¯ç­‰å¾… (Circular-chain)ï¼š å½¢æˆå¾ªç¯ç­‰å¾…çš„å…³ç³»ï¼Œå³å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹é“¾ $ T_1, T_2, \\ldots, T_n $ï¼Œå…¶ä¸­ $ T_1 $ æ­£åœ¨ç­‰å¾… $ T_2 $ å ç”¨çš„èµ„æºï¼Œ$ T_2 $ æ­£åœ¨ç­‰å¾… $ T_3 $ å ç”¨çš„èµ„æºï¼Œä¾æ­¤ç±»æ¨ï¼Œ$ T_n $ æ­£åœ¨ç­‰å¾… $ T_1 $ å ç”¨çš„èµ„æº è¿™å››ä¸ªæ¡ä»¶æ˜¯æ­»é”å‘ç”Ÿçš„å¿…è¦æ¡ä»¶ï¼Œè¿™æ„å‘³ç€åªè¦æ‰“ç ´ä»»ä½•ä¸€ä¸ªæ¡ä»¶ï¼Œå°±ä¸ä¼šå‘ç”Ÿæ­»é”äº†ï¼Œç†è®ºä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç ´åè¿™äº›æ¡ä»¶æ¥é¢„é˜²æˆ–é¿å…æ­»é”ã€‚\nç„¶è€Œï¼Œå°†è¿™å¥—ç†è®ºåº”ç”¨äºå®é™…å¤æ‚ç³»ç»Ÿæ—¶ï¼Œä¼šå‘ç°å®ƒæ˜¯ä¸€ä¸ªæ­£ç¡®çš„åºŸè¯ï¼Œä¸èƒ½ç§°ä¸ºä¸€ä¸ªåˆç†çš„ argument\nå¯¹äºç©å…·ç³»ç»Ÿ/æ¨¡å‹ï¼šå¯ä»¥ç›´æ¥è¯æ˜ç³»ç»Ÿæ˜¯ deadlock-free çš„ï¼Œå› ä¸ºå…¶çŠ¶æ€ç©ºé—´æœ‰é™ï¼Œå¯ä»¥é€šè¿‡ç©·ä¸¾æˆ–å½¢å¼åŒ–æ–¹æ³•è¿›è¡ŒéªŒè¯ å¯¹äºçœŸæ­£çš„å¤æ‚ç³»ç»Ÿï¼šå¾ˆéš¾åˆ¤æ–­å“ªä¸ªæ¡ä»¶æœ€å®¹æ˜“è¢«æ‰“ç ´ï¼Œæˆ–è€…è¯´ï¼Œåœ¨ä¿è¯ç³»ç»ŸåŠŸèƒ½æ€§å’Œæ€§èƒ½çš„å‰æä¸‹ï¼Œæ‰“ç ´æŸä¸ªæ¡ä»¶å¯èƒ½å¸¦æ¥å·¨å¤§çš„å¤æ‚æ€§æˆ–æ€§èƒ½å¼€é”€ å®é™…ç¼–ç¨‹ä¸­é€šå¸¸ä¼šé‡‡ç”¨å…¶ä»–ç­–ç•¥æ¥é¢„é˜²æ­»é”ï¼š\nä¸€ä¸ªå¸¸è§çš„æ–¹æ³•æ˜¯é”æ’åºï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š\nä»»æ„æ—¶åˆ»ç³»ç»Ÿä¸­çš„é”éƒ½æ˜¯æœ‰é™çš„ã€‚ ç»™æ‰€æœ‰é”ç¼–å·ï¼ˆæˆ–è€…å®šä¹‰ä¸€ä¸ªå…¨å±€çš„è·å–é¡ºåºï¼‰ çº¿ç¨‹åœ¨è·å–å¤šä¸ªé”æ—¶ï¼Œä¸¥æ ¼æŒ‰ç…§ä»å°æ•°åˆ°å¤§çš„é¡ºåºè·å–é” è¿™ç§ç­–ç•¥ä¹Ÿç›¸å¯¹å®¹æ˜“æ£€æŸ¥å’ŒéªŒè¯ã€‚ è¿™æ ·åœ¨ä»»æ„æ—¶åˆ»æ€»æœ‰ä¸€ä¸ªçº¿ç¨‹è·å¾—â€œç¼–å·æœ€å¤§â€çš„é”ï¼Œäºæ˜¯è¿™ä¸ªçº¿ç¨‹æ€»æ˜¯å¯ä»¥ç»§ç»­è¿è¡Œ\nç„¶è€Œè¿™ç§æ–¹æ³•åœ¨å®è·µä¸­ä¼šé‡åˆ°é—®é¢˜ï¼Œä»£ç çš„æ–‡æ¡£å¹¶ä¸æ€»æ˜¯å¯é ï¼Œå¹¶ä¸”å¯¹äºå¤æ‚ç³»ç»Ÿè¿™æ˜¯éš¾ä»¥æ‰©å±•çš„ï¼›è€Œæœ€å¥½çš„é”æ˜¯å°è£…çš„ï¼Œå¹¶ä¸ä¼šæš´éœ²å‡ºæ¥ï¼Œè¿™æ ·ä½¿ç”¨ä»£ç çš„äººç”šè‡³ä¸éœ€è¦çŸ¥é“æ­£åœ¨ä½¿ç”¨é”\nSome Methods ä¸ºäº†åº”å¯¹æ­»é”ï¼Œå°¤å…¶æ˜¯ ABBA-Deadlockï¼Œä¸€äº›å·¥å…·è¢«å¼€å‘å‡ºæ¥ï¼Œä¾‹å¦‚ Linux å†…æ ¸ä¸­çš„ LockDep\nä¸€ä¸ªç®€å•çš„æƒ³æ³•ï¼š\næ¯æ¬¡ acquire/release é”æ—¶ï¼Œéƒ½æ‰“å°ä¸€ä¸ªæ—¥å¿— å¦‚æœä»»ä½•çº¿ç¨‹å­˜åœ¨ $ A\\to B $ å’Œ $ B\\to A $ çš„ä¾èµ–å…³ç³»ï¼Œå°±æŠ¥å‘Šæ­»é” è¿™å¯èƒ½å¯¼è‡´ false positives ï¼Œæ¯”å¦‚å­˜åœ¨åŒæ­¥æœºåˆ¶ ($ A\\to B\\to \\mathrm{spawn}\\to B\\to A $) é€šè¿‡ä¼˜åŒ–è¿™ä¸ªæ–¹æ³•å¯ä»¥å¾—åˆ°ä¸€ä¸ªç›¸å¯¹é«˜æ•ˆçš„å®ç°ï¼šåŠ¨æ€ç»´æŠ¤â€œé”ä¾èµ–å›¾â€œå¹¶æ£€æµ‹ç¯è·¯\nåŸå­æ€§å’Œé¡ºåºè¿å å¹¶å‘ç¼–ç¨‹æ˜¯æœ¬è´¨å›°éš¾çš„ï¼Œæˆ‘ä»¬åªèƒ½ç”¨ sequential çš„æ–¹å¼æ¥ç†è§£å¹¶å‘ï¼šæŠŠç¨‹åºåˆ†æˆè‹¥å¹²çš„å—ï¼Œæ¯ä¸€å—çš„æ“ä½œéƒ½æ˜¯åŸå­çš„ï¼Œæ— æ³•è¢«æ‰“æ–­\nå¹¶å‘çš„æœºåˆ¶å¯ä»¥åˆ†æˆä¸¤ç±»ï¼š\näº’æ–¥é”å®ç°åŸå­æ€§ å¿˜è®°ä¸Šé”ä¼šå¯¼è‡´åŸå­æ€§è¿å (Atomicity Violation, AV) æ¡ä»¶å˜é‡/ä¿¡å·é‡å®ç°å…ˆåé¡ºåºåŒæ­¥ å¿˜è®°åŒæ­¥ä¼šå¯¼è‡´é¡ºåºè¿å (Order Violation, OV) å¹¶å‘çš„æœºåˆ¶å®Œå…¨æ˜¯â€œåæœè‡ªè´Ÿâ€çš„ï¼Œè¿™ä¹Ÿå¯¼è‡´äº† Threads cannot be implemented as a library ï¼Œå› ä¸ºï¼Ÿ\næœ‰ç ”ç©¶ç»Ÿè®¡äº†å¾ˆå¤šçœŸæ˜¯ç³»ç»Ÿå­˜åœ¨çš„å¹¶å‘ bugï¼Œå‘ç° 97% çš„éæ­»é”å¹¶å‘ bug éƒ½æ˜¯åŸå­æ€§æˆ–é¡ºåºé”™è¯¯\nAtomic Violation ä»£ç è¢«åˆ«çš„çº¿ç¨‹â€œå¼ºè¡Œæ’å…¥â€ï¼Œå³ä½¿åˆ†åˆ«ä¸Šé”æ¶ˆé™¤äº†æ•°æ®ç«äº‰ï¼Œè¿˜æ˜¯ä¼šå¯¼è‡´ AV\næ¯”å¦‚å›¾ä¸­çš„ä¾‹å­ï¼š\nå¦‚æœåœ¨ Thread 1 ç»“æŸåˆ¤æ–­è¿›å…¥ if ä¹‹å Thread 2 å†æ‰§è¡Œï¼Œå°±å¯¼è‡´äº†é”™è¯¯\nå¹¶ä¸”æ³¨æ„åˆ°æ“ä½œç³»ç»Ÿçš„çŠ¶æ€ä¹Ÿæ˜¯å…±äº«çŠ¶æ€ï¼Œåˆ©ç”¨ä¸€æ ·çš„åŸç†è¿˜å¯èƒ½äº§ç”Ÿæ›´éš¾å‘ç°çš„ bug\næ”»å‡»è€…åœ¨ check ä¹‹åé©¬ä¸Šæ›¿æ¢æ–‡ä»¶ä¸ºç¬¦å·é“¾æ¥ï¼Œå°±å¯ä»¥é€ æˆæƒé™é—®é¢˜ç­‰ä¸¥é‡å®‰å…¨æ¼æ´\nOrder Violation äº‹ä»¶æ²¡æœ‰æŒ‰ç…§é¢„å®šçš„é¡ºåºå‘ç”Ÿï¼Œå°±ä¼šå¯¼è‡´ OV ï¼Œæ¯”å¦‚ å¦‚æœ Thread 2 ä¸­çš„ S4 å‘ç”Ÿåœ¨äº†æ¡ä»¶å˜é‡çš„åˆå§‹åŒ–ä¹‹å‰ï¼Œé‚£ä¹ˆç›¸å½“äºå…¨å±€çš„å¹¿æ’­è¢«åæ‰äº†ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´ Thread 1 å¯èƒ½æ— æ³•è¢«å”¤é†’\nHowever æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŠ å¼ºç‰ˆçš„ LockDep æ¥è§£å†³è¿™äº›é—®é¢˜ï¼Œæ¯”å¦‚ç›´æ¥åˆ†æç¨‹åºçš„æ—¥å¿—ï¼Œæ£€æŸ¥æœ‰æ²¡æœ‰ä¸ç›¸äº¤çš„é”ï¼Œäº‹ä»¶çš„ happens-before å…³ç³»æ˜¯å¦æ­£ç¡®â€¦â€¦ç”šè‡³ä¹Ÿå¯ä»¥ç›´æ¥ç”¨å¯å‘å¼ï¼ˆæˆ–è€… LLM ï¼‰æ¥åˆ†ææ—¥å¿—æ˜¯å¦æ­£ç¡®\nç„¶è€Œå³ä½¿è¿™æ ·ä¹Ÿä¸èƒ½è§£å†³çœŸå®ä¸–ç•Œçš„æ‰€æœ‰å¹¶å‘é—®é¢˜ï¼Œæ¯”å¦‚è¿™ä¸ª GhostRace çš„ä¾‹å­\nå®ç°äº†æ­£ç¡®çš„äº’æ–¥ã€æ­£ç¡®çš„åŒæ­¥ $ \\text{use}\\to\\text{free} $ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 void T_A() { lock(\u0026amp;obj-\u0026gt;lock); free(obj-\u0026gt;something); obj-\u0026gt;something = NULL; unlock(\u0026amp;obj-\u0026gt;lock); } void T_B() { lock(\u0026amp;obj-\u0026gt;lock); if (obj-\u0026gt;something) { // changes cache on speculative execution } unlock(\u0026amp;obj-\u0026gt;lock); } å®é™…ä¸Šå¯¼è‡´é—®é¢˜çš„æ˜¯ç°ä»£ CPU çš„æ¨æµ‹æ‰§è¡Œçš„ç‰¹æ€§ï¼Œä¸ºäº†æé«˜æ•ˆç‡ä¼šæå‰é€šè¿‡åˆ†æ²»é¢„æµ‹å™¨é¢„åˆ¤æ‰§è¡Œçš„æ–¹å‘ï¼Œæå‰æ‰§è¡ŒæŒ‡ä»¤\nè¿™æ®µä»£ç ä¸­çº¿ç¨‹ $ T_{B} $ çš„ CPU ä¼šåœ¨æ­£å¼è·å¾—é”å¹¶åˆ¤æ–­ NULL ä¹‹å‰å°±æå‰æ¨æµ‹æ€§æ‰§è¡Œ if å—å†…éƒ¨çš„ä»£ç ï¼Œå¦‚æœæ­¤æ—¶ $ T_{A} $ æ°å¥½é‡Šæ”¾äº† obj-something æŒ‡å‘çš„å†…å­˜ï¼Œé‚£ä¹ˆ $ T_{B} $ ä¸­å°±ä¼šè®¿é—®åˆ°ä¸€å—å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜ï¼Œä»è€Œé€šè¿‡ç¼“å­˜ç­‰æ–¹å¼æ³„éœ²ä¿¡æ¯ï¼ˆè™½ç„¶é”™è¯¯æ‰§è¡Œçš„è¯­å¥å·²ç»å›æ»šäº†ï¼Œä½†æ˜¯è¢«åŠ è½½åˆ°ç¼“å­˜ä¸­çš„æ•°æ®ç­‰ä¸ä¼šå›æ»šï¼‰ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å°±æœ‰å¯èƒ½è®¿é—®åˆ°ç¨‹åºæœ¬æ¥æ²¡æœ‰æƒé™è®¿é—®çš„å†…å­˜ï¼Œä»è€Œäº§ç”Ÿå®‰å…¨æ¼æ´\nè¿™ç§å¹¶å‘ bug çš„æ ¹æºåœ¨äºè½¯ä»¶å±‚é¢çš„åŒæ­¥æ— æ³•çº¦æŸç¡¬ä»¶å±‚é¢çš„è¡Œä¸º\n","permalink":"https://diefish1024.github.io/posts/class-notes/nju-os-2025/17-%E5%B9%B6%E5%8F%91-bugs/","summary":"\u003ch2 id=\"æ•°æ®ç«äº‰\"\u003eæ•°æ®ç«äº‰\u003c/h2\u003e\n\u003cp\u003eå¤§å¤šå¹¶å‘ bug æœ€åéƒ½ä¼šä½“ç°ä¸º\u003cstrong\u003eæ•°æ®ç«äº‰ (Data Race)\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå¯¹äºé¡ºåºç¨‹åºè€Œè¨€ï¼Œå‡½æ•° \u003ccode\u003ef()\u003c/code\u003e è¿”å›ä¹‹åå°±å·²ç»å®Œæˆäº†æ‰€æœ‰çš„çŠ¶æ€ä¿®æ”¹ï¼Œå¯¹äºå…¶ä»–éƒ¨åˆ†è€Œè¨€è¿™ä¸ªä¿®æ”¹æ˜¯ç«‹å³ç”Ÿæ•ˆçš„ï¼›å¦‚æœå¯¹äºå¹¶å‘ç¨‹åºè€Œè¨€æ¨¡å¼çš„åˆ‡æ¢ä¹Ÿåœ¨ç¬é—´å®Œæˆï¼Œé‚£å°±ä¸ä¼šå¯¼è‡´å¹¶å‘çš„é—®é¢˜\u003c/p\u003e\n\u003cp\u003eç„¶è€Œå®é™…ä¸Šæ¨¡å¼çš„åˆ‡æ¢éœ€è¦æ—¶é—´ï¼Œæ‰§è¡Œçš„æ“ä½œåœ¨æœªæ¥ä¸€æ®µæ—¶é—´ä¹‹åæ‰ä¼šå°±ç»ªï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å®é™…ç¼–ç¨‹æ—¶æ€»æ˜¯å®¹æ˜“æœ‰â€œç«‹å³ç”Ÿæ•ˆâ€çš„è‚Œè‚‰è®°å¿†ï¼Œè¿™å°±å¯¼è‡´äº†å¹¶å‘é—®é¢˜çš„å¯èƒ½æ€§\u003c/p\u003e\n\u003cp\u003eä¸è¿‡å¯¹äº\u003cstrong\u003eå‡½æ•°å¼ç¼–ç¨‹\u003c/strong\u003eè€Œè¨€ï¼Œæ“ä½œä¸å­˜åœ¨å¯¹å¤–çŠ¶æ€çš„ä¿®æ”¹ï¼Œæ²¡æœ‰å‰¯ä½œç”¨ï¼ˆåªä¼šæ“ä½œå±€éƒ¨å˜é‡ï¼‰ï¼Œè¿™å°±ä¸ä¼šå¯¼è‡´å¹¶å‘é—®é¢˜\u003c/p\u003e\n\u003cp\u003eData Race å‘ç”Ÿçš„å®è´¨æ˜¯\u003cstrong\u003eä¸åŒçš„çº¿ç¨‹\u003c/strong\u003eåŒæ—¶è®¿é—®\u003cstrong\u003eåŒä¸€å†…å­˜\u003c/strong\u003eï¼Œå¹¶ä¸”\u003cstrong\u003eè‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å†™\u003c/strong\u003eï¼Œå½¢è±¡çš„ç†è§£å°±æ˜¯ä¸åŒçš„å†…å­˜è®¿é—®åœ¨â€œèµ›è·‘â€ï¼Œè·‘èµ¢çš„æ“ä½œå…ˆæ‰§è¡Œ\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eNot that easy\u003c/strong\u003e: è™½ç„¶æˆ‘ä»¬å°†æ•°æ®ç«äº‰å½¢è±¡åœ°æ¯”å–»ä¸ºâ€œèµ›è·‘â€ï¼Œä½†å®é™…ä¸Šï¼Œå“ªä¸€ä¸ªæ“ä½œèƒ½â€œè·‘èµ¢â€å¹¶æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•å’Œç¡®å®šï¼Œå…¶å¤æ‚æ€§ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå¼±å†…å­˜æ¨¡å‹ (Weak memory model)\u003c/strong\u003eï¼šåœ¨ç°ä»£å¤„ç†å™¨æ¶æ„ä¸­ï¼Œä¸ºäº†æå‡æ€§èƒ½ï¼Œå¤„ç†å™¨å¯èƒ½ä¼šå¯¹å†…å­˜æ“ä½œè¿›è¡Œé‡æ’åºã€‚è¿™æ„å‘³ç€ï¼Œä¸åŒçš„çº¿ç¨‹æˆ–â€œè§‚å¯Ÿè€…â€åœ¨ä¸åŒæ—¶é—´ç‚¹çœ‹åˆ°å…±äº«å†…å­˜çš„çŠ¶æ€å¯èƒ½æ˜¯ä¸ä¸€è‡´çš„ã€‚ä¸€ä¸ªçº¿ç¨‹å¯¹å†…å­˜çš„å†™å…¥æ“ä½œï¼Œå¯èƒ½ä¸ä¼šç«‹å³å¯¹æ‰€æœ‰å…¶ä»–çº¿ç¨‹å¯è§ï¼Œå¯¼è‡´ä¸åŒçº¿ç¨‹è§‚å¯Ÿåˆ°ä¸åŒçš„ç»“æœã€‚è¿™ç§\u003cstrong\u003eå†…å­˜æ¨¡å‹çš„ä¸€è‡´æ€§é—®é¢˜\u003c/strong\u003eä½¿å¾—ç¡®å®šå“ªä¸ªæ“ä½œâ€œå…ˆå‘ç”Ÿâ€å˜å¾—éå¸¸å›°éš¾ä¸”ä¸ç¡®å®šã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eæœªå®šä¹‰è¡Œä¸º (Undefined Behavior)\u003c/strong\u003eï¼šä» C++11 æ ‡å‡†å¼€å§‹ï¼Œæ•°æ®ç«äº‰è¢«æ˜ç¡®è§„å®šä¸º\u003cstrong\u003eæœªå®šä¹‰è¡Œä¸º\u003c/strong\u003eã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ çš„ç¨‹åºå‘ç”Ÿäº†æ•°æ®ç«äº‰ï¼Œç¼–è¯‘å™¨å¯ä»¥è‡ªç”±åœ°äº§ç”Ÿä»»ä½•è¡Œä¸ºï¼Œæ— è®ºæ˜¯å´©æºƒã€äº§ç”Ÿé”™è¯¯ç»“æœï¼Œè¿˜æ˜¯çœ‹ä¼¼æ­£å¸¸è¿è¡Œä½†ç»“æœä¸å¯é¢„æµ‹ã€‚è¿™ä½¿å¾—æ•°æ®ç«äº‰æˆä¸ºéå¸¸å±é™©ä¸”éš¾ä»¥è°ƒè¯•çš„å¹¶å‘é”™è¯¯ï¼Œå› ä¸ºå®ƒçš„è¡¨ç°å¯èƒ½æ˜¯ä¸ç¡®å®šã€ä¸ç¨³å®šçš„ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå¤šçº¿ç¨‹ä¸å¤šå†…å­˜çš„å¤æ‚äº¤äº’\u003c/strong\u003eï¼šåœ¨å®é™…çš„å¹¶å‘ç¨‹åºä¸­ï¼Œé€šå¸¸ä¼šæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®å¤šä¸ªå…±äº«å†…å­˜ä½ç½®ã€‚è¿™äº›çº¿ç¨‹å’Œå†…å­˜ä¹‹é—´å­˜åœ¨å¤æ‚çš„è¯»ï¼ˆRï¼‰å†™ï¼ˆWï¼‰äº¤äº’ã€‚ä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªå†…å­˜ä½ç½®çš„å†™å…¥å¯èƒ½å½±å“åˆ°å…¶ä»–å¤šä¸ªçº¿ç¨‹å¯¹è¯¥ä½ç½®çš„è¯»å–ï¼ŒåŒæ—¶ï¼Œå¤šä¸ªå†…å­˜ä½ç½®ä¹‹é—´ä¹Ÿå¯èƒ½å­˜åœ¨å¤æ‚çš„ä¾èµ–å…³ç³»å’Œç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ã€‚è¿™ç§é”™ç»¼å¤æ‚çš„äº¤äº’ç½‘ç»œè¿›ä¸€æ­¥åŠ å‰§äº†æ•°æ®ç«äº‰çš„ä¸å¯é¢„æµ‹æ€§ã€‚\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä¸ºäº†æ¶ˆç­æ•°æ®ç«äº‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯ç¨‹åºçš„ serializability ï¼Œ\u003cstrong\u003eå¯èƒ½ç«äº‰çš„å†…å­˜è®¿é—®è¦ä¹ˆäº’æ–¥ï¼Œè¦ä¹ˆåŒæ­¥\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå®é™…ç¼–ç¨‹ä¸­é‡åˆ°çš„æ•°æ®ç«äº‰ bug å¤§å¤šå±äº\u003cstrong\u003eä¸Šé”™äº†é”\u003c/strong\u003eå’Œ\u003cstrong\u003eå¿˜è®°ä¸Šé”\u003c/strong\u003eä¸¤ç§æƒ…å†µçš„å˜ç§\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eCase 1: ä¸Šé”™äº†é”\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eT_1\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nf\"\u003espin_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"n\"\u003esum\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nf\"\u003espin_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eT_2\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nf\"\u003espin_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"n\"\u003esum\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nf\"\u003espin_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eCase 2: å¿˜è®°ä¸Šé”\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eT_1\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"nf\"\u003espin_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"n\"\u003esum\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"nf\"\u003espin_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eT_2\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003esum\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eä½†æ˜¯å®é™…ç³»ç»Ÿé¢ä¸´çš„æƒ…å†µæ¯”è¿™å¤æ‚çš„å¤šï¼Œå› ä¸º\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå†…å­˜å¯ä»¥æ˜¯åœ°å€ç©ºé—´çš„ä»»ä½•å†…å­˜ï¼Œæ¯”å¦‚å…¨å±€å˜é‡ã€å †å†…å­˜åˆ†é…çš„å˜é‡ã€ç¨‹åºçš„æ ˆâ€¦â€¦\u003c/li\u003e\n\u003cli\u003eè®¿é—®å¯ä»¥å‘ç”Ÿåœ¨ä»»ä½•ä»£ç ï¼Œæ¯”å¦‚è‡ªå·±çš„ä»£ç ã€æ¡†æ¶ä»£ç ã€ä¸€è¡Œæ²¡è¯»åˆ°çš„æ±‡ç¼–æŒ‡ä»¤ã€æŸæ¡ ret æŒ‡ä»¤\n\u003cul\u003e\n\u003cli\u003eâ€œä¸€è¡Œæ²¡è¯»åˆ°çš„æ±‡ç¼–æŒ‡ä»¤â€é€ æˆçš„è®¿é—®çš„æƒ…å†µæœ‰ç¼–è¯‘å™¨ä¼˜åŒ–é€ æˆçš„æŒ‡ä»¤é‡æ’ã€ç¡¬ä»¶å±‚é¢å¼±å†…å­˜æ¨¡å‹çš„å†…å­˜è®¿é—®é‡æ’ã€è¿˜æœ‰ä¸€äº›é«˜å±‚è¯­è¨€æ“ä½œçš„éšå¼å†…å­˜è®¿é—®\u003c/li\u003e\n\u003cli\u003eå®é™…ç³»ç»Ÿä¸­è™½ç„¶éš¾ä»¥é¿å…ï¼Œä½†æ˜¯ä¼šå°½å¯èƒ½ä¿è¯åº•å±‚çš„ç»“æ„å¯¹ä¸Šå±‚å°½å¯èƒ½å°é—­æ¥é˜²æ­¢è¿™ç§é”™è¯¯\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"æ­»é”\"\u003eæ­»é”\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eæ­»é” (Deadlock)\u003c/strong\u003e æ˜¯æŒ‡ä¸€ä¸ªç¾¤ä½“ä¸­çš„æ¯ä¸ªæˆå‘˜éƒ½åœ¨ç­‰å¾…å…¶ä»–æˆå‘˜ï¼ˆåŒ…æ‹¬è‡ªèº«ï¼‰é‡‡å–è¡ŒåŠ¨çš„çŠ¶æ€\u003c/p\u003e\n\u003cp\u003eæ­»é”æœ‰ä¸¤ç§ï¼š\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eAA-Deadlock\u003c/strong\u003e: è‡ªå·±ç­‰å¾…è‡ªå·±\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nf\"\u003elock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e// lk-\u0026gt;locked == âœ…; proceed\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e\u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// Possibly in interrupt handler\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003elock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// while (lk-\u0026gt;locked == âŒ) ;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eè¿™æ ·çš„é”™è¯¯è™½ç„¶çœ‹èµ·æ¥å¾ˆå‚»ï¼Œä½†æ˜¯åœ¨çœŸå®ç¨‹åºå¤æ‚çš„æ§åˆ¶æµä¸­æ˜¯å¯èƒ½å‡ºç°çš„\u003c/p\u003e","title":"17. å¹¶å‘ Bugs"},{"content":"æ¨ç†æ•ˆç‡å¯¹äº llm æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„é—®é¢˜ã€‚å½“æ¨¡å‹ç”Ÿæˆæ–‡æœ¬æ—¶ï¼Œå°¤å…¶æ˜¯ä»¥è‡ªå›å½’æ–¹å¼é€è¯ç”Ÿæˆæ—¶ï¼Œæ•ˆç‡ç“¶é¢ˆä¼šå˜å¾—éå¸¸æ˜æ˜¾ã€‚KV Cache å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜è€Œè¯ç”Ÿçš„æŠ€æœ¯ã€‚\n1. What is KV Cache? KV Cacheï¼Œå…¨ç§° Key-Value Cacheï¼Œæ˜¯ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºåŠ é€Ÿ Transformer æ¶æ„åœ¨è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹ä¸­çš„æ¨ç†é€Ÿåº¦ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ç¼“å­˜å¹¶é‡ç”¨åœ¨æ³¨æ„åŠ›æœºåˆ¶ä¸­è®¡ç®—å¾—åˆ°çš„ Key (K) å’Œ Value (V) å‘é‡ã€‚\n2. Transformer Attention Mechanism Review è¦ç†è§£ KV Cacheï¼Œé¦–å…ˆéœ€è¦å¯¹ Transformer æ¶æ„ä¸­çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶æœ‰ä¸€ä¸ªåŸºæœ¬è®¤è¯†ã€‚è‡ªæ³¨æ„åŠ›æœºåˆ¶å…è®¸æ¨¡å‹åœ¨å¤„ç†åºåˆ—ä¸­çš„æŸä¸ªè¯æ—¶ï¼Œè€ƒè™‘åºåˆ—ä¸­æ‰€æœ‰å…¶ä»–è¯çš„é‡è¦æ€§ã€‚\næ¯ä¸ªè¾“å…¥ tokenï¼ˆè¯æˆ–å­è¯ï¼‰åœ¨è¿›å…¥æ³¨æ„åŠ›å±‚æ—¶ï¼Œéƒ½ä¼šè¢«è½¬æ¢æˆä¸‰ä¸ªä¸åŒçš„å‘é‡ï¼š\nQ å‘é‡ï¼šä»£è¡¨å½“å‰ token çš„â€œæŸ¥è¯¢â€ä¿¡æ¯ K å‘é‡ï¼šä»£è¡¨æ‰€æœ‰ token çš„â€œé”®â€ä¿¡æ¯ï¼Œç”¨äºä¸ Query è¿›è¡ŒåŒ¹é… V å‘é‡ï¼šä»£è¡¨æ‰€æœ‰ token çš„â€œå€¼â€ä¿¡æ¯ï¼Œç”¨äºåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°æœ€ç»ˆçš„è¾“å‡º è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„è®¡ç®—è¿‡ç¨‹ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š\nè®¡ç®— Query ä¸æ‰€æœ‰ Key çš„ç‚¹ç§¯ï¼Œå¾—åˆ°æ³¨æ„åŠ›åˆ†æ•° å°†æ³¨æ„åŠ›åˆ†æ•°è¿›è¡Œç¼©æ”¾ï¼Œé™¤ä»¥ $ \\sqrt{d_k} $ï¼ˆ$ d_k $ æ˜¯ Key å‘é‡çš„ç»´åº¦) å¯¹ç¼©æ”¾åçš„åˆ†æ•°è¿›è¡Œ Softmaxï¼Œå°†å…¶è½¬æ¢ä¸ºæ³¨æ„åŠ›æƒé‡ï¼Œè¡¨ç¤ºæ¯ä¸ª token å¯¹å½“å‰ token çš„é‡è¦æ€§ å°†æ³¨æ„åŠ›æƒé‡ä¸ Value å‘é‡è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°å½“å‰ token çš„æ³¨æ„åŠ›è¾“å‡º å…¬å¼ä¸ºï¼š $$ \\text{Attention}(Q, K, V) = \\text{softmax}\\left(\\frac{QK^T}{\\sqrt{d_k}}\\right)V $$ å…¶ä¸­çŸ©é˜µ $ Q,K,V \\in \\mathbb{R}^{L \\times d} $ ï¼Œ$ L $ ä¸ºå½“å‰ä¸Šä¸‹æ–‡é•¿åº¦\nï¼ˆå¤„äºç®€æ´æ€§çš„è€ƒè™‘ï¼Œå¿½ç•¥äº† Causal Mask ï¼Œå®é™…ä¸Š $ QK^{T} $ åº”è¯¥ Mask æˆä¸‹ä¸‰è§’çŸ©é˜µæ¥å¼ºåˆ¶ä¸èƒ½çœ‹åˆ°åºåˆ—æœªæ¥çš„ä¿¡æ¯ï¼‰\n3. The Problem KV Cache Solves åœ¨å¤§å‹è¯­è¨€æ¨¡å‹ä¸­ï¼Œå½“æ¨¡å‹ä»¥è‡ªå›å½’æ–¹å¼ç”Ÿæˆæ–‡æœ¬æ—¶ï¼ˆæ¯æ¬¡ç”Ÿæˆä¸€ä¸ªæ–° tokenï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°è¾“å…¥åºåˆ—ä¸­ï¼Œç„¶åæ ¹æ®æ•´ä¸ªåºåˆ—ç”Ÿæˆä¸‹ä¸€ä¸ª tokenï¼‰ï¼Œä¼šé‡åˆ°ä¸€ä¸ªæ•ˆç‡é—®é¢˜ï¼š\nå‡è®¾æˆ‘ä»¬è¦ç”Ÿæˆâ€œä¸­åäººæ°‘â€\nè¾“å…¥ï¼šâ€œä¸­â€ æ¨¡å‹è®¡ç®—â€œä¸­â€çš„ $ Q, K, V $ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œåâ€ è¾“å…¥ï¼šâ€œä¸­åâ€ æ¨¡å‹å†æ¬¡è®¡ç®—â€œä¸­â€å’Œâ€œåâ€çš„ $ Q, K, V $ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œäººâ€ è¾“å…¥ï¼šâ€œä¸­åäººâ€ æ¨¡å‹å†æ¬¡è®¡ç®—â€œä¸­â€ã€â€œåâ€å’Œâ€œäººâ€çš„ $ Q, K, V $ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œæ°‘â€ å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ¯ä¸€æ­¥ç”Ÿæˆæ–° token æ—¶ï¼Œéƒ½éœ€è¦é‡æ–°è®¡ç®—ä¹‹å‰å·²ç»å¤„ç†è¿‡çš„æ‰€æœ‰ token çš„ $ K $ å’Œ $ V $ å‘é‡ã€‚è¿™ç§é‡å¤è®¡ç®—åœ¨åºåˆ—è¾ƒé•¿æ—¶ä¼šæ¶ˆè€—å¤§é‡çš„è®¡ç®—èµ„æºå’Œæ—¶é—´ï¼Œæ•ˆç‡ä½ä¸‹ã€‚\n4. How KV Cache Works æ ¹æ®ä¸Šé¢åˆ†æå¾—åˆ°çš„é—®é¢˜ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ° KV Cache çš„æ ¸å¿ƒæ€æƒ³ï¼šå°†å·²ç»è®¡ç®—è¿‡çš„ Key å’Œ Value å‘é‡ç¼“å­˜èµ·æ¥ï¼Œåœ¨åç»­çš„ç”Ÿæˆæ­¥éª¤ä¸­ç›´æ¥é‡ç”¨ï¼Œè€Œä¸æ˜¯é‡æ–°è®¡ç®—ã€‚\nä»¥ç”Ÿæˆâ€œä¸­åäººæ°‘â€ä¸ºä¾‹ï¼Œä½¿ç”¨ KV Cache çš„æµç¨‹å¦‚ä¸‹ï¼š\nè¾“å…¥ï¼šâ€œä¸­â€ è®¡ç®—â€œä¸­â€çš„ $ K_1, V_1 $ å°† $ K_1, V_1 $ å­˜å…¥ KV Cache ä½¿ç”¨ $ Q_1, K_1, V_1 $ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œåâ€ è¾“å…¥ï¼šâ€œåâ€ï¼ˆå½“å‰ token åªæœ‰â€œåâ€ï¼Œä½†æ³¨æ„åŠ›è¦å…³æ³¨æ•´ä¸ªåºåˆ—â€œä¸­åâ€ï¼‰ è®¡ç®—â€œåâ€çš„ $ K_2, V_2 $ å°† $ K_2, V_2 $ æ·»åŠ åˆ° KV Cacheã€‚æ­¤æ—¶ KV Cache åŒ…å« $ [K_1, K_2] $ å’Œ $ [V_1, V_2] $ ä½¿ç”¨å½“å‰ $ Q_2 $ å’Œç¼“å­˜ä¸­çš„ $ [K_1, K_2], [V_1, V_2] $ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œäººâ€ è¾“å…¥ï¼šâ€œäººâ€ è®¡ç®—â€œäººâ€çš„ $ K_3, V_3 $ å°† $ K_3, V_3 $ æ·»åŠ åˆ° KV Cacheã€‚æ­¤æ—¶ KV Cache åŒ…å« $ [K_1, K_2, K_3] $ å’Œ $ [V_1, V_2, V_3] $ ä½¿ç”¨å½“å‰ $ Q_3 $ å’Œç¼“å­˜ä¸­çš„ $ [K_1, K_2, K_3], [V_1, V_2, V_3] $ è®¡ç®— attention ï¼Œç”Ÿæˆâ€œæ°‘â€ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ¯ä¸€æ­¥åªéœ€è¦è®¡ç®—å½“å‰æ–°ç”Ÿæˆ token çš„ $ K, V $ å‘é‡ï¼Œè€Œæ— éœ€é‡æ–°è®¡ç®—ä¹‹å‰æ‰€æœ‰ token çš„ $ K, V $ã€‚\n5. Why Not QKV Cache? å¯èƒ½ä¼šå¥½å¥‡ï¼Œæ—¢ç„¶ K å’Œ V éƒ½éœ€è¦ç¼“å­˜ï¼Œä¸ºä»€ä¹ˆä¸ä¹Ÿç¼“å­˜ Q å‘¢ï¼Ÿä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ºä»€ä¹ˆæ˜¯ KV Cache è€Œä¸æ˜¯ QKV Cacheï¼Ÿ\nåŸå› åœ¨äº Q å‘é‡çš„æ€§è´¨ï¼š\nQ å‘é‡æ˜¯ç”¨æ¥â€œæŸ¥è¯¢â€å½“å‰ token ä¸åºåˆ—ä¸­å…¶ä»– token çš„ç›¸å…³æ€§çš„ã€‚åœ¨è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€æ­¥ç”Ÿæˆä¸€ä¸ªæ–°çš„ tokenï¼Œè¿™ä¸ªæ–° token å¯¹åº”çš„ Query å‘é‡æ˜¯æ–°çš„ï¼Œå®ƒåŸºäºå½“å‰æ­¥çš„éšè—çŠ¶æ€è®¡ç®—å¾—å‡ºã€‚æ¢å¥è¯è¯´ï¼Œæ¯æ¬¡ç”Ÿæˆæ–° token æ—¶ï¼Œå…¶å¯¹åº”çš„ $ Q $ å‘é‡éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œå¹¶ä¸”éœ€è¦é‡æ–°è®¡ç®—ä»¥åæ˜ æœ€æ–°çš„ç”Ÿæˆä¸Šä¸‹æ–‡ã€‚ K å’Œ V å‘é‡åˆ™ä»£è¡¨äº†åºåˆ—ä¸­æ¯ä¸ª token çš„â€œå†…å®¹â€ä¿¡æ¯ã€‚å¯¹äºå·²ç»å¤„ç†è¿‡çš„ tokenï¼Œå®ƒä»¬çš„ $ K $ å’Œ $ V $ å‘é‡ä¸€æ—¦è®¡ç®—å‡ºæ¥ï¼Œå…¶å†…å®¹ä¿¡æ¯å°±æ˜¯å›ºå®šä¸å˜çš„ã€‚å› æ­¤ï¼Œè¿™äº› $ K $ å’Œ $ V $ å‘é‡å¯ä»¥ç›´æ¥è¢«ç¼“å­˜å¹¶åå¤ä½¿ç”¨ï¼Œè€Œæ— éœ€é‡æ–°è®¡ç®—ã€‚ å› æ­¤ï¼Œä¸ç¼“å­˜ Q æ˜¯å› ä¸ºå®ƒåœ¨æ¯ä¸€æ­¥éƒ½æ˜¯ä¸€ä¸ªæ–°çš„è®¡ç®—ç»“æœï¼›è€Œç¼“å­˜ K å’Œ V åˆ™å¯ä»¥æ˜¾è‘—å‡å°‘é‡å¤è®¡ç®—ï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚\n6. KV Cache in Attention Mechanism åœ¨æ•°å­¦ä¸Šï¼Œå½“ä½¿ç”¨ KV Cache è¿›è¡Œè‡ªå›å½’è§£ç æ—¶ï¼Œæ³¨æ„åŠ›å…¬å¼ä¸­çš„ $ K $ å’Œ $ V $ çŸ©é˜µä¼šéšç€ç”Ÿæˆè¿‡ç¨‹çš„è¿›è¡Œè€Œä¸æ–­å¢é•¿ã€‚\nå‡è®¾æˆ‘ä»¬æ­£åœ¨ç”Ÿæˆç¬¬ $ t $ ä¸ª tokenã€‚\nå½“å‰ token çš„ Q å‘é‡æ˜¯ $ Q_t $ ï¼Œè¿™æ˜¯ä¸€ä¸ªè¡Œå‘é‡ï¼Œä»£è¡¨å½“å‰ç¬¬ $ t $ ä¸ª token çš„ Query ï¼Œç»´åº¦ä¸º $ 1 \\times d_k $ K çŸ©é˜µ $ K_{\\text{cached}} $ å°†åŒ…å«ä»ç¬¬ä¸€ä¸ª token åˆ°ç¬¬ $ t $ ä¸ª token çš„æ‰€æœ‰ K å‘é‡ï¼š $ K_{\\text{cached}} = [K_1^T, K_2^T, \\dots, K_t^T]^T $ ï¼Œç»´åº¦ä¸º $ t \\times d_k $ V çŸ©é˜µ $ V_{\\text{cached}} $ å°†åŒ…å«ä»ç¬¬ä¸€ä¸ª token åˆ°ç¬¬ $ t $ ä¸ª token çš„æ‰€æœ‰ V å‘é‡ï¼š $ V_{\\text{cached}} = [V_1^T, V_2^T, \\dots, V_t^T]^T $ ã€‚å…¶ç»´åº¦ä¸º $ t \\times d_v $ é‚£ä¹ˆï¼Œç¬¬ $ t $ ä¸ª token çš„æ³¨æ„åŠ›è®¡ç®—å˜ä¸ºï¼š $$ \\text{Attention}_{t}(Q_t, K_{\\text{cached}}, V_{\\text{cached}}) = \\text{softmax}\\left(\\frac{Q_t K_{\\text{cached}}^T}{\\sqrt{d_k}}\\right)V_{\\text{cached}} $$ å…¶ä¸­\n$ Q_t K_{\\text{cached}}^T $ æ˜¯ä¸€ä¸ª $ 1 \\times t $ çš„è¡Œå‘é‡ï¼Œä»£è¡¨å½“å‰ Query ä¸æ‰€æœ‰å†å² Key çš„ç›¸å…³æ€§åˆ†æ•° $ \\text{softmax} $ æ“ä½œå°†è¿™ä¸ª $ 1 \\times t $ çš„å‘é‡è½¬åŒ–ä¸ºæ³¨æ„åŠ›æƒé‡ è¿™ä¸ª $ 1 \\times t $ çš„æ³¨æ„åŠ›æƒé‡å‘é‡å†ä¸ $ V_{\\text{cached}} $ çŸ©é˜µï¼ˆç»´åº¦ $ t \\times d_v $ï¼‰ç›¸ä¹˜ï¼Œå¾—åˆ°æœ€ç»ˆçš„æ³¨æ„åŠ›è¾“å‡ºï¼Œç»´åº¦æ˜¯ $ 1 \\times d_v $ æ¯æ¬¡ç”Ÿæˆæ–°çš„ token $ t+1 $ æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦è®¡ç®—æ–°çš„ $ Q_{t+1} $ï¼Œå°†æ–°è®¡ç®—çš„ $ K_{t+1} $ å’Œ $ V_{t+1} $ æ‹¼æ¥åˆ° $ K_{\\text{cached}} $ å’Œ $ V_{\\text{cached}} $ æœ«å°¾ï¼Œå½¢æˆ $ K'_{\\text{cached}} = \\text{concat}(K_{\\text{cached}}, K_{t+1}) $ å’Œ $ V'_{\\text{cached}} = \\text{concat}(V_{\\text{cached}}, V_{t+1}) $\n7. Limitations and Considerations å°½ç®¡ KV Cache å¸¦æ¥äº†å·¨å¤§çš„æ€§èƒ½æå‡ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š\nå†…å­˜å ç”¨ï¼šKV Cache éœ€è¦å­˜å‚¨æ‰€æœ‰å·²å¤„ç† token çš„ Key å’Œ Value å‘é‡ã€‚å¯¹äºå¤§å‹æ¨¡å‹å’Œé•¿ä¸Šä¸‹æ–‡åºåˆ—ï¼Œè¿™äº›ç¼“å­˜å¯èƒ½éå¸¸å¤§ï¼Œå¯¼è‡´æ˜¾å­˜ï¼ˆGPU Memoryï¼‰æˆä¸ºç“¶é¢ˆã€‚ ä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶ï¼šç”±äºå†…å­˜é™åˆ¶ï¼ŒKV Cache ä¼šé™åˆ¶æ¨¡å‹èƒ½å¤Ÿå¤„ç†çš„æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦ã€‚ä¸€æ—¦è¾¾åˆ°å†…å­˜ä¸Šé™ï¼Œå°±éœ€è¦é‡‡å–ç­–ç•¥æ¥ç®¡ç†ç¼“å­˜ï¼Œä¾‹å¦‚ä¸¢å¼ƒæœ€æ—©çš„ Key/Value å¯¹ï¼ˆç±»ä¼¼äºå¾ªç¯ç¼“å†²åŒºï¼‰ï¼Œä½†è¿™å¯èƒ½ä¼šå½±å“æ¨¡å‹å¯¹é•¿è·ç¦»ä¾èµ–çš„ç†è§£ã€‚ Summary KV Cache æ˜¯ Transformer æ¨¡å‹åœ¨è‡ªå›å½’æ¨ç†è¿‡ç¨‹ä¸­éå¸¸é‡è¦çš„ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ã€‚é€šè¿‡ç¼“å­˜å¹¶é‡ç”¨å·²ç»è®¡ç®—è¿‡çš„ Key å’Œ Value å‘é‡ï¼Œå®ƒæå¤§åœ°å‡å°‘äº†é‡å¤è®¡ç®—ï¼Œä»è€Œæ˜¾è‘—æå‡äº†å¤§å‹è¯­è¨€æ¨¡å‹çš„ç”Ÿæˆé€Ÿåº¦ã€‚\nReferences KV Cache åŸç†è®²è§£ ï¼ˆBilibiliï¼‰ æ³¨æ„ï¼šæ­¤è§†é¢‘å†…å®¹å­˜åœ¨éƒ¨åˆ†é”™è¯¯ çœ‹å›¾å­¦KV Cacheï¼ˆçŸ¥ä¹ï¼‰ ä¸ºä»€ä¹ˆæ²¡æœ‰Q Cacheï¼ˆçŸ¥ä¹ï¼‰ ","permalink":"https://diefish1024.github.io/posts/ai-infra/kv-cache-%E5%85%A5%E9%97%A8/","summary":"\u003cp\u003eæ¨ç†æ•ˆç‡å¯¹äº llm æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„é—®é¢˜ã€‚å½“æ¨¡å‹ç”Ÿæˆæ–‡æœ¬æ—¶ï¼Œå°¤å…¶æ˜¯ä»¥è‡ªå›å½’æ–¹å¼é€è¯ç”Ÿæˆæ—¶ï¼Œæ•ˆç‡ç“¶é¢ˆä¼šå˜å¾—éå¸¸æ˜æ˜¾ã€‚KV Cache å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜è€Œè¯ç”Ÿçš„æŠ€æœ¯ã€‚\u003c/p\u003e\n\u003ch2 id=\"1-what-is-kv-cache\"\u003e1. What is KV Cache?\u003c/h2\u003e\n\u003cp\u003eKV Cacheï¼Œå…¨ç§° \u003cstrong\u003eKey-Value Cache\u003c/strong\u003eï¼Œæ˜¯ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºåŠ é€Ÿ Transformer æ¶æ„åœ¨è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹ä¸­çš„æ¨ç†é€Ÿåº¦ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯\u003cstrong\u003eç¼“å­˜\u003c/strong\u003eå¹¶\u003cstrong\u003eé‡ç”¨\u003c/strong\u003eåœ¨æ³¨æ„åŠ›æœºåˆ¶ä¸­è®¡ç®—å¾—åˆ°çš„ \u003cstrong\u003eKey (K)\u003c/strong\u003e å’Œ \u003cstrong\u003eValue (V)\u003c/strong\u003e å‘é‡ã€‚\u003c/p\u003e\n\u003ch2 id=\"2-transformer-attention-mechanism-review\"\u003e2. Transformer Attention Mechanism Review\u003c/h2\u003e\n\u003cp\u003eè¦ç†è§£ KV Cacheï¼Œé¦–å…ˆéœ€è¦å¯¹ Transformer æ¶æ„ä¸­çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶æœ‰ä¸€ä¸ªåŸºæœ¬è®¤è¯†ã€‚è‡ªæ³¨æ„åŠ›æœºåˆ¶å…è®¸æ¨¡å‹åœ¨å¤„ç†åºåˆ—ä¸­çš„æŸä¸ªè¯æ—¶ï¼Œè€ƒè™‘åºåˆ—ä¸­æ‰€æœ‰å…¶ä»–è¯çš„é‡è¦æ€§ã€‚\u003c/p\u003e\n\u003cp\u003eæ¯ä¸ªè¾“å…¥ tokenï¼ˆè¯æˆ–å­è¯ï¼‰åœ¨è¿›å…¥æ³¨æ„åŠ›å±‚æ—¶ï¼Œéƒ½ä¼šè¢«è½¬æ¢æˆä¸‰ä¸ªä¸åŒçš„å‘é‡ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eQ å‘é‡ï¼šä»£è¡¨å½“å‰ token çš„â€œæŸ¥è¯¢â€ä¿¡æ¯\u003c/li\u003e\n\u003cli\u003eK å‘é‡ï¼šä»£è¡¨æ‰€æœ‰ token çš„â€œé”®â€ä¿¡æ¯ï¼Œç”¨äºä¸ Query è¿›è¡ŒåŒ¹é…\u003c/li\u003e\n\u003cli\u003eV å‘é‡ï¼šä»£è¡¨æ‰€æœ‰ token çš„â€œå€¼â€ä¿¡æ¯ï¼Œç”¨äºåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°æœ€ç»ˆçš„è¾“å‡º\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eè‡ªæ³¨æ„åŠ›æœºåˆ¶çš„è®¡ç®—è¿‡ç¨‹ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eè®¡ç®— Query ä¸æ‰€æœ‰ Key çš„ç‚¹ç§¯ï¼Œå¾—åˆ°\u003cstrong\u003eæ³¨æ„åŠ›åˆ†æ•°\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003eå°†æ³¨æ„åŠ›åˆ†æ•°è¿›è¡Œç¼©æ”¾ï¼Œé™¤ä»¥ $ \\sqrt{d_k} $ï¼ˆ$ d_k $ æ˜¯ Key å‘é‡çš„ç»´åº¦)\u003c/li\u003e\n\u003cli\u003eå¯¹ç¼©æ”¾åçš„åˆ†æ•°è¿›è¡Œ Softmaxï¼Œå°†å…¶è½¬æ¢ä¸º\u003cstrong\u003eæ³¨æ„åŠ›æƒé‡\u003c/strong\u003eï¼Œè¡¨ç¤ºæ¯ä¸ª token å¯¹å½“å‰ token çš„é‡è¦æ€§\u003c/li\u003e\n\u003cli\u003eå°†æ³¨æ„åŠ›æƒé‡ä¸ Value å‘é‡è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œå¾—åˆ°å½“å‰ token çš„æ³¨æ„åŠ›è¾“å‡º\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eå…¬å¼ä¸ºï¼š\n$$ \n\n\\text{Attention}(Q, K, V) = \\text{softmax}\\left(\\frac{QK^T}{\\sqrt{d_k}}\\right)V\n\n $$\nå…¶ä¸­çŸ©é˜µ $ Q,K,V \\in \\mathbb{R}^{L \\times d} $ ï¼Œ$ L $ ä¸ºå½“å‰ä¸Šä¸‹æ–‡é•¿åº¦\u003c/p\u003e","title":"KV Cache å…¥é—¨"},{"content":"Abstract é—®é¢˜ï¼šç°æœ‰ EEG æƒ…ç»ªè¯†åˆ«æ–¹æ³•å¯¹é•¿æœŸä¸Šä¸‹æ–‡ä¿¡æ¯å…³æ³¨ä¸è¶³ï¼Œå¯¼è‡´è·¨è¢«è¯•æ³›åŒ–èƒ½åŠ›å‡å¼± æ–¹æ¡ˆï¼šæå‡º Emotion Transformer (EmT) ï¼Œä¸º Graph-Transformer æ··å’Œæ¶æ„ æ ¸å¿ƒæ¨¡å—ï¼š TGCï¼šå°† EEG ä¿¡å·è½¬æ¢ä¸ºæ—¶åºå›¾åºåˆ— RMPGï¼šä½¿ç”¨æ®‹å·®å¤šè§†å›¾é‡‘å­—å¡” GCNï¼Œå­¦ä¹ åŠ¨æ€ã€å¤šå°ºåº¦çš„ç©ºé—´è¿æ¥æ¨¡å¼ï¼Œç”Ÿæˆ tokenï¼ˆæ ¸å¿ƒï¼‰ TCTï¼šä½¿ç”¨ä»»åŠ¡è‡ªé€‚åº”çš„ Transformerï¼Œå­¦ä¹  token åºåˆ—ä¸Šä¸‹æ–‡ï¼ˆæ ¸å¿ƒï¼‰ TSOï¼šè¾“å‡ºåˆ†ç±»/å›å½’ç»“æœ æˆæœï¼šåœ¨å¤šä¸ªå…¬å¼€æ•°æ®é›†çš„å¹¿ä¹‰è·¨è¢«è¯•ä»»åŠ¡ä¸Šé¢è¶…è¿‡äº† baseline Introduction \u0026amp; Related Work ä¸ºä»€ä¹ˆ EEG éš¾ä»¥ä½¿ç”¨è·¨è¢«è¯• (cross-subject) çš„åœºæ™¯ï¼Ÿ\nä¸ªä½“å·®å¼‚ï¼šä¸åŒè¢«è¯•ç”Ÿç†ç»“æ„å’Œè®¤çŸ¥ç­–ç•¥å·®å¼‚ï¼Œå¯¼è‡´ EEG æ¨¡å¼ä¸åŒ ä½ä¿¡å™ªæ¯”ï¼šEEG ä¿¡å·å®¹æ˜“å—åˆ°å¤–æºå™ªå£°å¹²æ‰°ï¼ˆè‚Œç”µã€çœ¼ç”µâ€¦â€¦ï¼‰ ç›®æ ‡æ˜¯å­¦ä¹ ä¸€ç§è·¨è¢«è¯•å…±äº«ã€å…·æœ‰æ³›åŒ–èƒ½åŠ›çš„æƒ…ç»ªè¡¨å¾\nGpaph Neural Networks æ ¸å¿ƒæ€æƒ³ï¼šEEG æ•°æ®å…·æœ‰éæ¬§å›¾ç»“æ„ï¼Œé€‚åˆä½¿ç”¨ GNN æ¥å¤„ç† ä»£è¡¨å·¥ä½œï¼š ChebyNetï¼šä½¿ç”¨åˆ‡æ¯”é›ªå¤«å¤šé¡¹å¼è¿‘ä¼¼å…‰è°±æ»¤æ³¢ï¼ŒEmT æ¨¡å‹ä¸­é‡‡ç”¨å…¶ä½œä¸º GCN å±‚ GCNï¼šé€šè¿‡å±€éƒ¨ä¸€é˜¶èšåˆè¿‘ä¼¼å…‰è°±æ»¤æ³¢ DGCNN / RGNNï¼šä½¿ç”¨ GNNs æå– EEG ç©ºé—´ä¿¡æ¯ï¼›ä¾èµ–å•ä¸€çš„é‚»æ¥çŸ©é˜µï¼Œå¿½ç•¥æ—¶åºä¸Šä¸‹æ–‡ï¼Œå…·æœ‰å±€é™æ€§ï¼›è€Œ EmT é€šè¿‡å¤šè§†å›¾å¯å­¦ä¹ é‚»æ¥çŸ©é˜µå’Œæ—¶åºå›¾æ¥å¼¥è¡¥ Temporal Context Learning æ ¸å¿ƒç†å¿µï¼šæƒ…ç»ªæ˜¯è¿ç»­è®¤çŸ¥è¿‡ç¨‹ï¼ŒEEG ä¿¡å·ä¸­åµŒå…¥æ—¶åºä¸Šä¸‹æ–‡ä¿¡æ¯ ä»£è¡¨å·¥ä½œï¼š LSTM / TCN / TESANet / Conformer / AMDET å±€é™æ€§ï¼šè¿™äº›æ–¹æ³•é€šå¸¸ä»æ‰å¹³åŒ–çš„ EEG ç‰¹å¾å‘é‡å­¦ä¹ ï¼Œå¯èƒ½æœªèƒ½æœ‰æ•ˆå­¦ä¹ ç©ºé—´å…³ç³»ï¼›EmT åˆ™é€šè¿‡å¹¶è¡Œ GCN å’Œ STA å±‚æ›´æœ‰æ•ˆåœ°æ•æ‰æ—¶ç©ºä¿¡æ¯ EEG Emotion Recognition æ ¸å¿ƒç†å¿µï¼šEEG æƒ…ç»ªè¯†åˆ«é¢ä¸´ä¸ªä½“å·®å¼‚å¤§ã€ä¿¡å™ªæ¯”ä½ç­‰æŒ‘æˆ˜ï¼Œéœ€æå–å…‰è°±ã€ç©ºé—´ã€æ—¶åºç‰¹å¾ ä»£è¡¨å·¥ä½œï¼š GCB-Net / TSception å±€é™æ€§ï¼šæ²¡æœ‰å…³æ³¨é•¿æ—¶åºä¸Šä¸‹æ–‡ä¿¡æ¯ Method EmT æ˜¯ä¸€ä¸ªç«¯åˆ°ç«¯çš„æ¡†æ¶ï¼ŒåŒ…å«å››å¤§æ¨¡å—ï¼š\nraw EEG -\u0026gt; TGC -\u0026gt; æ—¶åºå›¾ -\u0026gt; RMPG -\u0026gt; Tokens -\u0026gt; TCT -\u0026gt; æ·±å±‚ç‰¹å¾ -\u0026gt; TSO -\u0026gt; Result\nEEG-Temporal-Graph Representations (TGC) ç›®æ ‡ï¼šå°†è¿ç»­çš„ EEG ä¿¡å·è½¬åŒ–ä¸ºç»“æ„åŒ–çš„æ—¶åºå›¾åºåˆ—\nå›¾ï¼šæ¯ä¸ªâ€œå›¾â€æ˜¯æŒ‡åœ¨ä¸€ä¸ªçŸ­çš„çª—å£å†…å¤§è„‘çŠ¶æ€çš„æ•°å­¦è¡¨ç¤ºï¼Œå›¾ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”ä¸€ä¸ª EEG ç”µæé€šé“ï¼ŒèŠ‚ç‚¹çš„ç‰¹å¾æ˜¯è¯¥é€šé“åœ¨ 7 ä¸ªä¸åŒçš„é¢‘æ®µä¸Šçš„ rPSD æ—¶åºåºåˆ—ï¼šåºåˆ—æ˜¯é€šè¿‡æ»‘åŠ¨çª—å£æŠ€æœ¯æˆªå–çš„ä¸€æ®µè¾ƒé•¿çš„ EEG æ•°æ®é‡Œé¢åˆ‡åˆ†æˆè®¸å¤šé‡å çš„çŸ­çš„å­ç‰‡æ®µï¼Œæ¯ä¸ªå­ç‰‡æ®µç”Ÿæˆçš„å›¾æ‰€å½¢æˆçš„åºåˆ— åŒå±‚æ»‘åŠ¨çª—å£åˆ†æ®µï¼šä¸ºäº†æ•æ‰ä¸åŒæ—¶é—´å°ºåº¦ä¸Šçš„ä¿¡æ¯ï¼ŒTGC é‡‡ç”¨äº†ä¸€ç§åŒå±‚åˆ†æ®µç­–ç•¥\né¦–å…ˆå°†ä¸€æ¬¡å®Œæ•´å®éªŒçš„ (trail) çš„ EEG æ•°æ®ï¼Œè¡¨ç¤ºä¸º $ X \\in \\mathbb{R}^{c \\times L} $ ï¼ˆå…¶ä¸­ $ c $ ä¸ºé€šé“æ•°ï¼Œ$ L $ ä¸ºæ€»é‡‡æ ·ç‚¹æ•°ï¼‰ï¼Œé€šè¿‡ä¸€ä¸ªè¾ƒé•¿çš„æ»‘åŠ¨çª—å£ï¼ˆé•¿åº¦ä¸º $ l $ ï¼Œæ­¥é•¿ä¸º $ s $ ï¼‰åˆ†å‰²æˆå¤šä¸ªé‡å çš„é•¿ç‰‡æ®µ $ \\overline{X} \\in \\mathbb{R}^{c \\times l} $ æ¥ç€å¯¹äºæ¯ä¸€ä¸ªé•¿ç‰‡æ®µ $ \\overline{X} $ ä½¿ç”¨ä¸€ä¸ªæ›´çŸ­çš„æ»‘åŠ¨çª—å£ï¼ˆé•¿åº¦ä¸º $ l' $ ï¼Œæ­¥é•¿ä¸º $ s' $ ï¼‰å°†å…¶åˆ†å‰²ä¸ºä¸€ç³»åˆ—å­ç‰‡æ®µ $ \\tilde{X} \\in \\mathbb{R}^{c \\times l'} $ è¿™ä½¿å¾—æ¨¡å‹èƒ½å¤Ÿåœ¨ä¸€ä¸ªé•¿ç‰‡æ®µçš„æ ‡ç­¾ä¸‹ï¼Œè§‚å¯Ÿåˆ°å†…éƒ¨æ›´ç²¾ç»†çš„ä¿¡å·åŠ¨æ€å˜åŒ–ï¼Œä¸ºåç»­çš„ Transformer æ¨¡å—æ•æ‰æ—¶é—´ä¸Šä¸‹æ–‡æä¾›äº†åŸºç¡€ èŠ‚ç‚¹ç‰¹å¾æå–ï¼šå¯¹äºæ¯ä¸€ä¸ªå­ç‰‡æ®µ $ \\tilde{X} $ï¼Œéœ€è¦ä¸ºå…¶å¯¹åº”çš„å›¾èŠ‚ç‚¹ï¼ˆå³ EEG é€šé“ï¼‰æå–æœ‰æ„ä¹‰çš„ç‰¹å¾ï¼Œè®ºæ–‡é€‰æ‹©äº†ç›¸å¯¹åŠŸç‡è°±å¯†åº¦ (Relative PSD, rPSD) ä½œä¸ºèŠ‚ç‚¹å±æ€§\nå…·ä½“åœ°ï¼Œä½¿ç”¨ welch\u0026rsquo;s method è®¡ç®—æ¯ä¸ª EEG é€šé“åœ¨ä¸ƒä¸ªç»å…¸é¢‘å¸¦ä¸Šçš„ rPSD è¿™æ ·ï¼Œæ¯ä¸ªå­ç‰‡æ®µ $ \\tilde{X} $ éƒ½å¯¹åº”ä¸€ä¸ªç‰¹å¾çŸ©é˜µ $ F \\in \\mathbb{R}^{c \\times f} $ï¼Œå…¶ä¸­ $ f=7 $ æœ€ç»ˆï¼Œä¸€ä¸ªé•¿ç‰‡æ®µ $ \\overline{X} $ è¢«è½¬æ¢æˆä¸€ä¸ªæŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„å›¾åºåˆ— $ G_{T} = \\{\\mathcal{G}^{i}\\} \\in \\mathbb{R}^{seq \\times c \\times f} $ï¼Œå…¶ä¸­ $ seq $ æ˜¯å­ç‰‡æ®µçš„æ•°é‡ã€‚è¿™ä¸ªæ—¶é—´å›¾åºåˆ—å°±æ˜¯ RMPG æ¨¡å—çš„è¾“å…¥\nResidual Multiview Pyramid GCN (RMPG) æ ¸å¿ƒï¼šè§£å†³ä¼ ç»Ÿ GNNâ€œå•ä¸€è§†è§’â€é—®é¢˜ï¼Œä¸ºæ—¶é—´å›¾åºåˆ— $ G_{T} $â€‹ ä¸­çš„æ¯ä¸€ä¸ªå›¾ $ \\mathcal{G}^i $ å­¦ä¹ ä¸€ä¸ªä¸°å¯Œçš„ã€å¤šå±‚æ¬¡çš„ç©ºé—´è¡¨å¾ï¼Œå¹¶å°†å…¶å‹ç¼©æˆä¸€ä¸ªå•ä¸€çš„ token ï¼Œä»¥ä¾›åç»­çš„ TCT æ¨¡å—å¤„ç†\nRMPG æ¨¡å—ç”±ä¸€ä¸ªåŸºç¡€çš„å›¾ç¼–ç å™¨ $ \\Phi_{g}(\\cdot) $ æ„æˆï¼Œæ–‡ä¸­é‡‡ç”¨äº† ChebyNet ä½œä¸ºåŸºç¡€å›¾ç¼–ç å™¨ï¼Œå¯¹äºç»™å®šç‰¹å¾è¾“å…¥ $ F^{m-1} $ å’Œé‚»æ¥çŸ©é˜µ $ A $ ï¼ˆé€šè¿‡æ‹‰æ™®æ‹‰æ–¯ç®—å­ $ \\hat{L} $ è½¬æ¢ï¼‰ $$ \\Phi_{g}(F^{m}, A) = \\sigma\\left( \\sum_{k=0}^{K-1}\\theta_{k}^{m}T_{k}(\\hat{L})F^{m-1} - b^{m}\\right) $$ å…¶ä¸­ $ m $ ä¸º GCN å±‚çš„ç´¢å¼•ï¼Œ$ \\sigma $ ä¸º ReLU æ¿€æ´»å‡½æ•°ï¼Œ$ \\theta $ ä¸ºå‚æ•°ï¼Œ$ T_{k} $ ä¸º $ k $ é˜¶ Chebyshev å¤šé¡¹å¼\nå¤šè§†å›¾å­¦ä¹  (Multiview Learning) ï¼šä¸ºäº†æ¨¡æ‹Ÿæƒ…ç»ªèƒŒåå¤šç§è®¤çŸ¥å­è¿‡ç¨‹é©±åŠ¨çš„ä¸åŒå¤§è„‘è¿æ¥æ¨¡å¼ï¼ŒRMPG å¹¶éä½¿ç”¨å•ä¸€çš„å›¾å·ç§¯ç½‘ç»œï¼Œè€Œæ˜¯å¹¶è¡Œåœ°ä½¿ç”¨äº†å¤šä¸ª GCN åˆ†æ”¯ï¼Œ$ \\{ \\Phi_{g}^{0}(\\cdot), \\Phi_{g}^{1}(\\cdot), \\dots, \\Phi_{g}^{i}(\\cdot) \\} $\næ¯ä¸ªåˆ†æ”¯éƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„å¯å­¦ä¹ é‚»æ¥çŸ©é˜µ $ A^{i} \\in \\mathbb{R}^{c \\times c} $ ï¼Œèƒ½åœ¨æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­é€šè¿‡æ¢¯åº¦åå‘ä¼ æ’­è¿›è¡Œç«¯åˆ°ç«¯çš„ä¼˜åŒ– è¿™æ„å‘³ç€æ¯ä¸ª GCN åˆ†æ”¯éƒ½èƒ½ä»æ•°æ®ä¸­å­¦ä¹ åˆ°ä¸€ç§ç‹¬ç‰¹çš„å¤§è„‘åŠŸèƒ½è¿æ¥â€œè§†å›¾â€ é‡‘å­—å¡”å­¦ä¹  (Pyramid Learning) ï¼šä¸ºäº†æ•æ‰ä¸åŒå°ºåº¦çš„ç©ºé—´ä¿¡æ¯ï¼Œå¹¶è¡Œçš„ GCN åˆ†æ”¯è¢«è®¾è®¡æˆå…·æœ‰ä¸åŒçš„æ·±åº¦ï¼ˆå³ GCN å±‚æ•°ï¼‰\nè¾ƒæµ…çš„ GCN èƒ½å¤Ÿæœ‰æ•ˆåœ°èšåˆå…¨å±€çš„ã€è·¨è„‘åŒºçš„åŠŸèƒ½è¿æ¥ä¿¡æ¯ï¼Œèšåˆè¿œè·ç¦»èŠ‚ç‚¹çš„ä¿¡æ¯è€Œä¸è¿‡åº¦å¹³æ»‘ è¾ƒæ·±çš„ GCN èƒ½å¤Ÿæ›´å¥½åœ°èšåˆå±€éƒ¨é‚»åŸŸå†…çš„ä¿¡æ¯ï¼Œåœ¨è„‘åŒºå†…éƒ¨å½¢æˆä¸€è‡´çš„è¡¨å¾ GCN çš„æ·±åº¦è¶Šæ·±ï¼Œå…¶è¾“å‡ºæ‰€ä»£è¡¨çš„ç‰¹å¾é‡‘å­—å¡”å±‚çº§è¶Šé«˜ã€‚ æ®‹å·®è¿æ¥ (Residual) ï¼šé™¤äº†å¹¶è¡Œçš„ GCN åˆ†æ”¯å¤–ï¼ŒRMPG è¿˜åŒ…å«ä¸€ä¸ªå¹¶è¡Œçš„çº¿æ€§æ®‹å·®åˆ†æ”¯ã€‚è¯¥åˆ†æ”¯ç›´æ¥å¯¹åŸå§‹çš„æ—¶åºå›¾ $ G $ ï¼ˆæˆ–è€…å¯¹åº”çš„ç‰¹å¾çŸ©é˜µ $ F $ ï¼‰è¿›è¡Œçº¿æ€§æŠ•å½±ï¼Œä¸ç»è¿‡ä»»ä½•å›¾å·ç§¯ï¼Œä»è€Œä¿ç•™æœ€åŸå§‹çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œä½œä¸ºç‰¹å¾é‡‘å­—å¡”çš„â€œåŸºåº§â€\nçº¿æ€§æŠ•å½±å±‚ $ LP(\\cdot) $ å°†æ‰å¹³åŒ–çš„å›¾è¡¨ç¤ºæŠ•å½±åˆ°éšè—åµŒå…¥ $ H_{g}^{i} \\in \\mathbb{R}^{d_{g}} $ å †å æ¥è‡ªä¸åŒå±‚çš„ GCN çš„å¹¶è¡Œè¾“å‡ºï¼Œå¾—åˆ°å¤šé‡‘å­—å¡”è§†å›¾åµŒå…¥ $$ \\{ H_{g}^{i} \\} = \\{ LP^{i}(\\Gamma(\\Phi_{g}^{i}(F, A^{i}))) \\} $$ å…¶ä¸­ $ \\Gamma(\\cdot) $ æ˜¯æ‰å¹³æ“ä½œï¼Œ$ \\{ \\cdot \\} $ æ˜¯å †å æ“ä½œ ç‰¹å¾èåˆä¸ Token ç”Ÿæˆï¼šæœ€ç»ˆï¼Œå¯¹äºå›¾åºåˆ—ä¸­çš„æ¯ä¸€ä¸ªå›¾ $ G_{i} $ï¼Œå…¶æ‰€æœ‰ GCN è§†å›¾çš„è¾“å‡º $ \\{ H_{i}^{g} \\} $ å’Œæ®‹å·®åŸºåº§ $ H_{g-\\text{base}} $â€‹ é€šè¿‡ä¸€ä¸ª mean fusion æ“ä½œåˆå¹¶æˆå½“å‰æ—¶é—´æ­¥ $ i $ çš„æœ€ç»ˆ token $ s_{i} $ $$ s_{i} = \\text{mean}(\\{ H_{g-\\text{base}}, H_{g}^{0}, H_{g}^{1}, \\dots, H_{g}^{i} \\}) $$\né€šè¿‡ RMPG æ¨¡å—ï¼Œè¾“å…¥çš„å›¾åºåˆ— $ G_{T} $ è¢«é«˜æ•ˆåœ°è½¬åŒ–ä¸ºä¸€ä¸ª token åºåˆ— $ S_{T}=\\{ s^{i} \\} \\in \\mathbb{R}^{seq \\times d_{g}} $ ï¼Œè¿™ä¸ªåºåˆ—æ—¢è•´å«äº†æ¯ä¸ªæ—¶åˆ»ä¸°å¯Œçš„å¤šè§†å›¾ã€å¤šå±‚æ¬¡ç©ºé—´ä¿¡æ¯ï¼Œåˆå…·å¤‡äº†é€‚åˆ Transformer å¤„ç†çš„æ ¼å¼\nTemporal Contextual Transformer (TCT) æ ¸å¿ƒï¼šæ¥å—ç”± RMPG ç”Ÿæˆçš„ token åºåˆ— $ S_{T} $ ï¼Œå¹¶åˆ©ç”¨ Transformer çš„ç»“æ„æ¥é«˜æ•ˆæ•æ‰è¿™äº› token ä¹‹é—´çš„æ—¶é—´ä¾èµ–å…³ç³»ï¼›ä¸æ ‡å‡†çš„ Transformer ä¸åŒï¼ŒTCT å¼•å…¥äº†ä¸¤ç§ä¸º EEG æƒ…ç»ªè¯†åˆ«ä»»åŠ¡å®šåˆ¶çš„ Token Mixerï¼Œåˆ†åˆ«ç”¨äºåˆ†ç±»å’Œå›å½’ä»»åŠ¡\nTCT æ¨¡å—ç”±å¤šä¸ªå †å çš„ Transformer Block ç»„æˆï¼Œå¯¹äºè¾“å…¥ token åºåˆ— $ Z^{m} $ ï¼ˆ $ Z^{0} = S_{T} $ ï¼‰ï¼Œæ¯ä¸ª Block çš„è®¡ç®—è¿‡ç¨‹ä¸º $$ Z^{m'} = \\text{TokenMixer}(\\text{Norm}(Z^{m})) + Z^{m} $$ $$ Z^{m+1} = \\text{MLP}(\\text{Norm}(Z^{m'})) + Z^{m'} $$ å…¶ä¸­ $ m $ æ˜¯å±‚çš„ç´¢å¼•ï¼ŒMLP æ˜¯å¸¦ ReLU æ¿€æ´»å‡½æ•°çš„ä¸¤å±‚æ„ŸçŸ¥æœº\n$ \\text{TokenMixer}_{\\text{clas}} $ for Classification Tasks æ—¨åœ¨æ•æ‰éšæ—¶é—´å˜åŒ–çš„é•¿çŸ­æ—¶åºä¸Šä¸‹æ–‡ä¿¡æ¯\nå¤šå¤´è‡ªæ³¨æ„åŠ› (Multi-head Self-Attention, MSA) ï¼šç”¨äºå…¨å±€åœ°å…³æ³¨åºåˆ—ä¸­ä¸æ•´ä½“æƒ…ç»ªçŠ¶æ€é«˜åº¦ç›¸å…³çš„éƒ¨åˆ† $$ \\text{Attn}(Q,K,V) = \\text{softmax}\\left( \\frac{QK^{T}}{\\sqrt{ d }} \\right)V $$\nå¹¶è¡Œåº”ç”¨å¤šä¸ªæ³¨æ„åŠ›å¤´ï¼ˆæ¯ä¸ªå¤´æœ‰ç‹¬ç«‹çš„ $ LP_h(\\cdot) $ æ¥ç”Ÿæˆ $ Q, K, V $ï¼‰ï¼Œç„¶åå°†æ‰€æœ‰å¤´çš„è¾“å‡ºæ‹¼æ¥ï¼š$$ \\text{MSA}(S_{T}) = \\text{Concat}(\\text{Attn}(LP_0(S_{T})), ..., \\text{Attn}(LP_{n_{\\text{head}}-1}(S_{T}))) $$ å…¶ä¸­ $ S_{T} $ æ˜¯ token åºåˆ—ï¼Œ$ n_{\\text{head}} $ æ˜¯æ³¨æ„åŠ›å¤´çš„æ•°é‡ çŸ­æœŸèšåˆå±‚ (Short-Time Aggregation, STA) ï¼š\nåŸºäºâ€œæƒ…ç»ªçŸ­æœŸè¿ç»­è€Œé•¿æœŸå˜åŒ–â€çš„å…ˆéªŒçŸ¥è¯†ï¼ŒSTA åœ¨ MSA ä¹‹ååº”ç”¨æ¥å­¦ä¹ çŸ­æœŸçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ é¦–å…ˆå¯¹ MSA çš„è¾“å‡º $ H_{\\text{attn}} \\in \\mathbb{R}^{n_{\\text{head}} \\times \\text{seq} \\times d_{\\text{head}}} $ åº”ç”¨ä¸€ä¸ªå¸¦æœ‰æ¯”ä¾‹å› å­ $ \\alpha $ çš„ Dropout å±‚ $ \\text{dp}(\\alpha) $ æ¥ç€ï¼Œé€šè¿‡ Conv2D èšåˆ $ n_{\\text{anchor}} $ ä¸ªæ—¶åºè¿‘é‚» Conv2D çš„å·ç§¯æ ¸ $ K_{\\text{cnn}} $ çš„å°ºå¯¸ä¸º $ (n_{\\text{anchor}}, 1) $ï¼Œæ­¥é•¿ä¸º $ (1,1) $ æœ€åï¼Œå·ç§¯çš„è¾“å‡ºä¼šè¢« Reshape å¹¶è¿›è¡Œçº¿æ€§æŠ•å½±ï¼ˆ$ W_{\\text{sta}} $ï¼‰ å¯ä»¥æè¿°ä¸º $$ \\text{STA}(H_{\\text{attn}}) = \\text{Reshape}(\\text{Conv2D}(\\text{dp}(H_{\\text{attn}}), K_{\\text{cnn}})) W_{\\text{sta}} $$ $ \\text{Reshape}(\\cdot) $ å°†ç»´åº¦ä» $ (n_{\\text{head}},\\text{seq},d_{\\text{head}}) $ è½¬æ¢ä¸º $ (\\text{seq}, n_{\\text{head}} \\cdot d_{\\text{head}}) $ ï¼Œ $ W_{\\text{sta}} \\in \\mathbb{R}^{n_{\\text{head}} \\cdot d_{\\text{head}} \\times d_g} $ æ˜¯æŠ•å½±æƒé‡çŸ©é˜µ $ \\text{TokenMixer}_{\\text{Clas}} $ æœ€ç»ˆç”±ä¸Šè¿°ä¸¤ä¸ªæ¨¡å—ä¸²è”æ„æˆ $$ \\text{TokenMixer}_{\\text{clas}}(S_{T}) = \\text{STA}(\\text{MSA}(S_{T})) $$\n$ \\text{TokenMixer}_{\\text{regr}} $ for Regression Tasks æ—¨åœ¨é¢„æµ‹åºåˆ—ä¸­æƒ…ç»ªçŠ¶æ€çš„è¿ç»­å˜åŒ–\nä¸åŒäºåˆ†ç±»ä»»åŠ¡ï¼šåˆ†ç±»ä»»åŠ¡çš„ç›®æ ‡é€šå¸¸æ˜¯ä»æ•´ä¸ªåºåˆ—ä¸­æå–å‡ ä¸ªæ ¸å¿ƒç‰¹å¾æ¥åˆ¤æ–­æ•´ä½“æƒ…ç»ªçŠ¶æ€ï¼Œè¿™é€šè¿‡ MSA èšç„¦äºé‡è¦éƒ¨åˆ†æ˜¯æœ‰æ•ˆçš„ï¼›ç„¶è€Œå›å½’ä»»åŠ¡éœ€è¦æ¨¡å‹å¯¹åºåˆ—ä¸­æ¯ä¸ªæ—¶æ­¥çš„è¿ç»­æƒ…ç»ªå˜åŒ–è¿›è¡Œé¢„æµ‹ï¼Œå› æ­¤ä¸ä½¿ç”¨å…¨å±€çš„ MSAï¼Œè€Œæ˜¯é‡‡ç”¨äº†ä¸€ç§åŸºäº RNN çš„æ··åˆå™¨ï¼ˆ RNN family ï¼‰\nRNN Mixer ï¼š\nRNN ç»“æ„å¤©ç„¶é€‚åˆå¤„ç†è¿ç»­åºåˆ—çš„æ¼”å˜è¿‡ç¨‹ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°å»ºæ¨¡æƒ…ç»ªå€¼çš„å¹³æ»‘å˜åŒ– ç»éªŒæ€§é€‰æ‹©çš„ä¸¤å±‚åŒå‘ GRU (bi-directional GRU)Â ä½œä¸º $ \\text{TokenMixer}_{\\text{regr}} $ ï¼Œè¾“å‡ºé•¿åº¦ä¸º $ 2 \\times d_{\\text{head}} $ è®¡ç®—è¿‡ç¨‹ä¸º $$ \\text{TokenMixer}_{\\text{regr}}(S_T) = \\text{RNNs}(\\text{LP}(S_T)) $$ å…¶ä¸­ $ LP(S_{T}) = S_{T}W_{v} $ ï¼ŒæŠŠ token åºåˆ—æŠ•å½±ä¸º $ V $ å€¼\nTSO Module å¤´éƒ¨æ¥æ”¶æ¥è‡ªä¸åŒ Token Mixer çš„è¾“å‡ºï¼šç”¨äºåˆ†ç±»çš„ $ S_{\\text{clas}} $ å’Œç”¨äºå›å½’çš„ $ S_{\\text{regr}} $\nåˆ†ç±»ä»»åŠ¡ï¼šå¯¹æ‰€æœ‰ token è¿›è¡Œ mean fusion ï¼Œå†é€šè¿‡çº¿æ€§å±‚å¾—åˆ°æœ€ç»ˆ logits $$ \\hat{Y}_{\\text{clas}} = \\text{mean}(S_{\\text{clas}})W_{\\text{clas}} + b_{\\text{clas}} $$ å…¶ä¸­ $ S_{\\text{clas}} \\in \\mathbb{R}^{\\text{seq} \\times d_{\\text{head}}} $ ï¼Œ$ W_{\\text{clas}} \\in \\mathbb{R}^{d_{\\text{head}} \\times d_{\\text{class}}} $ ï¼Œ$ b_{\\text{clas}} \\in \\mathbb{R}^{n_{\\text{class}}} $\nå›å½’ä»»åŠ¡ï¼šç›´æ¥å°†æ¯ä¸ªæ—¶é—´æ­¥çš„ token ç‰¹å¾é€šè¿‡çº¿æ€§å±‚ï¼Œå¾—åˆ°å¯¹åº”æ¯ä¸ªæ—¶åˆ»çš„å›å½’å€¼ $$ \\hat{Y}_{\\text{regr}} = S_{\\text{regr}}W_{\\text{regr}} + b_{\\text{regr}} $$ å…¶ä¸­ $ S_{\\text{regr}} \\in \\mathbb{R}^{\\text{seq} \\times 2\\cdot d_{\\text{head}}} $ ï¼ˆåŒå‘ï¼‰ï¼Œ$ W_{\\text{regr}} \\in \\mathbb{R}^{2\\cdot d_{\\text{head}} \\times 1} $ ï¼Œ$ b_{\\text{regr}} \\in \\mathbb{R} $\nExperiment Datasets ä½¿ç”¨ SEED, THU-EP, FACED, MAHNOB-HCI å››ä¸ªå…¬å¼€æ•°æ®é›†\nå…¶ä¸­ SEED æ•°æ®é›†ä½¿ç”¨äº† 0.3-50 Hz çš„å¸¦é€šæ»¤æ³¢\nEEG-Temporal-Graph é•¿ç‰‡æ®µï¼šçª—å£é•¿åº¦ $ l=20\\,\\mathrm{s} $ ï¼ˆå³ $ 20 \\times f_{s} $ ï¼‰ï¼Œæ­¥é•¿ $ s=4\\,\\mathrm{s} $ å­ç‰‡æ®µï¼š å¯¹äº SEED å’Œ THU-EPï¼š $ l'=2\\,\\mathrm{s},s'=0.5\\,\\mathrm{s} $ å¯¹äº FACEDï¼š $ l'=4\\,\\mathrm{s},s'=1\\,\\mathrm{s} $ Settings æ•°æ®åˆ’åˆ†ï¼š SEEDï¼šé‡‡ç”¨ç•™ä¸€è¢«è¯•äº¤å‰éªŒè¯ï¼Œæ¯æ¬¡è¿­ä»£ä¸€ä¸ªè¢«è¯•çš„æ•°æ®ä½œä¸ºæµ‹è¯•é›†ï¼Œå‰©ä½™æ•°æ®ä¸­ 80% ä½œä¸ºè®­ç»ƒé›†ï¼Œ20% ä½œä¸ºéªŒè¯é›† THU-EP å’Œ FACEDï¼šé‡‡ç”¨ç•™ $ n $ è¢«è¯•äº¤å‰éªŒè¯ï¼Œå…¶ä¸­ $ n_{\\text{THU-EP}}=8,n_{\\text{FACED}}=12 $ ï¼Œè®­ç»ƒæ•°æ®ä¸­ 10% ä½œä¸ºéªŒè¯é›† åˆ†ç±»ä»»åŠ¡ï¼šå¯¹ SEEDã€THU-EP å’Œ FACED è¿›è¡Œç§¯æ/æ¶ˆææƒ…ç»ªçš„äºŒåˆ†ç±»ï¼ŒTHU-EP å’Œ FACED çš„æ•ˆä»·åˆ†æ•°é€šè¿‡é˜ˆå€¼ 3.0 åˆ’åˆ†ä¸ºé«˜/ä½æ•ˆä»· å›å½’ä»»åŠ¡ï¼šMAHNOB-HCI å¹¶è¿›è¡Œ LOSO éªŒè¯ Evaluation Metrics Classfication Accuracyï¼š$$ \\text{Accuracy} = \\frac{\\text{TP + TN}}{\\text{TP + FP + TN + FN}} $$ F1 Scoreï¼š$$ \\text{F1} = 2 \\times \\frac{\\text{Precision} \\times \\text{Recall}}{\\text{Precision + Recall}} = \\frac{\\text{TP}}{\\text{TP} + \\frac{1}{2}(\\text{FP} + \\text{FN})} $$ å…¶ä¸­ $ \\text{TP} $ è¡¨ç¤ºçœŸé˜³æ€§ï¼Œ$ \\text{TN} $ è¡¨ç¤ºçœŸé˜´æ€§ï¼Œ$ \\text{FP} $ è¡¨ç¤ºå‡é˜³æ€§ï¼Œ$ \\text{FN} $ è¡¨ç¤ºå‡é˜´æ€§\nRegression ç»™å®šé¢„æµ‹å€¼ $ \\hat{y} $ å’Œè¿ç»­æ ‡ç­¾ $ y $ ï¼š\nå‡æ–¹æ ¹è¯¯å·® (RMSE) ï¼š$$ \\text{RMSE} = \\sqrt{\\frac{1}{N} \\sum_{i=0}^{N-1} (\\hat{y}_i - y_i)^2} $$ çš®å°”é€Šç›¸å…³ç³»æ•° (PCC) ï¼š$$ \\text{PCC} = \\frac{\\sigma_{\\hat{y}y}}{\\sigma_{\\hat{y}} \\sigma_y} = \\frac{\\sum_{i=0}^{N-1} (\\hat{y}_i - \\mu_{\\hat{y}})(\\hat{y}_i - \\mu_y)}{\\sqrt{\\sum_{i=0}^{N-1} (\\hat{y}_i - \\mu_{\\hat{y}})^2} \\sqrt{\\sum_{i=0}^{N-1} (y_i - \\mu_y)^2}} $$ ä¸€è‡´æ€§ç›¸å…³ç³»æ•° (CCC) ï¼š$$ \\text{CCC} = \\frac{2\\sigma_{\\hat{y}y}}{\\sigma^2_{\\hat{y}} + \\sigma^2_y + (\\mu_{\\hat{y}} - \\mu_y)^2} $$ å…¶ä¸­ $ N $ æ˜¯å‘é‡ä¸­çš„å…ƒç´ æ•°é‡ï¼Œ$ \\sigma_{\\hat{y}y} $ æ˜¯åæ–¹å·®ï¼Œ$ \\sigma_{\\hat{y}} $ å’Œ $ \\sigma_y $ æ˜¯æ ‡å‡†å·®ï¼Œ$ \\mu_{\\hat{y}} $ å’Œ $ \\mu_y $ æ˜¯å‡å€¼\nImplementation Details æ¨¡å‹çš„ä¸‰ç§å˜ä½“ï¼š Analyses Classification SEEDï¼š EmT-D è¡¨ç°æœ€ä½³ï¼ŒEmT-B å’Œ EmT-S è¡¨ç°ä¹Ÿè‰¯å¥½ï¼ŒRGNN è¡¨ç°ç¬¬äºŒä½³ ä½¿ç”¨ç‰¹å¾ä½œä¸ºè¾“å…¥çš„æ¨¡å‹é€šå¸¸ä¼˜äºç›´æ¥ä½¿ç”¨ EEG ä¿¡å·ä½œä¸ºè¾“å…¥çš„æ¨¡å‹ï¼Œä»æ—¶åºç‰¹å¾è€Œéç›´æ¥ç‰¹å¾å­¦ä¹ é€šå¸¸èƒ½å–å¾—æ›´å¥½çš„æ€§èƒ½ï¼ˆRGNN é™¤å¤–ï¼‰ï¼Œè¿™è¡¨æ˜äº†å­¦ä¹ æ—¶åºä¸Šä¸‹æ–‡ä¿¡æ¯çš„æœ‰æ•ˆæ€§ï¼ŒEmT å€ŸåŠ©åŸºäº GCN çš„æ¨¡å—ï¼Œèƒ½æ›´å¥½åœ°å­¦ä¹ ç©ºé—´ä¿¡æ¯ THU-EP / FACEDï¼š THU-EPï¼šEmT-B å–å¾—äº†æœ€ä½³ F1 åˆ†æ•°ï¼ŒConformer å–å¾—äº†æœ€ä½³ ACC FACEDï¼šEmT-B å–å¾—äº†ç¬¬äºŒä½³ ACC å’Œæœ€ä½³ F1 åˆ†æ•° ç”±äºç±»ä¸å¹³è¡¡ï¼ŒF1 åˆ†æ•°æ¯” ACC æ›´é‡è¦ï¼ŒEmT-B åœ¨è¿™ä¸¤ä¸ªæ•°æ®é›†ä¸Šå‡å–å¾—äº†æœ€é«˜ F1 åˆ†æ•° ä¸ SEED ä¸åŒï¼Œç›´æ¥ä½¿ç”¨ EEG ä½œä¸ºè¾“å…¥çš„ baseline æ¨¡å‹è¡¨ç°æ›´å¥½ï¼Œè¿™å¯èƒ½å› ä¸ºè¿™ä¸¤ä¸ªæ•°æ®é›†çš„è¢«è¯•äººæ•°æ›´å¤š Featuresï¼š SEED (62 channelsï¼Œ15 subjects) ï¼šEmT-D (8 å±‚) è¡¨ç°æœ€ä½³ï¼Œè¯´æ˜ Transformer å±‚æ•°è¶Šå¤šï¼Œå­¦åˆ°çš„ç©ºé—´ä¿¡æ¯è¶Šä¸°å¯Œ THU-EP å’Œ FACED (32 channelsï¼Œmore subjects) ï¼šEmT-B (4 å±‚) è¡¨ç°æ›´å¥½ï¼Œé€šé“æ•°å°‘ä¸”è¢«è¯•é—´å˜å¼‚æ€§å¤§æ—¶ï¼Œæ›´æ·±çš„æ¨¡å‹ï¼ˆEmT-Dï¼‰å®¹æ˜“è¿‡æ‹Ÿåˆ Regression åœ¨ MAHNOB-HCI æ•°æ®é›†ä¸Šï¼ŒEmT-Regr (LP+LSTM) å–å¾—äº†æœ€ä½çš„ RMSEï¼Œè€Œ EmT-Regr (LP+GRU) å–å¾—äº†æœ€ä½³çš„ PCC å’Œ CCC ä½¿ç”¨ MSA ä½œä¸º Token Mixer æ—¶ï¼Œæ¨¡å‹æ€§èƒ½æ€¥å‰§ä¸‹é™ï¼Œç”šè‡³ä½äºæ‰€æœ‰åŸºçº¿æ¨¡å‹ è¿™è¡¨æ˜å¯¹äºå›å½’ä»»åŠ¡ï¼Œèåˆæ‰€æœ‰ç‰‡æ®µçš„ä¿¡æ¯è‡³å…³é‡è¦ï¼Œè€Œ RNN çš„é¡ºåºä¿¡æ¯èåˆèƒ½åŠ›æ¯” MSA æ›´é€‚åˆå»ºæ¨¡è¿ç»­çš„æƒ…ç»ªå˜åŒ– Ablation Study Effect of EEG Features Effect of The Depth and Width of GCNs in RMPG Depthï¼šå¢åŠ  GCN å±‚çš„æ•°é‡ä¼šå¯¼è‡´æ€§èƒ½æ˜¾è‘—ä¸‹é™ï¼Œè¿™ä¸æ›´æ·± GCN ä¸­å­˜åœ¨çš„è¿‡å¹³æ»‘é—®é¢˜ä¸€è‡´ Widthï¼šå®½åº¦ä» 8 å¢åŠ åˆ° 32 æ—¶ï¼Œæ€§èƒ½å‘ˆæ­£ç›¸å…³ï¼›å½“å®½åº¦è¿›ä¸€æ­¥å¢åŠ æ—¶ï¼Œæ€§èƒ½ä¸‹é™ï¼Œè¿™å¯èƒ½æ˜¯ç”±æ›´å¤§çš„æ¨¡å‹å°ºå¯¸å¯¼è‡´çš„è¿‡æ‹Ÿåˆ Effect of The Number of TCT Blocks Classfication (SEED) ï¼šTCT å—çš„æ•°é‡ä» 2 å¢åŠ åˆ° 8 æ—¶ï¼ŒACC å’Œ F1 åˆ†æ•°å‡æ˜¾è‘—æé«˜ï¼Œè¿™è¡¨æ˜å¢åŠ  TCT å—æ•°èƒ½å¢å¼ºæ¨¡å‹æ•æ‰æ—¶åºä¸Šä¸‹æ–‡ä¿¡æ¯çš„èƒ½åŠ›ï¼Œä»è€Œæå‡åˆ†ç±»æ€§èƒ½ Regression (MAHNOB-HCI) ï¼šTCT å—çš„æ•°é‡å¯¹æ€§èƒ½æŒ‡æ ‡å‡ ä¹æ²¡æœ‰å½±å“ Visualization Learned Connections åœ¨ SEED æ•°æ®é›†ä¸Šå­¦ä¹ åˆ°çš„ä¸¤ç§ä¸åŒè¿æ¥æ¨¡å¼çš„å¯è§†åŒ–è¯æ® åœ¨ SEED æ•°æ®é›†ä¸Šï¼Œä¸¤ä¸ªå¯å­¦ä¹ çš„é‚»æ¥çŸ©é˜µæ­ç¤ºäº†æƒ…ç»ªè®¤çŸ¥è¿‡ç¨‹ä¸­ä¸åŒçš„è¿æ¥æ¨¡å¼ï¼š\n(a) ä¸­ä¸»è¦å…³æ³¨é¢å¶ã€é¡¶å¶å’Œé¢å¶åŒºåŸŸä¹‹é—´çš„è¿æ¥ï¼Œè¿™äº›åŒºåŸŸä¸å¿ƒç†æ³¨æ„åŠ›å¯†åˆ‡ç›¸å…³ (b) ä¸­åˆ™åŒ…æ‹¬é¢å¶ã€é¢å¶å’Œé¡¶å¶åŒºåŸŸä¹‹é—´çš„äº’åŠ¨ï¼ˆä¸æƒ…ç»ªç›¸å…³ï¼‰ï¼Œä»¥åŠæ•å¶å’Œé¡¶å¶åŒºåŸŸçš„äº’åŠ¨ï¼ˆä¸è§†è§‰è¿‡ç¨‹ç›¸å…³ï¼Œå› ä¸ºåˆºæ¿€ä¸ºè§†é¢‘ï¼‰ Learned Temporal Contextual Information Classfication (FACED) Regression åˆ†ç±»ä»»åŠ¡åœ¨ TCT å—ä¹‹å‰ï¼Œç‰¹å¾éšæ—¶é—´å˜åŒ–ï¼ŒTCT å—ä¹‹åï¼Œæ¿€æ´»å˜å¾—æ›´åŠ ä¸€è‡´ï¼›è¿™å¯èƒ½æ˜¯å› ä¸ºè‡ªæ³¨æ„åŠ›æœºåˆ¶å…³æ³¨ä¸æ•´ä½“æƒ…ç»ªçŠ¶æ€é«˜åº¦ç›¸å…³çš„éƒ¨åˆ†ï¼Œè€Œ STA å±‚é€šè¿‡èšåˆé‚»è¿‘çš„æ—¶åºä¿¡æ¯æ¥å¹³æ»‘æ³¢åŠ¨ å›å½’ä»»åŠ¡ï¼šç‰¹å¾ç©ºé—´ä¹Ÿæ˜¾ç¤ºå‡ºæ—¶åºå˜åŒ–ï¼›ä¸åˆ†ç±»ä¸åŒï¼Œå›å½’ç‰¹å¾å¹¶éç®€å•å¹³æ»‘ï¼Œå½¢æˆäº†æ›´å¤æ‚çš„è¡¨ç¤º æ€»ç»“ï¼šTCT å—å¤„ç†åˆ†ç±»å’Œå›å½’ä»»åŠ¡çš„æ–¹å¼ä¸åŒï¼šåˆ†ç±»ä¸­ï¼Œç‰¹å¾è¢«å¹³æ»‘ä»¥å¢å¼ºå¯åˆ†ç¦»æ€§ï¼›å›å½’ä¸­ï¼ŒRNN Token Mixer ä¿ç•™äº†æ—¶åºå˜åŒ–ï¼Œä»è€Œå®ç°è¿ç»­æƒ…ç»ªé¢„æµ‹ ","permalink":"https://diefish1024.github.io/posts/literature-notes/emt/","summary":"\u003ch2 id=\"abstract\"\u003eAbstract\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eé—®é¢˜\u003c/strong\u003eï¼šç°æœ‰ EEG æƒ…ç»ªè¯†åˆ«æ–¹æ³•å¯¹é•¿æœŸä¸Šä¸‹æ–‡ä¿¡æ¯å…³æ³¨ä¸è¶³ï¼Œå¯¼è‡´è·¨è¢«è¯•æ³›åŒ–èƒ½åŠ›å‡å¼±\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ–¹æ¡ˆ\u003c/strong\u003eï¼šæå‡º \u003cstrong\u003eEmotion Transformer (EmT)\u003c/strong\u003e ï¼Œä¸º Graph-Transformer æ··å’Œæ¶æ„\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ ¸å¿ƒæ¨¡å—\u003c/strong\u003eï¼š\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eTGC\u003c/strong\u003eï¼šå°† EEG ä¿¡å·è½¬æ¢ä¸ºæ—¶åºå›¾åºåˆ—\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eRMPG\u003c/strong\u003eï¼šä½¿ç”¨æ®‹å·®å¤šè§†å›¾é‡‘å­—å¡” GCNï¼Œå­¦ä¹ åŠ¨æ€ã€å¤šå°ºåº¦çš„ç©ºé—´è¿æ¥æ¨¡å¼ï¼Œç”Ÿæˆ tokenï¼ˆæ ¸å¿ƒï¼‰\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eTCT\u003c/strong\u003eï¼šä½¿ç”¨ä»»åŠ¡è‡ªé€‚åº”çš„ Transformerï¼Œå­¦ä¹  token åºåˆ—ä¸Šä¸‹æ–‡ï¼ˆæ ¸å¿ƒï¼‰\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eTSO\u003c/strong\u003eï¼šè¾“å‡ºåˆ†ç±»/å›å½’ç»“æœ\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæˆæœ\u003c/strong\u003eï¼šåœ¨å¤šä¸ªå…¬å¼€æ•°æ®é›†çš„å¹¿ä¹‰è·¨è¢«è¯•ä»»åŠ¡ä¸Šé¢è¶…è¿‡äº† baseline\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"introduction--related-work\"\u003eIntroduction \u0026amp; Related Work\u003c/h2\u003e\n\u003cp\u003eä¸ºä»€ä¹ˆ EEG éš¾ä»¥ä½¿ç”¨è·¨è¢«è¯• (cross-subject) çš„åœºæ™¯ï¼Ÿ\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eä¸ªä½“å·®å¼‚\u003c/strong\u003eï¼šä¸åŒè¢«è¯•ç”Ÿç†ç»“æ„å’Œè®¤çŸ¥ç­–ç•¥å·®å¼‚ï¼Œå¯¼è‡´ EEG æ¨¡å¼ä¸åŒ\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eä½ä¿¡å™ªæ¯”\u003c/strong\u003eï¼šEEG ä¿¡å·å®¹æ˜“å—åˆ°å¤–æºå™ªå£°å¹²æ‰°ï¼ˆè‚Œç”µã€çœ¼ç”µâ€¦â€¦ï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç›®æ ‡æ˜¯å­¦ä¹ ä¸€ç§\u003cstrong\u003eè·¨è¢«è¯•å…±äº«\u003c/strong\u003eã€å…·æœ‰\u003cstrong\u003eæ³›åŒ–èƒ½åŠ›\u003c/strong\u003eçš„æƒ…ç»ªè¡¨å¾\u003c/p\u003e\n\u003ch3 id=\"gpaph-neural-networks\"\u003eGpaph Neural Networks\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eæ ¸å¿ƒæ€æƒ³\u003c/strong\u003eï¼šEEG æ•°æ®å…·æœ‰éæ¬§å›¾ç»“æ„ï¼Œé€‚åˆä½¿ç”¨ GNN æ¥å¤„ç†\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eä»£è¡¨å·¥ä½œ\u003c/strong\u003eï¼š\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eChebyNet\u003c/strong\u003eï¼šä½¿ç”¨åˆ‡æ¯”é›ªå¤«å¤šé¡¹å¼è¿‘ä¼¼å…‰è°±æ»¤æ³¢ï¼ŒEmT æ¨¡å‹ä¸­é‡‡ç”¨å…¶ä½œä¸º GCN å±‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eGCN\u003c/strong\u003eï¼šé€šè¿‡å±€éƒ¨ä¸€é˜¶èšåˆè¿‘ä¼¼å…‰è°±æ»¤æ³¢\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDGCNN / RGNN\u003c/strong\u003eï¼šä½¿ç”¨ GNNs æå– EEG ç©ºé—´ä¿¡æ¯ï¼›ä¾èµ–å•ä¸€çš„é‚»æ¥çŸ©é˜µï¼Œå¿½ç•¥æ—¶åºä¸Šä¸‹æ–‡ï¼Œå…·æœ‰\u003cstrong\u003eå±€é™æ€§\u003c/strong\u003eï¼›è€Œ EmT é€šè¿‡\u003cstrong\u003eå¤šè§†å›¾å¯å­¦ä¹ é‚»æ¥çŸ©é˜µ\u003c/strong\u003eå’Œ\u003cstrong\u003eæ—¶åºå›¾\u003c/strong\u003eæ¥å¼¥è¡¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"temporal-context-learning\"\u003eTemporal Context Learning\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eæ ¸å¿ƒç†å¿µ\u003c/strong\u003eï¼šæƒ…ç»ªæ˜¯è¿ç»­è®¤çŸ¥è¿‡ç¨‹ï¼ŒEEG ä¿¡å·ä¸­åµŒå…¥æ—¶åºä¸Šä¸‹æ–‡ä¿¡æ¯\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eä»£è¡¨å·¥ä½œ\u003c/strong\u003eï¼š\n\u003cul\u003e\n\u003cli\u003eLSTM / TCN / TESANet / Conformer / AMDET\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå±€é™æ€§\u003c/strong\u003eï¼šè¿™äº›æ–¹æ³•é€šå¸¸ä»æ‰å¹³åŒ–çš„ EEG ç‰¹å¾å‘é‡å­¦ä¹ ï¼Œå¯èƒ½\u003cstrong\u003eæœªèƒ½æœ‰æ•ˆå­¦ä¹ ç©ºé—´å…³ç³»\u003c/strong\u003eï¼›EmT åˆ™é€šè¿‡å¹¶è¡Œ GCN å’Œ STA å±‚æ›´æœ‰æ•ˆåœ°æ•æ‰æ—¶ç©ºä¿¡æ¯\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"eeg-emotion-recognition\"\u003eEEG Emotion Recognition\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eæ ¸å¿ƒç†å¿µ\u003c/strong\u003eï¼šEEG æƒ…ç»ªè¯†åˆ«é¢ä¸´ä¸ªä½“å·®å¼‚å¤§ã€ä¿¡å™ªæ¯”ä½ç­‰æŒ‘æˆ˜ï¼Œéœ€æå–å…‰è°±ã€ç©ºé—´ã€æ—¶åºç‰¹å¾\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eä»£è¡¨å·¥ä½œ\u003c/strong\u003eï¼š\n\u003cul\u003e\n\u003cli\u003eGCB-Net / TSception\u003c/li\u003e\n\u003cli\u003eå±€é™æ€§ï¼šæ²¡æœ‰å…³æ³¨é•¿æ—¶åºä¸Šä¸‹æ–‡ä¿¡æ¯\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"method\"\u003eMethod\u003c/h2\u003e\n\u003cp\u003eEmT æ˜¯ä¸€ä¸ªç«¯åˆ°ç«¯çš„æ¡†æ¶ï¼ŒåŒ…å«å››å¤§æ¨¡å—ï¼š\u003c/p\u003e","title":"EmT"},{"content":"Introduction TTA åœ¨å›å½’ä»»åŠ¡ä¸Šçš„å±€é™ï¼šä¸ºåˆ†ç±»ä»»åŠ¡è®¾è®¡ï¼Œä¸€èˆ¬åŸºäºç†µæœ€å°åŒ–å’Œç‰¹å¾å¯¹é½ï¼›ç†µæœ€å°åŒ–ä¸é€‚ç”¨ï¼Œå›å½’æ¨¡å‹äº§ç”Ÿå•ä¸€å€¼ï¼Œä¸äº§ç”Ÿæ¦‚ç‡åˆ†å¸ƒï¼›ç®€å•ç‰¹å¾å¯¹é½å¯¹å›å½’æ¨¡å‹æ•ˆæœä¸ä½³ï¼Œå¯èƒ½åè€Œä¼šç¨€é‡Šéœ€è¦å­¦ä¹ çš„ç‰¹å¾\nProblem Setting è€ƒè™‘ä¸€ä¸ªå›å½’æ¨¡å‹ $ f_\\theta: \\mathcal{X} \\to \\mathbb{R} $ï¼Œå¯ä»¥è¿›ä¸€æ­¥åˆ†è§£ä¸ºç‰¹å¾æå–å™¨ $ g_\\phi: \\mathcal{X} \\to \\mathbb{R}^D $ï¼ˆä»è¾“å…¥ $ \\mathcal{X} $ æå– $ D $ ç»´ç‰¹å¾ $ z $ï¼‰å’Œçº¿æ€§å›å½’å™¨ $ h_\\psi(z) = w^T z + b $ï¼ˆæˆ–è€… $ h_{\\psi}(z)=Wz+b $ï¼‰\n$ f_\\theta $ é¦–å…ˆåœ¨ä¸€ä¸ªæœ‰æ ‡ç­¾çš„æºæ•°æ®é›† $ S = \\{(x_i, y_i)\\}_{i=1}^{N_s} $ ä¸Šè¿›è¡Œé¢„è®­ç»ƒï¼Œæ•°æ®ä»æºåŸŸåˆ†å¸ƒ $ p_s $ ä¸­é‡‡æ ·\nç›®æ ‡æ˜¯ä½¿ç”¨ä¸€ä¸ªæ— æ ‡ç­¾çš„ç›®æ ‡æ•°æ®é›† $ T = \\{x_j\\}_{j=1}^{N_t} $ æ¥é€‚åº”é¢„è®­ç»ƒå¥½çš„æ¨¡å‹ $ f_\\theta $ åˆ°ç›®æ ‡åŸŸ\næˆ‘ä»¬å‡è®¾å­˜åœ¨ covariate shift ï¼Œè¿™æ„å‘³ç€ï¼š\nè¾“å…¥æ•°æ®çš„åˆ†å¸ƒåœ¨æºåŸŸå’Œç›®æ ‡åŸŸä¹‹é—´æ˜¯ä¸åŒçš„ï¼š$ p_s(x) \\neq p_t(x) $ ä½†ç»™å®šè¾“å…¥åï¼Œè¾“å‡ºçš„æ¡ä»¶åˆ†å¸ƒæ˜¯ç›¸åŒçš„ï¼š$ p_s(y|x) = p_t(y|x) $ Test-time Adaptation for Regression Basic Idea: Feature Alignment æœ´ç´ å®ç°ï¼š\nè®¡ç®—æºåŸŸç‰¹å¾ç»Ÿè®¡é‡ï¼šåœ¨æºåŸŸè®­ç»ƒåï¼Œè®¡ç®—æºåŸŸç‰¹å¾çš„å‡å€¼ $ \\mu^s $ å’Œå…ƒç´ çº§æ–¹å·® $ \\sigma^{s2} $ $$ \\mu^s = \\frac{1}{N_s} \\sum_{i=1}^{N_s} z_i^s, \\quad \\sigma^{s2} = \\frac{1}{N_s} \\sum_{i=1}^{N_s} (z_i^s - \\mu^s) \\odot (z_i^s - \\mu^s) \\quad \\text{(1)} $$ å…¶ä¸­ $ z_i^s = g_\\phi(x_i) $ æ˜¯æºç‰¹å¾ï¼Œ$ N_s $ æ˜¯æºæ•°æ®æ ·æœ¬æ•°ï¼Œ$ \\odot $ è¡¨ç¤ºå…ƒç´ çº§ä¹˜ç§¯\nç›®æ ‡åŸŸç‰¹å¾ç»Ÿè®¡é‡ï¼šåœ¨ç›®æ ‡åŸŸï¼Œå¯¹æ¯ä¸ªè¿·ä½ æ‰¹æ¬¡ï¼ˆmini-batchï¼‰$ B = \\{x_j\\}_{j=1}^{N_B} $ï¼Œè®¡ç®—å…¶ç‰¹å¾å‡å€¼ $ \\hat{\\mu}^t $ å’Œæ–¹å·® $ \\hat{\\sigma}^{t2} $ï¼Œè®¡ç®—æ–¹å¼ä¸å…¬å¼ (1) ç±»ä¼¼\nå¯¹é½æŸå¤±å‡½æ•°ï¼šä½¿ç”¨ KL æ•£åº¦æ¥è¡¡é‡ä¸¤ä¸ªå¯¹è§’é«˜æ–¯åˆ†å¸ƒ $ N(\\mu^s, \\sigma^{s2}) $ å’Œ $ N(\\hat{\\mu}^t, \\hat{\\sigma}^{t2}) $ ä¹‹é—´çš„å·®å¼‚ï¼Œå¹¶æœ€å°åŒ–è¯¥å·®å¼‚ã€‚ $$ L_{TTA} (\\phi) = \\frac{1}{2} \\sum_{d=1}^D \\left\\{ D_{KL} (N(\\mu^s_d, \\sigma^s_{d}{}^2)||N(\\hat{\\mu}^t_d, \\hat{\\sigma}^t_{d}{}^2)) + D_{KL} (N(\\hat{\\mu}^t_d, \\hat{\\sigma}^t_{d}{}^2)||N(\\mu^s_d, \\sigma^s_{d}{}^2)) \\right\\} \\quad \\text{(2)} $$ è¿™é‡Œçš„ $ d $ è¡¨ç¤ºå‘é‡çš„ç¬¬ $ d $ ä¸ªå…ƒç´ ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨åŒå‘çš„ KL æ•£åº¦ï¼Œæ˜¯ä¸ºäº†ç»éªŒä¸Šè·å¾—æ›´å¥½çš„ç»“æœ\nä¸€ç»´é«˜æ–¯ KL æ•£åº¦å…¬å¼ï¼š $$ D_{KL} (N(\\mu_1, \\sigma_1^2)||N(\\mu_2, \\sigma_2^2)) = \\dfrac{\\left[ \\log(\\sigma_2^2/\\sigma_1^2) + \\dfrac{(\\mu_1 - \\mu_2)^2 + \\sigma_1^2}{\\sigma_2^2} - 1 \\right]}{2} \\quad \\text{(3)} $$\næœ´ç´ å¯¹é½çš„é—®é¢˜ï¼š\nå›å½’æ¨¡å‹ç‰¹å¾å€¾å‘äºåˆ†å¸ƒåœ¨ä¸€ä¸ªå°å‹çš„å­ç©ºé—´ä¸­ï¼Œè®¸å¤šç‰¹å¾ç»´åº¦æ–¹å·®ä¸ºé›¶æˆ–æ¥è¿‘é›¶ å…¬å¼ (3) ä¸­æ¶‰åŠåˆ°æ–¹å·®åœ¨åˆ†æ¯ä¸Šï¼Œä½¿å¾—è¿™ç§æœ´ç´ å¯¹é½åœ¨é¢å¯¹é›¶æ–¹å·®ç»´åº¦æ—¶å˜å¾—ä¸ç¨³å®š å¯¹æ‰€æœ‰ç»´åº¦â€œä¸€è§†åŒä»â€åœ°å¯¹é½ä¸é€‚ç”¨äºå›å½’ä»»åŠ¡çš„ç‰¹æ€§ï¼Œå› ä¸ºè®¸å¤šç»´åº¦å¯¹æœ€ç»ˆè¾“å‡ºå½±å“å¾ˆå° Significant-subspace Alignment SSA çš„ä¸‰ä¸ªæ­¥éª¤ï¼š\nå­ç©ºé—´æ£€æµ‹ (Subspace detection)ï¼š\nåœ¨æºæ•°æ®é›† $ S $ ä¸Šè¿›è¡Œè®­ç»ƒåï¼Œæ£€æµ‹æºç‰¹å¾åˆ†å¸ƒæ‰€åœ¨çš„å­ç©ºé—´ã€‚ä¸è®¡ç®—æ¯ä¸ªç»´åº¦çš„æ–¹å·®ï¼Œè€Œæ˜¯è®¡ç®—åæ–¹å·®çŸ©é˜µï¼š $$ \\Sigma^s = \\frac{1}{N_s} \\sum_{i=1}^{N_s} (z_i^s - \\mu^s) (z_i^s - \\mu^s)^T \\quad \\text{(4)} $$ å…¶ä¸­ $ \\mu^s $ æ˜¯æºç‰¹å¾çš„å‡å€¼å‘é‡ï¼ˆåŒç† (1)ï¼‰ åŸºäº PCA çš„æ€æƒ³ï¼Œé€šè¿‡å¯¹ $ \\Sigma^s $ è¿›è¡Œç‰¹å¾åˆ†è§£ï¼Œå¾—åˆ°ç‰¹å¾å‘é‡ $ v_d^s $ å’Œå¯¹åº”çš„ç‰¹å¾å€¼ $ \\lambda_d^s $ é€‰å–å‰ K ä¸ªæœ€å¤§çš„ç‰¹å¾å€¼ $ \\lambda_1^s, \\dots, \\lambda_K^s $ åŠå…¶å¯¹åº”çš„æºåŸºå‘é‡ $ v_1^s, \\dots, v_K^s $ æ¥å®šä¹‰æºå­ç©ºé—´ï¼Œè¿™äº›åŸºå‘é‡å¼ æˆçš„å­ç©ºé—´ä»£è¡¨äº†æºç‰¹å¾æ•°æ®æœ€æœ‰ä»£è¡¨æ€§å’Œæœ€é‡è¦çš„å˜åŒ–æ–¹å‘ ç»´åº¦åŠ æƒ (Dimension weighting)ï¼š\nè€ƒè™‘åˆ°å›å½’æ¨¡å‹ $ h_\\psi(z)=w^T z + b $ï¼Œå­ç©ºé—´ç»´åº¦ $ v_d^s $ å¯¹æœ€ç»ˆè¾“å‡ºçš„å½±å“ç”± $ w^T v_d^s $ å†³å®šï¼ˆå³ç‰¹å¾å‘é‡ä¸å›å½’å™¨æƒé‡å‘é‡çš„ç‚¹ç§¯ï¼‰ ä¸ºäº†ä¼˜å…ˆå¯¹é½é‚£äº›å¯¹è¾“å‡ºå½±å“æ›´å¤§çš„å­ç©ºé—´ç»´åº¦ï¼Œä¸ºæ¯ä¸ªå­ç©ºé—´ç»´åº¦ $ d $ å®šä¹‰æƒé‡ $ a_d $ï¼š $$ a_d = 1 + |w^T v_d^s| \\quad \\text{(5)} $$ è¿™ä¸ªæƒé‡ $ a_d $ ä¼šåœ¨å¯¹åº”çš„å­ç©ºé—´åŸºæ–¹å‘å¯¹è¾“å‡ºæœ‰è¾ƒå¤§å½±å“æ—¶å€¼æ›´å¤§ï¼ˆæœ€å°ä¸º 1ï¼‰ã€‚ ç‰¹å¾å¯¹é½ (Feature alignment)ï¼š\nè¿™ä¸€æ­¥åœ¨ç›®æ ‡åŸŸè¿›è¡Œã€‚å¯¹äºç›®æ ‡åŸŸçš„è¿·ä½ æ‰¹æ¬¡ $ B $ï¼Œé¦–å…ˆå°†ç›®æ ‡ç‰¹å¾ $ z^t = g_\\phi(x^t) $ æŠ•å½±åˆ°æºå­ç©ºé—´ã€‚ $$ \\tilde{z}^t = V_s^T (z^t - \\mu^s) \\quad \\text{(6)} $$ å…¶ä¸­ $ V_s = [v_1^s, \\dots, v_K^s] \\in \\mathbb{R}^{D \\times K} $ æ˜¯ç”±å‰ K ä¸ªæºåŸºå‘é‡æ„æˆçš„çŸ©é˜µï¼Œ$ \\tilde{z}^t \\in \\mathbb{R}^K $ æ˜¯æŠ•å½±åçš„ç›®æ ‡ç‰¹å¾ã€‚ ç„¶åï¼Œè®¡ç®—æŠ•å½±åç›®æ ‡ç‰¹å¾çš„è¿·ä½ æ‰¹æ¬¡å‡å€¼ $ \\tilde{\\mu}^t $ å’Œæ–¹å·® $ \\tilde{\\sigma}^{t2} $ ï¼ˆåŒç†å…¬å¼ (1) ï¼‰ æœ€åï¼Œä½¿ç”¨ç»“åˆå­ç©ºé—´æ£€æµ‹å’Œç»´åº¦åŠ æƒçš„æ–°æŸå¤±å‡½æ•°æ¥æœ€å°åŒ–ç›®æ ‡ç‰¹å¾åˆ†å¸ƒä¸æºç‰¹å¾åˆ†å¸ƒåœ¨å­ç©ºé—´ä¸­çš„å·®å¼‚ã€‚æºåŸŸæŠ•å½±åçš„å‡å€¼æ˜¯ 0ï¼Œæ–¹å·®æ˜¯å…¶ç‰¹å¾å€¼ $ \\Lambda^s = [\\lambda_1^s, \\dots, \\lambda_K^s] $ã€‚ $$ \\begin{align}L_{TTA}(\\phi) = \u0026 \\frac{1}{2} \\sum_{d=1}^K a_d \\left\\{ D_{KL} (N(0, \\lambda^s_d)||N(\\tilde{\\mu}^t_d, \\tilde{\\sigma}^t_{d}{}^2)) + D_{KL} (N(\\tilde{\\mu}^t_d, \\tilde{\\sigma}^t_{d}{}^2)||N(0, \\lambda^s_d)) \\right\\} \\\\ = \u0026 \\sum_{d=1}^K a_d \\left\\{ \\frac{(\\tilde{\\mu}^t_d)^2 + \\lambda^s_d}{2\\tilde{\\sigma}^t_{d}{}^2} + \\frac{(\\tilde{\\mu}^t_d)^2 + \\tilde{\\sigma}^t_{d}{}^2}{2\\lambda^s_d} - 1 \\right\\} \\quad \\text{(7)} \\end{align} $$ å…¶ä¸­ $ a_d $ æ˜¯ç»´åº¦æƒé‡ï¼Œ$ \\lambda_d^s $ æ˜¯æºåŸŸå­ç©ºé—´çš„ç¬¬ $ d $ ä¸ªç‰¹å¾å€¼ï¼Œ$ \\tilde{\\mu}_d^t $ å’Œ $ \\tilde{\\sigma}_{d}{}^2 $ æ˜¯æŠ•å½±åçš„ç›®æ ‡ç‰¹å¾åœ¨ç¬¬ $ d $ ä¸ªç»´åº¦ä¸Šçš„å‡å€¼å’Œæ–¹å·® ä¼ªä»£ç ï¼š\nè¾“å…¥ï¼šé¢„è®­ç»ƒå¥½çš„æºæ¨¡å‹ $ f_\\theta $ã€æºåŸºå‘é‡ $ V_s $ã€æºå‡å€¼ $ \\mu^s $ã€æºæ–¹å·® $ \\Lambda^s $ã€ç›®æ ‡æ•°æ®é›† $ T $ è¾“å‡ºï¼šé€‚åº”åçš„æ¨¡å‹ $ f_\\phi^t $ æ­¥éª¤ï¼š è®¡ç®—æºå­ç©ºé—´ä¸­æ¯ä¸ªç»´åº¦çš„æƒé‡ $ a_d $ å¯¹äºç›®æ ‡æ•°æ®é›† $ T $ ä¸­çš„æ¯ä¸ª mini batch $ \\{x\\}_i^B $ï¼š æå–ç›®æ ‡ç‰¹å¾ $ z = g_\\phi(x) $ã€‚ å°†ç›®æ ‡ç‰¹å¾æŠ•å½±åˆ°æºå­ç©ºé—´ $ \\tilde{z} $ è®¡ç®—æŠ•å½±åç›®æ ‡ç‰¹å¾çš„å‡å€¼ $ \\tilde{\\mu}^t $ å’Œæ–¹å·® $ \\tilde{\\sigma}^{t2} $ æ›´æ–°ç‰¹å¾æå–å™¨ $ g_\\phi $ ä»¥æœ€å°åŒ–æŸå¤±å‡½æ•° $ L_{TTA}(\\phi) $ é‡å¤ç›´åˆ°æ”¶æ•›ã€‚ å¯¹è§’é«˜æ–¯åˆ†å¸ƒçš„åˆç†æ€§ ä¸ºä»€ä¹ˆå‡è®¾ç‰¹å¾åˆ†å¸ƒä¸ºå¯¹è§’é«˜æ–¯åˆ†å¸ƒæ˜¯åˆç†çš„ï¼š\nä¸­å¿ƒæé™å®šç†ï¼šå½“ç‰¹å¾è¢«æŠ•å½±åˆ°å­ç©ºé—´åï¼Œå¦‚æœåŸå§‹ç‰¹å¾ç»´åº¦ $ D $ è¶³å¤Ÿå¤§ï¼Œæ ¹æ®ä¸­å¿ƒæé™å®šç†ï¼ŒæŠ•å½±åçš„ç‰¹å¾åˆ†å¸ƒä¼šå€¾å‘äºé«˜æ–¯åˆ†å¸ƒã€‚ PCA çš„å»ç›¸å…³æ€§ï¼šç”±äºå­ç©ºé—´æ£€æµ‹ä½¿ç”¨äº† PCAï¼ŒæŠ•å½±åˆ°ä¸»æˆåˆ†ä¸Šçš„ç‰¹å¾æ˜¯å»ç›¸å…³çš„ï¼Œè¿™æ„å‘³ç€ä¸åŒç»´åº¦ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ï¼Œè¿™ä½¿å¾—å¯¹è§’é«˜æ–¯åˆ†å¸ƒçš„å‡è®¾ï¼ˆå³å„ç»´åº¦ç‹¬ç«‹ï¼‰å˜å¾—åˆç†ã€‚ Appendix A. LIMITATIONï¼šSSA å‡è®¾æ˜¯åå˜é‡åç§»ï¼Œå³ $ p(y|x) $ ä¸å˜ï¼Œæœªæ¥å·¥ä½œå°†è€ƒè™‘ $ p(y|x) $ å˜åŒ–çš„æƒ…å†µ\nB. EVALUATION METRICï¼šRÂ²æ¥è¿‘ 1 è¡¨ç¤ºæ¨¡å‹æ‹Ÿåˆæ•ˆæœå¥½ $$ R^2 = 1 - \\frac{\\sum_{i=1}^N (y_i - \\hat{y}_i)^2}{\\sum_{i=1}^N (y_i - \\bar{y})^2} \\quad \\text{(10)} $$ å…¶ä¸­ $ \\hat{y}_i $ æ˜¯é¢„æµ‹å€¼ï¼Œ$ y_i $ æ˜¯çœŸå®å€¼ï¼Œ$ \\bar{y} $ æ˜¯çœŸå®å€¼çš„å¹³å‡å€¼ã€‚\nD. ADDITIONAL EXPERIMENTAL RESULTSï¼š\nD.1 ç‰¹å¾å¯¹é½çš„åº¦é‡ï¼šæ¯”è¾ƒäº† KL æ•£åº¦ã€2WD å’Œ L1 èŒƒæ•°ä½œä¸ºç‰¹å¾å¯¹é½æŸå¤±çš„æ•ˆæœï¼Œç»“æœæ˜¾ç¤º KL æ•£åº¦ç»“åˆå­ç©ºé—´æ£€æµ‹ï¼ˆSSAï¼‰è¡¨ç°æœ€ä½³ã€‚ å…¬å¼ (11)ï¼š2-Wasserstein Distance for Gaussians $$ W_2^2 (N(\\mu_1, \\sigma_1^2), N(\\mu_2, \\sigma_2^2)) = (\\mu_1 - \\mu_2)^2 + (\\sigma_1 - \\sigma_2)^2 $$ å…¬å¼ (12)ï¼šL1 Norm of Statistics $$ L_1 (N(\\mu_1, \\sigma_1^2), N(\\mu_2, \\sigma_2^2)) = |\\mu_1 - \\mu_2| + |\\sigma_1 - \\sigma_2| $$ å…¬å¼ (13)ï¼šSSA Loss with 2WD $$ L_{TTA-2WD} = \\sum_{d=1}^K a_d \\left\\{ (\\tilde{\\mu}^t_d)^2 + (\\tilde{\\sigma}^t_d - \\sqrt{\\lambda^s_d})^2 \\right\\} $$ å…¬å¼ (14)ï¼šSSA Loss with L1 Norm $$ L_{TTA-L1} = \\sum_{d=1}^K a_d \\left\\{ |\\tilde{\\mu}^t_d| + |\\tilde{\\sigma}^t_d - \\sqrt{\\lambda^s_d}| \\right\\} $$ D.2 ç‰¹å¾å¯è§†åŒ–ï¼šé€šè¿‡ PCA å’Œ UMAP ç­‰é™ç»´æŠ€æœ¯å¯è§†åŒ–äº†æºåŸŸå’Œç›®æ ‡åŸŸç‰¹å¾åˆ†å¸ƒï¼ˆå›¾ 4-5ï¼‰ï¼Œç›´è§‚åœ°å±•ç¤ºäº† SSA å¦‚ä½•æˆåŠŸåœ°å°†ç›®æ ‡ç‰¹å¾åˆ†å¸ƒæ‹‰è¿‘æºåŸŸã€‚ D.3 åŸå§‹ç‰¹å¾ç»´åº¦å¯¹å­ç©ºé—´çš„å½±å“ï¼šåˆ†æäº†åŸå§‹ç‰¹å¾ç»´åº¦å¯¹å­ç©ºé—´çš„é‡è¦æ€§ã€‚ å…¬å¼ (15)ï¼šGradient Norm $ s_d $ $$ s_d = ||\\frac{\\partial \\tilde{z}}{\\partial z_d}||_2 = ||(V_s^T)_d||_2 = ||[v_{1,d}^s, \\dots, v_{K,d}^s]||_2, $$ å…¶ä¸­ $ (V_s^T)_d $ æ˜¯ $ V_s^T $ çš„ç¬¬ $ d $ è¡Œã€‚ å‘ç°ï¼šå›å½’æ¨¡å‹çš„ç‰¹å¾å­ç©ºé—´ç¡®å®å—è®¸å¤šåŸå§‹ç‰¹å¾ç»´åº¦å½±å“å¾ˆå°ï¼ˆå›¾ 6ï¼‰ï¼Œè¿™è¿›ä¸€æ­¥ç¡®è®¤äº†å­ç©ºé—´æ£€æµ‹çš„å¿…è¦æ€§ã€‚ D.4 é™„åŠ æ¶ˆèå®éªŒï¼šè¿›ä¸€æ­¥è¯å®äº†å­ç©ºé—´æ£€æµ‹å¯¹äº SSA æ€§èƒ½çš„é‡è¦æ€§ï¼ˆè¡¨ 13-14ï¼‰ã€‚ D.5 Vision Transformer å®éªŒï¼šåœ¨ Vision Transformer ä¸ŠéªŒè¯äº† SSA çš„æœ‰æ•ˆæ€§ï¼ˆè¡¨ 15-16ï¼‰ï¼Œè¡¨æ˜è¯¥æ–¹æ³•å¯¹ä¸åŒæ¨¡å‹æ¶æ„ä¹Ÿé€‚ç”¨ã€‚ D.6 å¤šä»»åŠ¡å›å½’æ¨¡å‹ï¼šå°† SSA åº”ç”¨äºå¤šä»»åŠ¡å›å½’ï¼Œæ¨¡å‹åŒæ—¶è¾“å‡ºå¤šä¸ªé¢„æµ‹å€¼ï¼ˆå¦‚å¤´éƒ¨å§¿æ€çš„ä¿¯ä»°ã€åèˆªã€æ»šè½¬è§’åº¦ï¼‰ï¼Œç»“æœè¡¨æ˜ SSA åŒæ ·æœ‰æ•ˆï¼ˆè¡¨ 17ï¼‰ã€‚ D.7 ä¸åˆ†ç±» TTA ç»“åˆï¼šæ¢ç´¢äº† SSA ä¸åˆ†ç±» TTA ç»“åˆçš„å¯èƒ½æ€§ï¼ˆè¡¨ 18-20ï¼‰ã€‚ D.8 è¶…å‚æ•°æ•æ„Ÿæ€§ï¼šåˆ†æäº†å­¦ä¹ ç‡å’Œæ‰¹æ¬¡å¤§å°ç­‰è¶…å‚æ•°å¯¹ SSA æ€§èƒ½çš„å½±å“ï¼ˆè¡¨ 21-26ï¼‰ï¼Œå‘ç° SSA åœ¨å…¸å‹å‚æ•°èŒƒå›´å†…è¡¨ç°ç¨³å®šã€‚ D.9 é¢å¤–ç»“æœï¼šæä¾›äº† MAE ç­‰å…¶ä»–æŒ‡æ ‡çš„æ€§èƒ½æ•°æ®ï¼ˆè¡¨ 27-28ï¼‰ã€‚ D.10 åœ¨çº¿è®¾ç½®ï¼šSSA åœ¨åˆ†æ‰¹åœ¨çº¿ï¼ˆbatched onlineï¼‰è®¾ç½®ä¸‹ä¹Ÿè¡¨ç°å‡ºè‰²ï¼ˆè¡¨ 29-31ï¼‰ã€‚ ","permalink":"https://diefish1024.github.io/posts/literature-notes/ssa/","summary":"\u003ch2 id=\"introduction\"\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eTTA åœ¨å›å½’ä»»åŠ¡ä¸Šçš„å±€é™ï¼šä¸ºåˆ†ç±»ä»»åŠ¡è®¾è®¡ï¼Œä¸€èˆ¬åŸºäºç†µæœ€å°åŒ–å’Œç‰¹å¾å¯¹é½ï¼›ç†µæœ€å°åŒ–ä¸é€‚ç”¨ï¼Œå›å½’æ¨¡å‹äº§ç”Ÿå•ä¸€å€¼ï¼Œä¸äº§ç”Ÿæ¦‚ç‡åˆ†å¸ƒï¼›ç®€å•ç‰¹å¾å¯¹é½å¯¹å›å½’æ¨¡å‹æ•ˆæœä¸ä½³ï¼Œå¯èƒ½åè€Œä¼šç¨€é‡Šéœ€è¦å­¦ä¹ çš„ç‰¹å¾\u003c/p\u003e\n\u003ch2 id=\"problem-setting\"\u003eProblem Setting\u003c/h2\u003e\n\u003cp\u003eè€ƒè™‘ä¸€ä¸ªå›å½’æ¨¡å‹ $ f_\\theta: \\mathcal{X} \\to \\mathbb{R} $ï¼Œå¯ä»¥è¿›ä¸€æ­¥åˆ†è§£ä¸º\u003cstrong\u003eç‰¹å¾æå–å™¨\u003c/strong\u003e $ g_\\phi: \\mathcal{X} \\to \\mathbb{R}^D $ï¼ˆä»è¾“å…¥ $ \\mathcal{X} $ æå– $ D $ ç»´ç‰¹å¾ $ z $ï¼‰å’Œ\u003cstrong\u003eçº¿æ€§å›å½’å™¨\u003c/strong\u003e $ h_\\psi(z) = w^T z + b $ï¼ˆæˆ–è€… $ h_{\\psi}(z)=Wz+b $ï¼‰\u003c/p\u003e\n\u003cp\u003e$ f_\\theta $ é¦–å…ˆåœ¨ä¸€ä¸ªæœ‰æ ‡ç­¾çš„\u003cstrong\u003eæºæ•°æ®é›†\u003c/strong\u003e $ S = \\{(x_i, y_i)\\}_{i=1}^{N_s} $ ä¸Šè¿›è¡Œé¢„è®­ç»ƒï¼Œæ•°æ®ä»æºåŸŸåˆ†å¸ƒ $ p_s $ ä¸­é‡‡æ ·\u003c/p\u003e\n\u003cp\u003eç›®æ ‡æ˜¯ä½¿ç”¨ä¸€ä¸ª\u003cstrong\u003eæ— æ ‡ç­¾çš„\u003c/strong\u003eç›®æ ‡æ•°æ®é›† $ T = \\{x_j\\}_{j=1}^{N_t} $ æ¥é€‚åº”é¢„è®­ç»ƒå¥½çš„æ¨¡å‹ $ f_\\theta $ åˆ°ç›®æ ‡åŸŸ\u003c/p\u003e\n\u003cp\u003eæˆ‘ä»¬å‡è®¾å­˜åœ¨ \u003cstrong\u003ecovariate shift\u003c/strong\u003e ï¼Œè¿™æ„å‘³ç€ï¼š\u003c/p\u003e","title":"SSA"},{"content":"Method Problem Set EEG æ•°æ® $ \\{ X_{s,l}^{i},y_{s,l}^{i} \\}_{i=1}^{n_{s,l}} $ ï¼Œè¿›è¡Œæ— ç›‘ç£åœ¨çº¿ K åˆ†ç±»\nSource Model Training å¯¹æºæ•°æ®åš Euclidean alignment (EA) æ•°æ®å¯¹é½ï¼Œå‡å°‘ä¸åŒä¸ªä½“ EEG ä¿¡å·å·®å¼‚\nEA è®¡ç®—æ¯ä¸ªä¸ªä½“æ‰€æœ‰ EEG è¯•æ¬¡åæ–¹å·®çŸ©é˜µçš„ç®—æœ¯å¹³å‡å€¼ $$ R_{s,l} = \\dfrac{1}{n}\\sum_{i=1}^{n} X_{i}(X_{i})^{T} \\implies \\bar{X}_{i} = R_{s,l}^{-1/2}X_{i} $$ ä¹‹åå†æ•´åˆç»è¿‡å¯¹é½çš„å—è¯•è€…æ•°æ®ï¼Œå½¢æˆâ€œæºåŸŸâ€\nåœ¨æ•´åˆåçš„æ•°æ®ä¸Šç‹¬ç«‹è®­ç»ƒ $ M $ ä¸ªæ¨¡å‹\nIncremental EA on Target Data å¯¹æ–°æ•°æ®å¢é‡å¼æ›´æ–°åæ–¹å·®çŸ©é˜µï¼Œå†ç”¨æ–°çš„çŸ©é˜µæ›´æ–°æ‰€æœ‰æµ‹è¯•æ•°æ®\nTarget Label Prediction ç”¨è®­ç»ƒå¥½çš„ $ M $ æ¨¡å‹åˆå§‹åŒ–ç”¨äºé€‚åº”ç›®æ ‡åŸŸçš„ $ M $ ä¸ª TTA æ¨¡å‹ $ f_{m} $\næ–°çš„ $ X_{a} $ ç»è¿‡ IEA è¢«å˜æ¢ä¸º $ X_{a}' $ åè¢«è¾“å…¥åˆ°æ¯ä¸ªæ¨¡å‹ $ f_{m} $ ä¸­è¿›è¡Œåˆ†ç±»ï¼Œè¾“å‡ºæ¦‚ç‡å‘é‡ $ f_{m}(X_{a}') $\nä¹‹åç»“åˆè¿™ $ M $ ä¸ªæ¦‚ç‡å‘é‡æ¥è·å¾—æœ€ç»ˆçš„é¢„æµ‹æ ‡ç­¾ $ \\hat{y}_{a} $\n$ a\\leq M $ æ•°æ®é‡è¾ƒå°‘ï¼šç›´æ¥å¯¹æ‰€æœ‰æ¨¡å‹çš„é¢„æµ‹å‘é‡å¹³å‡ $ a\u003eM $ æ•°æ®é‡è¾ƒå¤šï¼šä½¿ç”¨è°±å…ƒå­¦ä¹ å™¨å¯¹å„ä¸ªæ¨¡å‹è¿›è¡ŒåŠ æƒå¹³å‡ï¼Œæ ¹æ®å†å²è¡¨ç°ï¼ˆé¢„æµ‹çš„åæ–¹å·®çŸ©é˜µï¼‰åˆ†é…ä¸åŒçš„æƒé‡ Target Model Update åœ¨æ•°æ®é‡è¶³å¤Ÿä»¥åï¼ˆ$ a\u003eB $ï¼‰ä½¿ç”¨ä¸€ä¸ªæ»‘åŠ¨æ‰¹æ¬¡çš„æ•°æ®æ›´æ–°æ¨¡å‹ï¼Œåœ¨æ­¤ä¹‹å‰æ¨¡å‹ä¸å˜\nç»„åˆæŸå¤±å‡½æ•°ï¼š $$ L_{M} = L_{CEM}(f_{m};\\{ X'_{i} \\}_{i=a-B+1}^{a}) + L_{MDR}(f_{m};\\{ X'_{i} \\}_{i=a-B+1}^{a}) $$ æœ‰ä¸¤ä¸ªéƒ¨åˆ†\n1) Conditional Entropy Minimization æ¡ä»¶ç†µæœ€å°åŒ–\nä½¿åˆ†ç±»è¾¹ç•Œæ›´åŠ æ¸…æ™° é€šè¿‡æœ€å°åŒ–æ¯ä¸ªé¢„æµ‹çš„æ¡ä»¶ç†µï¼ˆä½¿ç”¨æ¸©åº¦ç¼©æ”¾å› å­ $ T $ è¿›è¡Œæ ¡å‡†ï¼‰ï¼Œä½¿æ¨¡å‹å€¾å‘äºè¾“å‡ºæ¥è¿‘ 0 æˆ– 1 çš„æ¦‚ç‡ 2) Adaptive Marginal Distribution Regularization è‡ªé€‚åº”è¾¹ç¼˜åˆ†å¸ƒæ­£åˆ™åŒ–\né˜²æ­¢å‡ºç°æ‰€æœ‰æ•°æ®éƒ½åœ¨å•ç±»åˆ«å’Œå¯¹é”™è¯¯ç»“æœè¿‡äºè‡ªä¿¡çš„ä¸è‰¯ç»“æœ è®¡ç®—å½“å‰æ‰¹æ¬¡æ¯ä¸ªç±»åˆ«çš„å¹³å‡é¢„æµ‹æ¦‚ç‡ $ p_{k} $ é€šè¿‡è®¾ç½®é˜ˆå€¼å¾—åˆ°ä¼ªæ ‡ç­¾ï¼Œä¼°è®¡ç›®æ ‡åŸŸçš„ç±»åˆ«è¯„è®º $ z_{k} $ æ ¡å‡†å¹³å‡é¢„æµ‹æ¦‚ç‡ $ q'_{k} $ $$ q_{k} = \\dfrac{p_{k}}{c+z_{k}},\\quad q'_{k} = \\dfrac{q_{k}}{\\sum q} $$ $ L_{MDR} = \\sum_{k=1}^{K}q'_{k}\\log q'_{k} $ ï¼ˆé‡‡ç”¨è´Ÿç†µçš„å½¢å¼ï¼‰ Complete T-TIME Algorithm å…ˆé¢„æµ‹ï¼Œåå°å¹¶è¡Œåœ°æ›´æ–°æ¨¡å‹\nExperiment ä½¿ç”¨ä¸‰ä¸ªè¿åŠ¨æƒ³è±¡æ•°æ®é›†\næ¯æ¬¡æŠŠä¸€ä¸ªå—è¯•è€…çš„æ•°æ®ä½œä¸ºç›®æ ‡åŸŸï¼Œå…¶ä½™ä½œä¸ºæºåŸŸ\nClassification Accuracies on Balanced Classes è¿‡äºå¤æ‚çš„ç®—æ³•ç”±äºæ•°æ®ä¸è¶³ï¼Œæ€§èƒ½åè€Œä¸‹é™ åŸºäºç†µçš„æ–¹æ³•æ™®éè¡¨ç°è‰¯å¥½ï¼ŒMCC åœ¨ç¦»çº¿è¿ç§»å­¦ä¹ ä¸­è¡¨ç°æœ€å¥½ T-TIME åœ¨æ‰€æœ‰åœ¨çº¿è¿ç§»å­¦ä¹ ç®—æ³•ä¸­è¡¨ç°æœ€ä½³ï¼Œå¹¶ä¸”å…¶æ€§èƒ½ä¸è¡¨ç°æœ€ä½³çš„ç¦»çº¿è¿ç§»å­¦ä¹ æ–¹æ³•ç›¸å½“ Classification Performance Under Class-Imbalance ä½¿ç”¨éšæœºç§»é™¤æ•°æ®æ¥åˆ›å»ºä¸å¹³è¡¡æ•°æ®é›†\nä¼ ç»Ÿæ–¹æ³•è¡¨ç°è¾ƒå¼± T-TIME è¡¨ç°çªå‡º ","permalink":"https://diefish1024.github.io/posts/literature-notes/t-time/","summary":"\u003ch1 id=\"method\"\u003eMethod\u003c/h1\u003e\n\u003ch3 id=\"problem-set\"\u003eProblem Set\u003c/h3\u003e\n\u003cp\u003eEEG æ•°æ® $ \\{ X_{s,l}^{i},y_{s,l}^{i} \\}_{i=1}^{n_{s,l}} $ ï¼Œè¿›è¡Œæ— ç›‘ç£åœ¨çº¿ K åˆ†ç±»\u003c/p\u003e\n\u003ch3 id=\"source-model-training\"\u003eSource Model Training\u003c/h3\u003e\n\u003cp\u003eå¯¹æºæ•°æ®åš Euclidean alignment (EA) æ•°æ®å¯¹é½ï¼Œå‡å°‘ä¸åŒä¸ªä½“ EEG ä¿¡å·å·®å¼‚\u003c/p\u003e\n\u003cp\u003eEA è®¡ç®—æ¯ä¸ªä¸ªä½“æ‰€æœ‰ EEG è¯•æ¬¡åæ–¹å·®çŸ©é˜µçš„ç®—æœ¯å¹³å‡å€¼\n$$ \n\nR_{s,l} = \\dfrac{1}{n}\\sum_{i=1}^{n} X_{i}(X_{i})^{T} \\implies \\bar{X}_{i} = R_{s,l}^{-1/2}X_{i}\n\n $$\nä¹‹åå†æ•´åˆç»è¿‡å¯¹é½çš„å—è¯•è€…æ•°æ®ï¼Œå½¢æˆâ€œæºåŸŸâ€\u003c/p\u003e\n\u003cp\u003eåœ¨æ•´åˆåçš„æ•°æ®ä¸Šç‹¬ç«‹è®­ç»ƒ $ M $ ä¸ªæ¨¡å‹\u003c/p\u003e\n\u003ch3 id=\"incremental-ea-on-target-data\"\u003eIncremental EA on Target Data\u003c/h3\u003e\n\u003cp\u003eå¯¹æ–°æ•°æ®å¢é‡å¼æ›´æ–°åæ–¹å·®çŸ©é˜µï¼Œå†ç”¨æ–°çš„çŸ©é˜µæ›´æ–°æ‰€æœ‰æµ‹è¯•æ•°æ®\u003c/p\u003e\n\u003ch3 id=\"target-label-prediction\"\u003eTarget Label Prediction\u003c/h3\u003e\n\u003cp\u003eç”¨è®­ç»ƒå¥½çš„ $ M $ æ¨¡å‹åˆå§‹åŒ–ç”¨äºé€‚åº”ç›®æ ‡åŸŸçš„ $ M $ ä¸ª TTA æ¨¡å‹ $ f_{m} $\u003c/p\u003e\n\u003cp\u003eæ–°çš„ $ X_{a} $ ç»è¿‡ IEA è¢«å˜æ¢ä¸º $ X_{a}' $ åè¢«è¾“å…¥åˆ°æ¯ä¸ªæ¨¡å‹ $ f_{m} $ ä¸­è¿›è¡Œåˆ†ç±»ï¼Œè¾“å‡ºæ¦‚ç‡å‘é‡ $ f_{m}(X_{a}') $\u003c/p\u003e","title":"T-TIME"},{"content":"Setting Fully Test-Time Adaptation æ˜¯ä¸€ç§ç‹¬ç‰¹çš„æ¨¡å‹é€‚åº”è®¾å®šã€‚åœ¨æ­¤è®¾å®šä¸‹ï¼Œæ¨¡å‹ $ f_\\theta(x) $ åœ¨è®­ç»ƒé˜¶æ®µå·²é€šè¿‡æºæ•°æ® $ x^s $ å’Œæ ‡ç­¾ $ y^s $ å®Œæˆè®­ç»ƒï¼Œè·å¾—å‚æ•° $ \\theta $ã€‚ä½†åœ¨æµ‹è¯•é˜¶æ®µï¼Œæ¨¡å‹å°†é‡åˆ°ä¸æºæ•°æ®åˆ†å¸ƒä¸åŒçš„æ— æ ‡ç­¾ç›®æ ‡æ•°æ® $ x^t $ã€‚\nFTT-Adaptation ä¸ä»¥ä¸‹æ–¹æ³•ä¸åŒï¼š\nFine-tuningï¼šéœ€è¦ç›®æ ‡æ ‡ç­¾è¿›è¡Œé‡æ–°è®­ç»ƒã€‚ Domain Adaptationï¼šéœ€è¦æºæ•°æ®å’Œç›®æ ‡æ•°æ®è¿›è¡Œè”åˆè®­ç»ƒã€‚ Test-Time Training (TTT)ï¼šéœ€è¦ä¿®æ”¹è®­ç»ƒè¿‡ç¨‹å¹¶å…±åŒä¼˜åŒ–æœ‰ç›‘ç£åŠè‡ªç›‘ç£æŸå¤±ã€‚ ç›¸æ¯”ä¹‹ä¸‹ï¼ŒFTT-Adaptation ä»…èƒ½åˆ©ç”¨é¢„è®­ç»ƒæ¨¡å‹ $ f_\\theta $ å’Œæ— æ ‡ç­¾ç›®æ ‡æ•°æ® $ x^t $ è¿›è¡Œé€‚åº”ï¼Œä¸ä¾èµ–æºæ•°æ®æˆ–é¢å¤–çš„ç›‘ç£ä¿¡æ¯ã€‚\nMethod è®ºæ–‡çš„æ ¸å¿ƒè´¡çŒ®æ˜¯æå‡ºäº† Tent æ–¹æ³•ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡æœ€å°åŒ–æµ‹è¯•ç†µï¼ˆTest Entropy Minimizationï¼‰æ¥é€‚åº”æ¨¡å‹é¢„æµ‹ï¼Œæ—¨åœ¨ä½¿æ¨¡å‹å¯¹æµ‹è¯•æ•°æ®çš„é¢„æµ‹ç»“æœæ›´â€œæœ‰ä¿¡å¿ƒâ€ã€‚\nEntropy Objective Tent çš„æµ‹è¯•æ—¶ç›®æ ‡å‡½æ•°æ˜¯æœ€å°åŒ–æ¨¡å‹é¢„æµ‹ $ \\hat{y} = f_\\theta(x^t) $ çš„ç†µ $ H(\\hat{y}) $ã€‚è®ºæ–‡ä¸­ä½¿ç”¨çš„é¦™å†œç†µè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š\n$$ H(\\hat{y}) = - \\sum_c p(\\hat{y}_c) \\log p(\\hat{y}_c) $$ å…¶ä¸­ï¼Œ $ p(\\hat{y}_c) $ è¡¨ç¤ºæ¨¡å‹é¢„æµ‹ç›®æ ‡æ•°æ® $ x^t $ å±äºç±»åˆ« $ c $ çš„æ¦‚ç‡ã€‚\næœ€å°åŒ–ç†µä¿ƒä½¿æ¨¡å‹è¾“å‡ºæ›´â€œå°–é”â€æˆ–æ›´â€œç¡®å®šâ€çš„é¢„æµ‹åˆ†å¸ƒã€‚ ä¼˜åŠ¿ï¼šç†µæ˜¯ä¸€ç§æ— ç›‘ç£ç›®æ ‡ï¼Œä»…ä¾èµ–äºæ¨¡å‹é¢„æµ‹ï¼Œä¸éœ€è¦çœŸå®æ ‡ç­¾ã€‚æœ€å°åŒ–ç†µä¸å‡å°‘é¢„æµ‹è¯¯å·®å’Œæ•°æ®æ¼‚ç§»ä¹‹é—´å­˜åœ¨å†…åœ¨è”ç³»ï¼Œå› ä¸ºæ›´ç¡®å®šçš„é¢„æµ‹é€šå¸¸æ„å‘³ç€æ›´æ­£ç¡®çš„é¢„æµ‹ã€‚ Modulation Parameters Tent ä¸ç›´æ¥ä¿®æ”¹åŸå§‹æ¨¡å‹çš„å…¨éƒ¨å‚æ•° $ \\theta $ã€‚ç›¸åï¼Œå®ƒä»…æ›´æ–°æ¨¡å‹å†…éƒ¨å½’ä¸€åŒ–å±‚ï¼ˆå¦‚Batch Normalization layersï¼‰ä¸­çš„çº¿æ€§ä¸”ä½ç»´åº¦çš„ä»¿å°„å˜æ¢å‚æ•°ï¼šå°ºåº¦å‚æ•° $ \\gamma $ å’Œåç§»å‚æ•° $ \\beta $ã€‚\nè¿™ä¸€é€‰æ‹©çš„ç†ç”±æ˜¯ï¼šè¿™äº›å‚æ•°åªå æ¨¡å‹æ€»å‚æ•°çš„æå°éƒ¨åˆ†ï¼ˆ\u0026lt;1%ï¼‰ï¼Œä¼˜åŒ–æ•ˆç‡é«˜ä¸”ç¨³å®šã€‚ ç‰¹å¾è°ƒåˆ¶è¿‡ç¨‹åŒ…å«ä¸¤ä¸ªæ­¥éª¤ï¼š 1.Normalization (æ ‡å‡†åŒ–)ï¼šæ ¹æ®å½“å‰æ‰¹æ¬¡æµ‹è¯•æ•°æ®çš„å‡å€¼ $ \\mu $ å’Œæ ‡å‡†å·® $ \\sigma $ æ¥æ ‡å‡†åŒ–ç‰¹å¾ $ x $ï¼Œå³ $ \\hat{x} = (x - \\mu)/\\sigma $ã€‚è¿™é‡Œçš„ $ \\mu, \\sigma $ æ˜¯åœ¨æµ‹è¯•æ—¶ä»å½“å‰æ‰¹æ¬¡æ•°æ®ä¸­ä¼°è®¡çš„ã€‚ 2.Transformation (ä»¿å°„å˜æ¢)ï¼šå¯¹æ ‡å‡†åŒ–åçš„ç‰¹å¾ $ \\hat{x} $ åº”ç”¨ä»¿å°„å˜æ¢ï¼Œå³ $ x' = \\gamma \\hat{x} + \\beta $ã€‚å‚æ•° $ \\gamma $ å’Œ $ \\beta $ é€šè¿‡æœ€å°åŒ–ç†µç›®æ ‡å‡½æ•°è¿›è¡Œä¼˜åŒ–ã€‚ Algorithm Tent ç®—æ³•çš„æµç¨‹å¦‚ä¸‹ï¼š\nInitializationï¼š åŠ è½½é¢„è®­ç»ƒå¥½çš„æºæ¨¡å‹å‚æ•° $ \\theta $ã€‚ å›ºå®šæ‰€æœ‰éä»¿å°„å˜æ¢çš„å‚æ•°ã€‚ ä¸¢å¼ƒæºæ•°æ®ä¸­ä¼°è®¡çš„å½’ä¸€åŒ–ç»Ÿè®¡é‡ã€‚ ä¼˜åŒ–å™¨æ”¶é›†æ‰€æœ‰å½’ä¸€åŒ–å±‚çš„é€šé“çº§ä»¿å°„å˜æ¢å‚æ•° $ \\{\\gamma_{l,k}, \\beta_{l,k}\\} $ã€‚ Iterationï¼šåœ¨çº¿å¤„ç†æ•°æ®æ‰¹æ¬¡ã€‚ Forward Passï¼šå¯¹æ¯ä¸ªæ•°æ®æ‰¹æ¬¡ï¼Œé€å±‚ä¼°è®¡è¯¥æ‰¹æ¬¡æ•°æ®çš„å½’ä¸€åŒ–ç»Ÿè®¡é‡ ($ \\mu, \\sigma $)ã€‚ Backward Passï¼šè®¡ç®—é¢„æµ‹ç†µ $ H(\\hat{y}) $ ç›¸å¯¹äºä»¿å°„å˜æ¢å‚æ•° $ \\gamma, \\beta $ çš„æ¢¯åº¦ $ \\nabla H(\\hat{y}) $ã€‚ Updateï¼šä½¿ç”¨æ¢¯åº¦æ›´æ–° $ \\gamma, \\beta $ å‚æ•°ã€‚Tent é‡‡ç”¨é«˜æ•ˆçš„åœ¨çº¿æ›´æ–°ç­–ç•¥ï¼Œæ¯æ¬¡æ›´æ–°åªå½±å“ä¸‹ä¸€ä¸ªæ‰¹æ¬¡çš„æ•°æ®å¤„ç†ã€‚ Terminationï¼šå¯¹äºåœ¨çº¿é€‚åº”ï¼Œé€‚åº”è¿‡ç¨‹åªè¦æœ‰æµ‹è¯•æ•°æ®å°±æŒç»­è¿›è¡Œã€‚å¯¹äºç¦»çº¿é€‚åº”ï¼Œæ¨¡å‹ä¼šå…ˆè¿›è¡Œæ›´æ–°ï¼Œç„¶åé‡å¤æ¨æ–­ï¼Œé€‚åº”å¯ä»¥æŒç»­å¤šä¸ªEpochsã€‚ Experiments è®ºæ–‡åœ¨å¤šç§è®¡ç®—æœºè§†è§‰ä»»åŠ¡å’Œæ•°æ®é›†ä¸Šå¯¹ Tent è¿›è¡Œäº†å…¨é¢è¯„ä¼°ã€‚\nRobustness To Corruptions åœ¨å›¾åƒåˆ†ç±»çš„é²æ£’æ€§åŸºå‡†æµ‹è¯•ä¸­ï¼Œä½¿ç”¨å—æŸç‰ˆæœ¬çš„ CIFAR-10/100-C å’Œ ImageNet-C æ•°æ®é›†ï¼ˆ15 ç§æŸåç±»å‹ï¼Œä¸åŒä¸¥é‡ç¨‹åº¦ï¼‰ã€‚\nä¸»è¦å‘ç°ï¼š Tent åœ¨ ImageNet-C ä¸Šè¾¾åˆ°äº† 44.0% çš„æœ€ä½é”™è¯¯ç‡ï¼Œä¼˜äº SOTA é²æ£’æ€§è®­ç»ƒæ–¹æ³•ï¼ˆå¦‚Adversarial Noise Training (ANT) çš„ 50.2%ï¼‰å’ŒTest-Time Normalization (BN) åŸºçº¿ï¼ˆ49.9%ï¼‰ã€‚ åœ¨ CIFAR-10/100-C ä¸Šï¼ŒTent ä¹Ÿæ˜¾è‘—ä¼˜äºå…¶ä»– TTA baselineï¼ˆBN, Pseudo-Labeling (PL)ï¼‰ä»¥åŠéœ€è¦è”åˆè®­ç»ƒæºåŸŸå’Œç›®æ ‡åŸŸçš„Domain Adaptationï¼ˆRG, UDA-SSï¼‰å’ŒTest-Time Training (TTT) æ–¹æ³•ã€‚ è¿™äº›æ”¹è¿›ä»…é€šè¿‡ä¸€æ¬¡Epochçš„æµ‹è¯•æ—¶ä¼˜åŒ–å®ç°ï¼Œä¸”æœªæ”¹å˜åŸå§‹æ¨¡å‹è®­ç»ƒã€‚ Source-Free Domain Adaptation è¯„ä¼° Tent åœ¨æ— æºåŸŸé€‚åº”åœºæ™¯ä¸‹çš„æ€§èƒ½ï¼ŒåŒ…æ‹¬æ•°å­—è¯†åˆ«ï¼ˆä» SVHN åˆ° MNIST/MNIST-M/USPSï¼‰å’Œè¯­ä¹‰åˆ†å‰²ï¼ˆä» GTA åˆ° Cityscapesï¼‰ã€‚\nä¸»è¦å‘ç°ï¼š åœ¨æ•°å­—è¯†åˆ«ä»»åŠ¡ä¸­ï¼ŒTent å¤§å¤šæ•°æƒ…å†µä¸‹é”™è¯¯ç‡ä½äºæºæ¨¡å‹å’ŒBNï¼Œéƒ¨åˆ†æƒ…å†µç”šè‡³ä¼˜äºéœ€è¦æºæ•°æ®çš„Domain Adaptationæ–¹æ³•ï¼ˆRG, UDA-SSï¼‰ã€‚ è¯­ä¹‰åˆ†å‰²ä»»åŠ¡ä¸­ï¼ŒTent å°†Intersection-Over-Union (IOU) åˆ†æ•°ä»æºæ¨¡å‹çš„ 28.8% æé«˜åˆ° 35.8%ï¼Œæ˜¾è‘—ä¼˜äº BN çš„ 31.4%ã€‚ Analysis è®ºæ–‡é€šè¿‡å¤šé¡¹åˆ†æå®éªŒæ¢ç©¶äº† Tent çš„å·¥ä½œåŸç†å’Œç‰¹æ€§ï¼š\nTent é™ä½ç†µå’Œè¯¯å·®ï¼šå®éªŒè¯å®ï¼ŒTent æˆåŠŸé™ä½äº†é¢„æµ‹çš„ç†µå€¼å’Œä»»åŠ¡æŸå¤±ï¼ˆå¦‚Softmax Cross-Entropyï¼‰ï¼Œå°è¯äº†ç†µæœ€å°åŒ–ä¸è¯¯å·®å‡å°‘ä¹‹é—´çš„æ­£ç›¸å…³æ€§ã€‚ Tent éœ€è¦ç‰¹å¾è°ƒåˆ¶ï¼šä¸æ›´æ–°å½’ä¸€åŒ–ç»Ÿè®¡é‡æˆ–ä¸ä¼˜åŒ–ä»¿å°„å˜æ¢å‚æ•°ä¼šæ˜¾è‘—é™ä½ Tent æ€§èƒ½ï¼Œè¯´æ˜è¿™äº›ç‰¹å¾è°ƒåˆ¶æ­¥éª¤å¯¹äºé€‚åº”ä¸å¯æˆ–ç¼ºã€‚ Tent æ³›åŒ–åˆ°ä¸åŒçš„ç›®æ ‡æ•°æ®ï¼šé€‚åº”è¿‡ç¨‹å¯¹æœªç”¨äºæ›´æ–°çš„å…¶ä»–æµ‹è¯•æ•°æ®ç‚¹åŒæ ·æœ‰æ•ˆï¼Œè¡¨æ˜å…¶å­¦ä¹ åˆ°çš„è°ƒåˆ¶æ˜¯é€šç”¨çš„ã€‚ Tent è°ƒåˆ¶ä¸å½’ä¸€åŒ–ä¸åŒï¼šå¯¹æ¯”åˆ†ææ˜¾ç¤ºï¼ŒTent çš„ç‰¹å¾è°ƒåˆ¶ä½¿ç‰¹å¾æ›´æ¥è¿‘åœ¨ç›®æ ‡æ ‡ç­¾ä¸Šä¼˜åŒ–çš„Oracleæ¨¡å‹ï¼ˆç†æƒ³æ¨¡å‹ï¼‰ï¼Œè€Œéä»…åƒBatch Normalizationé‚£æ ·æ¥è¿‘åŸå§‹å‚è€ƒåˆ†å¸ƒã€‚ Tent é€‚åº”å…¶ä»–ç½‘ç»œæ¶æ„ï¼šTent åœ¨åŸºäºSelf-Attention å’ŒEquilibrium Solving (MDEQ) çš„æ¨¡å‹ä¸Šä¹Ÿèƒ½æœ‰æ•ˆé™ä½è¯¯å·®ï¼Œå±•ç°äº†å…¶æ™®é€‚æ€§ã€‚ Related Work è®ºæ–‡å›é¡¾äº†ä¸ Tent ç›¸å…³çš„ç°æœ‰å·¥ä½œï¼š\nTrain-Time Adaptation æ–¹æ³•ï¼šä¼ ç»Ÿçš„Domain Adaptationã€Test-Time Training (TTT) ç­‰ï¼Œé€šå¸¸éœ€è¦æºæ•°æ®æˆ–è®­ç»ƒé˜¶æ®µä¿®æ”¹æ¨¡å‹ã€‚ Source-Free Adaptation æ–¹æ³•ï¼šè¿‘æœŸä¸€äº›ä¸ä¾èµ–æºæ•°æ®çš„æ–¹æ³•ï¼Œä½†é€šå¸¸éœ€è¦æ›´å¤æ‚çš„è®¾è®¡ã€ç¦»çº¿ä¼˜åŒ–æˆ–ä¿®æ”¹è®­ç»ƒè¿‡ç¨‹ã€‚Tent çš„ä¼˜åŠ¿åœ¨äºå…¶åœ¨çº¿ã€é«˜æ•ˆä¸”ä¸æ”¹å˜è®­ç»ƒè¿‡ç¨‹ã€‚ Entropy Minimizationï¼šç†µæœ€å°åŒ–å·²è¢«å¹¿æ³›ç”¨äºSemi-Supervised Learningå’ŒDomain Adaptationçš„æ­£åˆ™åŒ–é¡¹ï¼Œä½† Tent é¦–æ¬¡å°†å…¶ä½œä¸ºFully Test-Time Adaptationä¸­å”¯ä¸€çš„æ— ç›‘ç£æŸå¤±æ¥é©±åŠ¨æ¨¡å‹é€‚åº”ã€‚ Feature Modulationï¼šå½’ä¸€åŒ–å±‚å’Œä»¿å°„å˜æ¢å·²è¢«ç”¨äºå„ç§ä»»åŠ¡çš„ç‰¹å¾è°ƒåˆ¶ï¼Œä½† Tent å°†å…¶ä½œä¸ºåœ¨æµ‹è¯•æ—¶é€šè¿‡æ— ç›‘ç£ç›®æ ‡è¿›è¡Œä¼˜åŒ–çš„æ ¸å¿ƒæœºåˆ¶ã€‚ Discussion Tent é€šè¿‡Test Entropy Minimizationå®ç°äº†åœ¨æ•°æ®æ¼‚ç§»æƒ…å†µä¸‹çš„æ³›åŒ–è¯¯å·®é™ä½ã€‚å…¶æ ¸å¿ƒåœ¨äºæ¨¡å‹çš„è‡ªç›‘ç£è‡ªæˆ‘æ”¹è¿›ï¼Œå³ä¾æ®è‡ªèº«çš„é¢„æµ‹åé¦ˆè¿›è¡Œè°ƒæ•´ã€‚\nä¼˜åŠ¿æ€»ç»“ï¼š é«˜æ•ˆï¼šä»…é€šè¿‡åœ¨çº¿ä¼˜åŒ–å°‘æ•°å‚æ•°ï¼ˆ$ \\gamma, \\beta $ï¼‰å®ç°ã€‚ å®ç”¨ï¼šæ— éœ€æºæ•°æ®è®¿é—®ï¼Œä¸æ”¹å˜æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ã€‚ é€šç”¨ï¼šé€‚ç”¨äºå¤šç§æ•°æ®æ¼‚ç§»ç±»å‹å’Œä¸åŒç½‘ç»œæ¶æ„ã€‚ å°½ç®¡ Tent åœ¨å¹¿æ³›çš„åœºæ™¯ä¸­è¡¨ç°å‡ºè‰²ï¼Œä½†ä»å­˜åœ¨æŒ‘æˆ˜ï¼Œä¾‹å¦‚åœ¨ç‰¹å®šå›°éš¾çš„æ•°æ®æ¼‚ç§»ï¼ˆå¦‚ SVHN åˆ° MNIST-M/USPSï¼‰ä¸Šä»æœ‰æå‡ç©ºé—´ã€‚æœªæ¥ç ”ç©¶æ–¹å‘å¯æ¢ç´¢æ›´å…¨é¢çš„å‚æ•°è°ƒæ•´ã€æ›´é€šç”¨çš„Test-Time Adaptation Lossä»¥åŠè¿›ä¸€æ­¥æå‡æ•ˆç‡çš„æ–¹æ³•ã€‚æ€»è€Œè¨€ä¹‹ï¼ŒTent ä¸ºFully Test-Time Adaptation æä¾›äº†ä¸€ä¸ªåˆ›æ–°ä¸”å®ç”¨çš„èŒƒå¼ï¼Œä½¿å¾—æ¨¡å‹èƒ½å¤Ÿåœ¨éƒ¨ç½²åï¼Œåœ¨é¢å¯¹æœªçŸ¥ä¸”æ— æ ‡ç­¾çš„æµ‹è¯•æ•°æ®æ—¶ï¼Œå…·å¤‡å¼ºå¤§çš„è‡ªæˆ‘é€‚åº”èƒ½åŠ›ã€‚\n","permalink":"https://diefish1024.github.io/posts/literature-notes/tent/","summary":"\u003ch1 id=\"setting\"\u003eSetting\u003c/h1\u003e\n\u003cp\u003e\u003cstrong\u003eFully Test-Time Adaptation\u003c/strong\u003e æ˜¯ä¸€ç§ç‹¬ç‰¹çš„æ¨¡å‹é€‚åº”è®¾å®šã€‚åœ¨æ­¤è®¾å®šä¸‹ï¼Œæ¨¡å‹ $ f_\\theta(x) $ åœ¨è®­ç»ƒé˜¶æ®µå·²é€šè¿‡æºæ•°æ® $ x^s $ å’Œæ ‡ç­¾ $ y^s $ å®Œæˆè®­ç»ƒï¼Œè·å¾—å‚æ•° $ \\theta $ã€‚ä½†åœ¨æµ‹è¯•é˜¶æ®µï¼Œæ¨¡å‹å°†é‡åˆ°ä¸æºæ•°æ®åˆ†å¸ƒä¸åŒçš„æ— æ ‡ç­¾ç›®æ ‡æ•°æ® $ x^t $ã€‚\u003c/p\u003e\n\u003cp\u003eFTT-Adaptation ä¸ä»¥ä¸‹æ–¹æ³•ä¸åŒï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eFine-tuning\u003c/strong\u003eï¼šéœ€è¦ç›®æ ‡æ ‡ç­¾è¿›è¡Œé‡æ–°è®­ç»ƒã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eDomain Adaptation\u003c/strong\u003eï¼šéœ€è¦æºæ•°æ®å’Œç›®æ ‡æ•°æ®è¿›è¡Œè”åˆè®­ç»ƒã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eTest-Time Training (TTT)\u003c/strong\u003eï¼šéœ€è¦ä¿®æ”¹è®­ç»ƒè¿‡ç¨‹å¹¶å…±åŒä¼˜åŒ–æœ‰ç›‘ç£åŠè‡ªç›‘ç£æŸå¤±ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç›¸æ¯”ä¹‹ä¸‹ï¼ŒFTT-Adaptation ä»…èƒ½åˆ©ç”¨é¢„è®­ç»ƒæ¨¡å‹ $ f_\\theta $ å’Œæ— æ ‡ç­¾ç›®æ ‡æ•°æ® $ x^t $ è¿›è¡Œé€‚åº”ï¼Œä¸ä¾èµ–æºæ•°æ®æˆ–é¢å¤–çš„ç›‘ç£ä¿¡æ¯ã€‚\u003c/p\u003e\n\u003ch2 id=\"method\"\u003eMethod\u003c/h2\u003e\n\u003cp\u003eè®ºæ–‡çš„æ ¸å¿ƒè´¡çŒ®æ˜¯æå‡ºäº† \u003cstrong\u003eTent\u003c/strong\u003e æ–¹æ³•ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡\u003cstrong\u003eæœ€å°åŒ–æµ‹è¯•ç†µ\u003c/strong\u003eï¼ˆ\u003cstrong\u003eTest Entropy Minimization\u003c/strong\u003eï¼‰æ¥é€‚åº”æ¨¡å‹é¢„æµ‹ï¼Œæ—¨åœ¨ä½¿æ¨¡å‹å¯¹æµ‹è¯•æ•°æ®çš„é¢„æµ‹ç»“æœæ›´â€œæœ‰ä¿¡å¿ƒâ€ã€‚\u003c/p\u003e\n\u003ch3 id=\"entropy-objective\"\u003eEntropy Objective\u003c/h3\u003e\n\u003cp\u003eTent çš„æµ‹è¯•æ—¶ç›®æ ‡å‡½æ•°æ˜¯æœ€å°åŒ–æ¨¡å‹é¢„æµ‹ $ \\hat{y} = f_\\theta(x^t) $ çš„\u003cstrong\u003eç†µ $ H(\\hat{y}) $\u003c/strong\u003eã€‚è®ºæ–‡ä¸­ä½¿ç”¨çš„\u003cstrong\u003eé¦™å†œç†µ\u003c/strong\u003eè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š\u003c/p\u003e\n$$ \n\nH(\\hat{y}) = - \\sum_c p(\\hat{y}_c) \\log p(\\hat{y}_c)\n\n $$\n\u003cp\u003eå…¶ä¸­ï¼Œ $ p(\\hat{y}_c) $ è¡¨ç¤ºæ¨¡å‹é¢„æµ‹ç›®æ ‡æ•°æ® $ x^t $ å±äºç±»åˆ« $ c $ çš„æ¦‚ç‡ã€‚\u003c/p\u003e","title":"Tent"},{"content":"Setting Continual Test-Time Domain Adaptation æ˜¯ä¸€ç§æ›´å…·æŒ‘æˆ˜æ€§çš„æ¨¡å‹é€‚åº”è®¾å®šã€‚åœ¨æ­¤è®¾å®šä¸‹ï¼Œä¸€ä¸ªåœ¨æºæ•°æ®ä¸Šé¢„è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œåœ¨æµ‹è¯•æ—¶ä¼šé‡åˆ°ä¸€ä¸ªéå¹³ç¨³ä¸”æŒç»­å˜åŒ–çš„ç›®æ ‡ç¯å¢ƒ ã€‚\nCoTTA ä¸ä»¥ä¸‹æ–¹æ³•ä¸åŒï¼š\nStandard Domain Adaptationï¼šéœ€è¦åŒæ—¶è®¿é—®æºæ•°æ®å’Œï¼ˆé™æ€çš„ï¼‰ç›®æ ‡æ•°æ®è¿›è¡Œè®­ç»ƒã€‚ Standard Test-Time Adaptation / Fully Test-Time Adaptationï¼šé€šå¸¸å‡è®¾ç›®æ ‡åŸŸæ˜¯å›ºå®šçš„æˆ–é™æ€çš„ï¼Œè€Œ CoTTA å…³æ³¨çš„æ˜¯æŒç»­å˜åŒ–çš„ç›®æ ‡åŸŸã€‚ Test-Time Training (TTT)ï¼šéœ€è¦ä¿®æ”¹æºæ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ä»¥åŠ å…¥è¾…åŠ©ä»»åŠ¡ï¼Œå› æ­¤æ— æ³•ä½¿ç”¨ä»»æ„çš„â€œå¼€ç®±å³ç”¨â€é¢„è®­ç»ƒæ¨¡å‹ã€‚ ç›¸æ¯”ä¹‹ä¸‹ï¼ŒCoTTA ä¸“é—¨è§£å†³åœ¨æ— æºæ•°æ®çš„æ¡ä»¶ä¸‹ï¼Œæ¨¡å‹å¦‚ä½•åœ¨çº¿é€‚åº”ä¸€ä¸ªæŒç»­å˜åŒ–çš„æ•°æ®æµï¼ŒåŒæ—¶å…‹æœç°æœ‰æ–¹æ³•ä¸­å¸¸è§çš„é”™è¯¯ç´¯ç§¯å’Œç¾éš¾æ€§é—å¿˜é—®é¢˜ã€‚\nMethod è®ºæ–‡çš„æ ¸å¿ƒè´¡çŒ®æ˜¯æå‡ºäº†CoTTA (Continual Test-Time Adaptation) æ–¹æ³•ï¼Œæ—¨åœ¨é€šè¿‡å‡å°‘é”™è¯¯ç´¯ç§¯å’Œé¿å…ç¾éš¾æ€§é—å¿˜ï¼Œå®ç°æ¨¡å‹åœ¨éå¹³ç¨³ç¯å¢ƒä¸‹çš„é•¿æœŸç¨³å®šé€‚åº”ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªå…³é”®éƒ¨åˆ†ã€‚\n1. å‡å°‘é”™è¯¯ç´¯ç§¯ (Reducing Error Accumulation) ä¸ºäº†ç”Ÿæˆæ›´å¯é çš„è‡ªè®­ç»ƒä¿¡å·ï¼ŒCoTTA é‡‡ç”¨äº†å¹³å‡åŒ–çš„ä¼ªæ ‡ç­¾ç­–ç•¥ï¼Œè¯¥ç­–ç•¥ç»“åˆäº†æƒé‡å¹³å‡å’Œæ•°æ®å¢å¼ºå¹³å‡ã€‚\næƒé‡å¹³å‡ä¼ªæ ‡ç­¾ (Weight-Averaged Pseudo-Labels) è¯¥æ–¹æ³•é‡‡ç”¨ä¸€ä¸ªæ•™å¸ˆ - å­¦ç”Ÿ (teacher-student) æ¡†æ¶ã€‚å­¦ç”Ÿæ¨¡å‹ (student model) åœ¨çº¿è¿›è¡Œå­¦ä¹ å’Œæ›´æ–°ã€‚ æ•™å¸ˆæ¨¡å‹ (teacher model) çš„æƒé‡æ˜¯å­¦ç”Ÿæ¨¡å‹æƒé‡çš„æŒ‡æ•°ç§»åŠ¨å¹³å‡ (Exponential Moving Average, EMA)ã€‚ ç”±äºæ•™å¸ˆæ¨¡å‹çš„æ›´æ–°æ›´å¹³æ»‘ï¼Œå…¶é¢„æµ‹ç»“æœé€šå¸¸æ¯”å­¦ç”Ÿæ¨¡å‹æ›´å‡†ç¡®ï¼Œå› æ­¤ç”¨å®ƒæ¥ç”Ÿæˆä¼ªæ ‡ç­¾ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘é”™è¯¯ç´¯ç§¯ã€‚å­¦ç”Ÿæ¨¡å‹é€šè¿‡æœ€å°åŒ–ä¸æ•™å¸ˆä¼ªæ ‡ç­¾çš„ä¸€è‡´æ€§æŸå¤± (consistency loss) æ¥è¿›è¡Œæ›´æ–°ã€‚ æ•°æ®å¢å¼ºå¹³å‡ä¼ªæ ‡ç­¾ (Augmentation-Averaged Pseudo-Labels) ä¸ºäº†è¿›ä¸€æ­¥æå‡ä¼ªæ ‡ç­¾åœ¨é‡åˆ°è¾ƒå¤§åŸŸåç§»æ—¶çš„è´¨é‡ï¼ŒCoTTA ä¼šæœ‰æ¡ä»¶åœ°ä½¿ç”¨æ•°æ®å¢å¼ºã€‚ å®ƒé¦–å…ˆä½¿ç”¨åŸå§‹é¢„è®­ç»ƒæ¨¡å‹è¯„ä¼°å½“å‰æµ‹è¯•æ•°æ®çš„é¢„æµ‹ç½®ä¿¡åº¦ï¼Œä»¥æ­¤æ¥è¿‘ä¼¼åŸŸå·®å¼‚çš„å¤§å°ã€‚ æ¡ä»¶æ€§åº”ç”¨ï¼š å¦‚æœç½®ä¿¡åº¦é«˜ï¼ˆåŸŸå·®å¼‚å°ï¼‰ï¼Œåˆ™ç›´æ¥ä½¿ç”¨æ•™å¸ˆæ¨¡å‹çš„é¢„æµ‹ä½œä¸ºä¼ªæ ‡ç­¾ã€‚ å¦‚æœç½®ä¿¡åº¦ä½ï¼ˆåŸŸå·®å¼‚å¤§ï¼‰ï¼Œåˆ™å¯¹è¾“å…¥æ•°æ®è¿›è¡Œ N æ¬¡éšæœºå¢å¼ºï¼Œå¹¶å°†æ•™å¸ˆæ¨¡å‹å¯¹è¿™äº›å¢å¼ºæ ·æœ¬çš„å¹³å‡é¢„æµ‹ç»“æœä½œä¸ºä¼ªæ ‡ç­¾ã€‚è¿™å¯ä»¥è¿›ä¸€æ­¥æé«˜ä¼ªæ ‡ç­¾çš„é²æ£’æ€§ã€‚ 2. é¿å…ç¾éš¾æ€§é—å¿˜ (Avoiding Catastrophic Forgetting) ä¸ºäº†åœ¨é•¿æœŸé€‚åº”è¿‡ç¨‹ä¸­ä¿ç•™ä»æºåŸŸå­¦åˆ°çš„çŸ¥è¯†ï¼ŒCoTTA å¼•å…¥äº†éšæœºæ¢å¤ (Stochastic Restoration) æœºåˆ¶ã€‚\næ ¸å¿ƒæ€æƒ³ï¼šåœ¨æ¯æ¬¡æ¨¡å‹æ›´æ–°åï¼Œä»¥ä¸€ä¸ªå¾ˆå°çš„æ¦‚ç‡ pï¼Œå°†æ¨¡å‹ä¸­çš„ä¸€å°éƒ¨åˆ†æƒé‡å‚æ•°éšæœºåœ°æ¢å¤åˆ°å…¶åŸå§‹çš„ã€é¢„è®­ç»ƒæ—¶çš„çŠ¶æ€ã€‚ ä¼˜åŠ¿ï¼š è¿™ç§æœºåˆ¶å¯ä»¥çœ‹ä½œä¸€ç§ç‰¹æ®Šçš„ Dropoutã€‚å®ƒèƒ½æœ‰æ•ˆé˜²æ­¢æ¨¡å‹åœ¨é€‚åº”æ–°æ•°æ®æ—¶â€œæ¼‚ç§»â€å¾—ç¦»æºæ¨¡å‹å¤ªè¿œï¼Œä»è€Œæ˜¾å¼åœ°ä¿ç•™äº†æºçŸ¥è¯†ï¼Œé¿å…äº†ç¾éš¾æ€§é—å¿˜ã€‚ é€šè¿‡ä¿ç•™æºçŸ¥è¯†ï¼ŒCoTTA èƒ½å¤Ÿå®‰å…¨åœ°æ›´æ–°ç½‘ç»œä¸­çš„æ‰€æœ‰å‚æ•°ï¼Œè€Œä¸ä»…ä»…æ˜¯å½’ä¸€åŒ–å±‚ï¼Œè¿™ä¸ºæ¨¡å‹é€‚åº”æä¾›äº†æ›´å¤§çš„å®¹é‡ã€‚ Algorithm CoTTA ç®—æ³•çš„åœ¨çº¿æµç¨‹å¦‚ä¸‹ï¼š\nInitialization (åˆå§‹åŒ–)ï¼š åŠ è½½ä¸€ä¸ªâ€œå¼€ç®±å³ç”¨â€çš„é¢„è®­ç»ƒæºæ¨¡å‹ $ f_{\\theta_{0}} $ ç”¨æºæ¨¡å‹æƒé‡åˆå§‹åŒ–æ•™å¸ˆæ¨¡å‹ $ f_{\\theta'_{0}} $ Iteration (è¿­ä»£)ï¼šå¯¹äºåœ¨çº¿è¾“å…¥çš„æ¯ä¸ªæµ‹è¯•æ•°æ® $ x_{t} $â€‹ï¼š ç”Ÿæˆä¼ªæ ‡ç­¾ï¼šä½¿ç”¨æ•™å¸ˆæ¨¡å‹ $ f_{\\theta'_{t}} $â€‹â€‹ï¼Œå¹¶ç»“åˆæ¡ä»¶æ€§æ•°æ®å¢å¼ºï¼Œç”Ÿæˆæƒé‡å’Œå¢å¼ºå¹³å‡çš„ä¼ªæ ‡ç­¾ã€‚ æ›´æ–°å­¦ç”Ÿæ¨¡å‹ï¼šé€šè¿‡ä¸€è‡´æ€§æŸå¤±æ›´æ–°å­¦ç”Ÿæ¨¡å‹ $ f_{\\theta_{t}} $ æ›´æ–°æ•™å¸ˆæ¨¡å‹ï¼šä½¿ç”¨ EMA æ›´æ–°æ•™å¸ˆæ¨¡å‹çš„æƒé‡ $ f_{\\theta'_{t+1}} $ éšæœºæ¢å¤ï¼šå¯¹å­¦ç”Ÿæ¨¡å‹çš„æƒé‡è¿›è¡Œéšæœºæ¢å¤ Output (è¾“å‡º)ï¼šä½¿ç”¨æ•™å¸ˆæ¨¡å‹ $ f_{\\theta'_{t}} $â€‹â€‹ è¿›è¡Œåœ¨çº¿é¢„æµ‹ï¼Œå¹¶ä¼ é€’æ›´æ–°åçš„å­¦ç”Ÿå’Œæ•™å¸ˆæ¨¡å‹åˆ°ä¸‹ä¸€ä¸ªæ—¶é—´æ­¥ã€‚ Experiments è®ºæ–‡åœ¨å¤šä¸ªå›¾åƒåˆ†ç±»å’Œè¯­ä¹‰åˆ†å‰²ä»»åŠ¡ä¸Šå¯¹ CoTTA è¿›è¡Œäº†è¯„ä¼°ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸€ä¸ªæŒç»­å˜åŒ–çš„æµ‹è¯•ç¯å¢ƒä¸­ã€‚\nContinual Adaptation on Corrupted Images åœ¨ CIFAR10-Cã€CIFAR100-C å’Œ ImageNet-C æ•°æ®é›†ä¸Šï¼Œæ¨¡å‹è¢«é¡ºåºè¾“å…¥ 15 ç§ä¸åŒç±»å‹çš„æŸåå›¾åƒã€‚\nä¸»è¦å‘ç°ï¼š åœ¨ CIFAR10-C ä¸Šï¼ŒCoTTA çš„å¹³å‡é”™è¯¯ç‡ä»…ä¸º 16.2%ï¼Œæ˜¾è‘—ä¼˜äº Source-only åŸºçº¿ (43.5%) å’Œ TENT-continual (20.7%)ã€‚ åœ¨æ›´éš¾çš„ CIFAR100-C ä¸Šï¼ŒTENT ç­‰æ–¹æ³•å› é”™è¯¯ç´¯ç§¯å¯¼è‡´æ€§èƒ½éšæ—¶é—´æ¨ç§»è€Œæ€¥å‰§ä¸‹é™ï¼ˆé”™è¯¯ç‡ä» 37.2% æ¶åŒ–åˆ° 90.4%ï¼‰ï¼Œè€Œ CoTTA è¡¨ç°ç¨³å®šï¼Œå¹³å‡é”™è¯¯ç‡ä»…ä¸º 32.5% ã€‚ å®éªŒè¡¨æ˜ï¼ŒTENT åœ¨æŒç»­é€‚åº”çš„åæœŸä¼šå› é”™è¯¯ç´¯ç§¯è€Œæ€§èƒ½å´©æºƒï¼Œè€Œ CoTTA çš„éšæœºæ¢å¤æœºåˆ¶æˆåŠŸé¿å…äº†è¿™ä¸€ç‚¹ã€‚ Continual Adaptation on Semantic Segmentation åœ¨ä¸€ä¸ªä» Cityscapes (æ™´å¤©) åˆ° ACDC (é›¾ã€å¤œã€é›¨ã€é›ªç­‰æ¶åŠ£å¤©æ°”) çš„æŒç»­è¯­ä¹‰åˆ†å‰²ä»»åŠ¡ä¸­ï¼Œæ¨¡å‹ä¼šå¾ªç¯ç»å†è¿™å››ç§å¤©æ°”æ¡ä»¶ 10 æ¬¡ï¼Œä»¥æµ‹è¯•å…¶é•¿æœŸé€‚åº”å’Œé—å¿˜æƒ…å†µã€‚\nä¸»è¦å‘ç°ï¼š CoTTA å°†å¹³å‡ mIoU æå‡è‡³ 58.6%ï¼Œä¼˜äºæºæ¨¡å‹ (56.7%) å’Œå…¶ä»–é€‚åº”æ–¹æ³•ã€‚ TENT åœ¨æ­¤ä»»åŠ¡ä¸Šè¡¨ç°ä¸ä½³ï¼Œå› ä¸ºå…¶ä¾èµ–çš„æ‰¹é‡å½’ä¸€åŒ– (Batch Normalization) å±‚åœ¨ Transformer æ¶æ„ (Segformer) ä¸­å¾ˆå°‘ã€‚ CoTTA ä¸ä¾èµ–äºç‰¹å®šå±‚ï¼Œå› æ­¤åœ¨åŸºäº Transformer çš„æ¶æ„ä¸ŠåŒæ ·æœ‰æ•ˆï¼Œå±•ç°äº†å…¶é€šç”¨æ€§ã€‚ Analysis é€šè¿‡æ¶ˆèå®éªŒéªŒè¯äº† CoTTA å„ä¸ªç»„ä»¶çš„æœ‰æ•ˆæ€§ã€‚\næƒé‡å¹³å‡çš„ä½œç”¨ï¼šä»…ä½¿ç”¨æƒé‡å¹³å‡çš„ä¼ªæ ‡ç­¾ï¼Œå°±å°†é”™è¯¯ç‡ä» 20.7% (TENT-continual) é™è‡³ 18.3%ï¼Œè¯æ˜äº†æ•™å¸ˆæ¨¡å‹ä¼ªæ ‡ç­¾çš„ä¼˜è¶Šæ€§ã€‚ æ•°æ®å¢å¼ºå¹³å‡çš„ä½œç”¨ï¼šåœ¨æƒé‡å¹³å‡çš„åŸºç¡€ä¸Šå†åŠ å…¥æ¡ä»¶æ€§æ•°æ®å¢å¼ºï¼Œé”™è¯¯ç‡è¿›ä¸€æ­¥é™è‡³ 17.4%ã€‚ éšæœºæ¢å¤çš„ä½œç”¨ï¼šæœ€ååŠ å…¥éšæœºæ¢å¤æœºåˆ¶ï¼Œé”™è¯¯ç‡æœ€ç»ˆé™è‡³ 16.2%ï¼Œå¹¶ä¸”è§£å†³äº†é•¿æœŸé€‚åº”ä¸­çš„æ€§èƒ½è¡°é€€é—®é¢˜ï¼Œè¯æ˜äº†å…¶åœ¨é¿å…ç¾éš¾æ€§é—å¿˜ä¸­çš„å…³é”®ä½œç”¨ã€‚ Related Work è®ºæ–‡å›é¡¾äº†ä¸ CoTTA ç›¸å…³çš„é¢†åŸŸï¼š\nTest-Time Adaptation (TTA)ï¼šç°æœ‰å·¥ä½œå¤§å¤šå…³æ³¨é™æ€ç›®æ ‡åŸŸï¼Œåœ¨æŒç»­å˜åŒ–çš„ç¯å¢ƒä¸­ï¼ŒåŸºäºç†µæœ€å°åŒ–æˆ–ä¼ªæ ‡ç­¾çš„æ–¹æ³•å®¹æ˜“å› ä¼ªæ ‡ç­¾å™ªå£°è€Œç´¯ç§¯é”™è¯¯ã€‚ Continuous Domain Adaptationï¼šä¸ CoTTA ç›®æ ‡ç›¸ä¼¼ï¼Œä½†ç°æœ‰æ–¹æ³•é€šå¸¸éœ€è¦è®¿é—®æºæ•°æ®æ¥å¯¹é½åˆ†å¸ƒã€‚ Continual Learningï¼šCoTTA å€Ÿé‰´äº†è¯¥é¢†åŸŸçš„æ€æƒ³æ¥è§£å†³ç¾éš¾æ€§é—å¿˜é—®é¢˜ï¼Œä½†å°†å…¶åº”ç”¨åœ¨äº†ä¸€ä¸ªæ— ç›‘ç£ã€æµ‹è¯•æ—¶é€‚åº”çš„ç‹¬ç‰¹åœºæ™¯ä¸­ã€‚ Source-Free Domain Adaptationï¼šCoTTA å±äºæ­¤èŒƒç•´ï¼Œå…¶æ–°é¢–ä¹‹å¤„åœ¨äºå®ƒä¸“ä¸ºåœ¨çº¿å’ŒæŒç»­å˜åŒ–çš„ç¯å¢ƒè®¾è®¡ï¼Œè€Œè¿™æ˜¯å…ˆå‰å·¥ä½œå¾ˆå°‘è€ƒè™‘çš„ã€‚ Discussion CoTTA æˆåŠŸåœ°è§£å†³äº†åœ¨æ— æºæ•°æ®ã€éå¹³ç¨³ç¯å¢ƒä¸‹è¿›è¡ŒæŒç»­æµ‹è¯•æ—¶é€‚åº”çš„æŒ‘æˆ˜ã€‚å®ƒé€šè¿‡åˆ›æ–°çš„æœºåˆ¶åŒæ—¶è§£å†³äº†é”™è¯¯ç´¯ç§¯å’Œç¾éš¾æ€§é—å¿˜è¿™ä¸¤ä¸ªæ ¸å¿ƒéš¾é¢˜ã€‚\nä¼˜åŠ¿æ€»ç»“ï¼š ç¨³å®šä¸é•¿æ•ˆï¼šé€šè¿‡éšæœºæ¢å¤æœºåˆ¶ï¼ŒCoTTA å®ç°äº†åœ¨é•¿æœŸæŒç»­é€‚åº”è¿‡ç¨‹ä¸­çš„æ€§èƒ½ç¨³å®šï¼Œé¿å…äº†æ€§èƒ½å´©æºƒã€‚ å®ç”¨ä¸é€šç”¨ï¼šæ— éœ€è®¿é—®æºæ•°æ®ï¼Œä¹Ÿæ— éœ€ä¿®æ”¹æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ï¼Œå¯ç›´æ¥ç”¨äºå„ç±»â€œå¼€ç®±å³ç”¨â€çš„é¢„è®­ç»ƒæ¨¡å‹ï¼ˆåŒ…æ‹¬ CNN å’Œ Transformerï¼‰ ã€‚ é«˜æ•ˆï¼šæ•´ä¸ªé€‚åº”è¿‡ç¨‹åœ¨çº¿è¿›è¡Œï¼Œæ¨¡å‹æ ¹æ®å½“å‰æ•°æ®æµå³æ—¶æ›´æ–°å’Œé¢„æµ‹ã€‚ æ€»è€Œè¨€ä¹‹ï¼ŒCoTTA ä¸ºæ¨¡å‹åœ¨çœŸå®ä¸–ç•Œä¸­éƒ¨ç½²åçš„æŒç»­è‡ªæˆ‘è¿›åŒ–æä¾›äº†ä¸€ä¸ªå¼ºå¤§ä¸”å®ç”¨çš„æ¡†æ¶ï¼Œä½¿æ¨¡å‹èƒ½å¤Ÿé²æ£’åœ°é€‚åº”ä¸æ–­å˜åŒ–çš„æ“ä½œç¯å¢ƒã€‚\n","permalink":"https://diefish1024.github.io/posts/literature-notes/cotta/","summary":"\u003ch1 id=\"setting\"\u003eSetting\u003c/h1\u003e\n\u003cp\u003e\u003cstrong\u003eContinual Test-Time Domain Adaptation\u003c/strong\u003e æ˜¯ä¸€ç§æ›´å…·æŒ‘æˆ˜æ€§çš„æ¨¡å‹é€‚åº”è®¾å®šã€‚åœ¨æ­¤è®¾å®šä¸‹ï¼Œä¸€ä¸ªåœ¨æºæ•°æ®ä¸Šé¢„è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œåœ¨æµ‹è¯•æ—¶ä¼šé‡åˆ°ä¸€ä¸ª\u003cstrong\u003eéå¹³ç¨³\u003c/strong\u003eä¸”\u003cstrong\u003eæŒç»­å˜åŒ–\u003c/strong\u003eçš„ç›®æ ‡ç¯å¢ƒ ã€‚\u003c/p\u003e\n\u003cp\u003eCoTTA ä¸ä»¥ä¸‹æ–¹æ³•ä¸åŒï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eStandard Domain Adaptation\u003c/strong\u003eï¼šéœ€è¦åŒæ—¶è®¿é—®æºæ•°æ®å’Œï¼ˆé™æ€çš„ï¼‰ç›®æ ‡æ•°æ®è¿›è¡Œè®­ç»ƒã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eStandard Test-Time Adaptation / Fully Test-Time Adaptation\u003c/strong\u003eï¼šé€šå¸¸å‡è®¾ç›®æ ‡åŸŸæ˜¯å›ºå®šçš„æˆ–é™æ€çš„ï¼Œè€Œ CoTTA å…³æ³¨çš„æ˜¯æŒç»­å˜åŒ–çš„ç›®æ ‡åŸŸã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eTest-Time Training (TTT)\u003c/strong\u003eï¼šéœ€è¦ä¿®æ”¹æºæ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ä»¥åŠ å…¥è¾…åŠ©ä»»åŠ¡ï¼Œå› æ­¤æ— æ³•ä½¿ç”¨ä»»æ„çš„â€œå¼€ç®±å³ç”¨â€é¢„è®­ç»ƒæ¨¡å‹ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eç›¸æ¯”ä¹‹ä¸‹ï¼ŒCoTTA ä¸“é—¨è§£å†³åœ¨\u003cstrong\u003eæ— æºæ•°æ®\u003c/strong\u003eçš„æ¡ä»¶ä¸‹ï¼Œæ¨¡å‹å¦‚ä½•åœ¨çº¿é€‚åº”ä¸€ä¸ª\u003cstrong\u003eæŒç»­å˜åŒ–çš„\u003c/strong\u003eæ•°æ®æµï¼ŒåŒæ—¶å…‹æœç°æœ‰æ–¹æ³•ä¸­å¸¸è§çš„\u003cstrong\u003eé”™è¯¯ç´¯ç§¯\u003c/strong\u003eå’Œ\u003cstrong\u003eç¾éš¾æ€§é—å¿˜\u003c/strong\u003eé—®é¢˜ã€‚\u003c/p\u003e\n\u003ch2 id=\"method\"\u003eMethod\u003c/h2\u003e\n\u003cp\u003eè®ºæ–‡çš„æ ¸å¿ƒè´¡çŒ®æ˜¯æå‡ºäº†\u003cstrong\u003eCoTTA (Continual Test-Time Adaptation)\u003c/strong\u003e æ–¹æ³•ï¼Œæ—¨åœ¨é€šè¿‡\u003cstrong\u003eå‡å°‘é”™è¯¯ç´¯ç§¯\u003c/strong\u003eå’Œ\u003cstrong\u003eé¿å…ç¾éš¾æ€§é—å¿˜\u003c/strong\u003eï¼Œå®ç°æ¨¡å‹åœ¨éå¹³ç¨³ç¯å¢ƒä¸‹çš„é•¿æœŸç¨³å®šé€‚åº”ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªå…³é”®éƒ¨åˆ†ã€‚\u003c/p\u003e\n\u003ch3 id=\"1-å‡å°‘é”™è¯¯ç´¯ç§¯-reducing-error-accumulation\"\u003e1. å‡å°‘é”™è¯¯ç´¯ç§¯ (Reducing Error Accumulation)\u003c/h3\u003e\n\u003cp\u003eä¸ºäº†ç”Ÿæˆæ›´å¯é çš„è‡ªè®­ç»ƒä¿¡å·ï¼ŒCoTTA é‡‡ç”¨äº†å¹³å‡åŒ–çš„ä¼ªæ ‡ç­¾ç­–ç•¥ï¼Œè¯¥ç­–ç•¥ç»“åˆäº†æƒé‡å¹³å‡å’Œæ•°æ®å¢å¼ºå¹³å‡ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eæƒé‡å¹³å‡ä¼ªæ ‡ç­¾ (Weight-Averaged Pseudo-Labels)\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003eè¯¥æ–¹æ³•é‡‡ç”¨ä¸€ä¸ª\u003cstrong\u003eæ•™å¸ˆ - å­¦ç”Ÿ (teacher-student)\u003c/strong\u003e æ¡†æ¶ã€‚å­¦ç”Ÿæ¨¡å‹ (student model) åœ¨çº¿è¿›è¡Œå­¦ä¹ å’Œæ›´æ–°ã€‚\u003c/li\u003e\n\u003cli\u003eæ•™å¸ˆæ¨¡å‹ (teacher model) çš„æƒé‡æ˜¯å­¦ç”Ÿæ¨¡å‹æƒé‡çš„\u003cstrong\u003eæŒ‡æ•°ç§»åŠ¨å¹³å‡ (Exponential Moving Average, EMA)\u003c/strong\u003eã€‚\u003c/li\u003e\n\u003cli\u003eç”±äºæ•™å¸ˆæ¨¡å‹çš„æ›´æ–°æ›´å¹³æ»‘ï¼Œå…¶é¢„æµ‹ç»“æœé€šå¸¸æ¯”å­¦ç”Ÿæ¨¡å‹æ›´å‡†ç¡®ï¼Œå› æ­¤ç”¨å®ƒæ¥ç”Ÿæˆä¼ªæ ‡ç­¾ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘é”™è¯¯ç´¯ç§¯ã€‚å­¦ç”Ÿæ¨¡å‹é€šè¿‡æœ€å°åŒ–ä¸æ•™å¸ˆä¼ªæ ‡ç­¾çš„\u003cstrong\u003eä¸€è‡´æ€§æŸå¤±\u003c/strong\u003e (consistency loss) æ¥è¿›è¡Œæ›´æ–°ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ•°æ®å¢å¼ºå¹³å‡ä¼ªæ ‡ç­¾ (Augmentation-Averaged Pseudo-Labels)\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003eä¸ºäº†è¿›ä¸€æ­¥æå‡ä¼ªæ ‡ç­¾åœ¨é‡åˆ°è¾ƒå¤§åŸŸåç§»æ—¶çš„è´¨é‡ï¼ŒCoTTA ä¼šæœ‰æ¡ä»¶åœ°ä½¿ç”¨æ•°æ®å¢å¼ºã€‚\u003c/li\u003e\n\u003cli\u003eå®ƒé¦–å…ˆä½¿ç”¨\u003cstrong\u003eåŸå§‹é¢„è®­ç»ƒæ¨¡å‹\u003c/strong\u003eè¯„ä¼°å½“å‰æµ‹è¯•æ•°æ®çš„\u003cstrong\u003eé¢„æµ‹ç½®ä¿¡åº¦\u003c/strong\u003eï¼Œä»¥æ­¤æ¥è¿‘ä¼¼åŸŸå·®å¼‚çš„å¤§å°ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ¡ä»¶æ€§åº”ç”¨\u003c/strong\u003eï¼š\n\u003cul\u003e\n\u003cli\u003eå¦‚æœç½®ä¿¡åº¦\u003cstrong\u003eé«˜\u003c/strong\u003eï¼ˆåŸŸå·®å¼‚å°ï¼‰ï¼Œåˆ™ç›´æ¥ä½¿ç”¨æ•™å¸ˆæ¨¡å‹çš„é¢„æµ‹ä½œä¸ºä¼ªæ ‡ç­¾ã€‚\u003c/li\u003e\n\u003cli\u003eå¦‚æœç½®ä¿¡åº¦\u003cstrong\u003eä½\u003c/strong\u003eï¼ˆåŸŸå·®å¼‚å¤§ï¼‰ï¼Œåˆ™å¯¹è¾“å…¥æ•°æ®è¿›è¡Œ N æ¬¡éšæœºå¢å¼ºï¼Œå¹¶å°†æ•™å¸ˆæ¨¡å‹å¯¹è¿™äº›å¢å¼ºæ ·æœ¬çš„å¹³å‡é¢„æµ‹ç»“æœä½œä¸ºä¼ªæ ‡ç­¾ã€‚è¿™å¯ä»¥è¿›ä¸€æ­¥æé«˜ä¼ªæ ‡ç­¾çš„é²æ£’æ€§ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"2-é¿å…ç¾éš¾æ€§é—å¿˜-avoiding-catastrophic-forgetting\"\u003e2. é¿å…ç¾éš¾æ€§é—å¿˜ (Avoiding Catastrophic Forgetting)\u003c/h3\u003e\n\u003cp\u003eä¸ºäº†åœ¨é•¿æœŸé€‚åº”è¿‡ç¨‹ä¸­ä¿ç•™ä»æºåŸŸå­¦åˆ°çš„çŸ¥è¯†ï¼ŒCoTTA å¼•å…¥äº†\u003cstrong\u003eéšæœºæ¢å¤ (Stochastic Restoration)\u003c/strong\u003e æœºåˆ¶ã€‚\u003c/p\u003e","title":"CoTTA"},{"content":"Introduction ç±»ä¼¼ GAN çš„å¯¹æŠ—è®­ç»ƒæ€æƒ³\nDomain Adaptation ç»™å®šæºåŸŸ $ D_{S} $ ï¼ˆæœ‰æ ‡ç­¾ï¼‰å’Œç›®æ ‡åŸŸ $ D_{T} $ ï¼ˆæ— æ ‡ç­¾ï¼‰ï¼Œç›®æ ‡æ˜¯è®­ç»ƒä¸€ä¸ªåˆ†ç±»å™¨ $ \\eta: X\\to Y $ ä½¿å…¶åœ¨ç›®æ ‡åŸŸä¸Šçš„ç›®æ ‡é£é™© $$ R_{D_{T}}(\\eta) = \\underset{(\\mathbf{x},y)\\sim D_{T}}{\\mathrm{Pr}}(\\eta(\\mathbf{x}) \\neq y) $$ æœ€å°\nDomain Divergence éœ€è¦é‡åŒ–ä¸¤ä¸ªé¢†åŸŸçš„â€œç›¸ä¼¼åº¦â€ï¼Œä»è€Œå¼•å‡ºäº† H- æ•£åº¦ çš„æ¦‚å¿µï¼š $$ d_{\\mathcal{H}}(D_S, D_T) = 2 \\sup_{\\eta \\in \\mathcal{H}} \\left| \\Pr_{x \\sim D_S}[\\eta(x) = 1] - \\Pr_{x \\sim D_T}[\\eta(x) = 1] \\right| $$ å«ä¹‰æ˜¯æœ€ä¼˜çš„åˆ†ç±»å™¨å°†ç›®æ ‡åŸŸå’ŒæºåŸŸåˆ¤å®šä¸º 1 çš„å¯èƒ½æ€§ä¹‹å·®ï¼Œå½“ H- æ•£åº¦éå¸¸å°æ—¶ï¼Œè¯´æ˜ä¸¤ä¸ªé¢†åŸŸå¾ˆéš¾è¢«åŒºåˆ†ï¼Œä¹Ÿå°±è¯´æ˜å­¦ä¹ çš„ç‰¹å¾å®ç°äº†é¢†åŸŸä¸å˜æ€§çš„æ•ˆæœ\nç”±äºç†è®º H æ•£åº¦æ˜¯ç†æƒ³æ•°æ®åˆ†å¸ƒä¸Šçš„å®šä¹‰ï¼Œå®é™…ä¸­åªæœ‰æœ‰é™çš„æ ·æœ¬é›† $ S $ å’Œ $ T $ ï¼Œå› æ­¤éœ€è¦ä¸€å®šçš„è¿‘ä¼¼ï¼Œäºæ˜¯éœ€è¦ç»éªŒ H- æ•£åº¦ $$ \\hat{d}_{\\mathcal{H}}(S, T) = 2 \\left(1 - \\min_{\\eta \\in \\mathcal{H}} \\left[ \\dfrac{1}{n}\\sum_{i=1}^n \\mathcal{I}[\\eta(x_i) = 0] + \\dfrac{1}{n'}\\sum_{i=n+1}^N \\mathcal{I}[\\eta(x_i) = 1] \\right] \\right) $$ å…¶ä¸­ $ \\mathcal{I}[\\cdot] $ è¡¨ç¤ºæ¡ä»¶ä¸ºçœŸæ—¶ä¸º 1ï¼Œå¦åˆ™ä¸º 0\nProxy Distance ç»éªŒ H- æ•£åº¦ä¹Ÿéœ€è¦ç›´æ¥éå†æ‰€æœ‰çš„ $ \\eta $ ï¼Œåœ¨è®¡ç®—ä¸Šä¸ç°å®ï¼Œéœ€è¦ä¸€ä¸ªè¿›ä¸€æ­¥çš„è¿‘ä¼¼æ–¹æ³•ï¼Œå› æ­¤è€ƒè™‘ Proxy A-distance (PAD)\næ„é€ ç”¨äºé¢†åŸŸåˆ†ç±»çš„æ•°æ®é›† $$ U = \\{ (\\mathbf{x}_{i},0) \\}_{i=1}^{n} \\cup \\{ (\\mathbf{x}_{i},1) \\}_{i=n+1}^{N} $$ ç”¨è¿™ä¸ªæ•°æ®é›†è®­ç»ƒåˆ†ç±»å™¨ï¼Œè®¾ $ \\epsilon $ ä¸ºåœ¨æ•°æ®é›† $ U $ ä¸Šè®­ç»ƒå‡ºçš„æœ€ä¼˜é¢†åŸŸåˆ†ç±»å™¨æ‰€è¾¾åˆ°çš„æœ€å°é”™è¯¯ç‡ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ $$ \\hat{d}_{\\mathcal{A}} = 2(1-2\\epsilon) $$ æ¥è¿‘ä¼¼ H- æ•£åº¦\nGeneralization Bound on the Target Risk æœ‰æ•ˆæ€§è¯æ˜\nç†è®ºç ”ç©¶è¯´æ˜æ¨¡å‹çš„ç›®æ ‡é£é™©å¯ä»¥é€šè¿‡æºé£é™©å’Œä¸¤ä¸ªé¢†åŸŸçš„æ•£åº¦æ¥é™åˆ¶ï¼Œä¸»è¦æ€æƒ³æ˜¯ $$ R_{D_T}(\\eta) \\le R_S(\\eta) + \\text{Domain Divergence Terms} + \\text{Complexity Terms} + \\beta $$ å…¶ä¸­ $ \\text{Domain Divergence Terms}\\approx d_{\\mathcal{H}}(S, T) $ ï¼Œå¯ä»¥ç”¨ä¸Šé¢çš„ $ \\hat{d}_{\\mathcal{A}} $ è¿‘ä¼¼ï¼›$ \\text{Complexity Terms} $ æ˜¯ä¸€ä¸ªæ¯”è¾ƒå°çš„å¸¸æ•°é¡¹ï¼Œå’Œæ¨¡å‹æœ¬èº«è®­ç»ƒæœ‰å…³ï¼ˆåŸå…¬å¼æ²¡çœ‹æ‡‚ã€‚ã€‚ï¼‰ï¼›$ \\beta $ æ˜¯ä¸€ä¸ªç†æƒ³åŒ–çš„é¡¹ï¼Œè¡¨ç¤ºæœ€å¥½æƒ…å†µä¸‹åœ¨ç›®æ ‡åŸŸå’ŒæºåŸŸä¸ŠåŒæ—¶å–å¾—çš„æœ€ä½é”™è¯¯ç‡\nDANN ä¼˜åŒ–ç›®æ ‡ï¼š $$ E(\\theta_f, \\theta_y, \\theta_d) = \\frac{1}{n} \\sum_{i=1}^n \\mathcal{L}_y(\\theta_f, \\theta_y) - \\lambda \\left( \\frac{1}{n} \\sum_{i=1}^n \\mathcal{L}_d(\\theta_f, \\theta_d) + \\frac{1}{n'} \\sum_{i=n+1}^N \\mathcal{L}_d(\\theta_f, \\theta_d) \\right) $$ æ ¸å¿ƒæ˜¯ Saddle Point Problem ï¼Œæ‰¾åˆ°éœ€è¦æ‰¾åˆ°éç‚¹è€Œéæœ€å°å€¼\nå¦‚ä½•å®ç°å¯¹æŠ—ï¼š\næ ‡ç­¾é¢„æµ‹å‚æ•°ï¼š $$ \\theta_{y} \\leftarrow \\theta_{y} - \\mu \\dfrac{ \\partial \\mathcal{L}_{y} }{ \\partial \\theta_{y} } $$ é¢†åŸŸåˆ†ç±»å‚æ•°ï¼š $$ \\theta_{d} \\leftarrow \\theta_{d} - \\mu \\lambda \\dfrac{ \\partial \\mathcal{L}_{d} }{ \\partial \\theta_{d} } $$ ç‰¹å¾æå–å‚æ•°ï¼š $$ \\theta_{f} \\leftarrow \\theta_{f} - \\mu\\left( \\dfrac{ \\partial \\mathcal{L}_{y} }{ \\partial \\theta_{f} } - \\lambda \\dfrac{ \\partial \\mathcal{L}_{d} }{ \\partial \\theta_{f} } \\right) $$ æ ¸å¿ƒéœ€è¦æœ€å¤§åŒ– $ \\mathcal{L}_{d} $ ï¼Œå› æ­¤éœ€è¦æ²¿ç€æ¢¯åº¦çš„æ­£å‘ä¼˜åŒ– Gradient Reversal Layer (GRL) æ˜¯å®ç°å¯¹æŠ—çš„æ ¸å¿ƒç»„ä»¶ï¼Œå…·ä½“åŸç†æ˜¯åœ¨å‰å‘ä¼ æ’­æ—¶è¡¨ç°ä¸º $ R(x)=x $ ï¼Œä½†æ˜¯åå‘ä¼ æ’­æ—¶ $ \\dfrac{\\mathrm{d} R}{\\mathrm{d}x}=-I $ ï¼Œè¿™æ ·å¯ä»¥ç›´æ¥åˆ©ç”¨å†…ç½®çš„è‡ªåŠ¨å¾®åˆ†ä¼˜é›…å®ç°å¯¹æŠ—\n","permalink":"https://diefish1024.github.io/posts/literature-notes/dann/","summary":"\u003ch2 id=\"introduction\"\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eç±»ä¼¼ GAN çš„å¯¹æŠ—è®­ç»ƒæ€æƒ³\u003c/p\u003e\n\u003ch2 id=\"domain-adaptation\"\u003eDomain Adaptation\u003c/h2\u003e\n\u003cp\u003eç»™å®šæºåŸŸ $ D_{S} $ ï¼ˆæœ‰æ ‡ç­¾ï¼‰å’Œç›®æ ‡åŸŸ $ D_{T} $ ï¼ˆæ— æ ‡ç­¾ï¼‰ï¼Œç›®æ ‡æ˜¯è®­ç»ƒä¸€ä¸ªåˆ†ç±»å™¨ $ \\eta: X\\to Y $ ä½¿å…¶åœ¨ç›®æ ‡åŸŸä¸Šçš„ç›®æ ‡é£é™©\n$$ \n\nR_{D_{T}}(\\eta) = \\underset{(\\mathbf{x},y)\\sim D_{T}}{\\mathrm{Pr}}(\\eta(\\mathbf{x}) \\neq y)\n\n $$\næœ€å°\u003c/p\u003e\n\u003ch4 id=\"domain-divergence\"\u003eDomain Divergence\u003c/h4\u003e\n\u003cp\u003eéœ€è¦é‡åŒ–ä¸¤ä¸ªé¢†åŸŸçš„â€œç›¸ä¼¼åº¦â€ï¼Œä»è€Œå¼•å‡ºäº† \u003cstrong\u003eH- æ•£åº¦\u003c/strong\u003e çš„æ¦‚å¿µï¼š\n$$ \n\nd_{\\mathcal{H}}(D_S, D_T) = 2 \\sup_{\\eta \\in \\mathcal{H}} \\left| \\Pr_{x \\sim D_S}[\\eta(x) = 1] - \\Pr_{x \\sim D_T}[\\eta(x) = 1] \\right|\n\n $$\nå«ä¹‰æ˜¯æœ€ä¼˜çš„åˆ†ç±»å™¨å°†ç›®æ ‡åŸŸå’ŒæºåŸŸåˆ¤å®šä¸º 1 çš„å¯èƒ½æ€§ä¹‹å·®ï¼Œå½“ H- æ•£åº¦éå¸¸å°æ—¶ï¼Œè¯´æ˜ä¸¤ä¸ªé¢†åŸŸå¾ˆéš¾è¢«åŒºåˆ†ï¼Œä¹Ÿå°±è¯´æ˜å­¦ä¹ çš„ç‰¹å¾å®ç°äº†é¢†åŸŸä¸å˜æ€§çš„æ•ˆæœ\u003c/p\u003e\n\u003cp\u003eç”±äºç†è®º H æ•£åº¦æ˜¯ç†æƒ³æ•°æ®åˆ†å¸ƒä¸Šçš„å®šä¹‰ï¼Œå®é™…ä¸­åªæœ‰æœ‰é™çš„æ ·æœ¬é›† $ S $ å’Œ $ T $ ï¼Œå› æ­¤éœ€è¦ä¸€å®šçš„è¿‘ä¼¼ï¼Œäºæ˜¯éœ€è¦ç»éªŒ H- æ•£åº¦\n$$ \n\n\\hat{d}_{\\mathcal{H}}(S, T) = 2 \\left(1 - \\min_{\\eta \\in \\mathcal{H}} \\left[ \\dfrac{1}{n}\\sum_{i=1}^n \\mathcal{I}[\\eta(x_i) = 0] + \\dfrac{1}{n'}\\sum_{i=n+1}^N \\mathcal{I}[\\eta(x_i) = 1] \\right] \\right)\n\n $$\nå…¶ä¸­ $ \\mathcal{I}[\\cdot] $ è¡¨ç¤ºæ¡ä»¶ä¸ºçœŸæ—¶ä¸º 1ï¼Œå¦åˆ™ä¸º 0\u003c/p\u003e","title":"DANN"},{"content":"A General Paradigm of Test-Time Adaptation æ ¹æ®æµ‹è¯•æ•°æ®æ¥æ”¶æ–¹å¼å’Œé€‚åº”è¿‡ç¨‹ï¼ŒTTA åˆ†ä¸ºä¸‰ç§ä¸»è¦èŒƒå¼ï¼š\nTest-Time Batch Adaptation (TTBA) æµ‹è¯•æ—¶é—´æ‰¹æ¬¡é€‚åº”ï¼š æ•°æ®ä»¥å°æ‰¹æ¬¡å½¢å¼åˆ°è¾¾ã€‚æ¨¡å‹ä¼šé’ˆå¯¹æ¯ä¸ªåˆ°æ¥çš„å°æ‰¹æ¬¡è¿›è¡Œé€‚åº”ï¼Œå¹¶ç«‹å³æä¾›é¢„æµ‹ã€‚ Online Test-Time Adaptation (OTTA) åœ¨çº¿æµ‹è¯•æ—¶é—´é€‚åº”ï¼š æ•°æ®ä»¥åºåˆ—åŒ–çš„æ–¹å¼ï¼ˆå°æ‰¹æ¬¡ï¼‰åˆ°è¾¾ã€‚æ¨¡å‹è¿›è¡Œå¢é‡æ›´æ–°ï¼Œå¹¶ä¸”è¿‡å»çš„é€‚åº”ç»éªŒä¼šå½±å“æœªæ¥çš„é¢„æµ‹ã€‚ Test-Time Domain Adaptation (TTDA) æµ‹è¯•æ—¶é—´åŸŸé€‚åº”ï¼š æ•´ä¸ªç›®æ ‡åŸŸçš„æ•°æ®ï¼ˆæ‰€æœ‰æµ‹è¯•æ•°æ®ï¼‰å¯åœ¨é¢„æµ‹å‰ä¸€æ¬¡æ€§ç”¨äºé€‚åº”ã€‚ Datasets for Evaluation è®ºæ–‡ä½¿ç”¨äº†ä¸¤ç§ä¸åŒç±»å‹çš„åˆ†å¸ƒåç§»æ•°æ®é›†è¿›è¡Œè¯„ä¼°ï¼š\nCorruption Datasets æŸåæ•°æ®é›†ï¼š åŸå§‹æ•°æ®é›†ï¼ˆCIFAR-10ï¼ŒImageNetï¼‰ç»è¿‡äººä¸ºæŸåå¤„ç†åå¾—åˆ°çš„ï¼Œé€šè¿‡æ·»åŠ ä¸åŒç±»å‹çš„å™ªå£°ã€æ¨¡ç³Šç­‰ï¼Œæ¨¡æ‹Ÿä¸åŒä¸¥é‡ç¨‹åº¦çš„åˆ†å¸ƒåç§»ã€‚ Natural-shift Datasets è‡ªç„¶åç§»æ•°æ®é›†ï¼š è¿™äº›æ•°æ®é›†ä»£è¡¨æ•°æ®åˆ†å¸ƒä¸­è‡ªç„¶å‘ç”Ÿçš„å˜åŒ–ï¼Œæ”¶é›†è‡ªä¸åŒçš„çœŸå®ä¸–ç•Œæ¥æºæˆ–æ¡ä»¶ï¼ˆOffice-Homeï¼ŒDomainNetï¼Œå…¶ä¸­å›¾åƒå¯èƒ½æ˜¯ä¸åŒé£æ ¼çš„è‰ºæœ¯ä½œå“ã€å‰ªè´´ç”»ã€çœŸå®ä¸–ç•Œç…§ç‰‡æˆ–è‰å›¾ï¼‰ã€‚ Results on Natural Shift Datasets TTA æ–¹æ³•åœ¨è‡ªç„¶åç§»æ•°æ®é›†ä¸Šçš„è¡¨ç°ä¸åœ¨æŸåæ•°æ®é›†ä¸Šçš„è¡¨ç°æœ‰æ‰€ä¸åŒã€‚ PredBN åœ¨æŸåæ•°æ®é›†ä¸Šæœ‰æ•ˆï¼Œä½†åœ¨è‡ªç„¶åç§»æ•°æ®é›†ä¸Šè¡¨ç°ä¸ä½³ï¼Œæœ‰æ—¶ç”šè‡³æ¯”æºæ¨¡å‹æ›´å·®ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºè‡ªç„¶åç§»å¯¹æ•°æ®åˆ†å¸ƒçš„å½±å“ä¸äººå·¥æŸåä¸åŒã€‚ T3A åœ¨ OTTA èŒƒå¼ä¸‹çš„è‡ªç„¶åç§»æ•°æ®é›†ä¸Šè¡¨ç°ä¼˜äºå…¶ä»– OTTA ç®—æ³•ã€‚è¿™å½’å› äºå…¶ç‰¹å¾ç”Ÿæˆæ–¹å¼åŠå…¶åˆ†ç±»å™¨ä¼˜åŒ–èƒ½åŠ›ã€‚ å¯¹äºè‡ªç„¶åç§»æ•°æ®é›†ï¼ŒTTDA ç®—æ³• æŒç»­å–å¾—äº†æœ€é«˜çš„æ€§èƒ½ã€‚ä¸€äº› OTTA æ–¹æ³•çš„å¤šè½®æ¬¡ä¹Ÿèƒ½è¾¾åˆ°å¯æ¯”çš„æˆæœã€‚ ","permalink":"https://diefish1024.github.io/posts/literature-notes/benchmarking-tta/","summary":"\u003ch3 id=\"a-general-paradigm-of-test-time-adaptation\"\u003eA General Paradigm of Test-Time Adaptation\u003c/h3\u003e\n\u003cp\u003eæ ¹æ®æµ‹è¯•æ•°æ®æ¥æ”¶æ–¹å¼å’Œé€‚åº”è¿‡ç¨‹ï¼ŒTTA åˆ†ä¸ºä¸‰ç§ä¸»è¦èŒƒå¼ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eTest-Time Batch Adaptation (TTBA) æµ‹è¯•æ—¶é—´æ‰¹æ¬¡é€‚åº”ï¼š\u003c/strong\u003e æ•°æ®ä»¥å°æ‰¹æ¬¡å½¢å¼åˆ°è¾¾ã€‚æ¨¡å‹ä¼šé’ˆå¯¹æ¯ä¸ªåˆ°æ¥çš„å°æ‰¹æ¬¡è¿›è¡Œé€‚åº”ï¼Œå¹¶ç«‹å³æä¾›é¢„æµ‹ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eOnline Test-Time Adaptation (OTTA) åœ¨çº¿æµ‹è¯•æ—¶é—´é€‚åº”ï¼š\u003c/strong\u003e æ•°æ®ä»¥åºåˆ—åŒ–çš„æ–¹å¼ï¼ˆå°æ‰¹æ¬¡ï¼‰åˆ°è¾¾ã€‚æ¨¡å‹è¿›è¡Œå¢é‡æ›´æ–°ï¼Œå¹¶ä¸”è¿‡å»çš„é€‚åº”ç»éªŒä¼šå½±å“æœªæ¥çš„é¢„æµ‹ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eTest-Time Domain Adaptation (TTDA) æµ‹è¯•æ—¶é—´åŸŸé€‚åº”ï¼š\u003c/strong\u003e æ•´ä¸ªç›®æ ‡åŸŸçš„æ•°æ®ï¼ˆæ‰€æœ‰æµ‹è¯•æ•°æ®ï¼‰å¯åœ¨é¢„æµ‹å‰ä¸€æ¬¡æ€§ç”¨äºé€‚åº”ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"datasets-for-evaluation\"\u003eDatasets for Evaluation\u003c/h3\u003e\n\u003cp\u003eè®ºæ–‡ä½¿ç”¨äº†ä¸¤ç§ä¸åŒç±»å‹çš„åˆ†å¸ƒåç§»æ•°æ®é›†è¿›è¡Œè¯„ä¼°ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eCorruption Datasets æŸåæ•°æ®é›†ï¼š\u003c/strong\u003e åŸå§‹æ•°æ®é›†ï¼ˆCIFAR-10ï¼ŒImageNetï¼‰ç»è¿‡\u003cstrong\u003eäººä¸ºæŸåå¤„ç†\u003c/strong\u003eåå¾—åˆ°çš„ï¼Œé€šè¿‡æ·»åŠ ä¸åŒç±»å‹çš„å™ªå£°ã€æ¨¡ç³Šç­‰ï¼Œæ¨¡æ‹Ÿä¸åŒä¸¥é‡ç¨‹åº¦çš„åˆ†å¸ƒåç§»ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eNatural-shift Datasets è‡ªç„¶åç§»æ•°æ®é›†ï¼š\u003c/strong\u003e è¿™äº›æ•°æ®é›†ä»£è¡¨æ•°æ®åˆ†å¸ƒä¸­\u003cstrong\u003eè‡ªç„¶å‘ç”Ÿçš„å˜åŒ–\u003c/strong\u003eï¼Œæ”¶é›†è‡ªä¸åŒçš„çœŸå®ä¸–ç•Œæ¥æºæˆ–æ¡ä»¶ï¼ˆOffice-Homeï¼ŒDomainNetï¼Œå…¶ä¸­å›¾åƒå¯èƒ½æ˜¯ä¸åŒé£æ ¼çš„è‰ºæœ¯ä½œå“ã€å‰ªè´´ç”»ã€çœŸå®ä¸–ç•Œç…§ç‰‡æˆ–è‰å›¾ï¼‰ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"results-on-natural-shift-datasets\"\u003eResults on Natural Shift Datasets\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eTTA æ–¹æ³•åœ¨è‡ªç„¶åç§»æ•°æ®é›†ä¸Šçš„è¡¨ç°ä¸åœ¨æŸåæ•°æ®é›†ä¸Šçš„è¡¨ç°æœ‰æ‰€ä¸åŒã€‚\u003c/li\u003e\n\u003cli\u003ePredBN åœ¨æŸåæ•°æ®é›†ä¸Šæœ‰æ•ˆï¼Œä½†åœ¨è‡ªç„¶åç§»æ•°æ®é›†ä¸Šè¡¨ç°ä¸ä½³ï¼Œæœ‰æ—¶ç”šè‡³æ¯”æºæ¨¡å‹æ›´å·®ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºè‡ªç„¶åç§»å¯¹æ•°æ®åˆ†å¸ƒçš„å½±å“ä¸äººå·¥æŸåä¸åŒã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eT3A\u003c/strong\u003e åœ¨ OTTA èŒƒå¼ä¸‹çš„è‡ªç„¶åç§»æ•°æ®é›†ä¸Šè¡¨ç°ä¼˜äºå…¶ä»– OTTA ç®—æ³•ã€‚è¿™å½’å› äºå…¶ç‰¹å¾ç”Ÿæˆæ–¹å¼åŠå…¶åˆ†ç±»å™¨ä¼˜åŒ–èƒ½åŠ›ã€‚\u003c/li\u003e\n\u003cli\u003eå¯¹äºè‡ªç„¶åç§»æ•°æ®é›†ï¼Œ\u003cstrong\u003eTTDA ç®—æ³•\u003c/strong\u003e æŒç»­å–å¾—äº†æœ€é«˜çš„æ€§èƒ½ã€‚ä¸€äº› OTTA æ–¹æ³•çš„å¤šè½®æ¬¡ä¹Ÿèƒ½è¾¾åˆ°å¯æ¯”çš„æˆæœã€‚\u003c/li\u003e\n\u003c/ul\u003e","title":"Benchmarking TTA"},{"content":"ä¿¡å·é‡ äº’æ–¥é”åœ¨æŸç§æ„ä¹‰ä¸Šä¹Ÿå¯ä»¥è®¤ä¸ºå®ç°äº† \u0026ldquo;happens-before\u0026rdquo; çš„ä¾èµ–å…³ç³»â€”â€” release å¿…ç„¶å‘ç”Ÿåœ¨ acquire ä¹‹å‰ã€‚æˆ‘ä»¬å¯ä»¥è¯•ç€åˆ©ç”¨è¿™ç§ä¾èµ–å…³ç³»æ¥å®ç°è®¡ç®—å›¾çš„è°ƒåº¦ï¼šä¸ºæ¯æ¡è¾¹åˆ†é…ä¸€ä¸ªäº’æ–¥é”ï¼Œä»£è¡¨æ•°æ®æˆ–å‰ç½®ä»»åŠ¡çš„å®Œæˆï¼›ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»è·å¾—æ‰€æœ‰å…¥è¾¹å¯¹åº”çš„äº’æ–¥é”æ‰èƒ½å¼€å§‹è®¡ç®—ï¼Œè®¡ç®—å®Œæˆåï¼Œå°±é‡Šæ”¾æ‰€æœ‰å‡ºè¾¹å¯¹åº”çš„äº’æ–¥é”ï¼Œé€šçŸ¥ä¸‹æ¸¸èŠ‚ç‚¹è¾“å‡ºå°±ç»ªï¼ˆä½†æ˜¯è¿™ç§ç›´æ¥ä½¿ç”¨äº’æ–¥é”ä½œä¸ºè¾¹çŠ¶æ€ä¿¡å·çš„æ–¹å¼æ˜¯ undefined behaviorï¼Œå› ä¸ºäº’æ–¥é”ä¸»è¦ç”¨äºä¿æŠ¤ä¸´ç•ŒåŒºï¼Œå…¶é‡Šæ”¾é€šå¸¸è¦æ±‚ç”±æŒæœ‰å®ƒçš„çº¿ç¨‹å®Œæˆï¼Œè‹¥é‡Šæ”¾æœªæ›¾è·å–çš„é”ï¼Œåˆ™è¡Œä¸ºæœªå®šä¹‰ï¼‰\næˆ‘ä»¬å¯ä»¥ä»è¿™ç§æƒ³æ³•ä¸­æŠ½è±¡å‡ºå…¶æœ¬è´¨ï¼Œä¹Ÿå°±æ˜¯ç”¨ä¸€ä¸ªâ€œä¿¡å·â€å»è·å–èµ„æºçš„è®¸å¯ï¼Œç±»ä¼¼é¤å…çš„å–å·åƒé¥­\nè¿™ç§ä¿¡å·çš„æ€æƒ³å¾ˆé€‚åˆç”¨æ¥ç®¡ç†è®¡æ•°ç±»å‹çš„åŒç±»èµ„æºï¼Œæ¯”å¦‚åœè½¦åœºçš„ç©ºä½ï¼Œä¸ºäº†å®ç°è¿™ç§ producer-customer çš„é—®é¢˜ï¼Œç”¨ æ¡ä»¶å˜é‡ å¯ä»¥è½»æ˜“è§£å†³ï¼Œè¿›å…¥çš„æ¡ä»¶å°±æ˜¯å­˜åœ¨ç©ºä½ count \u0026lt; capacity ï¼Œé‚£æˆ‘ä»¬ä»å‡å°‘å˜é‡çš„è§’åº¦å‡ºå‘ï¼Œè¿™å®é™…ä¸Šä¹Ÿå°±æ˜¯å‰©ä½™ç©ºä½çš„æ•°é‡å¤§äºé›¶ï¼Œæˆ‘ä»¬åœè½¦ç›¸å½“äºæ¶ˆè€—äº†ä¸€ä¸ªè½¦ä½ï¼Œç¦»å¼€ç›¸å½“äºåˆ›é€ äº†ä¸€ä¸ªè½¦ä½ï¼Œè¿™ä¹Ÿå°±å¾—åˆ°äº†æ‰€è°“â€œä¿¡å·é‡â€çš„æœºåˆ¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 void P(sem_t *sem) { // Prolaag - try + decrease/down/wait/acquire mutex_lock(\u0026amp;sem-\u0026gt;lk); while (!(sem-\u0026gt;count \u0026gt; 0)) { cond_wait(\u0026amp;sem-\u0026gt;cv, \u0026amp;sem-\u0026gt;lk); } sem-\u0026gt;count--; // æ¶ˆè€—ä¸€ä¸ªä¿¡å· (è½¦ä½) mutex_unlock(\u0026amp;sem-\u0026gt;lk); } void V(sem_t *sem) { // Verhoog - increase/up/post/signal/release mutex_lock(\u0026amp;sem-\u0026gt;lk); sem-\u0026gt;count++; // åˆ›å»ºä¸€ä¸ªä¿¡å· (è½¦ä½) cond_broadcast(\u0026amp;sem-\u0026gt;cv); mutex_unlock(\u0026amp;sem-\u0026gt;lk); } æ ¹æ®è¿™ä¸ªä¸€è·¯æ¨å‡ºä¿¡å·é‡çš„æ€è·¯ï¼Œæˆ–è®¸å¯ä»¥è®¤ä¸ºè¿™æ˜¯äº’æ–¥é”çš„æ‰©å±•\nä¿¡å·é‡ï¼šåº”ç”¨ ä¿¡å·é‡æœ‰ä¸¤ç§å…¸å‹çš„åº”ç”¨ï¼š\nå®ç°ä¸€ä¸ªä¸´æ—¶çš„ happens-beforeï¼š$ A\\to V(s)\\to P(s)\\to B $ ç®¡ç†è®¡æ•°èµ„æºï¼šåœè½¦åœºã€é¤å…â€¦â€¦ å¯ä»¥åˆ©ç”¨ä¿¡å·é‡ä¼˜é›…åœ°å®ç° producer-customer çš„æ¨¡å‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 sem_t empty = SEM_INIT(depth); sem_t fill = SEM_INIT(0); void T_produce() { P(\u0026amp;empty); printf(\u0026#34;(\u0026#34;); V(\u0026amp;fill); } void T_consume() { P(\u0026amp;fill); printf(\u0026#34;)\u0026#34;); V(\u0026amp;empty); } ä¿¡å·é‡ã€æ¡ä»¶å˜é‡ä¸åŒæ­¥ ä¿¡å·é‡å¯¹æ¯”æ¡ä»¶å˜é‡ï¼š\nä¿¡å·é‡ï¼šæ›´åŠ å¹²å‡€ä¼˜é›…ï¼Œä½†æ˜¯ä¸ä¸€å®šèƒ½å¾ˆå¥½åœ°è¡¨ç¤ºåŒæ­¥æ¡ä»¶ï¼ˆç”¨æ›´ hack çš„æ–¹å¼è§£å†³é—®é¢˜ï¼‰ æ¡ä»¶å˜é‡ï¼šæ›´åŠ ä¸‡èƒ½ï¼Œä½†æ˜¯ä»£ç æ¯”è¾ƒä¸‘é™‹ï¼ˆç”¨æ›´æ ‡å‡†åŒ–çš„æ–¹å¼è§£å†³é—®é¢˜ï¼‰ å°è¯•ç”¨ä¿¡å·é‡è§£å†³æ›´å¤æ‚çš„åŒæ­¥é—®é¢˜ï¼šå“²å­¦å®¶åƒé¥­ï¼Œä¸€å¼ åœ†æ¡Œå›´å $ n $ ä¸ªå“²å­¦å®¶ï¼Œæ¯ä¸¤ä¸ªäººä¹‹é—´æœ‰ä¸€æŠŠå‰å­ï¼ˆç­·å­æ›´åŠ åˆé€‚ï¼Ÿï¼Ÿï¼‰ï¼Œæ¯ä¸ªå“²å­¦å®¶ï¼ˆçº¿ç¨‹ï¼‰æœ‰æ—¶æ€è€ƒæœ‰æ—¶åƒé¥­ï¼Œæ€è€ƒæ—¶ä»€ä¹ˆä¹Ÿä¸ç”¨åšï¼Œåƒé¥­æ—¶åŒæ—¶éœ€è¦å·¦æ‰‹å³æ‰‹çš„å‰å­\nç”¨æ¡ä»¶å˜é‡è§£å†³è¿™ä¸ªé—®é¢˜åªéœ€è¦æ— è„‘è®¾ç½®åŒæ­¥æ¡ä»¶å³å¯ï¼Œç”¨ä¿¡å·é‡è§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸€ä¸ªåˆæ­¥çš„æƒ³æ³•æ˜¯ P(\u0026amp;sem[lhs]) \u0026amp;\u0026amp; P(\u0026amp;sem[rhs]) ï¼Œä¹ä¸€çœ‹æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™ä¸ªæ¡ä»¶åœ¨æ‰€æœ‰äººéƒ½åŒæ—¶ä¸¾èµ·äº†åŒä¸€è¾¹çš„å‰å­æ—¶ä¼šé™·å…¥æ­»é”ï¼ˆæ‰€ä»¥å¹¶å‘ç¼–ç¨‹ä¸€å®šè¦ä»”ç»†å†ä»”ç»†ï¼ï¼‰ï¼Œæ‰€ä»¥ä¸ºäº†æ’é™¤è¿™ç§æ–¹æ¡ˆï¼Œæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š\nä»æ¡Œå­èµ¶èµ°ä¸€ä¸ªäººï¼šä¸ºä¸Šæ¡Œåƒé¥­äººæ•°è®¾ç½®ä¸€ä¸ªä¿¡å·é‡ï¼Œé™åˆ¶ä¸è®©æ‰€æœ‰äººåŒæ—¶ä¸Šæ¡Œå³å¯ï¼ˆæ˜¾ç„¶ä¸å¯èƒ½æ‰€æœ‰äººåŒæ—¶åƒä¸Šé¥­ï¼‰ ä¸ºå‰å­ç¼–å·ï¼Œæ€»æ˜¯å…ˆæ‹¿èµ·ç¼–å·å°çš„ä¸€æŠŠï¼ˆæœ€åä¸€ä¸ªäººçš„é¡ºåºä¼šå’Œå…¶ä»–äººåè¿‡æ¥ï¼‰ ä½†æ˜¯è¿™æ ·çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¸å¤Ÿä¼˜é›…ä¸å¤Ÿé€šç”¨çš„ï¼Œå› æ­¤æ›´å¤šæ—¶å€™æ¡ä»¶å˜é‡æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼Œå¯ä»¥æ€»ç»“ä¸ºä¿¡å·é‡åœ¨é€‚åˆçš„é€‚åˆå¾ˆå¥½ç”¨ï¼Œä½†ä¸æ€»æ˜¯å¾ˆå¥½ç”¨\n","permalink":"https://diefish1024.github.io/posts/class-notes/nju-os-2025/16-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E5%90%8C%E6%AD%A5%E4%BF%A1%E5%8F%B7%E9%87%8F/","summary":"\u003ch2 id=\"ä¿¡å·é‡\"\u003eä¿¡å·é‡\u003c/h2\u003e\n\u003cp\u003eäº’æ–¥é”åœ¨æŸç§æ„ä¹‰ä¸Šä¹Ÿå¯ä»¥è®¤ä¸ºå®ç°äº† \u0026ldquo;happens-before\u0026rdquo; çš„ä¾èµ–å…³ç³»â€”â€” release å¿…ç„¶å‘ç”Ÿåœ¨ acquire ä¹‹å‰ã€‚æˆ‘ä»¬å¯ä»¥è¯•ç€åˆ©ç”¨è¿™ç§ä¾èµ–å…³ç³»æ¥å®ç°è®¡ç®—å›¾çš„è°ƒåº¦ï¼šä¸ºæ¯æ¡è¾¹åˆ†é…ä¸€ä¸ªäº’æ–¥é”ï¼Œä»£è¡¨æ•°æ®æˆ–å‰ç½®ä»»åŠ¡çš„å®Œæˆï¼›ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»è·å¾—æ‰€æœ‰å…¥è¾¹å¯¹åº”çš„äº’æ–¥é”æ‰èƒ½å¼€å§‹è®¡ç®—ï¼Œè®¡ç®—å®Œæˆåï¼Œå°±é‡Šæ”¾æ‰€æœ‰å‡ºè¾¹å¯¹åº”çš„äº’æ–¥é”ï¼Œé€šçŸ¥ä¸‹æ¸¸èŠ‚ç‚¹è¾“å‡ºå°±ç»ªï¼ˆä½†æ˜¯è¿™ç§ç›´æ¥ä½¿ç”¨äº’æ–¥é”ä½œä¸ºè¾¹çŠ¶æ€ä¿¡å·çš„æ–¹å¼æ˜¯ undefined behaviorï¼Œå› ä¸ºäº’æ–¥é”ä¸»è¦ç”¨äºä¿æŠ¤ä¸´ç•ŒåŒºï¼Œå…¶é‡Šæ”¾é€šå¸¸è¦æ±‚ç”±æŒæœ‰å®ƒçš„çº¿ç¨‹å®Œæˆï¼Œè‹¥é‡Šæ”¾æœªæ›¾è·å–çš„é”ï¼Œåˆ™è¡Œä¸ºæœªå®šä¹‰ï¼‰\u003c/p\u003e\n\u003cp\u003eæˆ‘ä»¬å¯ä»¥ä»è¿™ç§æƒ³æ³•ä¸­æŠ½è±¡å‡ºå…¶æœ¬è´¨ï¼Œä¹Ÿå°±æ˜¯ç”¨ä¸€ä¸ªâ€œ\u003cstrong\u003eä¿¡å·\u003c/strong\u003eâ€å»è·å–èµ„æºçš„è®¸å¯ï¼Œç±»ä¼¼é¤å…çš„å–å·åƒé¥­\u003c/p\u003e\n\u003cp\u003eè¿™ç§\u003cstrong\u003eä¿¡å·\u003c/strong\u003eçš„æ€æƒ³å¾ˆé€‚åˆç”¨æ¥ç®¡ç†\u003cstrong\u003eè®¡æ•°ç±»å‹çš„åŒç±»èµ„æº\u003c/strong\u003eï¼Œæ¯”å¦‚åœè½¦åœºçš„ç©ºä½ï¼Œä¸ºäº†å®ç°è¿™ç§ producer-customer çš„é—®é¢˜ï¼Œç”¨ \u003ca href=\"15.%20%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%EF%BC%9A%E5%90%8C%E6%AD%A5%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F.md\"\u003eæ¡ä»¶å˜é‡\u003c/a\u003e å¯ä»¥è½»æ˜“è§£å†³ï¼Œè¿›å…¥çš„æ¡ä»¶å°±æ˜¯å­˜åœ¨ç©ºä½ \u003ccode\u003ecount \u0026lt; capacity\u003c/code\u003e ï¼Œé‚£æˆ‘ä»¬ä»å‡å°‘å˜é‡çš„è§’åº¦å‡ºå‘ï¼Œè¿™å®é™…ä¸Šä¹Ÿå°±æ˜¯å‰©ä½™ç©ºä½çš„æ•°é‡å¤§äºé›¶ï¼Œæˆ‘ä»¬åœè½¦ç›¸å½“äº\u003cstrong\u003eæ¶ˆè€—\u003c/strong\u003eäº†ä¸€ä¸ªè½¦ä½ï¼Œç¦»å¼€ç›¸å½“äº\u003cstrong\u003eåˆ›é€ \u003c/strong\u003eäº†ä¸€ä¸ªè½¦ä½ï¼Œè¿™ä¹Ÿå°±å¾—åˆ°äº†æ‰€è°“â€œ\u003cstrong\u003eä¿¡å·é‡\u003c/strong\u003eâ€çš„æœºåˆ¶\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eP\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003esem_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// Prolaag - try + decrease/down/wait/acquire\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003emutex_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nf\"\u003econd_wait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// æ¶ˆè€—ä¸€ä¸ªä¿¡å· (è½¦ä½)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003emutex_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eV\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003esem_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// Verhoog - increase/up/post/signal/release\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003emutex_lock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// åˆ›å»ºä¸€ä¸ªä¿¡å· (è½¦ä½)\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e\u003c/span\u003e    \u003cspan class=\"nf\"\u003econd_broadcast\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nf\"\u003emutex_unlock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esem\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eæ ¹æ®è¿™ä¸ªä¸€è·¯æ¨å‡ºä¿¡å·é‡çš„æ€è·¯ï¼Œæˆ–è®¸å¯ä»¥è®¤ä¸ºè¿™æ˜¯äº’æ–¥é”çš„æ‰©å±•\u003c/p\u003e","title":"16. å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥ä¿¡å·é‡"},{"content":"åŒæ­¥å’Œæ¡ä»¶å˜é‡ äº’æ–¥å®ç°äº†åŸå­æ€§ï¼Œä½†æ˜¯æ— æ³•å®ç°ç¡®å®šæ€§ï¼Œä¹Ÿå°±æ˜¯æ— æ³•æ­£ç¡®å®ç° \u0026ldquo;happens-before\u0026rdquo; çš„å…³ç³»\nå› æ­¤éœ€è¦å¼•å…¥æ¡ä»¶å˜é‡æ¥å®ç°çº¿ç¨‹çš„åŒæ­¥ï¼Œå½¢æˆå—æ§åˆ¶çš„å¹¶å‘äº‹ä»¶çš„å‘ç”Ÿé¡ºåºï¼ˆå¯ä»¥ç”¨ä¹å›¢æŒ‡æŒ¥æ¥ç±»æ¯”ï¼‰ï¼ŒæŠŠä¸€ç³»åˆ—ä¸ç¡®å®šçš„çŠ¶æ€åœ¨æŸä¸€ä¸ªæ—¶é—´ç‚¹åŒæ­¥åˆ°äº†ä¸€ä¸ªç¡®å®šçš„çŠ¶æ€ï¼Œå°†å‘æ•£çš„å¹¶å‘ç¨‹åºçŠ¶æ€ â€œæ”¶æŸâ€\nå®ç°åŒæ­¥\nå®ç° $ A\\to B $ï¼š\n1 2 3 4 5 6 7 A; can_proceed = true; (signal) while(!can_proceed); B // B: wait until the condition is satisfied è¿™æ ·çš„æ€è·¯å¤§è‡´æ­£ç¡®ï¼Œä½†æ˜¯è‡ªé€‰çš„å¾ªç¯æœ‰å¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªæ›´åŠ åº•å±‚çš„æœºåˆ¶æ¥å¸®åŠ©å®ç°è¿™ä¸€ç‚¹\næœ€ç†æƒ³çš„ API æ˜¯ wait_until(cond) ï¼Œä½†æ˜¯è¿‡å»ä¸ºäº†ç®€åŒ–è®¾è®¡ï¼Œå˜æˆäº†\næ¡ä»¶ä¸æ»¡è¶³æ—¶ç­‰å¾…ï¼šwait - ç›´æ¥ç¡çœ ç­‰å¾… æ¡ä»¶æ»¡è¶³æ—¶ç»§ç»­ï¼šsignal/broadcast - å”¤é†’æ‰€æœ‰çº¿ç¨‹ ï¼ˆå°æ—¶å€™çš„ scratch ç¼–ç¨‹å…¶å®å·²ç»æœ‰äº†è¿™æ ·çš„æ€æƒ³ğŸ˜‚ï¼‰\nåœ¨ c++ ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥æŠŠæ¡ä»¶æ”¾åˆ° $ \\lambda $ è¡¨è¾¾å¼ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 std::mutex mtx; std::condition_variable cv; void T_player() { std::unique_lock lk(mtx); cv.wait(lk, []{ return can_proceed; } ); cv.notify_all(); lk.unlock(); } æ³¨æ„æ¡ä»¶å˜é‡åœ¨ç­‰å¾…æ—¶éœ€è¦å¸¦ç€ä¸€æŠŠé”ï¼ˆéœ€è¦ç¡®ä¿æ£€æŸ¥å’Œç­‰å¾…æ˜¯åŸå­æ“ä½œï¼‰\nä½¿ç”¨æ¡ä»¶å˜é‡è§£å†³åŒæ­¥é—®é¢˜ å¤§éƒ¨åˆ†çš„åŒæ­¥é—®é¢˜éƒ½å¯ä»¥ç”¨ç»å…¸çš„ç”Ÿäº§è€… - æ¶ˆè´¹è€…é—®é¢˜å½’çº³ï¼š\nProducer å’Œ Consumer å…±äº«ä¸€ä¸ªç¼“å†²åŒºï¼Œå…¶ä¸­\nProducer çœ‹åˆ°ç¼“å†²åŒºæœ‰ç©ºä½å°±ä¼šæ”¾å…¥ï¼Œå¦åˆ™ç­‰å¾… Consumer çœ‹åˆ°ç¼“å†²åŒºæœ‰æ•°æ®å°±å›å»èµ°ï¼Œå¦åˆ™ç­‰å¾… æ˜¾ç„¶ä¸€ä¸ªå¯¹è±¡çš„ç”Ÿäº§å’Œæ¶ˆè´¹å¿…é¡»æ»¡è¶³ \u0026ldquo;happens-before\u0026rdquo; çš„å…³ç³»\nå¯ä»¥ç­‰ä»·æˆæ‰“å°åŒ¹é…çš„æ‹¬å·ï¼Œå¹¶ä¸”åµŒå¥—æ·±åº¦æœ‰ä¸Šé™ï¼ˆç¼“å†²åŒºçš„æ·±åº¦ï¼‰\nå¤„ç†è¿™æ ·çš„é—®é¢˜é¦–å…ˆè¦æƒ³æ¸…æ¥šç¨‹åºç»§ç»­æ‰§è¡Œçš„æ¡ä»¶ï¼Œæ¯”å¦‚ç”Ÿäº§çš„æ¡ä»¶æ˜¯ $ d\u003c n $ ï¼Œè€Œæ¶ˆè´¹çš„æ¡ä»¶æ˜¯ $ d\u003e0 $ ï¼Œç„¶åå¥—å…¥å›ºå®šçš„æ¨¡æ¿ä»£ç å³å¯ï¼š\n1 2 3 4 5 6 mutex_lock(lk); while (!cond) { // cond can be any calculate cond_wait(\u0026amp;cv, lk); } assert(cond); mutex_lock(lk); 1 2 3 4 mutex_lock(lk); cond = true cond_broadcast(\u0026amp;cv); //âš ï¸ mutex_unlock(lk); æ³¨æ„ï¼šå…¨å±€å¹¿æ’­ cond_broadcast ä¸èƒ½è¢«æ›¿æ¢æˆå•ç‹¬å”¤é†’ä¸€ä¸ªçº¿ç¨‹ cond_signal ï¼Œåœ¨è¿™é‡Œæ˜¾ç„¶å¯èƒ½ä¼šå¯¼è‡´æ‰€æœ‰è¿›ç¨‹éƒ½è¢«é”ä½æ— æ³•è§¦å‘æ–°çš„åŒæ­¥å˜é‡ï¼›å¹¶å‘ç¼–ç¨‹å¾ˆå¤šçœ‹èµ·æ¥æ­£ç¡®çš„åœ°æ–¹éƒ½éœ€è¦ä»”ç»†æ€è€ƒ\né‡åˆ°ä»»ä½•åŒæ­¥é—®é¢˜çš„æ ¸å¿ƒéƒ½æ˜¯åŒæ­¥æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Œæ¯”å¦‚æ‹¬å·æ‰“å°å¯ä»¥æ‹“å±•æˆæ‰“å° \u0026lt;\u0026gt;\u0026lt; æˆ–è€… \u0026gt;\u0026lt;\u0026gt; ä¸¤ç§å½¢çŠ¶ï¼Œæ ¸å¿ƒä¹Ÿæ˜¯ç”»å‡ºçŠ¶æ€æœºï¼Œæ‰¾åˆ°åŒæ­¥æ¡ä»¶ï¼Œå†å¥—å…¥æ¨¡æ¿å°±è§£å†³äº†é—®é¢˜\nè®¡ç®—å›¾ä¸å¹¶å‘æ§åˆ¶ å¹¶è¡Œè®¡ç®—çš„æ¨¡å‹å¯ä»¥ç”¨ä¸€ä¸ª DAG è®¡ç®—å›¾å»ç†è§£ï¼Œä»»åŠ¡ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œé€šè¿‡æ‹“æ‰‘æ’åºçš„é¡ºåºå»è§£å†³é—®é¢˜ï¼Œç›¸äº’ä¸å­˜åœ¨ \u0026ldquo;happens-before\u0026rdquo; ä¾èµ–å…³ç³»çš„ä»»åŠ¡éƒ½å¯ä»¥å¹¶å‘è§£å†³\nä¸ºäº†ä¼˜åŒ–æ•ˆç‡ï¼Œæˆ‘ä»¬å¯¹è®¡ç®—ä»»åŠ¡çš„åˆ†é…éœ€è¦ä¿è¯æ¯ä¸ªèŠ‚ç‚¹è®¡ç®—çš„æ¶ˆè€—æ˜¯è¿œå¤§äºåŒæ­¥å’Œé”çš„å¼€é”€çš„ï¼Œå› æ­¤å®é™…ä¸Šå¯èƒ½æ˜¯æŠŠå¾ˆå¤šä¸ªå°çš„ä»»åŠ¡èšåˆæˆä¸€ä¸ªå¤§çš„å¹¶å‘è®¡ç®—èŠ‚ç‚¹ï¼Œäº¤ç»™ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œ\nå®ç°è®¡ç®—å›¾æœ‰ä¸¤ç§æ€è·¯ï¼Œç¬¬ä¸€ç§æ˜¯æœ´ç´ çš„ä¸ºæ¯ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸€ä¸ªçº¿ç¨‹å’Œæ¡ä»¶å˜é‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // The dependency edge is u-\u0026gt;v void T_u() { // calculate u mutex_lock(v-\u0026gt;lock); v-\u0026gt;num_done++; cond_signal(v-\u0026gt;cv); // it\u0026#39;s okay mutex_unlock(v-\u0026gt;lock); } void T_v() { mutex_lock(v-\u0026gt;lock); while (!(v-\u0026gt;num_done == v-\u0026gt;num_predecessors)){ cond_wait(v-\u0026gt;cv, v-\u0026gt;lock); } mutex_unlock(v-\u0026gt;lock); // calculate v } ä½†æ˜¯è¿™æ ·å®é™…ä¼šäº§ç”Ÿè¿‡å¤šçš„çº¿ç¨‹ï¼Œé€ æˆä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ï¼ˆæ¯”å¦‚äº§ç”Ÿäº†å¤šä½™ CPU çš„ core æ•°é‡çš„çº¿ç¨‹ï¼‰ï¼Œå®é™…ä¸Šæ›´ä¼˜çš„åŠæ³•æ˜¯åˆ›å»ºä¸€ä¸ªä»»åŠ¡è°ƒåº¦å™¨çº¿ç¨‹ $ T_{\\text{scheduler}} $ æ¥ä¸“é—¨æ§åˆ¶äº§ç”Ÿ $ T_{\\text{worker}} $ ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 mutex_lock(lk); while (!(all_done || has_job(tid))) { cond_wait(\u0026amp;worker_cv[tid], lk); } mutex_unlock(lk); if (all_done) { break; } else { process_job(tid); } signal(\u0026amp;sched_cv); ","permalink":"https://diefish1024.github.io/posts/class-notes/nju-os-2025/15-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E5%90%8C%E6%AD%A5%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/","summary":"\u003ch2 id=\"åŒæ­¥å’Œæ¡ä»¶å˜é‡\"\u003eåŒæ­¥å’Œæ¡ä»¶å˜é‡\u003c/h2\u003e\n\u003cp\u003eäº’æ–¥å®ç°äº†\u003cstrong\u003eåŸå­æ€§\u003c/strong\u003eï¼Œä½†æ˜¯æ— æ³•å®ç°\u003cstrong\u003eç¡®å®šæ€§\u003c/strong\u003eï¼Œä¹Ÿå°±æ˜¯æ— æ³•æ­£ç¡®å®ç° \u0026ldquo;happens-before\u0026rdquo; çš„å…³ç³»\u003c/p\u003e\n\u003cp\u003eå› æ­¤éœ€è¦å¼•å…¥æ¡ä»¶å˜é‡æ¥å®ç°çº¿ç¨‹çš„åŒæ­¥ï¼Œå½¢æˆå—æ§åˆ¶çš„å¹¶å‘äº‹ä»¶çš„\u003cstrong\u003eå‘ç”Ÿé¡ºåº\u003c/strong\u003eï¼ˆå¯ä»¥ç”¨ä¹å›¢æŒ‡æŒ¥æ¥ç±»æ¯”ï¼‰ï¼ŒæŠŠä¸€ç³»åˆ—ä¸ç¡®å®šçš„çŠ¶æ€åœ¨æŸä¸€ä¸ªæ—¶é—´ç‚¹åŒæ­¥åˆ°äº†ä¸€ä¸ªç¡®å®šçš„çŠ¶æ€ï¼Œå°†å‘æ•£çš„å¹¶å‘ç¨‹åºçŠ¶æ€ â€œæ”¶æŸâ€\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eå®ç°åŒæ­¥\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå®ç° $ A\\to B $ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-gdscript3\" data-lang=\"gdscript3\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eA\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003ecan_proceed\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"bp\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esignal\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003ewhile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003ecan_proceed\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003eB\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"o\"\u003e//\u003c/span\u003e \u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ewait\u003c/span\u003e \u003cspan class=\"n\"\u003euntil\u003c/span\u003e \u003cspan class=\"n\"\u003ethe\u003c/span\u003e \u003cspan class=\"n\"\u003econdition\u003c/span\u003e \u003cspan class=\"n\"\u003eis\u003c/span\u003e \u003cspan class=\"n\"\u003esatisfied\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eè¿™æ ·çš„æ€è·¯å¤§è‡´æ­£ç¡®ï¼Œä½†æ˜¯è‡ªé€‰çš„å¾ªç¯æœ‰å¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªæ›´åŠ åº•å±‚çš„æœºåˆ¶æ¥å¸®åŠ©å®ç°è¿™ä¸€ç‚¹\u003c/p\u003e\n\u003cp\u003eæœ€ç†æƒ³çš„ API æ˜¯ \u003ccode\u003ewait_until(cond)\u003c/code\u003e ï¼Œä½†æ˜¯è¿‡å»ä¸ºäº†ç®€åŒ–è®¾è®¡ï¼Œå˜æˆäº†\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ¡ä»¶ä¸æ»¡è¶³æ—¶ç­‰å¾…ï¼š\u003ccode\u003ewait\u003c/code\u003e - ç›´æ¥ç¡çœ ç­‰å¾…\u003c/li\u003e\n\u003cli\u003eæ¡ä»¶æ»¡è¶³æ—¶ç»§ç»­ï¼š\u003ccode\u003esignal/broadcast\u003c/code\u003e - å”¤é†’æ‰€æœ‰çº¿ç¨‹\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eï¼ˆå°æ—¶å€™çš„ scratch ç¼–ç¨‹å…¶å®å·²ç»æœ‰äº†è¿™æ ·çš„æ€æƒ³ğŸ˜‚ï¼‰\u003c/p\u003e\n\u003cp\u003eåœ¨ c++ ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥æŠŠæ¡ä»¶æ”¾åˆ° $ \\lambda $ è¡¨è¾¾å¼ä¸­ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-c++\" data-lang=\"c++\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003emutex\u003c/span\u003e \u003cspan class=\"n\"\u003emtx\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003econdition_variable\u003c/span\u003e \u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003eT_player\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eunique_lock\u003c/span\u003e \u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emtx\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewait\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\t\u003cspan class=\"p\"\u003e[]{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ecan_proceed\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003ecv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enotify_all\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"n\"\u003elk\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eunlock\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eæ³¨æ„æ¡ä»¶å˜é‡åœ¨ç­‰å¾…æ—¶éœ€è¦å¸¦ç€ä¸€æŠŠé”ï¼ˆéœ€è¦ç¡®ä¿æ£€æŸ¥å’Œç­‰å¾…æ˜¯åŸå­æ“ä½œï¼‰\u003c/p\u003e","title":"15. å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥æ¡ä»¶å˜é‡"}]